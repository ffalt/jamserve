{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/db/db.types.ts","webpack:///external \"path\"","webpack:///./src/model/jam-types.ts","webpack:///./src/utils/logger.ts","webpack:///./src/utils/fs-utils.ts","webpack:///./src/objects/base/base.store.ts","webpack:///external \"fs-extra\"","webpack:///./src/api/jam/error.ts","webpack:///./src/objects/base/base.service.ts","webpack:///./src/objects/state/state.format.ts","webpack:///./src/utils/webservice-client.ts","webpack:///./src/utils/random.ts","webpack:///./src/objects/base/base.list.service.ts","webpack:///./src/objects/base/base.list.controller.ts","webpack:///./src/utils/paginate.ts","webpack:///external \"moment\"","webpack:///./src/utils/debounce-promises.ts","webpack:///./src/objects/base/base.controller.ts","webpack:///./src/api/subsonic/format.ts","webpack:///./src/engine/scan/scan.service.ts","webpack:///./src/utils/filetype.ts","webpack:///external \"request\"","webpack:///./src/api/subsonic/response.ts","webpack:///external \"crypto\"","webpack:///./src/utils/salthash.ts","webpack:///external \"fs\"","webpack:///./src/version.ts","webpack:///external \"express\"","webpack:///./src/api/jam/response.ts","webpack:///./src/objects/track/track.format.ts","webpack:///./src/objects/user/user.format.ts","webpack:///./src/objects/playlist/playlist.service.ts","webpack:///external \"limiter\"","webpack:///./src/utils/tool.ts","webpack:///external \"fluent-ffmpeg\"","webpack:///./src/utils/download.ts","webpack:///./src/objects/episode/episode.format.ts","webpack:///./src/engine/index/index.format.ts","webpack:///external \"express-session\"","webpack:///./src/utils/openapi-parameters-check.ts","webpack:///./src/utils/hex.ts","webpack:///./src sync","webpack:///./src/index.ts","webpack:///./src/engine/engine.ts","webpack:///./src/engine/io/io.service.ts","webpack:///external \"winston\"","webpack:///external \"winston-timer\"","webpack:///./src/utils/deep-compare.ts","webpack:///./src/utils/md5.ts","webpack:///./src/modules/audio/audio.module.ts","webpack:///external \"jamp3\"","webpack:///./src/modules/audio/clients/chartlyrics-client.ts","webpack:///./src/utils/webservice-xml-client.ts","webpack:///external \"xml2js\"","webpack:///./src/modules/audio/clients/acoustid-client.ts","webpack:///./src/modules/audio/tools/fpcalc.ts","webpack:///./src/utils/which.ts","webpack:///external \"child_process\"","webpack:///./src/modules/audio/clients/lastfm-client.ts","webpack:///./src/modules/audio/clients/musicbrainz-client.ts","webpack:///./src/modules/audio/clients/musicbrainz-client.types.ts","webpack:///./src/utils/genres.ts","webpack:///./src/modules/audio/tools/ffprobe.ts","webpack:///external \"jamp3/dist/lib/id3v1/id3v1_consts\"","webpack:///./src/modules/audio/clients/acousticbrainz-client.ts","webpack:///./src/modules/audio/clients/coverartarchive-client.ts","webpack:///./src/modules/audio/clients/wikipedia-client.ts","webpack:///./src/engine/index/index.service.ts","webpack:///./src/objects/metadata/metadata.service.ts","webpack:///./src/objects/metadata/metadata.types.ts","webpack:///./src/objects/user/user.service.ts","webpack:///external \"md5-typescript\"","webpack:///external \"common-password-checker\"","webpack:///./src/engine/chat/chat.service.ts","webpack:///./src/engine/genre/genre.service.ts","webpack:///./src/objects/podcast/podcast.service.ts","webpack:///./src/utils/feed.ts","webpack:///external \"zlib\"","webpack:///external \"feedparser\"","webpack:///external \"iconv-lite\"","webpack:///./src/engine/nowplaying/nowplaying.service.ts","webpack:///./src/objects/root/root.service.ts","webpack:///./src/objects/playqueue/playqueue.service.ts","webpack:///./src/engine/waveform/waveform.service.ts","webpack:///./src/modules/audio/tools/ffmpeg-waveform.ts","webpack:///external \"svgo\"","webpack:///external \"stream\"","webpack:///external \"waveform-data\"","webpack:///./src/engine/stream/stream.service.ts","webpack:///./src/modules/audio/transcoder.ts","webpack:///external \"tmp\"","webpack:///./src/objects/bookmark/bookmark.service.ts","webpack:///./src/objects/state/state.service.ts","webpack:///./src/engine/image/image.service.ts","webpack:///./src/engine/download/download.service.ts","webpack:///./src/utils/compress-stream.ts","webpack:///external \"archiver\"","webpack:///./src/objects/radio/radio.service.ts","webpack:///./src/objects/folder/folder.service.ts","webpack:///./src/modules/image/image.module.ts","webpack:///external \"http\"","webpack:///external \"jimp\"","webpack:///external \"mime-types\"","webpack:///./src/objects/track/track.service.ts","webpack:///./src/objects/artist/artist.service.ts","webpack:///./src/objects/album/album.service.ts","webpack:///./src/objects/episode/episode.service.ts","webpack:///./src/config/thirdparty.config.ts","webpack:///./src/engine/stats/stats.service.ts","webpack:///./src/objects/settings/settings.service.ts","webpack:///./src/config/settings.default.ts","webpack:///./src/api/server.ts","webpack:///external \"body-parser\"","webpack:///./src/api/jam/router.ts","webpack:///./src/api/jam/login.ts","webpack:///external \"multer\"","webpack:///./src/api/jam/api.ts","webpack:///./src/objects/episode/episode.controller.ts","webpack:///./src/objects/podcast/podcast.controller.ts","webpack:///./src/objects/podcast/podcast.format.ts","webpack:///./src/objects/album/album.controller.ts","webpack:///./src/objects/album/album.format.ts","webpack:///./src/objects/artist/artist.controller.ts","webpack:///./src/objects/artist/artist.format.ts","webpack:///./src/objects/playlist/playlist.controller.ts","webpack:///./src/objects/playlist/playlist.format.ts","webpack:///./src/objects/track/track.controller.ts","webpack:///./src/objects/folder/folder.controller.ts","webpack:///./src/objects/folder/folder.format.ts","webpack:///./src/engine/health/folder.rule.ts","webpack:///./src/objects/root/root.controller.ts","webpack:///./src/objects/root/root.format.ts","webpack:///./src/objects/user/user.controller.ts","webpack:///./src/engine/chat/chat.controller.ts","webpack:///./src/engine/chat/chat.format.ts","webpack:///./src/objects/metadata/metadata.controller.ts","webpack:///./src/engine/stream/stream.controller.ts","webpack:///./src/engine/genre/genre.controller.ts","webpack:///./src/engine/genre/genre.format.ts","webpack:///./src/engine/nowplaying/nowplaying.controller.ts","webpack:///./src/engine/nowplaying/nowplaying.format.ts","webpack:///./src/engine/image/image.controller.ts","webpack:///./src/engine/download/download.controller.ts","webpack:///./src/engine/waveform/waveform.controller.ts","webpack:///./src/engine/autocomplete/autocomplete.controller.ts","webpack:///./src/objects/bookmark/bookmark.controller.ts","webpack:///./src/objects/bookmark/bookmark.format.ts","webpack:///./src/objects/playqueue/playqueue.controller.ts","webpack:///./src/objects/playqueue/playqueue.format.ts","webpack:///./src/objects/radio/radio.controller.ts","webpack:///./src/objects/radio/radio.format.ts","webpack:///./src/engine/stats/stats.controller.ts","webpack:///./src/engine/stats/stats.format.ts","webpack:///./src/objects/settings/settings.controller.ts","webpack:///external \"cors\"","webpack:///./src/utils/session-storage.ts","webpack:///external \"passport\"","webpack:///external \"passport-jwt\"","webpack:///external \"passport-local\"","webpack:///external \"jsonwebtoken\"","webpack:///./src/api/jam/routes.ts","webpack:///./src/api/jam/check.ts","webpack:///./src/utils/validate-json.ts","webpack:///external \"ajv\"","webpack:///./src/utils/max-age.ts","webpack:///external \"multer-autoreap\"","webpack:///external \"express-rate-limit\"","webpack:///./src/api/subsonic/router.ts","webpack:///./src/api/subsonic/login.ts","webpack:///./src/utils/to-xml.ts","webpack:///external \"util\"","webpack:///./src/api/subsonic/parameters.ts","webpack:///./src/api/subsonic/api.ts","webpack:///./src/api/subsonic/routes.ts","webpack:///./src/api/subsonic/check.ts","webpack:///external \"helmet\"","webpack:///./src/config.ts","webpack:///./src/engine/store/store.ts","webpack:///./src/objects/user/user.store.ts","webpack:///./src/objects/track/track.store.ts","webpack:///./src/objects/folder/folder.store.ts","webpack:///./src/objects/episode/episode.store.ts","webpack:///./src/objects/album/album.store.ts","webpack:///./src/objects/artist/artist.store.ts","webpack:///./src/objects/radio/radio.store.ts","webpack:///./src/objects/playqueue/playqueue.store.ts","webpack:///./src/objects/root/root.store.ts","webpack:///./src/objects/bookmark/bookmark.store.ts","webpack:///./src/objects/podcast/podcast.store.ts","webpack:///./src/objects/playlist/playlist.store.ts","webpack:///./src/objects/state/state.store.ts","webpack:///./src/objects/metadata/metadata.store.ts","webpack:///./src/objects/settings/settings.store.ts","webpack:///./src/db/elasticsearch/db-elastic.ts","webpack:///external \"elasticsearch\"","webpack:///./src/db/elasticsearch/es-sequence.ts","webpack:///./src/db/elasticsearch/mapping.ts","webpack:///./src/utils/wait.ts","webpack:///./src/db/nedb/db-nedb.ts","webpack:///external \"nedb\"","webpack:///external \"commander\""],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","DBObjectType","require","FolderType","JamObjectType","RootScanStrategy","AudioMimeTypes","mp3","m4a","ogg","oga","flv","flac","webma","webm","wav","AudioFormatType","VideoMimeTypes","mp4","m4v","ogv","webmv","PodcastStatus","FolderTypeImageName","unknown","artist","collection","album","multialbum","extras","ArtworkImageType","FolderTypesAlbum","DatabaseQuerySortType","AlbumType","FileTyp","LastFMLookupType","TrackTagID3v2FormatTypes","winston_1","__importDefault","default","configureLogger","level","configure","transports","Console","format","combine","colorize","simple","Logger","[object Object]","this","params","line","Date","toISOString","concat","join","log","applyLog","toString","start_log","stop_log","path_1","fs_extra_1","fileDeleteIfExists","pathName","pathExists","unlink","pathDeleteIfExists","remove","fileSuffix","filename","extname","slice","toLowerCase","replaceFileSystemChars","replace","containsFolderSystemChars","test","replaceFolderSystemChars","ensureTrailingPathSeparator","length","sep","removeTrailingPathSeparator","jam_types_1","BaseStore","type","db","group","getDBIndex","getNewId","item","add","items","bulk","id","idOrIds","byId","ids","byIds","queryOne","all","query","queryIds","count","onItems","iterate","upsert","removeByQuery","transformQuery","QueryHelper","q","field","term","match","startsWith","startsWiths","terms","notNull","push","lte","gte","undefined","range","fieldMap","keys","sorts","forEach","sort","descending","ascending","amount","offset","ApiError","Error","message","failCode","super","constructor","captureStackTrace","InvalidParamError","msg","NotFoundError","UnauthError","GenericError","BaseStoreService","store","formatState","state","played","lastplayed","faved","rated","formatStates","states","result","limiter_1","request_1","WebserviceClient","requestPerInterval","requestIntervalMS","userAgent","limiter","RateLimiter","url","parameters","options","headers","User-Agent","qs","timeout","Promise","resolve","reject","removeTokens","err","response","body","JSON","parse","crypto_1","shuffle","list","j","Math","floor","random","randomInt","min","max","randomItem","randomItems","done","indexOf","randomString","randomBytes","ceil","base_service_1","BaseListService","stateService","searchIDs","assign","a","b","getAvgHighestDestIDs","getFilteredIDs","user","getHighestRatedDestIDs","getFrequentlyPlayedDestIDs","getFavedDestIDs","getRecentlyPlayedDestIDs","error_1","random_1","paginate_1","base_controller_1","BaseListController","BaseController","listService","imageService","downloadService","listQuery","jamquery","includes","translateQuery","getHighestRatedIDs","paginate","getAvgHighestIDs","getFrequentlyPlayedIDs","getFavedIDs","getRecentlyPlayedIDs","prepareListByIDs","DebouncePromises","pendingPromises","cb","error","state_format_1","service","obj","prepare","prepareList","byID","search","defaultSort","req","prepareByID","byIDs","findOrCreate","findOrCreateMany","map","fav","rating","rate","getObjImage","size","getObjDownload","moment_1","fs_utils_1","db_types_1","FORMAT","code","txt","subsonic-response","status","xmlns","0","10","20","30","40","50","70","version","date","utc","root","parseInt","username","email","maxBitRate","avatarLastChanged","formatSubSonicDate","folder","allowedfolder","scrobblingEnabled","adminRole","roles","admin","settingsRole","downloadRole","stream","uploadRole","upload","playlistRole","coverArtRole","commentRole","podcastRole","podcast","streamRole","jukeboxRole","shareRole","videoConversionRole","entry","starred","userRating","index","groups","entries","e","packFolderIndexArtist","packArtist","parent","parentID","basename","path","tag","title","artistId","artistID","coverArt","songCount","trackIDs","duration","year","genre","created","albumCount","albumIDs","info","notes","wiki","content","musicBrainzId","mbid","lastFmUrl","image","smallImageUrl","mediumImageUrl","largeImageUrl","similar","biography","bio","similarArtist","track","suffix","isDir","stat","media","isNaN","round","bitRate","contentType","isVideo","discNumber","disc","albumId","albumID","playCount","transcodedSuffix","transcodedContentType","nowPlaying","packTrack","episode","packPodcastEpisode","nowPlay","minutesAgo","diff","time","asMinutes","playerId","errorMessage","description","originalImageUrl","streamId","channelId","podcastID","summary","publishDate","author","playlist","comment","public","isPublic","changed","allowedUser","owner","userID","tracks","packPlaylist","bookmark","child","position","childs","song","playqueue","current","currentID","changedBy","radio","streamUrl","homePageUrl","homepage","trackCount","artistCount","FAIL","GENERIC","PARAMETER","CLIENT_OLD","SERVER_OLD","CREDENTIALS","UNAUTH","NOTFOUND","logger_1","deep_compare_1","filetype_1","playlist_service_1","md5_1","logChange","convert2list","getMostUsedTagValue","multi","val","cleaned","filter","trackHasChanged","file","mtime","modified","ctime","getArtistMBArtistID","trackInfo","dir","cVariousArtist","mbAlbumArtistID","mbArtistID","getArtistNameSort","artistSort","getArtistName","albumArtist","cUnknownArtist","slugify","getArtistSlug","getAlbumName","albumType","compilation","cUnknownAlbum","getAlbumSlug","extractAlbumName","trim","generateArtworkId","folderID","md5string","logChanges","changes","v","end","start","newTracks","updateTracks","removedTracks","newFolders","updateFolders","removedFolders","newArtists","updateArtists","removedArtists","newAlbums","updateAlbums","removedAlbums","ScanService","audioModule","imageModule","waveformService","artistCache","albumCache","strategy","auto","settings","scanAtStart","audioBookGenreNames","stats","mbReleaseGroupID","mbAlbumID","mbAlbumType","statID","slug","split","statNumber","statSlugValue","files","AUDIO","tracktag","albumArtistSort","sub","directories","subtag","artists","artistSorts","albums","genres","years","Number","mbArtistIDs","mbAlbumIDs","mbReleaseGroupIDs","mbAlbumTypes","hasMultipleArtists","hasMultipleAlbums","audiobook","g","find","localeCompare","artistalbum","cloneScanDir","folderStore","searchOne","matchDirR","folderList","inPath","f","trackList","trackStore","rootID","debug","folders","subFolder","subDir","sd","valueOf","readdir","subStat","isDirectory","getFileType","scanDirR","folderCount","buildDefaultTag","data","read","dirname","buildFolder","buildMerge","old","buildTrack","oldTrack","deepCompare","folderHasChanged","mergeR","forceMetaRefresh","buildMergeTags","mergeMeta","IMAGE","lname","types","front","other","metaStat","nameSplit","parts","y","shift","splitDirectoryName","images","collectFolderImages","imageName","artworks","setTagType","markMultiAlbumChilds","markArtistChilds","buildMetaStat","buildFolderTag","applyFolderTagType","artistStore","nameSort","rootIDs","albumTypes","now","findArtistInCache","findArtistInDB","updateArtist","buildArtist","findCompilationArtist","albumStore","findAlbumInCache","findAlbumInDB","updateAlbum","buildAlbum","getTrackByID","getAlbumByID","findOrCreateArtist","compilationArtist","findOrCreateCompilationArtist","findOrCreateAlbum","getArtistByID","collectMergeTracks","addMeta","removeMeta","allArtistIDs","allAlbumIDs","flatTracks","trackInfos","getAlbumsById","stateStore","destIDs","artistIDs","folderIDs","bookmarkStore","playlists","playlistStore","updatePlayListTracks","clearImageCacheByIDs","clearWaveformCacheByIDs","emptyChanges","scan","merge","storeChanges","clean","trackID","rootStore","buildMatchDirFromDBData","buildMatchFileFromDB","art","matchFile","changedDirs","changedFiles","collectR","SupportedReadImageFormat","SupportedWriteImageFormat","SupportedAudioFormat","SupportedTranscodeAudioFormat","TAG","BACKUP","OTHER","to_xml_1","format_1","ApiResponder","res","send","packOK","setHeader","callback","stringify","json","set","toXML","packResponse","fail","packFail","text","pipe","buffer","sendFile","hashSalt","password","salt","hash","createHmac","update","digest","hashSaltPassword","JAMSERVE_VERSION","JAMAPI_VERSION","formatTrackTag","mbz","recordingID","mbRecordingID","releaseTrackID","mbReleaseTrackID","releaseGroupID","mbTrackID","releaseID","trackNr","discTotal","musicbrainz","formatTrack","trackMedia","channels","sampleRate","trackTag","formatRoles","formatUser","formatSessionUser","trackHash","PlaylistService","which_1","child_process_1","spawnTool","binName","envName","args","bin","getBinPath","spawn","stdout","on","stderr","spawnToolStream","onData","spawnToolJson","fs_1","http","__importStar","downloadFile","statusCode","then","STATUS_CODES","catch","createWriteStream","track_format_1","formatEpisode","guid","link","formatArtistIndex","lastModified","formatFolderIndex","validate_json_1","validOAParameter","param","schema","required","num","minimum","maximum","enum","Array","isArray","console","checkAORequestBody","cmd","apiSchema","requestBody","$ref","def","definitions","validator","specialSchema","jsonValidator","createJSONValidator","validateJSON","errors","checkOpenApiParameters","openapi","forceMethod","cmdPath","paths","method","in","cookies","checkAOParameters","hexEncode","u","charAt","charCodeAt","hexDecode","hex","str","String","fromCharCode","substr","webpackEmptyContext","engine_1","server_1","config_1","store_1","db_elastic_1","db_nedb_1","commander_1","pack","usage","option","process","argv","config","loadConfig","database","use","DBElastic","elasticsearch","DBNedb","getDataPath","Store","engine","Engine","server","Server","reset","open","close","runClearDB","stop","exit","settingsService","library","ioService","refresh","run","io_service_1","audio_module_1","index_service_1","metadata_service_1","user_service_1","chat_service_1","genre_service_1","podcast_service_1","nowplaying_service_1","root_service_1","playqueue_service_1","waveform_service_1","stream_service_1","bookmark_service_1","state_service_1","image_service_1","download_service_1","radio_service_1","folder_service_1","image_module_1","track_service_1","artist_service_1","album_service_1","episode_service_1","thirdparty_config_1","salthash_1","scan_service_1","stats_service_1","settings_service_1","chatService","ChatService","AudioModule","ThirdPartyConfig","WaveformService","ImageModule","StateService","folderService","FolderService","trackService","TrackService","indexService","IndexService","scanService","SettingsService","settingsStore","artistService","ArtistService","albumService","AlbumService","userService","UserService","userStore","playQueueStore","ImageService","genreService","GenreService","statsService","StatsService","IoService","DownloadService","nowPlayingService","NowPlayingService","streamService","StreamService","playlistService","playQueueService","PlayQueueService","bookmarkService","BookmarkService","episodeService","EpisodeService","episodeStore","podcastService","PodcastService","podcastStore","metaDataService","MetaDataService","metaStore","rootService","RootService","radioService","RadioService","radioStore","firstStart","adminUser","pw","pass","subsonic_pass","mail","roots","firstStartRoots","first","ensureDir","checkDataPaths","loadSettings","checkFirstStart","ScanRequestMode","ScanRequestRefreshRoot","refreshRoot","ScanRequestRemoveRoot","removeRoot","ScanRequestRefreshTracks","refreshTracks","scanning","rootstatus","queue","delayedTrackRefresh","scanningCount","lastScan","buildIndexes","runRequest","next","findRequest","delayedCmd","clearTimeout","request","setTimeout","oldRequest","ignore","ignoreList","compare","oa","ob","createHash","jamp3_1","chartlyrics_client_1","acoustid_client_1","lastfm_client_1","musicbrainz_client_1","genres_1","ffprobe_1","id3v1_consts_1","acousticbrainz_client_1","coverartarchive_client_1","wikipedia_client_1","durationEstimate","encoded","layer","streams","codec_type","format_name","bit_rate","sample_rate","channel_layout","codec_long_name","tags","DATE","ARTIST","TITLE","ALBUM","GENRE","cleanGenre","album_artist","albumSort","album_sort_order","album_artist_sort","album_artist_sort_order","artist_sort","titleSort","title_sort_order","TRACKID","ALBUMTYPE","ALBUMARTISTID","ARTISTID","ALBUMID","RELEASETRACKID","RELEASEGROUPID","RECORDINGID","mbAlbumStatus","ALBUMSTATUS","mbReleaseCountry","RELEASECOUNTRY","genreIndex","ID3v1_GENRES","simplifyTag","release_year","originalyear","original_release_year","release_date","head","rev","disc_total","trackTotal","track_total","tools","isSaving","MusicbrainzClient","retryOn","acousticbrainz","AcousticbrainzClient","lastFM","LastFMClient","lastfm","apiKey","acoustid","AcoustidClient","chartLyrics","ChartLyricsClient","chartlyrics","wikipedia","WikipediaClient","coverArtArchive","CoverArtArchiveClient","coverartarchive","probe","packProbeJamServeTag","packProbeJamServeMedia","MP3","mpegQuick","mpeg","id3v2","packID3v2JamServeTag","packJamServeMedia","id3v1","ID3v1","v1","packID3v1JamServeTag","copy","frames","binValue","Buffer","from","statusFlags","formatFlags","ver","valid","ID3v2","write","id3v2tag","frame","pictureType","mimeType","inc","lookup","nr","highLevel","releaseImages","releaseGroupImages","lang","wikidata","webservice_xml_client_1","WebserviceXMLClient","artistName","songName","opts","getJson","GetLyricResult","LyricId","trackId","TrackId","checksum","LyricChecksum","LyricSong","LyricArtist","LyricUrl","covertArtUrl","LyricCovertArtUrl","rank","LyricRank","correctUrl","LyricCorrectUrl","lyric","Lyric","xml2js_1","parseString","err2","fpcalc_1","webservice_client_1","META_DEFAULT","fp","meta","client","toFixed","fingerprint","results","fpcalc","tool_1","cmds","raw","isWindows","platform","env","OSTYPE","cache","COLON","isexeStat","isFile","isSymbolicLink","pathext","pathExt","PATHEXT","pathexts","checkWindowsMode","mod","uid","gid","myUid","getuid","myGid","getgid","checkMode","whichs","opt","colon","pathEnv","PATH","pathExtExe","unshift","cwd","ext","extExe","getPathInfo","found","F","er","getNotFoundError","pathPart","E","ii","ll","isexe","is","enviroment","which","arch","localBin","walk","subkey","sample","fulltrack","img","api","sorted_params","beautify","toptracks","similartracks","albumIDTopTags","similarTrackID","topArtistSongsID","musicbrainz_client_types_1","host","port","basePath","limit","retryDelay","retryCount","toUpperCase","formatKey","encodeURIComponent","retry","isRateLimitError","concatSearchQuery","LookupIncludes","invalidKey","lookupIds","LookupBrowseTypes","area","event","instrument","label","place","recording","release","release-group","series","work","GenresSlugs","genreByNumbers","Genres","getKnownGenre","part","numpart","exec","SyntaxError","action","prop","exintro","redirects","titles","pages","page","extract","redirect","extract_html","entities","debounce_promises_1","IndexTreeBuilder","indexConfig","ignoreArticles","matches","RegExp","sortname","removeArticles","indexChar","getIndexChar","searchCount","getTotalTrackCount","folderIndex","buildFolderIndex","artistIndex","buildArtistIndex","indexCacheDebounce","cached","builder","isPending","append","setPending","getIndexes","metadata_types_1","stripInlineLastFM","stripInlineWikipediaHTML","metadataStore","musicbrainzLookup","relations","rel","resource","wikidataSummary","source","license","licenseUrl","wikipediaSummary","mbReleaseID","lastFMLookup","getMusicBrainzIDWikipediaArtistInfo","getLastFMArtistInfo","getMusicBrainzIDWikipediaAlbumInfo","getLastFMAlbumInfo","musicbrainzSearch","getArtistInfoByMusicBrainzID","lastFMArtistSearch","albumName","releases","getAlbumInfoByMusicBrainzID","lastFMAlbumSearch","getArtistInfoByName","getAlbumInfoByName","similarArtists","names","getLastFMSimilarArtists","getSimilarArtistsInfo","findSimilarArtists","findSimilarArtistFolders","songs","vals","sim","mbTrackIDs","tr","lastFMTopTracksArtistID","lastFMTopTracksArtist","similars","getSimilarSongs","findSimilarTracks","getSimilarArtistTracks","lastFMSimilarTracks","dataType","MetaDataType","brainz","metadata","acoustidLookup","topArtistSongs","abrainz","acousticbrainzLookup","caa","coverartarchiveLookup","pedia","entity","wikidataID","site","sitelinks","langSite","md5_typescript_1","commonPassword","userAvatarPath","avatar","destFileName","destName","createAvatar","clearImageCacheByID","getByName","token","Md5","init","testPassword","messages","chatConfig","maxMessages","maxAge","unit","subtract","since","cleanOld","genreHash","__awaiter","section","sections","sec","feed_1","base_list_service_1","podcastRefreshDebounce","podcastId","lastCheck","new","removeEpisodes","feed","Feed","episodes","completed","newEpisodes","mergeEpisodes","podcasts","zlib_1","feedparser_1","iconv_lite_1","reduce","para","encoding","decompress","createInflate","createGunzip","charset","iv","decodeStream","emit","posts","doneReported","pool","setMaxListeners","feedparser","abort","statusMessage","getParams","pipestream","maybeDecompress","maybeTranslate","fetch","generator","categories","post","chapters","pscChaps","pscChap","enclosures","playing","np","reportPlaying","checkUsedPath","playQueue","emptyPlaylist","ffmpeg_waveform_1","waveformCachePath","waveformCacheDebounce","wf","WaveformGenerator","svg","binary","searches","getCacheID","findIndex","cacheID","cachefile","generateWaveform","writeFile","svgo_1","stream_1","fluent_ffmpeg_1","WaveformData","WaveformStream","Transform","_at__samplesPerPixel","_at__sampleRate","writableObjectMode","readableObjectMode","highWaterMark","_buf","PassThrough","_out","_started","_min","_max","_samples","_total","_samplesPerPixel","_sampleRate","_ffmpeg","addOptions","errored","writeToStream","oddByte","readInt8","readInt16LE","readResults","pos","dataLen","chunk","once","Waveform","samplesPerPixel","ws","px","alloc","writeInt32LE","writeUInt32LE","writeInt16LE","samples_per_pixel","bits","asBinary","asJSON","buildSvg","svgo","optimize","createReadStream","wfd","adapter","resample","width","scale","totalPeaks","peakNumber","transcoder_1","sourceFormat","destFormat","Transcoder","needsTranscoding","validTranscoding","PreTranscoder","streamFile","tmp_1","fs","mediaFormat","getAvailableFormats","formats","canDemux","proc","nolog","withAudioCodec","withNoVideo","toFormat","withAudioBitrate","fd","cleanupCallback","statSync","rs","autoClose","save","destID","destType","emptyState","minRating","ratings","avg","isPlayed","isFaved","getTrackImage","getFolderImage","getArtistImage","getAlbumImage","getUserImage","paintImage","getCoverArtText","paint","compress_stream_1","CompressListStream","CompressFolderStream","fileList","downloadTrack","downloadFolder","downloadArtist","downloadAlbum","downloadEpisode","downloadPlaylist","archiver_1","BaseCompressStream","streaming","isSupportedFormat","archive","zlib","finalize","directory","homepageUrl","newPath","rename","rest","folderId","collect","artwork","clearID","setFrontArtworkImage","imageUrl","storeImage","download_1","jimp_1","mime_types_1","imageCachePath","imageCacheDebounce","filepath","imageext","font","loadFont","FONT_SANS_32_WHITE","print","alignmentX","HORIZONTAL_ALIGN_CENTER","alignmentY","VERTICAL_ALIGN_MIDDLE","resize","mime","getBufferAsync","fileFormat","getImageAs","crop","getWidth","getHeight","contain","getImage","destination","writeAsync","resizeImage","getTrackFolder","ext2","collectFolderPath","getArtistFolder","getAlbumFolder","podcastsPath","episodeDownloadDebounce","podcastEpisodeId","downloadEpisodeFile","deleted","links","version_1","artistTypes","settings_default_1","defaultSettings","setSettings","chat","express_1","body_parser_1","router_1","router_2","helmet_1","app","urlencoded","extended","initJamRouter","initSubsonicRouter","static","frontend","listen","getURL","login_1","response_1","multer_1","api_1","cors_1","session_storage_1","express_session_1","passport_1","passport_jwt_1","passport_local_1","jsonwebtoken_1","routes_1","check_1","max_age_1","user_format_1","autoUploadTempReap","LoginLimiter","rateLimit","windowMs","CallSessionLoginHandler","authenticate","login","getMaxAge","jwt","tokenData","exp","sign","secret","allowedCookieDomains","session","CallSessionLogoutHandler","logout","ok","checkRoles","role","JamController","UPLOAD_PATH","dest","router","Router","cookie","SessionJSONFileStore","resave","saveUninitialized","secure","initialize","serializeUser","deserializeUser","getByID","Strategy","usernameField","passwordField","auth","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","secretOrKey","jwt_payload","fromUrlQueryParameter","originalUrl","preflightContinue","credentials","allowedHeaders","origin","methods","register","execute","apiCheckName","apiCheck","single","registerPublicApi","origins","CheckAuthMiddleWare","registerAccessControlApi","episode_controller_1","podcast_controller_1","album_controller_1","artist_controller_1","playlist_controller_1","track_controller_1","folder_controller_1","root_controller_1","user_controller_1","chat_controller_1","metadata_controller_1","stream_controller_1","genre_controller_1","nowplaying_controller_1","image_controller_1","download_controller_1","waveform_controller_1","autocomplete_controller_1","bookmark_controller_1","playqueue_controller_1","radio_controller_1","stats_controller_1","settings_controller_1","settingsController","SettingsController","streamController","StreamController","chatController","ChatController","genreController","GenreController","statsController","StatsController","nowPlayingController","NowPlayingController","imageController","ImageController","downloadController","DownloadController","waveformController","WaveformController","autocompleteController","AutocompleteController","radioController","RadioController","rootController","RootController","trackController","TrackController","episodeController","EpisodeController","podcastController","PodcastController","albumController","AlbumController","artistController","ArtistController","folderController","FolderController","userController","UserController","playlistController","PlaylistController","bookmarkController","BookmarkController","playqueueController","PlayQueueController","metadataController","MetadataController","episode_format_1","base_list_controller_1","isDownloading","downloading","trackState","sortField","sortDescending","streamEpisode","getList","podcast_format_1","formatPodcast","podcastState","podcastEpisodes","prepareByQuery","podcastIDs","refreshPodcasts","album_format_1","formatAlbum","albumState","albumInfo","getAlbumInfo","albumTracks","sortAlbumTracks","newerThan","fromYear","toYear","getAlbumSimilarTracks","albumTrackIDs","artist_format_1","index_format_1","formatArtist","artistState","artistInfo","getArtistInfo","artistSimilar","getSimilarArtists","artistTracks","sortArtistTracks","artistAlbums","sortArtistAlbums","getArtistSimilarTracks","getArtistIndex","filterArtistIndex","artistAlbumIDs","artistTracksIDs","playlist_format_1","formatPlaylist","playlistState","playlistTracks","playlistTracksIDs","metaService","trackID3","tagID3","getID3","childOfID","parentIDs","readID3v2","saveID3v2","refreshTrack","streamTrack","getTrackSimilarTracks","renameTrack","folder_format_1","folder_rule_1","metadataService","checker","FolderRulesChecker","formatFolder","folderChildren","folderTracks","folderSubfolders","folderState","folderHealth","folderCounts","folderTag","folderInfo","getFolderArtistInfo","getFolderAlbumInfo","folderSimilar","getSimilarArtistFolders","health","folderParents","parents","trackQuery","recursive","inPaths","resultTracks","setFolderImage","renameFolder","getFolderSimilarTracks","getFolderIndex","filterFolderIndex","formatFolderArtworks","artworkByID","getArtworkImage","downloadFolderArtwork","formatFolderArtwork","removeArtworkImage","formatFolderTag","isAlbum","folderArtworks","FolderRule","FolderAlbumTagsRule","missing","details","FolderAlbumNameRule","nameSlug","nicename","getNiceFolderName","nicenameSlug","checkName","FolderAlbumImageRule","FolderArtistImageRule","FolderArtistNameRule","artistNameSlug","rules","rule","root_format_1","formatRoot","getRootStatus","forceRefreshMeta","rootState","isAdmin","roleAdmin","roleStream","roleUpload","rolePodcast","setUserImage","setUserPassword","setUserEmail","chat_format_1","formatChatMessage","acoustidLookupTrack","reportTrack","reportEpisode","findInAll","streamDBObject","genre_format_1","getGenres","formatGenre","nowplaying_format_1","nowplayingService","getNowPlaying","packNowPlaying","getTrackWaveform","getEpisodeWaveform","autocompleteQuery","bookmark_format_1","formatBookmark","bookmarkTrack","bookmarks","getAll","playqueue_format_1","playqueueService","getQueueOrCreate","formatPlayQueue","playQueueTracks","playQueueTrackIDs","radio_format_1","formatRadio","radioState","stats_format_1","getStats","formatStats","updateSettings","sid","sessionData","expired","destroy","savejson","clear","readJson","expires","ping","lastfmLookup","autocomplete","children","subfolders","artistSimilarTracks","tagID3s","retrieve","refreshAll","similarTracks","scanAll","download","artworkImage","waveform","delete","favUpdate","rateUpdate","tagID3Update","nameUpdate","imageUploadUpdate","artworkCreate","artworkDelete","passwordUpdate","emailUpdate","adminUpdate","openapi_parameters_check_1","JamApiSchema","jsonvalidator","compile","schemaValidator","keyword","dataPath","schemaPath","maxAgeSpec","asMilliseconds","parameters_1","AdminMiddleWare","PodcastAdminMiddleWare","ShareMiddleWare","JukeboxMiddleWare","SubsonicApi","share","jukebox","SubsonicParameterMiddleWare","SubsonicLoginMiddleWare","registerApi","hex_1","authSubsonic","authToken","validateCredentials","util_1","xmli","xmls","xmlo","xmlc","xml","processParams","objs","packAlbum","packFolder","packFolderArtist","prepareObj","removeDups","userIds","prepareTracks","users","bookmarkuser","packBookmark","packPlaylistWithSongs","typesObjs","findMultiInAll","licenseExpires","trialExpires","a1","b1","prepareFolders","packDirectory","ifModifiedSince","musicFolderId","indexes","ignoredArticles","packFolderIndex","packArtistIndex","albumList","albumList2","prepareAlbums","packAlbumInfo","al","packArtistInfo","artistInfo2","packArtistInfo2","limitCount","getTopTracks","topSongs","similarSongs","packSimilarSongs","similarSongs2","packSimilarSongs2","prepareTrack","packGenre","dummy","musicFolders","musicFolder","packRoot","packUser","collectStateChangeObjects","getBool","chatMessages","chatMessage","packChatMessage","plist","preparePlaylist","playlistId","updateQuery","songIdToAdd","songId","updatePlaylist","removetracks","songIndexToRemove","songadd","artistFolderIDs","prepareFolderArtists","albumFolderIDs","starred2","prepareArtists","includeEpisodes","podcastList","channel","packPodcast","prepareEpisodes","newestPodcasts","objstore","deleteEpisode","bookmarklist","prepareBookmarks","randomSongs","trackids","songsByGenre","tracklist","any","searchResult","totalHits","searchResult2","songOffset","folderlist","artistOffset","albumOffset","searchResult3","albumlist","artistlist","scanStatus","getScanStatus","artistid3","albumid3","lyrics","getLyrics","packPlayQueue","internetRadioStations","internetRadioStation","disabled","packRadio","videos","videoInfo","shares","jukeboxStatus","currentIndex","gain","addChatMessage","changePassword","createBookmark","createPlaylist","createPodcastChannel","createShare","createUser","deleteBookmark","deleteInternetRadioStation","deletePlaylist","deletePodcastChannel","deletePodcastEpisode","deleteShare","deleteUser","downloadPodcastEpisode","getAlbum","getAlbumInfo2","getAlbumList","getAlbumList2","getArtist","getArtistInfo2","getArtists","getBookmarks","getChatMessages","getInternetRadioStations","createInternetRadioStation","updateInternetRadioStation","getLicense","getMusicDirectory","getMusicFolders","getNewestPodcasts","getPlaylist","getPlaylists","getPlayQueue","getPodcasts","getRandomSongs","startScan","getShares","getSimilarSongs2","getSong","getSongsByGenre","getStarred","getStarred2","getTopSongs","getUser","getUsers","getVideoInfo","getVideos","jukeboxControl","savePlayQueue","scrobble","search2","search3","setRating","star","unstar","updateShare","updateUser","getAvatar","getCaptions","getCoverArt","hls","SubsonicApiSchema","extendConfig","configPath","configFile","configFirstStartFile","user_store_1","track_store_1","folder_store_1","episode_store_1","album_store_1","artist_store_1","radio_store_1","playqueue_store_1","root_store_1","bookmark_store_1","podcast_store_1","playlist_store_1","state_store_1","metadata_store_1","settings_store_1","SettingsStore","TrackStore","FolderStore","UserStore","StateStore","PlaylistStore","PodcastStore","EpisodeStore","BookmarkStore","ArtistStore","AlbumStore","PlayQueueStore","RadioStore","RootStore","MetaDataStore","check","stores","base_store_1","bool","maxRating","elasticsearch_1","es_sequence_1","mapping_1","wait_1","DBIndexElastic","_index","indexName","_type","_map","mapping","hit","_source","properties","match_all","must","getPropertyMapping","match_phrase_prefix","prefix","exists","onHits","getMoreUntilDone","hits","total","_scroll_id","scroll","scrollId","filterProperties","indexRefresh","bodies","deleteByQuery","translateElasticQuery","_id","hit2Obj","mget","docs","doc","onItem","stored_fields","aggs","_count","cardinality","aggregations","fieldname","distinct","buckets","Client","sequence","ESSequence","indexPrefix","getTypes","resetIndex","requestTimeout","indices","_default_","date_detection","mappings","createIndex","waitAfter","checkIndex","wait","esTypeMapping","enabled","_all","isObject","isFunction","isInjectedClientValid","putMapping","initPromise","initError","cacheFillPromise","cacheSize","esIndex","esType","isFinite","isInjectedCacheSizeValid","initEsIndexIfNeeded","addMappingToEsIndexIfMissing","number_of_shards","auto_expand_replicas","sequenceName","bulkParams","k","_version","returnValue","interal_get","fillCache","type_bool","type_int","type_string","fields","type_key","type_Root","type_User","type_Folder","type_PlayQueue","type_TrackTag","type_TrackMedia","type_Track","type_Album","type_Artist","type_Radio","type_State","type_Playlist","type_Podcast","type_Episode","type_Bookmark","ms","nedb_1","globaltempid","regExpEscape","literal_string","DBIndexNedb","$regex","$in","$where","$gte","$lte","$exists","$and","insert","numReplaced","hits2Objs","dbquery","translateSortQuery","skip","getFieldValueR","getDotFieldValues","db_path","clients","loadDatabase"],"mappings":"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C,WAAY,CAAC,cACbC,MAAO,CAAC,OAAQ,aAAc,WAC9BC,MAAO,CAAC,OAAQ,cAChBC,UAAW,CAAC,SAAU,aAAc,WACpCC,QAAS,CAAC,OAAQ,SAAU,aAAc,QAAS,QAAS,eAAgB,YAAa,iBACzFC,gBAAiB,CAAC,SAAU,aAAc,WAC1CC,OAAQ,CAAC,cACTC,KAAM,CAAC,SAAU,cACjBn+B,IAAK,CAAC,aAGMtM,EAAA4pC,eAAoD,CAChEI,KAAM,GACNtmC,OAAQ,CAAC,aAAc,WAAY,iBAAkB,QAAS,UAAW,cAAe,WAAY,OAAQ,WAC5GC,WAAY,CAAC,oBACbsmC,MAAO,GACPC,WAAY,GACZC,MAAO,CAAC,YACRC,MAAO,GACPC,UAAW,CAAC,UAAW,WAAY,iBAAkB,UAAW,OAAQ,UAAW,cACnFC,QAAS,CAAC,UAAW,cAAe,SAAU,aAAc,iBAAkB,UAAW,QAAS,QAAS,iBAAkB,UAAW,OAAQ,WAAY,cAC5JC,gBAAiB,CAAC,UAAW,WAAY,QAAS,iBAAkB,UAAW,OAAQ,UAAW,WAAY,cAC9GC,OAAQ,GACRC,KAAM,GACNn+B,IAAK,kCC7BN,IAAIo+B,mDAEJ,MAAMC,EAAiB,CACtB,QACA,eACA,UACA,QACA,QACA,OACA,SACA,UACA,OACA,QACA,UACA,SACA,QACA,MACA,MACA,MACA,SACA,OACA,SACA,aACA,cACA,MACA,cACA,SACA,aACA,cACA,UACA,WACA,QACA,YACA,SACA,SACA,YACA,eACA,OACA,QACA,OACA,aACA,SACA,QACA,mBACA,OACA,OACA,OACA,QACA,aACA,mBACA,oBACA,SACA,SACA,WACA,oBACA,aACA,WACA,YACA,QACA,gBACA,SACA,OACA,cACA,SACA,gBACA,WACA,SACA,kBACA,UACA,WACA,cACA,OACA,YACA,UACA,QACA,SACA,YACA,YACA,QACA,QACA,UACA,cACA,YACA,OACA,YACA,gBACA,QACA,cACA,QACA,QACA,UACA,SACA,YACA,aACA,cACA,mBACA,mBACA,iBACA,YACA,WACA,SACA,iBACA,WACA,SACA,SACA,UACA,QACA,gBACA,SACA,WACA,aACA,SACA,cACA,SACA,WACA,OACA,QACA,QACA,WACA,SACA,eACA,gBACA,YACA,OACA,YACA,YACA,aACA,aACA,aACA,MACA,cACA,aACA,WACA,SACA,QACA,UACA,YACA,aACA,OACA,wBACA,cACA,cACA,YACA,yBACA,iBACA,WACA,QACA,eACA,QACA,OACA,WACA,WACA,WACA,UACA,UACA,WACA,YACA,WACA,YACA,MACA,MACA,WACA,UACA,eACA,MACA,eACA,SACA,SACA,MACA,WACA,gBACA,WACA,YACA,YACA,SACA,YACA,eACA,YACA,YACA,YACA,YACA,WACA,aACA,YACA,cACA,eACA,YACA,gBACA,sBACA,UACA,aACA,SACA,UACA,cACA,YAi3BD,SAASltB,EAAQpH,GAChB,OAAOA,EAAMvP,QAAQ,YAAa,IAAIF,cAh3B1B5G,EAAA4qC,OAAwB,CACpC,SACA,gBACA,SACA,aACA,WACA,OACA,cACA,aACA,YACA,YACA,YACA,cACA,cACA,mBACA,WACA,qBACA,UACA,gBACA,sBACA,kBACA,sBACA,kBACA,WACA,YACA,cACA,sBACA,oBACA,sBACA,oBACA,mBACA,UACA,cACA,gBACA,wBACA,YACA,eACA,QACA,YACA,QACA,WACA,WACA,WACA,QACA,sBACA,oBACA,kBACA,gBACA,YACA,2BACA,qBACA,YACA,cACA,mBACA,oBACA,aACA,MACA,UACA,mBACA,QACA,eACA,oBACA,gBACA,kBACA,SACA,iBACA,QACA,UACA,cACA,OACA,WACA,OACA,OACA,aACA,kBACA,QACA,QACA,gBACA,UACA,WACA,WACA,WACA,UACA,SACA,cACA,iBACA,YACA,QACA,gBACA,aACA,gBACA,SACA,cACA,SACA,gBACA,aACA,aACA,eACA,eACA,gBACA,SACA,YACA,iBACA,YACA,qBACA,YACA,YACA,QACA,kBACA,iBACA,gBACA,qBACA,uBACA,kBACA,UACA,cACA,UACA,kBACA,gBACA,cACA,QACA,UACA,gBACA,QACA,qBACA,UACA,iBACA,UACA,mBACA,UACA,YACA,YACA,SACA,eACA,eACA,cACA,cACA,SACA,eACA,gBACA,UACA,WACA,gBACA,kBACA,gBACA,cACA,SACA,YACA,WACA,YACA,YACA,aACA,eACA,WACA,oBACA,QACA,SACA,0BACA,wBACA,oBACA,kBACA,gBACA,iBACA,gBACA,iBACA,UACA,eACA,kBACA,uBACA,eACA,YACA,sBACA,gBACA,OACA,aACA,WACA,SACA,SACA,aACA,kBACA,oBACA,yBACA,oBACA,mBACA,mBACA,YACA,UACA,gBACA,cACA,cACA,eACA,cACA,eACA,gBACA,UACA,UACA,YACA,iBACA,mBACA,QACA,YACA,aACA,aACA,OACA,SACA,aACA,aACA,SACA,QACA,aACA,YACA,aACA,aACA,YACA,kBACA,UACA,iBACA,eACA,eACA,eACA,YACA,WACA,kBACA,WACA,WACA,iBACA,mBACA,cACA,aACA,YACA,YACA,YACA,aACA,cACA,cACA,gBACA,kBACA,iBACA,mBACA,QACA,aACA,aACA,YACA,QACA,aACA,WACA,YACA,QACA,YACA,eACA,QACA,eACA,cACA,cACA,cACA,YACA,WACA,MACA,aACA,UACA,WACA,aACA,OACA,gBACA,cACA,qBACA,iBACA,MACA,WACA,iBACA,UACA,gBACA,gBACA,gBACA,qBACA,kBACA,wBACA,eACA,aACA,wBACA,kBACA,cACA,gBACA,aACA,cACA,iBACA,MACA,gBACA,SACA,qBACA,aACA,aACA,aACA,cACA,WACA,YACA,qBACA,UACA,eACA,uBACA,qBACA,oBACA,OACA,kBACA,cACA,eACA,SACA,aACA,QACA,WACA,iBACA,OACA,aACA,WACA,YACA,YACA,YACA,WACA,cACA,QACA,iBACA,aACA,YACA,YACA,qBACA,YACA,aACA,YACA,kBACA,gBACA,eACA,aACA,QACA,aACA,UACA,OACA,eACA,aACA,WACA,cACA,cACA,kBACA,SACA,gBACA,eACA,YACA,SACA,QACA,OACA,iBACA,UACA,cACA,SACA,eACA,cACA,cACA,QACA,eACA,aACA,aACA,YACA,SACA,aACA,SACA,QACA,MACA,aACA,qBACA,YACA,SACA,eACA,SACA,eACA,cACA,QACA,YACA,UACA,eACA,SACA,UACA,UACA,aACA,aACA,iBACA,WACA,aACA,WACA,YACA,cACA,UACA,WACA,eACA,mBACA,gBACA,WACA,YACA,cACA,kBACA,SACA,WACA,qBACA,UACA,eACA,YACA,UACA,UACA,UACA,QACA,cACA,aACA,cACA,aACA,QACA,cACA,kBACA,SACA,SACA,QACA,MACA,gBACA,WACA,WACA,aACA,QACA,aACA,YACA,aACA,eACA,aACA,kBACA,qBACA,mBACA,mBACA,kBACA,gBACA,eACA,uBACA,uBACA,mBACA,oBACA,cACA,eACA,eACA,cACA,cACA,cACA,QACA,WACA,aACA,YACA,OACA,aACA,cACA,aACA,WACA,YACA,YACA,YACA,UACA,cACA,MACA,OACA,OACA,aACA,UACA,YACA,SACA,QACA,eACA,oBACA,mBACA,SACA,YACA,UACA,UACA,YACA,SACA,SACA,gBACA,QACA,QACA,UACA,aACA,QACA,oBACA,eACA,kBACA,cACA,aACA,cACA,YACA,aACA,cACA,SACA,YACA,iBACA,iBACA,cACA,cACA,OACA,QACA,QACA,kBACA,sBACA,SACA,eACA,cACA,UACA,YACA,YACA,YACA,kBACA,SACA,cACA,kBACA,SACA,UACA,SACA,QACA,WACA,eACA,WACA,WACA,aACA,YACA,WACA,SACA,WACA,QACA,iBACA,aACA,mBACA,sBACA,oBACA,gBACA,WACA,WACA,WACA,QACA,YACA,cACA,cACA,aACA,aACA,qBACA,kBACA,iBACA,eACA,aACA,cACA,aACA,SACA,QACA,aACA,WACA,iBACA,4BACA,mBACA,UACA,mBACA,aACA,kBACA,gBACA,kBACA,MACA,WACA,WACA,WACA,eACA,kBACA,YACA,eACA,qBACA,UACA,yBACA,WACA,sBACA,YACA,WACA,UACA,WACA,iBACA,qBACA,WACA,WACA,eACA,kBACA,qBACA,WACA,gBACA,eACA,YACA,UACA,QACA,aACA,aACA,SACA,UACA,gBACA,kBACA,UACA,WACA,kBACA,YACA,WACA,UACA,UACA,SACA,gBACA,qBACA,SACA,QACA,eACA,kBACA,0BACA,QACA,iBACA,iBACA,SACA,cACA,SACA,sBACA,YACA,iBACA,YACA,UACA,oBACA,QACA,aACA,MACA,WACA,UACA,WACA,WACA,YACA,WACA,WACA,cACA,QACA,WACA,aACA,cACA,gBACA,aACA,YACA,oBACA,YACA,eACA,oBACA,cACA,cACA,YACA,gBACA,SACA,SACA,wBACA,sBACA,mBACA,oBACA,oBACA,kBACA,mBACA,qBACA,eACA,WACA,cACA,mBACA,kBACA,mBACA,qBACA,cACA,aACA,YACA,OACA,aACA,YACA,YACA,QACA,aACA,MACA,YACA,QACA,eACA,YACA,SACA,UACA,MACA,WACA,MACA,YACA,YACA,YACA,WACA,UACA,YACA,QACA,OACA,wBACA,WACA,WACA,SACA,iBACA,iBACA,gBACA,aACA,YACA,mBACA,QACA,UACA,iBACA,gBACA,aACA,OACA,cACA,kBACA,qBACA,aACA,aACA,QACA,cACA,UACA,SACA,QACA,kBACA,QACA,aACA,UACA,SACA,OACA,WACA,UACA,OACA,SACA,QACA,YACA,mBACA,cACA,WACA,YACA,oBACA,MACA,WACA,WACA,aACA,UACA,SACA,WACA,YACA,WACA,eACA,cACA,aACA,OACA,YACA,MACA,aACA,SACA,QACA,cACA,eACA,UACA,OACA,aACA,YACA,aACA,aACA,mBACA,gBACA,gBACA,QACA,gBACA,cACA,cACA,aACA,SACA,eACA,cACA,YACA,iBACA,mBACA,cACA,sBACA,cACA,cACA,YACA,aACA,eACA,cACA,WACA,YACA,cACA,QACA,wBACA,kBACA,iBACA,WACA,WACA,WACA,YACA,SACA,QACA,aACA,cACA,YACA,wBACA,SACA,oBACA,WACA,cACA,aACA,WACA,SACA,SACA,cACA,gBACA,WACA,eACA,eACA,aACA,QACA,SACA,YACA,4BACA,wBACA,UACA,SACA,eACA,OACA,WACA,SACA,eACA,WACA,WACA,SACA,YACA,WACA,iBACA,aACA,WACA,wBACA,cACA,cACA,sBACA,YACA,WACA,YACA,cACA,gBACA,sBACA,mBACA,iBACA,QACA,YACA,YACA,mBACA,eACA,SACA,aACA,QACA,aACA,eACA,YACA,YACA,mBACA,qBACA,kBACA,gBACA,cACA,QACA,YACA,eACA,cACA,YACA,UACA,OACA,eACA,UAOD5qC,EAAA6qC,cAAA,SAA8Bx0B,GAC7B,MAAMiK,EAAO7C,EAAQpH,GAOrB,OANKq0B,IACJA,EAAc,GACd1qC,EAAA4qC,OAAO3gC,QAAQ6X,IACd4oB,EAAYjtB,EAAQqE,IAAMA,KAGrB4oB,EAAYpqB,IAGpBtgB,EAAAm9B,WAAA,SAAgBA,EAAW9mB,GAC1B,MAAMyuB,EAAyB,GAgD/B,OA/CczuB,EAAMkK,MAAM,KACpBtW,QAAS6gC,IAEdA,EAAOA,EAAK7sB,OACZ,MAAM8sB,EAAU,YAAYC,KAAKF,GACjC,IAAI9b,EAKJ,GAJI+b,IACH/b,EAAM3b,SAAS03B,EAAQ,GAAI,IAC3BD,EAAOA,EAAKnkC,MAAM,EAAGokC,EAAQ71B,OAAS41B,EAAKnkC,MAAMokC,EAAQ71B,MAAQ61B,EAAQ,GAAG5jC,SAEzD,IAAhB2jC,EAAK3jC,aAAyByC,IAARolB,EAAoB,CAC7C,MAAM/sB,EAAI0oC,EAAe3b,GACrB/sB,IACH6oC,EAAO7oC,GAGT,GAAI6oC,EAAK3jC,OAAS,EAAG,CACpB,MAAMmZ,EAAO7C,EAAQqtB,GACrB,IAAIj/B,EACC6+B,IACJA,EAAc,GACd1qC,EAAA4qC,OAAO3gC,QAAQ6X,IACd4oB,EAAYjtB,EAAQqE,IAAMA,KAGxB4oB,GAAeA,EAAYpqB,KAC9BzU,EAAS6+B,EAAYpqB,KAEjBzU,GAAUi/B,EAAK38B,QAAQ,QAAU,EACpB28B,EAAKvqB,MAAM,KACnBtW,QAAQ6W,IAChBA,EAAMqc,EAAWrc,GACbgkB,EAAQ32B,QAAQ2S,GAAO,GAC1BgkB,EAAQr7B,KAAKqX,KAGLjV,EACNi5B,EAAQ32B,QAAQtC,GAAU,GAC7Bi5B,EAAQr7B,KAAKoC,GAGVi5B,EAAQ32B,QAAQ28B,GAAQ,GAC3BhG,EAAQr7B,KAAKqhC,MAKVhG,EAAQp/B,KAAK,sXCnnCrB,MAAAs/B,EAAAllC,EAAA,IAgFAE,EAAAwgC,MAAA,SAA4B/5B,EAAkBw+B,2CAC7C,OAAOD,EAAAtX,cAA2B,UAAW,eAAgB,CAAC,gBAAiB,OAAQ,cAAe,gBAAiB,kBAAmBuX,EAAMx+B,sBCjFjJxG,EAAAD,QAAAmC,QAAA,meCAA,MAAAoiC,EAAAzkC,EAAA,IAIM6F,EAHNpB,EAAAzE,EAAA,IAGY0E,QAAO,kBAsBnBxE,EAAAy/B,qBAAA,cAA0C8E,EAAAv4B,iBAWzC7G,YAAYqH,GAEX7B,MAAM,EAAG,IAAM6B,EAAQL,WAZxB/G,KAAAoH,QAAU,CACTw8B,KAAM,6BACNC,KAAM,GACNC,SAAU,WACV/8B,UAAW,GACXozB,SAAS,EACT6J,WAAY,IACZC,WAAY,GAMZjkC,KAAKoH,QAAU5L,OAAO+N,OAAO,GAAIvJ,KAAKoH,QAASA,GAG1CrH,UAAU2R,EAAcwrB,2CAQ7B,aAPmBl9B,KAAKrE,IAAI,CAC3B4U,KAAMvQ,KAAKoH,QAAQ08B,SAAWpyB,EAAO,cACrCtO,MAAO,CACN7G,OAAWiI,IAAP04B,EAAmBA,EAAGz8B,gBAAa+D,GAExC6/B,MAAO,MAKKtkC,IAAIkM,2CACjB,MAAMpI,EAAIrI,OAAOmJ,KAAKsH,EAAI7I,OACxBgU,OAAO/a,QAA2BmI,IAAnByH,EAAI7I,MAAM/G,IAAyC,OAAnB4P,EAAI7I,MAAM/G,IACzDiQ,IAAIjQ,GAAOA,EAAM,IAAM4P,EAAI7I,MAAM/G,IAC7B6K,EAAMlH,KAAKoH,QAAQw8B,MAA8B,KAAtB5jC,KAAKoH,QAAQy8B,KAAc,IAAM7jC,KAAKoH,QAAQy8B,KAAO,IAAM53B,EAAIsE,KAAO,IAAM1M,EAAEvD,KAAK,KAM9G8G,EAAUpH,KAAKoH,QACfzL,EAAMqE,KAAKrE,IAEjB,SAAe0oC,EAAM74B,2CACpB,OAAIpE,EAAQ+yB,SAAWluB,EAAIo4B,MAAQj9B,EAAQ68B,YAC1Ch4B,EAAIo4B,QACJ9jC,EAAI8Q,KAAK,+BAAiCjK,EAAQ48B,WAAa,MACxD,IAAIv8B,QAAa,CAACC,EAASC,KACjCiuB,WAAW,KACVj6B,EAAIsQ,GAAK2c,KAAKlhB,GAASohB,MAAMnhB,IAC3BP,EAAQ48B,eAGLv8B,QAAQE,OAAO6D,KAIxBjL,EAAI8Q,KAAK,aAAcrJ,KAAK6c,UAAU5Y,IACtC,IACC,MAAMoS,QAAare,KAAK69B,QAAa32B,OAAK1C,GAC1C,MAxBwB,CAACuD,GACjBA,GAAQA,EAAKyD,OAASzD,EAAKyD,MAAMzC,QAAQ,yBAA2B,EAuBxEu7B,CAAiBjmB,GACbgmB,EAAMj/B,MAAMiZ,EAAK7S,QAElB6S,EACN,MAAOpO,GACR,MAAM0Y,EAAa1Y,EAAE0Y,WACrB,OAAmB,MAAfA,GAAqC,MAAfA,EAClB0b,EAAMp0B,IAEb1P,EAAIiL,MAAMyE,GACHxI,QAAQE,OAAOsI,ucC9F1B,MAAAkvB,EAAAzkC,EAAA,IAIM6F,EAHNpB,EAAAzE,EAAA,IAGY0E,QAAO,mBAsBnBxE,EAAAsgC,sBAAA,cAA2CiE,EAAAv4B,iBAY1C7G,YAAYqH,GAKX7B,MAAM,GAAI,IAAM6B,EAAQL,WAhBzB/G,KAAAoH,QAAU,CACTw8B,KAAM,8BACNC,KAAM,GACNC,SAAU,IACV/8B,UAAW,GACXg9B,MAAO,GACP5J,SAAS,EACT6J,WAAY,IACZC,WAAY,GASZjkC,KAAKoH,QAAU5L,OAAO+N,OAAO,GAAIvJ,KAAKoH,QAASA,GAG1CrH,cAAc2R,2CAMnB,aALmB1R,KAAKrE,IAAI,CAC3B4U,KAAMvQ,KAAKoH,QAAQ08B,SAAW,WAAapyB,EAAO,IAClDtO,MAAO,GACPihC,MAAO,MAKHtkC,mBAAmB2R,2CAMxB,aALmB1R,KAAKrE,IAAI,CAC3B4U,KAAMvQ,KAAKoH,QAAQ08B,SAAW,iBAAmBpyB,EAAO,IACxDtO,MAAO,GACPihC,MAAO,MAKKtkC,IAAIkM,2CACjB,MAAMpI,EAAIrI,OAAOmJ,KAAKsH,EAAI7I,OACxBgU,OAAO/a,QAA2BmI,IAAnByH,EAAI7I,MAAM/G,IAAyC,OAAnB4P,EAAI7I,MAAM/G,IACzDiQ,IAAIjQ,GAAOA,EAAM,IAAM4P,EAAI7I,MAAM/G,IAC7B6K,EAAMlH,KAAKoH,QAAQw8B,MAA8B,KAAtB5jC,KAAKoH,QAAQy8B,KAAc,IAAM7jC,KAAKoH,QAAQy8B,KAAO,IAAM53B,EAAIsE,KAAO,IAAM1M,EAAEvD,KAAK,KAK9G8G,EAAUpH,KAAKoH,QACfzL,EAAMqE,KAAKrE,IAEjB,SAAe0oC,EAAM74B,2CACpB,OAAIpE,EAAQ+yB,SAAWluB,EAAIo4B,MAAQj9B,EAAQ68B,YAC1Ch4B,EAAIo4B,QACJ9jC,EAAI8Q,KAAK,+BAAiCjK,EAAQ48B,WAAa,MACxD,IAAIv8B,QAAa,CAACC,EAASC,KACjCiuB,WAAW,KACVj6B,EAAIsQ,GAAK2c,KAAKlhB,GAASohB,MAAMnhB,IAC3BP,EAAQ48B,eAGLv8B,QAAQE,OAAO6D,KAIxBjL,EAAI8Q,KAAK,aAAcrJ,KAAK6c,UAAU5Y,IACtC,IACC,MAAMoS,QAAare,KAAK69B,QAAa32B,OAAK1C,GAC1C,MAvBwB,CAACuD,GACjBA,GAAQA,EAAKyD,OAASzD,EAAKyD,MAAMzC,QAAQ,yBAA2B,EAsBxEu7B,CAAiBjmB,GACbgmB,EAAMj/B,MAAMiZ,EAAK7S,QAElB6S,EACN,MAAOpO,GACR,GAAIA,aAAa41B,YAOhB,OAAOp+B,QAAQC,QAAQ,CAACoY,OAAQ,KAEjC,MAAM6I,EAAa1Y,EAAE0Y,WACrB,OAAmB,MAAfA,GAAqC,MAAfA,EAClB0b,EAAMp0B,IAEb1P,EAAIiL,MAAMyE,GACHxI,QAAQE,OAAOsI,ucCjH1B,MAAAkvB,EAAAzkC,EAAA,IAGM6F,EAFNpB,EAAAzE,EAAA,IAEY0E,QAAO,aAsHnBxE,EAAAogC,gBAAA,cAAqCmE,EAAAv4B,iBAEpC7G,YAAYgH,GAEXxB,MAAM,IAAK,IAAMwB,GAGZhH,QAAQ0Q,EAAe6sB,2CAC5B/8B,EAAI8Q,KAAK,qBAAsBZ,GAC/B,MAAMvJ,aAAkBo2B,GAAQ,+BAC1Bjf,QAAiCre,KAAK69B,QAA4B32B,EAAK,CAC5E4+B,OAAQ,QACRC,KAAM,WACNrmC,OAAQ,OACRsmC,QAAS,EACTC,UAAW,EACXC,OAAQz1B,IAET,IAAK4N,IAASA,EAAKjb,QAAUib,EAAKjb,MAAM+iC,MACvC,OAED,MAAMA,EAAQ9nB,EAAKjb,MAAM+iC,MACnBC,EAAOD,EAAM3qC,OAAOmJ,KAAKwhC,GAAO,IACtC,OAAKC,EAGE,CAAC31B,MAAO21B,EAAK31B,MAAO4D,QAAS+xB,EAAKC,QAASn/B,eAAiBo2B,GAAQ,2BAA4B8G,mBAAmBgC,EAAK31B,eAH/H,IAOK1Q,aAAa0Q,EAAe6sB,2CACjC/8B,EAAI8Q,KAAK,qBAAsBZ,GAC/B,MAAMvJ,aAAkBo2B,GAAQ,+CAAgD8G,mBAAmB3zB,KAC7F4N,QAAgCre,KAAK69B,QAA2B32B,EAAK,CAACo/B,SAAU,SACtF,GAAKjoB,EAGL,OAAOA,EAAKkoB,eAGPxmC,SAAS8C,2CAEdtC,EAAI8Q,KAAK,8BAA+BxO,GACxC,MAAMqE,6FAAiG,IACjGmX,QAAare,KAAK69B,QAA2B32B,EAAK,IACxD,GAAKmX,GAASA,EAAKmoB,SAGnB,OAAOnoB,EAAKmoB,SAAS3jC,qcCzKvB,MAAAjC,EAAAzB,EAAAzE,EAAA,IAMAwH,EAAAxH,EAAA,GACA+rC,EAAA/rC,EAAA,IAIM6F,EAHNpB,EAAAzE,EAAA,IAGY0E,QAAO,gBAEnB,MAAasnC,EAGZ3mC,YAAY4mC,EAA6CnmB,EAAkCzD,EAAkCO,GAApEtd,KAAAwgB,cAAkCxgB,KAAA+c,cAAkC/c,KAAAsd,aAC5Htd,KAAK81B,OAAS6Q,EAAYC,eAAetmC,KAAK,KAG/CP,eAAe1E,GAEd,MAAMwrC,EAAU,IAAIC,OAAO,UAAY9mC,KAAK81B,OAAS,cAAe,MAAM8P,KAAKvqC,GAC/E,OAAOwrC,EAAUA,EAAQ,GAAKxrC,EAG/B0E,aAAa1E,EAAc0rC,GAC1B,MAAM5rC,GAAK4rC,GAAY/mC,KAAKgnC,eAAe3rC,IAAS,IAAIwd,OAAOqrB,cAAcvY,OAAO,GAEpF,OAA+B,OAA3BxwB,EAAE6I,MADgB,wCAEd7I,EAED,IAGF4E,2DACL,MAAM0G,EAAsB,CAACsJ,OAAQ,GAAIsZ,aAAclpB,KAAKygB,OAoB5D,aAnBsB5gB,KAAKwgB,YAAYzU,OAAO,CAACyM,UAAWtW,EAAApD,UAAUN,SAC5DqG,QAAQvG,IACf,MAAMqR,EAA0B,CAACrR,UAC3B2oC,EAAYjnC,KAAKknC,aAAa5oC,EAAOjD,KAAMiD,EAAOmiB,UACxD,IAAIne,EAAQmE,EAAOsJ,OAAO4M,KAAKD,GAAKA,EAAErhB,OAAS4rC,GAC1C3kC,IACJA,EAAQ,CAACjH,KAAM4rC,EAAWj3B,QAAS,IACnCvJ,EAAOsJ,OAAO1L,KAAK/B,IAEpBA,EAAM0N,QAAQ3L,KAAKsL,KAEpBlJ,EAAOsJ,OAAOlL,QAAQvC,IACrBA,EAAM0N,QAAQlL,KAAK,CAAC0E,EAAGC,IACfD,EAAElL,OAAOjD,KAAKuhB,cAAcnT,EAAEnL,OAAOjD,SAG9CoL,EAAOsJ,OAAOjL,KAAK,CAAC0E,EAAGC,IACfD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAExBoL,IAGM1G,mBAAmBwO,2CAChC,OAAOvO,KAAKsd,WAAW6pB,YAAY,CAAChqB,OAAQ5O,EAAOgC,SAG9CxQ,2DACL,MAAM0G,EAAsB,CAACsJ,OAAQ,GAAIsZ,aAAclpB,KAAKygB,OACtDnD,QAAgBzd,KAAK+c,YAAYhR,OAAO,CAACzM,MAAO,IACtD,IAAK,MAAMiP,KAAUkP,EAAS,CAC7B,MAAM1H,QAAmB/V,KAAKonC,mBAAmB74B,GAC3CoB,EAA0B,CAC/BtU,KAAMuF,EAAAxB,QAAKkR,SAAS/B,EAAOgC,MAC3BkQ,SAAUlS,EAAOiC,IAAIyH,YAAcjY,KAAKgnC,eAAepmC,EAAAxB,QAAKkR,SAAS/B,EAAOgC,OAC5EwF,WAAYA,GAAc,EAC1BxH,UAEK04B,EAAYjnC,KAAKknC,aAAav3B,EAAMtU,KAAMsU,EAAM8Q,UACtD,IAAIne,EAAQmE,EAAOsJ,OAAO4M,KAAKD,GAAKA,EAAErhB,OAAS4rC,GAC1C3kC,IACJA,EAAQ,CAACjH,KAAM4rC,EAAWj3B,QAAS,IACnCvJ,EAAOsJ,OAAO1L,KAAK/B,IAEpBA,EAAM0N,QAAQ3L,KAAKsL,GAUpB,OARAlJ,EAAOsJ,OAAOlL,QAAQvC,IACrBA,EAAM0N,QAAQlL,KAAK,CAAC0E,EAAGC,IACfD,EAAEiX,SAAS7D,cAAcnT,EAAEgX,aAGpCha,EAAOsJ,OAAOjL,KAAK,CAAC0E,EAAGC,IACfD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAExBoL,IAGF1G,uDAGL,MAAO,CAACsnC,kBAFkBrnC,KAAKsnC,mBAEVC,kBADKvnC,KAAKwnC,uBAlFjC5sC,EAAA8rC,mBAuFA9rC,EAAAq2B,aAAA,MAKClxB,YAAoBygB,EAAkCzD,EAAkCO,GAApEtd,KAAAwgB,cAAkCxgB,KAAA+c,cAAkC/c,KAAAsd,aAHhFtd,KAAAynC,mBAAqB,IAAIhB,EAAAp7B,iBAC1BrL,KAAA2mC,YAAsC,CAACC,eAAgB,IAKvD7mC,YAAY4mC,GAClB3mC,KAAK2mC,YAAcA,EACf3mC,KAAK0nC,SACR1nC,KAAK0nC,YAASljC,GAIVzE,uDACLQ,EAAIid,MAAM,oBACV,MAAMmqB,EAAU,IAAIjB,EAAiB1mC,KAAK2mC,YAAa3mC,KAAKwgB,YAAaxgB,KAAK+c,YAAa/c,KAAKsd,YAEhG,OADAtd,KAAK0nC,aAAeC,EAAQtS,eACrBr1B,KAAK0nC,SAGP3nC,qDACL,GAAIC,KAAK0nC,OACR,OAAO1nC,KAAK0nC,OAGb,GAAI1nC,KAAKynC,mBAAmBG,UADZ,SAEf,OAAO5nC,KAAKynC,mBAAmBI,OAFhB,SAIhB7nC,KAAKynC,mBAAmBK,WAJR,SAKhB,IACC,MAAMrhC,QAAezG,KAAKq1B,eAE1B,aADMr1B,KAAKynC,mBAAmB//B,QAPf,QAOgCjB,GACxCA,EACN,MAAOwJ,GAER,aADMjQ,KAAKynC,mBAAmB9/B,OAVf,QAU+BsI,GACvCxI,QAAQE,OAAOsI,MAIlBlQ,yDAEL,aADsBC,KAAK+nC,cACZV,cAGVtnC,yDAEL,aADsBC,KAAK+nC,cACZR,cAGhBxnC,kBAAkBwd,EAA4B8pB,GAC7C,OAAK9pB,EAGE,CACN8L,aAAcge,EAAYhe,aAC1BtZ,OAAQs3B,EAAYt3B,OAAOzD,IAAIhK,IACvB,CACNjH,KAAMiH,EAAMjH,KACZ2U,QAAS1N,EAAM0N,QAAQoH,OAAOzH,GAASA,EAAMpB,OAAOgP,SAAWA,MAE9DnG,OAAO9U,GAASA,EAAM0N,QAAQjO,OAAS,IATnCslC,EAaTtnC,kBAAkBwd,EAA4BgqB,GAC7C,OAAKhqB,EAGE,CACN8L,aAAcke,EAAYle,aAC1BtZ,OAAQw3B,EAAYx3B,OAAOzD,IAAIhK,IACvB,CACNjH,KAAMiH,EAAMjH,KACZ2U,QAAS1N,EAAM0N,QAAQoH,OAAOzH,GAASA,EAAMrR,OAAOoiB,QAAQ3X,QAAQwU,IAAW,MAE9EnG,OAAO9U,GAASA,EAAM0N,QAAQjO,OAAS,IATnCwlC,kcCxKV,MAAArlC,EAAAxH,EAAA,GAEAwP,EAAAxP,EAAA,IAUAyO,EAAAzO,EAAA,GAIAstC,EAAAttC,EAAA,IACAqS,EAAArS,EAAA,GAEAkG,EAAAzB,EAAAzE,EAAA,IAMA,SAASutC,EAAkBz2B,GAC1B,OAAQA,GAAW,IAAI9P,QAAQ,8CAA+C,IAC5EA,QAAQ,iDAAkD,IAC1DA,QAAQ,2GAA4G,IAGvH,SAASwmC,EAAyB12B,GACjC,OAAQA,GAAW,IACjB9P,QAAQ,oCAAqC,IAC7CA,QAAQ,OAAQ,IAChBA,QAAQ,SAAU,MAgBrB9G,EAAAw4B,gBAAA,cAAqCjqB,EAAApD,iBAEpChG,YAAoBooC,EAAsCprB,EAAkCO,EAAgC4D,EAAgCV,EAAkCrG,GAC7L5U,MAAM4iC,GADanoC,KAAAmoC,gBAAsCnoC,KAAA+c,cAAkC/c,KAAAsd,aAAgCtd,KAAAkhB,aAAgClhB,KAAAwgB,cAAkCxgB,KAAAma,cAIhLpa,oCAAoCgY,2CACjD,MAAMtR,QAAezG,KAAKooC,kBAAiB,SAA+BrwB,GAC1E,GAAItR,GAAUA,EAAOnI,QAAUmI,EAAOnI,OAAO+pC,UAAW,CACvD,IAAIC,EAAM7hC,EAAOnI,OAAO+pC,UAAU1rB,KAAK/gB,GAAgB,aAAXA,EAAEwG,MAC9C,GAAIkmC,GAAOA,EAAIphC,KAAOohC,EAAIphC,IAAIqhC,SAAU,CACvC,MAAMngC,EAAOkgC,EAAIphC,IAAIqhC,SAASptB,MAAM,KAC9BtY,EAAKuF,EAAKA,EAAKrG,OAAS,GACxBwP,QAAavR,KAAKwoC,gBAAgB3lC,EAAI,MAC5C,GAAI0O,GAAQA,EAAK8C,QAQhB,MAP+B,CAC9BnN,IAAKqK,EAAK8C,QAAQnN,IAClB8M,YAAak0B,EAAyB32B,EAAK8C,QAAQA,SACnDo0B,OAAQ,YACRC,QAAS,iCACTC,WAAY,mDAMf,IADAL,EAAM7hC,EAAOnI,OAAO+pC,UAAU1rB,KAAK/gB,GAAgB,cAAXA,EAAEwG,QAC/BkmC,EAAIphC,KAAOohC,EAAIphC,IAAIqhC,SAAU,CACvC,MAAMngC,EAAOkgC,EAAIphC,IAAIqhC,SAASptB,MAAM,KAC9B1K,EAAQrI,EAAKA,EAAKrG,OAAS,GAC3Bu7B,EAAOl1B,EAAK,GAAG+S,MAAM,KAAK,GAC1B5J,QAAavR,KAAK4oC,iBAAiBn4B,EAAO6sB,GAChD,GAAI/rB,GAAQA,EAAK8C,QAQhB,MAP+B,CAC9BnN,IAAKqK,EAAK8C,QAAQnN,IAClB8M,YAAak0B,EAAyB32B,EAAK8C,QAAQA,SACnDo0B,OAAQ,YACRC,QAAS,iCACTC,WAAY,uDASH5oC,mCAAmC8oC,2CAChD,MAAMpiC,QAAezG,KAAKooC,kBAAiB,UAAgCS,GAC3E,GAAIpiC,GAAUA,EAAOy+B,SAAWz+B,EAAOy+B,QAAQmD,UAAW,CACzD,MAAMC,EAAM7hC,EAAOy+B,QAAQmD,UAAU1rB,KAAK/gB,GAAgB,aAAXA,EAAEwG,MACjD,GAAIkmC,GAAOA,EAAIphC,KAAOohC,EAAIphC,IAAIqhC,SAAU,CACvC,MAAMngC,EAAOkgC,EAAIphC,IAAIqhC,SAASptB,MAAM,KAC9BtY,EAAKuF,EAAKA,EAAKrG,OAAS,GACxBwP,QAAavR,KAAKwoC,gBAAgB3lC,EAAI,MAC5C,GAAI0O,GAAQA,EAAK8C,QAQhB,MAP+B,CAC9BnN,IAAKqK,EAAK8C,QAAQnN,IAClB8M,YAAak0B,EAAyB32B,EAAK8C,QAAQA,SACnDo0B,OAAQ,YACRC,QAAS,iCACTC,WAAY,uDASH5oC,oBAAoBgY,2CACjC,MAAMtR,QAAezG,KAAK8oC,aAAa5mC,EAAAlD,iBAAiBV,OAAQyZ,GAChE,GAAItR,GAAUA,EAAOnI,QAAUmI,EAAOnI,OAAO4T,KAAOzL,EAAOnI,OAAO4T,IAAIV,QAQrE,MAP+B,CAC9BtK,IAAKT,EAAOnI,OAAO4I,IACnB8M,YAAai0B,EAAkBxhC,EAAOnI,OAAO4T,IAAIV,SACjDi3B,OAAQ,SACRC,QAAS,iCACTC,WAAY,qDAOD5oC,mBAAmB8oC,2CAChC,MAAMpiC,QAAezG,KAAK8oC,aAAa5mC,EAAAlD,iBAAiBR,MAAOqqC,GAC/D,GAAIpiC,GAAUA,EAAOjI,OAASiI,EAAOjI,MAAM+S,MAAQ9K,EAAOjI,MAAM+S,KAAKC,QAQpE,MAP+B,CAC9BtK,IAAKT,EAAOjI,MAAM0I,IAClB8M,YAAai0B,EAAkBxhC,EAAOjI,MAAM+S,KAAKC,SACjDi3B,OAAQ,SACRC,QAAS,iCACTC,WAAY,qDAOD5oC,6BAA6BgY,2CAC1C,IAAI1G,QAAarR,KAAK+oC,oCAAoChxB,GAC1D,OAAI1G,IAGJA,QAAarR,KAAKgpC,oBAAoBjxB,UACtC,IAMahY,4BAA4B8oC,2CACzC,IAAIx3B,QAAarR,KAAKipC,mCAAmCJ,GACzD,OAAIx3B,IAGJA,QAAarR,KAAKkpC,mBAAmBL,UACrC,IAMa9oC,oBAAoB29B,2CACjC,MAAMlZ,QAAYxkB,KAAKmpC,kBAAiB,SAA+B,CAAC7qC,OAAQo/B,IAChF,GAAIlZ,GAAOA,EAAI3I,SAAkC,IAAvB2I,EAAI3I,QAAQ9Z,OAAc,CACnD,MAAMsP,QAAarR,KAAKopC,6BAA6B5kB,EAAI3I,QAAQ,GAAGhZ,IACpE,GAAIwO,EACH,OAAOA,EAGT,MAAMmpB,QAAex6B,KAAKqpC,mBAAmB3L,GAC7C,GAAIlD,GAAUA,EAAOl8B,QAAUk8B,EAAOl8B,OAAOoT,KAAM,CAClD,MAAML,QAAarR,KAAKopC,6BAA6B5O,EAAOl8B,OAAOoT,MACnE,GAAIL,EACH,OAAOA,KAMItR,mBAAmBupC,EAAmB5L,2CACnD,MAAMlZ,QAAYxkB,KAAKmpC,kBAAiB,UAAgC,CAACjE,QAASoE,EAAWhrC,OAAQo/B,IACrG,GAAIlZ,GAAOA,EAAI+kB,UAAY/kB,EAAI+kB,SAASxnC,OAAS,EAAG,CACnD,MAAMsP,QAAarR,KAAKwpC,4BAA4BhlB,EAAI+kB,SAAS,GAAG1mC,IACpE,GAAIwO,EACH,OAAOA,EAGT,MAAMmpB,QAAex6B,KAAKypC,kBAAkBH,EAAW5L,GACvD,GAAIlD,GAAUA,EAAOh8B,OAASg8B,EAAOh8B,MAAMkT,KAAM,CAChD,MAAML,QAAarR,KAAKwpC,4BAA4BhP,EAAOh8B,MAAMkT,MACjE,GAAIL,EACH,OAAOA,KAQJtR,cAAczB,2CACnB,GAAIA,EAAOyZ,WAAY,CACtB,MAAM1G,QAAarR,KAAKopC,6BAA6B9qC,EAAOyZ,YAC5D,GAAI1G,EACH,OAAOA,EAGT,GAAI/S,EAAOjD,KAAM,CAChB,MAAMgW,QAAarR,KAAK0pC,oBAAoBprC,EAAOjD,MACnD,GAAIgW,EACH,OAAOA,KAMJtR,aAAavB,2CAClB,GAAIA,EAAMuc,UAAW,CACpB,MAAM1J,QAAarR,KAAKwpC,4BAA4BhrC,EAAMuc,WAC1D,GAAI1J,EACH,OAAOA,EAGT,GAAI7S,EAAMnD,MAAQmD,EAAMF,OAAQ,CAC/B,MAAM+S,QAAarR,KAAK2pC,mBAAmBnrC,EAAMnD,KAAMmD,EAAMF,QAC7D,GAAI+S,EACH,OAAOA,KAMJtR,oBAAoBwO,2CACzB,GAAIA,EAAOiC,IAAIuH,WAAY,CAC1B,MAAM1G,QAAarR,KAAKopC,6BAA6B76B,EAAOiC,IAAIuH,YAChE,GAAI1G,EACH,OAAOA,EAGT,GAAI9C,EAAOiC,IAAIlS,OAAQ,CACtB,MAAM+S,QAAarR,KAAK0pC,oBAAoBn7B,EAAOiC,IAAIlS,QACvD,GAAI+S,EACH,OAAOA,KAMJtR,mBAAmBwO,2CACxB,GAAIA,EAAOiC,IAAIuK,UAAW,CACzB,MAAM1J,QAAarR,KAAKwpC,4BAA4Bj7B,EAAOiC,IAAIuK,WAC/D,GAAI1J,EACH,OAAOA,EAGT,GAAI9C,EAAOiC,IAAIhS,OAAS+P,EAAOiC,IAAIlS,OAAQ,CAC1C,MAAM+S,QAAarR,KAAK2pC,mBAAmBp7B,EAAOiC,IAAIhS,MAAO+P,EAAOiC,IAAIlS,QACxE,GAAI+S,EACH,OAAOA,KAQItR,wBAAwBgY,2CACrC,MAAMyiB,QAAex6B,KAAK8oC,aAAa5mC,EAAAlD,iBAAiBV,OAAQyZ,GAChE,OAAIyiB,GAAUA,EAAOl8B,QAAUk8B,EAAOl8B,OAAO0T,SAAWwoB,EAAOl8B,OAAO0T,QAAQ1T,OACtEk8B,EAAOl8B,OAAO0T,QAAQ1T,OAEvB,KAGMyB,yBAAyB6pC,2CACtC,MAAMC,EAAuB,GAM7B,OALAD,EAAe/kC,QAAQ2E,IAClBA,EAAEnO,MACLwuC,EAAMxlC,KAAKmF,EAAEnO,cAGF2E,KAAK+c,YAAYhR,OAAO,CAACsT,MAAO,CAACnd,EAAAlF,WAAWsB,QAASud,QAASguB,MAG9D9pC,mBAAmB6pC,2CAChC,MAAMC,EAAuB,GAM7B,OALAD,EAAe/kC,QAAQ2E,IAClBA,EAAEnO,MACLwuC,EAAMxlC,KAAKmF,EAAEnO,cAGF2E,KAAKwgB,YAAYzU,OAAO,CAAC89B,YAGzB9pC,sBAAsBgY,EAAqBzZ,2CACxD,IAAI0T,EAAgC,GACpC,GAAI+F,EACH/F,QAAgBhS,KAAK8pC,wBAAwB/xB,QACvC,GAAIzZ,EAAQ,CAClB,MAAMkL,QAAUxJ,KAAKqpC,mBAAmB/qC,GACpCkL,GAAKA,EAAElL,SACV0T,QAAgBhS,KAAK8pC,wBAAwBtgC,EAAElL,OAAOoT,OAGxD,OAAOM,IAGFjS,kBAAkBzB,2CACvB,MAAM0T,QAAgBhS,KAAK+pC,sBAAsBzrC,EAAOyZ,WAAYzZ,EAAOjD,MAC3E,OAAI2W,GAAWA,EAAQjQ,OAAS,EACxB/B,KAAKgqC,mBAAmBh4B,GAEzB,KAGFjS,wBAAwBwO,2CAC7B,MAAMyD,QAAgBhS,KAAK+pC,sBAAsBx7B,EAAOiC,IAAIuH,WAAYxJ,EAAOiC,IAAIlS,QACnF,OAAI0T,GAAWA,EAAQjQ,OAAS,EACxB/B,KAAKiqC,yBAAyBj4B,GAE/B,KAKMjS,kBAAkBmqC,2CAC/B,MAAMlnC,EAAmB,GACnBmnC,EAAoB,GACpB1jC,EAAuB,GAC7ByjC,EAAMrlC,QAAQulC,IACTA,EAAI14B,KACP1O,EAAIqB,KAAK+lC,GAETD,EAAK9lC,KAAK+lC,KAGZ,MAAMC,EAAarnC,EAAIsJ,IAAI8F,GAASA,EAAMV,MAAQ,KAAK0F,OAAOvU,GAAa,MAAPA,GAC9DmS,QAAehV,KAAKsd,WAAWvR,OAAO,CAACs+B,eAC7CrnC,EAAI6B,QAAQulC,IACX,MAAMpuC,EAAIgZ,EAAO2H,KAAK2tB,GAAMA,EAAG95B,IAAIiW,YAAc2jB,EAAI14B,MAChD1V,EAGJyK,EAAOpC,KAAKrI,GAFZmuC,EAAK9lC,KAAK+lC,KAKZ,IAAK,MAAMA,KAAOD,EAAM,CACvB,MAAM/3B,QAAcpS,KAAKsd,WAAWN,UAAU,CAACvM,MAAO25B,EAAI/uC,KAAMiD,OAAQ8rC,EAAI9rC,SACxE8T,GACH3L,EAAOpC,KAAK+N,GAGd,OAAO3L,IAGM1G,gBAAgBiS,2CAC7B,IAAIgD,EAAsB,GAC1B,IAAK,MAAM1W,KAAU0T,EAAS,CAC7B,IAAIqM,EACA/f,EAAOoT,KACV2M,QAAare,KAAKuqC,wBAAwBjsC,EAAOoT,MACvCpT,EAAOjD,OACjBgjB,QAAare,KAAKwqC,sBAAsBlsC,EAAOjD,OAE5CgjB,GAAQA,EAAKilB,WAAajlB,EAAKilB,UAAUlxB,QAC5C4C,EAASA,EAAO3U,OAAOge,EAAKilB,UAAUlxB,MAAM9F,IAAIgJ,IACxC,CACNja,KAAMia,EAAKja,KACXiD,OAAQgX,EAAKhX,OAAOjD,KACpBqW,KAAM4D,EAAK5D,KACXxK,IAAKoO,EAAKpO,SAKd,OAAOgD,EAAA/B,QAAQ6M,KAGFjV,uBAAuB0qC,2CACpC,IAAKA,GAAgC,IAApBA,EAAS1oC,OACzB,MAAO,GAER,MAAMmoC,QAAclqC,KAAK0qC,gBAAgBD,GACzC,aAAazqC,KAAK2qC,kBAAkBT,KAG/BnqC,aAAazB,2CAClB,MAAMmI,QAAezG,KAAKwqC,sBAAsBlsC,GAChD,GAAImI,GAAUA,EAAO68B,WAAa78B,EAAO68B,UAAUlxB,MAAO,CACzD,MAAM83B,EAAqBzjC,EAAO68B,UAAUlxB,MAAM9F,IAAItQ,IAC9C,CACNX,KAAMW,EAAEX,KACRiD,OAAQtC,EAAEsC,OAAOjD,KACjBqW,KAAM1V,EAAE0V,KACRxK,IAAKlL,EAAEkL,OAGT,aAAalH,KAAK2qC,kBAAkBT,GAErC,MAAO,KAGFnqC,sBAAsBvB,2CAC3B,MAAMwT,QAAgBhS,KAAK+pC,sBAAsBvrC,EAAMuZ,WAAYvZ,EAAMF,QACzE,OAAO0B,KAAK4qC,uBAAuB54B,KAG9BjS,uBAAuBzB,2CAC5B,MAAM0T,QAAgBhS,KAAK+pC,sBAAsBzrC,EAAOyZ,WAAYzZ,EAAOjD,MAC3E,OAAO2E,KAAK4qC,uBAAuB54B,KAG9BjS,uBAAuBwO,2CAC5B,MAAMyD,QAAgBhS,KAAK+pC,sBAAsBx7B,EAAOiC,IAAIuH,WAAYxJ,EAAOiC,IAAIlS,QACnF,OAAO0B,KAAK4qC,uBAAuB54B,KAG9BjS,sBAAsBqS,2CAC3B,GAAIA,EAAM5B,IAAIiW,UAAW,CACxB,MAAMpI,QAAare,KAAK6qC,oBAAoBz4B,EAAM5B,IAAIiW,WACtD,GAAIpI,GAAQA,EAAKklB,eAAiBllB,EAAKklB,cAAcnxB,MAAO,CAC3D,MAAM83B,EAAQ7rB,EAAKklB,cAAcnxB,MAAM9F,IAAItQ,IACnC,CACNX,KAAMW,EAAEX,KACRiD,OAAQtC,EAAEsC,OAAOjD,KACjBqW,KAAM1V,EAAE0V,KACRxK,IAAKlL,EAAEkL,OAGT,aAAalH,KAAK2qC,kBAAkBT,IAGtC,MAAO,KAKFnqC,kBAAkBqC,EAAcgB,2CACrC,MAAM/H,EAAO,UAAY+G,EAAO4F,KAAK6c,UAAUzhB,GACzCqD,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAalkB,cAChF,GAAIpgB,EACH,OAAOA,EAAO4X,KAEf,MAAM2sB,QAAehrC,KAAKma,YAAYgvB,kBAAkB/mC,EAAMgB,GAE9D,aADMpD,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAalkB,YAAaxI,KAAM2sB,IAC5GA,IAGFjrC,oBAAoBqS,EAAcxH,2CAEvC,aADuB5K,KAAKma,YAAY+wB,eAAetqC,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,MAAOuP,KAIrF7K,aAAaqC,EAAcsP,2CAChC,MAAMrW,EAAO,UAAY+G,EAAOsP,EAC1BjL,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,QAAex6B,KAAKma,YAAY2uB,aAAa1mC,EAAMsP,GAEzD,aADM1R,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,kBAAkBvB,EAAeF,2CACtC,MAAMjD,EAAO,gBAAkBmD,EAAQ,KAAOF,EACxCmI,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,EAAS,CAACh8B,YAAawB,KAAKma,YAAYmgB,OAAO97B,MAAMA,EAAOF,IAElE,aADM0B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,mBAAmBzB,2CACxB,MAAMjD,EAAO,iBAAmBiD,EAC1BmI,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,EAAS,CAACl8B,aAAc0B,KAAKma,YAAYmgB,OAAOh8B,OAAOA,IAE7D,aADM0B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,sBAAsBzB,2CAC3B,MAAMjD,EAAO,oBAAsBiD,EAC7BmI,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,EAAS,CAAC8I,gBAAiBtjC,KAAKma,YAAYmgB,OAAO6Q,eAAe7sC,IAExE,aADM0B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,wBAAwB2R,2CAC7B,MAAMrW,EAAO,sBAAwBqW,EAC/BjL,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,EAAS,CAAC8I,gBAAiBtjC,KAAKma,YAAYmgB,OAAOoJ,iBAAiBhyB,IAE1E,aADM1R,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,oBAAoB2R,2CACzB,MAAMrW,EAAO,mBAAqBqW,EAC5BjL,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAavQ,SAChF,GAAI/zB,EACH,OAAOA,EAAO4X,KAEf,MAAMmc,EAAS,CAAC+I,oBAAqBvjC,KAAKma,YAAYmgB,OAAOmJ,eAAe/xB,IAE5E,aADM1R,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAavQ,OAAQnc,KAAMmc,IACvGA,IAGFz6B,qBAAqB2R,EAAcwrB,2CACxC,MAAM7hC,EAA+C,IAAM6hC,EACrDz2B,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAa3Q,iBAChF,GAAI3zB,EACH,OAAOA,EAAO4X,KAEf,MAAM+sB,QAAgBprC,KAAKma,YAAYkxB,qBAAqB35B,EAAMwrB,GAElE,aADMl9B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAa3Q,eAAgB/b,KAAM+sB,IAC/GA,IAGFrrC,sBAAsBqC,EAAcsP,2CACzC,MAAMrW,EAAO,UAAY+G,EAAOsP,EAC1BjL,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAa5P,kBAChF,GAAI10B,EACH,OAAOA,EAAO4X,KAEf,MAAMitB,QAAYtrC,KAAKma,YAAYoxB,sBAAsBnpC,EAAMsP,GAE/D,aADM1R,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAa5P,gBAAiB9c,KAAMitB,IAChHA,IAGFvrC,kBAAkBqC,EAAcsP,EAAcsrB,2CACnD,MAAM3hC,EAAO,UAAY+G,EAAOsP,GAAQsrB,GAAY,IAC9Cv2B,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAalkB,cAChF,GAAIpgB,EACH,OAAOA,EAAO4X,KAEf,MAAM2sB,QAAehrC,KAAKma,YAAYiuB,kBAAkBhmC,EAAMsP,EAAMsrB,GAEpE,aADMh9B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAalkB,YAAaxI,KAAM2sB,IAC5GA,IAGFjrC,iBAAiB0Q,EAAe6sB,2CAErC,MAAMjiC,EAAO,WAAaoV,EAAQ,KADlC6sB,EAAOA,GAAQ,MAET72B,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAahQ,YAChF,GAAIt0B,EACH,OAAOA,EAAO4X,KAEf,MAAMmtB,EAAQ,CAACn3B,cAAerU,KAAKma,YAAYyuB,iBAAiBn4B,EAAO6sB,IAEvE,aADMt9B,KAAKmoC,cAAczlC,IAAI,CAACG,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAahQ,UAAW1c,KAAMmtB,IAC1GA,IAGFzrC,gBAAgB8C,EAAYy6B,2CACjC,MAAMjiC,EAAO,sBAAwBwH,EACrC,IAAI4D,QAAezG,KAAKmoC,cAAcnrB,UAAU,CAAC3hB,OAAMyvC,SAAU9C,EAAA+C,aAAaxN,WAC9E,IAAK92B,EAAQ,CACZ,MAAMglC,QAAezrC,KAAKma,YAAYuxB,WAAW7oC,GACjD,IAAK4oC,EACJ,MAAO,GAERhlC,EAAS,CAAC5D,GAAI,GAAIxH,OAAM+G,KAAM2K,EAAAjQ,aAAamuC,SAAUH,SAAU9C,EAAA+C,aAAaxN,SAAUlf,KAAMotB,SACtFzrC,KAAKmoC,cAAczlC,IAAI+D,GAG9B,MAAMklC,GADNrO,EAAOA,GAAQ,MACK,OACpB,GAAI72B,EAAO4X,MAAQ5X,EAAO4X,KAAKutB,UAAW,CACzC,MAAMC,EAAWplC,EAAO4X,KAAKutB,UAAUD,GACvC,OAAKE,QAGQ7rC,KAAK4oC,iBAAiBiD,EAASp7B,MAAO6sB,GAF3C,GAIT,MAAO,sFCnlBT,SAAYyN,GACXA,IAAA,6BACAA,IAAA,yBACAA,IAAA,uBACAA,IAAA,uBACAA,IAAA,mCACAA,IAAA,qCACAA,IAAA,mBAPD,CAAYnwC,EAAAmwC,eAAAnwC,EAAAmwC,aAAY,mcCDxB,MAAAj+B,EAAApS,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IAEAoxC,EAAApxC,EAAA,IAQAyO,EAAAzO,EAAA,GACAu1B,EAAAv1B,EAAA,IAEMqxC,EAAiBrxC,EAAQ,IAE/BE,EAAA82B,YAAA,cAAiCvoB,EAAApD,iBAKhChG,YAAmBisC,EAA+Bra,EAA8BrP,EAAgCM,EAAsCF,EAC3IkP,EAAwCxX,GAClD7U,MAAMosB,GAFY3xB,KAAAgsC,iBAA+BhsC,KAAA2xB,YAA8B3xB,KAAAsiB,aAAgCtiB,KAAA4iB,gBAAsC5iB,KAAA0iB,gBAC3I1iB,KAAA4xB,iBAAwC5xB,KAAAoa,cAL3Cpa,KAAA0nC,OAEJ,GAOE3nC,aAAa6J,EAAY+C,EAAejN,2CAC7C,GAAIkK,EAAKqiC,OACR,OAAOjsC,KAAKoa,YAAYze,IAAIiO,EAAK/G,GAAIjC,EAAAxB,QAAKkB,KAAKN,KAAKgsC,eAAgBpiC,EAAKqiC,QAASt/B,EAAMjN,KAIpFK,aAAa6J,EAAYvI,2CAC9B,MAAM6qC,EAAe,UAAYtiC,EAAK/G,GAAK,OACrCspC,EAAWvrC,EAAAxB,QAAKkB,KAAKN,KAAKgsC,eAAgBE,SAC1Cp/B,EAAAhM,mBAAmBqrC,SACnBnsC,KAAKoa,YAAYgyB,aAAa/qC,EAAU8qC,SACxCnsC,KAAKoa,YAAYiyB,oBAAoBziC,EAAK/G,IAChD+G,EAAKqiC,OAASC,EACdtiC,EAAKyE,kBAAoBlO,KAAKygB,YACxB5gB,KAAK6lB,OAAOjc,KAGb7J,OAAO6J,2CACZ,OAAKA,EAAKvO,MAAoC,IAA5BuO,EAAKvO,KAAKwd,OAAO9W,cAGR/B,KAAKssC,UAAU1iC,EAAKvO,OAEvCoM,QAAQE,OAAOvC,MAAM,4BAEtBpF,KAAK2xB,UAAUjvB,IAAIkH,GANlBnC,QAAQE,OAAOvC,MAAM,uBASxBrF,OAAO6J,iDACN5J,KAAK2xB,UAAUjwB,QAAQkI,UACtB5J,KAAK0nC,OAAO99B,EAAK/G,MAGnB9C,OAAO6J,kDACL5J,KAAK0nC,OAAO99B,EAAK/G,UAClB7C,KAAKsiB,WAAW5e,cAAc,CAACqR,OAAQnL,EAAK/G,WAC5C7C,KAAK4iB,cAAclf,cAAc,CAACqR,OAAQnL,EAAK/G,WAC/C7C,KAAK0iB,cAAchf,cAAc,CAACqR,OAAQnL,EAAK/G,WAC/C7C,KAAK4xB,eAAeluB,cAAc,CAACqR,OAAQnL,EAAK/G,WAChD7C,KAAKoa,YAAYiyB,oBAAoBziC,EAAK/G,UAC1C7C,KAAK2xB,UAAUxwB,OAAOyI,EAAK/G,IAE7B+G,EAAKqiC,eACFn/B,EAAAhM,mBAAmBF,EAAAxB,QAAKkB,KAAKN,KAAKgsC,eAAgBpiC,EAAKqiC,YAIzDlsC,UAAU1E,2CACf,IAAKA,GAA+B,IAAvBA,EAAKwd,OAAO9W,OACxB,OAAO0F,QAAQE,OAAOvC,MAAM,qBAE7B,MAAMpC,EAAMxH,OAAOmJ,KAAK3E,KAAK0nC,QAC7B,IAAK,MAAM7kC,KAAMG,EAChB,GAAIhD,KAAK0nC,OAAO7kC,GAAIxH,OAASA,EAC5B,OAAO2E,KAAK0nC,OAAO7kC,GAGrB,MAAM+G,QAAa5J,KAAK2xB,UAAU3U,UAAU,CAAC3hB,SAI7C,OAHIuO,IACH5J,KAAK0nC,OAAO99B,EAAK/G,IAAM+G,GAEjBA,IAGF7J,QAAQ8C,2CACb,IAAI+G,EAAyB5J,KAAK0nC,OAAO7kC,GACzC,OAAI+G,KAGJA,QAAa5J,KAAK2xB,UAAU5uB,KAAKF,MAEhC7C,KAAK0nC,OAAO7kC,GAAM+G,GAEZA,KAGF7J,KAAK1E,EAAcy4B,2CACxB,IAAMA,IAAWA,EAAK/xB,OACrB,OAAO0F,QAAQE,OAAOvC,MAAM,qBAE7B,MAAMwE,QAAa5J,KAAKssC,UAAUjxC,GAClC,OAAKuO,EAGQqmB,EAAAzK,SAASsO,EAAMlqB,EAAK8b,QACpB9b,EAAK+b,KACVle,QAAQE,OAAOvC,MAAM,qBAEtBwE,EANCnC,QAAQE,OAAOvC,MAAM,uBASxBrF,aAAa1E,EAAcy4B,2CAChC,IAAMA,IAAWA,EAAK/xB,OACrB,OAAO0F,QAAQE,OAAOvC,MAAM,qBAE7B,MAAMwE,QAAa5J,KAAKssC,UAAUjxC,GAClC,OAAKuO,EAGDkqB,IAASlqB,EAAKmqB,cACVtsB,QAAQE,OAAOvC,MAAM,qBAEtBwE,EALCnC,QAAQE,OAAOvC,MAAM,uBAQxBrF,UAAU1E,EAAckxC,EAAe7mB,2CAC5C,IAAKrqB,GAA+B,IAAvBA,EAAKwd,OAAO9W,OACxB,OAAO0F,QAAQE,OAAOvC,MAAM,qBAE7B,IAAMmnC,IAAYA,EAAMxqC,OACvB,OAAO0F,QAAQE,OAAOvC,MAAM,kBAE7B,MAAMwE,QAAa5J,KAAKssC,UAAUjxC,GAClC,IAAKuO,EACJ,OAAOnC,QAAQE,OAAOvC,MAAM,qBAE7B,MAAMpJ,EAAI8vC,EAAAU,IAAIC,KAAK7iC,EAAKmqB,cAAgBrO,GACxC,OAAI6mB,IAAUvwC,EACNyL,QAAQE,OAAOvC,MAAM,kBAEtBwE,IAGD7J,aACNC,KAAK0nC,OAAS,GAGT3nC,gBAAgB6J,EAAYkqB,iDAC3B9zB,KAAK0sC,aAAa5Y,GACxB,MAAMD,EAAK5D,EAAAlK,iBAAiB+N,GAC5BlqB,EAAK8b,KAAOmO,EAAGnO,KACf9b,EAAK+b,KAAOkO,EAAGlO,WACT3lB,KAAK2xB,UAAUjwB,QAAQkI,UACtB5J,KAAK0nC,OAAO99B,EAAK/G,MAGnB9C,aAAa0lB,2CAClB,OAAMA,GAAeA,EAAS5M,OAAO9W,OAGjC0jB,EAAS1jB,OAAS,EACd0F,QAAQE,OAAOvC,MAAM,0BAEzB2mC,EAAetmB,GACXhe,QAAQE,OAAOvC,MAAM,gGAD7B,EALQqC,QAAQE,OAAOvC,MAAM,uBAUxBrF,aAAa6J,EAAYuE,2CAC9B,IAAMA,IAAYA,EAAM0K,OAAO9W,OAC9B,OAAO0F,QAAQE,OAAOvC,MAAM,kBAE7BwE,EAAKuE,MAAQA,QACPnO,KAAK2xB,UAAUjwB,QAAQkI,UACtB5J,KAAK0nC,OAAO99B,EAAK/G,uBCpL1BhI,EAAAD,QAAAmC,QAAA,iCCAAlC,EAAAD,QAAAmC,QAAA,ydCAA,MAAA8P,EAAA1N,EAAAzE,EAAA,KAKAE,EAAA01B,YAAA,MAKCvwB,cAJQC,KAAA2sC,SAA+B,GAC/B3sC,KAAA+Q,SAA4BlE,EAAAzN,QAAO2R,SAAS,EAAG,KAC/C/Q,KAAA4sC,WAAoC,CAACC,YAAa,EAAGC,OAAQ,CAAC/wC,MAAO,EAAGgxC,KAAM,MAKtFhtC,YAAY6sC,GACX5sC,KAAK4sC,WAAaA,EAClB5sC,KAAK+Q,SAAWlE,EAAAzN,QAAO2R,SAAS/Q,KAAK4sC,WAAWE,OAAO/wC,MAA+BiE,KAAK4sC,WAAWE,OAAOC,MAGxGhtC,mDACL,MAAM3E,EAAIyR,EAAAzN,UAAS4tC,SAAShtC,KAAK+Q,UAAU8M,UAC3C7d,KAAK2sC,SAAW3sC,KAAK2sC,SAASv1B,OAAOjc,GAAKC,EAAID,EAAEyY,QAG3C7T,KAAK6T,2CACV,OAAO5T,KAAK2sC,SAAShwB,KAAKhX,GAAOA,EAAIiO,OAASA,KAGzC7T,OAAOsF,2CACZrF,KAAK2sC,SAAW3sC,KAAK2sC,SAASv1B,OAAOzR,GAAOA,EAAIiO,OAASvO,EAAQuO,QAG5D7T,IAAIktC,iDACHjtC,KAAKktC,WACX,IAAI9kC,EAA2BpI,KAAK2sC,SAIpC,YAHcnoC,IAAVyoC,GAAwBx6B,MAAMw6B,KACjC7kC,EAAOA,EAAKgP,OAAOzR,GAAOA,EAAIiO,KAAOq5B,IAE/B7kC,IAGFrI,IAAIsF,EAAiBuE,iDACpB5J,KAAKktC,WACX,MAAM/xC,EAAI,CACTkK,QAASA,EACTuO,KAAMzT,KAAKygB,MACX1S,SAAUtE,EAAKvO,KACf0Z,OAAQnL,EAAK/G,IAMd,OAJA7C,KAAK2sC,SAAStoC,KAAKlJ,GACf6E,KAAK2sC,SAAS5qC,OAAS/B,KAAK4sC,WAAWC,aAC1C7sC,KAAK2sC,SAAS/sB,QAERzkB,oXCvCTP,EAAAm3B,aAAA,MAGChyB,YAAoBud,GAAAtd,KAAAsd,aAFZtd,KAAAgc,OAA2B,GAK7Bjc,kDAEL,MAAMotC,EAUF,SAEEntC,KAAKsd,WAAW9Z,QAAewR,GAAUo4B,EAAAptC,UAAA,qBAC9C,IAAK,MAAMoS,KAAS4C,EAAQ,CAC3B,MAAM/D,EAAQmB,EAAM5B,IAAIS,OAAS,aAC3BoN,EAAO8uB,EAAUl8B,IAAU,CAACgjB,MAAO,IACnCoZ,EAAUhvB,EAAK4V,MAAM7hB,EAAMmL,SAAW,CAACja,MAAO,EAAGuY,QAAS,GAAIE,OAAQ,IAC5EsxB,EAAQ/pC,QACJ8O,EAAMzB,WACT08B,EAAQxxB,QAAQzJ,EAAMzB,WAAa08B,EAAQxxB,QAAQzJ,EAAMzB,WAAa,GAAK,GAExEyB,EAAMa,UACTo6B,EAAQtxB,OAAO3J,EAAMa,UAAYo6B,EAAQtxB,OAAO3J,EAAMa,UAAY,GAAK,GAExEoL,EAAK4V,MAAM7hB,EAAMmL,QAAU8vB,EAC3BF,EAAUl8B,GAASoN,MAIrBre,KAAKgc,OAASxgB,OAAOmJ,KAAKwoC,GAAW7gC,IAAIjQ,IACxC,MAAMgiB,EAAO8uB,EAAU9wC,GACvB,MAAO,CACNhB,KAAMgB,EACNixC,SAAU9xC,OAAOmJ,KAAK0Z,EAAK4V,OAAO3nB,IAAIihC,IACrC,MAAMF,EAAUhvB,EAAK4V,MAAMsZ,GAC3B,MAAO,CACNhwB,OAAQgwB,EACRv3B,YAAaxa,OAAOmJ,KAAK0oC,EAAQxxB,SAAS9Z,OAC1CoP,WAAY3V,OAAOmJ,KAAK0oC,EAAQtxB,QAAQha,OACxCgU,WAAYs3B,EAAQ/pC,cAOnBvD,UAAUwd,2CAIf,OAH2B,IAAvBvd,KAAKgc,OAAOja,eACT/B,KAAKsuB,WAELtuB,KAAKgc,OAAO1P,IAAIoQ,IACtB,MAAMzL,EAAQ,CACb5V,KAAMqhB,EAAErhB,KACR8V,WAAY,EACZ6E,YAAa,EACbD,WAAY,GASb,OAPA2G,EAAE4wB,SAASzoC,QAAQwoC,IACb9vB,GAAU8vB,EAAQ9vB,SAAWA,IACjCtM,EAAME,YAAck8B,EAAQl8B,WAC5BF,EAAM+E,aAAeq3B,EAAQr3B,YAC7B/E,EAAM8E,YAAcs3B,EAAQt3B,cAGvB9E,IACLmG,OAAOnG,GAASA,EAAM8E,WAAa,qcCtFxC,MAAAy3B,EAAA9yC,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IACAwH,EAAAxH,EAAA,GAKA+rC,EAAA/rC,EAAA,IACA+yC,EAAA/yC,EAAA,IAEAqS,EAAArS,EAAA,GAEM6F,EAAMkW,EAAArX,QAAO,kBAEnBxE,EAAAq4B,eAAA,cAAoCwa,EAAArkC,gBAGnCrJ,YAAmBmzB,EAAoCL,EAAgCxpB,GACtF9D,MAAM2tB,EAAc7pB,GADFrJ,KAAAkzB,eAAoClzB,KAAA6yB,iBAF/C7yB,KAAA0tC,uBAAyB,IAAIjH,EAAAp7B,iBAMrCtL,cAAc4tC,GACb,OAAO3tC,KAAK0tC,uBAAuB9F,UAAU+F,GAGxC5tC,OAAOmH,2CACZ,MAAMoI,EAAmB,CACxBzM,GAAI,GACJT,KAAM2K,EAAAjQ,aAAawS,QACnB4B,QAAS/Q,KAAKygB,MACdgtB,UAAW,EACX1mC,IAAKA,EACLkG,OAAQlL,EAAA/D,cAAc0vC,KAGvB,OADAv+B,EAAQzM,SAAW7C,KAAKkzB,aAAaxwB,IAAI4M,GAClCA,IAGFvP,OAAOuP,iDACNtP,KAAKkzB,aAAa/xB,OAAOmO,EAAQzM,UACjC7C,KAAK6yB,eAAeib,eAAex+B,EAAQzM,MAG5C9C,QAAQuP,2CACb,GAAItP,KAAK0tC,uBAAuB9F,UAAUt4B,EAAQzM,IACjD,OAAO7C,KAAK0tC,uBAAuB7F,OAAOv4B,EAAQzM,IAEnD7C,KAAK0tC,uBAAuB5F,WAAWx4B,EAAQzM,IAC/C,IACCtC,EAAIid,MAAM,qBAAsBlO,EAAQpI,KACxC,MAAM6mC,EAAO,IAAIP,EAAAQ,KACjB,IAAIC,EAA2B,GAC/B,IACC,MAAMxnC,QAAesnC,EAAKpyC,IAAI2T,GAC1B7I,IACH6I,EAAQkB,IAAM/J,EAAO+J,IACrBy9B,EAAWxnC,EAAOwnC,UAEnB3+B,EAAQlC,OAASlL,EAAA/D,cAAc+vC,UAC/B5+B,EAAQyE,kBAAevP,EACtB,MAAOyL,GACR1P,EAAI8Q,KAAK,4BAA6BpB,GACtCX,EAAQlC,OAASlL,EAAA/D,cAAcqN,MAC/B8D,EAAQyE,cAAgB9D,GAAK,IAAIxP,WAElC6O,EAAQs+B,UAAYztC,KAAKygB,YACnB5gB,KAAKkzB,aAAaxxB,QAAQ4N,GAChC,MAAM6+B,QAAoBnuC,KAAK6yB,eAAeub,cAAc9+B,EAAQzM,GAAIorC,GACxE1tC,EAAI8Q,KAAK/B,EAAQpI,IAAM,mBAAqBinC,EAAYpsC,cAClD/B,KAAK0tC,uBAAuBhmC,QAAQ4H,EAAQzM,QAAI2B,GACrD,MAAOyL,GAER,aADMjQ,KAAK0tC,uBAAuBhmC,QAAQ4H,EAAQzM,QAAI2B,GAC/CiD,QAAQE,OAAOsI,MAIlBlQ,0DACLQ,EAAI8Q,KAAK,cACT,MAAMg9B,QAAiBruC,KAAKkzB,aAAa/vB,MACzC,IAAK,MAAMmM,KAAW++B,QACfruC,KAAKsuB,QAAQhf,GAEpB/O,EAAI8Q,KAAK,+cCjFX,MAAAi9B,EAAAnvC,EAAAzE,EAAA,KAEAiM,EAAAxH,EAAAzE,EAAA,KACA6zC,EAAApvC,EAAAzE,EAAA,KACA8zC,EAAArvC,EAAAzE,EAAA,KACAwH,EAAAxH,EAAA,GAIAqS,EAAArS,EAAA,GAEAE,EAAAozC,KAAA,MAECjuC,eAIQA,UAAUgsB,GACjB,OAAOA,EAAI5Q,MAAM,KAAKszB,OACrB,CAACC,EAAiCjlB,KACjC,MAAM/J,EAAQ+J,EAAMtO,MAAM,KAAK7O,IAAI,SAASo5B,GAC3C,OAAOA,EAAK7sB,SAKb,OAHqB,IAAjB6G,EAAM3d,SACT2sC,EAAKhvB,EAAM,IAAMA,EAAM,IAEjBgvB,GACL,IAGG3uC,gBAAgBykB,EAAsBmqB,EAAkB7lC,GAC/D,IAAI8lC,EAQJ,OAPID,EAAS3qC,MAAM,gBAClB4qC,EAAaN,EAAAlvC,QAAKyvC,iBACP3mB,GAAG,QAASpf,GACb6lC,EAAS3qC,MAAM,cACzB4qC,EAAaN,EAAAlvC,QAAK0vC,gBACP5mB,GAAG,QAASpf,GAEjB8lC,EAAapqB,EAAIa,KAAKupB,GAAcpqB,EAGpCzkB,eAAeykB,EAAsBuqB,EAAiBjmC,GAE7D,GAAIimC,IAAY,UAAUntC,KAAKmtC,GAC9B,IACC,MAAMC,EAAKR,EAAApvC,QAAM6vC,aAAaF,GAE9BC,EAAG9mB,GAAG,QAASpf,GAGf0b,EAAWA,EAAIa,KAAK2pB,GACnB,MAAOnnC,GACR2c,EAAI0qB,KAAK,QAASrnC,GAGpB,OAAO2c,EAGMzkB,MAAMmH,2CACnB,MAAMioC,EAAgC,GACtC,IAAIpB,EACAqB,GAAe,EACnB,MAAMnjC,EAAMtF,EAAAvH,QAAQ8H,EAAK,CAACM,QAAS,IAAO6nC,MAAM,IAChDpjC,EAAIqjC,gBAAgB,IAEpBrjC,EAAI0Y,UAAU,aAAc,2HAC5B1Y,EAAI0Y,UAAU,SAAU,mCAExB,MAAM4qB,EAAa,IAAIhB,EAAAnvC,QAAW,IAYlC,OAVAmwC,EAAWrnB,GAAG,WAAY,WACzB,MAAMpgB,EAAWynC,EACjBxB,EAAOjmC,EAASw3B,KAChB,IAAI78B,EAAOqF,EAASwW,OACpB,KAAO7b,GACN0sC,EAAM9qC,KAAK5B,GACXA,EAAOqF,EAASwW,SAIX,IAAI7W,QAAkE,CAACC,EAASC,KACtF,MAAMmB,EAAQjB,IACTunC,IAGJA,GAAe,EACXvnC,EACHF,EAAOE,GAEPH,EAAQ,CAACqmC,OAAMoB,YAIjBljC,EAAIic,GAAG,QAASpf,GAChBmD,EAAIic,GAAG,WAAa1D,IACnB,GAAuB,MAAnBA,EAAImE,WAEP,OADA1c,EAAIujC,QACG1mC,EAAK,IAAI1D,MAAM,mBAAqBof,EAAImE,YAAcnE,EAAIirB,cAAgB,IAAMjrB,EAAIirB,cAAgB,MAE5G,MAAMd,EAAWnqB,EAAInd,QAAQ,qBAAuB,WAC9C0nC,EAAU/uC,KAAK0vC,UAAUlrB,EAAInd,QAAQ,iBAAmB,IAAI0nC,QAClE,IAAIY,EAAa3vC,KAAK4vC,gBAAgBprB,EAAKmqB,EAAU7lC,IACrD6mC,EAAa3vC,KAAK6vC,eAAeF,EAAYZ,EAASjmC,IAC3Cuc,KAAKkqB,KAGjBA,EAAWrnB,GAAG,QAASpf,GACvBymC,EAAWrnB,GAAG,MAAOpf,OAKV/I,IAAIuP,2CAChB,MAAM+O,QAAare,KAAK8vC,MAAMxgC,EAAQpI,KAChCsJ,EAAkB,CACvBC,MAAO4N,EAAK0vB,KAAKt9B,MACjBuD,YAAaqK,EAAK0vB,KAAK/5B,YACvBmV,KAAM9K,EAAK0vB,KAAK5kB,KAChB5U,OAAQ8J,EAAK0vB,KAAKx5B,OAClBw7B,UAAW1xB,EAAK0vB,KAAKgC,UACrBn+B,MAAOyM,EAAK0vB,KAAKn8B,OAASyM,EAAK0vB,KAAKn8B,MAAM1K,IAAMmX,EAAK0vB,KAAKn8B,MAAM1K,SAAM1C,EACtEwrC,WAAY3xB,EAAK0vB,KAAKiC,YA8BvB,OA5BI3xB,EAAK0vB,KAAK,mBAAqB1vB,EAAK0vB,KAAK,kBAAkB,OAC9Dv9B,EAAIwD,YAAcqK,EAAK0vB,KAAK,kBAAkB,MA2BxC,CAACv9B,MAAKy9B,SAzBoB5vB,EAAK8wB,MAAM7iC,IAAI2jC,IAC/C,IAAIC,EAAyC,GAE7C,MAAMC,EAAsBF,EAAM,gBAClC,GAAIE,EAAU,CACb,MAAMC,EAAsBD,EAAS,eACjCC,IACHF,EAAWE,EAAQ9jC,IAAI7J,GAAQA,EAAK,OAGtC,MAAO,CACNI,GAAI,GACJuR,UAAW9E,EAAQzM,GACnBuK,OAAQlL,EAAA/D,cAAc0vC,IACtBzrC,KAAM2K,EAAAjQ,aAAayW,QACnBgB,OAAQ07B,EAAK17B,OACb4U,KAAM8mB,EAAK9mB,KACXD,KAAM+mB,EAAK/mB,KACX7U,QAAS47B,EAAK57B,QACdg8B,WAAiBJ,EAAKI,WACtBviC,KAAMmiC,EAAKniC,KAAOmiC,EAAKniC,KAAK+P,UAAY,EACxCxiB,KAAM40C,EAAKx/B,MACXy/B,SAAUA,yBCtJdr1C,EAAAD,QAAAmC,QAAA,uBCAAlC,EAAAD,QAAAmC,QAAA,6BCAAlC,EAAAD,QAAAmC,QAAA,4XCAA,MAAAgQ,EAAArS,EAAA,GAOAE,EAAAy3B,kBAAA,MAGCtyB,YAAoBsJ,GAAArJ,KAAAqJ,eAFpBrJ,KAAAswC,QAA6B,GAKvBvwC,wDACL,OAAOC,KAAKswC,UAGbvwC,QACCC,KAAKswC,QAAU,GAGVvwC,cAAcwT,EAAkB3J,2CACrC5J,KAAKswC,QAAUtwC,KAAKswC,QAAQl5B,OAAOm5B,GAAOA,EAAG3mC,KAAK/G,KAAO+G,EAAK/G,IAC9D7C,KAAKswC,QAAQjsC,KAAK,CACjBuP,KAAMzT,KAAKygB,MACXjV,IAAK4H,EACL3J,KAAMA,UAED5J,KAAKqJ,aAAamnC,cAAcj9B,EAAQ1Q,GAAIkK,EAAAjQ,aAAayW,QAAS3J,EAAK/G,UACvE7C,KAAKqJ,aAAamnC,cAAcj9B,EAAQa,UAAWrH,EAAAjQ,aAAawS,QAAS1F,EAAK/G,MAG/E9C,YAAYqS,EAAcxI,2CAC/B5J,KAAKswC,QAAUtwC,KAAKswC,QAAQl5B,OAAOm5B,GAAOA,EAAG3mC,KAAK/G,KAAO+G,EAAK/G,IAC9D7C,KAAKswC,QAAQjsC,KAAK,CACjBuP,KAAMzT,KAAKygB,MACXjV,IAAKyG,EACLxI,KAAMA,UAED5J,KAAKqJ,aAAamnC,cAAcp+B,EAAMvP,GAAIkK,EAAAjQ,aAAasV,MAAOxI,EAAK/G,UACnE7C,KAAKqJ,aAAamnC,cAAcp+B,EAAMa,QAASlG,EAAAjQ,aAAa0B,MAAOoL,EAAK/G,UACxE7C,KAAKqJ,aAAamnC,cAAcp+B,EAAMzB,SAAU5D,EAAAjQ,aAAawB,OAAQsL,EAAK/G,UAC1E7C,KAAKqJ,aAAamnC,cAAcp+B,EAAM/B,SAAUtD,EAAAjQ,aAAayR,OAAQ3E,EAAK/G,sXCxClF,MAAAsG,EAAAzO,EAAA,GAEAE,EAAA24B,YAAA,cAAiCpqB,EAAApD,iBAEhChG,YAAmBujB,GAClB/d,MAAM+d,GADYtjB,KAAAsjB,YAILvjB,cAAc6X,EAAaqc,2CACxC,IAAK,MAAMr4B,KAAKq4B,EACf,GAA4B,IAAxBrc,EAAI7O,QAAQnN,EAAE2U,OAAuC,IAAxB3U,EAAE2U,KAAKxH,QAAQ6O,GAC/C,OAAOnQ,QAAQE,OAAOvC,MAAM,6BAKzBrF,OAAOiO,2CACZ,MAAMimB,QAAcj0B,KAAKsjB,UAAUngB,MAEnC,aADMnD,KAAKywC,cAAcziC,EAAKuC,KAAM0jB,GAC7Bj0B,KAAKsjB,UAAU5gB,IAAIsL,KAGrBjO,OAAOiO,2CACZ,MAAMimB,QAAcj0B,KAAKsjB,UAAUngB,YAC7BnD,KAAKywC,cAAcziC,EAAKuC,KAAM0jB,EAAM7c,OAAOxb,GAAKA,EAAEiH,KAAOmL,EAAKnL,WAC9D7C,KAAKsjB,UAAU5hB,QAAQsM,KAGxBjO,OAAOiO,iDACNhO,KAAKsjB,UAAUniB,OAAO6M,EAAKnL,sXC/BnC,MAAAkK,EAAArS,EAAA,GAGAyO,EAAAzO,EAAA,GAEAE,EAAA83B,iBAAA,cAAsCvpB,EAAApD,iBAErChG,YAAoB6xB,GACnBrsB,MAAMqsB,GADa5xB,KAAA4xB,iBAId7xB,iBAAiBgV,EAAgBwqB,2CACtC,IAAImR,QAAkB1wC,KAAKrE,IAAIoZ,GAK/B,OAJK27B,KACJA,EAAY1wC,KAAK2wC,cAAc57B,EAAQwqB,IAC7B18B,SAAW7C,KAAK4xB,eAAelvB,IAAIguC,IAEvCA,IAGR3wC,cAAcgV,EAAgBwqB,GAC7B,MAAO,CACN18B,GAAI,GACJT,KAAM2K,EAAAjQ,aAAayY,UACnBR,SACAjE,SAAU,GACV8D,QAASzU,KAAKygB,MACdlL,UAAW6pB,GAAU,kBAIjBx/B,IAAIgV,2CACT,OAAO/U,KAAK4xB,eAAe5U,UAAU,CAACjI,aAGjChV,KAAKgV,EAAgBjE,EAAyB2E,EAA+BL,EAA8BmqB,2CAChH,IAAImR,QAAkB1wC,KAAK4xB,eAAe5U,UAAU,CAACjI,WAqBrD,OApBK27B,GAaJA,EAAU5/B,SAAWA,EACrB4/B,EAAUj7B,UAAYA,EACtBi7B,EAAUt7B,SAAWA,EACrBs7B,EAAU97B,QAAUzU,KAAKygB,MACzB8vB,EAAUh7B,UAAY6pB,GAAU,uBAC1Bv/B,KAAK4xB,eAAelwB,QAAQgvC,KAjBlCA,EAAY,CACX7tC,GAAI,GACJT,KAAM2K,EAAAjQ,aAAayY,UACnBR,SACAjE,WACA2E,YACAL,WACAR,QAASzU,KAAKygB,MACdlL,UAAW6pB,GAAU,mBAEZ18B,SAAW7C,KAAK4xB,eAAelvB,IAAIguC,GASvCA,IAGF3wC,OAAOgV,2CACZ,MAAM27B,QAAkB1wC,KAAKrE,IAAIoZ,GAC7B27B,UACG1wC,KAAK4xB,eAAezwB,OAAOuvC,EAAU7tC,ucC/D9C,MAAAjC,EAAAzB,EAAAzE,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IAEA+rC,EAAA/rC,EAAA,IACAk2C,EAAAl2C,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IAMM6F,EAAMkW,EAAArX,QAAO,mBAEnBxE,EAAA61B,gBAAA,MAGC1wB,YAAoB8wC,GAAA7wC,KAAA6wC,oBAFZ7wC,KAAA8wC,sBAAwB,IAAIrK,EAAAp7B,iBAK5BtL,WAAW8C,EAAYnD,GAC9B,MAAO,YAAcmD,EAAK,IAAMnD,EAGnBK,iBAAiBsB,EAAkB3B,2CAChD,MAAMqxC,EAAK,IAAIH,EAAAI,kBACf,OAAQtxC,GACP,IAAK,MACJ,MAAO,CAAC4lB,OAAQ,CAACA,OAAQ8W,OAAOC,WAAW0U,EAAGE,IAAI5vC,IAAYuR,YAAa,kBAC5E,IAAK,OACJ,MAAO,CAACkS,WAAYisB,EAAGjsB,KAAKzjB,IAC7B,IAAK,MACJ,MAAO,CAACikB,OAAQ,CAACA,aAAcyrB,EAAGG,OAAO7vC,GAAWuR,YAAa,uBAEnE,OAAOnL,QAAQE,OAAOvC,MAAM,6CAGvBrF,wBAAwBiD,2CAC7B,MAAMmuC,EAAWnuC,EAAIoU,OAAOvU,GAAMA,EAAGd,OAAS,GAAGuK,IAAIzJ,GAAM7C,KAAKoxC,WAAWvuC,EAAI,KAC/E,GAAIsuC,EAASpvC,OAAS,EAAG,CACxB,IAAIqG,QAAavH,EAAAzB,QAAI0e,QAAQ9d,KAAK6wC,mBAClCzoC,EAAOA,EAAKgP,OAAO/b,GACX81C,EAASE,UAAUx0C,GAAyB,IAApBxB,EAAK0N,QAAQlM,KAAa,GAE1D,IAAK,MAAMwE,KAAY+G,QAChBvH,EAAAzB,QAAI6B,OAAOL,EAAAxB,QAAKsI,QAAQ1H,KAAK6wC,kBAAmBxvC,OAK3CtB,IAAI8C,EAAYxB,EAAkB3B,2CAC/C,IAAK2B,WAAoBR,EAAAzB,QAAI4B,WAAWK,IACvC,OAAOoG,QAAQE,OAAOvC,MAAM,6CAE7B,MAAMksC,EAAUtxC,KAAKoxC,WAAWvuC,EAAInD,GACpC,GAAIM,KAAK8wC,sBAAsBlJ,UAAU0J,GACxC,OAAOtxC,KAAK8wC,sBAAsBjJ,OAAOyJ,GAE1CtxC,KAAK8wC,sBAAsBhJ,WAAWwJ,GACtC,IACC,IAAI7qC,EACJ,MAAM8qC,EAAY3wC,EAAAxB,QAAKkB,KAAKN,KAAK6wC,kBAAmBS,GAepD,aAdqBzwC,EAAAzB,QAAI4B,WAAWuwC,IAEnC9qC,EAAS,CAAC6Q,KAAM,CAACjW,SAAUkwC,EAAWl2C,KAAMi2C,KAE5C7qC,QAAezG,KAAKwxC,iBAAiBnwC,EAAU3B,IACpC4lB,QACV/kB,EAAIid,MAAM,8BAA+B+zB,SACnC1wC,EAAAzB,QAAIqyC,UAAUF,EAAW9qC,EAAO6e,OAAOA,SACnC7e,EAAOqe,OACjBvkB,EAAIid,MAAM,8BAA+B+zB,SACnC1wC,EAAAzB,QAAIqyC,UAAUF,EAAWvpC,KAAK6c,UAAUpe,EAAOqe,cAGjD9kB,KAAK8wC,sBAAsBppC,QAAQ4pC,EAAS7qC,GAC3CA,EACN,MAAOwJ,GAER,aADMjQ,KAAK8wC,sBAAsBnpC,OAAO2pC,EAASrhC,GAC1CxI,QAAQE,OAAOsI,MAIlBlQ,iBAAiBqS,EAAc1S,2CACpC,aAAaM,KAAKrE,IAAIyW,EAAMvP,GAAIjC,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,MAAOqE,KAG9DK,mBAAmBwT,EAAkB7T,2CAC1C,OAAI6T,EAAQhD,MAAQgD,EAAQf,YACdxS,KAAKrE,IAAI4X,EAAQ1Q,GAAI0Q,EAAQhD,KAAM7Q,GAEzC+H,QAAQE,OAAOvC,MAAM,geC1F/B,MAAAssC,EAAAvyC,EAAAzE,EAAA,KACA6tB,EAAAppB,EAAAzE,EAAA,KACAi3C,EAAAj3C,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IACAk3C,EAAAzyC,EAAAzE,EAAA,KAGMm3C,EAAen3C,EAAQ,IAEvB6F,EAAMkW,EAAArX,QAAO,YAmBnB,MAAM0yC,UAAuBH,EAAAI,UAY5BhyC,YAAYiyC,EAA+BC,GAC1C1sC,MAAM,CAAC2sC,oBAAoB,EAAOC,oBAAoB,EAAMC,cAAe,OAZ5EpyC,KAAAqyC,KAAO,IAAIV,EAAAW,YACXtyC,KAAAuyC,KAAO,IAAIZ,EAAAW,YAIXtyC,KAAAwyC,UAAW,EACXxyC,KAAAyyC,KAAsB,KACtBzyC,KAAA0yC,KAAsB,KACtB1yC,KAAA2yC,SAAW,EACX3yC,KAAA4yC,OAAS,EAIR5yC,KAAK6yC,iBAA2C,MAAxBb,EAA+BA,EAAuB,IAC9EhyC,KAAK8yC,YAAiC,MAAnBb,EAA0BA,EAAkB,MAC/D,MAAM7qC,EAAuC,CAC5CqhC,OAAkBzoC,KAAKqyC,MAExBryC,KAAK+yC,QAAUnB,EAAAxyC,QAAOgI,GAAS4rC,WAAW,CAAC,WAAY,QAAS,oBAAqB,OAAShzC,KAAK8yC,cACnG9yC,KAAK+yC,QAAQ7qB,GAAG,QAAUkC,IACzB7pB,EAAIid,MAAM,uBAAyB4M,GACnCpqB,KAAKwyC,UAAW,EACTxyC,KAAKkvC,KAAK,cAElB,IAAI+D,GAAU,EACdjzC,KAAK+yC,QAAQ7qB,GAAG,QAAUrgB,GACR,WAAbA,EAAIoF,MACPgmC,GAAU,EACV1yC,EAAIid,MAAM,2BACHxd,KAAKkvC,KAAK,OAAQ,4BAEzB+D,GAAU,EACV1yC,EAAIid,MAAM,0BAA4B3V,GAC/B7H,KAAKkvC,KAAK,OAAQ,0BAA4BrnC,KAGvD7H,KAAK+yC,QAAQ7qB,GAAG,MAAO,KACtB,IAAK+qB,EACJ,OAAOjzC,KAAKkvC,KAAK,UAGnBlvC,KAAK+yC,QAAQG,cAAclzC,KAAKuyC,MAChCvyC,KAAKuyC,KAAKrqB,GAAG,WAAY,IAAMloB,KAAKqZ,SAGrCtZ,QACC,IACIjF,EACAiB,EAFAo3C,EAAyB,KAGzB90B,EAA2Bre,KAAKuyC,KAAKj0B,OACzC,KAAOD,GAAQA,EAAKtc,OAAS,GAC5BjH,EAAI,EACW,MAAXq4C,GACHp3C,EAAUsiB,EAAK+0B,SAAS,GAAG,IAAS,EAAKD,EACzCA,EAAU,KACVr4C,EAAI,IAEJiB,EAAQsiB,EAAKg1B,YAAY,GAAG,GAC5Bv4C,EAAI,GAELkF,KAAKszC,YAAYv3C,EAAOjB,EAAGujB,GAC3BA,EAAOre,KAAKuyC,KAAKj0B,OAInBve,YAAYhE,EAAew3C,EAAal1B,GACvC,MAAMm1B,EAAUn1B,EAAKtc,OACrB,KACC/B,KAAKyyC,KAAqB,OAAdzyC,KAAKyyC,KAAgB12C,EAAQuM,KAAKI,IAAI1I,KAAKyyC,KAAM12C,GAC7DiE,KAAK0yC,KAAqB,OAAd1yC,KAAK0yC,KAAgB32C,EAAQuM,KAAKK,IAAI3I,KAAK0yC,KAAM32C,GAC7DiE,KAAK2yC,UAAY,EACb3yC,KAAK2yC,WAAa3yC,KAAK6yC,mBAC1B7yC,KAAKqE,KAAK,CAACiE,KAAKoK,MAAM1S,KAAKyyC,MAAOnqC,KAAKoK,MAAM1S,KAAK0yC,QAClD1yC,KAAKyyC,KAAO,KACZzyC,KAAK0yC,KAAO,KACZ1yC,KAAK2yC,SAAW,KAEbY,GAAOC,IAGXz3C,EAAQsiB,EAAKg1B,YAAYE,GAAK,GAC9BA,GAAO,EAITxzC,WAAW0zC,EAAe9E,EAAkBpjC,GAG3C,OAFAvL,KAAK4yC,QAAUa,EAAM1xC,OAEjB/B,KAAKwyC,SACDxyC,KAAKqyC,KAAK1V,MAAM8W,EAAO9E,EAAepjC,GAEtCvL,KAAK0zC,KAAK,WAAY,IACrB1zC,KAAKqyC,KAAK1V,MAAM8W,EAAO9E,EAAepjC,IAKhDxL,OAAOwL,GAEN,OADAvL,KAAKqyC,KAAKj5B,MACHpZ,KAAKuyC,KAAKmB,KAAK,MAAO,KACxB1zC,KAAK2yC,SAAW,GACnB3yC,KAAKqE,KAAK,CAACrE,KAAKyyC,KAAMzyC,KAAK0yC,OAErBnnC,OAWV,MAAMooC,EAIL5zC,YAAoBgP,EAAwB6uB,GAAxB59B,KAAA+O,SAAwB/O,KAAA49B,OAF5C59B,KAAA2yC,SAA0B,GAGzB3yC,KAAK49B,KAAOpiC,OAAO+N,OAAO,CACzBqqC,gBAAiB,IACjB3sB,WAAY,OACV2W,GAAQ,IAGZ79B,IAAIwL,GACH,MAAMsoC,EAAK,IAAI/B,EAAe9xC,KAAK49B,KAAKgW,gBAAiB5zC,KAAK49B,KAAK3W,YACnE4sB,EAAG3rB,GAAG,WAAY,KACjB,IAAI4rB,EAAKD,EAAGv1B,OACZ,KAAOw1B,GAAMA,EAAG/xC,OAAS,GACxB/B,KAAK2yC,SAAStuC,KAAKyvC,EAAG,IACtB9zC,KAAK2yC,SAAStuC,KAAKyvC,EAAG,IACtBA,EAAKD,EAAGv1B,SAGVu1B,EAAG3rB,GAAG,OAASrgB,IACd0D,EAAG1D,KAEJ7H,KAAK+O,OAAOsW,KAAKwuB,GAGlB9zC,WAEC,MAAM0G,EAAS21B,OAAO2X,MAAM,GAA6B,EAAvB/zC,KAAK2yC,SAAS5wC,QAChD0E,EAAOutC,aAAa,EAAG,GACvBvtC,EAAOwtC,cAAc,EAAG,GACxBxtC,EAAOutC,aAAah0C,KAAK49B,KAAK3W,WAAY,GAC1CxgB,EAAOutC,aAAah0C,KAAK49B,KAAKgW,gBAAiB,IAC/CntC,EAAOutC,aAAah0C,KAAK2yC,SAAS5wC,OAAS,EAAG,IAC9C,IAAIwxC,EAAM,GAKV,OAJAvzC,KAAK2yC,SAAS9tC,QAAQ+kB,IACrBnjB,EAAOytC,aAAatqB,EAAK2pB,GACzBA,GAAO,IAED9sC,EAGR1G,SAEC,MAAO,CACN8N,QAAS,EACTypB,YAAat3B,KAAK49B,KAAK3W,WACvBktB,kBAAmBn0C,KAAK49B,KAAKgW,gBAC7BQ,KAAM,GACNryC,OAAQ/B,KAAK2yC,SAAS5wC,OAAS,EAC/Bsc,KAAMre,KAAK2yC,WAMd/3C,EAAAo2C,kBAAA,MAEOjxC,OAAOsB,2CAEZ,aAD2BrB,KAAKwxC,iBAAiBnwC,IACvCgzC,aAGLt0C,KAAKsB,2CAEV,aAD2BrB,KAAKwxC,iBAAiBnwC,IACvCizC,WAGLv0C,IAAIsB,2CACT,MAAMgd,QAAare,KAAK8kB,KAAKzjB,GACvB4vC,EAAMjxC,KAAKu0C,SAASl2B,GACpBm2B,EAAO,IAAI9C,EAAAtyC,QAEjB,aADwBo1C,EAAKC,SAASxD,IACrB5yB,OAGJte,iBAAiBsB,2CAC9B,MAAM0N,EAASwZ,EAAAnpB,QAAGs1C,iBAAiBrzC,GACnC,OAAO,IAAIoG,QAAkB,CAACC,EAASC,KACtC,MAAMopC,EAAe,IAAI4C,EAAS5kC,EAAQ,CACzC6kC,gBAAiB,IACjB3sB,WAAY,QAEb8pB,EAAGxiB,IAAK1mB,IACHA,EACHF,EAAOE,GAEPH,EAAQqpC,SAMJhxC,SAASse,GAGhB,GAAIA,EAAKA,KAAKtc,OAAS,EAAG,CACzB,IAAI4yC,EAAM9C,EAAaz1C,OAAOiiB,IAG7Bs2B,EAFuBrsC,KAAKC,MAAMosC,EAAI5jC,SAAW4jC,EAAIC,QAAQtd,YAAc,KACtD,IACfqd,EAAIE,SAAS,CAACC,MAAOA,IAAWC,MAAO,MAEvCJ,EAAIE,SAAS,CAACC,MAAOA,OAExBF,QAAQv2B,KAAKA,KAAOs2B,EAAIC,QAAQv2B,KAAKA,KAAK9c,MAAM,EAAGuzC,KACvDz2B,EAAOs2B,EAAIC,QAAQv2B,KAEpB,MAAM22B,EAAa32B,EAAKA,KAAKtc,OACvB3G,EAAmB,GACzB,IAAK,IAAI65C,EAAa,EAAGA,EAAaD,EAAYC,IAAc,CAC/D,MAAMrrB,EAAOvL,EAAKA,KAAK42B,GAfT,IAeiC,IAC3CA,EAAa,GAAM,EACtB75C,EAAEiJ,YAAY4wC,EAAa,OAAOrrB,KAElCxuB,EAAEiJ,YAAY4wC,EAAa,OAAOrrB,KAQpC,+QAF0BxuB,EAAEkF,KAAK,oCCxQnCzF,EAAAD,QAAAmC,QAAA,uBCAAlC,EAAAD,QAAAmC,QAAA,yBCAAlC,EAAAD,QAAAmC,QAAA,+cCCA,MAAAm4C,EAAAx6C,EAAA,IACAoS,EAAApS,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IACAuP,EAAAvP,EAAA,GAIAwH,EAAAxH,EAAA,GAEAE,EAAA23B,cAAA,MAECxyB,eAIMA,WAAWsB,EAAkBwB,EAAYsyC,EAAuBC,EAAqBhnC,2CAE1F,WADqBvN,EAAAzB,QAAI4B,WAAWK,IAEnC,OAAOoG,QAAQE,OAAOvC,MAAM,mBAGP,OADtBgwC,EAAaA,GAAclzC,EAAArE,gBAAgBT,KAC5B,KACdg4C,EAAaA,EAAW7zC,MAAM,IAE/B,MAAMoR,EAAUvE,GAAc,EAC9B,MAAmB,QAAfgnC,GAAwBF,EAAAG,WAAWC,iBAAiBH,GAAgBroC,EAAA1L,WAAWC,GAAW+zC,EAAYziC,GACpGuiC,EAAAG,WAAWE,iBAAkCH,GAG3C,CAAC/vB,KAAM,IAAI6vB,EAAAM,cAAcn0C,EAAU+zC,EAAYziC,IAF9ClL,QAAQE,OAAOvC,MAAM,mCAKtB,CAACkS,KAAM,CAACjW,WAAUhG,KAAMwH,EAAK,IAAMuyC,MAItCr1C,YAAYqS,EAAc1S,EAA4B0O,EAAgCxE,2CAC3F,OAAO5J,KAAKy1C,WAAW70C,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,MAAO+W,EAAMvP,GAAIuP,EAAMI,MAAM9S,OAAQA,EAAQ0O,KAG3FrO,cAAcwT,EAAkB7T,EAA4B0O,EAAgCxE,2CACjG,OAAI2J,EAAQhD,MAAQgD,EAAQf,MACpBxS,KAAKy1C,WAAWliC,EAAQhD,KAAMgD,EAAQ1Q,GAAI0Q,EAAQf,MAAM9S,OAAQA,EAAQ0O,GAExE3G,QAAQE,OAAOsC,EAAAnE,aAAa,yoBC9CtC,MAAA8rC,EAAAzyC,EAAAzE,EAAA,KAEAg7C,EAAAv2C,EAAAzE,EAAA,KAEA+b,EAAAtX,EAAAzE,EAAA,IACAi7C,EAAAltB,EAAA/tB,EAAA,KACAic,EAAAjc,EAAA,IACAwH,EAAAxH,EAAA,GAEM6F,EAAMkW,EAAArX,QAAO,oBAEnBxE,EAAAy6C,WAAA,MAMCt1C,YAAYsB,EAAkB3B,EAAgB0O,EAAoB2C,GACjE/Q,KAAKqB,SAAWA,EAChBrB,KAAKN,OAASA,EACdM,KAAKoO,WAAaA,EAClBpO,KAAK+Q,SAAWA,EACZ3C,GAAc,IACjBpO,KAAKoO,WAAa,KAIpBrO,wBAAwB61C,EAAqBl2C,EAAgB0O,GAC5D,OAAQ1O,IAAWk2C,GAAiBxnC,EAAa,EAGlDrO,wBAAwBL,GACvB,OAAOiX,EAAAsN,8BAA8Blb,QAAQrJ,IAAW,EAGzDK,qEACC,OAAO,IAAI0H,QAAiD,CAACC,EAASC,KACrEiqC,EAAAxyC,UAASy2C,oBAAoB,CAAChuC,EAAKiuC,KAClC,GAAIjuC,IAAQiuC,EACX,OAAOnuC,EAAOE,GAEfH,EAAQlM,OAAOmJ,KAAKmxC,GAAS1+B,OAAO/a,GAAOy5C,EAAQz5C,GAAK05C,UAAUzpC,IAAIjQ,IAC9D,CAACqD,OAAQrD,EAAKhB,KAAMy6C,EAAQz5C,GAAK2X,sBAsB5CjU,KAAKgP,GACJxO,EAAI8Q,KAAK,4BAA6BrR,KAAKN,OAAQM,KAAKoO,YACxD,MAAM4nC,EAAOpE,EAAAxyC,QAAoC,CAACqpC,OAAQzoC,KAAKqB,SAAU40C,OAAO,IAC5Ej2C,KAAKN,SAAWwC,EAAArE,gBAAgBT,KACnC44C,EAAKE,eAAe,cAErBF,EAAKG,cACHC,SAASp2C,KAAKN,QACd22C,iBAAiBr2C,KAAKoO,WAAa,KACnC8Z,GAAG,MAAO,KACV3nB,EAAIid,MAAM,2CAEV0K,GAAG,QAAUrgB,IACbtH,EAAIiL,MAAM,wCAA0C3D,EAAIxC,WAE1D0J,EAAO6D,YAAY5S,KAAKN,QACxBs2C,EAAK9C,cAAcnkC,EAAQ,CAACqK,KAAK,MAKnCxe,EAAA46C,cAAA,MAKCz1C,YAAYsB,EAAkB3B,EAAgB0O,GAC7CpO,KAAKqB,SAAWA,EAChBrB,KAAKN,OAASA,EACdM,KAAKoO,WAAaA,EACdA,GAAc,IACjBpO,KAAKoO,WAAa,KAIpBrO,KAAKgP,GACJxO,EAAI8Q,KAAK,yCAA0CrR,KAAKN,OAAQM,KAAKoO,YACrEsnC,EAAAt2C,QAAIkY,KAAK,CAACzP,EAAKxG,EAAUi1C,EAAIC,KAC5B,GAAI1uC,EACH,MAAMA,EAEP,MAAMmuC,EAAOpE,EAAAxyC,QAAoC,CAACqpC,OAAQzoC,KAAKqB,SAAU40C,OAAO,IAC5Ej2C,KAAKN,SAAWwC,EAAArE,gBAAgBT,KACnC44C,EAAKE,eAAe,cAErBF,EAAKG,cACHC,SAASp2C,KAAKN,QACd22C,iBAAiBr2C,KAAKoO,WAAa,KACnC8Z,GAAG,MAAO,KACV3nB,EAAI8Q,KAAK,yDACTtC,EAAO6D,YAAY5S,KAAKN,QACxBqP,EAAO4V,UAAU,iBAAkBgxB,EAAGa,SAASn1C,GAAUsL,MACzD,MAAM8pC,EAAKd,EAAGjB,iBAAiBrzC,EAAU,CAACq1C,WAAW,IACrDD,EAAGvuB,GAAG,MAAO,KACZquB,MAEDE,EAAGvuB,GAAG,QAAS,KACdquB,MAEDE,EAAGpxB,KAAKtW,KAERmZ,GAAG,QAAU+W,IACbsX,IACA,MAAM5wC,EAAM,wCAA0Cs5B,EAAK55B,QAC3D0J,EAAO3B,OAAO,KAAKqX,KAAK9e,GACxBpF,EAAIiL,MAAM7F,KAEZqwC,EAAKW,KAAKt1C,sBCnIbxG,EAAAD,QAAAmC,QAAA,qXCAA,MAAAgQ,EAAArS,EAAA,GAGAyO,EAAAzO,EAAA,GAEAE,EAAAg4B,gBAAA,cAAqCzpB,EAAApD,iBAEpChG,YAAmB2iB,GAClBnd,MAAMmd,GADY1iB,KAAA0iB,gBAIb3iB,OAAOgV,2CACZ,aAAa/U,KAAK0iB,cAAc3W,OAAO,CAACgJ,aAGnChV,IAAIsjB,EAAiBtO,2CAC1B,aAAa/U,KAAK0iB,cAAc1F,UAAU,CAACjI,SAAQ6hC,OAAQvzB,MAGtDtjB,OAAO62C,EAAgB7hC,EAAgBK,EAAkBX,2CAC9D,IAAIS,QAAiBlV,KAAK0iB,cAAc1F,UAAU,CAAC45B,SAAQ7hC,WAmB3D,OAlBKG,GAaJA,EAAST,QAAUA,EACnBS,EAASE,SAAWA,EACpBF,EAASN,QAAUzU,KAAKygB,YAClB5gB,KAAK0iB,cAAchhB,QAAQwT,KAfjCA,EAAW,CACVrS,GAAI,GACJT,KAAM2K,EAAAjQ,aAAaoY,SACnB0hC,SACA7hC,SACAK,WACAX,UACAvD,QAAS/Q,KAAKygB,MACdhM,QAASzU,KAAKygB,QAEN/d,SAAW7C,KAAK0iB,cAAchgB,IAAIwS,GAOrCA,IAGFnV,OAAOsjB,EAAiBtO,iDACvB/U,KAAK0iB,cAAchf,cAAc,CAACkzC,OAAQvzB,EAAStO,6XC3C3D,MAAAhI,EAAArS,EAAA,GAGAyO,EAAAzO,EAAA,GAEAE,EAAA+1B,aAAA,cAAkCxnB,EAAApD,iBAEjChG,YAAmBuiB,GAClB/c,MAAM+c,GADYtiB,KAAAsiB,aAIXviB,WAAW62C,EAAgBC,EAAwB9hC,GAC1D,MAAO,CACNlS,GAAI,GACJT,KAAM2K,EAAAjQ,aAAaoJ,MACnB0wC,SACAC,WACA1wC,OAAQ,EACRC,WAAY,EACZC,WAAO7B,EACP8B,MAAO,EACPyO,UAIIhV,IAAI8C,EAAYT,EAAoB2S,EAAgB5T,2CACzD,MAAM+E,QAAclG,KAAKoM,aAAavJ,EAAIkS,EAAQ3S,GAClD,GAAIjB,EAAQ,CACX,QAAoBqD,IAAhB0B,EAAMG,MACT,OAAOH,EAERA,EAAMG,WAAQ7B,MACR,CACN,QAAoBA,IAAhB0B,EAAMG,MACT,OAAOH,EAERA,EAAMG,MAAQlG,KAAKygB,MAOpB,OALwB,IAApB1a,EAAMrD,GAAGd,aACN/B,KAAKsiB,WAAW5f,IAAIwD,SAEpBlG,KAAKsiB,WAAW5gB,QAAQwE,GAExBA,IAGFnG,KAAK8C,EAAYT,EAAoB2S,EAAgBvI,2CAC1D,MAAMtG,QAAclG,KAAKoM,aAAavJ,EAAIkS,EAAQ3S,GAWlD,OATC8D,EAAMI,MADQ,IAAXkG,OACWhI,EAEAgI,EAES,IAApBtG,EAAMrD,GAAGd,aACN/B,KAAKsiB,WAAW5f,IAAIwD,SAEpBlG,KAAKsiB,WAAW5gB,QAAQwE,GAExBA,IAGFnG,aAAa62C,EAAgB7hC,EAAgB3S,2CAElD,aADoBpC,KAAKsiB,WAAWtF,UAAU,CAACjI,SAAQ6hC,SAAQx0C,WAC/CpC,KAAK82C,WAAWF,EAAQx0C,EAAM2S,KAGzChV,iBAAiBwiB,EAAwBxN,EAAgB3S,2CAC9D,IAAKmgB,GAA8B,IAAnBA,EAAQxgB,OACvB,MAAO,GAER,MAAMqG,QAAapI,KAAKsiB,WAAWvW,OAAO,CAACgJ,SAAQ3S,OAAMmgB,YACnD9b,EAAkC,GASxC,OARA2B,EAAKvD,QAASqB,IACbO,EAAOP,EAAM0wC,QAAU1wC,IAExBqc,EAAQ1d,QAAShC,IACX4D,EAAO5D,KACX4D,EAAO5D,GAAM7C,KAAK82C,WAAWj0C,EAAIT,EAAM2S,MAGlCtO,IAGF1G,uBAAuBqC,EAAoB2S,2CAGhD,aAFqB/U,KAAKsiB,WAAWvW,OAAO,CAACgJ,SAAQ3S,OAAM20C,UAAW,KAC/C3/B,OAAOlR,QAAyB1B,IAAhB0B,EAAMI,OAAqBxB,KAAK,CAAC0E,EAAGC,IAAcA,EAAEnD,MAAgBkD,EAAElD,OAC9FgG,IAAI9C,GAAKA,EAAEotC,UAGrB72C,qBAAqBqC,2CAC1B,MAAMoE,QAAexG,KAAKsiB,WAAWvW,OAAO,CAAC3J,SACvC40C,EAA2C,GAajD,OAZAxwC,EAAO3B,QAAQqB,SACM1B,IAAhB0B,EAAMI,QACT0wC,EAAQ9wC,EAAM0wC,QAAUI,EAAQ9wC,EAAM0wC,SAAW,GACjDI,EAAQ9wC,EAAM0wC,QAAQvyC,KAAK6B,EAAMI,UAGtB9K,OAAOmJ,KAAKqyC,GAAS1qC,IAAIjQ,IAC9B,CACNwG,GAAIxG,EACJ46C,IAAKD,EAAQ36C,GAAKoyC,OAAO,CAAChlC,EAAGtO,IAAOsO,EAAItO,EAAI,GAAK67C,EAAQ36C,GAAK0F,UAE7D+C,KAAK,CAAC0E,EAAGC,IAAOA,EAAEwtC,IAAMztC,EAAEytC,KACjB3qC,IAAI9C,GAAKA,EAAE3G,MAGlB9C,2BAA2BqC,EAAoB2S,2CACpD,MAAMvO,QAAexG,KAAKsiB,WAAWvW,OAAO,CAACgJ,SAAQ3S,OAAM80C,UAAU,IAErE,OADA1wC,EAAO1B,KAAK,CAAC0E,EAAGC,IAAMA,EAAEtD,OAASqD,EAAErD,QAC5BK,EAAO8F,IAAI9C,GAAKA,EAAEotC,UAGpB72C,gBAAgBqC,EAAoB2S,2CACzC,MAAMvO,QAAexG,KAAKsiB,WAAWvW,OAAO,CAACgJ,SAAQ3S,OAAM+0C,SAAS,IAEpE,OADA3wC,EAAO1B,KAAK,CAAC0E,EAAGC,IAAcA,EAAEpD,MAAgBmD,EAAEnD,OAC3CG,EAAO8F,IAAI9C,GAAKA,EAAEotC,UAGpB72C,yBAAyBqC,EAAoB2S,2CAClD,MAAMvO,QAAexG,KAAKsiB,WAAWvW,OAAO,CAACgJ,SAAQ3S,OAAM80C,UAAU,IAErE,OADA1wC,EAAO1B,KAAK,CAAC0E,EAAGC,IAAMA,EAAErD,WAAaoD,EAAEpD,YAChCI,EAAO8F,IAAI9C,GAAKA,EAAEotC,UAGpB72C,cAAc8C,EAAYT,EAAoB2S,2CACnD,MAAM7O,QAAclG,KAAKoM,aAAavJ,EAAIkS,EAAQ3S,GAIlD,OAHA8D,EAAMC,SACND,EAAME,WAAajG,KAAKygB,YAClB5gB,KAAKsiB,WAAW7e,OAAO,CAACyC,IACvBA,ocCjIT,MAAAhE,EAAAxH,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IAiBAqS,EAAArS,EAAA,GAEAE,EAAAi3B,aAAA,MAEC9xB,YAAoBqa,EAAkC0W,EAC3CF,EAAsCS,EACtCE,EAAoCE,GAF3BzxB,KAAAoa,cAAkCpa,KAAA8wB,eAC3C9wB,KAAA4wB,gBAAsC5wB,KAAAqxB,gBACtCrxB,KAAAuxB,eAAoCvxB,KAAAyxB,cAGzC1xB,YAAYxE,EAAaoR,EAAejN,2CAC7C,IAAI+G,EACJ,OAAQlL,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB,MAAMA,EAAe7W,EACrBkL,QAAezG,KAAK8wB,aAAasmB,cAAchlC,EAAOzF,EAAMjN,GAC5D,MACD,KAAKqN,EAAAjQ,aAAayR,OACjB,MAAMA,EAAiBhT,EACvBkL,QAAezG,KAAK4wB,cAAcymB,eAAe9oC,EAAQ5B,EAAMjN,GAC/D,MACD,KAAKqN,EAAAjQ,aAAawB,OACjB,MAAMA,EAAiB/C,EACvBkL,QAAezG,KAAKqxB,cAAcimB,eAAeh5C,EAAQqO,EAAMjN,GAC/D,MACD,KAAKqN,EAAAjQ,aAAa0B,MACjB,MAAMA,EAAejD,EACrBkL,QAAezG,KAAKuxB,aAAagmB,cAAc/4C,EAAOmO,EAAMjN,GAC5D,MACD,KAAKqN,EAAAjQ,aAAa8M,KACjB,MAAMA,EAAarO,EACnBkL,QAAezG,KAAKyxB,YAAY+lB,aAAa5tC,EAAM+C,EAAMjN,GAK3D,OAAK+G,GACGzG,KAAKy3C,WAAWl8C,EAAGoR,EAAMjN,KAM5BK,WAAW4L,EAAegB,EAAejN,2CAC9C,MAgDM7C,EAhDkB,CAACtB,IACxB,OAAQA,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB,MAAMA,EAAe7W,EACrB,OAAO6W,EAAM5B,KAAO4B,EAAM5B,IAAIC,MAAQ2B,EAAM5B,IAAIC,MAAQ7P,EAAAxB,QAAKkR,SAAS8B,EAAM7B,MAC7E,KAAKxD,EAAAjQ,aAAayR,OACjB,MAAMA,EAAiBhT,EACvB,IAAIkL,EAWJ,OAVI8H,EAAOiC,MACNjC,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,OAClCmI,EAAS8H,EAAOiC,IAAIlS,OACV,CAAC4D,EAAAlF,WAAWyB,WAAYyD,EAAAlF,WAAWwB,OAAOuK,QAAQwF,EAAOiC,IAAIpO,OAAS,IAChFqE,EAAS8H,EAAOiC,IAAIhS,QAGjBiI,GAA4B,IAAlBA,EAAO1E,SACrB0E,EAAS7F,EAAAxB,QAAKkR,SAAS/B,EAAOgC,OAExB9J,EACR,KAAKsG,EAAAjQ,aAAayW,QACjB,MAAMA,EAA4BhY,EAClC,IAAI6pB,EAA2B7R,EAAQ/C,IAAM+C,EAAQ/C,IAAIC,WAAQjM,EAOjE,OANK4gB,GAAQ7R,EAAQhD,OACpB6U,EAAOxkB,EAAAxB,QAAKkR,SAASiD,EAAQhD,OAEzB6U,IACJA,EAAO,WAEDA,EACR,KAAKrY,EAAAjQ,aAAa0X,SAEjB,OADqCjZ,EACrBF,KACjB,KAAK0R,EAAAjQ,aAAawS,QACjB,MAAMA,EAA4B/T,EAClC,OAAO+T,EAAQkB,IAAMlB,EAAQkB,IAAIC,MAAQnB,EAAQpI,IAClD,KAAK6F,EAAAjQ,aAAa0B,MAGlB,KAAKuO,EAAAjQ,aAAawB,OAGlB,KAAKyO,EAAAjQ,aAAa8M,KAEjB,OADyBrO,EACbF,KACb,QACC,OAAO0R,EAAAjQ,aAAavB,EAAE6G,QAGfs1C,CAAgB/rC,GAC1B,OAAO3L,KAAKoa,YAAYu9B,MAAM96C,EAAG8P,GAAQ,IAAKjN,qcC9GhD,MAAAkB,EAAAzB,EAAAzE,EAAA,IACAk9C,EAAAl9C,EAAA,IACAqS,EAAArS,EAAA,GAWAE,EAAAu3B,gBAAA,MAECpyB,YAAoBud,GAAAtd,KAAAsd,aAINvd,gBAAgBwT,EAAkB7T,2CAC/C,OAAK6T,EAAQhD,KAGN,CAAC8U,KAAM,IAAIuyB,EAAAC,mBAAmB,CAACtkC,EAAQhD,MAAO3P,EAAAxB,QAAKkR,SAASiD,EAAQhD,MAAO7Q,IAF1E+H,QAAQE,OAAOvC,MAAM,gCAKhBrF,cAAcqS,EAAc1S,2CACzC,MAAO,CAAC2lB,KAAM,IAAIuyB,EAAAC,mBAAmB,CAACj3C,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,OAAQuF,EAAAxB,QAAKkR,SAAS8B,EAAM/W,MAAOqE,MAGxFK,eAAewO,EAAgB7O,2CAC5C,MAAO,CAAC2lB,KAAM,IAAIuyB,EAAAE,qBAAqBvpC,EAAOgC,KAAM3P,EAAAxB,QAAKkR,SAAS/B,EAAOgC,MAAO7Q,MAGnEK,eAAezB,EAAgBoB,2CAC5C,MACMq4C,SADe/3C,KAAKsd,WAAWra,MAAM3E,EAAOwS,WAC1BxE,IAAItQ,GAAK4E,EAAAxB,QAAKkB,KAAKtE,EAAEuU,KAAMvU,EAAEX,OACrD,MAAO,CAACgqB,KAAM,IAAIuyB,EAAAC,mBAAmBE,EAAUz5C,EAAOjD,KAAMqE,MAG/CK,cAAcvB,EAAckB,2CACzC,MACMq4C,SADe/3C,KAAKsd,WAAWra,MAAMzE,EAAMsS,WACzBxE,IAAItQ,GAAK4E,EAAAxB,QAAKkB,KAAKtE,EAAEuU,KAAMvU,EAAEX,OACrD,MAAO,CAACgqB,KAAM,IAAIuyB,EAAAC,mBAAmBE,EAAUv5C,EAAMnD,KAAMqE,MAG9CK,iBAAiByU,EAAoB9U,EAA4BkK,2CAC9E,GAAI4K,EAASO,SAAWnL,EAAK/G,KAAO2R,EAASG,SAC5C,OAAOlN,QAAQE,OAAOvC,MAAM,iBAE7B,MACM2yC,SADe/3C,KAAKsd,WAAWra,MAAMuR,EAAS1D,WAC5BxE,IAAItQ,GAAK4E,EAAAxB,QAAKkB,KAAKtE,EAAEuU,KAAMvU,EAAEX,OAErD,MAAO,CAACgqB,KAAM,IAAIuyB,EAAAC,mBAAmBE,EAAUvjC,EAASnZ,KAAMqE,MAGzDK,eAAexE,EAAamE,EAA4BkK,2CAC7D,OAAQrO,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB,OAAOpS,KAAKg4C,cAAqBz8C,EAAGmE,GACrC,KAAKqN,EAAAjQ,aAAayR,OACjB,OAAOvO,KAAKi4C,eAAuB18C,EAAGmE,GACvC,KAAKqN,EAAAjQ,aAAawB,OACjB,OAAO0B,KAAKk4C,eAAuB38C,EAAGmE,GACvC,KAAKqN,EAAAjQ,aAAa0B,MACjB,OAAOwB,KAAKm4C,cAAqB58C,EAAGmE,GACrC,KAAKqN,EAAAjQ,aAAayW,QACjB,OAAOvT,KAAKo4C,gBAAyB78C,EAAGmE,GACzC,KAAKqN,EAAAjQ,aAAa0X,SACjB,OAAOxU,KAAKq4C,iBAA2B98C,EAAGmE,EAAQkK,GAEpD,OAAOnC,QAAQE,OAAOvC,MAAM,0WCxE9B,MAAAkzC,EAAAn5C,EAAAzE,EAAA,KAGA6V,EAAAkY,EAAA/tB,EAAA,IACAoS,EAAApS,EAAA,GAEA,MAAe69C,EAKdx4C,YAAsBsB,EAAkB3B,GAGvC,GANMM,KAAAw4C,WAAY,EAIlBx4C,KAAKqB,SAAWyL,EAAArL,uBAAuBJ,EAAU,KAAKK,QAAQ,KAAM,KACpE1B,KAAKN,OAASA,GAAU,OACnBm4C,EAAmBY,kBAAkBz4C,KAAKN,QAC9C,MAAM,IAAI0F,MAAM,+BAIlBrF,yBAAyBL,GACxB,MAAO,CAAC,MAAO,OAAOqJ,QAAQrJ,IAAW,EAG1CK,KAAKgP,GAEJ,MACM2pC,EAAUJ,EAAAl5C,QAA0BY,KAAKN,OAAQ,CAACi5C,KAAM,CAACr5C,MAAO,KACtEo5C,EAAQxwB,GAAG,QAAUrgB,IAEpB,MAAMA,IAEPkH,EAAO6D,YAAY,OACnB7D,EAAO4V,UAAU,sBAAuB,0BAA4B3kB,KAAKqB,UAAY,YAAc,SAEnG0N,EAAOmZ,GAAG,SAAU,KAEnBloB,KAAKw4C,WAAY,IAElBE,EAAQrzB,KAAKtW,GACb/O,KAAKuuB,IAAImqB,GACTA,EAAQE,YAOVh+C,EAAAk9C,qBAAA,cAA0CS,EAEzCx4C,YAAmBwO,EAAgBlN,EAAkB3B,GACpD6F,MAAMlE,EAAU3B,GADEM,KAAAuO,SAITxO,IAAI24C,GACbA,EAAQG,UAAU74C,KAAKuO,QAAQ,KAIjC,MAAaspC,UAA2BU,EAGvCx4C,YAAYqI,EAAqB/G,EAAkB3B,GAClD6F,MAAMlE,EAAU3B,GAHVM,KAAAoI,KAAsB,GAI5BpI,KAAKoI,KAAOA,EAGHrI,IAAI24C,GACb14C,KAAKoI,KAAKvD,QAAQyS,IACjBohC,EAAQphC,KAAKA,EAAM,CAACjc,KAAMkV,EAAKD,SAASgH,QAV3C1c,EAAAi9C,oCC1DAh9C,EAAAD,QAAAmC,QAAA,0XCAA,MAAAgQ,EAAArS,EAAA,GAGAyO,EAAAzO,EAAA,GAEAE,EAAA64B,aAAA,cAAkCtqB,EAAApD,iBAEjChG,YAAmB2zB,GAClBnuB,MAAMmuB,GADY1zB,KAAA0zB,aAIb3zB,OAAO1E,EAAc6L,EAAa4xC,2CACvC,MAAMnjC,EAAe,CACpB9S,GAAI,GACJT,KAAM2K,EAAAjQ,aAAa6Y,MACnBta,OACAya,SAAUgjC,EACV5xC,MACAgK,QAAS/Q,KAAKygB,MACdhM,QAASzU,KAAKygB,OAGf,OADAjL,EAAM9S,SAAW7C,KAAK0zB,WAAWhxB,IAAIiT,GAC9BA,IAGF5V,OAAO4V,EAActa,EAAe6L,EAAc4xC,2CACvDnjC,EAAMG,SAAWgjC,GAAenjC,EAAMG,SACtCH,EAAMzO,IAAMA,GAAOyO,EAAMzO,IACzByO,EAAMta,KAAOA,GAAQsa,EAAMta,KAC3Bsa,EAAMf,QAAUzU,KAAKygB,YACf5gB,KAAK0zB,WAAWhyB,QAAQiU,KAGzB5V,OAAO4V,iDACN3V,KAAK0zB,WAAWvyB,OAAOwU,EAAM9S,scChCrC,MAAAiK,EAAApS,EAAA,GAEAkG,EAAAzB,EAAAzE,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IAEAwH,EAAAxH,EAAA,GAEA+yC,EAAA/yC,EAAA,IAEAw1B,EAAAx1B,EAAA,IAEM6F,EAAMkW,EAAArX,QAAO,iBAEnBxE,EAAAi2B,cAAA,cAAmC4c,EAAArkC,gBAElCrJ,YAAmBgd,EAAkCO,EAAwBjU,EAAmC+Q,GAC/G7U,MAAMwX,EAAa1T,GADDrJ,KAAA+c,cAAkC/c,KAAAsd,aAA2Dtd,KAAAoa,cAI1Gra,aAAawO,EAAgBlT,2CAClC,GAAIyR,EAAAnL,0BAA0BtG,GAC7B,OAAOoM,QAAQE,OAAOvC,MAAM,wBAG7B,GAAoB,KADpB/J,EAAOyR,EAAAjL,yBAAyBxG,EAAM,IAAIwd,QACjC9W,QAAgB,CAAC,IAAK,MAAMgH,QAAQ1N,IAAS,EACrD,OAAOoM,QAAQE,OAAOvC,MAAM,wBAE7B,MAAMxI,EAAIgE,EAAAxB,QAAKmf,QAAQhQ,EAAOgC,MACxBwoC,EAAUn4C,EAAAxB,QAAKkB,KAAK1D,EAAGvB,GAE7B,SADqBwF,EAAAzB,QAAI4B,WAAW+3C,GAEnC,OAAOtxC,QAAQE,OAAOvC,MAAM,mCAEvBvE,EAAAzB,QAAI45C,OAAOzqC,EAAOgC,KAAMwoC,GAC9B,MAAMt7B,QAAgBzd,KAAK+c,YAAYhR,OAAO,CAACoR,OAAQ5O,EAAOgC,OAC9D,IAAK,MAAM6M,KAAKK,EAAS,CACxB,MAAMw7B,EAAO77B,EAAE7M,KAAKhP,MAAMgN,EAAOgC,KAAKxO,OAAS,GAC3Ck3C,EAAKl3C,OAAS,GAAKk3C,EAAK,KAAOr4C,EAAAxB,QAAK4C,IACvCzB,EAAIiL,MAAM,qBAAsBytC,EAAM1qC,EAAOgC,KAAM6M,EAAE7M,OAErD6M,EAAE7M,KAAOwoC,EAAUjsC,EAAAhL,4BAA4Bm3C,SACzCj5C,KAAK+c,YAAYrb,QAAQ0b,IAGjC,MAAMpI,QAAehV,KAAKsd,WAAWvR,OAAO,CAACoR,OAAQ5O,EAAOgC,OAC5D,IAAK,MAAMvU,KAAKgZ,EACfhZ,EAAEuU,KAAOvU,EAAEuU,KAAK7O,QAAQ6M,EAAOgC,KAAMzD,EAAAhL,4BAA4Bi3C,UAC3D/4C,KAAKsd,WAAW5b,QAAQ1F,GAE/BuS,EAAOgC,KAAOzD,EAAAhL,4BAA4Bi3C,KAGrCh5C,kBAAkBm5C,2CACvB,MAAMzyC,EAAwB,GACxBT,EAAQhG,KAAK+c,YAcnB,aAZA,SAAeo8B,EAAQt2C,2CACtB,IAAKA,EACJ,OAED,MAAM0L,QAAevI,EAAMjD,KAAKF,GAC5B0L,IACH9H,EAAOk7B,QAAQpzB,SACT4qC,EAAQ5qC,EAAO8B,aAIjB8oC,CAAQD,GACPzyC,IAGF1G,eAAewO,EAAgB5B,EAAejN,2CACnD,GAAK6O,EAAOiC,IAAIoB,OACVrD,EAAOiC,IAAIoB,MAIjB,aAAa5R,KAAKoa,YAAYze,IAAI4S,EAAO1L,GAAIjC,EAAAxB,QAAKkB,KAAKiO,EAAOgC,KAAMhC,EAAOiC,IAAIoB,OAAQjF,EAAMjN,KAGxFK,eAAewO,EAAgBlN,2CACpC,MAAM6qC,EAAehqC,EAAA9D,oBAAoBmQ,EAAOiC,IAAIpO,MAAQxB,EAAAxB,QAAKkC,QAAQD,GACnE8qC,EAAWvrC,EAAAxB,QAAKkB,KAAKiO,EAAOgC,KAAM27B,SAClCp/B,EAAAhM,mBAAmBqrC,SACnBtrC,EAAAzB,QAAI68B,KAAK56B,EAAU8qC,GACzB59B,EAAOiC,IAAIoB,MAAQs6B,QACblsC,KAAK+c,YAAYrb,QAAQ6M,KAG1BxO,gBAAgBwO,EAAgB6qC,EAAkBzsC,EAAejN,2CACtE,aAAaM,KAAKoa,YAAYze,IAAIy9C,EAAQv2C,GAAIjC,EAAAxB,QAAKkB,KAAKiO,EAAOgC,KAAM6oC,EAAQ/9C,MAAOsR,EAAMjN,KAGrFK,qBAAqBwO,2CAC1B,IAAIA,EAAOiC,IAAIoB,OAGXrD,EAAOiC,IAAIyP,SAAU,CACxB,MAAMm5B,EAAU7qC,EAAOiC,IAAIyP,SAAStD,KAAKnT,GAAKA,EAAE6V,MAAMtW,QAAQ7G,EAAAvD,iBAAiB2gB,QAAU,GACrF85B,IACH7qC,EAAOiC,IAAIoB,MAAQwnC,EAAQ/9C,WACrB2E,KAAK+c,YAAYrb,QAAQ6M,OAK5BxO,mBAAmBwO,EAAgB6qC,2CACxC,IAAK7qC,EAAOiC,IAAIyP,SACf,OAED1R,EAAOiC,IAAIyP,UAAY1R,EAAOiC,IAAIyP,UAAY,IAAI7I,OAAOqM,GAAOA,EAAI5gB,KAAOu2C,EAAQv2C,IACnF,MAAMw2C,EAAU,GACZ9qC,EAAOiC,IAAIoB,QAAUwnC,EAAQ/9C,OAChCkT,EAAOiC,IAAIoB,WAAQpN,EACnB60C,EAAQh1C,KAAKkK,EAAO1L,KAErBw2C,EAAQh1C,KAAK+0C,EAAQv2C,UACf7C,KAAK+c,YAAYrb,QAAQ6M,GAC/B,MAAM49B,EAAWvrC,EAAAxB,QAAKkB,KAAKiO,EAAOgC,KAAM6oC,EAAQ/9C,YAC1CyR,EAAAhM,mBAAmBqrC,GACzBjiB,QAAQ3pB,IAAI84C,SACNr5C,KAAKoa,YAAY0I,qBAAqBu2B,SACtCr5C,KAAKs5C,qBAAqB/qC,KAG3BxO,sBAAsBwO,EAAgBgrC,EAAkBl6B,2CAC7D,MAAMhkB,EAAOgkB,EAAMva,KAAK,CAAC0E,EAAGC,IAAMD,EAAEoT,cAAcnT,IAAInJ,KAAK,KACrDe,QAAiBrB,KAAKoa,YAAYo/B,WAAWjrC,EAAOgC,KAAMlV,EAAMk+C,GAChEhnC,QAAa1R,EAAAzB,QAAImT,KAAK3R,EAAAxB,QAAKkB,KAAKiO,EAAOgC,KAAMlP,IAC7C+3C,EAAU,CACfv2C,GAAIqtB,EAAApX,kBAAkBvK,EAAO1L,GAAIxB,GACjChG,KAAMgG,EACNge,QACA9M,KAAM,CACLrB,QAASqB,EAAKkF,MAAMoG,UACpBrG,SAAUjF,EAAKgF,MAAMsG,UACrBlR,KAAM4F,EAAK5F,OAOb,OAJA4B,EAAOiC,IAAIyP,SAAW1R,EAAOiC,IAAIyP,UAAY,GAC7C1R,EAAOiC,IAAIyP,SAAS5b,KAAK+0C,SACnBp5C,KAAK+c,YAAYrb,QAAQ6M,SACzBvO,KAAKs5C,qBAAqB/qC,GACzB6qC,ocClJT,MAAAx4C,EAAAzB,EAAAzE,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IACA++C,EAAA/+C,EAAA,IACAoS,EAAApS,EAAA,GAEAg/C,EAAAv6C,EAAAzE,EAAA,MACAi/C,EAAAx6C,EAAAzE,EAAA,MACA+rC,EAAA/rC,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IACAic,EAAAjc,EAAA,IAIM6F,EAAMkW,EAAArX,QAAO,UAMnBxE,EAAA81B,YAAA,MAKC3wB,YAAoB65C,GAAA55C,KAAA45C,iBAJZ55C,KAAAN,OAAS,MAETM,KAAA65C,mBAAqB,IAAIpT,EAAAp7B,iBAK3BtL,WAAW+5C,EAAkBz+C,EAAck+C,2CAChDh5C,EAAIid,MAAM,mBAAoB+7B,GAC9B,MAAMQ,EAAWn5C,EAAAxB,QAAKkC,QAAQi4C,GAAUp+B,MAAM,KAAK,GAAGtC,OAAOrX,cAC7D,GAAwB,IAApBu4C,EAASh4C,OACZ,OAAO0F,QAAQE,OAAOvC,MAAM,sBAE7B,IAAI/D,EAAWhG,EAAO0+C,EAClB7c,EAAK,EACT,WAAar8B,EAAAzB,QAAI4B,WAAWJ,EAAAxB,QAAKkB,KAAKw5C,EAAUz4C,KAC/CA,EAAWhG,EAAO,IAAM6hC,EAAK6c,EAC7B7c,IAID,aAFMuc,EAAA/wB,aAAa6wB,EAAU34C,EAAAxB,QAAKkB,KAAKw5C,EAAUz4C,IACjDd,EAAI8Q,KAAK,mBAAoBhQ,GACtBA,IAGFtB,MAAMqlB,EAAczY,EAA0BjN,2CACnDiN,EAAOA,GAAQ,IACf,MAAMiF,EAAQ,IAAI8nC,EAAAt6C,QAAK,IAAK,IAAK,WAC5BY,KAAKg6C,OACTh6C,KAAKg6C,WAAaN,EAAAt6C,QAAK66C,SAASP,EAAAt6C,QAAK86C,qBAEtCtoC,EAAMuoC,MAAMn6C,KAAKg6C,KAAM,GAAI,GAAI,CAC9B50B,KAAMA,EACNg1B,WAAYV,EAAAt6C,QAAKi7C,wBACjBC,WAAYZ,EAAAt6C,QAAKm7C,uBACf,IAAK,KAER3oC,EAAM4oC,OAAO7tC,EAAMA,GACnB,MAAM8tC,EAAOd,EAAAv6C,QAAU69B,OAAOv9B,GAAkBM,KAAKN,QACrD,OAAK+6C,EAIE,CACNn1B,OAAQ,CACPA,aAHmB1T,EAAM8oC,eAAeD,GAIxC7nC,YAAa6nC,IANPhzC,QAAQE,OAAO,kCAWV5H,SAASsB,EAAkBsL,EAA0BtR,2CAClE,IAAIs/C,EAAa/5C,EAAAxB,QAAKkC,QAAQD,GAI9B,MAHsB,MAAlBs5C,EAAW,KACdA,EAAaA,EAAWp5C,MAAM,IAExBvB,KAAK46C,WAAWv5C,EAAUs5C,EAAYhuC,EAAMtR,KAGtC0E,WAAWsB,EAAkB3B,EAAgBiN,EAA0BtR,2CACpF,IAAIs/C,EAAa/5C,EAAAxB,QAAKkC,QAAQD,GAK9B,GAJsB,MAAlBs5C,EAAW,KACdA,EAAaA,EAAWp5C,MAAM,YAEVV,EAAAzB,QAAI4B,WAAWK,IAEnC,OAAOoG,QAAQE,OAAOvC,MAAM,mBAE7B,GAAIuH,GAASguC,IAAej7C,EAAS,CACpC,MAAMkS,QAAc8nC,EAAAt6C,QAAKkf,KAAKjd,GACxBo5C,EAAOd,EAAAv6C,QAAU69B,OAAOv9B,GAC9B,OAAK+6C,GAGD9tC,IACHiF,EAAMipC,KAAK,EAAG,EAAGjpC,EAAMkpC,WAAa,EAAGlpC,EAAMmpC,YAAc,GAE3DnpC,EAAMopC,QAAQruC,EAAMA,IAGd,CACN2Y,OAAQ,CACPA,aAHmB1T,EAAM8oC,eAAeD,GAIxC7nC,YAAa6nC,KAXPhzC,QAAQE,OAAO,gCAevB,MAAO,CAAC2P,KAAM,CAACjW,WAAUhG,WAIrB0E,IAAI8C,EAAYxB,EAAkBsL,EAA0BjN,2CACjE,IAAK2B,EACJ,OAAOoG,QAAQE,OAAOvC,MAAM,iBAE7B,GAAI1F,GAAUiX,EAAAoN,0BAA0Bhb,QAAQrJ,GAAU,EACzD,OAAO+H,QAAQE,OAAOvC,MAAM,mBAE7B,IAAI1F,IAAUiN,EA8Bb,OAAO3M,KAAKi7C,SAAS55C,EAAUsL,EAAM9J,EAAK,KAAOnD,GAAUM,KAAKN,SA9B7C,CACnB,MAAM4xC,EAAU,SAAWzuC,GAAM8J,EAAO,IAAMA,EAAO,IAAM,KAAOjN,GAAUM,KAAKN,QACjF,GAAIM,KAAK65C,mBAAmBjS,UAAU0J,GACrC,OAAOtxC,KAAK65C,mBAAmBhS,OAAOyJ,GAEvCtxC,KAAK65C,mBAAmB/R,WAAWwJ,GACnC,IACC,IAAI7qC,EACJ,MAAM8qC,EAAY3wC,EAAAxB,QAAKkB,KAAKN,KAAK45C,eAAgBtI,GAgBjD,aAfqBzwC,EAAAzB,QAAI4B,WAAWuwC,IAEnC9qC,EAAS,CAAC6Q,KAAM,CAACjW,SAAUkwC,EAAWl2C,KAAMi2C,KAG3C7qC,EADG/G,QACYM,KAAK46C,WAAWv5C,EAAU3B,EAAQiN,EAAM2kC,SAExCtxC,KAAKi7C,SAAS55C,EAAUsL,EAAM2kC,IAEnChsB,SACV/kB,EAAIid,MAAM,2BAA4B+zB,SAChC1wC,EAAAzB,QAAIqyC,UAAUF,EAAW9qC,EAAO6e,OAAOA,eAGzCtlB,KAAK65C,mBAAmBnyC,QAAQ4pC,EAAS7qC,GACxCA,EACN,MAAOwJ,GAER,aADMjQ,KAAK65C,mBAAmBlyC,OAAO2pC,EAASrhC,GACvCxI,QAAQE,OAAOsI,OAOnBlQ,YAAYsB,EAAkB65C,EAAqBvuC,2CACxD,MAAMiF,QAAc8nC,EAAAt6C,QAAKkf,KAAKjd,GAC9BuQ,EAAMopC,QAAQruC,EAAMA,SACdiF,EAAMupC,WAAWD,KAGlBn7C,qBAAqBiD,2CAC1B,MAAMmuC,EAAWnuC,EAAIoU,OAAOvU,GAAMA,EAAGd,OAAS,GAAGuK,IAAIzJ,GAAM,SAAWA,GACtE,GAAIsuC,EAASpvC,OAAS,EAAG,CACxB,IAAIqG,QAAavH,EAAAzB,QAAI0e,QAAQ9d,KAAK45C,gBAClCxxC,EAAOA,EAAKgP,OAAO/b,GACX81C,EAASE,UAAUx0C,GAAyB,IAApBxB,EAAK0N,QAAQlM,KAAa,GAE1D,IAAK,MAAMwE,KAAY+G,QAChBvH,EAAAzB,QAAI6B,OAAOL,EAAAxB,QAAKsI,QAAQ1H,KAAK45C,eAAgBv4C,OAKhDtB,oBAAoB8C,2CACzB,GAAkB,IAAdA,EAAGd,OACN,OAED,MAAMgK,EAAS,SAAWlJ,EAC1B,IAAIuF,QAAavH,EAAAzB,QAAI0e,QAAQ9d,KAAK45C,gBAClCxxC,EAAOA,EAAKgP,OAAO/b,GAAiC,IAAzBA,EAAK0N,QAAQgD,IACxC,IAAK,MAAM1K,KAAY+G,QAChBvH,EAAAzB,QAAI6B,OAAOL,EAAAxB,QAAKsI,QAAQ1H,KAAK45C,eAAgBv4C,MAI/CtB,aAAasB,EAAkB65C,2CACpC,OAAM75C,SAGeR,EAAAzB,QAAI4B,WAAWK,WAI9BrB,KAAKo7C,YAAY/5C,EAAUA,EAAW,OAAQ,UAC9CyL,EAAAhM,mBAAmBo6C,cACnBr6C,EAAAzB,QAAI45C,OAAO33C,EAAW,OAAQ65C,KAJ5BzzC,QAAQE,OAAOvC,MAAM,mBAJrBqC,QAAQE,OAAOvC,MAAM,oCCxL/BvK,EAAAD,QAAAmC,QAAA,uBCAAlC,EAAAD,QAAAmC,QAAA,uBCAAlC,EAAAD,QAAAmC,QAAA,4cCKA,MAAA0wC,EAAA/yC,EAAA,IAEAoS,EAAApS,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IAEAE,EAAAm2B,aAAA,cAAkC0c,EAAArkC,gBAEjCrJ,YAAmBud,EAAgCsT,EAA8BvnB,GAChF9D,MAAM+X,EAAYjU,GADArJ,KAAAsd,aAAgCtd,KAAA4wB,gBAI7C7wB,eAAeqS,2CACpB,aAAapS,KAAK4wB,cAAc7T,YAAYha,KAAKqP,EAAM/B,YAGlDtQ,cAAcqS,EAAczF,EAAejN,2CAChD,MAAM6O,QAAevO,KAAKq7C,eAAejpC,GACzC,GAAI7D,EACH,OAAOvO,KAAK4wB,cAAcymB,eAAe9oC,EAAQ5B,EAAMjN,KAInDK,YAAYqS,EAAc/W,2CAE/B,GAAoB,KADpBA,EAAOyR,EAAArL,uBAAuBpG,EAAM,IAAIwd,QAC/B9W,OACR,OAAO0F,QAAQE,OAAOvC,MAAM,iBAE7B,MAAMy8B,EAAMjhC,EAAAxB,QAAKkC,QAAQjG,GAAMmG,cACzB85C,EAAO16C,EAAAxB,QAAKkC,QAAQ8Q,EAAM/W,MAAMmG,cACtC,GAAIqgC,IAAQyZ,EACX,OAAO7zC,QAAQE,OAAOvC,MAAM,yCAA2Cy8B,EAAM,KAAOyZ,IAErF,MAAMvC,EAAUn4C,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAMlV,GAEtC,SADqBwF,EAAAzB,QAAI4B,WAAW+3C,GAEnC,OAAOtxC,QAAQE,OAAOvC,MAAM,8BAEvBvE,EAAAzB,QAAI45C,OAAOp4C,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,MAAOuF,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAMlV,IAC1E+W,EAAM/W,KAAOA,QACP2E,KAAKsd,WAAW7Z,OAAO,CAAC2O,sXCzChC,MAAAlQ,EAAAxH,EAAA,GAGA+yC,EAAA/yC,EAAA,IAEAw1B,EAAAx1B,EAAA,IAEAE,EAAA02B,cAAA,cAAmCmc,EAAArkC,gBAGlCrJ,YAAmBygB,EAAkClD,EAAgCsT,EAA8BvnB,GAClH9D,MAAMib,EAAanX,GADDrJ,KAAAwgB,cAAkCxgB,KAAAsd,aAAgCtd,KAAA4wB,gBAI/E7wB,gBAAgBzB,2CACrB,GAA+B,IAA3BA,EAAOwS,SAAS/O,OACnB,OAED,MAAMqQ,QAAcpS,KAAKsd,WAAWva,KAAKzE,EAAOwS,SAAS,IACzD,IAAKsB,EACJ,OAED,MAAMqL,QAAgBzd,KAAK4wB,cAAc2qB,kBAAkBnpC,EAAM/B,UACjE,GAAuB,IAAnBoN,EAAQ1b,OACX,OAED,IAAIwM,EAASkP,EAAQd,KAAKS,GAAKA,EAAE5M,IAAIpO,OAASF,EAAAlF,WAAWsB,QAIzD,OAHKiQ,IACJA,EAASkP,EAAQA,EAAQ1b,OAAS,IAE5BwM,IAGFxO,eAAezB,EAAgBqO,EAAejN,2CACnD,GAAIpB,EAAOjD,OAAS60B,EAAArY,eACnB,OAAO7X,KAAK4wB,cAAcxW,YAAYu9B,MAAMznB,EAAArY,eAAgBlL,EAAMjN,GAEnE,MAAM6O,QAAevO,KAAKw7C,gBAAgBl9C,GAC1C,OAAIiQ,EACIvO,KAAK4wB,cAAcymB,eAAe9oC,EAAQ5B,EAAMjN,QADxD,oXCrCF,MAAAwC,EAAAxH,EAAA,GAEA+yC,EAAA/yC,EAAA,IAGAE,EAAA42B,aAAA,cAAkCic,EAAArkC,gBAEjCrJ,YAAmBmhB,EAAgC5D,EAAgCsT,EAA8BvnB,GAChH9D,MAAM2b,EAAY7X,GADArJ,KAAAkhB,aAAgClhB,KAAAsd,aAAgCtd,KAAA4wB,gBAI7E7wB,eAAevB,2CACpB,GAA8B,IAA1BA,EAAMsS,SAAS/O,OAClB,OAED,MAAMqQ,QAAcpS,KAAKsd,WAAWva,KAAKvE,EAAMsS,SAAS,IACxD,IAAKsB,EACJ,OAED,IAAIqL,QAAgBzd,KAAK4wB,cAAc2qB,kBAAkBnpC,EAAM/B,UAC/D,GAAuB,IAAnBoN,EAAQ1b,OACX,OAGD,IAAIwM,GADJkP,EAAUA,EAAQ3Y,KAAK,CAAC0E,EAAGC,IAAMA,EAAE+G,IAAIlR,MAAQkK,EAAEgH,IAAIlR,QAChC,GACrB,IAAK,MAAM8d,KAAKK,EAAS,CACxB,KAAIvb,EAAAtD,iBAAiBmK,QAAQqU,EAAE5M,IAAIpO,OAAS,GAG3C,MAFAmM,EAAS6O,EAKX,OAAO7O,IAGFxO,cAAcvB,EAAcmO,EAAejN,2CAChD,MAAM6O,QAAevO,KAAKy7C,eAAej9C,GACzC,GAAI+P,EACH,OAAOvO,KAAK4wB,cAAcymB,eAAe9oC,EAAQ5B,EAAMjN,qcC3C1D,MAAAoN,EAAApS,EAAA,GACAic,EAAAjc,EAAA,IACAkG,EAAAzB,EAAAzE,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IAEA++C,EAAA/+C,EAAA,IACAmG,EAAA1B,EAAAzE,EAAA,IAGAwH,EAAAxH,EAAA,GACA+rC,EAAA/rC,EAAA,IACA+yC,EAAA/yC,EAAA,IAGM6F,EAAMkW,EAAArX,QAAO,kBAEnBxE,EAAAk4B,eAAA,cAAoC2a,EAAArkC,gBAGnCrJ,YAAoB27C,EAA6B3oB,EAA4B1pB,EAAoC8Q,GAChH5U,MAAMwtB,EAAc1pB,GADDrJ,KAAA07C,eAA6B17C,KAAA+yB,eAAgE/yB,KAAAma,cAFzGna,KAAA27C,wBAA0B,IAAIlV,EAAAp7B,iBAMtCtL,cAAc67C,GACb,OAAO57C,KAAK27C,wBAAwB/T,UAAUgU,GAGjC77C,oBAAoBwT,2CACjC,IAAIrM,EAAM,GACV,KAAIqM,EAAQ88B,YAAc98B,EAAQ88B,WAAWtuC,OAAS,GAGrD,MAAM,IAAIqD,MAAM,gCAFhB8B,EAAMqM,EAAQ88B,WAAW,GAAGnpC,IAI7B,MAAMmL,EAASvF,EAAA1L,WAAW8F,GAC1B,GAAIyP,EAAAqN,qBAAqBjb,QAAyBsJ,GAAU,EAC3D,MAAM,IAAIjN,MAAM,oCAEjB,MAAMxI,EAAIgE,EAAAxB,QAAKsI,QAAQ1H,KAAK07C,aAAcnoC,EAAQa,iBAC5CvT,EAAAzB,QAAIg1B,UAAUx3B,GACpB,MAAMyE,EAAWT,EAAAxB,QAAKkB,KAAK1D,EAAG2W,EAAQ1Q,GAAK,IAAMwP,GAGjD,OAFA9R,EAAI8Q,KAAK,kBAAmBnK,SACtBuyC,EAAA/wB,aAAaxhB,EAAK7F,GACjBA,IAGFtB,gBAAgBwT,2CACrB,GAAIvT,KAAK27C,wBAAwB/T,UAAUr0B,EAAQ1Q,IAClD,OAAO7C,KAAK27C,wBAAwB9T,OAAOt0B,EAAQ1Q,IAEpD7C,KAAK27C,wBAAwB7T,WAAWv0B,EAAQ1Q,IAChD,IACC,IACC,MAAMxB,QAAiBrB,KAAK67C,oBAAoBtoC,GAC1ChB,QAAa1R,EAAAzB,QAAImT,KAAKlR,GACtBoF,QAAezG,KAAKma,YAAYmE,KAAKjd,GAC3CkS,EAAQnG,OAASlL,EAAA/D,cAAc+vC,UAC/B36B,EAAQ/C,IAAM/J,EAAO+J,IACrB+C,EAAQf,MAAQ/L,EAAO+L,MACvBe,EAAQhB,KAAO,CACdrB,QAASqB,EAAKkF,MAAMoG,UACpBrG,SAAUjF,EAAKgF,MAAMsG,UACrBlR,KAAM4F,EAAK5F,MAEZ4G,EAAQhD,KAAOlP,EACd,MAAO4O,GACRsD,EAAQnG,OAASlL,EAAA/D,cAAcqN,MAC/B+H,EAAQ/H,OAASyE,GAAK,IAAIxP,iBAErBT,KAAK+yB,aAAarxB,QAAQ6R,SAC1BvT,KAAK27C,wBAAwBj0C,QAAQ6L,EAAQ1Q,QAAI2B,GACtD,MAAOyL,GAER,aADMjQ,KAAK27C,wBAAwBj0C,QAAQ6L,EAAQ1Q,QAAI2B,GAChDiD,QAAQE,OAAOsI,MAIlBlQ,eAAeqU,2CACpB,MAAM05B,QAAuB9tC,KAAK+yB,aAAahnB,OAAO,CAACqI,cACjDpR,EAAM8qC,EAAexhC,IAAIiH,GAAWA,EAAQ1Q,UAC5C7C,KAAK+yB,aAAa5xB,OAAO6B,GAC/B,IAAK,MAAMuQ,KAAWu6B,EACjBv6B,EAAQhD,aACLzD,EAAAhM,mBAAmByS,EAAQhD,OAGnC,MAAM3T,EAAIgE,EAAAxB,QAAKsI,QAAQ1H,KAAK07C,aAActnC,SACpCtH,EAAA5L,mBAAmBtE,KAGpBmD,cAAcwT,2CACdA,EAAQhD,aAGPzD,EAAAhM,mBAAmByS,EAAQhD,MACjCgD,EAAQhD,UAAO/L,EACf+O,EAAQhB,UAAO/N,EACf+O,EAAQf,WAAQhO,EAChB+O,EAAQnG,OAASlL,EAAA/D,cAAc29C,cACzB97C,KAAK+yB,aAAarxB,QAAQ6R,MAG3BxT,cAAcqU,EAAmB65B,2CACtC,IAAMA,IAAeA,EAASlsC,OAC7B,MAAO,GAER,MACMg6C,SADY/7C,KAAK+yB,aAAahnB,OAAO,CAACqI,eAC1B9H,IAAI2D,GAAKA,EAAEkZ,MAG7B,OAFA8kB,EAAWA,EAAS72B,OAAOnH,GAAK8rC,EAAMhzC,QAAQkH,EAAEkZ,MAAQ,SAClDnpB,KAAK+yB,aAAatvB,OAAOwqC,GACxBA,qFC1GT,MAAA+N,EAAAthD,EAAA,IA4BaE,EAAAmM,UAAY,YAAci1C,EAAAh2B,iBAE1BprB,EAAA41B,iBAA0C,CAMtDkK,SAAU,CAACD,OAAQ,aAAc1zB,UAAAnM,EAAAmM,WAMjCyzB,OAAQ,CAACC,OAAQ,mCAAoC1zB,UAAAnM,EAAAmM,WAMrD8f,YAAa,CAAC9f,UAAWnM,EAAAmM,UAAY,gCAMrCqzB,eAAgB,CAACrzB,UAAWnM,EAAAmM,UAAY,gCAMxCo0B,gBAAiB,CAACp0B,UAAWnM,EAAAmM,UAAY,gCAKzCg0B,UAAW,CAACh0B,UAAWnM,EAAAmM,UAAY,gCAMnC+zB,YAAa,CAAC/zB,UAAAnM,EAAAmM,0XCzEf,MAAA7E,EAAAxH,EAAA,GAEAE,EAAAq3B,aAAA,MAGClyB,YAAoBiG,GAAAhG,KAAAgG,QAFZhG,KAAA6a,MAAsB,GAKxB9a,kDACLC,KAAK6a,MAAQ,KAGR9a,SAASwd,2CACd,IAAIhL,EAAOvS,KAAK6a,MAAM8B,KAAK9f,GAAKA,EAAE0gB,SAAWA,GAqB7C,OApBKhL,IACJA,EAAO,CACNgL,SACA/e,YAAawB,KAAKgG,MAAMkb,WAAWimB,YAAY,CAAC5pB,WAChDoD,WAAY,CACXniB,YAAawB,KAAKgG,MAAMkb,WAAWimB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAUN,QAC7Eia,kBAAmBzY,KAAKgG,MAAMkb,WAAWimB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAU2Z,cACnFgE,gBAAiBzc,KAAKgG,MAAMkb,WAAWimB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAU2d,aAElFne,aAAc0B,KAAKgG,MAAMwa,YAAY2mB,YAAY,CAAC5pB,WAClD0+B,YAAa,CACZz9C,YAAawB,KAAKgG,MAAMwa,YAAY2mB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAUN,QAC9Eia,kBAAmBzY,KAAKgG,MAAMwa,YAAY2mB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAU2Z,cACpFgE,gBAAiBzc,KAAKgG,MAAMwa,YAAY2mB,YAAY,CAAC5pB,SAAQ/E,UAAWtW,EAAApD,UAAU2d,aAEnFlO,aAAcvO,KAAKgG,MAAM+W,YAAYoqB,YAAY,CAAC5pB,WAClDnL,YAAapS,KAAKgG,MAAMsX,WAAW6pB,YAAY,CAAC5pB,YAEjDvd,KAAK6a,MAAMxW,KAAKkO,IAEVA,oXClCT,MAAA2pC,EAAAxhD,EAAA,KACAqS,EAAArS,EAAA,GAKAE,EAAAu2B,gBAAA,MAGCpxB,YAAmBqxB,EAAsCf,EAAkCW,EAAoCE,EAAkCrjB,GAA9I7N,KAAAoxB,gBAAsCpxB,KAAAqwB,cAAkCrwB,KAAAgxB,eAAoChxB,KAAAkxB,cAAkClxB,KAAA6N,UAF1J7N,KAAA0a,SAA8BwhC,EAAAC,gBAM/Bp8C,8CACL,OAAOC,KAAK0a,WAGL3a,YAAY2a,GACnB1a,KAAK0a,SAAWA,EAChB1a,KAAKqwB,YAAY+rB,YAAYp8C,KAAK0a,SAAS2hC,MAC3Cr8C,KAAKgxB,aAAaorB,YAAYp8C,KAAK0a,SAAS5K,OAC5C9P,KAAKkxB,YAAYkrB,YAAYp8C,KAAK0a,SAAS0T,SAGtCruB,uDACL,IAAI2a,QAAiB1a,KAAKoxB,cAAcpU,UAAU,CAACqwB,QAAS,aACvD3yB,IACJA,EAAW,CACV7X,GAAI,GACJT,KAAM2K,EAAAjQ,aAAa4d,SACnB2yB,QAAS,WACThvB,KAAM69B,EAAAC,gBACNtuC,QAAS7N,KAAK6N,eAET7N,KAAKoxB,cAAc1uB,IAAIgY,IAE9B1a,KAAKo8C,YAAY1hC,EAAS2D,QAGrBte,eAAe2a,2CACpB1a,KAAKo8C,YAAY1hC,sFCxCN9f,EAAAuhD,gBAAqC,CACjDE,KAAM,CACLxP,YAAa,IACbC,OAAQ,CAAC/wC,MAAO,EAAGgxC,KAAM,QAE1Bj9B,MAAO,CACN82B,eAAgB,CAAC,MAAO,KAAM,KAAM,MAAO,MAAO,KAAM,MAAO,QAEhExY,QAAS,CACRzT,aAAa,EACbC,oBAAqB,CAAC,YAAa,aAAc,aAAc,cAAe,WAAY,YAAa,UAAW,6cCZpH,MAAA0hC,EAAAn9C,EAAAzE,EAAA,KAEA6hD,EAAAp9C,EAAAzE,EAAA,MACA8hD,EAAA9hD,EAAA,KACA+hD,EAAA/hD,EAAA,KACAkG,EAAAzB,EAAAzE,EAAA,IAEA+b,EAAAtX,EAAAzE,EAAA,IACAgiD,EAAAv9C,EAAAzE,EAAA,MAEM6F,EAAMkW,EAAArX,QAAO,UAMnBxE,EAAAgzB,OAAA,MAKC7tB,YAAY0tB,GACXztB,KAAKytB,OAASA,EACd,MAAMkvB,EAA2BL,EAAAl9C,UACjCu9C,EAAIxvB,IAAIovB,EAAAn9C,QAAWw9C,WAAW,CAACC,UAAU,EAAM9Y,MAAO,UACtD4Y,EAAIxvB,IAAIovB,EAAAn9C,QAAW0lB,KAAK,CAACif,MAAO,UAChC4Y,EAAIxvB,IAAIovB,EAAAn9C,QAAW0lB,KAAK,CAAC1iB,KAAM,2BAA4B2hC,MAAO,UAElE4Y,EAAIxvB,IAAIuvB,EAAAt9C,WAORu9C,EAAIxvB,IALJ,SAA0BlhB,EAAsBuY,EAAuB+Q,GACtDtpB,EAAKwhB,OAASA,EAC9B8H,MAIDonB,EAAIxvB,IAAI,UAAWqvB,EAAAM,cAAcrvB,IACjCkvB,EAAIxvB,IAAI,QAASsvB,EAAAM,mBAAmBtvB,IAGpCkvB,EAAIhhD,IAAI,2BAA4B,CAACsQ,EAAKuY,KACzCA,EAAIe,SAAS3kB,EAAAxB,QAAKsI,QAAQ,kCAG3Bi1C,EAAIhhD,IAAI,KAAM2gD,EAAAl9C,QAAQ49C,OAAOp8C,EAAAxB,QAAKsI,QAAQ+lB,EAAOT,OAAO5B,MAAM6xB,YAC9DN,EAAIhhD,IAAI,KAAM,CAACsQ,EAAsBuY,KACpCA,EAAIe,SAAS3kB,EAAAxB,QAAKkB,KAAKM,EAAAxB,QAAKsI,QAAQ+lB,EAAOT,OAAO5B,MAAM6xB,UAAW,iBAGpEj9C,KAAK28C,IAAMA,EAGZ58C,SACC,MAAO,WAAkD,cAArCC,KAAKytB,OAAOT,OAAOW,OAAOuvB,OAAyB,YAAcl9C,KAAKytB,OAAOT,OAAOW,OAAOuvB,QAAU,IAAMl9C,KAAKytB,OAAOT,OAAOW,OAAOkW,KAGpJ9jC,gDACLC,KAAK2tB,OAAS3tB,KAAK28C,IAAIO,OAAOl9C,KAAKytB,OAAOT,OAAOW,OAAOkW,KAAM7jC,KAAKytB,OAAOT,OAAOW,OAAOuvB,QACxF38C,EAAI8Q,KAAK,aAAerR,KAAKm9C,YAGxBp9C,+CACL,OAAO,IAAI0H,QAAc,CAACC,EAASC,KAC7B3H,KAAK2tB,OACR3tB,KAAK2tB,OAAOI,MAAMrmB,GAGlBA,yBCnEL7M,EAAAD,QAAAmC,QAAA,6cCAA,MAAAu/C,EAAAn9C,EAAAzE,EAAA,KACA0iD,EAAA1iD,EAAA,KACA2iD,EAAA3iD,EAAA,IACA4iD,EAAAn+C,EAAAzE,EAAA,MACAkG,EAAAzB,EAAAzE,EAAA,IACA+b,EAAAtX,EAAAzE,EAAA,IACA6iD,EAAA7iD,EAAA,KAGA8iD,EAAAr+C,EAAAzE,EAAA,MACA+iD,EAAA/iD,EAAA,KACAgjD,EAAAv+C,EAAAzE,EAAA,KACAijD,EAAAx+C,EAAAzE,EAAA,MACAkjD,EAAAz+C,EAAAzE,EAAA,MACAmjD,EAAA1+C,EAAAzE,EAAA,MACAojD,EAAA3+C,EAAAzE,EAAA,MACAuP,EAAAvP,EAAA,GACAqjD,EAAArjD,EAAA,KACAsjD,EAAAtjD,EAAA,KACAujD,EAAAvjD,EAAA,KACAwjD,EAAAxjD,EAAA,IAEAshD,EAAAthD,EAAA,IAEMyjD,EAAqBzjD,EAAQ,KAG7B0jD,EAFY1jD,EAAQ,IAEL2jD,CAAU,CAC9BC,SAAU,KACV31C,IAAK,EACLtD,QAAS,yEAGJ9E,EAAMkW,EAAArX,QAAO,WAQnB,SAASm/C,EAAwBtyC,EAAkBuY,EAAuB+Q,GACzEooB,EAAAv+C,QAASo/C,aAAa,QAAS,CAAC32C,EAAK+B,EAAMyH,KAC1C,GAAIxJ,IAAQ+B,EACX,OAAO2rB,IAERtpB,EAAIwyC,MAAM70C,EAAOq1B,IAChB,GAAIA,EAEH,OADA1+B,EAAIiL,MAAMyzB,GACH1J,IAER,MAAMgK,EAAStzB,EAAIlE,KAAKw3B,QAAU,iBAClCtzB,EAAIszB,OAASA,EACb,MAAMuN,EAASmR,EAAAS,UAAUzyC,EAAIwhB,OAAOT,OAAOW,OAAOgxB,IAAI7R,QAChD8R,EAAwB,CAC7B/7C,GAAI+G,EAAK/G,GACTg8C,IAAK/R,EAAS,EAAIxkC,KAAKC,OAAOpI,KAAKygB,MAAQksB,GAAU,UAAQtoC,EAC7D+6B,UAEKgN,EAAQuR,EAAA1+C,QAAI0/C,KAAKF,EAAW3yC,EAAIwhB,OAAOT,OAAOW,OAAOgxB,IAAII,QACzDt4C,EAAsB,CAACoH,QAASmuC,EAAA/1B,eAAgB+4B,qBAAsB/yC,EAAIwhB,OAAOT,OAAOW,OAAOsxB,QAAQD,qBAAsBL,IAAKpS,EAAO3iC,KAAMs0C,EAAA92B,WAAWnb,EAAIrC,OACpKyzC,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAnBzBk3C,CAqBG1xC,EAAKuY,EAAK+Q,GAGd,SAAS2pB,EAAyBjzC,EAAkBuY,EAAuB+Q,GAC1EtpB,EAAIkzC,SACJ9B,EAAA94B,aAAa66B,GAAG56B,GAGjB,SAAe66B,EAAWz1C,EAAY+E,2CACrC,GAAIA,GAASA,EAAM5M,OAAS,EAC3B,IAAK,MAAMu9C,KAAQ3wC,EAClB,IAAK/E,EAAK+E,MAAM2wC,GACf,OAAO73C,QAAQE,OAAOsC,EAAApE,iBAM1BjL,EAAAkiD,cAAA,SAA8BrvB,GAC7B,MAAM0V,EAAM,IAAIoa,EAAAgC,cAAc9xB,GAExB+xB,EAAc/xB,EAAOT,OAAOO,YAAY,CAAC,QAAS,YAClDte,EAASquC,EAAAl+C,QAAO,CAACqgD,QAASD,OAE1BE,EAASpD,EAAAl9C,QAAQugD,SAMjB7S,EAASmR,EAAAS,UAAUjxB,EAAOT,OAAOW,OAAOsxB,QAAQW,OAAO9S,QAC7D4S,EAAOvyB,IAAIuwB,EAAAt+C,QAAQ,CAClB/D,KAAMoyB,EAAOT,OAAOW,OAAOsxB,QAAQW,OAAOvkD,KAC1C0jD,OAAQtxB,EAAOT,OAAOW,OAAOsxB,QAAQF,OACrC/4C,MAAO,IAAIy3C,EAAAoC,qBAAqBpyB,EAAOT,OAAOO,YAAY,CAAC,UAAW,mBACtEuyB,QAAQ,EACRC,mBAAmB,EACnBH,OAAQ,CACPI,OAAQvyB,EAAOT,OAAOW,OAAOsxB,QAAQW,OAAOI,OAC5ClT,OAAQA,EAAS,EAAIA,OAAStoC,MAGhCk7C,EAAOvyB,IAAIwwB,EAAAv+C,QAAS6gD,cACpBP,EAAOvyB,IAAIwwB,EAAAv+C,QAAS6/C,WACpBtB,EAAAv+C,QAAS8gD,cAAc,CAACt2C,EAAYd,KACnCA,EAAK,KAAMc,EAAK/G,MAEjB86C,EAAAv+C,QAAS+gD,gBAAgB,CAACt9C,EAAYiG,KACrC2kB,EAAOgE,YAAY2uB,QAAQv9C,GAAI+lB,KAAKhf,GAAQd,EAAK,KAAMc,IAAc,IAAQkf,MAAMhgB,KAGpF60C,EAAAv+C,QAAS+tB,IAAI,QAAS,IAAI0wB,EAAAz+C,QAAcihD,SACvC,CAACC,cAAe,WAAYC,cAAe,YAC3C,CAACryC,EAAUuX,EAAU3c,KACpB2kB,EAAOgE,YAAY+uB,KAAKtyC,EAAUuX,GAAUmD,KAAKhf,GAAQd,EAAK,KAAMc,IAAc,IAAQkf,MAAMhgB,MAGlG60C,EAAAv+C,QAAS+tB,IAAI,aAAc,IAAIywB,EAAAx+C,QAAYihD,SAC1C,CACCI,eAAgB7C,EAAAx+C,QAAYshD,WAAWC,8BACvCC,YAAanzB,EAAOT,OAAOW,OAAOgxB,IAAII,QAEvC,CAAC8B,EAAa/3C,KACb2kB,EAAOgE,YAAY2uB,QAAQS,EAAYh+C,IAAI+lB,KAAKhf,GAAQd,EAAK,KAAMc,IAAc,EAAOi3C,IAAc/3B,MAAMhgB,MAG9G60C,EAAAv+C,QAAS+tB,IAAI,gBAAiB,IAAIywB,EAAAx+C,QAAYihD,SAC7C,CACCI,eAAgB7C,EAAAx+C,QAAYshD,WAAWI,sBAAsB,UAC7DF,YAAanzB,EAAOT,OAAOW,OAAOgxB,IAAII,QAEvC,CAAC8B,EAAa/3C,KACb2kB,EAAOgE,YAAY2uB,QAAQS,EAAYh+C,IAAI+lB,KAAKhf,GAAQd,EAAK,KAAMc,IAAc,EAAOi3C,IAAc/3B,MAAMhgB,MAoC9G42C,EAAOvyB,IAAI,CAAClhB,EAAKuY,EAAK+Q,KACrBh1B,EAAI8Q,KAAKpF,EAAI80C,aACbxrB,MAGDmqB,EAAOvyB,IArBP,SAAiClhB,EAAkBuY,EAAuB+Q,GACzE,GAAItpB,EAAIrC,KACP,OAAO2rB,IAERooB,EAAAv+C,QAASo/C,aAAa,aAAc,CAACS,SAAS,GAAQ,CAACp3C,EAAK+B,EAAMyH,KACjE,GAAIxJ,EAEH,OADAtH,EAAIiL,MAAM3D,GACH0tB,IAERtpB,EAAI0yC,MAAQ/0C,EACZqC,EAAIszB,OAASluB,EAAKkuB,OAClBtzB,EAAIrC,KAAOA,EACX2rB,KARDooB,CASG1xC,EAAKuY,EAAK+Q,KASdmqB,EAAOvyB,IAtCP,SAAoClhB,EAAkBuY,EAAuB+Q,GAC5E,GAAItpB,EAAIrC,KACP,OAAO2rB,IAERooB,EAAAv+C,QAASo/C,aAAa,gBAAiB,CAACS,SAAS,GAAQ,CAACp3C,EAAK+B,EAAMyH,KACpE,GAAIxJ,EAEH,OADAtH,EAAIiL,MAAM3D,GACH0tB,IAERtpB,EAAI0yC,MAAQ/0C,EACZqC,EAAIszB,OAASluB,EAAKkuB,OAClBtzB,EAAIrC,KAAOA,EACX2rB,KARDooB,CASG1xC,EAAKuY,EAAK+Q,KA4BdmqB,EAAOvyB,IAAIqwB,EAAAp+C,QAAK,CACf4hD,mBAAmB,EACnBC,aAAa,EACbC,eAAgB,CAAC,eAAgB,iBACjCC,QAAQ,EACRC,QAAS,CAAC,MAAO,WAGlB,MAAMC,EAAqB,CAC1B1lD,IAAK,CAACN,EAAcimD,EAA2BC,EAAuB5yC,KACrE+wC,EAAO/jD,IAAIN,EAAM2iD,EAAAwD,SAASD,GAAgBlmD,GAAO,CAAO4Q,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnE,UACOq/C,EAAWpzC,EAAIrC,KAAM+E,SACrB2yC,EAAQr1C,EAAKuY,GAClB,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMgZ,EAAKvU,QAIjCggC,KAAM,CAAC50C,EAAcimD,EAA2BC,EAAuB5yC,KACtE+wC,EAAOzP,KAAK50C,EAAM2iD,EAAAwD,SAASD,GAAgBlmD,GAAO,CAAO4Q,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpE,UACOq/C,EAAWpzC,EAAIrC,KAAM+E,SACrB2yC,EAAQr1C,EAAKuY,GAClB,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMgZ,EAAKvU,QAIjChB,OAAQ,CAAC5T,EAAcyI,EAAew9C,EAA2BC,EAAuB5yC,KACvF+wC,EAAOzP,KAAK50C,EAAM4T,EAAOwyC,OAAO39C,GAAQk6C,EAAAwD,SAASD,GAAgBlmD,GAAO8iD,EAAoB,CAAOlyC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9G,UACOq/C,EAAWpzC,EAAIrC,KAAM+E,SACrB2yC,EAAQr1C,EAAKuY,GAClB,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMgZ,EAAKvU,SA2ClC,OArCA8tC,EAAA2D,kBAAkBL,EAAUle,GAC5Buc,EAAOzP,KAAK,SAAUmO,EAAcJ,EAAAwD,SAAS,UAAmCjD,GAuBhFmB,EAAOvyB,IAAIqwB,EAAAp+C,QArBiB,SAAS6M,EAAsB2Y,GAC1D,MAAM+8B,EAAUl0B,EAAOT,OAAOW,OAAOsxB,QAAQD,sBAAwB,GAkBrEp6B,EAAS,KAjBwB,CAChCo8B,mBAAmB,EACnBC,aAAa,EACbC,eAAgB,CAAC,eAAgB,iBACjCC,OAAQ,SAASA,EAAQ51C,IACS,IAA7Bo2C,EAAQ54C,QAAQo4C,IAAmBA,EAGnB,YAAfl1C,EAAIof,QAAwBpf,EAAI0yC,IACnCpzC,EAAG,MAAM,GAETA,EAAG,IAAInG,MAAM,wBALdmG,EAAG,MAAM,IASX61C,QAAS,CAAC,MAAO,aAMnB1B,EAAOzP,KAAK,UAAmCiP,GAC/CQ,EAAOvyB,IAAI,QAASmvB,EAAAl9C,QAAQ49C,OAAOp8C,EAAAxB,QAAKsI,QAAQ,sBAEhDg4C,EAAOvyB,IAA4BiwB,EAAAwE,qBAEnC7D,EAAA8D,yBAAyBR,EAAUle,GAEnCuc,EAAOvyB,IAAI,CAAClhB,EAAKuY,EAAK+Q,KACrB8nB,EAAA94B,aAAa/Y,MAAMgZ,EAAKva,EAAArE,cAAc,4BAGhC85C,kFCrPR9kD,EAAAgnD,oBAAA,SAAoC31C,EAAkBuY,EAAuB+Q,GAI5E,OAHKtpB,EAAIszB,QAAUtzB,EAAIgzC,SAAWhzC,EAAIgzC,QAAQ1f,SAC7CtzB,EAAIszB,OAAStzB,EAAIgzC,QAAQ1f,QAEtBtzB,EAAIrC,KACA2rB,IAED/Q,EAAIpX,OAAO,KAAK0X,KAAK,CAACtZ,MAAO,iCCpBrC3Q,EAAAD,QAAAmC,QAAA,wXCEA,MAAA+kD,EAAApnD,EAAA,KACAqnD,EAAArnD,EAAA,KACAsnD,EAAAtnD,EAAA,KACAunD,EAAAvnD,EAAA,KACAwnD,EAAAxnD,EAAA,KACAynD,EAAAznD,EAAA,KACA0nD,EAAA1nD,EAAA,KACA2nD,EAAA3nD,EAAA,KACA4nD,EAAA5nD,EAAA,KACA6nD,EAAA7nD,EAAA,KACA8nD,EAAA9nD,EAAA,KACA+nD,EAAA/nD,EAAA,KACAwjD,EAAAxjD,EAAA,IACAgoD,EAAAhoD,EAAA,KACAioD,EAAAjoD,EAAA,KACAkoD,EAAAloD,EAAA,KACAmoD,EAAAnoD,EAAA,KAEAooD,EAAApoD,EAAA,KACAqoD,EAAAroD,EAAA,KACAsoD,EAAAtoD,EAAA,KACAuoD,EAAAvoD,EAAA,KACAwoD,EAAAxoD,EAAA,KACAshD,EAAAthD,EAAA,IACAyoD,EAAAzoD,EAAA,KACA0oD,EAAA1oD,EAAA,KASAE,EAAA2kD,cAAA,MAyBCx/C,YAAoB0tB,GAAAztB,KAAAytB,SACnBztB,KAAKqjD,mBAAqB,IAAID,EAAAE,mBAAmBtjD,KAAKytB,OAAOU,iBAC7DnuB,KAAKujD,iBAAmB,IAAId,EAAAe,iBAAiBxjD,KAAKytB,OAAO6E,cAAetyB,KAAKytB,OAAO2E,kBAAmBpyB,KAAKytB,OAAOznB,OACnHhG,KAAKyjD,eAAiB,IAAIlB,EAAAmB,eAAe1jD,KAAKytB,OAAO4C,aACrDrwB,KAAK2jD,gBAAkB,IAAIjB,EAAAkB,gBAAgBn2B,EAAOqE,cAClD9xB,KAAK6jD,gBAAkB,IAAIV,EAAAW,gBAAgBr2B,EAAOuE,cAClDhyB,KAAK+jD,qBAAuB,IAAIpB,EAAAqB,qBAAqBv2B,EAAO2E,mBAC5DpyB,KAAKikD,gBAAkB,IAAIrB,EAAAsB,gBAAgBlkD,KAAKytB,OAAOznB,MAAOhG,KAAKytB,OAAOjjB,cAC1ExK,KAAKmkD,mBAAqB,IAAItB,EAAAuB,mBAAmBpkD,KAAKytB,OAAOznB,MAAOhG,KAAKytB,OAAOhjB,iBAChFzK,KAAKqkD,mBAAqB,IAAIvB,EAAAwB,mBAAmBtkD,KAAKytB,OAAOznB,MAAOhG,KAAKytB,OAAOpT,iBAChFra,KAAKukD,uBAAyB,IAAIxB,EAAAyB,uBAAuBxkD,KAAKytB,OAAOznB,OACrEhG,KAAKykD,gBAAkB,IAAIvB,EAAAwB,gBAAgB1kD,KAAKytB,OAAO+F,aACtDxzB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAK2kD,eAAiB,IAAItC,EAAAuC,eAAe5kD,KAAKytB,OAAO6F,YAAatzB,KAAKytB,OAAOY,UAC7EruB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAK6kD,gBAAkB,IAAI1C,EAAA2C,gBAAgB9kD,KAAKytB,OAAOqD,aAAc9wB,KAAKytB,OAAOmD,cAAe5wB,KAAKytB,OAAOtT,YAAana,KAAKytB,OAAOkF,gBAAiB3yB,KAAKytB,OAAO0F,gBAAiBnzB,KAAKujD,iBAAkBvjD,KAAKytB,OAAOY,UACrNruB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAK+kD,kBAAoB,IAAIjD,EAAAkD,kBAAkBhlD,KAAKytB,OAAOoF,eAAgB7yB,KAAKujD,iBAC/EvjD,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAKilD,kBAAoB,IAAIlD,EAAAmD,kBAAkBllD,KAAKytB,OAAOuF,eAAgBhzB,KAAK+kD,kBAC/E/kD,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAKmlD,gBAAkB,IAAInD,EAAAoD,gBAAgBplD,KAAKytB,OAAO8D,aAAcvxB,KAAK6kD,gBAAiB7kD,KAAKytB,OAAO0F,gBACtGnzB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAKqlD,iBAAmB,IAAIpD,EAAAqD,iBAAiBtlD,KAAKytB,OAAO4D,cAAerxB,KAAK6kD,gBAAiB7kD,KAAKmlD,gBAAiBnlD,KAAKytB,OAAO0F,gBAAiBnzB,KAAKytB,OAAOuD,aAC5JhxB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAKulD,iBAAmB,IAAInD,EAAAoD,iBAAiBxlD,KAAKytB,OAAOmD,cAAe5wB,KAAK6kD,gBAAiB7kD,KAAKytB,OAAO0F,gBAAiBnzB,KAAKytB,OAAOuD,aACtIhxB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAKylD,eAAiB,IAAInD,EAAAoD,eAAe1lD,KAAKytB,OAAOgE,YACpDzxB,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAK2lD,mBAAqB,IAAIzD,EAAA0D,mBAAmB5lD,KAAKytB,OAAO+E,gBAAiBxyB,KAAK6kD,gBAClF7kD,KAAKytB,OAAOpkB,aAAcrJ,KAAKytB,OAAOjjB,aAAcxK,KAAKytB,OAAOhjB,iBACjEzK,KAAK6lD,mBAAqB,IAAI7C,EAAA8C,mBAAmB9lD,KAAKytB,OAAOkF,gBAAiB3yB,KAAK6kD,iBACnF7kD,KAAK+lD,oBAAsB,IAAI9C,EAAA+C,oBAAoBhmD,KAAKytB,OAAOgF,iBAAkBzyB,KAAK6kD,iBACtF7kD,KAAKimD,mBAAqB,IAAIzD,EAAA0D,mBAAmBlmD,KAAKytB,OAAO0F,gBAAiBnzB,KAAK6kD,iBAG9E9kD,KAAKkM,2CACV,MAAO,CAAC4B,QAASmuC,EAAA/1B,kBAGZlmB,QAAQkM,2CACb,MAAO,CAAC4B,QAASmuC,EAAA/1B,eAAgB+4B,qBAAsBh/C,KAAKytB,OAAOT,OAAOW,OAAOsxB,QAAQD,qBAAsBp1C,KAAMqC,EAAIrC,KAAOs0C,EAAA72B,kBAAkBpb,EAAIrC,WAAQpF,qXCpGhK,MAAAtC,EAAAxH,EAAA,GAGAyrD,EAAAzrD,EAAA,IACA+Q,EAAA/Q,EAAA,GASA0rD,EAAA1rD,EAAA,IACAqS,EAAArS,EAAA,GAEAE,EAAAoqD,kBAAA,cAAuCoB,EAAA/7C,mBAEtCtK,YACS8yB,EACA0wB,EACEl6C,EACAmB,EACAC,GAEVlF,MAAMstB,EAAgBxpB,EAAcmB,EAAcC,GAN1CzK,KAAA6yB,iBACA7yB,KAAAujD,mBACEvjD,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,KACpB,IAAKD,EAAEgH,IACN,OAAQ,EAET,IAAK/G,EAAE+G,IACN,OAAO,EAER,QAAoBhM,IAAhBgF,EAAEgH,IAAI4B,YAAuC5N,IAAhBiF,EAAE+G,IAAI4B,MAAqB,CAC3D,MAAMoS,EAAMhb,EAAEgH,IAAI4B,MAAQ3I,EAAE+G,IAAI4B,MAChC,GAAY,IAARoS,EACH,OAAOA,EAGT,OAAOhb,EAAEsE,KAAOrE,EAAEqE,OAKf/N,QAAQwT,EAAkB3I,EAAyChB,2CACxE,MAAMnD,EAAS0/C,EAAAl9B,cAAc1V,EAAS3I,EACrC5K,KAAK6yB,eAAewzB,cAAc9yC,EAAQ1Q,IAAMX,EAAA/D,cAAcmoD,YAAc/yC,EAAQnG,QAErF,GAAIxC,EAAS27C,WAAY,CACxB,MAAMrgD,QAAclG,KAAKqJ,aAAa+C,aAAamH,EAAQ1Q,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAayW,SACrF9M,EAAOP,MAAQuF,EAAAxF,YAAYC,GAE5B,OAAOO,IAGF1G,eAAeqD,EAAoCwG,2CACxD,MAAO,CACNxG,MAAOA,EAAMA,MACb/H,KAAM+H,EAAM/H,KACZ+Y,UAAWhR,EAAMgR,UACjBhH,OAAQhK,EAAMgK,OACdlI,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,SAASkM,2CACd,MAAMsH,QAAgBvT,KAAK8L,KAAKG,EAAI7I,MAAMP,IACrC0Q,EAAQhD,MACZvQ,KAAK6yB,eAAeulB,gBAAgB7kC,KAIhCxT,OAAOkM,2CACZ,MAAMsH,QAAgBvT,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC1C,aAAa7C,KAAKujD,iBAAiBmD,cAAcnzC,EAAStH,EAAI7I,MAAM1D,OAAQuM,EAAI7I,MAAMgL,WAAYnC,EAAIrC,QAGjG7J,OAAOkM,2CACZ,MAAMsH,QAAgBvT,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC1C,MAAO,CACNuK,OAAQpN,KAAK6yB,eAAewzB,cAAc9yC,EAAQ1Q,IAAMX,EAAA/D,cAAcmoD,YAAc/yC,EAAQnG,UAIxFrN,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,wXC1F3D,MAAA1H,EAAAxH,EAAA,GAGAksD,EAAAlsD,EAAA,KAEA+Q,EAAA/Q,EAAA,GAOA0rD,EAAA1rD,EAAA,IACAqS,EAAArS,EAAA,GAEAE,EAAAsqD,kBAAA,cAAuCkB,EAAA/7C,mBAEtCtK,YACSizB,EACA+xB,EACE17C,EACAmB,EACAC,GAEVlF,MAAMytB,EAAgB3pB,EAAcmB,EAAcC,GAN1CzK,KAAAgzB,iBACAhzB,KAAA+kD,oBACE/kD,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,KAAOD,EAAEgH,KAAOhH,EAAEgH,IAAIC,MAAQjH,EAAEgH,IAAIC,MAAQjH,EAAEtC,KAAK0V,cAAenT,EAAE+G,KAAO/G,EAAE+G,IAAIC,MAAQhH,EAAE+G,IAAIC,MAAQhH,EAAEvC,MAG1HnH,QAAQuP,EAAkB1E,EAAyChB,2CACxE,MAAMnD,EAASmgD,EAAAC,cAAcv3C,EAAStP,KAAKgzB,eAAeqzB,cAAc/2C,EAAQzM,IAAMX,EAAA/D,cAAcmoD,YAAch3C,EAAQlC,QAC1H,GAAIxC,EAASk8C,aAAc,CAC1B,MAAM5gD,QAAclG,KAAKqJ,aAAa+C,aAAakD,EAAQzM,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAawS,SACrF7I,EAAOP,MAAQuF,EAAAxF,YAAYC,GAK5B,OAHI0E,EAASm8C,kBACZtgD,EAAOwnC,eAAiBjuC,KAAK+kD,kBAAkBiC,eAAe,CAAC5yC,UAAW9E,EAAQzM,IAAK+H,EAAUhB,IAE3FnD,IAGF1G,eAAeqD,EAAoCwG,2CACxD,MAAO,CACNxG,MAAOA,EAAMA,MACb8D,IAAK9D,EAAM8D,IACXuJ,MAAOrN,EAAMqN,MACbrD,OAAQhK,EAAMgK,OACdlI,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,OAAOkM,2CACZ,OAAOjM,KAAK+kD,kBAAkBiC,eAAe,CAACC,WAAYh7C,EAAI7I,MAAMJ,KAAMiJ,EAAI7I,MAAO6I,EAAIrC,QAGpF7J,WAAWkM,2CAChBjM,KAAKgzB,eAAek0B,oBAGfnnD,QAAQkM,2CACb,MAAMqD,QAAgBtP,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC1C7C,KAAKgzB,eAAe1E,QAAQhf,KAGvBvP,OAAOkM,2CACZ,MAAMqD,QAAgBtP,KAAKgzB,eAAe52B,OAAO6P,EAAI7I,MAAM8D,KAC3D,OAAOlH,KAAK4L,QAAQ0D,EAAS,GAAIrD,EAAIrC,QAGhC7J,OAAOkM,2CACZ,MAAMqD,QAAgBtP,KAAK8L,KAAKG,EAAI7I,MAAMP,UACpC7C,KAAKgzB,eAAe7xB,OAAOmO,KAG5BvP,OAAOkM,2CACZ,MAAMqD,QAAgBtP,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC1C,MAAO,CACN+qC,UAAWt+B,EAAQs+B,UACnBxgC,OAAgCpN,KAAKgzB,eAAeqzB,cAAc/2C,EAAQzM,IAAMX,EAAA/D,cAAc+D,EAAA/D,cAAcmoD,aAAepkD,EAAA/D,cAAcmR,EAAQlC,WAI7IrN,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,yFCrF3DhP,EAAAisD,cAAA,SAA8Bv3C,EAAkBlC,GAC/C,MAAO,CACNvK,GAAIyM,EAAQzM,GACZqE,IAAKoI,EAAQpI,IACbgK,QAAS5B,EAAQ4B,QACjB08B,UAAWt+B,EAAQs+B,UAAY,EAAIt+B,EAAQs+B,eAAYppC,EACvD4I,OAA+BA,EAC/B2G,aAAczE,EAAQyE,aACtB1Y,KAAMiU,EAAQkB,IAAMlB,EAAQkB,IAAIC,MAAQnB,EAAQpI,IAChD8M,YAAa1E,EAAQkB,IAAMlB,EAAQkB,IAAIwD,iBAAcxP,kXCXvD,MAAAuI,EAAArS,EAAA,GACAyP,EAAAzP,EAAA,IAEA0rD,EAAA1rD,EAAA,IAEAysD,EAAAzsD,EAAA,KAWAE,EAAAwqD,gBAAA,cAAqCgB,EAAA/7C,mBAEpCtK,YACSwxB,EACAszB,EACA1xB,EACE9pB,EACAmB,EACAC,GAEVlF,MAAMgsB,EAAcloB,EAAcmB,EAAcC,GAPxCzK,KAAAuxB,eACAvxB,KAAA6kD,kBACA7kD,KAAAmzB,kBACEnzB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAGpD0E,gBAAgByJ,EAAUC,GACzB,IAAI+a,GAAO/a,EAAE+G,IAAIuC,MAAQ,IAAMvJ,EAAEgH,IAAIuC,MAAQ,GAI7C,OAHY,IAARyR,IACHA,GAAO/a,EAAE+G,IAAI4B,OAAS,IAAM5I,EAAEgH,IAAI4B,OAAS,IAErCoS,EAGFzkB,QAAQvB,EAAcoM,EAAuChB,2CAClE,MAAMnD,EAAS0gD,EAAAC,YAAY5oD,EAAOoM,GAUlC,OATIA,EAASy8C,aACZ5gD,EAAOP,YAAclG,KAAKqJ,aAAa+C,aAAa5N,EAAMqE,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAa0B,QAEjFoM,EAAS08C,YACZ7gD,EAAO4K,WAAarR,KAAKmzB,gBAAgBo0B,aAAa/oD,IAEnDoM,EAAS48C,cACZ/gD,EAAOuO,aAAehV,KAAK6kD,gBAAgBz5C,iBAAiB5M,EAAMsS,SAAUlG,EAAUhB,EAAM5J,KAAKynD,kBAE3FhhD,IAGF1G,eAAeqD,EAAkCwG,2CACtD,MAAO,CACNxG,MAAOA,EAAMA,MACb/H,KAAM+H,EAAM/H,KACZkiB,OAAQna,EAAMma,OACdjf,OAAQ8E,EAAM9E,OACdqS,SAAUvN,EAAMuN,SAChB0S,QAASjgB,EAAMigB,QACftI,UAAW3X,EAAM2X,UACjBhD,WAAY3U,EAAM2U,WAClBS,UAAWpV,EAAMoV,UACjBmI,WAAYvd,EAAMud,WAClB1P,MAAO7N,EAAM6N,MACby2C,UAAWtkD,EAAMskD,UACjBC,SAAUvkD,EAAMukD,SAChBC,OAAQxkD,EAAMwkD,OACd1iD,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,cAAckM,2CACnB,MAAMzN,QAAcwB,KAAK8L,KAAKG,EAAI7I,MAAMP,IAClCmS,QAAehV,KAAKmzB,gBAAgB00B,sBAAsBrpD,GAChE,OAAOwB,KAAK6kD,gBAAgBh5C,YAAY1B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAM6B,OAAQgH,EAAI7I,MAAM8B,QAAS+G,EAAI7I,MAAO6I,EAAIrC,QAGxG7J,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,QAGpD7J,OAAOkM,2CACZ,MAAM8P,QAAe/b,KAAKmM,MAAMF,EAAI7I,MAAMJ,KAC1C,IAAI8N,EAA0B,GAI9B,OAHAiL,EAAOlX,QAAQrG,IACdsS,EAAWA,EAASzQ,OAAO7B,EAAMsS,YAE3B9Q,KAAK6kD,gBAAgBz5C,iBAAiB0F,EAAU7E,EAAI7I,MAAO6I,EAAIrC,KAAM5J,KAAKynD,mBAG5E1nD,KAAKkM,2CACV,MAAMzN,QAAcwB,KAAK8L,KAAKG,EAAI7I,MAAMP,IACxC,MAAO,CAACwO,WAAYrR,KAAKmzB,gBAAgBo0B,aAAa/oD,uFChGxD5D,EAAAwsD,YAAA,SAA4B5oD,EAAcoM,GACzC,IAAIub,EAAW,CACdxV,SAAUnS,EAAMuZ,WAChB9E,QAASzU,EAAMuc,WAKhB,OAHKvf,OAAOmJ,KAAKwhB,GAAKxJ,KAAKtgB,KAAS8pB,EAAI9pB,MACvC8pB,OAAM3hB,GAEA,CACN3B,GAAIrE,EAAMqE,GACVxH,KAAMmD,EAAMnD,KACZmd,UAAWha,EAAMga,UACjBtH,QAAS1S,EAAM0S,QACf5S,OAAQE,EAAMF,OACdqS,SAAUnS,EAAMmS,SAChBoF,WAAYvX,EAAMsS,SAAS/O,OAC3ByO,IAAK,CACJS,MAAOzS,EAAMyS,MACbD,KAAMxS,EAAMwS,KACZD,SAAUvS,EAAMuS,SAChBG,QAAS1S,EAAM0S,QACf2V,YAAaV,GAEdrV,SAAUlG,EAASk9C,cAAgBtpD,EAAMsS,cAAWtM,kXCzBtD,MAAAuI,EAAArS,EAAA,GACAyP,EAAAzP,EAAA,IAEA0rD,EAAA1rD,EAAA,IAGAqtD,EAAArtD,EAAA,KACA+Q,EAAA/Q,EAAA,GACAstD,EAAAttD,EAAA,IAaAE,EAAA0qD,iBAAA,cAAsCc,EAAA/7C,mBAErCtK,YACSsxB,EACAwzB,EACAM,EACAhyB,EACAnC,EACE3nB,EACAmB,EACAC,GAEVlF,MAAM8rB,EAAehoB,EAAcmB,EAAcC,GATzCzK,KAAAqxB,gBACArxB,KAAA6kD,kBACA7kD,KAAAmlD,kBACAnlD,KAAAmzB,kBACAnzB,KAAAgxB,eACEhxB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAGpD0E,iBAAiByJ,EAAUC,GAC1B,IAAI+a,EAAMhb,EAAEgP,UAAUoE,cAAcnT,EAAE+O,WAItC,OAHY,IAARgM,IACHA,GAAO/a,EAAEuH,MAAQ,IAAMxH,EAAEwH,MAAQ,IAE3BwT,EAGRzkB,iBAAiByJ,EAAUC,GAC1B,IAAI+a,EAAMhb,EAAE6G,SAASuM,cAAcnT,EAAE4G,UAOrC,OANY,IAARmU,IACHA,GAAO/a,EAAE+G,IAAIuC,MAAQ,IAAMvJ,EAAEgH,IAAIuC,MAAQ,IAE9B,IAARyR,IACHA,GAAO/a,EAAE+G,IAAI4B,OAAS,IAAM5I,EAAEgH,IAAI4B,OAAS,IAErCoS,EAGFzkB,QAAQzB,EAAgBsM,EAAwChB,2CACrE,MAAMnD,EAASshD,EAAAE,aAAa3pD,EAAQsM,GACpC,GAAIA,EAASs9C,YAAa,CACzB,MAAMhiD,QAAclG,KAAKqJ,aAAa+C,aAAa9N,EAAOuE,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAawB,QACpFmI,EAAOP,MAAQuF,EAAAxF,YAAYC,GAc5B,OAZI0E,EAASu9C,aACZ1hD,EAAO4K,WAAarR,KAAKmzB,gBAAgBi1B,cAAc9pD,IAEpDsM,EAASy9C,gBACZ5hD,EAAOuL,cAAgBhS,KAAK6L,kBAAkB7L,KAAKmzB,gBAAgBm1B,kBAAkBhqD,GAAS,GAAIsL,IAE/FgB,EAAS29C,eACZ9hD,EAAOuO,aAAehV,KAAK6kD,gBAAgBz5C,iBAAiB9M,EAAOwS,SAAUlG,EAAUhB,EAAM5J,KAAKwoD,mBAE/F59C,EAAS69C,eACZhiD,EAAOsV,aAAe/b,KAAKmlD,gBAAgB/5C,iBAAiB9M,EAAO8S,SAAUxG,EAAUhB,EAAM5J,KAAK0oD,mBAE5FjiD,IAGF1G,eAAeqD,EAAmCwG,2CACvD,MAAO,CACNxG,MAAOA,EAAMA,MACb/H,KAAM+H,EAAM/H,KACZkiB,OAAQna,EAAMma,OACdtK,QAAS7P,EAAM6P,QACf8E,WAAY3U,EAAM2U,WAElB2vC,UAAWtkD,EAAMskD,UAGjBxiD,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,QAAQkM,2CACb,MAAM3N,QAAe0B,KAAK8L,KAAKG,EAAI7I,MAAMP,IACnCuF,QAAapI,KAAKmzB,gBAAgBm1B,kBAAkBhqD,GAC1D,OAAO0B,KAAK6L,YAAYzD,EAAM6D,EAAI7I,MAAO6I,EAAIrC,QAGxC7J,cAAckM,2CACnB,MAAM3N,QAAe0B,KAAK8L,KAAKG,EAAI7I,MAAMP,IACnCmS,QAAehV,KAAKmzB,gBAAgBw1B,uBAAuBrqD,GACjE,OAAO0B,KAAK6kD,gBAAgBh5C,YAAY1B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAM6B,OAAQgH,EAAI7I,MAAM8B,QAAS+G,EAAI7I,MAAO6I,EAAIrC,QAGxG7J,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,QAGpD7J,MAAMkM,2CACX,MAAMs7B,QAAoBvnC,KAAKgxB,aAAa43B,iBAC5C,OAAOZ,EAAA5+B,kBAAkBppB,KAAKgxB,aAAa63B,kBAAkB58C,EAAI7I,MAAMma,OAAQgqB,MAG1ExnC,OAAOkM,2CACZ,MAAM4P,QAAgB7b,KAAKmM,MAAMF,EAAI7I,MAAMJ,KAC3C,IAAI8N,EAA0B,GAI9B,OAHA+K,EAAQhX,QAAQvG,IACfwS,EAAWA,EAASzQ,OAAO/B,EAAOwS,YAE5B9Q,KAAK6kD,gBAAgBz5C,iBAAiB0F,EAAU7E,EAAI7I,MAAO6I,EAAIrC,KAAM5J,KAAKwoD,oBAG5EzoD,KAAKkM,2CACV,MAAM3N,QAAe0B,KAAK8L,KAAKG,EAAI7I,MAAMP,IACzC,MAAO,CAACwO,WAAYrR,KAAKmzB,gBAAgBi1B,cAAc9pD,uFC/HzD1D,EAAAqtD,aAAA,SAA6B3pD,EAAgBsM,GAC5C,IAAIub,EAAW,CACdxV,SAAUrS,EAAOyZ,YAKlB,OAHKvc,OAAOmJ,KAAKwhB,GAAKxJ,KAAKtgB,KAAS8pB,EAAI9pB,MACvC8pB,OAAM3hB,GAEA,CACN3B,GAAIvE,EAAOuE,GACXxH,KAAMiD,EAAOjD,KACb8V,WAAY7S,EAAO8S,SAASrP,OAC5B4e,WAAYriB,EAAOqiB,WACnBvP,SAAUxG,EAASk+C,eAAiBxqD,EAAO8S,cAAW5M,EACtDsM,SAAUlG,EAASm+C,gBAAkBzqD,EAAOwS,cAAWtM,EACvDuR,WAAYzX,EAAOwS,SAAS/O,OAC5BmP,QAAS5S,EAAO4S,QAChB2V,YAAaV,kXCpBf,MAAA/b,EAAA1P,EAAA,IAGAqS,EAAArS,EAAA,GACAuP,EAAAvP,EAAA,GAGA+Q,EAAA/Q,EAAA,GACAsuD,EAAAtuD,EAAA,KASAE,EAAAgrD,mBAAA,cAAwCx7C,EAAAE,eAEvCvK,YACSyyB,EACAqyB,EACEx7C,EACAmB,EACAC,GAEVlF,MAAMitB,EAAiBnpB,EAAcmB,EAAcC,GAN3CzK,KAAAwyB,kBACAxyB,KAAA6kD,kBACE7kD,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAOX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAG9C0E,QAAQyU,EAAoB5J,EAA0ChB,2CAC3E,MAAMnD,EAASuiD,EAAAC,eAAez0C,EAAU5J,GACxC,GAAIA,EAASs+C,cAAe,CAC3B,MAAMhjD,QAAclG,KAAKqJ,aAAa+C,aAAaoI,EAAS3R,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAawB,QACtFmI,EAAOP,MAAQuF,EAAAxF,YAAYC,GAK5B,OAHI0E,EAASu+C,iBACZ1iD,EAAOuO,aAAehV,KAAK6kD,gBAAgBz5C,iBAAiBoJ,EAAS1D,SAAUlG,EAAUhB,IAEnFnD,IAGF1G,eAAeqD,EAAqCwG,2CACzD,MAAO,CACNxG,MAAOA,EAAMA,MACb/H,KAAM+H,EAAM/H,KACZ0Z,OAAQnL,EAAK/G,GACb8R,SAAUvR,EAAMuR,SAChBzP,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,OAAOkM,2CACZ,MAAMuI,QAAiBxU,KAAKwyB,gBAAgBp2B,OAAO6P,EAAI7I,MAAM/H,KAAM4Q,EAAI7I,MAAMqR,aAAgCjQ,IAAvByH,EAAI7I,MAAMuR,UAAiC1I,EAAI7I,MAAMuR,SAAU1I,EAAIrC,KAAK/G,GAAIoJ,EAAI7I,MAAM0N,UAAY,IACxL,OAAO9Q,KAAK4L,QAAQ4I,EAAU,CAAC40C,mBAAmB,EAAMF,eAAe,GAAOj9C,EAAIrC,QAG7E7J,OAAOkM,2CACZ,MAAMuI,QAAiBxU,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC3C,GAAI2R,EAASO,SAAW9I,EAAIrC,KAAK/G,GAChC,OAAO4E,QAAQE,OAAOsC,EAAApE,eAEvB2O,EAASnZ,KAAO4Q,EAAI7I,MAAM/H,MAAQmZ,EAASnZ,KAC3CmZ,EAASC,QAAUxI,EAAI7I,MAAMqR,SAAWD,EAASC,QACjDD,EAASG,cAAkCnQ,IAAvByH,EAAI7I,MAAMuR,SAAyBH,EAASG,SAAW1I,EAAI7I,MAAMuR,SACrFH,EAASI,QAAUzU,KAAKygB,MACxBpM,EAAS1D,SAAW7E,EAAI7I,MAAM0N,UAAY,SACpC9Q,KAAKwyB,gBAAgB3M,OAAOrR,KAG7BzU,OAAOkM,2CACZ,IAAI0W,QAAkB3iB,KAAKmM,MAAMF,EAAI7I,MAAMJ,KAC3C2f,EAAYA,EAAUvL,OAAO5C,GAAYA,EAASO,SAAW9I,EAAIrC,KAAK/G,IACtE,IAAIiO,EAA0B,GAI9B,OAHA6R,EAAU9d,QAAQ2P,IACjB1D,EAAWA,EAASzQ,OAAOmU,EAAS1D,YAE9B9Q,KAAK6kD,gBAAgBz5C,iBAAiB0F,EAAU7E,EAAI7I,MAAO6I,EAAIrC,QAGjE7J,OAAOkM,2CACZ,MAAMuI,QAAiBxU,KAAK8L,KAAKG,EAAI7I,MAAMP,IAC3C,GAAI2R,EAASO,SAAW9I,EAAIrC,KAAK/G,GAChC,OAAO4E,QAAQE,OAAOsC,EAAApE,qBAEjB7F,KAAKwyB,gBAAgBrxB,OAAOqT,sFCxFpC5Z,EAAAquD,eAAA,SAA+Bz0C,EAAoB5J,GAClD,MAAO,CACN/H,GAAI2R,EAAS3R,GACbxH,KAAMmZ,EAASnZ,KACf0Z,OAAQP,EAASO,OACjBN,QAASD,EAASC,QAClBE,SAAUH,EAASG,SACnB5D,SAAUyD,EAASzD,SACnBG,QAASsD,EAAStD,QAClB0D,QAASJ,EAASI,QAClBmB,WAAYvB,EAAS1D,SAAS/O,OAC9B+O,SAAUlG,EAASw+C,kBAAoB50C,EAAS1D,cAAWtM,kcCb7D,MAAAuI,EAAArS,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IAEAyP,EAAAzP,EAAA,IAEA0rD,EAAA1rD,EAAA,IACAsuB,EAAAtuB,EAAA,IAKA+Q,EAAA/Q,EAAA,GAUAwH,EAAAxH,EAAA,GAGAE,EAAAkqD,gBAAA,cAAqCsB,EAAA/7C,mBAEpCtK,YACS+wB,EACAF,EACAzW,EACAwY,EACA02B,EACA9F,EACAl1B,EACEhlB,EACAmB,EACAC,GAEVlF,MAAMurB,EAAcznB,EAAcmB,EAAcC,GAXxCzK,KAAA8wB,eACA9wB,KAAA4wB,gBACA5wB,KAAAma,cACAna,KAAA2yB,kBACA3yB,KAAAqpD,cACArpD,KAAAujD,mBACAvjD,KAAAquB,YACEruB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAYiV,GACX,OAAOA,EAAOlQ,KAAK,CAAC0E,EAAGC,KACrB,QAAoBjF,IAAhBgF,EAAEgH,IAAI4B,YAAuC5N,IAAhBiF,EAAE+G,IAAI4B,MAAqB,CAC3D,MAAMoS,EAAMhb,EAAEgH,IAAI4B,MAAQ3I,EAAE+G,IAAI4B,MAChC,GAAY,IAARoS,EACH,OAAOA,EAGT,OAAOhb,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,QAK3B0E,QAAQqS,EAAcxH,EAAuChB,2CAClE,MAAMnD,EAASuiB,EAAAlC,YAAY1U,EAAOxH,GAIlC,GAHIA,EAAS0+C,WACZ7iD,EAAO8iD,aAAevpD,KAAKwpD,OAAOp3C,IAE/BxH,EAAS27C,WAAY,CACxB,MAAMrgD,QAAclG,KAAKqJ,aAAa+C,aAAagG,EAAMvP,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAasV,OACnF3L,EAAOP,MAAQuF,EAAAxF,YAAYC,GAE5B,OAAOO,IAGF1G,eAAeqD,EAAkCwG,2CACtD,IAAIuT,EACJ,GAAI/Z,EAAMqmD,UAAW,CACpB,MAAMl7C,QAAevO,KAAK4wB,cAAc7T,YAAYha,KAAKK,EAAMqmD,WAC3Dl7C,IACH4O,EAAS5O,EAAOgC,MAGlB,MAAO,CACNnN,MAAOA,EAAMA,MACbma,OAAQna,EAAMma,OACdlN,SAAUjN,EAAMiN,SAChBq5C,UAAWtmD,EAAMsmD,UACjBvsC,SACA7e,OAAQ8E,EAAM9E,OACdmS,MAAOrN,EAAMqN,MACbjS,MAAO4E,EAAM5E,MACbyS,MAAO7N,EAAM6N,MACby2C,UAAWtkD,EAAMskD,UACjBC,SAAUvkD,EAAMukD,SAChBC,OAAQxkD,EAAMwkD,OACd1iD,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAMtFzE,OAAOqS,2CACZ,GAAIA,EAAMI,MAAM9S,SAAWwC,EAAArE,gBAAgBT,IAC1C,IACC,aAAa4C,KAAKma,YAAYwvC,UAAU/oD,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,OACnE,MAAO4U,GACR,MAAMisB,EAAkC,GAmBxC,OAlBI9pB,EAAM5B,IAAIhS,QACb09B,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAIhS,SAEhC4T,EAAM5B,IAAIlS,SACb49B,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAIlS,UAEhC8T,EAAM5B,IAAIC,QACbyrB,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAIC,SAEhC2B,EAAM5B,IAAIQ,OACbkrB,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAIQ,KAAKvQ,cAErC2R,EAAM5B,IAAI4B,QACb8pB,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAI4B,MAAM3R,cAEtC2R,EAAM5B,IAAIS,QACbirB,EAAa,KAAI,CAAC,CAAC9W,KAAMhT,EAAM5B,IAAIS,SAE7B,CAACpD,QAAS,EAAGquB,aAKjBn8B,OAAOkM,2CACZ,MAAMmG,QAAcpS,KAAK8L,KAAKG,EAAI7I,MAAMP,IAClC4D,QAAezG,KAAKwpD,OAAOp3C,GACjC,OAAK3L,GACGgB,QAAQE,OAAOvC,MAAM,qBAKxBrF,QAAQkM,2CACb,IAAI+I,QAAehV,KAAKmM,MAAMF,EAAI7I,MAAMJ,KACxCgS,EAAShV,KAAKgM,YAAYgJ,GAC1B,MAAMvO,EAAsB,GAC5B,IAAK,MAAM2L,KAAS4C,EAAQ,CAC3B,MAAMxE,QAAYxQ,KAAKwpD,OAAOp3C,GAC1B5B,IACH/J,EAAO2L,EAAMvP,IAAM2N,GAGrB,OAAO/J,IAGF1G,aAAakM,2CAClB,MAAMmG,QAAcpS,KAAK8L,KAAKG,EAAI7I,MAAMP,UAClC7C,KAAKma,YAAYyvC,UAAUhpD,EAAAxB,QAAKkB,KAAK8R,EAAM7B,KAAM6B,EAAM/W,MAAO4Q,EAAI7I,MAAMoN,KAC9ExQ,KAAKquB,UAAUw7B,aAAaz3C,KAiBvBrS,OAAOkM,2CACZ,MAAMmG,QAAcpS,KAAK8L,KAAKG,EAAI7I,MAAMP,IACxC,aAAa7C,KAAKujD,iBAAiBuG,YAAY13C,EAAOnG,EAAI7I,MAAM1D,OAAQuM,EAAI7I,MAAMgL,WAAYnC,EAAIrC,QAG7F7J,QAAQkM,2CACb,MAAMmG,QAAcpS,KAAK8L,KAAKG,EAAI7I,MAAMP,IAClCmS,QAAehV,KAAKqpD,YAAYU,sBAAsB33C,GAC5D,OAAOpS,KAAK6L,YAAY1B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAM6B,OAAQgH,EAAI7I,MAAM8B,QAAS+G,EAAI7I,MAAO6I,EAAIrC,QAGxF7J,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,QAGpD7J,WAAWkM,2CAChB,MAAMmG,QAAcpS,KAAK8L,KAAKG,EAAI7I,MAAMP,UAClC7C,KAAK8wB,aAAak5B,YAAY53C,EAAOnG,EAAI7I,MAAM/H,wcCxLvD,MAAA6G,EAAAxH,EAAA,GACAuP,EAAAvP,EAAA,GACAyP,EAAAzP,EAAA,IAEA0rD,EAAA1rD,EAAA,IAEAuvD,EAAAvvD,EAAA,KACA+Q,EAAA/Q,EAAA,GACAstD,EAAAttD,EAAA,IAUAkG,EAAAzB,EAAAzE,EAAA,IAIAwvD,EAAAxvD,EAAA,KACAqS,EAAArS,EAAA,GAEAE,EAAA4qD,iBAAA,cAAsCY,EAAA/7C,mBAGrCtK,YACW6wB,EACFi0B,EACAsF,EACAn5B,EACE3nB,EACAmB,EACAC,GAEVlF,MAAMqrB,EAAevnB,EAAcmB,EAAcC,GARvCzK,KAAA4wB,gBACF5wB,KAAA6kD,kBACA7kD,KAAAmqD,kBACAnqD,KAAAgxB,eACEhxB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBATXzK,KAAAoqD,QAAU,IAAIF,EAAAG,mBAcdtqD,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,KAAOD,EAAEgH,KAAOhH,EAAEgH,IAAIC,MAAQjH,EAAEgH,IAAIC,MAAQ7P,EAAAxB,QAAKkR,SAAS9G,EAAE+G,OAAOqM,cAAenT,EAAE+G,KAAO/G,EAAE+G,IAAIC,MAAQhH,EAAE+G,IAAIC,MAAQ7P,EAAAxB,QAAKkR,SAAS7G,EAAE8G,QAGxJxQ,QAAQwO,EAAgB3D,EAAgDhB,2CAC7E,MAAMnD,EAASwjD,EAAAK,aAAa/7C,EAAQ3D,GAIpC,IAHIA,EAAS2/C,gBAAkB3/C,EAAS4/C,gBACvC/jD,EAAOuO,aAAehV,KAAK6kD,gBAAgBmC,eAAe,CAAC32C,SAAU9B,EAAO1L,IAAK+H,EAAUhB,IAExFgB,EAAS2/C,gBAAkB3/C,EAAS6/C,iBAAkB,CACzD,MAAMhtC,QAAgBzd,KAAK4wB,cAAc7T,YAAYhR,OAAO,CAACsE,SAAU9B,EAAO1L,GAAI+B,MAAO,CAAC,CAACd,MAAO,OAAQiB,YAAY,MAEtH0B,EAAOgX,cAAgBzd,KAAK6L,YAAY4R,EACvC,CAACitC,YAAa9/C,EAAS8/C,YAAaC,aAAc//C,EAAS+/C,aAAcC,aAAchgD,EAASggD,aAAcC,UAAWjgD,EAASigD,WAChIjhD,GAEJ,GAAIgB,EAAS8/C,YAAa,CACzB,MAAMxkD,QAAclG,KAAKqJ,aAAa+C,aAAamC,EAAO1L,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAayR,QACpF9H,EAAOP,MAAQuF,EAAAxF,YAAYC,GAoB5B,GAlBI0E,EAASkgD,aACRv8C,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,OAClCmI,EAAO4K,WAAarR,KAAKmqD,gBAAgBY,oBAAoBx8C,GACnDrM,EAAAtD,iBAAiBmK,QAAQwF,EAAOiC,IAAIpO,OAAS,IACvDqE,EAAO4K,WAAarR,KAAKmqD,gBAAgBa,mBAAmBz8C,KAG1D3D,EAASqgD,eACR18C,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,SAElCmI,EAAOuL,cAAgBhS,KAAK6L,kBAAkB7L,KAAKmqD,gBAAgBe,wBAAwB38C,GAC1F,CAACm8C,YAAa9/C,EAAS8/C,YAAaE,aAAchgD,EAASggD,aAAcC,UAAWjgD,EAASigD,WAC3FjhD,IAGDgB,EAAS+/C,eACZlkD,EAAO0kD,aAAenrD,KAAKoqD,QAAQ77B,IAAIhgB,IAEpC3D,EAASwgD,cAAe,CAC3B,MAAMC,QAAgBrrD,KAAK4wB,cAAc2qB,kBAAkBhtC,EAAO8B,UAClE5J,EAAO4kD,QAAUA,EAAQ/+C,IAAI8D,IACrB,CACNvN,GAAIuN,EAAOvN,GACXxH,KAAMuF,EAAAxB,QAAKkR,SAASF,EAAOG,SAI9B,OAAO9J,IAGF1G,eAAeqD,EAAmCwG,2CACvD,IAAIuT,EACJ,GAAI/Z,EAAMqmD,UAAW,CACpB,MAAMl7C,QAAevO,KAAK4wB,cAAc7T,YAAYha,KAAKK,EAAMqmD,WAC3Dl7C,IACH4O,EAAS5O,EAAOgC,MAGlB,MAAO,CACNnN,MAAOA,EAAMA,MACbP,GAAIO,EAAMP,GACV0a,OAAQna,EAAMma,OACdlN,SAAUjN,EAAMiN,SAChB8M,SACA7e,OAAQ8E,EAAM9E,OACdmS,MAAOrN,EAAMqN,MACbjS,MAAO4E,EAAM5E,MACbyS,MAAO7N,EAAM6N,MACb3R,MAAO8D,EAAM9D,MACbooD,UAAWtkD,EAAMskD,UACjBC,SAAUvkD,EAAMukD,SAChBC,OAAQxkD,EAAMwkD,OACd1iD,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdoa,MAAOjc,EAAMhB,KAAO,CAACgB,EAAMhB,WAAQoC,EACnCI,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAMtFzE,WAAWkM,2CAChB,MAAM7D,QAAapI,KAAK4wB,cAAc7T,YAAYhR,OAAO,CAACsE,SAAUpE,EAAI7I,MAAMP,KAC9E,OAAO7C,KAAK6L,YAAYzD,EAAM6D,EAAI7I,MAAO6I,EAAIrC,QAGxC7J,OAAOkM,2CACZ,MAAMwR,QAAgBzd,KAAKmM,MAAMF,EAAI7I,MAAMJ,KACrCsoD,EAA+Br/C,EAAI7I,MAAMmoD,UAAY,CAACC,QAAS/tC,EAAQnR,IAAIiC,GAAUA,EAAOgC,OAAS,CAACm5C,UAAWjsC,EAAQnR,IAAIiC,GAAUA,EAAO1L,KACpJ,OAAO7C,KAAK6kD,gBAAgBmC,eAAesE,EAAYr/C,EAAI7I,MAAO6I,EAAIrC,QAGjE7J,SAASkM,2CACd,MAAMwR,QAAgBzd,KAAK4wB,cAAc7T,YAAYhR,OAAO,CAACsE,SAAUpE,EAAI7I,MAAMP,KAC3E4oD,QAAqBzrD,KAAK6kD,gBAAgBmC,eAAe,CAAC32C,SAAUpE,EAAI7I,MAAMP,IAAKoJ,EAAI7I,MAAO6I,EAAIrC,MAExG,MAAO,CAAC6T,cADoBzd,KAAK6L,YAAY4R,EAASxR,EAAI7I,MAAO6I,EAAIrC,MACrCoL,OAAQy2C,KAGnC1rD,kBAAkBkM,2CACvB,IAAKA,EAAIqL,KACR,OAAO7P,QAAQE,OAAOsC,EAAAvE,kBAAkB,wBAEzC,MAAM6I,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,UACnC7C,KAAK4wB,cAAc86B,eAAen9C,EAAQtC,EAAIqL,QAG/CvX,WAAWkM,2CAChB,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,UACnC7C,KAAK4wB,cAAc+6B,aAAap9C,EAAQtC,EAAI7I,MAAM/H,QAGnD0E,WAAWkM,2CAChB,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACzC,MAAO,CAACwO,WAAYrR,KAAKmqD,gBAAgBY,oBAAoBx8C,MAGxDxO,cAAckM,2CACnB,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACnCuF,QAAapI,KAAKmqD,gBAAgBe,wBAAwB38C,GAChE,OAAOvO,KAAK6L,YAAYzD,EAAM6D,EAAI7I,MAAO6I,EAAIrC,QAGxC7J,UAAUkM,2CACf,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACzC,MAAO,CAACwO,WAAYrR,KAAKmqD,gBAAgBa,mBAAmBz8C,MAGvDxO,oBAAoBkM,2CACzB,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACnCmS,QAAehV,KAAKmqD,gBAAgByB,uBAAuBr9C,GACjE,OAAOvO,KAAK6kD,gBAAgBh5C,YAAY1B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAM6B,OAAQgH,EAAI7I,MAAM8B,QAAS+G,EAAI7I,MAAO6I,EAAIrC,QAGxG7J,KAAKkM,2CACV,OAAOjM,KAAK2mD,QAAQ16C,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAI7I,MAAO6I,EAAIrC,QAGpD7J,MAAMkM,2CACX,MAAMo7B,QAAoBrnC,KAAKgxB,aAAa66B,iBAC5C,OAAO7D,EAAA1+B,kBAAkBtpB,KAAKgxB,aAAa86B,kBAAkB7/C,EAAI7I,MAAMma,OAAQ8pB,MAG1EtnC,SAASkM,2CACd,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACzC,OAAOonD,EAAA8B,qBAAqBx9C,KAGfxO,YAAY8C,2CACzB,MAAMkW,EAAWlW,EAAGsY,MAAM,KAAK,GACzB5M,QAAevO,KAAK8L,KAAKiN,GACzBqgC,GAAW7qC,EAAOiC,IAAIyP,UAAY,IAAItD,KAAK8G,GAAOA,EAAI5gB,KAAOA,GACnE,OAAKu2C,EAGE,CAAC7qC,SAAQ6qC,WAFR3xC,QAAQE,OAAOsC,EAAArE,mBAKlB7F,aAAakM,2CAClB,MAAMsC,OAACA,EAAM6qC,QAAEA,SAAiBp5C,KAAKgsD,YAAY//C,EAAI7I,MAAMP,IAC3D,aAAa7C,KAAK4wB,cAAcq7B,gBAAgB19C,EAAQ6qC,EAASntC,EAAI7I,MAAMuJ,KAAMV,EAAI7I,MAAM1D,UAGtFK,cAAckM,2CACnB,MAAMsC,QAAevO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACnCu2C,QAAgBp5C,KAAK4wB,cAAcs7B,sBAAsB39C,EAAQtC,EAAI7I,MAAM8D,IAA8B+E,EAAI7I,MAAMic,OACzH,OAAO4qC,EAAAkC,oBAAoB/S,KAGtBr5C,cAAckM,2CACnB,MAAMsC,OAACA,EAAM6qC,QAAEA,SAAiBp5C,KAAKgsD,YAAY//C,EAAI7I,MAAMP,IAC3D,aAAa7C,KAAK4wB,cAAcw7B,mBAAmB79C,EAAQ6qC,KAGtDr5C,OAAOkM,2CACZ,MAAM7D,QAAapI,KAAK0L,QAAQ1F,MAAM+F,aAAa/L,KAAK6K,eAAeoB,EAAI7I,MAAO6I,EAAIrC,OAGtF,OAFAqC,EAAI7I,MAAMunD,cAAe,SACH3qD,KAAK6L,YAAYzD,EAAM6D,EAAI7I,MAAO6I,EAAIrC,OAC7CwN,OAAOgG,GAAKA,EAAE+tC,QAAU/tC,EAAE+tC,OAAOppD,OAAS,0KCzN3D,MAAAnB,EAAAzB,EAAAzE,EAAA,IACAwH,EAAAxH,EAAA,GAGA,SAAgByxD,EAAoB/S,GACnC,MAAO,CACNv2C,GAAIu2C,EAAQv2C,GACZxH,KAAM+9C,EAAQ/9C,KACdgkB,MAAO+5B,EAAQ/5B,MACf1S,KAAMysC,EAAQ7mC,KAAK5F,MAIrB,SAAgBo/C,EAAqBx9C,GACpC,OAAKA,EAAOiC,IAAIyP,SAGT1R,EAAOiC,IAAIyP,SAAS3T,IAAI8sC,GAAW+S,EAAoB/S,IAFtD,GAKT,SAASiT,EAAgB99C,GACxB,MAAM+9C,EAAUpqD,EAAAtD,iBAAiBmK,QAAQwF,EAAOiC,IAAIpO,OAAS,EAE7D,IAAI+jB,EAAmC,CACtCxV,SAFgBpC,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,QAEzBguD,EAAU/9C,EAAOiC,IAAIuH,gBAAavT,EACxDkiB,UAAW4lC,EAAU/9C,EAAOiC,IAAIuK,eAAYvW,EAC5CgiB,eAAgB8lC,EAAU/9C,EAAOiC,IAAIsK,sBAAmBtW,GAKzD,OAHKhJ,OAAOmJ,KAAKwhB,GAAKxJ,KAAKtgB,KAAe8pB,EAAK9pB,MAC9C8pB,OAAM3hB,GAEA,CACNlG,OAAQiQ,EAAOiC,IAAIlS,OACnB2Z,WAAY1J,EAAOiC,IAAIyH,WACvBzZ,MAAO8tD,EAAU/9C,EAAOiC,IAAIhS,WAAQgG,EACpCgU,UAAW8zC,EAAU/9C,EAAOiC,IAAIgI,eAAYhU,EAC5CyM,MAAO1C,EAAOiC,IAAIS,MAClBD,KAAMs7C,EAAU/9C,EAAOiC,IAAIQ,UAAOxM,EAClCqiB,YAAaV,GAlCfvrB,EAAAuxD,sBASAvxD,EAAAmxD,uBA6BAnxD,EAAA0vD,aAAA,SAA6B/7C,EAAgB3D,GAE5C,OADAA,EAAWA,GAAY,GAChB,CACN/H,GAAI0L,EAAO1L,GACXvD,MAAOiP,EAAOiC,IAAMjC,EAAOiC,IAAIlR,OAAS,EACxC+Q,SAAU9B,EAAO8B,SACjBhV,KAAMuF,EAAAxB,QAAKkR,SAAS/B,EAAOgC,MAC3BW,QAAS3C,EAAOgE,KAAKrB,QACrB6E,WAAYnL,EAASggD,aAAer8C,EAAOiC,IAAIuF,gBAAavR,EAC5D2Z,YAAavT,EAASggD,aAAer8C,EAAOiC,IAAI2N,iBAAc3Z,EAC9DpC,UAA4CoC,IAApB+J,EAAOiC,IAAIpO,MAAuBF,EAAAlF,WAAWuR,EAAOiC,IAAIpO,OAAsB,UACtGoO,IAAK5F,EAASigD,UAAYwB,EAAgB99C,QAAU/J,EACpDyb,SAAUrV,EAAS2hD,eAAiBR,EAAqBx9C,QAAU/J,kcCtDrE,MAAAtC,EAAAxH,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IACAoS,EAAApS,EAAA,GAGA,MAAsB8xD,EAErBzsD,YAA6B8C,EAAmBxH,GAAnB2E,KAAA6C,KAAmB7C,KAAA3E,QAFjDT,EAAA4xD,aASA,MAAaC,UAA4BD,EAExCzsD,cACCwF,MAAM,2BAA4B,mCAG7BxF,IAAIwO,2CACT,GAAIrM,EAAAtD,iBAAiBmK,QAAQwF,EAAOiC,IAAIpO,OAAS,EAAG,CACnD,MAAMsqD,EAAU,GAoBhB,GAnBKn+C,EAAOiC,IAAIhS,OACfkuD,EAAQroD,KAAK,SAETkK,EAAOiC,IAAIlS,QACfouD,EAAQroD,KAAK,UAETkK,EAAOiC,IAAIQ,MACf07C,EAAQroD,KAAK,QAETkK,EAAOiC,IAAIS,OACfy7C,EAAQroD,KAAK,SAETkK,EAAOiC,IAAIuK,UAGVxM,EAAOiC,IAAIwK,aACf0xC,EAAQroD,KAAK,0BAHdqoD,EAAQroD,KAAK,wBAMVqoD,EAAQ3qD,OAAS,EACpB,MAAO,CAAC4qD,QAASD,EAAQpsD,KAAK,UA7BlC1F,EAAA6xD,sBAoCA,MAAaG,UAA4BJ,EAExCzsD,cACCwF,MAAM,4BAA6B,oCAGpCxF,kBAAkByQ,GACjB,MAAMQ,EAAOR,EAAIQ,KAAOR,EAAIQ,KAAKvQ,WAAa,GAC9C,IAAIpF,GAAQmV,EAAIhS,OAAS,IACvBkD,QAAQ,QAAS,IACjBA,QAAQ,UAAU,KAGpB,OAFArG,EAAOyR,EAAAjL,yBAAyBxG,EAAM,OAC3B2V,EAAKjP,OAAS,EAAI,IAAM+K,EAAAjL,yBAAyBmP,EAAM,KAAO,KAAO,IAAM3V,GAC7Ewd,OAGV9Y,UAAUwO,GACT,GAAKA,EAAOiC,IAAS,OAAMjC,EAAOiC,IAAQ,MAAMjC,EAAOiC,IAAIQ,KAAO,EAAI,CACrE,MAAM67C,EAAWjsD,EAAAxB,QAAKkR,SAAS/B,EAAOgC,MAAMsI,OAAOnX,QAAQ,aAAc,IAAIF,cACvEsrD,EAAW9sD,KAAK+sD,kBAAkBx+C,EAAOiC,KACzCw8C,EAAeF,EAASprD,QAAQ,aAAc,IAAIF,cACxD,GAA6C,IAAzCqrD,EAASjwC,cAAcowC,GAC1B,MAAO,CAACL,QAASG,IAKd/sD,IAAIwO,2CACT,OAAIA,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWwB,MAC3BwB,KAAKitD,UAAU1+C,GACXA,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWyB,YAA0C,IAA1B8P,EAAOiC,IAAIuF,WAC9D/V,KAAKitD,UAAU1+C,QADhB,KA9BT3T,EAAAgyD,sBAqCA,MAAaM,UAA6BV,EAEzCzsD,cACCwF,MAAM,4BAA6B,iCAG9BxF,IAAIwO,2CACT,GAAKrM,EAAAtD,iBAAiBmK,QAAQwF,EAAOiC,IAAIpO,OAAS,IAAQmM,EAAOiC,IAAIoB,MACpE,MAAO,MARVhX,EAAAsyD,uBAcA,MAAaC,UAA8BX,EAE1CzsD,cACCwF,MAAM,6BAA8B,kCAG/BxF,IAAIwO,2CACT,GAAKA,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,SAAaiQ,EAAOiC,IAAIoB,MAC3D,MAAO,MARVhX,EAAAuyD,wBAcA,MAAaC,UAA6BZ,EAEzCzsD,cACCwF,MAAM,6BAA8B,qCAGrCxF,UAAUwO,GACT,GAAIA,EAAOiC,IAAIlS,OAAQ,CACtB,MAAMuuD,EAAWjsD,EAAAxB,QAAKkR,SAAS/B,EAAOgC,MAAMsI,OAAOnX,QAAQ,aAAc,IAAIF,cACvEk8B,EAAa5wB,EAAAjL,yBAAyB0M,EAAOiC,IAAIlS,OAAQ,KACzD+uD,EAAiB3vB,EAAWh8B,QAAQ,aAAc,IAAIF,cAC5D,GAA+C,IAA3CqrD,EAASjwC,cAAcywC,GAC1B,MAAO,CAACV,QAASjvB,IAKd39B,IAAIwO,2CACT,GAAIA,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,OAClC,OAAO0B,KAAKitD,UAAU1+C,MAnBzB3T,EAAAwyD,uBAyBAxyD,EAAAyvD,mBAAA,MAGCtqD,cAFAC,KAAAstD,MAA2B,GAG1BttD,KAAKstD,MAAMjpD,KAAK,IAAIooD,GACpBzsD,KAAKstD,MAAMjpD,KAAK,IAAIuoD,GACpB5sD,KAAKstD,MAAMjpD,KAAK,IAAI6oD,GACpBltD,KAAKstD,MAAMjpD,KAAK,IAAI8oD,GACpBntD,KAAKstD,MAAMjpD,KAAK,IAAI+oD,GAGfrtD,IAAIwO,2CACT,MAAM9H,EAA6B,GACnC,IAAK,MAAM8mD,KAAQvtD,KAAKstD,MAAO,CAC9B,MAAMtpD,QAAcupD,EAAKh/B,IAAIhgB,GACzBvK,GACHyC,EAAOpC,KAAK,CACXxB,GAAI0qD,EAAK1qD,GACTxH,KAAMkyD,EAAKlyD,KACXsxD,QAAS3oD,EAAM2oD,UAIlB,OAAOlmD,oXCrKT,MAAA2D,EAAA1P,EAAA,IAGAqS,EAAArS,EAAA,GAIA8yD,EAAA9yD,EAAA,KASAE,EAAAgqD,eAAA,cAAoCx6C,EAAAE,eAEnCvK,YACSuzB,EACAjF,EACEhlB,EACAmB,EACAC,GAEVlF,MAAM+tB,EAAajqB,EAAcmB,EAAcC,GANvCzK,KAAAszB,cACAtzB,KAAAquB,YACEruB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAG9C0E,QAAQiO,EAAYpD,EAAchB,2CACvC,OAAO4jD,EAAAC,WAAWz/C,EAAMhO,KAAKquB,UAAUq/B,cAAc1/C,EAAKnL,OAGrD9C,eAAeqD,EAAiCwG,2CACrD,MAAO,CACNxG,MAAOA,EAAMA,MACb8B,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,OAAOkM,2CACZ,MAAM+B,EAAa,CAClBnL,GAAI,GACJqO,QAAS/Q,KAAKygB,MACdxe,KAAM2K,EAAAjQ,aAAakR,KACnB3S,KAAM4Q,EAAI7I,MAAM/H,KAChBkV,KAAMtE,EAAI7I,MAAMmN,KAChBiK,SAA4BvO,EAAI7I,MAAMoX,UAGvC,OADAxM,EAAKnL,SAAW7C,KAAKszB,YAAYl3B,OAAO4R,GACjChO,KAAK4L,QAAQoC,EAAM,GAAI/B,EAAIrC,QAG7B7J,OAAOkM,2CACZ,MAAM+B,QAAahO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACvCmL,EAAK3S,KAAO4Q,EAAI7I,MAAM/H,KACtB2S,EAAKuC,KAAOtE,EAAI7I,MAAMmN,KACtB,MAAMo9C,EAAmB3/C,EAAKwM,WAAavO,EAAI7I,MAAMoX,SAIrD,OAHAxM,EAAKwM,SAA6BvO,EAAI7I,MAAMoX,eACtCxa,KAAKszB,YAAYzN,OAAO7X,GAC9BhO,KAAKquB,UAAUqG,YAAY1mB,EAAM2/C,GAC1B3tD,KAAK4L,QAAQoC,EAAM,GAAI/B,EAAIrC,QAG7B7J,OAAOkM,2CACZ,MAAM+B,QAAahO,KAAK8L,KAAKG,EAAI7I,MAAMP,UACjC7C,KAAKquB,UAAUuG,WAAW5mB,KAG3BjO,QAAQkM,2CACbjM,KAAKquB,UAAUC,YAGVvuB,KAAKkM,2CACV,MAAM+B,QAAahO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACvC7C,KAAKquB,UAAUqG,YAAY1mB,GAAM,KAG5BjO,OAAOkM,2CACZ,MAAM+B,QAAahO,KAAK8L,KAAKG,EAAI7I,MAAMP,IACvC,OAAO7C,KAAKquB,UAAUq/B,cAAc1/C,EAAKnL,uFClF3CjI,EAAA6yD,WAAA,SAA2Bz/C,EAAY4/C,GACtC,MAAO,CACN/qD,GAAImL,EAAKnL,GACTxH,KAAM2S,EAAK3S,KACX6V,QAASlD,EAAKkD,QACdX,KAAMvC,EAAKuC,KACXnD,OAAQwgD,EACRpzC,SAAUxM,EAAKwM,yXCVjB,MAAApQ,EAAA1P,EAAA,IAGAqS,EAAArS,EAAA,GACAuP,EAAAvP,EAAA,GAEAwjD,EAAAxjD,EAAA,IAOAu1B,EAAAv1B,EAAA,IACAwP,EAAAxP,EAAA,IAEAE,EAAA8qD,eAAA,cAAoCt7C,EAAAE,eAEnCvK,YACS0xB,EACEpoB,EACAmB,EACAC,GAEVlF,MAAMksB,EAAapoB,EAAcmB,EAAcC,GALvCzK,KAAAyxB,cACEzxB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAG9C0E,QAAQ0C,EAAYmI,EAAchB,2CACvC,OAAOs0C,EAAA92B,WAAW3kB,KAGb1C,eAAeqD,EAAiCwG,2CACrD,MAAO,CACNxG,MAAOA,EAAMA,MACb/H,KAAM+H,EAAM/H,KACZwyD,QAASzqD,EAAMyqD,QACf3oD,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,OAAOkM,2CACZ,MAAM6nB,EAAO5pB,EAAAlB,aAAa,IACpB6qB,EAAK5D,EAAAlK,iBAAiB+N,GACtBpI,EAAU,CACf7oB,GAAI,GACJxH,KAAM4Q,EAAI7I,MAAM/H,MAAQ,GACxBqqB,KAAMmO,EAAGnO,KACTC,KAAMkO,EAAGlO,KACTxX,MAAO,GACP4lB,cAAe7pB,EAAAlB,aAAa,IAC5B5G,KAAM2K,EAAAjQ,aAAa8M,KACnBsH,QAAS/Q,KAAKygB,MAEdnS,mBAAmB,EACnBE,MAAO,CACNC,WAA+BpK,IAAxByH,EAAI7I,MAAM0qD,WAA0B7hD,EAAI7I,MAAM0qD,UACrD/+C,YAAiCvK,IAAzByH,EAAI7I,MAAM2qD,YAA2B9hD,EAAI7I,MAAM2qD,WACvD9+C,YAAiCzK,IAAzByH,EAAI7I,MAAM4qD,YAA2B/hD,EAAI7I,MAAM4qD,WACvD1+C,aAAmC9K,IAA1ByH,EAAI7I,MAAM6qD,aAA4BhiD,EAAI7I,MAAM6qD,cAY3D,OADAviC,EAAE7oB,SAAW7C,KAAKyxB,YAAYr1B,OAAOsvB,GAC9B1rB,KAAK4L,QAAQ8f,EAAG,GAAIzf,EAAIrC,QAI1B7J,OAAOkM,2CACZ,MAAMyf,QAAU1rB,KAAK8L,KAAKG,EAAI7I,MAAMP,IACpC,GAAIoJ,EAAI7I,MAAM/H,KAAM,CACnB,GAAI4Q,EAAI7I,MAAM/H,OAASqwB,EAAErwB,aACP2E,KAAKyxB,YAAY6a,UAAUrgC,EAAI7I,MAAM/H,OAErD,OAAOoM,QAAQE,OAAOsC,EAAAnE,aAAa,4BAGrC4lB,EAAErwB,KAAO4Q,EAAI7I,MAAM/H,KAAKwd,OAkBzB,OAhBI5M,EAAI7I,MAAM+K,QACbud,EAAEvd,MAAQlC,EAAI7I,MAAM+K,MAAM0K,aAECrU,IAAxByH,EAAI7I,MAAM0qD,YACbpiC,EAAE/c,MAAMC,MAAQ3C,EAAI7I,MAAM0qD,gBAEGtpD,IAA1ByH,EAAI7I,MAAM6qD,cACbviC,EAAE/c,MAAMW,QAAUrD,EAAI7I,MAAM6qD,kBAEAzpD,IAAzByH,EAAI7I,MAAM2qD,aACbriC,EAAE/c,MAAMI,OAAS9C,EAAI7I,MAAM2qD,iBAECvpD,IAAzByH,EAAI7I,MAAM4qD,aACbtiC,EAAE/c,MAAMM,OAAShD,EAAI7I,MAAM4qD,kBAEtBhuD,KAAKyxB,YAAY5L,OAAO6F,GACvB1rB,KAAK4L,QAAQ8f,EAAG,GAAIzf,EAAIrC,QAG1B7J,OAAOkM,2CACZ,MAAMyf,QAAU1rB,KAAK8L,KAAKG,EAAI7I,MAAMP,UAC9B7C,KAAKyxB,YAAYtwB,OAAOuqB,KAGzB3rB,kBAAkBkM,2CACvB,IAAKA,EAAIqL,KACR,OAAO7P,QAAQE,OAAOsC,EAAAvE,kBAAkB,wBAEzC,MAAMgmB,QAAU1rB,KAAK8L,KAAKG,EAAI7I,MAAMP,IACpC,OAAI6oB,EAAE7oB,KAAOoJ,EAAIrC,KAAK/G,IAAMoJ,EAAIrC,KAAK+E,MAAMC,YAC7B5O,KAAKyxB,YAAYy8B,aAAaxiC,EAAGzf,EAAIqL,MAE5C7P,QAAQE,OAAOsC,EAAApE,iBAGjB9F,eAAekM,2CACpB,MAAMyf,QAAU1rB,KAAK8L,KAAKG,EAAI7I,MAAMP,IACpC,OAAI6oB,EAAE7oB,KAAOoJ,EAAIrC,KAAK/G,IAAMoJ,EAAIrC,KAAK+E,MAAMC,YAC7B5O,KAAKyxB,YAAY08B,gBAAgBziC,EAAGzf,EAAI7I,MAAMqiB,UAErDhe,QAAQE,OAAOsC,EAAApE,iBAGjB9F,YAAYkM,2CACjB,MAAMyf,QAAU1rB,KAAK8L,KAAKG,EAAI7I,MAAMP,IACpC,OAAI6oB,EAAE7oB,KAAOoJ,EAAIrC,KAAK/G,IAAMoJ,EAAIrC,KAAK+E,MAAMC,YAC7B5O,KAAKyxB,YAAY28B,aAAa1iC,EAAGzf,EAAI7I,MAAM+K,OAElD1G,QAAQE,OAAOsC,EAAApE,iYCzIxB,MAAAoE,EAAAvP,EAAA,GAEA2zD,EAAA3zD,EAAA,KAGAE,EAAA8oD,eAAA,MAEC3jD,YAAoBswB,GAAArwB,KAAAqwB,cAGdtwB,KAAKkM,2CAEV,aADuBjM,KAAKqwB,YAAY10B,IAAIsQ,EAAI7I,MAAM6pC,QACtC3gC,IAAI3G,GAAO0oD,EAAAC,kBAAkB3oD,MAGxC5F,OAAOkM,iDACNjM,KAAKqwB,YAAY3tB,IAAIuJ,EAAI7I,MAAMiC,QAAS4G,EAAIrC,QAG7C7J,OAAOkM,2CACZ,MAAM5G,QAAgBrF,KAAKqwB,YAAY1T,KAAK1Q,EAAI7I,MAAMwQ,MACtD,OAAKvO,EAGDA,EAAQ0P,SAAW9I,EAAIrC,KAAK/G,GACxB4E,QAAQE,OAAOsC,EAAApE,0BAEjB7F,KAAKqwB,YAAYlvB,OAAOkE,IALtBoC,QAAQE,OAAOsC,EAAArE,oGCrBzBhL,EAAA0zD,kBAAA,SAAkCjpD,GACjC,MAAO,CACN6I,SAAU7I,EAAQ6I,SAClB6G,OAAQ1P,EAAQ0P,OAChBnB,KAAMvO,EAAQuO,KACdvO,QAASA,EAAQA,wXCGnBzK,EAAAsrD,mBAAA,MAECnmD,YAAoBoqD,EAA0CtF,GAA1C7kD,KAAAmqD,kBAA0CnqD,KAAA6kD,kBAGxD9kD,kBAAkBkM,2CACvB,MAAM7I,EAAQ5H,OAAO+N,OAAO,GAAI0C,EAAI7I,OAEpC,cADOA,EAAMhB,WACApC,KAAKmqD,gBAAgBhhB,kBAAkBl9B,EAAI7I,MAAMhB,KAAMgB,KAG/DrD,eAAekM,2CACpB,MAAMmG,QAAcpS,KAAK6kD,gBAAgB/4C,KAAKG,EAAI7I,MAAMP,IACxD,aAAa7C,KAAKmqD,gBAAgBoE,oBAAoBn8C,EAAOnG,EAAI7I,MAAM45B,OAGlEj9B,aAAakM,2CAClB,aAAajM,KAAKmqD,gBAAgBrhB,aAAa78B,EAAI7I,MAAMhB,KAAM6J,EAAI7I,MAAMP,MAGpE9C,qBAAqBkM,2CAC1B,aAAajM,KAAKmqD,gBAAgB9e,qBAAqBp/B,EAAI7I,MAAMP,GAAIoJ,EAAI7I,MAAM85B,MAG1En9B,sBAAsBkM,2CAC3B,aAAajM,KAAKmqD,gBAAgB5e,sBAAsBt/B,EAAI7I,MAAMhB,KAAM6J,EAAI7I,MAAMP,MAG7E9C,kBAAkBkM,2CACvB,aAAajM,KAAKmqD,gBAAgB/hB,kBAAkBn8B,EAAI7I,MAAMhB,KAAM6J,EAAI7I,MAAMP,GAAIoJ,EAAI7I,MAAM45B,OAGvFj9B,iBAAiBkM,2CACtB,aAAajM,KAAKmqD,gBAAgBvhB,iBAAiB38B,EAAI7I,MAAMqN,MAAOxE,EAAI7I,MAAMk6B,QAGzEv9B,gBAAgBkM,2CACrB,aAAajM,KAAKmqD,gBAAgB3hB,gBAAgBv8B,EAAI7I,MAAMP,GAAIoJ,EAAI7I,MAAMk6B,wXC9C5E,MAAArzB,EAAAvP,EAAA,GAOAqS,EAAArS,EAAA,GAIAE,EAAA4oD,iBAAA,MAECzjD,YAAoBuyB,EAAsCF,EAA8CpsB,GAApFhG,KAAAsyB,gBAAsCtyB,KAAAoyB,oBAA8CpyB,KAAAgG,QAIlGjG,YAAYqS,EAAc1S,EAA4B0O,EAAgCxE,2CAC3F,MAAMnD,QAAezG,KAAKsyB,cAAcw3B,YAAY13C,EAAO1S,EAAQ0O,EAAYxE,GAE/E,OADA5J,KAAKoyB,kBAAkBo8B,YAAYp8C,EAAOxI,GACnCnD,IAGF1G,cAAcwT,EAAkB7T,EAA4B0O,EAAgCxE,2CACjG,MAAMnD,QAAezG,KAAKsyB,cAAco0B,cAAcnzC,EAAS7T,EAAQ0O,EAAYxE,GAEnF,OADA5J,KAAKoyB,kBAAkBq8B,cAAcl7C,EAAS3J,GACvCnD,IAGM1G,eAAexE,EAAamE,EAA4B0O,EAAgCxE,2CACrG,OAAQrO,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB,OAAOpS,KAAK8pD,YAAmBvuD,EAAGmE,EAAQ0O,EAAYxE,GACvD,KAAKmD,EAAAjQ,aAAayW,QACjB,OAAOvT,KAAK0mD,cAAuBnrD,EAAGmE,EAAQ0O,EAAYxE,GAG5D,OAAOnC,QAAQE,OAAOvC,MAAM,wCAGvBrF,OAAOkM,2CACZ,MAAMpJ,EAAKoJ,EAAI7I,MAAMP,GACrB,IAAKA,GAAoB,IAAdA,EAAGd,OACb,OAAO0F,QAAQE,OAAOsC,EAAAvE,qBAEvB,MAAMiG,QAAY3L,KAAKgG,MAAM0oD,UAAU7rD,GACvC,IAAK8I,EACJ,OAAOlE,QAAQE,OAAOsC,EAAArE,iBAEvB,MAAMa,QAAezG,KAAK2uD,eAAehjD,EAAKM,EAAI7I,MAAM1D,YAAQ8E,EAAWyH,EAAIrC,MAC/E,OAAKnD,GACGgB,QAAQE,OAAOsC,EAAArE,mYClDzB,MAAAgpD,EAAAl0D,EAAA,KAGAE,EAAAgpD,gBAAA,MAEC7jD,YAAoB+xB,GAAA9xB,KAAA8xB,eAId/xB,KAAKkM,2CAEV,aADqBjM,KAAK8xB,aAAa+8B,UAAU5iD,EAAI7I,MAAMma,SAC7CjR,IAAI2E,GAAS29C,EAAAE,YAAY79C,uFCXzCrW,EAAAk0D,YAAA,SAA4B79C,GAC3B,MAAO,CACN5V,KAAM4V,EAAM5V,KACZ0a,WAAY9E,EAAM8E,WAClB5E,WAAYF,EAAME,WAClB6E,YAAa/E,EAAM+E,4XCLrB,MAAA+4C,EAAAr0D,EAAA,KAEAE,EAAAopD,qBAAA,MAECjkD,YAAoBivD,GAAAhvD,KAAAgvD,oBAIdjvD,KAAKkM,2CAEV,aADmBjM,KAAKgvD,kBAAkBC,iBAC9B3iD,IAAIqD,GAASo/C,EAAAG,eAAev/C,2KCZ1C,MAAA9C,EAAA1N,EAAAzE,EAAA,KACAqS,EAAArS,EAAA,GACAsuB,EAAAtuB,EAAA,IACAyrD,EAAAzrD,EAAA,IAKAE,EAAAs0D,eAAA,SAA+Bv/C,GAC9B,MAAM2gC,EAA0B,CAC/BpiC,SAAUyB,EAAM/F,KAAKvO,KACrBqY,WAAYpL,KAAKoK,MAAM7F,EAAAzN,QAAO2R,SAASlE,EAAAzN,UAASuU,KAAK9G,EAAAzN,QAAOuQ,EAAMiE,QAAQC,cAE3E,OAAQlE,EAAMhE,IAAIvJ,MACjB,KAAK2K,EAAAjQ,aAAasV,MACjBk+B,EAAQl+B,MAAQ4W,EAAAlC,YAAmBnX,EAAMhE,IAAK,IAC9C,MACD,KAAKoB,EAAAjQ,aAAayW,QACjB,MAAMA,EAAmB5D,EAAMhE,IAC/B2kC,EAAQl+B,MAAQ+zC,EAAAl9B,cAAc1V,EAAS,GAAIA,EAAQnG,QAGrD,OAAOkjC,iXCpBR,MAAArmC,EAAAvP,EAAA,GAIAE,EAAAspD,gBAAA,MACCnkD,YACSiG,EACAwE,GADAxK,KAAAgG,QACAhG,KAAAwK,eAIHzK,MAAMkM,2CACX,MAAMpJ,EAAKoJ,EAAI7I,MAAMP,GACrB,IAAKA,GAAoB,IAAdA,EAAGd,OACb,OAAO0F,QAAQE,OAAOsC,EAAAvE,qBAEvB,MAAMiG,QAAY3L,KAAKgG,MAAM0oD,UAAU7rD,GACvC,IAAK8I,EACJ,OAAOlE,QAAQE,OAAOsC,EAAArE,iBAEvB,MAAMa,QAAezG,KAAKwK,aAAakC,YAAYf,EAAKM,EAAI7I,MAAMuJ,KAAMV,EAAI7I,MAAM1D,QAClF,OAAK+G,GACGgB,QAAQE,OAAOsC,EAAArE,mYCvBzB,MAAAqE,EAAAvP,EAAA,GAKAE,EAAAwpD,mBAAA,MAECrkD,YACSiG,EACAyE,GADAzK,KAAAgG,QACAhG,KAAAyK,kBAIH1K,SAASkM,2CACd,MAAMpJ,EAAKoJ,EAAI7I,MAAMP,GACrB,IAAKA,GAAoB,IAAdA,EAAGd,OACb,OAAO0F,QAAQE,OAAOsC,EAAAvE,qBAEvB,MAAMiG,QAAY3L,KAAKgG,MAAM0oD,UAAU7rD,GACvC,IAAK8I,EACJ,OAAOlE,QAAQE,OAAOsC,EAAArE,iBAEvB,MAAMa,QAAezG,KAAKyK,gBAAgBmC,eAAejB,EAAKM,EAAI7I,MAAM1D,OAAQuM,EAAIrC,MACpF,OAAKnD,GACGgB,QAAQE,OAAOsC,EAAArE,mYCxBzB,MAAAqE,EAAAvP,EAAA,GAIAqS,EAAArS,EAAA,GAKAE,EAAA0pD,mBAAA,MACCvkD,YAAoBiG,EAAsBqU,GAAtBra,KAAAgG,QAAsBhG,KAAAqa,kBAIpCta,SAASkM,2CACd,MAAMpJ,EAAKoJ,EAAI7I,MAAMP,GACrB,IAAKA,GAAoB,IAAdA,EAAGd,OACb,OAAO0F,QAAQE,OAAOsC,EAAAvE,qBAEvB,MAAMiG,QAAY3L,KAAKgG,MAAM0oD,UAAU7rD,GACvC,IAAK8I,EACJ,OAAOlE,QAAQE,OAAOsC,EAAArE,iBAEvB,MAAMlG,EAASuM,EAAI7I,MAAM1D,QAA8B,MACvD,OAAQiM,EAAIvJ,MACX,KAAK2K,EAAAjQ,aAAasV,MACjB,aAAapS,KAAKqa,gBAAgB80C,iBAAwBxjD,EAAKjM,GAChE,KAAKqN,EAAAjQ,aAAayW,QACjB,aAAavT,KAAKqa,gBAAgB+0C,mBAA4BzjD,EAAKjM,GAErE,OAAO+H,QAAQE,OAAOvC,MAAM,kaC3B9BxK,EAAA4pD,uBAAA,MAECzkD,YAAoBiG,GAAAhG,KAAAgG,QAIdjG,aAAakM,2CAClB,aAAajM,KAAKqvD,kBAAkBpjD,EAAI7I,SAGnCrD,kBAAkBqD,2CACvB,MAAMqD,EAA2B,GACjC,QAAoBjC,IAAhBpB,EAAMgP,OAAuBhP,EAAMgP,MAAQ,EAAG,CACjD,MAAMhK,QAAapI,KAAKgG,MAAMsX,WAAWvR,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAMgP,QACnF3L,EAAOuO,OAAS5M,EAAKkE,IAAI/Q,IACjB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEiV,IAAIC,OAAS,MAGzC,QAAoBjM,IAAhBpB,EAAM5E,OAAuB4E,EAAM5E,MAAQ,EAAG,CACjD,MAAM4J,QAAapI,KAAKgG,MAAMkb,WAAWnV,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAM5E,QACnFiI,EAAOsV,OAAS3T,EAAKkE,IAAI/Q,IACjB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEF,QAG5B,QAAqBmJ,IAAjBpB,EAAM9E,QAAwB8E,EAAM9E,OAAS,EAAG,CACnD,MAAM8J,QAAapI,KAAKgG,MAAMwa,YAAYzU,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAM9E,SACpFmI,EAAOoV,QAAUzT,EAAKkE,IAAI/Q,IAClB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEF,QAG5B,QAAqBmJ,IAAjBpB,EAAMmL,QAAwBnL,EAAMmL,OAAS,EAAG,CACnD,MAAMnG,QAAapI,KAAKgG,MAAMwa,YAAYzU,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAMmL,SACpF9H,EAAOgX,QAAUrV,EAAKkE,IAAI/Q,IAClB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEF,QAG5B,QAAuBmJ,IAAnBpB,EAAMoR,UAA0BpR,EAAMoR,SAAW,EAAG,CACvD,MAAMpM,QAAapI,KAAKgG,MAAM4c,cAAc7W,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAMoR,WACtF/N,EAAOkc,UAAYva,EAAKkE,IAAI/Q,IACpB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEF,QAG5B,QAAsBmJ,IAAlBpB,EAAMkM,SAAyBlM,EAAMkM,QAAU,EAAG,CACrD,MAAMlH,QAAapI,KAAKgG,MAAMktB,aAAannB,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAMkM,UACrF7I,EAAO4nC,SAAWjmC,EAAKkE,IAAI/Q,IACnB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEiV,IAAMjV,EAAEiV,IAAIC,MAAQ,MAGhD,QAAsBjM,IAAlBpB,EAAMmQ,SAAyBnQ,EAAMmQ,QAAU,EAAG,CACrD,MAAMnL,QAAapI,KAAKgG,MAAM+sB,aAAahnB,OAAO,CAAC3I,MAAOA,EAAMA,MAAO6B,OAAQ7B,EAAMmQ,UACrF9M,EAAOwnC,SAAW7lC,EAAKkE,IAAI/Q,IACnB,CAACsH,GAAItH,EAAEsH,GAAIxH,KAAME,EAAEF,QAG5B,OAAOoL,oXCpDT,MAAA6oD,EAAA50D,EAAA,KAGAE,EAAAkrD,mBAAA,MAEC/lD,YACS4yB,EACAkyB,GADA7kD,KAAA2yB,kBACA3yB,KAAA6kD,kBAIT9kD,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMA,EAAEmL,QAAUpL,EAAEoL,SAGrC7U,QAAQmV,EAAoBtK,EAA0ChB,2CAC3E,MAAMnD,EAAS6oD,EAAAC,eAAer6C,GAI9B,OAHItK,EAAS4kD,gBACZ/oD,EAAO2L,YAAcpS,KAAK6kD,gBAAgB34C,YAAYgJ,EAASrS,GAAI+H,EAAUhB,IAEvEnD,IAGR1G,eAAeqD,EAAqCwG,GACnD,MAAO,CACNxG,MAAOA,EAAMA,MACb2R,OAAQ3R,EAAM2R,OACd6hC,OAAQxzC,EAAMigB,QACdne,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,GAItFzE,OAAOkM,2CACZ,MAAMmG,QAAcpS,KAAK6kD,gBAAgB/4C,KAAKG,EAAI7I,MAAMigB,SAClDnO,QAAiBlV,KAAK2yB,gBAAgBv2B,OAAOgW,EAAMvP,GAAIoJ,EAAIrC,KAAK/G,GAAIoJ,EAAI7I,MAAMgS,UAAY,EAAGnJ,EAAI7I,MAAMqR,SAC7G,OAAOzU,KAAK4L,QAAQsJ,EAAU,GAAIjJ,EAAIrC,QAGjC7J,OAAOkM,iDACNjM,KAAK2yB,gBAAgBxxB,OAAO8K,EAAI7I,MAAMP,GAAIoJ,EAAIrC,KAAK/G,MAGpD9C,KAAKkM,2CACV,MAAMwjD,QAAkBzvD,KAAK2yB,gBAAgB+8B,OAAOzjD,EAAIrC,KAAK/G,IACvD4D,EAASgpD,EAAUnjD,IAAI4I,GAAYo6C,EAAAC,eAAer6C,IACxD,GAAIjJ,EAAI7I,MAAMosD,cAAe,CAC5B,MAAMx6C,QAAehV,KAAK6kD,gBAAgBz5C,iBAAiBqkD,EAAUnjD,IAAI7C,GAAKA,EAAEmtC,QAAS3qC,EAAI7I,MAAO6I,EAAIrC,MACxGnD,EAAO5B,QAAQqQ,IACdA,EAAS9C,MAAQ4C,EAAO2H,KAAK3gB,GAAKA,EAAE6G,KAAOqS,EAASmO,WAGtD,OAAO5c,qFCzDT7L,EAAA20D,eAAA,SAA+Br6C,GAC9B,MAAO,CACNrS,GAAIqS,EAASrS,GACbwgB,QAASnO,EAAS0hC,OAClBniC,QAASS,EAAST,QAClBvD,QAASgE,EAAShE,QAClB0D,QAASM,EAASN,QAClBQ,SAAUF,EAASE,yXCNrB,MAAAu6C,EAAAj1D,EAAA,KAGAE,EAAAorD,oBAAA,MAECjmD,YACS6vD,EACA/K,GADA7kD,KAAA4vD,mBACA5vD,KAAA6kD,kBAIH9kD,IAAIkM,2CACT,MAAMykC,QAAkB1wC,KAAK4vD,iBAAiBC,iBAAiB5jD,EAAIrC,KAAK/G,GAAIoJ,EAAIszB,QAC1E94B,EAASkpD,EAAAG,gBAAgBpf,EAAWzkC,EAAI7I,OAI9C,OAHI6I,EAAI7I,MAAM2sD,kBACbtpD,EAAOuO,aAAehV,KAAK6kD,gBAAgBz5C,iBAAiBslC,EAAU5/B,SAAU7E,EAAI7I,MAAO6I,EAAIrC,OAEzFnD,IAGF1G,OAAOkM,2CACZ,aAAajM,KAAK4vD,iBAAiBjZ,KAAK1qC,EAAIrC,KAAK/G,GAAIoJ,EAAI7I,MAAM0N,SAAU7E,EAAI7I,MAAMqS,UAAWxJ,EAAI7I,MAAMgS,SAAUnJ,EAAIszB,UAGjHx/B,OAAOkM,iDACNjM,KAAK4vD,iBAAiBzuD,OAAO8K,EAAIrC,KAAK/G,uFCzB9CjI,EAAAk1D,gBAAA,SAAgCpf,EAAsB9lC,GACrD,MAAO,CACNgK,QAAS87B,EAAU97B,QACnBc,UAAWg7B,EAAUh7B,UACrBD,UAAWi7B,EAAUj7B,UACrBL,SAAUs7B,EAAUt7B,SACpBtE,SAAUlG,EAASolD,kBAAoBtf,EAAU5/B,cAAWtM,kXCV9D,MAAA4F,EAAA1P,EAAA,IAGAqS,EAAArS,EAAA,GAEAu1D,EAAAv1D,EAAA,KAEA+Q,EAAA/Q,EAAA,GAQAE,EAAA8pD,gBAAA,cAAqCt6C,EAAAE,eAEpCvK,YACSyzB,EACEnqB,EACAmB,EACAC,GAEVlF,MAAMiuB,EAAcnqB,EAAcmB,EAAcC,GALxCzK,KAAAwzB,eACExzB,KAAAqJ,eACArJ,KAAAwK,eACAxK,KAAAyK,kBAKX1K,YAAY4C,GACX,OAAOA,EAAMmC,KAAK,CAAC0E,EAAGC,IAAMD,EAAEnO,KAAKuhB,cAAcnT,EAAEpO,OAG9C0E,QAAQ4V,EAAc/K,EAAuChB,2CAClE,MAAMnD,EAASwpD,EAAAC,YAAYv6C,GAC3B,GAAI/K,EAASulD,WAAY,CACxB,MAAMjqD,QAAclG,KAAKqJ,aAAa+C,aAAauJ,EAAM9S,GAAI+G,EAAK/G,GAAIkK,EAAAjQ,aAAa6Y,OACnFlP,EAAOP,MAAQuF,EAAAxF,YAAYC,GAE5B,OAAOO,IAGF1G,eAAeqD,EAAkCwG,2CACtD,MAAO,CACNxG,MAAOA,EAAMA,MACb8D,IAAK9D,EAAM8D,IACX7L,KAAM+H,EAAM/H,KACZya,SAAU1S,EAAM0S,SAChB5Q,OAAQ9B,EAAM8B,OACdD,OAAQ7B,EAAM6B,OACdL,MAAOxB,EAAMojD,UAAY,CAAC,CAAC1iD,MAAOV,EAAMojD,UAAWzhD,aAAc3B,EAAMqjD,sBAAmBjiD,KAItFzE,OAAOkM,2CACZ,MAAM0J,QAAc3V,KAAKwzB,aAAap3B,OAAO6P,EAAI7I,MAAM/H,KAAM4Q,EAAI7I,MAAM8D,IAAK+E,EAAI7I,MAAM0S,UACtF,OAAO9V,KAAK4L,QAAQ+J,EAAO,CAACw6C,YAAY,GAAOlkD,EAAIrC,QAG9C7J,OAAOkM,2CACZ,MAAM0J,QAAc3V,KAAK8L,KAAKG,EAAI7I,MAAMP,UAClC7C,KAAKwzB,aAAa3N,OAAOlQ,EAAO1J,EAAI7I,MAAM/H,KAAM4Q,EAAI7I,MAAM8D,IAAK+E,EAAI7I,MAAM0S,YAG1E/V,OAAOkM,2CACZ,MAAM0J,QAAc3V,KAAK8L,KAAKG,EAAI7I,MAAMP,UAClC7C,KAAKwzB,aAAaryB,OAAOwU,sFC5DjC/a,EAAAs1D,YAAA,SAA4Bv6C,GAC3B,MAAO,CACN9S,GAAI8S,EAAM9S,GACVqE,IAAKyO,EAAMzO,IACXgK,QAASyE,EAAMzE,QACf0D,QAASe,EAAMf,QACfvZ,KAAMsa,EAAMta,KACZya,SAAUH,EAAMG,yXCPlB,MAAAs6C,EAAA11D,EAAA,KAGAE,EAAAkpD,gBAAA,MAEC/jD,YAAoBiyB,GAAAhyB,KAAAgyB,eAIdjyB,IAAIkM,2CACT,MAAM4O,QAAc7a,KAAKgyB,aAAaq+B,SAASpkD,EAAI7I,MAAMma,QACzD,OAAO6yC,EAAAE,YAAYz1C,sFCXrBjgB,EAAA01D,YAAA,SAA4Bz1C,GAC3B,MAAO,CACN0C,OAAQ1C,EAAM0C,OACd/e,MAAOqc,EAAMrc,MACbmiB,WAAY,CACXniB,MAAOqc,EAAM8F,WAAWniB,MACxBia,YAAaoC,EAAM8F,WAAWlI,YAC9BgE,UAAW5B,EAAM8F,WAAWlE,WAE7Bw/B,YAAa,CACZz9C,MAAOqc,EAAMohC,YAAYz9C,MACzBia,YAAaoC,EAAMohC,YAAYxjC,YAC/BgE,UAAW5B,EAAMohC,YAAYx/B,WAE9Bne,OAAQuc,EAAMvc,OACdiQ,OAAQsM,EAAMtM,OACd6D,MAAOyI,EAAMzI,sXCffxX,EAAA0oD,mBAAA,MAECvjD,YAAmBouB,GAAAnuB,KAAAmuB,kBAGbpuB,MAAMkM,2CACX,aAAajM,KAAKmuB,gBAAgBxyB,QAG7BoE,YAAYkM,iDACXjM,KAAKmuB,gBAAgBoiC,eAAetkD,EAAI7I,0BCdhDvI,EAAAD,QAAAmC,QAAA,scCAA,MAAA8D,EAAA1B,EAAAzE,EAAA,IACAkG,EAAAzB,EAAAzE,EAAA,IACAgjD,EAAAhjD,EAAA,IAOAE,EAAAilD,qBAAA,cAA0CnC,EAAAlwB,MAIzCztB,YAAYsB,GACXkE,QAHDvF,KAAAmgC,MAAkB,GA0ClBngC,KAAArE,IAA8F,EAAC60D,EAAK5rC,KACnG,MAAM6rC,EAAczwD,KAAKmgC,MAAMqwB,GAC/B,GAAIC,GAAezwD,KAAK0wD,QAAQD,GAC/B,OAAOzwD,KAAK2wD,QAAQH,EAAM3oD,IACzB+c,EAAS/c,KAGX+c,EAAS,KAAM6rC,KAGhBzwD,KAAA+kB,IAAwF,EAACyrC,EAAKnyC,EAAMuG,KACnG5kB,KAAKmgC,MAAMqwB,GAAOnyC,EAClBre,KAAK4wD,SAAShsC,KAGf5kB,KAAA2wD,QAAiE,EAACH,EAAK5rC,YAC/D5kB,KAAKmgC,MAAMqwB,GAClBxwD,KAAK4wD,SAAShsC,KAGf5kB,KAAAmD,IAAoG,CAACyhB,IACpGA,EAAS,KAAM5kB,KAAKmgC,SAGrBngC,KAAA+B,OAAyE,CAAC6iB,IACzEA,EAAS,KAAMppB,OAAOmJ,KAAK3E,KAAKmgC,OAAOp+B,UAGxC/B,KAAA6wD,MAAkD,CAACjsC,IAClD5kB,KAAKmgC,MAAQ,GACbngC,KAAK4wD,SAAShsC,KApEd5kB,KAAKqB,SAAWT,EAAAxB,QAAKsI,QAAQrG,GAAY,iBACzCrB,KAAKysC,OAAO3jB,MAAM7Y,IACjBia,QAAQ3pB,IAAI,uBAAwB0P,KAIhClQ,+CAGL,SAFMc,EAAAzB,QAAIg1B,UAAUxzB,EAAAxB,QAAKmf,QAAQve,KAAKqB,iBACjBR,EAAAzB,QAAI4B,WAAWhB,KAAKqB,UAC7B,CACX,MAAMq3C,QAAgB73C,EAAAzB,QAAI0xD,SAAS9wD,KAAKqB,UACxC7F,OAAOmJ,KAAK+zC,GAAS7zC,QAAQxI,IAC5B,MAAMo0D,EAAc/X,EAAQr8C,QACOmI,IAA/BisD,EAAY7Q,OAAOmR,SAA+D,kBAA/BN,EAAY7Q,OAAOmR,UACzEN,EAAY7Q,OAAOmR,QAAU,IAAI5wD,KAAKswD,EAAY7Q,OAAOmR,UAErD/wD,KAAK0wD,QAAQD,KACjBzwD,KAAKmgC,MAAM9jC,GAAOo0D,QAMd1wD,QAAQse,GACf,SAAIA,EAAKuhC,QAAUvhC,EAAKuhC,OAAOmR,mBAAmB5wD,OAC1Cke,EAAKuhC,OAAOmR,QAAQlzC,UAAY1d,KAAKygB,MAKtC7gB,SAAS6kB,GAChB/jB,EAAAzB,QAAIqyC,UAAUzxC,KAAKqB,SAAU2G,KAAK6c,UAAU7kB,KAAKmgC,OAASt4B,IACrD+c,GACHA,EAAS/c,sBChDbhN,EAAAD,QAAAmC,QAAA,2BCAAlC,EAAAD,QAAAmC,QAAA,+BCAAlC,EAAAD,QAAAmC,QAAA,iCCAAlC,EAAAD,QAAAmC,QAAA,8XCUA,MAAAsgD,EAAA3iD,EAAA,IAWAE,EAAA8mD,kBAAA,SAAkCL,EAAoBle,GACrDke,EAAS1lD,IAAI,QAAS,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAyB08B,EAAI6tB,KAAK5pD,SAClCi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,WAAY,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3C,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA4B08B,EAAI8b,QAAQ73C,SACxCi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,OAI/B7L,EAAAinD,yBAAA,SAAyCR,EAAoBle,GAC5Dke,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAA8B08B,EAAI8iB,mBAAmBgL,aAAa7pD,SAClEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAuC08B,EAAI8iB,mBAAmB/a,eAAe9jC,SAC7Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,sBAAuB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAAqC08B,EAAI8iB,mBAAmB7d,kBAAkBhhC,SAC9Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,sBAAuB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAAqC08B,EAAI8iB,mBAAmB9c,kBAAkB/hC,SAC9Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,yBAA0B,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzD,MAAMoH,EAA0D,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzG94B,QAAwC08B,EAAI8iB,mBAAmB5a,qBAAqBjkC,SACpFi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,0BAA2B,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC1D,MAAMoH,EAA2D,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1G94B,QAAyC08B,EAAI8iB,mBAAmB1a,sBAAsBnkC,SACtFi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,qBAAsB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAsD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACrG94B,QAAsC08B,EAAI8iB,mBAAmBrd,iBAAiBxhC,SAC9Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,oBAAqB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACpG94B,QAAsC08B,EAAI8iB,mBAAmBzd,gBAAgBphC,SAC7Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAiC08B,EAAIohB,uBAAuB2M,aAAa9pD,SACzEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIwgB,gBAAgBv7C,KAAKhB,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,SAAU,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzC,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAA0B08B,EAAI0gB,gBAAgBloD,IAAIyL,SAClDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAsC08B,EAAI4gB,qBAAqB37C,KAAKhB,SACpEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzF94B,QAAuC08B,EAAIsgB,eAAer7C,KAAKhB,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAgC08B,EAAIoiB,iBAAiBz1C,MAAM1I,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAA2B08B,EAAIoiB,iBAAiB1iD,GAAGuE,SACnDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkC08B,EAAIoiB,iBAAiBviD,IAAIoE,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAmC08B,EAAIoiB,iBAAiB4L,SAAS/pD,SACjEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAiC08B,EAAIoiB,iBAAiBvwC,OAAO5N,SAC7Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,qBAAsB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAsD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACrG94B,QAAkC08B,EAAIoiB,iBAAiB6L,WAAWhqD,SAClEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,yBAA0B,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAkC08B,EAAIoiB,iBAAiB8C,cAAcjhD,SACrEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,sBAAuB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIoiB,iBAAiB4C,WAAW/gD,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,qBAAsB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIoiB,iBAAiB+B,UAAUlgD,SACxDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/F94B,QAAkC08B,EAAIoiB,iBAAiBn9C,KAAKhB,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAkC08B,EAAIoiB,iBAAiBx5C,OAAO3E,SAC9Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAkC08B,EAAIoiB,iBAAiB4F,OAAO/jD,SAC9Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAIoiB,iBAAiBr/C,MAAMkB,SACrDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAIoiB,iBAAiB/+C,OAAOY,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gCAAiC,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChE,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAIoiB,iBAAiB8L,oBAAoBjqD,SAC1Ei2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAwC08B,EAAIoiB,iBAAiBtlC,SAAS7Y,SACtEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,YAAa,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAA0B08B,EAAI0hB,gBAAgBhiD,GAAGuE,SACjDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAI0hB,gBAAgB7hD,IAAIoE,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA2B08B,EAAI0hB,gBAAgB0E,OAAOniD,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA4B08B,EAAI0hB,gBAAgByM,QAAQlqD,SACxDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAiC08B,EAAI0hB,gBAAgB94C,OAAO3E,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAI0hB,gBAAgB3+C,MAAMkB,SACpDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAI0hB,gBAAgBr+C,OAAOY,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA+C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAAiC08B,EAAI0hB,gBAAgBz8C,KAAKhB,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAI0hB,gBAAgB7yC,QAAQ5K,SAC7Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAmC08B,EAAI4hB,kBAAkBliD,GAAGuE,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAA0C08B,EAAI4hB,kBAAkB/hD,IAAIoE,SACpEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAA0C08B,EAAI4hB,kBAAkBh5C,OAAO3E,SACvEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,oBAAqB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAI4hB,kBAAkBwM,SAASnqD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,oBAAqB,CAAC,YAEzB68B,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAI4hB,kBAAkB7+C,MAAMkB,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAI4hB,kBAAkBv+C,OAAOY,SACxDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyC08B,EAAI4hB,kBAAkB33C,OAAOhG,SACtEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvG94B,QAA0C08B,EAAI4hB,kBAAkB38C,KAAKhB,SACrEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAA4B08B,EAAI8hB,kBAAkBpiD,GAAGuE,SACrDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAmC08B,EAAI8hB,kBAAkBjiD,IAAIoE,SAC7Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAkC08B,EAAI8hB,kBAAkB73C,OAAOhG,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAmC08B,EAAI8hB,kBAAkBl5C,OAAO3E,SAChEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,sBAAuB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACzE4D,EAAI8hB,kBAAkBuM,WAAWpqD,SACjCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,sBAAuB,CAAC,YAE3B68B,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAI8hB,kBAAkB32B,QAAQlnB,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,mBAAoB,CAAC,YAExB68B,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAI8hB,kBAAkB/+C,MAAMkB,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAI8hB,kBAAkBz+C,OAAOY,SACxDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAmC08B,EAAI8hB,kBAAkB78C,KAAKhB,SAC9Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,YAAa,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAA0B08B,EAAIshB,gBAAgB5hD,GAAGuE,SACjDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIshB,gBAAgBzhD,IAAIoE,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIshB,gBAAgB14C,OAAO3E,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAIshB,gBAAgBv+C,MAAMkB,SACpDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAIshB,gBAAgBj+C,OAAOY,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAA2B08B,EAAIkiB,iBAAiBxiD,GAAGuE,SACnDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkC08B,EAAIkiB,iBAAiBriD,IAAIoE,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAkC08B,EAAIkiB,iBAAiBt5C,OAAO3E,SAC9Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAIkiB,iBAAiBn/C,MAAMkB,SACrDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAIkiB,iBAAiB7+C,OAAOY,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/F94B,QAAkC08B,EAAIkiB,iBAAiBj9C,KAAKhB,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,yBAA0B,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAIkiB,iBAAiBoM,cAAcrqD,SACpEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAkC08B,EAAIkiB,iBAAiBrzC,QAAQ5K,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAgC08B,EAAIkiB,iBAAiBv1C,MAAM1I,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIkiB,iBAAiBrwC,OAAO5N,SAC7Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIkiB,iBAAiBh0C,KAAKjK,SACnDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,YAAa,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAA0B08B,EAAIgiB,gBAAgBtiD,GAAGuE,SACjDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIgiB,gBAAgBniD,IAAIoE,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA+C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAAiC08B,EAAIgiB,gBAAgB/8C,KAAKhB,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAiC08B,EAAIgiB,gBAAgBp5C,OAAO3E,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAIgiB,gBAAgBj/C,MAAMkB,SACpDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAIgiB,gBAAgB3+C,OAAOY,SACtDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,wBAAyB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAIgiB,gBAAgBsM,cAAcrqD,SACnEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIgiB,gBAAgBnwC,OAAO5N,SAC5Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIgiB,gBAAgB9zC,KAAKjK,SAClDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAA6B08B,EAAIwiB,mBAAmB9iD,GAAGuE,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA+C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAAoC08B,EAAIwiB,mBAAmB3iD,IAAIoE,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAoC08B,EAAIwiB,mBAAmB55C,OAAO3E,SAClEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA0B08B,EAAIwiB,mBAAmBz/C,MAAMkB,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAA2B08B,EAAIwiB,mBAAmBn/C,OAAOY,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAIwiB,mBAAmB3wC,OAAO5N,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,WAAY,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIsiB,eAAe5iD,GAAGuE,SAC/Ci2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,WAAY,CAAC,UAEhB46C,EAAS1lD,IAAI,YAAa,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5C,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAAgC08B,EAAIsiB,eAAeziD,IAAIoE,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,YAAa,CAAC,UAEjB46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/F94B,QAAgC08B,EAAIsiB,eAAe15C,OAAO3E,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,eAAgB,CAAC,UAEpB46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAA+C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAA8B08B,EAAI4iB,oBAAoBpqD,IAAIyL,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAAoC08B,EAAI0iB,mBAAmBz9C,KAAKhB,SAChEi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,WAAY,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAAyB08B,EAAIwhB,eAAe9hD,GAAGuE,SAC/Ci2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,YAAa,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5C,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAAgC08B,EAAIwhB,eAAe3hD,IAAIoE,SACvDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/F94B,QAAgC08B,EAAIwhB,eAAe54C,OAAO3E,SAC1Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIwhB,eAAe1hC,KAAK7b,SACxBi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,aAAc,CAAC,UAElB68B,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACzE4D,EAAIwhB,eAAe+M,QAAQtqD,SAC3Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,gBAAiB,CAAC,UAErB68B,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvF94B,QAA+B08B,EAAIwhB,eAAev3C,OAAOhG,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAkC08B,EAAIkgB,mBAAmBz0C,MAAMxH,SAC/Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,kBAAmB,CAAC,UAEvB46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAIoiB,iBAAiBoM,SAASvqD,SAC/Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,mBAAoB,CAAC,WAExB46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIoiB,iBAAiB3zC,MAAMxK,SAC5Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,wBAAyB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIoiB,iBAAiBqM,aAAaxqD,SACnEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAI0hB,gBAAgB91C,OAAO3H,SAC5Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,gBAAiB,CAAC,WAErB46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAI0hB,gBAAgB8M,SAASvqD,SAC9Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,kBAAmB,CAAC,WAEvB46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAI0hB,gBAAgBjzC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA4C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAI4hB,kBAAkBh2C,OAAO3H,SAC9Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,kBAAmB,CAAC,WAEvB46C,EAAS1lD,IAAI,oBAAqB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAI4hB,kBAAkB4M,SAASvqD,SAChEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,oBAAqB,CAAC,WAEzB46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAI4hB,kBAAkBnzC,MAAMxK,SAC7Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,iBAAkB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAI8hB,kBAAkBrzC,MAAMxK,SAC7Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,oBAAqB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAI8hB,kBAAkB0M,SAASvqD,SAChEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,oBAAqB,CAAC,WAEzB46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIkiB,iBAAiBzzC,MAAMxK,SAC5Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAIkiB,iBAAiBsM,SAASvqD,SAC/Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,mBAAoB,CAAC,WAExB46C,EAAS1lD,IAAI,eAAgB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIgiB,gBAAgBvzC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAIgiB,gBAAgBwM,SAASvqD,SAC9Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,kBAAmB,CAAC,WAEvB46C,EAAS1lD,IAAI,kBAAmB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClD,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIwiB,mBAAmB/zC,MAAMxK,SAC9Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,qBAAsB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAIwiB,mBAAmBgM,SAASvqD,SACjEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,qBAAsB,CAAC,WAE1B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIsiB,eAAe7zC,MAAMxK,SAC1Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC1F94B,QAAiC08B,EAAIwhB,eAAe/yC,MAAMxK,SAC1Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,MAGhC46C,EAAS1lD,IAAI,2BAA4B,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3D,MAAMoH,EAA2C,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAiC08B,EAAI8gB,gBAAgBryC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,+BAEH46C,EAAS1lD,IAAI,mBAAoB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAiC08B,EAAI8gB,gBAAgBryC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,sBAEH46C,EAAS1lD,IAAI,qBAAsB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACrG94B,QAAiC08B,EAAI8gB,gBAAgBryC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,wBAEH46C,EAAS1lD,IAAI,aAAc,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAAiC08B,EAAI8gB,gBAAgBryC,MAAMxK,SAC3Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,eAEH46C,EAAS1lD,IAAI,sBAAuB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAiC08B,EAAIogB,iBAAiBx0C,OAAO3H,SAC7Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,wBAAyB,CAAC,WAE7B46C,EAAS1lD,IAAI,cAAe,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9C,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAAiC08B,EAAIogB,iBAAiBx0C,OAAO3H,SAC7Di2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,eAAgB,CAAC,WAEpB46C,EAAS1lD,IAAI,wBAAyB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAAiC08B,EAAIkhB,mBAAmBwN,SAASzqD,SACjEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,0BAA2B,CAAC,WAE/B46C,EAAS1lD,IAAI,gBAAiB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxF94B,QAAiC08B,EAAIghB,mBAAmBwN,SAASvqD,SACjEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,iBAAkB,CAAC,WAEtB46C,EAAS1lD,IAAI,wBAAyB,CAAOsQ,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAIhM,OAAQ2J,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAAiC08B,EAAIghB,mBAAmBwN,SAASvqD,SACjEi2C,EAAA94B,aAAa2sB,OAAO1sB,EAAK/d,KAC7B,0BAA2B,CAAC,WAE/B46C,EAASpR,KAAK,mBAAoB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAA6B08B,EAAI0iB,mBAAmBzpD,OAAOgL,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAASpR,KAAK,mBAAoB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAI0iB,mBAAmBiM,OAAO1qD,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC3F4D,EAAIsgB,eAAernD,OAAOgL,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC9F4D,EAAIsgB,eAAeqO,OAAO1qD,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,gBAAiB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAA0B08B,EAAIshB,gBAAgBroD,OAAOgL,SACrDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,gBAAiB,CAAC,UAErB46C,EAASpR,KAAK,gBAAiB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC/F4D,EAAIshB,gBAAgB5+B,OAAOze,SAC3Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,gBAAiB,CAAC,UAErB68B,EAASpR,KAAK,gBAAiB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAIshB,gBAAgBqN,OAAO1qD,SAC3Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,gBAAiB,CAAC,UAErB68B,EAASpR,KAAK,oBAAqB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAI0hB,gBAAgBkN,UAAU3qD,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAI0hB,gBAAgBmN,WAAW5qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,uBAAwB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAChG4D,EAAI0hB,gBAAgBoN,aAAa7qD,SACjCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,uBAAwB,CAAC,UAE5B68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACjG4D,EAAI0hB,gBAAgBqN,WAAW9qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,qBAAsB,CAAC,UAE1B68B,EAASpyC,OAAO,6BAA8B,QAAS,CAAOhD,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzE,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,OAAQjoB,KAAMrL,EAAIqL,KAAOrL,EAAIqL,KAAK/G,UAAO/L,SAC/H2+B,EAAIoiB,iBAAiB4M,kBAAkB/qD,SACvCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,6BAA8B,CAAC,UAElC68B,EAASpR,KAAK,yBAA0B,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC1D,MAAMoH,EAAsD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACpG4D,EAAIoiB,iBAAiB6M,cAAchrD,SACnCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,yBAA0B,CAAC,UAE9B68B,EAASpR,KAAK,yBAA0B,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC1D,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAIoiB,iBAAiB8M,cAAcjrD,SACnCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,yBAA0B,CAAC,UAE9B68B,EAASpR,KAAK,sBAAuB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAClG4D,EAAIoiB,iBAAiB2M,WAAW9qD,SAChCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,sBAAuB,CAAC,UAE3B68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIoiB,iBAAiBwM,UAAU3qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,sBAAuB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAIoiB,iBAAiByM,WAAW5qD,SAChCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,oBAAqB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIgiB,gBAAgB4M,UAAU3qD,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAIgiB,gBAAgB6M,WAAW5qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIkiB,iBAAiB0M,UAAU3qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,sBAAuB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAIkiB,iBAAiB2M,WAAW5qD,SAChCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,sBAAuB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAI4hB,kBAAkBgN,UAAU3qD,SAChCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,uBAAwB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAI4hB,kBAAkBiN,WAAW5qD,SACjCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,kBAAmB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC9F94B,QAA4B08B,EAAI8hB,kBAAkB7oD,OAAOgL,SACzDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,kBAAmB,CAAC,YAEvB46C,EAASpR,KAAK,sBAAuB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAI8hB,kBAAkB8M,UAAU3qD,SAChCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,uBAAwB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAI8hB,kBAAkB+M,WAAW5qD,SACjCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,kBAAmB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAI8hB,kBAAkB6M,OAAO1qD,SAC7Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,kBAAmB,CAAC,YAEvB68B,EAASpR,KAAK,mBAAoB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/F94B,QAA6B08B,EAAIwiB,mBAAmBvpD,OAAOgL,SAC3Di2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,MAG9B46C,EAASpR,KAAK,mBAAoB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAClG4D,EAAIwiB,mBAAmB9/B,OAAOze,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,uBAAwB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxD,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIwiB,mBAAmBoM,UAAU3qD,SACjCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,wBAAyB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzD,MAAMoH,EAA0C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxF4D,EAAIwiB,mBAAmBqM,WAAW5qD,SAClCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,mBAAoB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACpD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAIwiB,mBAAmBmM,OAAO1qD,SAC9Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,oBAAqB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAChG4D,EAAI4iB,oBAAoBlgC,OAAOze,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,oBAAqB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrD,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxE4D,EAAI4iB,oBAAoB+L,OAAO1qD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAyB08B,EAAIsiB,eAAerpD,OAAOgL,SACnDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,eAAgB,CAAC,UAEpB46C,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC9F4D,EAAIsiB,eAAe5/B,OAAOze,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,eAAgB,CAAC,UAEpB68B,EAASpR,KAAK,wBAAyB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzD,MAAMoH,EAAwD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtG4D,EAAIsiB,eAAe6M,eAAelrD,SAClCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,qBAAsB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtD,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACnG4D,EAAIsiB,eAAe8M,YAAYnrD,SAC/Bi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpyC,OAAO,2BAA4B,QAAS,CAAOhD,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvE,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,OAAQjoB,KAAMrL,EAAIqL,KAAOrL,EAAIqL,KAAK/G,UAAO/L,SAC/H2+B,EAAIsiB,eAAe0M,kBAAkB/qD,SACrCi2C,EAAA94B,aAAa66B,GAAG56B,MAGvB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAIsiB,eAAeqM,OAAO1qD,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,eAAgB,CAAC,UAEpB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC3F94B,QAAyB08B,EAAIwhB,eAAevoD,OAAOgL,SACnDi2C,EAAA94B,aAAalG,KAAKmG,EAAK/d,KAC3B,eAAgB,CAAC,UAEpB46C,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC9F4D,EAAIwhB,eAAe9+B,OAAOze,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,eAAgB,CAAC,UAEpB68B,EAASpR,KAAK,eAAgB,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAChD,MAAMoH,EAAwC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACtF4D,EAAIwhB,eAAemN,OAAO1qD,SAC1Bi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,eAAgB,CAAC,UAEpB68B,EAASpR,KAAK,yBAA0B,CAAOhkC,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC1D,MAAMoH,EAAyC,CAAChE,MAAO6I,EAAIlE,KAAM6B,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACvF4D,EAAIkgB,mBAAmBmP,YAAYprD,SACnCi2C,EAAA94B,aAAa66B,GAAG56B,KACpB,yBAA0B,CAAC,0FC5hC/B,MAAAiuC,EAAA/3D,EAAA,IACA2iD,EAAA3iD,EAAA,IAEMuwB,EAAyBvwB,EAAQ,KACjCg4D,EAAeh4D,EAAQ,KAE7BE,EAAA4mD,SAAA,SAAyBnmD,GAQxB,OAPA,SAAmC4Q,EAAsBuY,EAAuB+Q,GAC/Ek9B,EAAAznC,uBAAuB3vB,EAAM4Q,EAAKgf,EAASynC,GAAc9pC,KAAK,KAC7D2M,MACEzM,MAAO7Y,IACTotC,EAAA94B,aAAa/Y,MAAMgZ,EAAKvU,qcCb3B,MAEM0iD,EAAgB,IAFtBxzD,EAAAzE,EAAA,MAE0B0E,SAI1BxE,EAAAgwB,cAAA,SAA8BlB,GAC7B,OAAOipC,EAAcC,QAAQlpC,IAG9B9uB,EAAAkwB,aAAA,SAAmCzM,EAAWw0C,2CAE7C,aADoBA,EAAgBx0C,IAE5B,CAAC0M,OAAQ,IACN8nC,EAAgB9nC,OACnB,CAACA,OAAQ8nC,EAAgB9nC,QAEzB,CACNA,OAAQ,CAAC,CACR+nC,QAAS,UACTC,SAAU,UACVC,WAAY,UACZ/yD,OAAQ,wBCtBZpF,EAAAD,QAAAmC,QAAA,y5oZCAA,MAAA8P,EAAA1N,EAAAzE,EAAA,KAEAE,EAAA8jD,UAAA,SAA0BuU,GACzB,IAAInmB,EAAS,EAIb,OAHImmB,EAAWl3D,MAAQ,IACtB+wC,EAASjgC,EAAAzN,QAAO2R,SAASkiD,EAAWl3D,MAA+Bk3D,EAAWlmB,MAAMmmB,kBAE9EpmB,kBCPRjyC,EAAAD,QAAAmC,QAAA,kCCAAlC,EAAAD,QAAAmC,QAAA,yLCAA,MAAAu/C,EAAAn9C,EAAAzE,EAAA,KACA0iD,EAAA1iD,EAAA,KACAy4D,EAAAz4D,EAAA,KACA+b,EAAAtX,EAAAzE,EAAA,IACA4pB,EAAA5pB,EAAA,IACA6iD,EAAA7iD,EAAA,KAIAqjD,EAAArjD,EAAA,KACA2iD,EAAA3iD,EAAA,IAEM6F,EAAMkW,EAAArX,QAAO,gBAEnB,SAAgBg0D,EAAgBnnD,EAA+BuY,EAAuB+Q,GAChFtpB,EAAIrC,MAASqC,EAAIrC,KAAK+E,MAAMC,OAChCyuC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAEjDgf,IAGD,SAAgB89B,EAAuBpnD,EAA+BuY,EAAuB+Q,GACvFtpB,EAAIrC,MAASqC,EAAIrC,KAAK+E,MAAMW,SAChC+tC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAEjDgf,IAGD,SAAgB+9B,EAAgBrnD,EAA+BuY,EAAuB+Q,GAChFtpB,EAAIrC,MAASqC,EAAIrC,KAAK+E,MAAMc,WAChC4tC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAEjDgf,IAGD,SAAgBg+B,EAAkBtnD,EAA+BuY,EAAuB+Q,GAClFtpB,EAAIrC,MAASqC,EAAIrC,KAAK+E,MAAMa,aAChC6tC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAEjDgf,IAzBD36B,EAAAw4D,kBAOAx4D,EAAAy4D,yBAOAz4D,EAAA04D,kBAOA14D,EAAA24D,oBAOA34D,EAAAmiD,mBAAA,SAAmCtvB,GAClC,MAAM0V,EAAM,IAAIoa,EAAAiW,YAAY/lC,GACtB9e,EAA8B,CACnCC,MAA+BwkD,EAC/B9jD,QAAiC+jD,EACjCI,MAA+BH,EAC/BI,QAAiCH,GAG5B7T,EAASpD,EAAAl9C,QAAQugD,SAgBvB,OAdAD,EAAOvyB,IAAI,CAAClhB,EAAKuY,EAAK+Q,KACrBh1B,EAAI8Q,KAAKpF,EAAIof,OAAQpf,EAAI80C,aACzBxrB,MAGDmqB,EAAOvyB,IAAIgmC,EAAAQ,6BACXjU,EAAOvyB,IAA4BiwB,EAAAwW,yBACnClU,EAAOvyB,IAA4BiwB,EAAAwE,qBACnC7D,EAAA8V,YAAYnU,EAAQvc,EAAKx0B,GAEzB+wC,EAAOvyB,IAAI,CAAClhB,EAAKuY,EAAK+Q,KACrB/Q,EAAIpX,OAAO,KAAKqX,KAAK,gCAGfi7B,iXC1CR,MAAArC,EAAA3iD,EAAA,IACA4pB,EAAA5pB,EAAA,IAEAo5D,EAAAp5D,EAAA,IA2BAE,EAAAg5D,wBAAA,SAAwC3nD,EAAkBuY,EAAuB+Q,GAChF,OAAItpB,EAAIrC,KACA2rB,IAEHtpB,EAAI9E,YAGT8E,EAAIszB,OAAStzB,EAAI9E,WAAWo4B,YAxB7B,SAAmCtzB,2CAClC,GAAIA,EAAIrC,KACP,OAAaqC,EAAIrC,KAElB,GAAIqC,EAAI9E,WAAWse,SAAU,CAC5B,IAAIqO,EAAO7nB,EAAI9E,WAAWse,SAI1B,OAH6B,IAAzBqO,EAAK/qB,QAAQ,UAChB+qB,EAAOggC,EAAAjoC,UAAUiI,EAAKvyB,MAAM,IAAIsX,QAE1B5M,EAAIwhB,OAAOgE,YAAYsiC,aAAa9nD,EAAI9E,WAAW+G,SAAU4lB,GAC9D,OAAI7nB,EAAI9E,WAAWolC,OAAStgC,EAAI9E,WAAWue,KAC1CzZ,EAAIwhB,OAAOgE,YAAYuiC,UAAU/nD,EAAI9E,WAAW+G,SAAUjC,EAAI9E,WAAWolC,MAAOtgC,EAAI9E,WAAWue,MAE/Fje,QAAQE,OAAO,wBAYvBssD,CAAoBhoD,GAClB2c,KAAKhf,IACLqC,EAAIrC,KAAOA,EACX2rB,MAEAzM,MAAM7Y,IACNslB,OATMA,KAaT36B,EAAAgnD,oBAAA,SAAoC31C,EAAkBuY,EAAuB+Q,GAC5E,OAAItpB,EAAIrC,KACA2rB,IAED8nB,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKM,6KC7ExD,MAAA29C,EAAA/0D,EAAAzE,EAAA,MAEAE,EAAAoqB,MAAA,SAAsBrZ,GAErB,MAMMwoD,EAAQ54D,IACb,IAAIsB,EAAI,GAYR,OAXArB,OAAOmJ,KAAKpJ,GAAGsJ,QAAQxI,IACtB,GAAa,YAARA,EAAoB,CACxB,MAAMqf,EAAMngB,EAAEc,GACT63D,EAAA90D,QAAK6qB,QAAQvO,IAAwB,iBAARA,QAErBlX,IADAwD,KAAK6c,UAAUnJ,KAE1B7e,GAAK,IAAMR,EAAM,KAdT,CAACQ,GAAmBA,EAAE4D,WAAWiB,QAAQ,KAAM,SAC1DA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,UAUa0yD,CAAK14C,GAAO,QAKjC7e,GAYFw3D,EAAQ94D,IACb,IAAIsB,EAAI,GAuBR,OAtBArB,OAAOmJ,KAAKpJ,GAAGsJ,QAAQxI,IACtB,MAAMqf,EAAMngB,EAAEc,GACd,GAAI63D,EAAA90D,QAAK6qB,QAAQvO,GAChBA,EAAI7W,QAAS8K,IACZ,MAAMuH,EAfG,CAAC3b,IACb,IAAK,MAAMc,KAAOd,EACjB,GAAY,YAARc,GAAqBd,EAAEoB,eAAeN,GACzC,OAAOd,EAAEc,GAGX,MAAO,IASQi4D,CAAK3kD,GAAS0kD,EAAK1kD,GAC/B9S,GAAK,IAAMR,EAAM83D,EAAKxkD,GAErB9S,GADGqa,EAAInV,OAAS,EACX,IAAMmV,EAAM,KAAO7a,EAAM,IAEzB,aAGD,GAAmB,iBAARqf,EAAkB,CACnC,MAAMxE,EAAMm9C,EAAK34C,GACjB7e,GAAK,IAAMR,EAAM83D,EAAKz4C,GAClBxE,EAAInV,OAAS,EAChBlF,GAAK,IAAMqa,EAAM,KAAO7a,EAAM,IAE9BQ,GAAK,SAIDA,GAiBR,MAdY,CAACtB,IACZ,IAAIsB,EAAI,GAUR,OATArB,OAAOmJ,KAAKpJ,GAAGsJ,QAAQxI,IACtB,MAAM6a,EAAMm9C,EAAK94D,EAAEc,IACnBQ,GAAK,IAAMR,EAAM83D,EAAK54D,EAAEc,IACpB6a,EAAInV,OAAS,EAChBlF,GAAK,IAAMqa,EAAM,KAAO7a,EAAM,IAE9BQ,GAAK,QAGA,yCAA2CA,GAG5C03D,CAAI5oD,mBC5EZ9Q,EAAAD,QAAAmC,QAAA,uFCkDAnC,EAAA+4D,4BAAA,SAA4C1nD,EAAsBuY,EAAuB+Q,GAC7DtpB,EAAK9E,WArCjC,SAAuB8E,GAWtB,MAAMhM,EAA6B,CAClCiO,SAAUjC,EAAI7I,MAAMsoB,EACpBjG,SAAUxZ,EAAI7I,MAAMxG,EACpB8C,OAAQuM,EAAI7I,MAAMga,EAClBvP,QAAS5B,EAAI7I,MAAM+V,EACnBozB,MAAOtgC,EAAI7I,MAAMpH,EACjB0pB,KAAMzZ,EAAI7I,MAAMvG,EAChB0iC,OAAQtzB,EAAI7I,MAAMjI,EAClBypB,SAAU3Y,EAAI7I,MAAMwhB,UAUrB,cARO3Y,EAAI7I,MAAMpH,SACViQ,EAAI7I,MAAMsoB,SACVzf,EAAI7I,MAAMxG,SACVqP,EAAI7I,MAAMga,SACVnR,EAAI7I,MAAM+V,SACVlN,EAAI7I,MAAMjI,SACV8Q,EAAI7I,MAAMvG,SACVoP,EAAI7I,MAAMwhB,SACV3kB,EAQsCu0D,CAAcvoD,GAC3DspB,mXClDD,MAAArzB,EAAAxH,EAAA,GACAwP,EAAAxP,EAAA,IACAyP,EAAAzP,EAAA,IACA4pB,EAAA5pB,EAAA,IAgBAo5D,EAAAp5D,EAAA,IACAqS,EAAArS,EAAA,GAYAE,EAAA44D,YAAA,MAECzzD,YAAmB0tB,GAAAztB,KAAAytB,SAKL1tB,YAAmCqC,EAAoBqyD,EAAgB9nC,EAAiC/iB,2CACrH,MAAMpD,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiBooD,EAAKnoD,IAAI/Q,GAAKA,EAAEsH,IAAK+G,EAAK/G,GAAIT,GAC7F,OAAOqyD,EAAKnoD,IAAI/Q,GACRoxB,EAAKpxB,EAAGiL,EAAOjL,EAAEsH,QAIZ9C,WAAkCqC,EAAoBuJ,EAAQghB,EAAiC/iB,2CAC5G,MAAM1D,QAAclG,KAAKytB,OAAOpkB,aAAa+C,aAAaT,EAAI9I,GAAI+G,EAAK/G,GAAIT,GAC3E,OAAOuqB,EAAKhhB,EAAKzF,KAGJnG,cAAcgc,EAAsBnS,2CACjD,OAAO5J,KAAK6L,YAAsCkB,EAAAjQ,aAAa0B,MAAOud,EAAQuI,EAAAtX,OAAO0nD,UAAW9qD,KAGnF7J,eAAe8b,EAAwBjS,2CACpD,OAAO5J,KAAK6L,YAAwCkB,EAAAjQ,aAAawB,OAAQud,EAASyI,EAAAtX,OAAOmD,WAAYvG,KAGxF7J,eAAe0d,EAAwB7T,2CACpD,OAAO5J,KAAK6L,YAAoCkB,EAAAjQ,aAAayR,OAAQkP,EAAS6G,EAAAtX,OAAO2nD,WAAY/qD,KAGpF7J,qBAAqB0d,EAAwB7T,2CAC1D,OAAO5J,KAAK6L,YAAqCkB,EAAAjQ,aAAayR,OAAQkP,EAAS6G,EAAAtX,OAAO4nD,iBAAkBhrD,KAG3F7J,aAAaqS,EAAcxI,2CACxC,OAAO5J,KAAK60D,WAAkC9nD,EAAAjQ,aAAasV,MAAOA,EAAOkS,EAAAtX,OAAOsG,UAAW1J,KAG9E7J,cAAciV,EAAsBpL,2CACjD,OAAO5J,KAAK6L,YAAmCkB,EAAAjQ,aAAasV,MAAO4C,EAAQsP,EAAAtX,OAAOsG,UAAW1J,KAGhF7J,iBAAiB0vD,EAA4B7lD,2CAE1D,MAAMkrD,EAAc1sD,GACZA,EAAKgP,OAAO,SAAS3U,EAAM8wC,GACjC,OAAOnrC,EAAKW,QAAQtG,KAAU8wC,IAI1BziC,EAAWgkD,EAAWrF,EAAUnjD,IAAI4I,GAAYA,EAAS0hC,SACzDme,EAAUD,EAAWrF,EAAUnjD,IAAI4I,GAAYA,EAASH,SACxDC,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM6N,GAClDuE,QAAerV,KAAKg1D,cAAchgD,EAAQpL,GAC1CqrD,QAAcj1D,KAAKytB,OAAOznB,MAAM2rB,UAAU1uB,MAAM8xD,GAChDtuD,EAAmC,GAQzC,OAPAgpD,EAAU5qD,QAAQqQ,IACjB,MAAMvF,EAAQ0F,EAAOsH,KAAKxH,GAASA,EAAMtS,KAAOqS,EAAS0hC,QACnDse,EAAeD,EAAMt4C,KAAK+O,GAAKA,EAAE7oB,KAAOqS,EAASH,QACnDpF,GAASulD,GACZzuD,EAAOpC,KAAKigB,EAAAtX,OAAOmoD,aAAajgD,EAAUggD,EAAeA,EAAa75D,KAAO,GAAIsU,MAG5ElJ,IAGM1G,gBAAgByU,EAAoB5K,2CACjD,MAAMoL,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAMuR,EAAS1D,UAC3DtK,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiBmI,EAAS1D,UAAY,GAAIlH,EAAK/G,GAAIkK,EAAAjQ,aAAasV,OAC9G,OAAOkS,EAAAtX,OAAOooD,sBAAsB5gD,EAAUQ,EAAQxO,KAGzCzG,gBAAgBkuC,EAA0BrkC,2CACvD,MAAMpD,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiB4hC,EAAS3hC,IAAIiH,GAAWA,EAAQ1Q,IAAK+G,EAAK/G,GAAIkK,EAAAjQ,aAAayW,SAC1H,OAAO06B,EAAS3hC,IAAIiH,GACZ+Q,EAAAtX,OAAOwG,mBAAmBD,EAAS/M,EAAO+M,EAAQ1Q,IAAM7C,KAAKytB,OAAOoF,eAAewzB,cAAc9yC,EAAQ1Q,IAAMX,EAAA/D,cAAcmoD,YAAc/yC,EAAQnG,WAI9IrN,0BAA0BkM,2CACvC,MAAMopD,EAAiD,GACvD,GAAIppD,EAAI7I,MAAMP,GAAI,CACjB,MAAMG,EAAMgnB,MAAMC,QAAQhe,EAAI7I,MAAMP,IAAMoJ,EAAI7I,MAAMP,GAAK,CAACoJ,EAAI7I,MAAMP,WACjD7C,KAAKytB,OAAOznB,MAAMsvD,eAAetyD,IAC/C6B,QAAQpC,IACZ4yD,EAAU5yD,EAAKL,MAAQizD,EAAU5yD,EAAKL,OAAS,GAC/CizD,EAAU5yD,EAAKL,MAAMiC,KAAK5B,KAG5B,GAAIwJ,EAAI7I,MAAM4P,QAAS,CACtB,MAAMhQ,EAAMgnB,MAAMC,QAAQhe,EAAI7I,MAAM4P,SAAW/G,EAAI7I,MAAM4P,QAAU,CAAC/G,EAAI7I,MAAM4P,SACxE5K,QAAapI,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMD,GACtDqyD,EAAUtoD,EAAAjQ,aAAa0B,QAAU62D,EAAUtoD,EAAAjQ,aAAa0B,QAAU,IAAI6B,OAAO+H,GAE9E,GAAI6D,EAAI7I,MAAMsN,SAAU,CACvB,MAAM1N,EAAMgnB,MAAMC,QAAQhe,EAAI7I,MAAMsN,UAAYzE,EAAI7I,MAAMsN,SAAW,CAACzE,EAAI7I,MAAMsN,UAC1EtI,QAAapI,KAAKytB,OAAOznB,MAAMwa,YAAYvd,MAAMD,GACvDqyD,EAAUtoD,EAAAjQ,aAAawB,SAAW+2D,EAAUtoD,EAAAjQ,aAAawB,SAAW,IAAI+B,OAAO+H,GAEhF,OAAOitD,IAKFt1D,KAAKkM,8CAcLlM,WAAWkM,2CAWhB,MAAO,CAACy8B,QAAS,CAACjM,OAAO,EAAMtuB,MAAO,QAASonD,eAAgB,GAAIC,aAAc,OAG5Ez1D,kBAAkBkM,2CAavB,MAAMsC,QAAevO,KAAK8L,KAAaG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAM+W,aACjE/H,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWvR,OAAO,CAACwE,KAAMhC,EAAOgC,OACvEyE,EAAOlQ,KAAK,CAAC0E,EAAGC,KACf,MAAMgsD,GAAMjsD,EAAEgH,IAAMhH,EAAEgH,IAAI4B,MAAQ,KAAO,GACnCsjD,GAAMjsD,EAAE+G,IAAM/G,EAAE+G,IAAI4B,MAAQ,KAAO,GACzC,OAAIqjD,EAAKC,GACA,EAELD,EAAKC,EACD,EAED,IAER,MAAMj4C,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAACsE,SAAU9B,EAAO1L,KAC7E4a,EAAQ3Y,KAAK,CAAC0E,EAAGC,KAChB,MAAMgsD,GAAMjsD,EAAEgH,IAAMhH,EAAEgH,IAAIhS,MAAQ,KAAO,GACnCk3D,GAAMjsD,EAAE+G,IAAM/G,EAAE+G,IAAIhS,MAAQ,KAAO,GACzC,OAAIi3D,EAAKC,GACA,EAELD,EAAKC,EACD,EAED,IAGR,IAAIrgD,EAAgC,GAChCjN,QAAapI,KAAK21D,eAAel4C,EAASxR,EAAIrC,MAClDyL,EAASA,EAAOhV,OAAO+H,GACvBA,QAAapI,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAC5CyL,EAASA,EAAOhV,OAAO+H,GACvB,MAAMlC,QAAclG,KAAKytB,OAAOpkB,aAAa+C,aAAamC,EAAO1L,GAAIoJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAayR,QACzFsqC,EAAYv0B,EAAAtX,OAAO4oD,cAAcrnD,EAAQrI,GAE/C,OADA2yC,EAAU1jC,MAAQE,EACX,CAACwjC,eAGH94C,WAAWkM,2CAehB,MAAMo7B,QAAoBrnC,KAAKytB,OAAOuD,aAAa66B,iBACnD,GAAI5/C,EAAI7I,MAAMyyD,iBAAmB5pD,EAAI7I,MAAMyyD,gBAAkB,GAAMxuB,EAAYhe,cAAgBpd,EAAI7I,MAAMyyD,gBAExG,MADmB,GAEb,CACN,MAAM/lD,EAAQ9P,KAAKytB,OAAOuD,aAAa86B,kBAAkB7/C,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EAAW6iC,GACnI,IAAIrkC,EAAqB,GACzB8M,EAAMC,OAAOlL,QAAQ8K,IACpB3M,EAAMA,EAAI3C,OAAOsP,EAAMK,QAAQ1D,IAAI2D,GAAKA,EAAE1B,OAAO1L,OAElD,MAAM2D,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiBrJ,EAAKiJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAayR,QAC9F,MAAO,CACNwnD,QAAS,CACR1sC,aAAcvZ,EAAMuZ,aACpB2sC,iBAAkBh2D,KAAKytB,OAAOuD,aAAa2V,YAAYC,gBAAkB,IAAItmC,KAAK,KAClFwP,MAAOwU,EAAAtX,OAAOipD,gBAAgBnmD,EAAOtJ,QAQnCzG,WAAWkM,2CAchB,MAAMs7B,QAAoBvnC,KAAKytB,OAAOuD,aAAa43B,iBAC7C94C,EAAQ9P,KAAKytB,OAAOuD,aAAa63B,kBAAkB58C,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EAAW+iC,GACnI,IAAIvkC,EAAqB,GACzB8M,EAAMC,OAAOlL,QAAQ8K,IACpB3M,EAAMA,EAAI3C,OAAOsP,EAAMK,QAAQ1D,IAAI2D,GAAKA,EAAE3R,OAAOuE,OAElD,MAAM2D,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiBrJ,EAAKiJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAawB,QAC9F,MAAO,CACNud,QAAS,CACRm6C,iBAAkBh2D,KAAKytB,OAAOuD,aAAa2V,YAAYC,gBAAkB,IAAItmC,KAAK,KAClFwP,MAAOwU,EAAAtX,OAAOkpD,gBAAgBpmD,EAAOtJ,OAKlCzG,aAAakM,2CAoBlB,MAAMhH,EAASgH,EAAI7I,MAAMuJ,MAAQ,GAC3BzH,EAAS+G,EAAI7I,MAAM8B,QAAU,EACnC,IAAIlC,EAAqB,GACrBya,EAAyB,GAC7B,OAAQxR,EAAI7I,MAAMhB,MACjB,IAAK,SACJY,QAAYhD,KAAKytB,OAAOznB,MAAM+W,YAAYzT,UAAU,CAAC+V,MAAOnd,EAAAtD,mBAC5D6e,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMiH,EAAArB,YAAoB7F,EAAKiC,IAC7E,MACD,IAAK,SACJwY,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAACsT,MAAOnd,EAAAtD,iBAAkBsG,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,UAAWiB,YAAY,MACtI,MACD,IAAK,uBACJ0Y,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAACsT,MAAOnd,EAAAtD,iBAAkBsG,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,SAAUiB,YAAY,MACrI,MACD,IAAK,qBACJ0Y,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAACsT,MAAOnd,EAAAtD,iBAAkBsG,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,QAASiB,YAAY,MACpI,MACD,IAAK,UACJ/B,QAAYhD,KAAKytB,OAAOmD,cAAc1lB,YAAY,CAACmU,MAAOnd,EAAAtD,kBAAmBqN,EAAIrC,MACjF6T,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IAC1E,MACD,IAAK,WACJlC,QAAYhD,KAAKytB,OAAOmD,cAAc3lB,uBAAuB,CAACoU,MAAOnd,EAAAtD,kBAAmBqN,EAAIrC,MAC5F6T,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IAC1E,MACD,IAAK,SACJlC,QAAYhD,KAAKytB,OAAOmD,cAAczlB,qBAAqB,CAACkU,MAAOnd,EAAAtD,kBAAmBqN,EAAIrC,MAC1F6T,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IAC1E,MACD,IAAK,UACJlC,QAAYhD,KAAKytB,OAAOmD,cAAc9lB,mBAAmB,CAACuU,MAAOnd,EAAAtD,kBAAmBqN,EAAIrC,MACxF6T,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IAC1E,MACD,IAAK,UACJuY,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAACsT,MAAOnd,EAAAtD,iBAAkBsG,SAAQD,SAAQgM,MAAOhF,EAAI7I,MAAM6N,OAAS,KACzH,MACD,IAAK,SACJwM,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAAC7G,SAAQD,SAAQoa,MAAOnd,EAAAtD,iBAAkB+oD,SAAU17C,EAAI7I,MAAMukD,SAAUC,OAAQ37C,EAAI7I,MAAMwkD,SAC/I,MACD,QACC,OAAOngD,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,UAAWiP,KAAM,4BAG5D,MAAO,CAAC+wC,UAAW,CAAC33D,YADCwB,KAAK21D,eAAel4C,EAASxR,EAAIrC,UAIjD7J,cAAckM,2CAmBnB,MAAMhH,EAASqD,KAAKI,IAAIuD,EAAI7I,MAAMuJ,MAAQ,GAAI,KACxCzH,EAAS+G,EAAI7I,MAAM8B,QAAU,EAC7BqY,EAAStR,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EAC9E,IAAIuX,EAAuB,GACvB/Y,EAAqB,GACzB,OAAQiJ,EAAI7I,MAAMhB,MACjB,IAAK,SACJY,QAAYhD,KAAKytB,OAAOznB,MAAMkb,WAAW5X,UAAU,CAACiU,WACpDxB,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMiH,EAAArB,YAAoB7F,EAAKiC,IAC3E,MACD,IAAK,UACJ8W,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAAC9G,SAAQC,SAAQ+L,MAAOhF,EAAI7I,MAAM6N,OAAS,GAAIsM,WAClG,MACD,IAAK,SACJxB,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAAC9G,SAAQC,SAAQyiD,SAAU17C,EAAI7I,MAAMukD,SAAUC,OAAQ37C,EAAI7I,MAAMwkD,OAAQrqC,WAC5H,MACD,IAAK,SACJxB,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAACwR,SAAQrY,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,UAAWiB,YAAY,MACnH,MACD,IAAK,uBACJgX,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAACwR,SAAQrY,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,SAAUiB,YAAY,MAClH,MACD,IAAK,qBACJgX,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAACwR,SAAQrY,SAAQD,SAAQL,MAAO,CAAC,CAACd,MAAO,OAAQiB,YAAY,MAChH,MACD,IAAK,UACJ/B,QAAYhD,KAAKytB,OAAO8D,aAAarmB,YAAY,CAACqS,UAAStR,EAAIrC,MAC/DmS,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IACxE,MACD,IAAK,WACJlC,QAAYhD,KAAKytB,OAAO8D,aAAatmB,uBAAuB,CAACsS,UAAStR,EAAIrC,MAC1EmS,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IACxE,MACD,IAAK,SACJlC,QAAYhD,KAAKytB,OAAO8D,aAAapmB,qBAAqB,CAACoS,UAAStR,EAAIrC,MACxEmS,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IACxE,MACD,IAAK,UACJlC,QAAYhD,KAAKytB,OAAO8D,aAAazmB,mBAAmB,CAACyS,UAAStR,EAAIrC,MACtEmS,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMkH,EAAAY,SAAS/H,EAAKiC,EAAQC,IACxE,MACD,QACC,OAAOuC,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,UAAWiP,KAAM,4BAG5D,MAAO,CAACgxC,WAAY,CAAC53D,YADAwB,KAAKq2D,cAAct6C,EAAQ9P,EAAIrC,UAI/C7J,YAAYkM,2CAcjB,MAAM1Q,QAAUyE,KAAKytB,OAAOznB,MAAM0oD,UAAUziD,EAAI7I,MAAMP,IACtD,OAAKtH,QAGQyE,KAAKytB,OAAOjjB,aAAakC,YAAYnR,EAAG0Q,EAAI7I,MAAMuJ,MAFvDlF,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAKrCzW,UAAUkM,2CAaf,MAAM5Q,EAAO4Q,EAAI7I,MAAM8K,SACjBtE,QAAa5J,KAAKytB,OAAOgE,YAAY6a,UAAUjxC,GACrD,OAAKuO,QAGQ5J,KAAKytB,OAAOjjB,aAAakC,YAAY9C,GAF1CnC,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAKrCzW,aAAakM,2CAWlB,MAAMsC,QAAevO,KAAKytB,OAAOznB,MAAM+W,YAAYha,KAAKkJ,EAAI7I,MAAMP,IAClE,GAAI0L,EACH,GAAIA,EAAOiC,IAAIuK,UAAW,CACzB,MAAMyf,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBR,MAAO+P,EAAOiC,IAAIuK,WACjG,GAAIyf,GAAUA,EAAOh8B,MACpB,MAAO,CAAC8oD,UAAWhjC,EAAAtX,OAAOspD,cAAc97B,EAAOh8B,aAE1C,GAAI+P,EAAOiC,IAAIhS,OAAS+P,EAAOiC,IAAIlS,OAAQ,CACjD,MAAMi4D,QAAWv2D,KAAKytB,OAAO0F,gBAAgBsW,kBAAkBl7B,EAAOiC,IAAIhS,MAAO+P,EAAOiC,IAAIlS,QAC5F,GAAIi4D,GAAMA,EAAG/3D,MAAO,CACnB,MAAMg8B,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBR,MAAO+3D,EAAG/3D,MAAMkT,MAC/F,GAAI8oB,GAAUA,EAAOh8B,MACpB,MAAO,CAAC8oD,UAAWhjC,EAAAtX,OAAOspD,cAAc97B,EAAOh8B,SAKnD,MAAO,CAAC8oD,UAAW,MAGdvnD,cAAckM,2CAYnB,MAAMzN,QAAcwB,KAAKytB,OAAOznB,MAAMkb,WAAWne,KAAKkJ,EAAI7I,MAAMP,IAChE,GAAIrE,EACH,GAAIA,EAAMuc,UAAW,CACpB,MAAMyf,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBR,MAAOA,EAAMuc,WAC5F,GAAIyf,GAAUA,EAAOh8B,MACpB,MAAO,CAAC8oD,UAAWhjC,EAAAtX,OAAOspD,cAAc97B,EAAOh8B,aAE1C,GAAIA,EAAMnD,MAAQmD,EAAMF,OAAQ,CACtC,MAAMi4D,QAAWv2D,KAAKytB,OAAO0F,gBAAgBsW,kBAAkBjrC,EAAMnD,KAAMmD,EAAMF,QACjF,GAAIi4D,GAAMA,EAAG/3D,MAAO,CACnB,MAAMg8B,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBR,MAAO+3D,EAAG/3D,MAAMkT,MAC/F,GAAI8oB,GAAUA,EAAOh8B,MACpB,MAAO,CAAC8oD,UAAWhjC,EAAAtX,OAAOspD,cAAc97B,EAAOh8B,SAKnD,MAAO,CAAC8oD,UAAW,MAGdvnD,cAAckM,2CA4CnB,MAAMsC,QAAevO,KAAKytB,OAAOznB,MAAM+W,YAAYha,KAAKkJ,EAAI7I,MAAMP,IAClE,GAAI0L,EACH,GAAIA,EAAOiC,IAAIuH,WAAY,CAC1B,MAAMyiB,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBV,OAAQiQ,EAAOiC,IAAIuH,YAClG,GAAIyiB,GAAUA,EAAOl8B,OACpB,MAAO,CAAC6pD,WAAY7jC,EAAAtX,OAAOwpD,eAAeh8B,EAAOl8B,cAE5C,GAAIiQ,EAAOiC,IAAIlS,OAAQ,CAC7B,MAAMi4D,QAAWv2D,KAAKytB,OAAO0F,gBAAgBkW,mBAAmB96B,EAAOiC,IAAIlS,QAC3E,GAAIi4D,GAAMA,EAAGj4D,OAAQ,CACpB,MAAMk8B,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBV,OAAQi4D,EAAGj4D,OAAOoT,MACjG,GAAI8oB,GAAUA,EAAOl8B,OACpB,MAAO,CAAC6pD,WAAY7jC,EAAAtX,OAAOwpD,eAAeh8B,EAAOl8B,UAKrD,MAAO,CAAC6pD,WAAY,MAGfpoD,eAAekM,2CAgCpB,MAAM3N,QAAe0B,KAAKytB,OAAOznB,MAAM+W,YAAYha,KAAKkJ,EAAI7I,MAAMP,IAClE,GAAIvE,EACH,GAAIA,EAAOkS,IAAIuH,WAAY,CAC1B,MAAMyiB,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBV,OAAQA,EAAOkS,IAAIuH,YAClG,GAAIyiB,GAAUA,EAAOl8B,OACpB,MAAO,CAACm4D,YAAanyC,EAAAtX,OAAO0pD,gBAAgBl8B,EAAOl8B,cAE9C,GAAIA,EAAOkS,IAAIlS,OAAQ,CAC7B,MAAMi4D,QAAWv2D,KAAKytB,OAAO0F,gBAAgBkW,mBAAmB/qC,EAAOkS,IAAIlS,QAC3E,GAAIi4D,GAAMA,EAAGj4D,OAAQ,CACpB,MAAMk8B,QAAex6B,KAAKytB,OAAO0F,gBAAgB2V,aAAa5mC,EAAAlD,iBAAiBV,OAAQi4D,EAAGj4D,OAAOoT,MACjG,GAAI8oB,GAAUA,EAAOl8B,OACpB,MAAO,CAACm4D,YAAanyC,EAAAtX,OAAO0pD,gBAAgBl8B,EAAOl8B,UAKvD,MAAO,CAACm4D,YAAa,MAGhB12D,YAAYkM,2CAWjB,MAAM0qD,EAAa1qD,EAAI7I,MAAME,OAAS,GACtC,IAAI0R,QAAehV,KAAKytB,OAAO0F,gBAAgByjC,aAAa3qD,EAAI7I,MAAM9E,QAGtE,OAFA0W,EAASA,EAAOzT,MAAM,EAAGo1D,GAElB,CAACE,SAAU,CAACvhD,WADEtV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,UAI/C7J,gBAAgBkM,2CAWrB,MAAM1Q,QAAUyE,KAAKytB,OAAOznB,MAAM0oD,UAAUziD,EAAI7I,MAAMP,IACtD,GAAKtH,EAEE,CACN,IAAIyZ,EAAuB,GAC3B,OAAQzZ,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB4C,QAAehV,KAAKytB,OAAO0F,gBAAgB42B,sBAA6BxuD,GACxE,MACD,KAAKwR,EAAAjQ,aAAayR,OACjByG,QAAehV,KAAKytB,OAAO0F,gBAAgBy4B,uBAA+BrwD,GAC1E,MACD,KAAKwR,EAAAjQ,aAAawB,OACjB0W,QAAehV,KAAKytB,OAAO0F,gBAAgBw1B,uBAA+BptD,GAC1E,MACD,KAAKwR,EAAAjQ,aAAa0B,MACjBwW,QAAehV,KAAKytB,OAAO0F,gBAAgB00B,sBAA6BtsD,GAG1E,MAAMwoC,EAAQ55B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAME,OAAS,GAAI,GAChD+R,QAAerV,KAAKg1D,cAAcjxB,EAAO93B,EAAIrC,MACnD,MAAO,CAACktD,aAAcxyC,EAAAtX,OAAO+pD,iBAAiB1hD,IAnB9C,OAAO5N,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAuBrCzW,iBAAiBkM,2CAYtB,MAAM3N,QAAe0B,KAAK8L,KAAaG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMwa,aACjExL,QAAehV,KAAKytB,OAAO0F,gBAAgBw1B,uBAAuBrqD,GAClEylC,EAAQ55B,EAAAY,SAASiK,EAAQ/I,EAAI7I,MAAME,OAAS,GAAI,GAChD+R,QAAerV,KAAKg1D,cAAcjxB,EAAO93B,EAAIrC,MACnD,MAAO,CAACotD,cAAe1yC,EAAAtX,OAAOiqD,kBAAkB5hD,MAG3CtV,SAASkM,2CAad,MAAM1Q,QAAUyE,KAAKytB,OAAOznB,MAAM0oD,UAAUziD,EAAI7I,MAAMP,IACtD,OAAKtH,EAGGyE,KAAKytB,OAAOhjB,gBAAgBmC,eAAerR,OAAGiJ,EAAWyH,EAAIrC,MAF7DnC,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAMrCzW,OAAOkM,2CAmBZ,MAAM1Q,QAAUyE,KAAKytB,OAAOznB,MAAM0oD,UAAUziD,EAAI7I,MAAMP,IACtD,GAAKtH,EAEE,CACN,OAAQA,EAAE6G,MACT,KAAK2K,EAAAjQ,aAAasV,MACjB,MAAMoS,QAAYxkB,KAAKytB,OAAO6E,cAAcw3B,YAAmBvuD,EAAG0Q,EAAI7I,MAAM1D,OAAQuM,EAAI7I,MAAMgL,WAAYnC,EAAIrC,MAE9G,OADA5J,KAAKytB,OAAO2E,kBAAkBo8B,YAAmBjzD,EAAG0Q,EAAIrC,MACjD4a,EACR,KAAKzX,EAAAjQ,aAAayW,QACjB,MAAM9M,QAAezG,KAAKytB,OAAO6E,cAAco0B,cAAuBnrD,EAAG0Q,EAAI7I,MAAM1D,OAAQuM,EAAI7I,MAAMgL,WAAYnC,EAAIrC,MAErH,OADA5J,KAAKytB,OAAO2E,kBAAkBq8B,cAAuBlzD,EAAG0Q,EAAIrC,MACrDnD,EAET,OAAOgB,QAAQE,OAAOvC,MAAM,sCAZ5B,OAAOqC,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAgBrCzW,QAAQkM,2CAab,MAAMmG,QAAcpS,KAAK8L,KAAYG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMsX,YAErE,MAAO,CAAChI,WADYtV,KAAKk3D,aAAa9kD,EAAOnG,EAAIrC,SAI5C7J,UAAUkM,2CAWf,MACM7D,SADepI,KAAKytB,OAAOqE,aAAa+8B,aACHviD,IAAI2E,GAASqT,EAAAtX,OAAOmqD,UAAUlmD,IACzE,GAAoB,IAAhB7I,EAAKrG,OAAc,CACtB,MAAMq1D,EAAwB,CAC7B5lD,QAAS,IACTX,UAAW,EACXmF,YAAa,EACb7E,WAAY,GAEb/I,EAAK/D,KAAK+yD,GAEX,MAAO,CAACp7C,OAAQ,CAAC/K,MAAO7I,MAGnBrI,gBAAgBkM,2CAYrB,MAAO,CAACorD,aAAc,CAACC,mBADJt3D,KAAKytB,OAAOznB,MAAMsd,UAAUngB,OACNmJ,IAAIgY,EAAAtX,OAAOuqD,cAG/Cx3D,QAAQkM,2CAeb,GAAMA,EAAI7I,MAAM8K,UAAcjC,EAAIrC,KAAKvO,OAAS4Q,EAAI7I,MAAM8K,SAEnD,IAAKjC,EAAIrC,KAAK+E,MAAMC,MAEpB,CACN,MAAM8c,QAAU1rB,KAAKytB,OAAOgE,YAAY6a,UAAUrgC,EAAI7I,MAAM8K,UAC5D,OAAKwd,EAGG,CAAC9hB,KAAM0a,EAAAtX,OAAOwqD,SAAS9rC,IAFvBjkB,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAJ1C,OAAO/O,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAFzC,MAAO,CAAC3M,KAAM0a,EAAAtX,OAAOwqD,SAASvrD,EAAIrC,SAa9B7J,KAAKkM,2CAaV,MAAMopD,QAAkBr1D,KAAKy3D,0BAA0BxrD,GACvD,IAAK,MAAM5P,KAAOb,OAAOmJ,KAAK0wD,GAAY,CACzC,MAAMjzD,EAAqB6L,SAAS5R,EAAK,IACzC,IAAK,MAAMoG,KAAQ4yD,EAAUjzD,SACtBpC,KAAKytB,OAAOpkB,aAAakD,IAAI9J,EAAKI,GAAIT,EAAM6J,EAAIrC,KAAK/G,IAAI,MAK5D9C,OAAOkM,2CAaZ,MAAMopD,QAAkBr1D,KAAKy3D,0BAA0BxrD,GACvD,IAAK,MAAM5P,KAAOb,OAAOmJ,KAAK0wD,GAAY,CACzC,MAAMjzD,EAAqB6L,SAAS5R,EAAK,IACzC,IAAK,MAAMoG,KAAQ4yD,EAAUjzD,SACtBpC,KAAKytB,OAAOpkB,aAAakD,IAAI9J,EAAKI,GAAIT,EAAM6J,EAAIrC,KAAK/G,IAAI,MAK5D9C,UAAUkM,2CAcf,GAAKA,EAAI7I,MAAMoJ,OAAS,GAAOP,EAAI7I,MAAMoJ,OAAS,EACjD,OAAO/E,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,YAE1C,MAAMk/C,QAAkBr1D,KAAKy3D,0BAA0BxrD,GACvD,IAAK,MAAM5P,KAAOb,OAAOmJ,KAAK0wD,GAAY,CACzC,MAAMjzD,EAAqB6L,SAAS5R,EAAK,IACzC,IAAK,MAAMoG,KAAQ4yD,EAAUjzD,SACtBpC,KAAKytB,OAAOpkB,aAAaoD,KAAKhK,EAAKI,GAAIT,EAAM6J,EAAIrC,KAAK/G,GAAIoJ,EAAI7I,MAAMoJ,WAKvEzM,cAAckM,2CAWnB,MAAM7D,QAAapI,KAAKytB,OAAO2E,kBAAkB68B,gBAC3CxoD,EAA0C,GAChD,IAAK,MAAMkJ,KAASvH,EAAM,CACzB,MAAMlC,QAAclG,KAAKytB,OAAOpkB,aAAa+C,aAAauD,EAAMhE,IAAI9I,GAAIoJ,EAAIrC,KAAK/G,GAAI8M,EAAMhE,IAAIvJ,MAC/FqE,EAAOpC,KAAKigB,EAAAtX,OAAOkiD,eAAev/C,EAAOzJ,IAE1C,MAAO,CAACmN,WAAY,CAAC1D,MAAOlJ,MAGvB1G,SAASkM,2CAWd,MAAO,CAACgpD,MAAO,CAACrrD,YADI5J,KAAKytB,OAAOznB,MAAM2rB,UAAUxuB,OACpBmJ,IAAIgY,EAAAtX,OAAOwqD,cAGlCz3D,WAAWkM,2CA6BhB,MAAMyrD,EAAU,CAACjuD,EAAwB+gB,SAC3BhmB,IAANiF,EAAkB+gB,EAAM/gB,EAE1ByE,EAAWjC,EAAI7I,MAAM8K,SACrBwd,QAAU1rB,KAAKytB,OAAOgE,YAAY6a,UAAUp+B,GAClD,IAAKwd,EACJ,OAAOjkB,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAEtCvK,EAAI7I,MAAM+K,QACbud,EAAEvd,MAAQlC,EAAI7I,MAAM+K,OAEjBlC,EAAI7I,MAAMqiB,WACbiG,EAAEqI,cAAgB9nB,EAAI7I,MAAMqiB,UAEzBxZ,EAAI7I,MAAM0yD,gBACbpqC,EAAEld,eAAiBwb,MAAMC,QAAQhe,EAAI7I,MAAM0yD,eAAiB7pD,EAAI7I,MAAM0yD,cAAgB,CAAC7pD,EAAI7I,MAAM0yD,gBAAgBxpD,IAAIzJ,GAAMA,EAAGpC,kBAElG+D,IAAzByH,EAAI7I,MAAMgL,aACbsd,EAAEtd,WAAanC,EAAI7I,MAAMgL,YAAc,GAEpCnC,EAAI7I,MAAM8K,WACbwd,EAAErwB,KAAO4Q,EAAI7I,MAAM8K,UAIpBwd,EAAE/c,MAAMC,MAAQ8oD,EAAQzrD,EAAI7I,MAAMsL,UAAWgd,EAAE/c,MAAMC,OAErD8c,EAAE/c,MAAMI,OAAS2oD,EAAQzrD,EAAI7I,MAAMmM,WAAYmc,EAAE/c,MAAMI,QAGvD2c,EAAE/c,MAAMM,OAASyoD,EAAQzrD,EAAI7I,MAAM4L,WAAY0c,EAAE/c,MAAMM,QAGvDyc,EAAE/c,MAAMW,QAAUooD,EAAQzrD,EAAI7I,MAAMiM,YAAaqc,EAAE/c,MAAMW,eAInDtP,KAAKytB,OAAOgE,YAAY5L,OAAO6F,KAGhC3rB,WAAWkM,2CA8BhB,IACGA,EAAI7I,MAAM8K,UAA4C,IAA9BjC,EAAI7I,MAAM8K,SAASnM,SAC3CkK,EAAI7I,MAAMqiB,UAA4C,IAA9BxZ,EAAI7I,MAAMqiB,SAAS1jB,SAC3CkK,EAAI7I,MAAM+K,OAAsC,IAA3BlC,EAAI7I,MAAM+K,MAAMpM,OAEvC,OAAO0F,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,YAE1C,MAAMuhD,EAAU,CAACjuD,EAAwB+gB,SAC3BhmB,IAANiF,EAAkB+gB,EAAM/gB,EAE1BiiB,EAAU,CACf7oB,GAAI,GACJxH,KAAM4Q,EAAI7I,MAAM8K,UAAY,GAC5BwX,KAAM,GACNC,KAAM,GACNoO,cAAe9nB,EAAI7I,MAAMqiB,UAAY,UACrCtX,MAAOlC,EAAI7I,MAAM+K,OAAS,UAC1BE,kBAAmBlO,KAAKygB,MACxB1P,QAAS/Q,KAAKygB,MACdxe,KAAM2K,EAAAjQ,aAAa8M,KAEnB6E,mBAAmB,EACnBE,MAAO,CACNC,MAAO8oD,EAAQzrD,EAAI7I,MAAMsL,WAAW,GAEpCK,OAAQ2oD,EAAQzrD,EAAI7I,MAAMmM,YAAY,GAGtCN,OAAQyoD,EAAQzrD,EAAI7I,MAAM4L,YAAY,GAItCM,QAASooD,EAAQzrD,EAAI7I,MAAMiM,aAAa,KAKF,IAApCqc,EAAEqI,cAAchrB,QAAQ,UAC3B2iB,EAAEqI,cAAgB+/B,EAAAjoC,UAAUH,EAAEqI,cAAcxyB,MAAM,IAAIsX,cAEjD7Y,KAAKytB,OAAOgE,YAAYr1B,OAAOsvB,KAGhC3rB,WAAWkM,2CAahB,MAAMyf,QAAU1rB,KAAKytB,OAAOgE,YAAY6a,UAAUrgC,EAAI7I,MAAM8K,UAC5D,IAAKwd,EACJ,OAAOjkB,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,iBAEpCxW,KAAKytB,OAAOgE,YAAYtwB,OAAOuqB,KAGhC3rB,eAAekM,2CAcpB,IACGA,EAAI7I,MAAM8K,WACVjC,EAAI7I,MAAMqiB,UACmB,IAA9BxZ,EAAI7I,MAAMqiB,SAAS1jB,OAEpB,OAAO0F,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,YAE1C,GAAIlK,EAAI7I,MAAM8K,WAAajC,EAAIrC,KAAKvO,OAC9B4Q,EAAIrC,KAAK+E,MAAMC,MACnB,OAAOnH,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAG3C,MAAMmV,QAAU1rB,KAAKytB,OAAOgE,YAAY6a,UAAUrgC,EAAI7I,MAAM8K,UAC5D,IAAKwd,EACJ,OAAOjkB,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAE1CkV,EAAEqI,cAAgB9nB,EAAI7I,MAAMqiB,SACY,IAApCiG,EAAEqI,cAAchrB,QAAQ,UAC3B2iB,EAAEqI,cAAgB+/B,EAAAjoC,UAAUH,EAAEqI,cAAcxyB,MAAM,IAAIsX,cAEjD7Y,KAAKytB,OAAOgE,YAAY5L,OAAO6F,KAGhC3rB,gBAAgBkM,2CAcrB,MAAO,CAAC0rD,aAAc,CAACC,mBADA53D,KAAKytB,OAAO4C,YAAY10B,IAAIsQ,EAAI7I,MAAM6pC,QAChB3gC,IAAI3G,GAAO2e,EAAAtX,OAAO6qD,gBAAgBlyD,QAG1E5F,eAAekM,iDAadjM,KAAKytB,OAAO4C,YAAY3tB,IAAIuJ,EAAI7I,MAAMiC,QAAS4G,EAAIrC,QAGpD7J,aAAakM,2CAalB,IAAI8I,EAAS9I,EAAIrC,KAAK/G,GACtB,GAAKoJ,EAAI7I,MAAc,UAAM6I,EAAI7I,MAAM8K,WAAajC,EAAIrC,KAAKvO,KAAO,CACnE,IAAK4Q,EAAIrC,KAAK+E,MAAMC,MACnB,OAAOnH,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAE1C,MAAMmV,QAAU1rB,KAAKytB,OAAOgE,YAAY6a,UAAUrgC,EAAI7I,MAAM8K,UAC5D,IAAKwd,EACJ,OAAOjkB,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAE1CzB,EAAS2W,EAAE7oB,GAEZ,MAAMuF,QAAapI,KAAKytB,OAAOznB,MAAM4c,cAAc7W,OAAO,CAACgJ,SAAQJ,SAAU1I,EAAIrC,KAAK/G,KAAOkS,IACvF4N,EAAgC,GAChClc,EAAmC,GACzC,IAAK,MAAM+N,KAAYpM,EAAM,CAC5B,MAAM0vD,QAAc93D,KAAK+3D,gBAAgBvjD,EAAUvI,EAAIrC,MACvDnD,EAAOpC,KAAKyzD,GAGb,OADAn1C,EAAUnO,SAAW/N,EACd,CAACkc,eAGH5iB,YAAYkM,2CAcjB,MAAMuI,QAAiBxU,KAAK8L,KAAeG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAM4c,eAC3E,OAAIpO,EAASO,SAAW9I,EAAIrC,KAAK/G,GACzB4E,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAGnC,CAAC/B,eADaxU,KAAK+3D,gBAAgBvjD,EAAUvI,EAAIrC,SAInD7J,eAAekM,2CAepB,IAAIuI,EACJ,IAAKvI,EAAI7I,MAAM40D,aAAe/rD,EAAI7I,MAAM/H,KACvC,OAAOoM,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKE,YACnC,GAAIlK,EAAI7I,MAAM40D,WAAY,CAChC,MAAMC,EAAiD,CACtDD,WAAY/rD,EAAI7I,MAAM40D,WACtB38D,KAAM4Q,EAAI7I,MAAM/H,KAChB68D,YAAajsD,EAAI7I,MAAM+0D,QAElBlsD,EAAK7I,MAAQ60D,QACbj4D,KAAKo4D,eAA8DnsD,GACzEuI,QAAiBxU,KAAK8L,KAAeG,EAAI7I,MAAM40D,WAAYh4D,KAAKytB,OAAOznB,MAAM4c,oBACnE3W,EAAI7I,MAAM/H,OACpBmZ,QAAiBxU,KAAKytB,OAAO+E,gBAAgBp2B,OAAO6P,EAAI7I,MAAM/H,UAAMmJ,GAAW,EAAOyH,EAAIrC,KAAK/G,QAAyB2B,IAArByH,EAAI7I,MAAM+0D,OAAwBnuC,MAAMC,QAAQhe,EAAI7I,MAAM+0D,QAAUlsD,EAAI7I,MAAM+0D,OAAS,CAAClsD,EAAI7I,MAAM+0D,QAAW,KAEjN,IAAK3jD,EACJ,OAAO/M,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAE1C,MAAMxB,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAMuR,EAAS1D,UAC3DtK,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiBmI,EAAS1D,SAAU7E,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAasV,OAC5G,MAAO,CAACoC,SAAU8P,EAAAtX,OAAOooD,sBAAsB5gD,EAAUQ,EAAQxO,MAG5DzG,eAAekM,2CAkBpB,MAAMuI,QAAiBxU,KAAK8L,KAAeG,EAAI7I,MAAM40D,WAAYh4D,KAAKytB,OAAOznB,MAAM4c,eACnF,GAAI3W,EAAIrC,KAAK/G,KAAO2R,EAASO,OAC5B,OAAOtN,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,SAG1C,MAAM8hD,OAA+C7zD,IAAhCyH,EAAI7I,MAAMk1D,kBAAmCtuC,MAAMC,QAAQhe,EAAI7I,MAAMk1D,mBAAqBrsD,EAAI7I,MAAMk1D,kBAAoB,CAACrsD,EAAI7I,MAAMk1D,mBAAsB,GAC9K9jD,EAAS1D,SAAW0D,EAAS1D,SAASsG,OAAO,CAACvU,EAAIiN,IAAUuoD,EAAatvD,QAAQ+G,GAAS,GAE1F,MAAMkF,EAAwBR,EAAS1D,SACvC,GAAI7E,EAAI7I,MAAM80D,YAAa,CAC1B,MAAMK,OAAoC/zD,IAA1ByH,EAAI7I,MAAM80D,YAA6BluC,MAAMC,QAAQhe,EAAI7I,MAAM80D,aAAejsD,EAAI7I,MAAM80D,YAAc,CAACjsD,EAAI7I,MAAM80D,aAAgB,GACjJ1jD,EAAS1D,SAAWkE,EAAO3U,OAAOk4D,GAEnC/jD,EAASnZ,KAAO4Q,EAAI7I,MAAM/H,MAAQmZ,EAASnZ,KAC3CmZ,EAASC,QAAUxI,EAAI7I,MAAMqR,SAAWD,EAASC,QACjDD,EAASG,cAAgCnQ,IAArByH,EAAI7I,MAAMsR,OAAuBzI,EAAI7I,MAAMsR,OAASF,EAASG,SACjFH,EAASI,QAAUzU,KAAKygB,YAClB5gB,KAAKytB,OAAO+E,gBAAgB3M,OAAOrR,KAGpCzU,eAAekM,2CAapB,MAAMuI,QAAiBxU,KAAK8L,KAAeG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAM4c,eAC3E,GAAIpO,EAASO,SAAW9I,EAAIrC,KAAK/G,GAChC,OAAO4E,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKM,eAEpCvW,KAAKytB,OAAO+E,gBAAgBrxB,OAAOqT,KAGpCzU,WAAWkM,2CAchB,MAAMsR,OAAsC/Y,IAA5ByH,EAAI7I,MAAM0yD,cAA8B7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EACvFoL,EAA4B,GAC5BkB,QAAiB9Q,KAAKytB,OAAOqD,aAAa5lB,YAAY,CAACqS,UAAStR,EAAIrC,MAC1E,GAAIkH,EAAS/O,OAAS,EAAG,CACxB,MAAMiT,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM6N,GACxDlB,EAAQ0F,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAErD,MAAM4uD,QAAwBx4D,KAAKytB,OAAOmD,cAAc1lB,YAAY,CAACmU,MAAO,CAACnd,EAAAlF,WAAWsB,QAASif,UAAStR,EAAIrC,MAC9G,GAAI4uD,EAAgBz2D,OAAS,EAAG,CAC/B,MAAM0b,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMu1D,GAC1D5oD,EAAQtR,aAAe0B,KAAKy4D,qBAAqBh7C,EAASxR,EAAIrC,MAE/D,MAAM8uD,QAAuB14D,KAAKytB,OAAOmD,cAAc1lB,YAAY,CAACmU,MAAOnd,EAAAtD,iBAAkB2e,UAAStR,EAAIrC,MAC1G,GAAI8uD,EAAe32D,OAAS,EAAG,CAC9B,MAAM0b,QAAgBzd,KAAKytB,OAAOznB,MAAM+W,YAAY9Z,MAAMy1D,GAC1D9oD,EAAQpR,YAAcwB,KAAK21D,eAAel4C,EAASxR,EAAIrC,MAExD,MAAO,CAACgG,aAGH7P,YAAYkM,2CAejB,MAAMsR,OAAsC/Y,IAA5ByH,EAAI7I,MAAM0yD,cAA8B7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EACvFm0D,EAA8B,GAC9B7nD,QAAiB9Q,KAAKytB,OAAOqD,aAAa5lB,YAAY,CAACqS,UAAStR,EAAIrC,MAC1E,GAAIkH,EAAS/O,OAAS,EAAG,CACxB,MAAMiT,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM6N,GACxD6nD,EAASrjD,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAEtD,MAAMwH,QAAiBpR,KAAKytB,OAAO8D,aAAarmB,YAAY,CAACqS,UAAStR,EAAIrC,MAC1E,GAAIwH,EAASrP,OAAS,EAAG,CACxB,MAAMga,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAMmO,GACxDunD,EAASn6D,YAAcwB,KAAKq2D,cAAct6C,EAAQ9P,EAAIrC,MAEvD,MAAM4Y,QAAkBxiB,KAAKytB,OAAO4D,cAAcnmB,YAAY,CAACqS,UAAStR,EAAIrC,MAC5E,GAAI4Y,EAAUzgB,OAAS,EAAG,CACzB,MAAM8Z,QAAgB7b,KAAKytB,OAAOznB,MAAMwa,YAAYvd,MAAMuf,GAC1Dm2C,EAASr6D,aAAe0B,KAAK44D,eAAe/8C,EAAS5P,EAAIrC,MAE1D,MAAO,CAAC+uD,cAGH54D,gBAAgBkM,2CAWrBjM,KAAKytB,OAAOuF,eAAek0B,oBAGtBnnD,qBAAqBkM,iDAapBjM,KAAKytB,OAAOuF,eAAe52B,OAAO6P,EAAI7I,MAAM8D,OAG7CnH,YAAYkM,2CAkBjB,IAAI4sD,GAAkB,OACYr0D,IAA9ByH,EAAI7I,MAAMy1D,kBACbA,EAAkB5sD,EAAI7I,MAAMy1D,iBAE7B,IAAIC,EAA8B,GAClC,GAAI7sD,EAAI7I,MAAMP,GAAI,CACjB,MAAMyM,QAAgBtP,KAAKytB,OAAOznB,MAAMktB,aAAanwB,KAAKkJ,EAAI7I,MAAMP,IACpE,IAAIyM,EAGH,OAAO7H,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,WAFzCsiD,EAAYz0D,KAAKiL,QAKlBwpD,QAAoB94D,KAAKytB,OAAOznB,MAAMktB,aAAa/vB,MAEpD,MAAM41D,EAAUD,EAAYxsD,IAAIgD,GAAWgV,EAAAtX,OAAOgsD,YAAY1pD,EAAUtP,KAAKytB,OAAOuF,eAAeqzB,cAAc/2C,EAAQzM,IAAMX,EAAA/D,cAAcmoD,iBAAc9hD,IACrJ6pC,EAA8B,CAAC0qB,WACrC,GAAIF,EACH,IAAK,MAAMvpD,KAAWypD,EAAS,CAC9B,MAAM9qB,QAAiBjuC,KAAKytB,OAAOznB,MAAM+sB,aAAahnB,OAAO,CAACqI,UAAW9E,EAAQzM,KACjFyM,EAAQiE,cAAgBvT,KAAKi5D,gBAAgBhrB,EAASnpC,KAAK,CAAC0E,EAAGC,KAAOA,EAAEqE,MAAQ,IAAMtE,EAAEsE,MAAQ,IAAK7B,EAAIrC,MAG3G,MAAO,CAACykC,cAGHtuC,kBAAkBkM,2CAWvB,IAAIgiC,QAAiBjuC,KAAKytB,OAAOznB,MAAM+sB,aAAa5vB,MACpD8qC,EAAWA,EAASnpC,KAAK,CAAC0E,EAAGC,KACpBA,EAAEqE,MAAQ,IAAMtE,EAAEsE,MAAQ,IAEnC,MAAMorD,EAA0C,GAEhD,OADAA,EAAe3lD,cAAgBvT,KAAKi5D,gBAAgB9uD,EAAAY,SAASkjC,EAAUhiC,EAAI7I,MAAME,OAAS,GAAI,GAAI2I,EAAIrC,MAC/F,CAACsvD,oBAGHn5D,KAAyB8C,EAAYs2D,2CAC1C,MAAM12D,QAAa02D,EAASp2D,KAAKF,GACjC,OAAKJ,GACGgF,QAAQE,OAAO,CAACud,KAAMZ,EAAAtX,OAAOiJ,KAAKO,aAKrCzW,qBAAqBkM,2CAa1B,MAAMqD,QAAgBtP,KAAK8L,KAAcG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMktB,oBACnElzB,KAAKytB,OAAOuF,eAAe7xB,OAAOmO,KAGnCvP,uBAAuBkM,2CAc5B,MAAMsH,QAAgBvT,KAAK8L,KAAcG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAM+sB,cACpExf,EAAQhD,MACZvQ,KAAKytB,OAAOoF,eAAeulB,gBAAgB7kC,KAIvCxT,qBAAqBkM,2CAa1B,MAAMsH,QAAgBvT,KAAK8L,KAAcG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAM+sB,oBACnE/yB,KAAKytB,OAAOoF,eAAeumC,cAAc7lD,KAG1CxT,aAAakM,2CAWlB,MAAMotD,QAAqBr5D,KAAKytB,OAAOkF,gBAAgB+8B,OAAOzjD,EAAIrC,KAAK/G,IACjE4sD,EAAgC,GAEtC,OADAA,EAAUv6C,eAAiBlV,KAAKs5D,iBAAiBD,EAAcptD,EAAIrC,MAC5D,CAAC6lD,eAGH1vD,eAAekM,2CAepB,MAAMmG,QAAcpS,KAAK8L,KAAYG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMsX,kBAC/Dtd,KAAKytB,OAAOkF,gBAAgBv2B,OAAOgW,EAAMvP,GAAIoJ,EAAIrC,KAAK/G,GAAIoJ,EAAI7I,MAAMgS,SAAUnJ,EAAI7I,MAAMqR,WAGzF1U,eAAekM,iDAadjM,KAAKytB,OAAOkF,gBAAgBxxB,OAAO8K,EAAI7I,MAAMP,GAAIoJ,EAAIrC,KAAK/G,MAG3D9C,eAAekM,2CAkBpB,MAAMhH,EAASqD,KAAKI,IAAIuD,EAAI7I,MAAMuJ,MAAQ,GAAI,KACxCvJ,EAA0B,CAC/B6N,MAAOhF,EAAI7I,MAAM6N,MACjB02C,SAAU17C,EAAI7I,MAAMukD,SACpBC,OAAQ37C,EAAI7I,MAAMwkD,OAClBrqC,OAAQtR,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,GAElE+0D,EAA8B,GAC9BC,QAAiBx5D,KAAKytB,OAAOznB,MAAMsX,WAAWhU,UAAUlG,GAC9D,GAAIo2D,EAASz3D,OAAS,EAAG,CACxB,MAAMgiC,EAAuB75B,EAAArB,YAAY2wD,EAAUv0D,GAC7C+P,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM8gC,GACxDw1B,EAAYjkD,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAEzD,MAAO,CAAC2vD,iBAGHx5D,gBAAgBkM,2CAgBrB,MAAMwtD,EAA+B,GAC/BC,QAAkB15D,KAAKytB,OAAOznB,MAAMsX,WAAWhU,UAAU,CAAC2H,MAAOhF,EAAI7I,MAAM6N,MAAOsM,OAAQtR,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,IACzJu/B,EAAQ55B,EAAAY,SAAS2uD,EAAWztD,EAAI7I,MAAME,OAAS,GAAI2I,EAAI7I,MAAM8B,QAAU,GACvE8P,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM8gC,GAExD,OADA01B,EAAankD,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAClD,CAAC6vD,kBAGH15D,OAAOkM,2CAoBRA,EAAI7I,MAAMu2D,MACb1tD,EAAI7I,MAAM9E,OAAS2N,EAAI7I,MAAMu2D,IAC7B1tD,EAAI7I,MAAM5E,MAAQyN,EAAI7I,MAAMu2D,IAC5B1tD,EAAI7I,MAAMqN,MAAQxE,EAAI7I,MAAMu2D,KAE7B,IAAIvxD,QAAapI,KAAKytB,OAAOznB,MAAMsX,WAAWhU,UAAU,CACvDhL,OAAQ2N,EAAI7I,MAAM9E,OAClBE,MAAOyN,EAAI7I,MAAM5E,MACjBiS,MAAOxE,EAAI7I,MAAMqN,MACjBi3C,UAAWz7C,EAAI7I,MAAMskD,YAEtB,MAAMkS,EAAsC,CAAC10D,OAAQ+G,EAAI7I,MAAM8B,QAAU,EAAG20D,UAAWzxD,EAAKrG,QAC5FqG,EAAO+B,EAAAY,SAAS3C,EAAM6D,EAAI7I,MAAME,OAAS,GAAI2I,EAAI7I,MAAM8B,QAAU,GACjE,MAAM8P,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAMmF,GAExD,OADAwxD,EAAa51D,YAAchE,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MACnD,CAACgwD,kBAGH75D,QAAQkM,2CAqBb,MAAM6tD,EAAwC,GACxCv8C,EAAStR,EAAI7I,MAAM0yD,cAAgB7pD,EAAI7I,MAAM0yD,cAAcr1D,gBAAa+D,EACxEk1D,QAAkB15D,KAAKytB,OAAOznB,MAAMsX,WAAWhU,UAAU,CAAClG,MAAO6I,EAAI7I,MAAMA,MAAOma,WACxF,GAAIm8C,EAAU33D,OAAS,EAAG,CACzB,MAAMgiC,EAAQ55B,EAAAY,SAAS2uD,EAAWztD,EAAI7I,MAAMyN,WAAa,GAAI5E,EAAI7I,MAAM22D,YAAc,GAC/E/kD,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM8gC,GACxD+1B,EAAcxkD,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAE3D,MAAMowD,QAAmBh6D,KAAKytB,OAAOznB,MAAM+W,YAAYhR,OAAO,CAAC3I,MAAO6I,EAAI7I,MAAMA,MAAOma,WACvF,GAAIy8C,EAAWj4D,OAAS,EAAG,CAC1B,MAAMyE,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiB2tD,EAAW1tD,IAAI8Q,GAAKA,EAAEva,IAAKoJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAayR,QAC9GsN,EAAkC,GAClCE,EAAgC,GACtCi+C,EAAWn1D,QAAQ0J,IACdA,EAAOiC,IAAIpO,OAASF,EAAAlF,WAAWsB,OAClCud,EAAQxX,KAAKigB,EAAAtX,OAAO4nD,iBAAiBrmD,EAAQ/H,EAAO+H,EAAO1L,MAE3DkZ,EAAO1X,KAAKigB,EAAAtX,OAAO2nD,WAAWpmD,EAAQ/H,EAAO+H,EAAO1L,QAGtDi3D,EAAcx7D,OAAS6L,EAAAY,SAAS8Q,EAAS5P,EAAI7I,MAAM4S,aAAe,GAAI/J,EAAI7I,MAAM62D,cAAgB,GAChGH,EAAct7D,MAAQ2L,EAAAY,SAASgR,EAAQ9P,EAAI7I,MAAM+N,YAAc,GAAIlF,EAAI7I,MAAM82D,aAAe,GAE7F,MAAO,CAACJ,mBAGH/5D,QAAQkM,2CAoBb,MAAMkuD,EAAwC,GACxCT,QAAkB15D,KAAKytB,OAAOznB,MAAMsX,WAAWhU,UAAU,CAAClG,MAAO6I,EAAI7I,MAAMA,QACjF,GAAIs2D,EAAU33D,OAAS,EAAG,CACzB,MAAMgiC,EAAQ55B,EAAAY,SAAS2uD,EAAWztD,EAAI7I,MAAMyN,WAAa,GAAI5E,EAAI7I,MAAM22D,YAAc,GAC/E/kD,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAM8gC,GACxDo2B,EAAc7kD,WAAatV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAE3D,MAAMwwD,QAAkBp6D,KAAKytB,OAAOznB,MAAMkb,WAAW5X,UAAU,CAAClG,MAAO6I,EAAI7I,MAAMA,QACjF,GAAIg3D,EAAUr4D,OAAS,EAAG,CACzB,MAAMgiC,EAAQ55B,EAAAY,SAASqvD,EAAWnuD,EAAI7I,MAAM+N,YAAc,GAAIlF,EAAI7I,MAAM82D,aAAe,GACjFn+C,QAAe/b,KAAKytB,OAAOznB,MAAMkb,WAAWje,MAAM8gC,GACxDo2B,EAAc37D,YAAcwB,KAAKq2D,cAAct6C,EAAQ9P,EAAIrC,MAE5D,MAAMywD,QAAmBr6D,KAAKytB,OAAOznB,MAAMwa,YAAYlX,UAAU,CAAClG,MAAO6I,EAAI7I,MAAMA,QACnF,GAAIi3D,EAAWt4D,OAAS,EAAG,CAC1B,MAAMgiC,EAAQ55B,EAAAY,SAASsvD,EAAYpuD,EAAI7I,MAAM4S,aAAe,GAAI/J,EAAI7I,MAAM62D,cAAgB,GACpFp+C,QAAgB7b,KAAKytB,OAAOznB,MAAMwa,YAAYvd,MAAM8gC,GAC1Do2B,EAAc77D,aAAe0B,KAAK44D,eAAe/8C,EAAS5P,EAAIrC,MAE/D,MAAO,CAACuwD,mBAGHp6D,cAAckM,2CAQnB,MAAO,CAACquD,WAAYt6D,KAAKytB,OAAOY,UAAUksC,mBAGrCx6D,UAAUkM,2CAQfjM,KAAKytB,OAAOY,UAAUC,YAGjBvuB,UAAUkM,2CAaf,MAAM3N,QAAe0B,KAAK8L,KAAaG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMwa,aACjE45C,QAAkBp6D,KAAKytB,OAAOznB,MAAMkb,WAAWnV,OAAO,CAAC4E,SAAUrS,EAAOuE,KAC9Eu3D,EAAUt1D,KAAK,CAAC0E,EAAGC,KACVD,EAAEwH,MAAQ,IAAMvH,EAAEuH,MAAQ,IAEnC,MAAM9K,QAAclG,KAAKytB,OAAOpkB,aAAa+C,aAAa9N,EAAOuE,GAAIoJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAawB,QACzFkI,QAAexG,KAAKytB,OAAOpkB,aAAagD,iBAAiB+tD,EAAU9tD,IAAI9C,GAAKA,EAAE3G,IAAKoJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAa0B,OAC7Gg8D,EAA0Cl2C,EAAAtX,OAAOmD,WAAW7R,EAAQ4H,GAE1E,OADAs0D,EAAUh8D,MAAQ47D,EAAU9tD,IAAI9C,GAAK8a,EAAAtX,OAAO0nD,UAAUlrD,EAAGhD,EAAOgD,EAAE3G,MAC3D,CAACvE,OAAQk8D,KAGXz6D,SAASkM,2CAad,MAAMzN,QAAcwB,KAAK8L,KAAYG,EAAI7I,MAAMP,GAAI7C,KAAKytB,OAAOznB,MAAMkb,YAC/DlM,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAMzE,EAAMsS,UACxD5K,QAAclG,KAAKytB,OAAOpkB,aAAa+C,aAAa5N,EAAMqE,GAAIoJ,EAAIrC,KAAK/G,GAAIkK,EAAAjQ,aAAa0B,OAC9FwW,EAAOlQ,KAAK,CAAC0E,EAAGC,KACPD,EAAEgH,IAAI4B,OAAS,IAAM3I,EAAE+G,IAAI4B,OAAS,IAE7C,MAAMiD,QAAerV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MAC9C6wD,EAAuCn2C,EAAAtX,OAAO0nD,UAAUl2D,EAAO0H,GAErE,OADAu0D,EAASnlD,KAAOD,EACT,CAAC7W,MAAOi8D,KAGV16D,UAAUkM,2CAcf,IAAKA,EAAI7I,MAAM9E,SAAW2N,EAAI7I,MAAMqN,MACnC,MAAO,CAACiqD,OAAQ,CAAClpD,QAAS,KAE3B,MAAMkpD,QAAe16D,KAAKytB,OAAOtT,YAAYwgD,UAAU1uD,EAAI7I,MAAM9E,OAAQ2N,EAAI7I,MAAMqN,OACnF,OAAKiqD,EAGE,CAACA,OAAQ,CAACp8D,OAAQo8D,EAAOp8D,OAAQmS,MAAOiqD,EAAOplD,KAAM9D,QAASkpD,EAAO77B,MAAMn9B,QAAQ,QAAS,QAF3F,CAACg5D,OAAQ,CAAClpD,QAAS,OAKtBzR,aAAakM,2CAYlB,MAAMsJ,QAAkBvV,KAAKytB,OAAOgF,iBAAiB92B,IAAIsQ,EAAIrC,KAAK/G,IAClE,IAAK0S,EAEJ,MADmB,GAGpB,MAAMP,QAAehV,KAAKytB,OAAOznB,MAAMsX,WAAWra,MAAMsS,EAAUzE,UAC5DuE,QAAerV,KAAKg1D,cAAchgD,EAAQ/I,EAAIrC,MACpD,MAAO,CAAC8mC,UAAWpsB,EAAAtX,OAAO4tD,cAAcrlD,EAAWtJ,EAAIrC,KAAMyL,MAGxDtV,cAAckM,2CAcnB,MAAMjJ,EAAqBiJ,EAAI7I,MAAMP,GAAMmnB,MAAMC,QAAQhe,EAAI7I,MAAMP,IAAMoJ,EAAI7I,MAAMP,GAAK,CAACoJ,EAAI7I,MAAMP,IAAO,SACpG7C,KAAKytB,OAAOgF,iBAAiBkkB,KAAK1qC,EAAIrC,KAAK/G,GAAIG,EAAKiJ,EAAI7I,MAAMoS,QAASvJ,EAAI7I,MAAMgS,SAAUnJ,EAAIszB,UAGhGx/B,2BAA2BkM,2CAYhC,MAAM0J,QAAc3V,KAAK8L,KAAKG,EAAI7I,MAAMP,SAAU7C,KAAKytB,OAAOznB,MAAM0tB,kBAC9D1zB,KAAKytB,OAAOznB,MAAM0tB,WAAWvyB,OAAOwU,EAAM9S,MAG3C9C,2BAA2BkM,iDAc1BjM,KAAKytB,OAAO+F,aAAap3B,OAAO6P,EAAI7I,MAAM/H,KAAM4Q,EAAI7I,MAAMwS,UAAW3J,EAAI7I,MAAM01C,eAGhF/4C,2BAA2BkM,2CAehC,MAAM0J,QAAc3V,KAAK8L,KAAKG,EAAI7I,MAAMP,SAAU7C,KAAKytB,OAAOznB,MAAM0tB,kBAC9D1zB,KAAKytB,OAAO+F,aAAa3N,OAAOlQ,EAAO1J,EAAI7I,MAAM/H,KAAM4Q,EAAI7I,MAAMwS,UAAW3J,EAAI7I,MAAM01C,eAGvF/4C,yBAAyBkM,2CAY9B,MAAO,CAAC4uD,sBAAuB,CAACC,4BADX96D,KAAKytB,OAAOznB,MAAM0tB,WAAWvwB,OACWiU,OAAOzB,IAAUA,EAAMolD,UAAUzuD,IAAIqJ,GAAS2O,EAAAtX,OAAOguD,UAAUrlD,QAKvH5V,UAAUkM,2CAYf,OADAxE,QAAQE,OAAO,mBACR,CAACszD,OAAQ,MAGXl7D,aAAakM,2CAWlB,OADAxE,QAAQE,OAAO,mBACR,CAACuzD,UAAW,CAACr4D,GAAI,OAGnB9C,YAAYkM,2CAYjB,OADAxE,QAAQE,OAAO,mBACR,KAGF5H,SAASkM,2CAqBdxE,QAAQE,OAAO,qBAGV5H,UAAUkM,2CAYf,OADAxE,QAAQE,OAAO,mBACR,CAACwzD,OAAQ,MAGXp7D,YAAYkM,2CAgBjBxE,QAAQE,OAAO,qBAGV5H,YAAYkM,2CAejBxE,QAAQE,OAAO,qBAGV5H,YAAYkM,2CAajBxE,QAAQE,OAAO,qBAGV5H,IAAIkM,2CAoBT,OADAxE,QAAQE,OAAO,mBACR,KAGF5H,eAAekM,2CAkBpB,OADAxE,QAAQE,OAAO,mBACR,CAACyzD,cAAe,CAACC,aAAc,EAAG/qB,SAAS,EAAOgrB,KAAM,sXC5oEjE,MAAAje,EAAA3iD,EAAA,IAGAsjD,EAAAtjD,EAAA,KASAE,EAAAi5D,YAAA,SAA4BnU,EAAwBvc,EAAkBx0B,GACrE+wC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAsD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACrG4D,EAAIo4B,eAAen0D,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAyD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxG4D,EAAIq4B,eAAep0D,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAClG4D,EAAIs4B,eAAer0D,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAyD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACxG94B,QAAyD08B,EAAIu4B,eAAet0D,SAC5Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,6BAA8BwL,EAAMW,QAAS0uC,EAAAwD,SAAS,8BAA+B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClH,IACC,MAAMoH,EAAyD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxG4D,EAAIw4B,qBAAqBv0D,SACzBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqBwL,EAAM8kD,MAAOzV,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC9F,IACC,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC/F4D,EAAIy4B,YAAYx0D,SAChBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoBwL,EAAMC,MAAOovC,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5F,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACpG4D,EAAI04B,WAAWz0D,SACfi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAI24B,eAAe10D,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mCAAoCwL,EAAMC,MAAOovC,EAAAwD,SAAS,oCAAqC,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5H,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAI44B,2BAA2B30D,SAC/Bi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAI64B,eAAe50D,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,6BAA8BwL,EAAMW,QAAS0uC,EAAAwD,SAAS,8BAA+B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClH,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAI84B,qBAAqB70D,SACzBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,6BAA8BwL,EAAMW,QAAS0uC,EAAAwD,SAAS,8BAA+B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAClH,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAI+4B,qBAAqB90D,SACzBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAIg5B,YAAY/0D,SAChBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoBwL,EAAMC,MAAOovC,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5F,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAClG4D,EAAIi5B,WAAWh1D,SACfi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,+BAAgCwL,EAAMW,QAAS0uC,EAAAwD,SAAS,gCAAiC,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtH,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC5F4D,EAAIk5B,uBAAuBj1D,SAC3Bi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,iBAAkB66C,EAAAwD,SAAS,kBAAmB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3E,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAsD08B,EAAIm5B,SAASl1D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkD08B,EAAIokB,aAAangD,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkD08B,EAAIo5B,cAAcn1D,SACpEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAkD08B,EAAIq5B,aAAap1D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACpG94B,QAAoD08B,EAAIs5B,cAAcr1D,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAyD08B,EAAIu5B,UAAUt1D,SACvEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACpG94B,QAAoD08B,EAAIilB,cAAchhD,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACpG94B,QAAsD08B,EAAIw5B,eAAev1D,SACzEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoB66C,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/E,IACC,MAAMoH,EAAwD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvG94B,QAAiD08B,EAAIy5B,WAAWx1D,SAChEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAkD08B,EAAI05B,aAAaz1D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,wBAAyB66C,EAAAwD,SAAS,yBAA0B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzF,IACC,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAAwD08B,EAAI25B,gBAAgB11D,SAC5Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA4C08B,EAAI0rB,UAAUznD,SAC1Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoB66C,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/E,IACC,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAA8C08B,EAAI4E,WAAW3gC,SAC7Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,iCAAkC66C,EAAAwD,SAAS,kCAAmC,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3G,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA0E08B,EAAI45B,yBAAyB31D,SACvGi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mCAAoCwL,EAAMC,MAAOovC,EAAAwD,SAAS,oCAAqC,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5H,IACC,MAAMoH,EAA8D,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC7G4D,EAAI65B,2BAA2B51D,SAC/Bi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mCAAoCwL,EAAMC,MAAOovC,EAAAwD,SAAS,oCAAqC,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5H,IACC,MAAMoH,EAA8D,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC7G4D,EAAI85B,2BAA2B71D,SAC/Bi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoB66C,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/E,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA8C08B,EAAI+5B,WAAW91D,SAC7Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAA4C08B,EAAIw3B,UAAUvzD,SAC1Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,0BAA2B66C,EAAAwD,SAAS,2BAA4B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7F,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkD08B,EAAIg6B,kBAAkB/1D,SACxEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,wBAAyB66C,EAAAwD,SAAS,yBAA0B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAwD08B,EAAIi6B,gBAAgBh2D,SAC5Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,0BAA2B66C,EAAAwD,SAAS,2BAA4B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7F,IACC,MAAMoH,EAAgE,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC/G94B,QAA4D08B,EAAIk6B,kBAAkBj2D,SAClFi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAoD08B,EAAI8rB,cAAc7nD,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAyD08B,EAAIm6B,YAAYl2D,SACzEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACnG94B,QAAkD08B,EAAIo6B,aAAan2D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAkD08B,EAAIq6B,aAAap2D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAA0D,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzG94B,QAAgD08B,EAAIs6B,YAAYr2D,SAChEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACpG94B,QAAgD08B,EAAIu6B,eAAet2D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAAoD08B,EAAIo3B,cAAcnzD,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACzE4D,EAAIw6B,UAAUv2D,SACdi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA4C08B,EAAIy6B,UAAUx2D,SAC1Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,wBAAyB66C,EAAAwD,SAAS,yBAA0B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzF,IACC,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAAwD08B,EAAIuH,gBAAgBtjC,SAC5Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,yBAA0B66C,EAAAwD,SAAS,0BAA2B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3F,IACC,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAA0D08B,EAAI06B,iBAAiBz2D,SAC/Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,gBAAiB66C,EAAAwD,SAAS,iBAAkB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzE,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAyC08B,EAAI26B,QAAQ12D,SACrDi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,wBAAyB66C,EAAAwD,SAAS,yBAA0B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzF,IACC,MAAMoH,EAAuD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACtG94B,QAAiD08B,EAAI46B,gBAAgB32D,SACrEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoB66C,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC/E,IACC,MAAMoH,EAAwD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvG94B,QAA8C08B,EAAI66B,WAAW52D,SAC7Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAAwD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACvG94B,QAAgD08B,EAAI86B,YAAY72D,SAChEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAgD08B,EAAI+6B,YAAY92D,SAChEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,gBAAiB66C,EAAAwD,SAAS,iBAAkB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzE,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAwC08B,EAAIg7B,QAAQ/2D,SACpDi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,iBAAkBwL,EAAMC,MAAOovC,EAAAwD,SAAS,kBAAmB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxF,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA0C08B,EAAIi7B,SAASh3D,SACvDi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,qBAAsB66C,EAAAwD,SAAS,sBAAuB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnF,IACC,MAAMoH,EAA6C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC5F94B,QAAkD08B,EAAIk7B,aAAaj3D,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACzE94B,QAA4C08B,EAAIm7B,UAAUl3D,SAC1Di2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwBwL,EAAM+kD,QAAS1V,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACtG,IACC,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAA0D08B,EAAIo7B,eAAen3D,SAC7Ei2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,aAAc66C,EAAAwD,SAAS,cAAe,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnE,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACzE4D,EAAI6tB,KAAK5pD,SACTi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,wBAAyBwL,EAAMW,QAAS0uC,EAAAwD,SAAS,yBAA0B,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACxG,IACC,MAAMoH,EAA0B,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACzE4D,EAAI+jB,gBAAgB9/C,SACpBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,sBAAuB66C,EAAAwD,SAAS,uBAAwB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACrF,IACC,MAAMoH,EAAoD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACnG4D,EAAIq7B,cAAcp3D,SAClBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,iBAAkB66C,EAAAwD,SAAS,kBAAmB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3E,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAClG4D,EAAIs7B,SAASr3D,SACbi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,eAAgB66C,EAAAwD,SAAS,gBAAiB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvE,IACC,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAwD08B,EAAIp3B,OAAO3E,SACnEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,gBAAiB66C,EAAAwD,SAAS,iBAAkB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzE,IACC,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAA0D08B,EAAIu7B,QAAQt3D,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,gBAAiB66C,EAAAwD,SAAS,iBAAkB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACzE,IACC,MAAMoH,EAAkD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QACjG94B,QAA0D08B,EAAIw7B,QAAQv3D,SACtEi2C,EAAA94B,aAAalG,KAAKpS,EAAKuY,EAAK/d,GACjC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAA+C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC9F4D,EAAIy7B,UAAUx3D,SACdi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,aAAc66C,EAAAwD,SAAS,cAAe,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACnE,IACC,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC/F4D,EAAI07B,KAAKz3D,SACTi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,eAAgB66C,EAAAwD,SAAS,gBAAiB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvE,IACC,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC/F4D,EAAI27B,OAAO13D,SACXi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,uBAAwB66C,EAAAwD,SAAS,wBAAyB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvF,IACC,MAAMoH,EAAyD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACxG4D,EAAIi1B,eAAehxD,SACnBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAAgD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cAC/F4D,EAAI47B,YAAY33D,SAChBi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,mBAAoBwL,EAAMC,MAAOovC,EAAAwD,SAAS,oBAAqB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC5F,IACC,MAAMoH,EAAqD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,cACpG4D,EAAI67B,WAAW53D,SACfi2C,EAAA94B,aAAa66B,GAAGnzC,EAAKuY,GAC1B,MAAOvU,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,kBAAmB66C,EAAAwD,SAAS,mBAAoB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC7E,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAI87B,UAAU73D,SAC/Ci2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAI+7B,YAAY93D,SACjDi2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,oBAAqB66C,EAAAwD,SAAS,qBAAsB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjF,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAIg8B,YAAY/3D,SACjDi2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,YAAa66C,EAAAwD,SAAS,aAAc,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACjE,IACC,MAAMoH,EAA8C,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAC7F94B,QAAiC08B,EAAIi8B,IAAIh4D,SACzCi2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,eAAgB66C,EAAAwD,SAAS,gBAAiB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBACvE,IACC,MAAMoH,EAAiD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAChG94B,QAAiC08B,EAAIp0B,OAAO3H,SAC5Ci2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,OAIrCyvC,EAAOv8C,IAAI,iBAAkB66C,EAAAwD,SAAS,kBAAmB,CAAOv1C,EAAKuY,IAAO4oB,EAAAptC,UAAA,qBAC3E,IACC,MAAMoH,EAAmD,CAAChE,MAAO6I,EAAI7I,MAAOwG,KAAMqC,EAAIrC,KAAM21B,OAAQtzB,EAAIszB,QAClG94B,QAAiC08B,EAAIwuB,SAASvqD,SAC9Ci2C,EAAA94B,aAAa2sB,OAAOjlC,EAAKuY,EAAK/d,GACnC,MAAOwJ,SACFotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAKvU,uFCnwBtC,MAAAwiD,EAAA/3D,EAAA,IACA2iD,EAAA3iD,EAAA,IACA4pB,EAAA5pB,EAAA,IAGM2kE,EAAoB3kE,EAAQ,KAC5BuwB,EAAyBvwB,EAAQ,KAEvCE,EAAA4mD,SAAA,SAAyBnmD,GAQxB,OAPA,SAAmC4Q,EAAsBuY,EAAuB+Q,GAC/Ek9B,EAAAznC,uBAAuB3vB,EAAM4Q,EAAKgf,EAASo0C,EAAmB,OAAOz2C,KAAK,KACzE2M,MACEzM,MAAO7Y,IACTotC,EAAA94B,aAAa/Y,MAAMS,EAAKuY,EAAK,CAACU,KAAMZ,EAAAtX,OAAOiJ,KAAKE,UAAWiP,KAAMnV,EAAExP,ivkKCdtE5F,EAAAD,QAAAmC,QAAA,6KCAA,MAAA6D,EAAAzB,EAAAzE,EAAA,IA4DA,SAAgB4kE,EAAatyC,GAC5B,MAAMvmB,EAAiBumB,EAIvB,OAHAvmB,EAAO8mB,YAAc,CAAC7N,GACd9e,EAAAxB,QAAKsI,QAAQslB,EAAO5B,MAAM/M,QAASqB,IAEpCjZ,EALR7L,EAAA0kE,eAUA1kE,EAAAqyB,WAAA,SAA2BsyC,GAC1BA,EAAaA,GAAcA,EAAWx9D,OAAS,EAAIw9D,EAAa3+D,EAAAxB,QAAKkB,KAAKwsB,QAAQ8U,MAAO,UACzF,MAAM49B,EAAa5+D,EAAAxB,QAAKkB,KAAKi/D,EAAY,aACnCE,EAAuB7+D,EAAAxB,QAAKkB,KAAKi/D,EAAY,wBACnD,IAAIvyC,EAQJ,OAPIjwB,SACHiwB,EAASjwB,QAAwByiE,IAC1B7rC,WAAa52B,QAAwB0iE,IAE5CzyC,EAAStyB,EAAA,GAAAA,CAAQ8kE,IACV7rC,WAAaj5B,EAAA,GAAAA,CAAQ+kE,GAEtBH,EAAatyC,kcClFrB,MAAA0yC,EAAAhlE,EAAA,KACAilE,EAAAjlE,EAAA,KACAklE,EAAAllE,EAAA,KACAmlE,EAAAnlE,EAAA,KACAolE,EAAAplE,EAAA,KACAqlE,EAAArlE,EAAA,KACAslE,EAAAtlE,EAAA,KACAulE,EAAAvlE,EAAA,KACAwlE,EAAAxlE,EAAA,KACAylE,EAAAzlE,EAAA,KACA0lE,EAAA1lE,EAAA,KACA2lE,EAAA3lE,EAAA,KACA4lE,EAAA5lE,EAAA,KAIA+b,EAAAtX,EAAAzE,EAAA,IACA6lE,EAAA7lE,EAAA,KACA8lE,EAAA9lE,EAAA,KAEY+b,EAAArX,QAAO,SAEnBxE,EAAA4yB,MAAA,MAiBCztB,YAAmBsC,GAAArC,KAAAqC,KAClBrC,KAAKoxB,cAAgB,IAAIovC,EAAAC,cAAczgE,KAAKqC,IAC5CrC,KAAKsd,WAAa,IAAIqiD,EAAAe,WAAW1gE,KAAKqC,IACtCrC,KAAK+c,YAAc,IAAI6iD,EAAAe,YAAY3gE,KAAKqC,IACxCrC,KAAK2xB,UAAY,IAAI+tC,EAAAkB,UAAU5gE,KAAKqC,IACpCrC,KAAKsiB,WAAa,IAAIg+C,EAAAO,WAAW7gE,KAAKqC,IACtCrC,KAAK4iB,cAAgB,IAAIy9C,EAAAS,cAAc9gE,KAAKqC,IAC5CrC,KAAKkzB,aAAe,IAAIktC,EAAAW,aAAa/gE,KAAKqC,IAC1CrC,KAAK+yB,aAAe,IAAI8sC,EAAAmB,aAAahhE,KAAKqC,IAC1CrC,KAAK0iB,cAAgB,IAAIy9C,EAAAc,cAAcjhE,KAAKqC,IAC5CrC,KAAKwgB,YAAc,IAAIu/C,EAAAmB,YAAYlhE,KAAKqC,IACxCrC,KAAKkhB,WAAa,IAAI4+C,EAAAqB,WAAWnhE,KAAKqC,IACtCrC,KAAK4xB,eAAiB,IAAIquC,EAAAmB,eAAephE,KAAKqC,IAC9CrC,KAAK0zB,WAAa,IAAIssC,EAAAqB,WAAWrhE,KAAKqC,IACtCrC,KAAKsjB,UAAY,IAAI48C,EAAAoB,UAAUthE,KAAKqC,IACpCrC,KAAKqzB,UAAY,IAAIktC,EAAAgB,cAAcvhE,KAAKqC,IAGnCtC,sDACCC,KAAKqC,GAAGwrB,UAGT9tB,sDACCC,KAAKqC,GAAGm/D,UAGTzhE,qDACCC,KAAKqC,GAAGyrB,SAGT/tB,sDACCC,KAAKqC,GAAG0rB,UAGThuB,UAAU8C,2CACf,MAAM4+D,EACL,CAACzhE,KAAK+c,YAAa/c,KAAKsd,WAAYtd,KAAKkhB,WAAYlhB,KAAKwgB,YAAaxgB,KAAKkzB,aAAclzB,KAAK+yB,aAAc/yB,KAAK4iB,cAAe5iB,KAAKwgB,YAAaxgB,KAAKkhB,WAAYlhB,KAAK0zB,WAAY1zB,KAAK2xB,WAC3L,IAAK,MAAM3rB,KAASy7D,EAAQ,CAC3B,MAAM91D,QAAY3F,EAAMjD,KAAKF,GAC7B,GAAI8I,EACH,OAAOA,KAKJ5L,eAAeiD,2CACpB,IAAIyD,EAA0B,GAC9B,MAAMg7D,EACL,CAACzhE,KAAK+c,YAAa/c,KAAKsd,WAAYtd,KAAKkhB,WAAYlhB,KAAKwgB,YAAaxgB,KAAKkzB,aAAclzB,KAAK+yB,aAAc/yB,KAAK4iB,cAAe5iB,KAAKwgB,YAAaxgB,KAAKkhB,WAAYlhB,KAAK0zB,WAAY1zB,KAAK2xB,WAC3L,IAAK,MAAM3rB,KAASy7D,EAAQ,CAC3B,MAAMhN,QAAazuD,EAAM/C,MAAMD,GAC/ByD,EAASA,EAAOpG,OAAOo0D,GAExB,OAAOhuD,qFC5FT,MAAAsG,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GASAE,EAAAgmE,UAAA,cAA+Bc,EAAAv/D,UAE9BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAa8M,KAAMvH,GAGhBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAId,OAHAC,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAE89D,KAAK,cAAev+D,EAAMyqD,SAC5BhqD,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,oFCrBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAGAoS,EAAApS,EAAA,GAsBAE,EAAA8lE,WAAA,cAAgCgB,EAAAv/D,UAiB/BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAasV,MAAO/P,GAjB3BrC,KAAA0E,SAAuC,CACtC6L,KAAQ,OACRF,SAAY,WACZq5C,UAAa,WACbnsC,OAAU,SACVmD,QAAW,SACX/P,SAAY,WACZrS,OAAU,aACVmoB,UAAa,gBACbhW,MAAS,YACTjS,MAAS,YACTwS,KAAQ,WACRC,MAAS,YACTC,QAAW,gBAOFnR,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAkBd,OAjBAC,EAAEM,MAAM,WAAYf,EAAMsmD,WAC1B7lD,EAAEE,KAAK,OAAQX,EAAMmN,MACrB1M,EAAEK,YAAY,OAAQd,EAAMooD,QAAUpoD,EAAMooD,QAAQl/C,IAAIzP,GAAKiQ,EAAAhL,4BAA4BjF,SAAM2H,GAC/FX,EAAEI,WAAW,OAAQb,EAAM+Z,OAASrQ,EAAAhL,4BAA4BsB,EAAM+Z,aAAU3Y,GAChFX,EAAEE,KAAK,YAAaX,EAAM6N,OAC1BpN,EAAEE,KAAK,SAAUX,EAAMma,QACvB1Z,EAAEM,MAAM,SAAUf,EAAMsd,SACxB7c,EAAEE,KAAK,WAAYX,EAAMiN,UACzBxM,EAAEE,KAAK,gBAAiBX,EAAMqjB,WAC9B5iB,EAAEM,MAAM,gBAAiBf,EAAMinC,YAC/BxmC,EAAEE,KAAK,aAAcX,EAAM9E,QAC3BuF,EAAEE,KAAK,YAAaX,EAAMqN,OAC1B5M,EAAEG,MAAM,YAAaZ,EAAMA,OAC3BS,EAAEE,KAAK,YAAaX,EAAM5E,OAC1BqF,EAAEE,KAAK,WAAYX,EAAMuN,UACzB9M,EAAEY,MAAM,WAAYrB,EAAMwkD,OAAQxkD,EAAMukD,UACxC9jD,EAAEY,MAAM,oBAAgBD,EAAWpB,EAAMskD,WAClC7jD,EAAElI,IAAIyH,EAAOpD,KAAK0E,2FClE3B,MAAAqI,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAGAoS,EAAApS,EAAA,GAsBAE,EAAA+lE,YAAA,cAAiCe,EAAAv/D,UAgBhCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAayR,OAAQlM,GAhB5BrC,KAAA0E,SAAuC,CACtC2L,SAAY,WACZq5C,UAAa,WACbnsC,OAAU,SACVjf,OAAU,aACVmS,MAAS,YACTrO,KAAQ,WACR4O,KAAQ,WACRE,QAAW,eACX1S,MAAS,YACT+R,KAAQ,OACRjR,MAAS,YACT2R,MAAS,aAOAlR,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAkBd,OAjBAC,EAAEE,KAAK,OAAQX,EAAMmN,MACrB1M,EAAEI,WAAW,OAAQb,EAAM+Z,OAASrQ,EAAAhL,4BAA4BsB,EAAM+Z,aAAU3Y,GAChFX,EAAEE,KAAK,gBAAiBX,EAAM2X,WAC9BlX,EAAEE,KAAK,iBAAkBX,EAAM2U,YAC/BlU,EAAEE,KAAK,YAAaX,EAAM6N,OAC1BpN,EAAEE,KAAK,YAAaX,EAAMqN,OAC1B5M,EAAEE,KAAK,YAAaX,EAAM5E,OAC1BqF,EAAEE,KAAK,SAAUX,EAAMma,QACvB1Z,EAAEE,KAAK,WAAYX,EAAMiN,UACzBxM,EAAEM,MAAM,WAAYf,EAAMsmD,WAC1B7lD,EAAEE,KAAK,YAAaX,EAAM9D,OAC1BuE,EAAEE,KAAK,aAAcX,EAAM9E,QAC3BuF,EAAEM,MAAM,aAAcf,EAAMyY,SAC5BhY,EAAEM,MAAM,WAAYf,EAAMic,OAC1Bxb,EAAEY,MAAM,WAAYrB,EAAMwkD,OAAQxkD,EAAMukD,UACxC9jD,EAAEY,MAAM,oBAAgBD,EAAWpB,EAAMskD,WACzC7jD,EAAEG,MAAM,YAAaZ,EAAMA,OACpBS,EAAElI,IAAIyH,EAAOpD,KAAK0E,2FCjE3B,MAAAqI,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAYAE,EAAAomE,aAAA,cAAkCU,EAAAv/D,UAUjCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAayW,QAASlR,GAV7BrC,KAAA0E,SAAuC,CACtCuiD,WAAc,YACd7yC,UAAa,YACbhH,OAAU,SACVU,KAAQ,OACRzS,KAAQ,OACR6V,QAAW,gBAOFnR,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAOd,OANAC,EAAEM,MAAM,YAAaf,EAAM6jD,YAC3BpjD,EAAEE,KAAK,YAAaX,EAAMgR,WAC1BvQ,EAAEE,KAAK,SAAUX,EAAMgK,QACvBvJ,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEY,MAAM,YAAQD,EAAWpB,EAAMskD,WACjC7jD,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,EAAOpD,KAAK0E,2FCnC3B,MAAAqI,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAsBAE,EAAAumE,WAAA,cAAgCO,EAAAv/D,UAE/BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAa0B,MAAO6D,GAGjBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAgBd,OAfAC,EAAEE,KAAK,UAAWX,EAAMma,QACxB1Z,EAAEE,KAAK,WAAYX,EAAMuN,UACzB9M,EAAEE,KAAK,QAASX,EAAM6N,OACtBpN,EAAEE,KAAK,YAAaX,EAAM2X,WAC1BlX,EAAEE,KAAK,aAAcX,EAAM2U,YAC3BlU,EAAEE,KAAK,WAAYX,EAAMigB,SACzBxf,EAAEE,KAAK,YAAaX,EAAMoV,WAC1B3U,EAAEM,MAAM,YAAaf,EAAMud,YAC3B9c,EAAEM,MAAM,WAAYf,EAAM0N,UAC1BjN,EAAEE,KAAK,SAAUX,EAAM9E,QACvBuF,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEE,KAAK,OAAQX,EAAM8X,MACrBrX,EAAEY,MAAM,OAAQrB,EAAMwkD,OAAQxkD,EAAMukD,UACpC9jD,EAAEY,MAAM,eAAWD,EAAWpB,EAAMskD,WACpC7jD,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,oFC9Cf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAuBAE,EAAAsmE,YAAA,cAAiCQ,EAAAv/D,UAEhCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAawB,OAAQ+D,GAGlBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAed,OAdAC,EAAEM,MAAM,WAAYf,EAAM0N,UAC1BjN,EAAEM,MAAM,OAAQf,EAAMymC,OACtBhmC,EAAEE,KAAK,UAAWX,EAAMma,QACxB1Z,EAAEE,KAAK,WAAYX,EAAM6P,SACzBpP,EAAEE,KAAK,WAAYX,EAAMigB,SACzBxf,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEE,KAAK,aAAcX,EAAMoV,WAC3B3U,EAAEM,MAAM,aAAcf,EAAMud,YAC5B9c,EAAEE,KAAK,OAAQX,EAAM8X,MAErBrX,EAAEE,KAAK,aAAcX,EAAM2U,YAE3BlU,EAAEY,MAAM,eAAWD,EAAWpB,EAAMskD,WACpC7jD,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,oFC9Cf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAUAE,EAAAymE,WAAA,cAAgCK,EAAAv/D,UAE/BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAa6Y,MAAOtT,GAGjBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAKd,OAJAC,EAAEE,KAAK,MAAOX,EAAM8D,KACpBrD,EAAEE,KAAK,WAAYX,EAAM0S,UACzBjS,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,oFCvBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAQAE,EAAAwmE,eAAA,cAAoCM,EAAAv/D,UAEnCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAayY,UAAWlT,GAGrBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAEd,OADAC,EAAEE,KAAK,SAAUX,EAAM2R,QAChBlR,EAAElI,IAAIyH,oFClBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GASAE,EAAA0mE,UAAA,cAA+BI,EAAAv/D,UAE9BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAakR,KAAM3L,GAGhBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAId,OAHAC,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEE,KAAK,OAAQX,EAAMmN,MACrB1M,EAAEG,MAAM,OAAQZ,EAAMA,OACfS,EAAElI,IAAIyH,oFCrBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAUAE,EAAAqmE,cAAA,cAAmCS,EAAAv/D,UAElCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAaoY,SAAU7S,GAGpBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAId,OAHAC,EAAEE,KAAK,SAAUX,EAAM2R,QACvBlR,EAAEE,KAAK,SAAUX,EAAMwzC,QACvB/yC,EAAEM,MAAM,SAAUf,EAAMmf,SACjB1e,EAAElI,IAAIyH,oFCtBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAWAE,EAAAmmE,aAAA,cAAkCW,EAAAv/D,UASjCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAawS,QAASjN,GAT7BrC,KAAA0E,SAAuC,CACtCwC,IAAO,MACPuJ,MAAS,YACTrD,OAAU,SACVhK,MAAS,YACT8N,QAAW,WAOFnR,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAMd,OALAC,EAAEE,KAAK,MAAOX,EAAM8D,KACpBrD,EAAEE,KAAK,YAAaX,EAAMqN,OAC1B5M,EAAEE,KAAK,SAAUX,EAAMgK,QACvBvJ,EAAEY,MAAM,eAAWD,EAAWpB,EAAMskD,WACpC7jD,EAAEG,MAAM,YAAaZ,EAAMA,OACpBS,EAAElI,IAAIyH,EAAOpD,KAAK0E,2FChC3B,MAAAqI,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAaAE,EAAAkmE,cAAA,cAAmCY,EAAAv/D,UAElCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAa0X,SAAUnS,GAGpBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAQd,OAPAC,EAAEE,KAAK,WAAYX,EAAMigB,SACzBxf,EAAEM,MAAM,WAAYf,EAAM0N,UAC1BjN,EAAEE,KAAK,SAAUX,EAAM2R,QACvBlR,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAE89D,KAAK,WAAYv+D,EAAMuR,UACzB9Q,EAAEG,MAAM,OAAQZ,EAAMA,OACtBS,EAAEY,MAAM,eAAWD,EAAWpB,EAAMskD,WAC7B7jD,EAAElI,IAAIyH,oFC7Bf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAeAE,EAAAimE,WAAA,cAAgCa,EAAAv/D,UAE/BpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAaoJ,MAAO7D,GAGjBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAQd,OAPAC,EAAEE,KAAK,SAAUX,EAAM2R,QACvBlR,EAAEE,KAAK,SAAUX,EAAMwzC,QACvB/yC,EAAEM,MAAM,SAAUf,EAAMmf,SACxB1e,EAAEE,KAAK,WAAYX,EAAMhB,MACzByB,EAAEO,QAAQ,QAAShB,EAAM+zC,SACzBtzC,EAAEY,MAAM,QAASrB,EAAMw+D,UAAWx+D,EAAM2zC,WACxClzC,EAAEY,MAAM,cAAUD,EAAWpB,EAAM8zC,SAAW,OAAI1yC,GAC3CX,EAAElI,IAAIyH,oFC/Bf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAUAE,EAAA2mE,cAAA,cAAmCG,EAAAv/D,UAElCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAamuC,SAAU5oC,GAGpBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAGd,OAFAC,EAAEE,KAAK,OAAQX,EAAM/H,MACrBwI,EAAEE,KAAK,WAAYX,EAAM0nC,UAClBjnC,EAAElI,IAAIyH,oFCrBf,MAAA2J,EAAArS,EAAA,GACAgnE,EAAAhnE,EAAA,GAQAE,EAAA6lE,cAAA,cAAmCiB,EAAAv/D,UAElCpC,YAAYsC,GACXkD,MAAMwH,EAAAjQ,aAAa4d,SAAUrY,GAGpBtC,eAAeqD,GACxB,MAAMS,EAAI,IAAI69D,EAAA99D,YAEd,OADAC,EAAEE,KAAK,UAAWX,EAAMiqC,SACjBxpC,EAAElI,IAAIyH,mcClBf,MAAAy+D,EAAA1iE,EAAAzE,EAAA,MACAqS,EAAArS,EAAA,GACAonE,EAAApnE,EAAA,KACA+b,EAAAtX,EAAAzE,EAAA,IACAqnE,EAAArnE,EAAA,KACAsnE,EAAAtnE,EAAA,KAKM6F,EAAMkW,EAAArX,QAAO,cAEnB,MAAa6iE,EAOZliE,YAAYqC,EAAoBC,GAC/BrC,KAAKoC,KAAOA,OACCoC,IAATpC,GACHpC,KAAKkiE,OAAS7/D,EAAG8/D,UAAU,KAC3BniE,KAAKoiE,MAAQ,KAEbpiE,KAAKoiE,MAAQr1D,EAAAjQ,aAAasF,GAC1BpC,KAAKkiE,OAAS7/D,EAAG8/D,UAAUp1D,EAAAjQ,aAAasF,KAEzCpC,KAAKqiE,KAAON,EAAAO,QAAQtiE,KAAKoiE,OACzBpiE,KAAKqC,GAAKA,EAGHtC,QAAQwiE,GAGf,OAFAA,EAAIC,QAAQ3/D,GAAK0/D,EAAIC,QAAQ3/D,GAAGpC,WAChC8hE,EAAIC,QAAQpgE,KAAO2K,EAAAjQ,aAAaylE,EAAIH,OAC1BG,EAAIC,QAGPziE,iBAAiBxE,GACxB,MAAMkL,EAAcjL,OAAO+N,OAAO,GAAIhO,GAEtC,OADAkL,EAAOrE,UAAOoC,EACPiC,EAGA1G,mBAAmB1D,GAC1B,MAAMqjB,EAAQrjB,EAAI8e,MAAM,KACxB,IAAI5f,EAAIyE,KAAKqiE,KACb,IAAK,MAAMzlE,KAAK8iB,EACfnkB,EAAIA,EAAEknE,WAAW7lE,GAElB,OAAOrB,EAGAwE,sBAAsBqD,GAC7B,GAAIA,EAAMD,IACT,MAAO,CAACu/D,UAAW,IAEpB,IAAIC,EAAmB,GACvB,GAAIv/D,EAAMW,KAAM,CACf,MAAMxI,EAAI6H,EAAMW,KAChB4+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GACZgiC,EAAO/lC,KAAK4iE,mBAAmBvmE,GASrC,OARK0pC,GACJ7b,QAAQ3pB,IAAI,eAAgBP,KAAKoiE,MAAO/lE,GAErC0pC,GAAsB,SAAdA,EAAK3jC,KAChB2B,EAAK1H,EAAM,YAAcd,EAAEc,GAE3B0H,EAAK1H,GAAOd,EAAEc,GAER,CAAC0H,KAAQA,MAInB,GAAIX,EAAMe,MAAO,CAChB,MAAM5I,EAAI6H,EAAMe,MAChBw+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GACZgiC,EAAO/lC,KAAK4iE,mBAAmBvmE,GASrC,OARK0pC,GACJ7b,QAAQ3pB,IAAI,eAAgBP,KAAKoiE,MAAO/lE,GAErC0pC,GAAsB,SAAdA,EAAK3jC,KAChB2B,EAAK1H,EAAM,YAAcd,EAAEc,GAE3B0H,EAAK1H,GAAOd,EAAEc,GAER,CAAC8H,MAASJ,MAIpB,GAAIX,EAAMY,MAAO,CAChB,MAAMzI,EAAI6H,EAAMY,MAChB2+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAOd,EAAEc,GACP,CAACwmE,oBAAuB9+D,MAIlC,GAAIX,EAAMa,WAAY,CACrB,MAAM1I,EAAI6H,EAAMa,WAChB0+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAOd,EAAEc,GACP,CAACymE,OAAU/+D,MAIrB,GAAIX,EAAMc,YAAa,CACtB,MAAM3I,EAAI6H,EAAMc,YAChB1I,OAAOmJ,KAAKpJ,GAAGsJ,QAAQxI,IACtBd,EAAEc,GAAKwI,QAAQhI,IACd,MAAMkH,EAAY,GAClBA,EAAK1H,GAAOQ,EACZ8lE,EAAKt+D,KAAK,CAACy+D,OAAU/+D,QAIxB,GAAIX,EAAMqB,MAAO,CAChB,MAAMlJ,EAAI6H,EAAMqB,MAChBk+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM8tC,EAAO5uC,EAAEc,GACT0H,EAAY,GAElB,OADAA,EAAK1H,GAAO,CAACkI,IAAO4lC,EAAK5lC,IAAKD,IAAO6lC,EAAK7lC,KACnC,CAACG,MAASV,MAIpB,GAAIX,EAAMgB,QAAS,CAClB,MAAM7I,EAAI6H,EAAMgB,QAChBu+D,EAAOA,EAAKtiE,OAAO9E,EAAE+Q,IAAIjQ,IACjB,CAAC0mE,OAAU,CAACj/D,MAASzH,OAG9B,MAAO,CACNslE,KAAM,CACLgB,KAAMA,IAKK5iE,OAAO+H,EAA2Ck7D,2CAC/D,IAAI1/D,EAAQ,EACZ,MAAMi8B,EAASv/B,KAAKqC,GAAGk9B,aAEvB,SAAe0jC,EAAiBz+C,2CAG/B,GAFAlhB,GAASkhB,EAAI0+C,KAAKA,KAAKnhE,aACjBihE,EAAOx+C,EAAI0+C,KAAKA,MAClB1+C,EAAI0+C,KAAKC,QAAU7/D,GAASkhB,EAAI4+C,WAAY,CAE/C,MAAM7tC,QAAagK,EAAO8jC,OAAU,CAACC,SAAU9+C,EAAI4+C,WAAYC,OAAQ,cACjEJ,EAAiB1tC,MAInB0tC,CAAiBn7D,KAGlB/H,mDACL,aAAaC,KAAKqC,GAAGG,aAGhBzC,IAAIgI,2CAWT,OAVKA,EAAKlF,IAAyB,IAAnBkF,EAAKlF,GAAGd,SACvBgG,EAAKlF,SAAW7C,KAAKwC,kBAEhBxC,KAAKqC,GAAGk9B,OAAOzvB,MAAM,CAC1BA,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM/H,KAAKujE,iBAAiBx7D,GAC5BlF,GAAIkF,EAAKlF,GACTyrB,QAAgCtuB,KAAKqC,GAAGmhE,eAElCz7D,EAAKlF,KAGP9C,KAAK0jE,2CACV,IAAK,MAAM17D,KAAQ07D,cACNzjE,KAAK0C,IAAIqF,KAIjBhI,QAAQ8C,EAAYkF,iDACnB/H,KAAKqC,GAAGk9B,OAAOzvB,MAAM,CAC1BA,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM/H,KAAKujE,iBAAiBx7D,GAC5BlF,KACAyrB,QAAgCtuB,KAAKqC,GAAGmhE,iBAIpCzjE,OAAO8C,EAAYkF,2CACnBlF,GAAoB,IAAdA,EAAGd,aAIR/B,KAAKqC,GAAGk9B,OAAOzvB,MAAM,CAC1BA,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM/H,KAAKujE,iBAAiBx7D,GAC5BlF,KACAyrB,QAAgCtuB,KAAKqC,GAAGmhE,qBARlCxjE,KAAK0C,IAAIqF,KAYXhI,cAAcqD,2CASnB,aARuBpD,KAAKqC,GAAGk9B,OAAOmkC,cAAc,CACnD5zD,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,IAEnCkrB,QAAgCtuB,KAAKqC,GAAGmhE,gBAEzB1nB,UAGX/7C,OAAO8C,2CACZ,GAAkB,IAAdA,EAAGd,OACN,OAAO0F,QAAQC,UAEZsiB,MAAMC,QAAQpnB,SACX7C,KAAKqC,GAAGk9B,OAAOmkC,cAAc,CAClC5zD,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM,CACL3E,MAAO,CACNe,MAAS,CACRy/D,IAAO/gE,KAIVyrB,QAAgCtuB,KAAKqC,GAAGmhE,qBAGnCxjE,KAAKqC,GAAGk9B,OAAOuyB,OAAO,CAC3BhiD,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXv/D,GAAYA,EACZyrB,QAAgCtuB,KAAKqC,GAAGmhE,iBAKrCzjE,KAAK8C,2CACV,QAAkB2B,IAAdxE,KAAKoC,KACR,aAAapC,KAAKkD,SAAS,CAACa,KAAM,CAAClB,GAAIA,KAEvC,IACC,MAAMiF,QAAiB9H,KAAKqC,GAAGk9B,OAAO5jC,IAAI,CACzCmU,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXv/D,GAAIA,IAEL,OAAKiF,EAASk6B,MAGNhiC,KAAK6jE,QAAQ/7D,QAFpB,EAIA,MAAOmI,GACa,MAAjBA,EAAE0Y,YACLlhB,QAAQE,OAAOsI,MAMblQ,MAAMiD,2CACX,GAAmB,IAAfA,EAAIjB,OACP,MAAO,GAER,MAAM+F,QAAiB9H,KAAKqC,GAAGk9B,OAAOukC,KAAK,CAC1Ch0D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM,CAAC/E,IAAOA,KAEf,OAAK8E,EAASi8D,KAGPj8D,EAASi8D,KAAK3sD,OAAQ4sD,GACrBA,EAAIhiC,OACT11B,IAAK03D,GACAhkE,KAAK6jE,QAAQG,IALb,KASHjkE,MAAMqD,2CACX,IAAIgF,EAAiB,GACrB,MAAMN,QAAiB9H,KAAKqC,GAAGk9B,OAAOxzB,OAAU,CAC/C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXiB,OAAQ,MACR12D,KAAM,IACN5E,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,MAMpC,aAHMpD,KAAKqjE,OAAOv7D,EAAiBo7D,GAAQ91B,EAAAptC,UAAA,qBAC1CoI,EAAOA,EAAK/H,OAAO6iE,EAAK52D,IAAItM,KAAK6jE,aAE3Bz7D,IAGFrI,SAASqD,2CACd,MAAM0E,QAAiB9H,KAAKqC,GAAGk9B,OAAOxzB,OAAO,CAC5C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXz1D,KAAM,EACN5E,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,MAGpC,GAAI0E,EAASo7D,KAAKC,MAAQ,EACzB,OAAOnjE,KAAK6jE,QAAQ/7D,EAASo7D,KAAKA,KAAK,MAKnCnjE,QAAQqD,EAAsB6gE,2CACnC,MAAMn8D,QAAiB9H,KAAKqC,GAAGk9B,OAAOxzB,OAAU,CAC/C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXiB,OAAQ,MACR12D,KAAM,IACN5E,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,YAG9BpD,KAAKqjE,OAAOv7D,EAAiBo7D,GAAQ91B,EAAAptC,UAAA,2BACpCikE,EAAOf,EAAK52D,IAAItM,KAAK6jE,eAIvB9jE,SAASqD,2CACd,IAAIgF,EAAsB,GAC1B,MAAMN,QAAiB9H,KAAKqC,GAAGk9B,OAAOxzB,OAAU,CAC/C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXiB,OAAQ,MACRt7D,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,GAClC8gE,cAAe,MAMjB,aAHMlkE,KAAKqjE,OAAOv7D,EAAiBo7D,GAAQ91B,EAAAptC,UAAA,qBAC1CoI,EAAOA,EAAK/H,OAAO6iE,EAAK52D,IAAIi2D,GAAOA,EAAIqB,IAAInjE,gBAErC2H,IAGFrI,UAAUqD,EAAsBU,2CAerC,aAduB9D,KAAKqC,GAAGk9B,OAAOxzB,OAAO,CAC5C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,GAClC+gE,KAAQ,CACPC,OAAU,CACTC,YAAe,CACdvgE,MAASA,SAMEwgE,aAAaF,OAAOroE,QAG/BgE,MAAMqD,2CASX,aARuBpD,KAAKqC,GAAGk9B,OAAOxzB,OAAO,CAC5C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXz1D,KAAM,EACN5E,KAAM,CACL3E,MAAOpD,KAAK2jE,sBAAsBvgE,OAGpB8/D,KAAKC,QAGhBpjE,SAASwkE,2CAMd,aALuBvkE,KAAKqC,GAAGk9B,OAAOxzB,OAAO,CAC5C+D,MAAO9P,KAAKkiE,OACZ9/D,KAAMpC,KAAKoiE,MACXr6D,KAAM,CAACo8D,KAAQ,CAACK,SAAY,CAACrgE,MAAS,CAACL,MAASygE,SAEjCD,aAAaE,SAASC,QAAQn4D,IAAKi2D,GAAaA,EAAIlmE,QA9XtEzB,EAAAqnE,iBAmYArnE,EAAAwyB,UAAA,MAMCrtB,YAAYitB,GACXhtB,KAAKu/B,OAAS,IAAIsiC,EAAAziE,QAAcslE,OAAO,CAAC9gC,KAAM5W,EAAO4W,KAAMrjC,IAAKysB,EAAOzsB,MACvEP,KAAK2kE,SAAW,IAAI7C,EAAA8C,WAAW5kE,KAAKu/B,QACpCv/B,KAAK6kE,YAAc73C,EAAO63C,YAC1B7kE,KAAKwjE,aAAex2C,EAAOw2C,aAGtBzjE,+CACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,iBACjB9kE,KAAK+kE,WAAW3iE,KAIlBrC,gDACLC,KAAKu/B,OAAOxR,UAGPhuB,+CACL,UACOC,KAAKu/B,OAAOyxB,KAA+B,CAACgU,eAAgB,MACjE,MAAO/0D,GAER,OADA1P,EAAIiL,MAAM,uCAAwCyE,GAC3CxI,QAAQE,OAAOsI,MAIlBlQ,+CACLQ,EAAIid,MAAM,0CACJxd,KAAK2kE,SAASl4B,KAAKzsC,KAAKu/B,cACxBv/B,KAAKgxD,aACLhxD,KAAKwhE,UAGNzhE,mDAEL,aADyBC,KAAK2kE,SAAShpE,IAAIqE,KAAKmiE,UAAU,QAChD1hE,aAGXV,UAAU1E,GACT,OAAO2E,KAAK6kE,YAAc,IAAMxpE,EAGzB0E,WACP,OAAOvE,OAAOmJ,KAAKoI,EAAAjQ,cACjBsa,OAAO/a,IAAQoW,MAAMyJ,OAAO7f,KAC5BiQ,IAAIjQ,GAAO4R,SAAS5R,EAAK,KAGd0D,WAAWqC,2CACxB,MAAM0N,EAAQ9P,KAAKmiE,UAAUp1D,EAAAjQ,aAAasF,WACrBpC,KAAKu/B,OAAO0lC,QAAQlC,OAAO,CAACjzD,mBAE1C9P,KAAKu/B,OAAO0lC,QAAQnT,OAAO,CAAChiD,aAI9B/P,gDACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,iBACjB9kE,KAAK+kE,WAAW3iE,KAIVrC,YAAYqC,2CACzB,MAAM/G,EAAO0R,EAAAjQ,aAAasF,GAC1B,IAAK2/D,EAAAO,QAAQjnE,GACZ,OAAOoM,QAAQE,OAAOvC,MAAM,0CAA4C/J,IAEzE,MAAMyU,EAAQ9P,KAAKmiE,UAAU9mE,GACvBH,EAAS,CACfgqE,UAAiB,CAACA,UAAa,CAACC,gBAAkB,KAClDjqE,EAAEG,GAAQ0mE,EAAAO,QAAQjnE,SACZ2E,KAAKu/B,OAAO0lC,QAAQ7oE,OAAO,CAAC0T,QAAO/H,KAAM,CAACq9D,SAAYlqE,OAG/C6E,WAAWqC,2CACxB,MAAM/G,EAAO0R,EAAAjQ,aAAasF,GACpB0N,EAAQ9P,KAAKmiE,UAAU9mE,GAE7B,cADqB2E,KAAKu/B,OAAO0lC,QAAQlC,OAAO,CAACjzD,mBAE1C9P,KAAKqlE,YAAYjjE,IAChB,KAKHrC,gDACL,IAAIulE,GAAY,EAChB,IAAK,MAAMljE,KAAQpC,KAAK8kE,WACvBQ,SAAkBtlE,KAAKulE,WAAWnjE,KAASkjE,EAExCA,UACGtD,EAAAwD,KAAK,QAINzlE,WAA+BqC,GACrC,OAAO,IAAI6/D,EAAkB7/D,EAAMpC,uBCrfrCnF,EAAAD,QAAAmC,QAAA,gGCEA,MAAM0oE,EAAgB,CACrBjD,QAAS,CAACkD,SAAS,GACnBC,KAAM,CAACD,SAAS,GAEhBA,SAAS,GA2JV,SAASE,EAAS1uD,GACjB,MAAsB,iBAARA,EAGf,SAAS2uD,EAAW3uD,GACnB,MAAsB,mBAARA,EAGf,SAAS4uD,EAAsBvmC,GAC9B,UAAWqmC,EAASrmC,IAAYsmC,EAAWtmC,MACxCqmC,EAASrmC,EAAO0lC,UAAaY,EAAWtmC,EAAO0lC,WAChDY,EAAWtmC,EAAO0lC,QAAQ7oE,SAC1BypE,EAAWtmC,EAAO0lC,QAAQlC,SAC1B8C,EAAWtmC,EAAO0lC,QAAQc,aAC1BF,EAAWtmC,EAAO38B,OAtKrBhI,EAAAgqE,WAAA,MASC7kE,YAAYw/B,GAEX,GATOv/B,KAAAgmE,YAAmC,KACnChmE,KAAAimE,UAAiC,KACjCjmE,KAAAkmE,iBAAwC,KACxClmE,KAAAmgC,MAAmD,GACnDngC,KAAAmmE,UAAY,IACZnmE,KAAAoH,QAAU,CAACg/D,QAAS,YAAaC,OAAQ,YAGhDrmE,KAAKu/B,OAASA,GACTumC,EAAsBvmC,GAC1B,MAAM,IAAIn6B,MAAM,2DAIlBrF,KAAKqH,EAAe++D,GAInB,OAAKL,EAAsB9lE,KAAKu/B,QAGP,OAArBv/B,KAAKgmE,YACDv+D,QAAQE,OAAO,IAAIvC,MAAM,sDAEH,OAA1BpF,KAAKkmE,iBACDz+D,QAAQE,OAAO,IAAIvC,MAAM,oDA8InC,SAAkC+gE,GACjC,YAAuB3hE,IAAd2hE,GAAkD,iBAAdA,GAA0BG,SAASH,IAAc79D,KAAKC,MAAM49D,KAAeA,EA7IlHI,CAAyBJ,IAG9BnmE,KAAKgmE,YAAc,IAAIv+D,QAASC,IAC/B1H,KAAKmgC,MAAQ,GACbngC,KAAKmmE,UAAY,IACjBnmE,KAAKimE,UAAY,UACCzhE,IAAd2hE,IACHnmE,KAAKmmE,UAAYA,GAEdP,EAASx+D,KACZpH,KAAKoH,QAAU5L,OAAO+N,OAAOvJ,KAAKoH,QAASA,IAE5CM,EAAQ1H,KAAKwmE,yBACX19C,MAAO7Y,IAET,MADAjQ,KAAKimE,UAAYh2D,EACXA,IACJ2Y,KAAK,KACP5oB,KAAKgmE,YAAc,OAEbhmE,KAAKgmE,aAnBJv+D,QAAQE,OAAO,IAAIvC,MAAM,+DATzBqC,QAAQE,OAAO,IAAIvC,MAAM,4DA+BlCrF,+BACC,MAAMuiE,EAAe,GAErB,OADAA,EAAQtiE,KAAKoH,QAAQi/D,QAAUZ,EACxBzlE,KAAKu/B,OAAO0lC,QAAQc,WAAW,CACrCj2D,MAAO9P,KAAKoH,QAAQg/D,QACpBhkE,KAAMpC,KAAKoH,QAAQi/D,OAEnBt+D,KAAMu6D,IAIRviE,sBACC,OAAOC,KAAKu/B,OAAO0lC,QAAQlC,OAAO,CAACjzD,MAAO9P,KAAKoH,QAAQg/D,UAAUx9C,KAAK9gB,IACrE,GAAIA,EACH,OAAO9H,KAAKymE,+BAEb,MAAMz5C,EAAc,CACnBtS,SAAU,CACTgsD,iBAAkB,EAClBC,qBAAsB,SAEvBvB,SAAU,IAGX,OADAp4C,EAAOo4C,SAASplE,KAAKoH,QAAQi/D,QAAUZ,EAChCzlE,KAAKu/B,OAAO0lC,QAAQ7oE,OAAO,CACjC0T,MAAO9P,KAAKoH,QAAQg/D,QACpBr+D,KAAMilB,MAKTjtB,UAAU6mE,GAuBT,OAtBA5mE,KAAKkmE,iBAAmB,IAAIz+D,QAAQC,IAC9B1H,KAAKmgC,MAAMymC,KACf5mE,KAAKmgC,MAAMymC,GAAgB,IAE5B,MAAMC,EAAqD,CAAC9+D,KAAM,IAClE,IAAK,IAAIjN,EAAI,EAAGA,EAAIkF,KAAKmmE,UAAWrrE,GAAK,EAExC+rE,EAAW9+D,KAAK1D,KAAK,CAACyL,MAAO,CAACoyD,OAAQliE,KAAKoH,QAAQg/D,QAAShE,MAAOpiE,KAAKoH,QAAQi/D,OAAQzC,IAAKgD,KAE7FC,EAAW9+D,KAAK1D,KAAK,IAEtBqD,EACC1H,KAAKu/B,OAAO38B,KAAKikE,GAAYj+C,KAAK9gB,IACjC,IAAK,IAAIg/D,EAAI,EAAGA,EAAIh/D,EAASnF,MAAMZ,OAAQ+kE,GAAK,EAE/C9mE,KAAKmgC,MAAMymC,GAAcviE,KAAKyD,EAASnF,MAAMmkE,GAAGh3D,MAAMi3D,eAIvDn+C,KAAK,KACP5oB,KAAKkmE,iBAAmB,OAElBlmE,KAAKkmE,iBAGLnmE,YAAY6mE,GACnB,GAAuB,OAAnB5mE,KAAKimE,UACR,OAAOx+D,QAAQE,OAAO3H,KAAKimE,WAE5B,GAAIjmE,KAAKmgC,MAAMymC,IAAiB5mE,KAAKmgC,MAAMymC,GAAc7kE,OAAS,EACjE,OAAO0F,QAAQC,QAAQ1H,KAAKmgC,MAAMymC,GAAchnD,SAGjD,MAAMonD,EAAc,IACZhnE,KAAKinE,YAAYL,GAGzB,OAA8B,OAA1B5mE,KAAKkmE,iBACDlmE,KAAKkmE,iBAAiBt9C,KAAKo+C,GAE3BhnE,KAAKknE,UAAUN,GAAch+C,KAAKo+C,GAIpCjnE,IAAI6mE,GACV,IAAK5mE,KAAKu/B,OACT,MAAM,IAAIn6B,MAAM,kEAEjB,GAA6B,iBAAjBwhE,GAAsD,IAAxBA,EAAa7kE,OACtD,MAAM,IAAIqD,MAAM,oDAEjB,OAAyB,OAArBpF,KAAKgmE,YAEDhmE,KAAKgmE,YAAYp9C,KAAK,IAAM5oB,KAAKinE,YAAYL,IAE9C5mE,KAAKinE,YAAYL,GAGlB7mE,aAAa6mE,GACnB,OAAK5mE,KAAKmgC,MAAMymC,GAGR5mE,KAAKmgC,MAAMymC,GAAc7kE,OAFzB,mFCzJV,MAAMolE,EAAY,CAAC/kE,KAAM,WAEnBglE,EAAW,CAAChlE,KAAM,QAElBilE,EAAc,CAACjlE,KAAM,OAAQklE,OAAQ,CAACxU,QAAS,CAAC1wD,KAAM,aAEtDmlE,EAAW,CAACnlE,KAAM,WAElBolE,EAAY,CACjB/E,WAAY,CACXpnE,KAAMgsE,EACN92D,KAAMg3D,EACNr2D,QAASk2D,EACT5sD,SAAU+sD,EACV1kE,GAAI0kE,EACJnlE,KAAMglE,IAaFK,EAAY,CACjBhF,WAAY,CACXpnE,KAAMgsE,EACN3hD,KAAM6hD,EACN5hD,KAAM4hD,EACNxzC,cAAewzC,EACfp5D,MAAOo5D,EACPr2D,QAASk2D,EACT34D,kBAAmB04D,EACnB94D,kBAAmB+4D,EACnBn7B,OAAQs7B,EACRn5D,WAAYg5D,EACZ54D,cAAe+4D,EACf54D,MAtBqB,CACtB8zD,WAAY,CACX1zD,OAAQo4D,EACRl4D,OAAQk4D,EACRv4D,MAAOu4D,EACP73D,QAAS63D,IAkBTtkE,GAAI0kE,EACJnlE,KAAMglE,IAyCFM,EAAc,CACnBjF,WAAY,CACXllD,OAAQgqD,EACRh3D,KAAMg3D,EACNl3D,SAAUk3D,EACVh1D,KAAM,CACLkwD,WAAY,CACXvxD,QAASk2D,EACT5vD,SAAU4vD,IAGZ52D,IAjCqB,CACtBiyD,WAAY,CACXnjE,MAAO8nE,EACPrxD,WAAYqxD,EACZjpD,YAAaipD,EACbhlE,KAAMmlE,EACNt2D,MAAOs2D,EACP/oE,MAAO+oE,EACPjpE,OAAQipE,EACRtvD,WAAYsvD,EACZ/uD,UAAW+uD,EACX92D,MAAO42D,EACPr2D,KAAMo2D,EACNrsD,UAAWwsD,EACXzsD,iBAAkBysD,EAClBvsD,YAAausD,EACbxvD,WAAYwvD,EACZ31D,MAAO21D,EACPtnD,SAjCmB,CACpBwiD,WAAY,CACX5/D,GAAI0kE,EACJlsE,KAAMgsE,EACNhoD,MAAOkoD,EACPh1D,KAAM,CACLkwD,WAAY,CACXvxD,QAASk2D,EACT5vD,SAAU4vD,EACVz6D,KAAMy6D,QAwCRvkE,GAAI0kE,EACJnlE,KAAMglE,IAIFO,EAAiB,CACtBlF,WAAY,CACX1tD,OAAQwyD,EACRz2D,SAAUy2D,EACV9xD,UAAW8xD,EACXnyD,SAAUgyD,EACVxyD,QAASwyD,EACT1xD,UAAW6xD,EACX1kE,GAAI0kE,EACJnlE,KAAMglE,IAIFQ,EAAgB,CACrBnF,WAAY,CACX/iE,OAAQ6nE,EACR/oE,MAAO+oE,EACPtvC,UAAWsvC,EACXpvD,YAAaovD,EACb9rD,gBAAiB8rD,EACjBjpE,OAAQipE,EACRtvD,WAAYsvD,EACZt2D,MAAOs2D,EACPx0D,KAAMq0D,EACNxgD,UAAWwgD,EACX32D,MAAO42D,EACP/uC,UAAWivC,EACXn1D,MAAOg1D,EACPttC,WAAYstC,EACZp2D,KAAMo2D,EACN3gD,UAAW8gD,EACXvsD,YAAausD,EACbzvD,gBAAiByvD,EACjBxvD,WAAYwvD,EACZxsD,UAAWwsD,EACXhhD,iBAAkBghD,EAClBzsD,iBAAkBysD,EAClBlhD,cAAekhD,EACfvuC,cAAeuuC,EACfruC,iBAAkBquC,IAIdM,EAAkB,CACvBpF,WAAY,CACX1xD,SAAUq2D,EACVz0D,QAASy0D,EACT1nE,OAAQ6nE,EACRtgD,WAAYmgD,EACZpgD,SAAUogD,EACVpwC,QAASuwC,EACTtrE,KAAMsrE,EACN15D,QAAS05D,IAILO,EAAa,CAClBrF,WAAY,CACXllD,OAAQgqD,EACRl3D,SAAUk3D,EACVlsE,KAAMgsE,EACN92D,KAAMg3D,EACNh1D,KAAM,CACLkwD,WAAY,CACXvxD,QAASk2D,EACT5vD,SAAU4vD,EACVz6D,KAAMy6D,IAGRn0D,QAASs0D,EACT52D,SAAU42D,EACV/2D,IAAKo3D,EACLp1D,MAAOq1D,EACPhlE,GAAI0kE,EACJnlE,KAAMglE,IAIFW,EAAa,CAClBtF,WAAY,CACXvnD,KAAMqsD,EACNlsE,KAAMgsE,EACN3mD,QAAS6mD,EACTz2D,SAAUy2D,EACV/uD,UAAW+uD,EACX52D,SAAU42D,EACVjpE,OAAQipE,EACRt2D,MAAOs2D,EACPv2D,KAAMo2D,EACNr2D,SAAUq2D,EACVl2D,QAASk2D,EACTrvD,WAAYwvD,EACZxsD,UAAWwsD,EACX1kE,GAAI0kE,EACJnlE,KAAMglE,IAIFY,EAAc,CACnBvF,WAAY,CACXvnD,KAAMqsD,EACNlsE,KAAMgsE,EACN5mD,SAAU8mD,EACV7mD,QAAS6mD,EACTz2D,SAAUy2D,EACVn2D,SAAUm2D,EACV5mD,WAAY4mD,EACZxvD,WAAYwvD,EACZr2D,QAASk2D,EACTvkE,GAAI0kE,EACJnlE,KAAMglE,IAIFa,EAAa,CAClBxF,WAAY,CACXpnE,KAAMgsE,EACNngE,IAAKqgE,EACLzxD,SAAUyxD,EACVxM,SAAUoM,EACVj2D,QAASk2D,EACTxyD,QAASwyD,EACTvkE,GAAI0kE,EACJnlE,KAAMglE,IAIFc,EAAa,CAClBzF,WAAY,CACX1tD,OAAQwyD,EACR3wB,OAAQ2wB,EACR1wB,SAAUuwB,EACVjhE,OAAQihE,EACRhhE,WAAYghE,EACZ/gE,MAAO+gE,EACP9gE,MAAO8gE,EACPvkE,GAAI0kE,EACJnlE,KAAMglE,IAIFe,EAAgB,CACrB1F,WAAY,CACXpnE,KAAMgsE,EACNtyD,OAAQwyD,EACR9yD,QAAS8yD,EACT32D,SAAU22D,EACV3yD,QAASwyD,EACTl2D,QAASk2D,EACTvyD,YAAa0yD,EACb5yD,SAAUwyD,EACVp2D,SAAUq2D,EACVt2D,SAAUy2D,EACV1kE,GAAI0kE,EACJnlE,KAAMglE,IAgBFgB,EAAe,CACpB3F,WAAY,CACXv7D,IAAKqgE,EACLr2D,QAASk2D,EACTx5B,UAAWw5B,EACXh6D,OAAQm6D,EACRxzD,aAAcwzD,EACd/2D,IAnBsB,CACvBiyD,WAAY,CACXhyD,MAAO42D,EACPl+C,KAAMo+C,EACNhzD,OAAQgzD,EACRvzD,YAAauzD,EACbx3B,UAAWw3B,EACX31D,MAAO21D,EACPv3B,WAAYu3B,IAYZ1kE,GAAI0kE,EACJnlE,KAAMglE,IAmBFiB,EAAe,CACpB5F,WAAY,CACXruD,UAAWmzD,EACXn6D,OAAQm6D,EACR/7D,MAAO+7D,EACPh3D,KAAMg3D,EACNp+C,KAAMo+C,EACNlzD,QAASkzD,EACTz5D,KAAMs5D,EACN/rE,KAAMgsE,EACNn+C,KAAMq+C,EACNhzD,OAAQgzD,EACRr3B,SA3BiC,CAClCuyB,WAAY,CACXppD,MAAO+tD,EACP32D,MAAO42D,IAyBPh3B,WArBmC,CACpCoyB,WAAY,CACXv7D,IAAKqgE,EACLnlE,KAAMmlE,EACNxlE,OAAQqlE,IAkBR70D,KAAM,CACLkwD,WAAY,CACXvxD,QAASk2D,EACT5vD,SAAU4vD,EACVz6D,KAAMy6D,IAGR52D,IAAKo3D,EACLp1D,MAAOq1D,EACPhlE,GAAI0kE,EACJnlE,KAAMglE,IAIFkB,EAAgB,CACrB7F,WAAY,CACX7rB,OAAQ2wB,EACRxyD,OAAQwyD,EACR9yD,QAAS8yD,EACTr2D,QAASk2D,EACTxyD,QAASwyD,EACThyD,SAAUgyD,EACVvkE,GAAI0kE,EACJnlE,KAAMglE,IAIKxsE,EAAA0nE,QAAe,CAC3Bt0D,KAAMw5D,EACN59D,KAAM69D,EACNl5D,OAAQm5D,EACRnyD,UAAWoyD,EACXv1D,MAAO01D,EACPtpE,MAAOupE,EACPzpE,OAAQ0pE,EACRryD,MAAOsyD,EACP/hE,MAAOgiE,EACP1zD,SAAU2zD,EACV74D,QAAS84D,EACT70D,QAAS80D,EACTnzD,SAAUozD,iXCjWX1tE,EAAA4qE,KAAA,SAA2B+C,2CAC1B,OAAO,IAAI9gE,QAAc+c,GAAOoR,WAAWpR,EAAK+jD,qcCDjD,MAAArmE,EAAAxH,EAAA,GACAkG,EAAAzB,EAAAzE,EAAA,IACA8tE,EAAArpE,EAAAzE,EAAA,MAGAoS,EAAApS,EAAA,GACAqS,EAAArS,EAAA,GAEA,IAAI+tE,EAAetoE,KAAKygB,MAExB,SAAS8nD,EAAaC,GACrB,OAAOA,EAAejnE,QAAQ,iCAAkC,QAGjE,MAAaknE,EAiBZ7oE,YAAYqC,EAAoBm9B,GAC/Bv/B,KAAKoC,KAAOA,EACZpC,KAAKoiE,MAAQr1D,EAAAjQ,aAAasF,GAC1BpC,KAAKkiE,OAAS,OAASn1D,EAAAjQ,aAAasF,GACpCpC,KAAKu/B,OAASA,EAfPx/B,QAAQwiE,GAEf,cADaA,EAAKqB,IACXrB,EAGAxiE,UAAUmjE,GACjB,OAAOA,EAAK52D,IAAIi2D,GACRviE,KAAK6jE,QAAQtB,IAWhBxiE,mDAGL,SADA0oE,GACoBhoE,aAGbV,mBAAmBqD,GAC1B,GAAIA,EAAM0B,KAAM,CACf,MAAM2B,EAAqC,GACrC3B,EAAO1B,EAAM0B,KAInB,OAHAtJ,OAAOmJ,KAAKG,GAAMD,QAAQxI,IACzBoK,EAAOpK,GAAOyI,EAAKzI,KAAS6F,EAAArD,sBAAsBmG,UAAY,GAAK,IAE7DyB,GAKD1G,eAAeqD,GACtB,GAAIA,EAAMD,IACT,MAAO,GAER,IAAIw/D,EAAmB,GACvB,GAAIv/D,EAAMW,KAAM,CACf,MAAMxI,EAAI6H,EAAMW,KAChB4+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAOd,EAAEc,GACP0H,KAIV,GAAIX,EAAMY,MAAO,CAChB,MAAMzI,EAAI6H,EAAMY,MAChB2+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAO,CAACwsE,OAAQ,IAAI/hC,OAAO4hC,EAAantE,EAAEc,GAAKoE,YAAa,MAC1DsD,KAKV,GAAIX,EAAMe,MAAO,CAChB,MAAM5I,EAAI6H,EAAMe,MAChBw+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAIjQ,IAClB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAO,CAACysE,IAAKvtE,EAAEc,IACb0H,KAIV,GAAIX,EAAMa,WAAY,CACrB,MAAM1I,EAAI6H,EAAMa,WAChB0+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAKjQ,IACZ,CACN0sE,OAAQ,WACP,OAAqC,IAA9B/oE,KAAK3D,GAAK0M,QAAQxN,EAAEc,SAMhC,GAAI+G,EAAMc,YAAa,CACtB,MAAM3I,EAAI6H,EAAMc,YAChBy+D,EAAOA,EAAKtiE,OACX7E,OAAOmJ,KAAKpJ,GAAG+Q,IAAKjQ,IACZ,CACN0sE,OAAQ,WACP,QAASxtE,EAAEc,GAAKsgB,KAAKhN,GAAsC,IAA7B3P,KAAK3D,GAAK0M,QAAQ4G,SAMrD,GAAIvM,EAAMqB,MAAO,CAChB,MAAMlJ,EAAI6H,EAAMqB,MAChBjJ,OAAOmJ,KAAKpJ,GAAGsJ,QAAQxI,IACtB,MAAM8tC,EAAO5uC,EAAEc,GACf,GAAI8tC,EAAKxtC,eAAe,aAAuB6H,IAAb2lC,EAAK5lC,IAAmB,CACzD,MAAMR,EAAY,GAClBA,EAAK1H,GAAO,CAAC2sE,KAAM7+B,EAAK5lC,KACxBo+D,EAAKt+D,KAAKN,GAEX,GAAIomC,EAAKxtC,eAAe,aAAuB6H,IAAb2lC,EAAK7lC,IAAmB,CACzD,MAAMP,EAAY,GAClBA,EAAK1H,GAAO,CAAC4sE,KAAM9+B,EAAK7lC,KACxBq+D,EAAKt+D,KAAKN,MAIb,GAAIX,EAAMgB,QAAS,CAClB,MAAM7I,EAAI6H,EAAMgB,QAChBu+D,EAAOA,EAAKtiE,OAAO9E,EAAE+Q,IAAIjQ,IACxB,MAAM0H,EAAY,GAElB,OADAA,EAAK1H,GAAO,CAAC6sE,SAAS,GACfnlE,KAGT,MAAO,CAAColE,KAAMxG,GAGT5iE,IAAIgI,2CAIT,OAHKA,EAAKlF,IAAyB,IAAnBkF,EAAKlF,GAAGd,SACvBgG,EAAKlF,SAAW7C,KAAKwC,YAEf,IAAIiF,QAAgB,CAACC,EAASC,KACpC3H,KAAKu/B,OAAO6pC,OAAOrhE,EAAOF,IACrBA,EACHF,EAAOE,GAEPH,EAAQK,EAAKlF,UAOX9C,KAAK0jE,2CACV,IAAK,MAAM17D,KAAQ07D,cACNzjE,KAAK0C,IAAIqF,KAIjBhI,QAAQ8C,EAAYkF,2CACzB,OAAO,IAAIN,QAAc,CAACC,EAASC,KAClC3H,KAAKu/B,OAAO1Z,OAAO,CAAChjB,GAAIA,GAAKkF,EAAM,GAAI,CAACF,EAAKwhE,KAC5C,GAAIxhE,EACHF,EAAOE,OACD,IAAoB,IAAhBwhE,EACV,OAAO1hE,EAAO,kBAAoB3H,KAAKoiE,MAAQ,gBAAkBv/D,GAEjE6E,WAME3H,OAAO8C,EAAYkF,2CACnBlF,GAAoB,IAAdA,EAAGd,aAIP/B,KAAK0B,QAAQmB,EAAIkF,SAHjB/H,KAAK0C,IAAIqF,KAOXhI,OAAO8C,2CACZ,MAAMG,EAAMgnB,MAAMC,QAAQpnB,GAAMA,EAAK,CAACA,GACtC,GAAmB,IAAfG,EAAIjB,OAGR,OAAO,IAAI0F,QAAc,CAACC,EAASC,KAClC3H,KAAKu/B,OAAOp+B,OAAO,CAAC0B,GAAI,CAACimE,IAAK9lE,IAAO,CAACiU,OAAO,GAAO,CAACpP,EAAKvE,KACrDuE,EACHF,EAAOE,GACGvE,IAAUN,EAAIjB,OACxB4F,EAAOvC,MAAM,qBAAuB9B,EAAQ,8BAAgCN,EAAIjB,SAEhF2F,UAME3H,cAAcqD,2CACnB,OAAO,IAAIqE,QAAgB,CAACC,EAASC,KACpC3H,KAAKu/B,OAAOp+B,OAAOnB,KAAK6K,eAAezH,GAAQ,CAAC6T,OAAO,GAAO,CAACpP,EAAKvE,KAC/DuE,EACHF,EAAOE,GAEPH,EAAQpE,SAMNvD,KAAK8C,2CACV,YAAkB2B,IAAdxE,KAAKoC,WACKpC,KAAKkD,SAAS,CAACa,KAAM,CAAClB,GAAIA,KAEhC,IAAI4E,QAAW,CAACC,EAASC,KAC/B3H,KAAKu/B,OAAO5iB,KAAQ,CAAC9Z,GAAIA,GAAK,CAACgF,EAAKk8D,KAC/Bl8D,EACHF,EAAOE,GACmB,IAAhBk8D,EAAKhiE,OACf2F,IAEAA,EAAQ1H,KAAK6jE,QAAQE,EAAK,WAOzBhkE,MAAMiD,2CACX,OAAO,IAAIyE,QAAkB,CAACC,EAASC,KACtC3H,KAAKu/B,OAAO5iB,KAAQ,CAAC9Z,GAAI,CAACimE,IAAK9lE,IAAO,CAAC6E,EAAKk8D,KACvCl8D,EACHF,EAAOE,GAEPH,EAAQ1H,KAAKspE,UAAUvF,UAMrBhkE,MAAMqD,2CACX,IAAImmE,EAAUvpE,KAAKu/B,OAAO5iB,KAAQ3c,KAAK6K,eAAezH,IACtD,MAAM0B,EAAO9E,KAAKwpE,mBAAmBpmE,GAWrC,OAVI0B,IACHykE,EAAUA,EAAQzkE,KAAKA,IAEpB1B,EAAM8B,SACTqkE,EAAUA,EAAQE,KAAKrmE,EAAM8B,SAE1B9B,EAAM6B,SACTskE,EAAUA,EAAQxlC,MAAM3gC,EAAM6B,SAGxB,IAAIwC,QAAkB,CAACC,EAASC,KACtC4hE,EAAQ3jC,KAAK,CAAC/9B,EAAKk8D,KACdl8D,EACHF,EAAOE,GAEPH,EAAQ1H,KAAKspE,UAAUvF,UAMrBhkE,SAASqD,2CACd,OAAO,IAAIqE,QAAW,CAACC,EAASC,KAC/B3H,KAAKu/B,OAAO5iB,KAAQ3c,KAAK6K,eAAezH,IAAQ2gC,MAAM,GAAG6B,KAAK,CAAC/9B,EAAKk8D,KAC/Dl8D,EACHF,EAAOE,GACmB,IAAhBk8D,EAAKhiE,OACf2F,IAEAA,EAAQ1H,KAAK6jE,QAAQE,EAAK,WAMxBhkE,QAAQqD,EAAsBG,2CACnC,IAAIgmE,EAAUvpE,KAAKu/B,OAAO5iB,KAAQ3c,KAAK6K,eAAezH,IACtD,MAAM0B,EAAO9E,KAAKwpE,mBAAmBpmE,GAUrC,OATI0B,IACHykE,EAAUA,EAAQzkE,KAAKA,IAEpB1B,EAAM8B,SACTqkE,EAAUA,EAAQE,KAAKrmE,EAAM8B,SAE1B9B,EAAM6B,SACTskE,EAAUA,EAAQxlC,MAAM3gC,EAAM6B,SAExB,IAAIwC,QAAc,CAACC,EAASC,KAClC4hE,EAAQ3jC,KAAK,CAAC/9B,EAAKk8D,KACdl8D,EACHF,EAAOE,GAEPtE,EAAQvD,KAAKspE,UAAUvF,IAAOn7C,KAAKlhB,GAASohB,MAAMnhB,SAMhD5H,SAASqD,2CACd,IAAImmE,EAAUvpE,KAAKu/B,OAAO5iB,KAAQ3c,KAAK6K,eAAezH,IACtD,MAAM0B,EAAO9E,KAAKwpE,mBAAmBpmE,GAUrC,OATI0B,IACHykE,EAAUA,EAAQzkE,KAAKA,IAEpB1B,EAAM8B,SACTqkE,EAAUA,EAAQE,KAAKrmE,EAAM8B,SAE1B9B,EAAM6B,SACTskE,EAAUA,EAAQxlC,MAAM3gC,EAAM6B,SAExB,IAAIwC,QAAuB,CAACC,EAASC,KAC3C4hE,EAAQ3jC,KAAK,CAAC/9B,EAAKk8D,KACdl8D,EACHF,EAAOE,GAEPH,EAAQq8D,EAAKz3D,IAAI/Q,GAAKA,EAAEsH,WAMpB9C,kBAAkB+D,EAAevI,GACxC,MAAMkL,EAAqB,GAErBijE,EAAiB,CAACpC,EAAuB37D,KAC9C,MAAM+P,EAAM/P,EAAI27D,EAAO,IACvB,QAAY9iE,IAARkX,EAGJ,GAAIsO,MAAMC,QAAQvO,GAAM,CACvB,GAAsB,IAAlB4rD,EAAOvlE,OACV,OAED2Z,EAAI7W,QAAQsQ,IACXu0D,EAAepC,EAAO/lE,MAAM,GAAI4T,UAGX,IAAlBmyD,EAAOvlE,OACV0E,EAAOpC,KAAKqX,EAAIjb,YACS,iBAARib,GACjBguD,EAAepC,EAAO/lE,MAAM,GAAIma,IAMnC,OADAguD,EAAe5lE,EAAMqX,MAAM,KAAM5f,GAC1BkL,EAGF1G,UAAUqD,EAAsBU,2CACrC,IAAIylE,EAAUvpE,KAAKu/B,OAAO5iB,KAAQ3c,KAAK6K,eAAezH,IACtD,MAAM0B,EAAO9E,KAAKwpE,mBAAmBpmE,GAUrC,OATI0B,IACHykE,EAAUA,EAAQzkE,KAAKA,IAEpB1B,EAAM8B,SACTqkE,EAAUA,EAAQE,KAAKrmE,EAAM8B,SAE1B9B,EAAM6B,SACTskE,EAAUA,EAAQxlC,MAAM3gC,EAAM6B,SAExB,IAAIwC,QAAgB,CAACC,EAASC,KACpC4hE,EAAQ3jC,KAAK,CAAC/9B,EAAKk8D,KAClB,GAAIl8D,EACHF,EAAOE,OACD,CACN,MAAMO,EAAsB,GAC5B27D,EAAKl/D,QAAQm/D,IACChkE,KAAK2pE,kBAAkB7lE,EAAOkgE,GACtCn/D,QAAQqS,IACR9O,EAAKW,QAAQmO,GAAO,GACvB9O,EAAK/D,KAAK6S,OAIbxP,EAAQU,EAAKrG,eAMXhC,MAAMqD,2CACX,OAAO,IAAIqE,QAAgB,CAACC,EAASC,KACpC3H,KAAKu/B,OAAOj8B,MAAMtD,KAAK6K,eAAezH,GAAQ,CAACyE,EAAKvE,KAC/CuE,EACHF,EAAOE,GAEPH,EAAQpE,SAMNvD,SAASwkE,2CACd,OAAO,IAAI98D,QAAuB,CAACC,EAASC,KAC3C3H,KAAKu/B,OAAO5iB,KAAQ,GAAI,CAAC9U,EAAKk8D,KAC7B,GAAIl8D,EACHF,EAAOE,OACD,CACN,MAAMO,EAAsB,GAC5B27D,EAAKl/D,QAAQm/D,IACChkE,KAAK2pE,kBAAkBpF,EAAWP,GAC1Cn/D,QAAQqS,IACR9O,EAAKW,QAAQmO,GAAO,GACvB9O,EAAK/D,KAAK6S,OAIbxP,EAAQU,WArZbxN,EAAAguE,cA6ZAhuE,EAAA0yB,OAAA,MAKCvtB,YAAY6pE,GAJZ5pE,KAAA6pE,QAEI,GAGH7pE,KAAK8kE,WAAWjgE,QAAQzC,IACvB,MAAMf,EAAWT,EAAAxB,QAAKsI,QAAQkiE,EAAS78D,EAAAjQ,aAAasF,GAAQ,OAC5DpC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,IAAS,CAACm9B,OAAQ,IAAIipC,EAAAppE,QAAK,CAACiC,aAAYA,cAI9DtB,+CACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,WAAY,CACnC,MAAMziE,EAAKrC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,UAC/B0K,EAAAhM,mBAAmBuB,EAAGhB,aAIhBtB,aAAasC,2CAC1B,OAAO,IAAIoF,QAAQ,CAACC,EAASC,KAC5BtF,EAAGynE,aAAcjiE,IAChB,GAAIA,EACH,OAAOF,EAAOE,GAEfH,UAKG3H,+CACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,WAAY,CACnC,MAAMziE,EAAKrC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,UAC/BpC,KAAK8pE,aAAaznE,EAAGk9B,cAEtBv/B,KAAKwhE,UAGNzhE,mDAIEA,WACP,OAAOvE,OAAOmJ,KAAKoI,EAAAjQ,cACjBsa,OAAO/a,IAAQoW,MAAMyJ,OAAO7f,KAC5BiQ,IAAIjQ,GAAO4R,SAAS5R,EAAK,KAGd0D,WAAWsC,2CACxB,OAAO,IAAIoF,QAAc,CAACC,EAASC,KAClCtF,EAAGlB,OAAO,GAAI,CAAC8V,OAAO,GAAQpP,IAC7B,GAAIA,EACH,OAAOF,EAAOE,GAEfxF,EAAGynE,aAAc7qC,IACZA,GACHt3B,EAAOs3B,GAERv3B,YAME3H,gDACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,WAAY,CACnC,MAAMziE,EAAKrC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,UAC/BpC,KAAK+kE,WAAW1iE,EAAGk9B,WAIbx/B,WAAWsC,8CAInBtC,gDACL,IAAK,MAAMqC,KAAQpC,KAAK8kE,WAAY,CACnC,MAAMziE,EAAKrC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,UAC/BpC,KAAKulE,WAAWljE,EAAGk9B,WAI3Bx/B,WAA+BqC,GAC9B,OAAO,IAAIwmE,EAAexmE,EAAMpC,KAAK6pE,QAAQ98D,EAAAjQ,aAAasF,IAAOm9B,yBC9fnE1kC,EAAAD,QAAAmC,QAAA,uBCAAlC,EAAAD,QAAAmC,QAAA","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 42);\n","export enum DBObjectType {\n\troot,\n\tuser,\n\tfolder,\n\ttrack,\n\tstate,\n\tplaylist,\n\tpodcast,\n\tepisode,\n\tbookmark,\n\talbum,\n\tartist,\n\tplayqueue,\n\tradio,\n\tmetadata,\n\tsettings\n}\n","module.exports = require(\"path\");","export enum JamObjectType {\n\troot = 'root',\n\tuser = 'user',\n\tfolder = 'folder',\n\ttrack = 'track',\n\tstate = 'state',\n\tplaylist = 'playlist',\n\tpodcast = 'podcast',\n\tepisode = 'episode',\n\tbookmark = 'bookmark',\n\talbum = 'album',\n\tartist = 'artist',\n\tplayqueue = 'playqueue',\n\tradio = 'radio'\n}\n\nexport enum RootScanStrategy {\n\tauto = 'auto',\n\tartistalbum = 'artistalbum',\n\tcompilation = 'compilation',\n\taudiobook = 'audiobook'\n}\n\nexport const AudioMimeTypes: { [ext: string]: string } = {\n\t'mp3': 'audio/mpeg',\n\t'm4a': 'audio/mp4',\n\t'ogg': 'audio/ogg',\n\t'oga': 'audio/ogg',\n\t'flv': 'aaudio/x-flv',\n\t'flac': 'audio/flac',\n\t'webma': 'audio/webm',\n\t'webm': 'audio/webm',\n\t'wav': 'audio/wav'\n};\n\nexport enum AudioFormatType {\n\tmp3 = 'mp3',\n\tm4a = 'm4a',\n\togg = 'ogg',\n\toga = 'oga',\n\tflv = 'flv',\n\tflac = 'flac',\n\twebma = 'webma',\n\twav = 'wav'\n}\n\nexport const VideoMimeTypes: { [ext: string]: string } = {\n\t'mp4': 'audio/mp4',\n\t'm4v': 'audio/mp4',\n\t'ogv': 'audio/ogg',\n\t'webmv': 'audio/webm',\n\t'webm': 'audio/webm'\n};\n\nexport enum FolderType {\n\tunknown = 'unknown',\n\tartist = 'artist',\n\tcollection = 'collection',\n\talbum = 'album',\n\tmultialbum = 'multialbum',\n\textras = 'extras',\n}\n\nexport enum PodcastStatus {\n\t'new' = 'new',\n\tdownloading = 'downloading',\n\tcompleted = 'completed',\n\terror = 'error',\n\tdeleted = 'deleted',\n\t// skipped = 'skipped'\n}\n\nexport const FolderTypeImageName: { [foldertype: string]: string } = {\n\tunknown: 'folder',\n\tartist: 'artist',\n\tcollection: 'folder',\n\talbum: 'cover',\n\tmultialbum: 'cover',\n\textras: 'folder'\n};\n\nexport enum ArtworkImageType {\n\tfront = 'front',\n\tback = 'back',\n\tbooklet = 'booklet',\n\tmedium = 'medium',\n\ttray = 'tray',\n\tobi = 'obi',\n\tspine = 'spine',\n\ttrack = 'track',\n\tliner = 'liner',\n\tsticker = 'sticker',\n\tposter = 'poster',\n\twatermark = 'watermark',\n\traw = 'raw',\n\tunedited = 'unedited',\n\tother = 'other',\n\tartist = 'artist'\n}\n\nexport const FolderTypesAlbum = [FolderType.album, FolderType.multialbum];\n\nexport enum DatabaseQuerySortType {\n\tascending, descending\n}\n\nexport enum AlbumType {\n\tunknown = 'unknown',\n\talbum = 'album',\n\tcompilation = 'compilation',\n\taudiobook = 'audiobook'\n}\n\nexport enum FileTyp {\n\tUNKNOWN = 'unknown',\n\tAUDIO = 'audio',\n\tIMAGE = 'image',\n\tTAG = 'tag',\n\tBACKUP = 'backup',\n\tOTHER = 'other'\n}\n\nexport enum LastFMLookupType {\n\talbum = 'album',\n\talbumToptracks = 'album-toptracks',\n\tartist = 'artist',\n\ttrack = 'track',\n\ttrackSimilar = 'track-similar',\n\tartistToptracks = 'artist-toptracks'\n}\n\nexport const enum MusicBrainzLookupType {\n\tarea = 'area',\n\tartist = 'artist',\n\tcollection = 'collection',\n\tevent = 'event',\n\tinstrument = 'instrument',\n\tlabel = 'label',\n\tplace = 'place',\n\trecording = 'recording',\n\trelease = 'release',\n\treleaseGroup = 'release-group',\n\tseries = 'series',\n\twork = 'work',\n\turl = 'url'\n}\n\nexport const enum MusicBrainzSearchType {\n\tartist = 'artist',\n\tlabel = 'label',\n\trecording = 'recording',\n\trelease = 'release',\n\treleaseGroup = 'release-group',\n\twork = 'work',\n\tarea = 'area'\n}\n\nexport const enum CoverArtArchiveLookupType {\n\trelease = 'release',\n\treleaseGroup = 'release-group'\n}\n\nexport const enum TrackTagFormatType {\n\tnone = 'none',\n\tffmpeg = 'ffmpeg',\n\tid3v20 = 'id3v20',\n\tid3v21 = 'id3v21',\n\tid3v22 = 'id3v22',\n\tid3v23 = 'id3v23',\n\tid3v24 = 'id3v24',\n\tid3v1 = 'id3v1'\n}\n\nexport const TrackTagID3v2FormatTypes = [TrackTagFormatType.id3v20, TrackTagFormatType.id3v21, TrackTagFormatType.id3v22, TrackTagFormatType.id3v23, TrackTagFormatType.id3v24];\n\n\nexport const enum MusicBrainzAlbumPrimaryType {\n\talbum = 'Album',\n\tsingle = 'Single',\n\tep = 'EP',\n\tbroadcast = 'Broadcast',\n\tother = 'Other',\n}\n\nexport const enum MusicBrainzAlbumSecondaryType {\n\tcompilation = 'Compilation',\n\tsoundtrack = 'Soundtrack',\n\tspokenword = 'Spokenword',\n\tinterview = 'Interview',\n\taudiobook = 'Audiobook',\n\taudiodrama = 'Audio drama',\n\tlive = 'Live',\n\tremix = 'Remix',\n\tdjmix = 'DJ-mix',\n\tmixtape = 'Mixtape'\n}\n","import winston from 'winston';\n\nrequire('winston-timer')(winston);\n\nexport function configureLogger(level: string) {\n\twinston.configure({\n\t\tlevel,\n\t\ttransports: [\n\t\t\tnew winston.transports.Console({\n\t\t\t\tformat:\n\t\t\t\t\twinston.format.combine(\n\t\t\t\t\t\t// winston.format.timestamp(),\n\t\t\t\t\t\twinston.format.colorize(),\n\t\t\t\t\t\twinston.format.simple()\n\t\t\t\t\t\t// winston.format.json()\n\t\t\t\t\t)\n\t\t\t})\n\t\t]\n\t});\n}\n\nclass Logger {\n\tprivate name: string;\n\n\tconstructor(name: string) {\n\t\tthis.name = name;\n\t}\n\n\tprivate applyLog(level: string, format: string, ...params: any[]) {\n\t\tconst line: string = (new Date()).toISOString() + ' ' + this.name + ': ' + [format].concat(params).join(' ');\n\t\twinston.log(level, line);\n\t}\n\n\tdebug(format: string, ...params: any[]) {\n\t\tthis.applyLog('debug', format, params);\n\t}\n\n\tinfo(format: string, ...params: any[]) {\n\t\tthis.applyLog('info', format, params);\n\t}\n\n\twarn(format: string, ...params: any[]) {\n\t\tthis.applyLog('warn', format, params);\n\t}\n\n\terror(format: string | Error, ...params: any[]) {\n\t\tthis.applyLog('error', format.toString(), params);\n\t}\n\n\ttime(name: string) {\n\t\t(<any>winston).start_log(name, 'debug');\n\t}\n\n\ttimeEnd(name: string) {\n\t\t(<any>winston).stop_log(name, 'debug');\n\t}\n}\n\nfunction logger(name: string) {\n\treturn new Logger(name);\n}\n\nexport default logger;\n","import path from 'path';\nimport fse from 'fs-extra';\n\nexport async function fileDeleteIfExists(pathName: string): Promise<void> {\n\tconst exists = await fse.pathExists(pathName);\n\tif (exists) {\n\t\tawait fse.unlink(pathName);\n\t}\n}\n\nexport async function pathDeleteIfExists(pathName: string): Promise<void> {\n\tconst exists = await fse.pathExists(pathName);\n\tif (exists) {\n\t\tawait fse.remove(pathName);\n\t}\n}\n\nexport function fileSuffix(filename: string): string {\n\treturn path.extname(filename).slice(1).toLowerCase();\n}\n\nexport function replaceFileSystemChars(s: string, replace: string): string {\n\treturn s.toString()\n\t\t.replace(/:/g, ' - ')\n\t\t.replace(/[\\?\\/!\\\\]/g, replace);\n}\n\nexport function containsFolderSystemChars(s: string): boolean {\n\tconst rx = /[<>:\"\\/\\\\|?*\\x00-\\x1F]|^(?:aux|con|clock\\$|nul|prn|com[1-9]|lpt[1-9])$/i;\n\treturn rx.test(s);\n}\nexport function replaceFolderSystemChars(s: string, replace: string): string {\n\t/*\n< (less than)\n> (greater than)\n: (colon)\n\" (double quote)\n/ (forward slash)\n\\ (backslash)\n| (vertical bar or pipe)\n? (question mark)\n* (asterisk)\n\t */\n\treturn s.toString()\n\t\t.replace(/:/g, ' -')\n\t\t.replace(/[|\\*\\?\\/!\\\\<>]/g, replace);\n}\n\nexport function ensureTrailingPathSeparator(s: string): string {\n\tif (s.length > 0 && s[s.length - 1] !== path.sep) {\n\t\treturn s + path.sep;\n\t}\n\treturn s;\n}\n\nexport function removeTrailingPathSeparator(s: string): string {\n\tif (s.length > 0 && s[s.length - 1] === path.sep) {\n\t\treturn s.slice(0, s.length - 1);\n\t}\n\treturn s;\n}\n","import {DatabaseQuerySortType} from '../../model/jam-types';\nimport {DBObject} from './base.model';\nimport {Database, DatabaseIndex, DatabaseQuery, DatabaseQuerySort} from '../../db/db.model';\nimport {DBObjectType} from '../../db/db.types';\n\nexport interface SearchQuery {\n\tid?: string;\n\tids?: Array<string>;\n\tquery?: string;\n\toffset?: number;\n\tamount?: number;\n\tsorts?: Array<SearchQuerySort>;\n}\n\nexport interface SearchQuerySort {\n\tfield: string;\n\tdescending: boolean;\n}\n\nexport abstract class BaseStore<T extends DBObject, X extends SearchQuery> {\n\tprotected group: DatabaseIndex<T>;\n\ttype: DBObjectType;\n\n\tprotected constructor(type: DBObjectType, db: Database) {\n\t\tthis.group = db.getDBIndex<T>(type);\n\t\tthis.type = type;\n\t}\n\n\tprotected abstract transformQuery(query: X): DatabaseQuery;\n\n\tasync getNewId(): Promise<string> {\n\t\treturn await this.group.getNewId();\n\t}\n\n\tasync add(item: T): Promise<string> {\n\t\treturn await this.group.add(item);\n\t}\n\n\tasync bulk(items: Array<T>): Promise<void> {\n\t\treturn await this.group.bulk(items);\n\t}\n\n\tasync replace(item: T): Promise<void> {\n\t\treturn await this.group.replace(item.id, item);\n\t}\n\n\tasync remove(idOrIds: string | Array<string>): Promise<void> {\n\t\treturn await this.group.remove(idOrIds);\n\t}\n\n\tasync replaceMany(items: Array<T>): Promise<void> {\n\t\tfor (const item of items) {\n\t\t\tawait this.group.replace(item.id, item);\n\t\t}\n\t}\n\n\tasync byId(id: string): Promise<T | undefined> {\n\t\treturn await this.group.byId(id);\n\t}\n\n\tasync byIds(ids: Array<string>): Promise<Array<T>> {\n\t\treturn await this.group.byIds(ids);\n\t}\n\n\tasync random(): Promise<T | undefined> {\n\t\treturn await this.group.queryOne({all: true});\n\t}\n\n\tasync all(): Promise<Array<T>> {\n\t\treturn await this.group.query({all: true});\n\t}\n\n\tasync allIds(): Promise<Array<string>> {\n\t\treturn await this.group.queryIds({all: true});\n\t}\n\n\tasync count(): Promise<number> {\n\t\treturn await this.group.count({all: true});\n\t}\n\n\tasync iterate(onItems: (items: Array<T>) => Promise<void>): Promise<void> {\n\t\tawait this.group.iterate({all: true}, onItems);\n\t}\n\n\tasync upsert(items: Array<T>): Promise<void> {\n\t\tfor (const item of items) {\n\t\t\tawait this.group.upsert(item.id, item);\n\t\t}\n\t}\n\n\tasync removeByQuery(query: X): Promise<number> {\n\t\treturn await this.group.removeByQuery(this.transformQuery(query));\n\t}\n\n\tasync searchIDs(query: X): Promise<Array<string>> {\n\t\treturn await this.group.queryIds(this.transformQuery(query));\n\t}\n\n\tasync search(query: X): Promise<Array<T>> {\n\t\treturn await this.group.query(this.transformQuery(query));\n\t}\n\n\tasync searchOne(query: X): Promise<T | undefined> {\n\t\treturn await this.group.queryOne(this.transformQuery(query));\n\t}\n\n\tasync searchCount(query: X): Promise<number> {\n\t\treturn await this.group.count(this.transformQuery(query));\n\t}\n\n}\n\nexport class QueryHelper {\n\tprivate q: DatabaseQuery = {};\n\n\tterm(field: string, value: string | number | boolean | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.term = this.q.term || {};\n\t\t\tthis.q.term[field] = value;\n\t\t}\n\t}\n\n\tmatch(field: string, value: string | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.match = this.q.match || {};\n\t\t\tthis.q.match[field] = value;\n\t\t}\n\t}\n\n\tstartsWith(field: string, value: string | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.startsWith = this.q.startsWith || {};\n\t\t\tthis.q.startsWith[field] = value;\n\t\t}\n\t}\n\n\tstartsWiths(field: string, value: Array<string> | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.startsWiths = this.q.startsWiths || {};\n\t\t\tthis.q.startsWiths[field] = value;\n\t\t}\n\t}\n\n\tterms(field: string, value: Array<string | number | boolean> | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.terms = this.q.terms || {};\n\t\t\tthis.q.terms[field] = value;\n\t\t}\n\t}\n\n\tbool(field: string, value: boolean | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.term = this.q.term || {};\n\t\t\tthis.q.term[field] = value;\n\t\t}\n\t}\n\n\tnotNull(field: string, value: boolean | undefined) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tthis.q.notNull = this.q.notNull || [];\n\t\t\tthis.q.notNull.push(field);\n\t\t}\n\t}\n\n\trange(field: string, lte: number | undefined, gte: number | undefined) {\n\t\tif (lte !== undefined || gte !== undefined) {\n\t\t\tthis.q.range = this.q.range || {};\n\t\t\tthis.q.range[field] = {gte, lte};\n\t\t}\n\t}\n\n\tget(query: SearchQuery, fieldMap?: { [name: string]: string }): DatabaseQuery {\n\t\tthis.terms('id', query.ids);\n\t\tthis.term('id', query.id);\n\t\tif (Object.keys(this.q).length === 0) {\n\t\t\tthis.q.all = true;\n\t\t}\n\t\tif (query.sorts) {\n\t\t\tconst sorts: DatabaseQuerySort = {};\n\t\t\tquery.sorts.forEach(sort => {\n\t\t\t\tconst field = fieldMap ? fieldMap[sort.field] : sort.field;\n\t\t\t\tif (field) {\n\t\t\t\t\tsorts[field] = sort.descending ? DatabaseQuerySortType.descending : DatabaseQuerySortType.ascending;\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.q.sort = sorts;\n\t\t}\n\t\tif (query.amount !== undefined && query.amount > 0) {\n\t\t\tthis.q.amount = query.amount;\n\t\t}\n\t\tif (query.offset !== undefined && query.offset > 0) {\n\t\t\tthis.q.offset = query.offset;\n\t\t}\n\t\treturn this.q;\n\t}\n}\n","module.exports = require(\"fs-extra\");","class ApiError extends Error {\n\tfailCode: number;\n\n\tconstructor(message: string, failCode: number) {\n\n\t\t// Calling parent constructor of base Error class.\n\t\tsuper(message);\n\n\t\t// Saving class name in the property of our custom error as a shortcut.\n\t\tthis.name = this.constructor.name;\n\n\t\t// Capturing stack trace, excluding constructor call from it.\n\t\tError.captureStackTrace(this, this.constructor);\n\n\t\t// You can use any additional properties you want.\n\t\t// I'm going to use preferred HTTP status for this error types.\n\t\t// `500` is the default value if not specified.\n\t\tthis.failCode = failCode || 500;\n\t}\n}\n\nexport function InvalidParamError(msg?: string): ApiError {\n\treturn new ApiError(msg || 'Invalid/Missing parameter', 400);\n}\n\nexport function NotFoundError(msg?: string): ApiError {\n\treturn new ApiError(msg || 'Item not found', 404);\n}\n\nexport function UnauthError(msg?: string): ApiError {\n\treturn new ApiError(msg || 'Unauthorized', 401);\n}\n\nexport function GenericError(msg?: string): ApiError {\n\treturn new ApiError(msg || 'Guru Meditation', 500);\n}\n","import {BaseStore, SearchQuery} from './base.store';\nimport {DBObject} from './base.model';\n\nexport class BaseStoreService<DBOBJECT extends DBObject, QUERY extends SearchQuery> {\n\tconstructor(\n\t\tpublic store: BaseStore<DBOBJECT, QUERY>\n\t) {\n\n\t}\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {State, States} from './state.model';\n\nexport function formatState(state?: State): Jam.State {\n\treturn {\n\t\tplayed: state && state.played > 0 ? state.played : undefined,\n\t\tlastplayed: state && state.lastplayed > 0 ? state.lastplayed : undefined,\n\t\tfaved: state ? state.faved : undefined,\n\t\trated: state && state.rated !== undefined && state.rated > 0 ? state.rated : undefined\n\t};\n}\n\nexport function formatStates(states: States): Jam.States {\n\tconst result: Jam.States = {};\n\tObject.keys(states).forEach(key => {\n\t\tresult[key] = formatState(states[key]);\n\t});\n\treturn result;\n}\n","import rateLimiter from 'limiter';\nimport request from 'request';\n\nexport class WebserviceClient {\n\tprivate limiter: rateLimiter.RateLimiter;\n\tprivate userAgent: string;\n\n\tconstructor(requestPerInterval: number, requestIntervalMS: number, userAgent: string) {\n\t\tthis.limiter = new rateLimiter.RateLimiter(requestPerInterval, requestIntervalMS);\n\t\tthis.userAgent = userAgent;\n\t}\n\n\tprotected async getJson<T>(url: string, parameters: object | undefined): Promise<T> {\n\t\tconst options: request.Options = {\n\t\t\turl,\n\t\t\theaders: {'User-Agent': this.userAgent},\n\t\t\tqs: parameters,\n\t\t\ttimeout: 5000\n\t\t};\n\t\tconst limiter = this.limiter;\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tlimiter.removeTokens(1, () => {\n\t\t\t\trequest(options, (err, response, body) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresolve(<T>JSON.parse(body));\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n}\n","import crypto from 'crypto';\n\nexport function shuffle<T>(list: Array<T>): Array<T> {\n\tfor (let i = list.length - 1; i > 0; i--) {\n\t\tconst j = Math.floor(Math.random() * (i + 1));\n\t\t[list[i], list[j]] = [list[j], list[i]];\n\t}\n\treturn list;\n}\n\nexport function randomInt(min: number, max: number) {\n\treturn Math.floor(Math.random() * (max - min + 1)) + min;\n}\n\nexport function randomItem<T>(list: Array<T>): T {\n\tconst i = randomInt(0, list.length - 1);\n\treturn list[i];\n}\n\nexport function randomItems<T>(list: Array<T>, amount?: number): Array<T> {\n\tif (amount === undefined || amount < 0 || list.length <= amount) {\n\t\treturn shuffle<T>(list);\n\t}\n\tconst result: Array<T> = [];\n\tconst done: Array<number> = [];\n\twhile ((result.length < amount)) {\n\t\tconst i = randomInt(0, list.length - 1);\n\t\tif (done.indexOf(i) < 0) {\n\t\t\tresult.push(list[i]);\n\t\t\tdone.push(i);\n\t\t}\n\t}\n\treturn result;\n}\n\nexport function randomString(length: number): string {\n\treturn crypto.randomBytes(Math.ceil(length / 2))\n\t\t.toString('hex') /** convert to hexadecimal format */\n\t\t.slice(0, length);   /** return required number of characters */\n}\n","import {BaseStore, SearchQuery} from './base.store';\nimport {User} from '../user/user.model';\nimport {DBObject} from './base.model';\nimport {StateService} from '../state/state.service';\nimport {BaseStoreService} from './base.service';\n\nexport class BaseListService<T extends DBObject, Q extends SearchQuery> extends BaseStoreService<T, Q> {\n\n\tconstructor(\n\t\tstore: BaseStore<T, Q>,\n\t\tpublic stateService: StateService\n\t) {\n\t\tsuper(store);\n\t}\n\n\tasync getFilteredIDs(ids: Array<string>, query: Q): Promise<Array<string>> {\n\t\tconst list = await this.store.searchIDs(Object.assign(query, {ids, amount: -1, offset: 0}));\n\t\treturn list.sort((a, b) => {\n\t\t\treturn ids.indexOf(a) - ids.indexOf(b);\n\t\t});\n\t}\n\n\tasync getAvgHighestIDs(query: Q): Promise<Array<string>> {\n\t\tconst ids = await this.stateService.getAvgHighestDestIDs(this.store.type);\n\t\treturn await this.getFilteredIDs(ids, query);\n\t}\n\n\tasync getHighestRatedIDs(query: Q, user: User): Promise<Array<string>> {\n\t\tconst ids = await this.stateService.getHighestRatedDestIDs(this.store.type, user.id);\n\t\treturn await this.getFilteredIDs(ids, query);\n\t}\n\n\tasync getFrequentlyPlayedIDs(query: Q, user: User): Promise<Array<string>> {\n\t\tconst ids = await this.stateService.getFrequentlyPlayedDestIDs(this.store.type, user.id);\n\t\treturn await this.getFilteredIDs(ids, query);\n\t}\n\n\tasync getFavedIDs(query: Q, user: User): Promise<Array<string>> {\n\t\tconst ids = await this.stateService.getFavedDestIDs(this.store.type, user.id);\n\t\treturn await this.getFilteredIDs(ids, query);\n\t}\n\n\tasync getRecentlyPlayedIDs(query: Q, user: User): Promise<Array<string>> {\n\t\tconst ids = await this.stateService.getRecentlyPlayedDestIDs(this.store.type, user.id);\n\t\treturn await this.getFilteredIDs(ids, query);\n\t}\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {InvalidParamError} from '../../api/jam/error';\nimport {randomItems} from '../../utils/random';\nimport {paginate} from '../../utils/paginate';\nimport {BaseController} from './base.controller';\nimport {SearchQuery} from './base.store';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {BaseListService} from './base.list.service';\nimport {DBObject} from './base.model';\nimport {User} from '../user/user.model';\n\nexport abstract class BaseListController<OBJREQUEST extends JamParameters.ID | INCLUDE, OBJLISTREQUEST extends JamParameters.IDs | INCLUDE, INCLUDE, JAMQUERY extends SearchQuery, S extends JamParameters.SearchQuery | INCLUDE, DBOBJECT extends DBObject, RESULTOBJ extends { id: string }> extends BaseController<OBJREQUEST, OBJLISTREQUEST, INCLUDE, JAMQUERY, S, DBOBJECT, RESULTOBJ> {\n\n\tprotected constructor(\n\t\tprotected listService: BaseListService<DBOBJECT, JAMQUERY>,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(listService, stateService, imageService, downloadService);\n\t}\n\n\tasync getList(listQuery: JamParameters.List, jamquery: S, includes: INCLUDE, user: User): Promise<Array<RESULTOBJ>> {\n\t\tconst query = await this.translateQuery(jamquery, user);\n\t\tlet ids: Array<string> = [];\n\t\tswitch (listQuery.list) {\n\t\t\tcase 'random':\n\t\t\t\tids = await this.listService.store.searchIDs(Object.assign(query, {amount: -1, offset: 0}));\n\t\t\t\tids = randomItems<string>(ids, listQuery.amount || 20);\n\t\t\t\tbreak;\n\t\t\tcase 'highest':\n\t\t\t\tids = await this.listService.getHighestRatedIDs(query, user);\n\t\t\t\tids = paginate(ids, listQuery.amount, listQuery.offset);\n\t\t\t\tbreak;\n\t\t\tcase 'avghighest':\n\t\t\t\tids = await this.listService.getAvgHighestIDs(query);\n\t\t\t\tids = paginate(ids, listQuery.amount, listQuery.offset);\n\t\t\t\tbreak;\n\t\t\tcase 'frequent':\n\t\t\t\tids = await this.listService.getFrequentlyPlayedIDs(query, user);\n\t\t\t\tids = paginate(ids, listQuery.amount, listQuery.offset);\n\t\t\t\tbreak;\n\t\t\tcase 'faved':\n\t\t\t\tids = await this.listService.getFavedIDs(query, user);\n\t\t\t\tids = paginate(ids, listQuery.amount, listQuery.offset);\n\t\t\t\tbreak;\n\t\t\tcase 'recent':\n\t\t\t\tids = await this.listService.getRecentlyPlayedIDs(query, user);\n\t\t\t\tids = paginate(ids, listQuery.amount, listQuery.offset);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn Promise.reject(InvalidParamError('Unknown List Type'));\n\t\t}\n\t\treturn this.prepareListByIDs(ids, includes, user);\n\t}\n\n}\n","export function paginate<T>(list: Array<T>, amount: number | undefined, offset: number | undefined): Array<T> {\n\tif (amount !== undefined && amount < 0) {\n\t\treturn list;\n\t}\n\treturn list.slice((offset || 0), (offset || 0) + (amount || 20));\n}\n","module.exports = require(\"moment\");","export class DebouncePromises<T> {\n\tprivate pendingPromises: { [id: string]: Array<any> } = {};\n\n\tappend(id: string): Promise<T> {\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tconst run = (err: Error | null, result: T) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.pendingPromises[id].push(run);\n\t\t});\n\t}\n\n\tsetPending(id: string): void {\n\t\tthis.pendingPromises[id] = [];\n\t}\n\n\tisPending(id: string): boolean {\n\t\treturn !!this.pendingPromises[id];\n\t}\n\n\tresolve(id: string, result: T) {\n\t\tfor (const cb of this.pendingPromises[id]) {\n\t\t\tcb(null, result);\n\t\t}\n\t\tdelete this.pendingPromises[id];\n\t}\n\n\treject(id: string, error: Error) {\n\t\tfor (const cb of this.pendingPromises[id]) {\n\t\t\tcb(error);\n\t\t}\n\t\tdelete this.pendingPromises[id];\n\t}\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {SearchQuery} from './base.store';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {Jam} from '../../model/jam-rest-data';\nimport {IApiBinaryResult} from '../../typings';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatState, formatStates} from '../state/state.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {DBObject} from './base.model';\nimport {User} from '../user/user.model';\nimport {BaseStoreService} from './base.service';\n\nexport abstract class BaseController<OBJREQUEST extends JamParameters.ID | INCLUDE, OBJLISTREQUEST extends JamParameters.IDs | INCLUDE, INCLUDE, JAMQUERY extends SearchQuery, S extends JamParameters.SearchQuery | INCLUDE, DBOBJECT extends DBObject, RESULTOBJ extends { id: string }> {\n\n\tprotected constructor(\n\t\tprotected service: BaseStoreService<DBOBJECT, JAMQUERY>,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t}\n\n\tabstract async prepare(item: DBOBJECT, includes: INCLUDE, user: User): Promise<RESULTOBJ>;\n\n\tabstract translateQuery(query: S, user: User): Promise<JAMQUERY>;\n\n\tabstract defaultSort(items: Array<DBOBJECT>): Array<DBOBJECT>;\n\n\tasync byID(id?: string): Promise<DBOBJECT> {\n\t\tif (!id) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst obj = await this.service.store.byId(id);\n\t\tif (!obj) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\treturn obj;\n\t}\n\n\tasync byIDs(ids: Array<string>): Promise<Array<DBOBJECT>> {\n\t\tif (!ids) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\treturn await this.service.store.byIds(ids);\n\t}\n\n\tasync prepareList(items: Array<DBOBJECT>, includes: INCLUDE, user: User, sort?: (a: DBOBJECT, b: DBOBJECT) => number): Promise<Array<RESULTOBJ>> {\n\t\tconst result: Array<RESULTOBJ> = [];\n\t\tif (sort) {\n\t\t\titems = items.sort(sort);\n\t\t}\n\t\tfor (const item of items) {\n\t\t\tconst r = await this.prepare(item, includes, user);\n\t\t\tresult.push(r);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync prepareListByIDs(ids: Array<string>, includes: INCLUDE, user: User, sort?: (a: DBOBJECT, b: DBOBJECT) => number): Promise<Array<RESULTOBJ>> {\n\t\tconst list = await this.service.store.byIds(ids);\n\t\tconst result = await this.prepareList(list, includes, user, sort);\n\t\tif (sort) {\n\t\t\treturn result;\n\t\t}\n\t\treturn result.sort((a, b) => {\n\t\t\treturn ids.indexOf(a.id) - ids.indexOf(b.id);\n\t\t});\n\t}\n\n\tasync prepareByID(id: string, includes: INCLUDE, user: User): Promise<RESULTOBJ> {\n\t\tconst o = await this.byID(id);\n\t\treturn await this.prepare(o, includes, user);\n\t}\n\n\tasync prepareByQuery(query: JAMQUERY, includes: INCLUDE, user: User): Promise<Array<RESULTOBJ>> {\n\t\tconst list = await this.service.store.search(query);\n\t\treturn this.prepareList(this.defaultSort(list), includes, user);\n\t}\n\n\tasync id(req: JamRequest<OBJREQUEST>): Promise<RESULTOBJ> {\n\t\treturn this.prepareByID((<JamParameters.ID>req.query).id, <INCLUDE>req.query, req.user);\n\t}\n\n\tasync ids(req: JamRequest<OBJLISTREQUEST>): Promise<Array<RESULTOBJ>> {\n\t\tconst items = await this.byIDs((<JamParameters.IDs>req.query).ids);\n\t\treturn this.prepareList(items, <INCLUDE>req.query, req.user);\n\t}\n\n\tasync state(req: JamRequest<JamParameters.ID>): Promise<Jam.State> {\n\t\tconst item = await this.byID(req.query.id);\n\t\tconst state = await this.stateService.findOrCreate(item.id, req.user.id, this.service.store.type);\n\t\treturn formatState(state);\n\t}\n\n\tasync states(req: JamRequest<JamParameters.IDs>): Promise<Jam.States> {\n\t\tconst items = await this.byIDs(req.query.ids);\n\t\tconst states = await this.stateService.findOrCreateMany(items.map(item => item.id), req.user.id, this.service.store.type);\n\t\treturn formatStates(states);\n\t}\n\n\tasync favUpdate(req: JamRequest<JamParameters.Fav>): Promise<Jam.State> {\n\t\tconst item = await this.byID(req.query.id);\n\t\tconst state = await this.stateService.fav(item.id, this.service.store.type, req.user.id, req.query.remove ? req.query.remove : false);\n\t\treturn formatState(state);\n\t}\n\n\tasync rateUpdate(req: JamRequest<JamParameters.Rate>): Promise<Jam.State> {\n\t\tconst rating = req.query.rating || 0;\n\t\tif ((rating < 0) || (rating > 5)) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst item = await this.byID(req.query.id);\n\t\tconst state = await this.stateService.rate(item.id, this.service.store.type, req.user.id, rating);\n\t\treturn formatState(state);\n\t}\n\n\tasync search(req: JamRequest<S>): Promise<Array<RESULTOBJ>> {\n\t\tconst list = await this.service.store.search(await this.translateQuery(req.query, req.user));\n\t\treturn this.prepareList(list, <INCLUDE>req.query, req.user);\n\t}\n\n\tasync image(req: JamRequest<JamParameters.Image>): Promise<IApiBinaryResult> {\n\t\tconst item = await this.byID(req.query.id);\n\t\treturn await this.imageService.getObjImage(item, req.query.size, req.query.format);\n\t}\n\n\tasync download(req: JamRequest<JamParameters.Download>): Promise<IApiBinaryResult> {\n\t\tconst item = await this.byID(req.query.id);\n\t\treturn await this.downloadService.getObjDownload(item, req.query.format, req.user);\n\t}\n\n}\n","import moment from 'moment';\nimport path from 'path';\nimport {fileSuffix} from '../../utils/fs-utils';\nimport {AudioFormatType, AudioMimeTypes, PodcastStatus} from '../../model/jam-types';\nimport {Subsonic} from '../../model/subsonic-rest-data';\nimport {Root} from '../../objects/root/root.model';\nimport {User} from '../../objects/user/user.model';\nimport {ArtistIndex, FolderIndex, FolderIndexEntry} from '../../engine/index/index.model';\nimport {State, States} from '../../objects/state/state.model';\nimport {Folder} from '../../objects/folder/folder.model';\nimport {Album} from '../../objects/album/album.model';\nimport {Artist} from '../../objects/artist/artist.model';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport {NowPlaying} from '../../engine/nowplaying/nowplaying.model';\nimport {Podcast} from '../../objects/podcast/podcast.model';\nimport {Playlist} from '../../objects/playlist/playlist.model';\nimport {Bookmark} from '../../objects/bookmark/bookmark.model';\nimport {PlayQueue} from '../../objects/playqueue/playqueue.model';\nimport {Radio} from '../../objects/radio/radio.model';\nimport {ChatMessage} from '../../engine/chat/chat.model';\nimport {Genre} from '../../engine/genre/genre.model';\nimport {DBObjectType} from '../../db/db.types';\nimport {LastFM} from '../../model/lastfm-rest-data';\n\nexport interface SubsonicExtResponse extends Subsonic.Response {\n\t[name: string]: any;\n\n\txmlns: string;\n}\n\nexport interface SubsonicAPIResponse {\n\t'subsonic-response': SubsonicExtResponse;\n}\n\nexport class FORMAT {\n\tstatic FAIL = {\n\t\tGENERIC: 0,\n\t\tPARAMETER: 10,\n\t\tCLIENT_OLD: 20,\n\t\tSERVER_OLD: 30,\n\t\tCREDENTIALS: 40,\n\t\tUNAUTH: 50,\n\t\tNOTFOUND: 70\n\t};\n\n\tstatic packFail(code: number, txt?: string): SubsonicAPIResponse {\n\t\t/*\n\t\t <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\t\t <subsonic-response xmlns=\"http://subsonic.org/restapi\"\n\t\t status=\"failed\" version=\"1.1.0\">\n\t\t <error code=\"40\" message=\"Wrong username or password\"/>\n\t\t </subsonic-response>\n\n\t\t The following error codes are defined:\n\t\t Code \tDescription\n\t\t 0 \tA generic error.\n\t\t 10 \tRequired parameter is missing.\n\t\t 20 \tIncompatible Subsonic REST protocol version. Client must upgrade.\n\t\t 30 \tIncompatible Subsonic REST protocol version. Server must upgrade.\n\t\t 40 \tWrong username or password.\n\t\t 50 \tuser is not authorized for the given operation.\n\t\t 60 \tThe trial period for the Subsonic server is over. Please upgrade to Subsonic Premium. Visit subsonic.org for details.\n\t\t 70 \tThe requested data was not found.\n\t\t */\n\n\t\tconst codeStrings: { [num: number]: string } = {\n\t\t\t0: 'A generic error.',\n\t\t\t10: 'Required parameter is missing.',\n\t\t\t20: 'Incompatible Subsonic REST protocol version. Client must upgrade.',\n\t\t\t30: 'Incompatible Subsonic REST protocol version. Server must upgrade.',\n\t\t\t40: 'Wrong username or password.',\n\t\t\t50: 'user is not authorized for the given operation.',\n\t\t\t70: 'The requested data was not found.'\n\t\t};\n\n\t\treturn {\n\t\t\t'subsonic-response': {\n\t\t\t\t'status': 'failed',\n\t\t\t\t'xmlns': 'http://subsonic.org/restapi',\n\t\t\t\t'error': {\n\t\t\t\t\tcode: code,\n\t\t\t\t\tmessage: txt || codeStrings[code]\n\t\t\t\t},\n\t\t\t\t'version': '1.16.0'\n\t\t\t}\n\t\t};\n\t}\n\n\tstatic packResponse<T>(o: Subsonic.Response): SubsonicAPIResponse {\n\t\tconst response: SubsonicExtResponse = {\n\t\t\tstatus: 'ok',\n\t\t\txmlns: 'http://subsonic.org/restapi',\n\t\t\tversion: '1.16.0'\n\t\t};\n\t\treturn {\n\t\t\t'subsonic-response': Object.assign(response, o)\n\t\t};\n\t}\n\n\tstatic packOK(): SubsonicAPIResponse {\n\t\treturn {\n\t\t\t'subsonic-response': {\n\t\t\t\tstatus: 'ok',\n\t\t\t\txmlns: 'http://subsonic.org/restapi',\n\t\t\t\tversion: '1.16.0'\n\t\t\t}\n\t\t};\n\t}\n\n\tstatic formatSubSonicDate(date: number): string {\n\t\treturn moment(date).utc().format(); // .format('YYYY-MM-DDThh:mm:ss.000Z');\n\t}\n\n\tstatic packRoot(root: Root): Subsonic.MusicFolder {\n\t\treturn {id: parseInt(root.id, 10), name: root.name};\n\t}\n\n\tstatic packUser(user: User): Subsonic.User {\n\t\treturn {\n\t\t\tusername: user.name,\n\t\t\temail: user.email,\n\t\t\tmaxBitRate: user.maxBitRate,\n\t\t\tavatarLastChanged: user.avatarLastChanged !== undefined ? this.formatSubSonicDate(user.avatarLastChanged) : undefined,\n\t\t\tfolder: user.allowedfolder ? user.allowedfolder.map(s => parseInt(s, 10)) : undefined,\n\t\t\tscrobblingEnabled: user.scrobblingEnabled,\n\t\t\tadminRole: user.roles.admin,\n\t\t\tsettingsRole: user.roles.admin, // user.roles.settingsRole,\n\t\t\tdownloadRole: user.roles.stream, // user.roles.downloadRole,\n\t\t\tuploadRole: user.roles.upload,\n\t\t\tplaylistRole: user.roles.admin, // user.roles.playlistRole,\n\t\t\tcoverArtRole: user.roles.admin, // user.roles.coverArtRole,\n\t\t\tcommentRole: user.roles.admin, // user.roles.commentRole,\n\t\t\tpodcastRole: user.roles.podcast,\n\t\t\tstreamRole: user.roles.stream,\n\t\t\tjukeboxRole: user.roles.admin, // user.roles.jukeboxRole,\n\t\t\tshareRole: user.roles.admin, // user.roles.shareRole,\n\t\t\tvideoConversionRole: user.roles.admin, // user.roles.videoConversionRole\n\t\t};\n\t}\n\n\tstatic packFolderIndexArtist(entry: FolderIndexEntry, state: State): Subsonic.Artist {\n\t\t/*\n<xs:complexType name=\"Artist\">\n\t<xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n\t<xs:attribute name=\"name\" type=\"xs:string\" use=\"required\"/>\n\t<xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/> <!-- Added in 1.10.1 -->\n\t<xs:attribute name=\"userRating\" type=\"sub:UserRating\" use=\"optional\"/>  <!-- Added in 1.13.0 -->\n\t<xs:attribute name=\"averageRating\" type=\"sub:AverageRating\" use=\"optional\"/>  <!-- Added in 1.13.0 -->\n</xs:complexType>\n\t */\n\t\treturn {\n\t\t\tid: entry.folder.id,\n\t\t\tname: entry.name,\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined,\n\t\t\tuserRating: state ? state.rated : undefined\n\t\t\t// TODO: averageRating\n\t\t};\n\t}\n\n\tstatic packFolderIndex(index: FolderIndex, states: States): Array<Subsonic.Index> {\n\t\tif (!index) {\n\t\t\treturn [];\n\t\t}\n\t\treturn index.groups.map(i => ({\n\t\t\tname: i.name,\n\t\t\tartist: i.entries.map(e => {\n\t\t\t\treturn FORMAT.packFolderIndexArtist(e, states[e.folder.id]);\n\t\t\t})\n\t\t}));\n\t}\n\n\tstatic packArtistIndex(index: ArtistIndex, states: States): Array<Subsonic.IndexID3> {\n\t\tif (!index) {\n\t\t\treturn [];\n\t\t}\n\t\treturn index.groups.map(i => ({\n\t\t\tname: i.name,\n\t\t\tartist: i.entries.map(e => FORMAT.packArtist(e.artist, states[e.artist.id]))\n\t\t}));\n\t}\n\n\tstatic packDirectory(folder: Folder, state: State): Subsonic.Directory {\n\t\t/*\n\t\t <xs:complexType name=\"Directory\">\n\t\t <xs:sequence>\n\t\t <xs:element name=\"child\" type=\"sub:Child\" minOccurs=\"0\" maxOccurs=\"unbounded\"/>\n\t\t </xs:sequence>\n\t\t <xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"parent\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"name\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/> <!-- Added in 1.10.1 -->\n\t\t </xs:complexType>\n\t\t */\n\t\treturn {\n\t\t\tid: folder.id,\n\t\t\tparent: folder.parentID,\n\t\t\tname: path.basename(folder.path),\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined\n\t\t};\n\t}\n\n\tstatic packFolderArtist(folder: Folder, state: State): Subsonic.Artist {\n\t\t/*\n    <xs:complexType name=\"Artist\">\n        <xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n        <xs:attribute name=\"name\" type=\"xs:string\" use=\"required\"/>\n        <xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/> <!-- Added in 1.10.1 -->\n        <xs:attribute name=\"userRating\" type=\"sub:UserRating\" use=\"optional\"/>  <!-- Added in 1.13.0 -->\n        <xs:attribute name=\"averageRating\" type=\"sub:AverageRating\" use=\"optional\"/>  <!-- Added in 1.13.0 -->\n    </xs:complexType>\n\t\t */\n\t\treturn {\n\t\t\tid: folder.id,\n\t\t\tname: folder.tag.title || folder.tag.artist || '',\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined,\n\t\t\tuserRating: state ? state.rated : undefined\n\t\t};\n\t}\n\n\tstatic packAlbum(album: Album, state: State): Subsonic.AlbumID3 {\n\t\t/*\n\t\t <xs:complexType name=\"AlbumID3\">\n\t\t <xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"name\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"artist\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"artistId\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"coverArt\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"songCount\" type=\"xs:int\" use=\"required\"/>\n\t\t <xs:attribute name=\"duration\" type=\"xs:int\" use=\"required\"/>\n\t\t <xs:attribute name=\"created\" type=\"xs:dateTime\" use=\"required\"/>\n\t\t <xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/>\n\t\t <xs:attribute name=\"year\" type=\"xs:int\" use=\"optional\"/> <!-- Added in 1.10.1 -->\n\t\t <xs:attribute name=\"genre\" type=\"xs:string\" use=\"optional\"/> <!-- Added in 1.10.1 -->\n\n\t\t */\n\t\treturn {\n\t\t\tid: album.id,\n\t\t\tname: album.name,\n\t\t\tartist: album.artist,\n\t\t\tartistId: album.artistID,\n\t\t\tcoverArt: album.id,\n\t\t\tsongCount: album.trackIDs.length,\n\t\t\tduration: album.duration,\n\t\t\tyear: album.year,\n\t\t\tgenre: album.genre,\n\t\t\tcreated: FORMAT.formatSubSonicDate(album.created),\n\t\t\tstarred: state && state.faved ? FORMAT.formatSubSonicDate(state.faved) : undefined\n\t\t};\n\t}\n\n\tstatic packArtist(artist: Artist, state: State): Subsonic.ArtistID3 {\n\t\t/*\n\t\t <xs:complexType name=\"ArtistID3\">\n\t\t <xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"name\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"coverArt\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"albumCount\" type=\"xs:int\" use=\"required\"/>\n\t\t <xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/>\n\t\t </xs:complexType>\n\t\t */\n\t\treturn {\n\t\t\tid: artist.id,\n\t\t\tname: artist.name,\n\t\t\tcoverArt: artist.id,\n\t\t\talbumCount: artist.albumIDs.length,\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined\n\t\t};\n\t}\n\n\tstatic packAlbumInfo(info: LastFM.Album): Subsonic.AlbumInfo {\n\t\tconst result: Subsonic.AlbumInfo = {\n\t\t\tnotes: info.wiki ? info.wiki.content : undefined,\n\t\t\tmusicBrainzId: info.mbid,\n\t\t\tlastFmUrl: info.url\n\t\t};\n\t\t(info.image || []).forEach(i => {\n\t\t\tif (i.size === 'small') {\n\t\t\t\tresult.smallImageUrl = i.url;\n\t\t\t} else if (i.size === 'medium') {\n\t\t\t\tresult.mediumImageUrl = i.url;\n\t\t\t} else if (i.size === 'large') {\n\t\t\t\tresult.largeImageUrl = i.url;\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t}\n\n\tstatic packArtistInfo(info: LastFM.Artist, similar?: Array<Subsonic.Artist>): Subsonic.ArtistInfo {\n\t\tconst result: Subsonic.ArtistInfo = {\n\t\t\tbiography: info.bio ? info.bio.content : undefined,\n\t\t\tmusicBrainzId: info.mbid,\n\t\t\tlastFmUrl: info.url,\n\t\t\tsimilarArtist: similar\n\t\t};\n\t\t(info.image || []).forEach(i => {\n\t\t\tif (i.size === 'small') {\n\t\t\t\tresult.smallImageUrl = i.url;\n\t\t\t} else if (i.size === 'medium') {\n\t\t\t\tresult.mediumImageUrl = i.url;\n\t\t\t} else if (i.size === 'large') {\n\t\t\t\tresult.largeImageUrl = i.url;\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t}\n\n\tstatic packArtistInfo2(info: LastFM.Artist, similar?: Array<Subsonic.ArtistID3>): Subsonic.ArtistInfo2 {\n\t\tconst result: Subsonic.ArtistInfo2 = {\n\t\t\tbiography: info.bio ? info.bio.content : undefined,\n\t\t\tmusicBrainzId: info.mbid,\n\t\t\tlastFmUrl: info.url,\n\t\t\tsimilarArtist: similar\n\t\t};\n\t\t(info.image || []).forEach(i => {\n\t\t\tif (i.size === 'small') {\n\t\t\t\tresult.smallImageUrl = i.url;\n\t\t\t} else if (i.size === 'medium') {\n\t\t\t\tresult.mediumImageUrl = i.url;\n\t\t\t} else if (i.size === 'large') {\n\t\t\t\tresult.largeImageUrl = i.url;\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t}\n\n\tstatic packTrack(track: Track, state: State): Subsonic.Child {\n\t\t/*\n\t\t <xs:complexType name=\"Child\">\n\t\t <xs:attribute name=\"id\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"parent\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"isDir\" type=\"xs:boolean\" use=\"required\"/>\n\t\t <xs:attribute name=\"title\" type=\"xs:string\" use=\"required\"/>\n\t\t <xs:attribute name=\"album\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"artist\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"track\" type=\"xs:int\" use=\"optional\"/>\n\t\t <xs:attribute name=\"year\" type=\"xs:int\" use=\"optional\"/>\n\t\t <xs:attribute name=\"genre\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"coverArt\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"size\" type=\"xs:long\" use=\"optional\"/>\n\t\t <xs:attribute name=\"contentType\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"suffix\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"transcodedContentType\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"transcodedSuffix\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"duration\" type=\"xs:int\" use=\"optional\"/>\n\t\t <xs:attribute name=\"bitRate\" type=\"xs:int\" use=\"optional\"/>\n\t\t <xs:attribute name=\"path\" type=\"xs:string\" use=\"optional\"/>\n\t\t <xs:attribute name=\"isVideo\" type=\"xs:boolean\" use=\"optional\"/> <!-- Added in 1.4.1 -->\n\t\t <xs:attribute name=\"userRating\" type=\"sub:UserRating\" use=\"optional\"/> <!-- Added in 1.6.0 -->\n\t\t <xs:attribute name=\"averageRating\" type=\"sub:AverageRating\" use=\"optional\"/> <!-- Added in 1.6.0 -->\n\t\t <xs:attribute name=\"discNumber\" type=\"xs:int\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"created\" type=\"xs:dateTime\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"starred\" type=\"xs:dateTime\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"albumId\" type=\"xs:string\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"artistId\" type=\"xs:string\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"type\" type=\"sub:MediaType\" use=\"optional\"/> <!-- Added in 1.8.0 -->\n\t\t <xs:attribute name=\"bookmarkPosition\" type=\"xs:long\" use=\"optional\"/> <!-- In millis. Added in 1.10.1 -->\n\t\t </xs:complexType>\n\t\t */\n\n\t\tconst suffix = fileSuffix(track.name);\n\t\tconst result: Subsonic.Child = {\n\t\t\tid: track.id,\n\t\t\tparent: track.parentID || '',\n\t\t\ttitle: track.tag.title || track.name,\n\t\t\talbum: track.tag.album,\n\t\t\tartist: track.tag.artist,\n\t\t\tisDir: false,\n\t\t\tcoverArt: track.id,\n\t\t\tgenre: track.tag.genre,\n\t\t\tyear: track.tag.year,\n\t\t\tcreated: FORMAT.formatSubSonicDate(track.stat.created),\n\t\t\tduration: (track.media.duration !== undefined && !isNaN(track.media.duration)) ? Math.round(track.media.duration) : -1,\n\t\t\tbitRate: (track.media.bitRate !== undefined) ? Math.round(track.media.bitRate / 1000) : -1,\n\t\t\ttrack: track.tag.track,\n\t\t\tsize: track.stat.size,\n\t\t\tsuffix: suffix,\n\t\t\tcontentType: AudioMimeTypes[suffix],\n\t\t\tisVideo: false,\n\t\t\tpath: track.path + '/' + track.name,\n\t\t\tdiscNumber: track.tag.disc,\n\t\t\talbumId: track.albumID,\n\t\t\tartistId: track.artistID,\n\t\t\ttype: 'music',\n\t\t\tuserRating: state ? state.rated : undefined,\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined,\n\t\t\tplayCount: state && state.played ? state.played : 0,\n\t\t\ttranscodedSuffix: undefined,\n\t\t\ttranscodedContentType: undefined\n\t\t\t// \"rank\": 0,\n\t\t\t// \"averageRating\": track.state.avgrated,\n\t\t\t// \"bookmarkPosition\": track.state.bookmark,\n\t\t};\n\t\tif (suffix !== AudioFormatType.mp3) {\n\t\t\tresult.transcodedSuffix = AudioFormatType.mp3;\n\t\t\tresult.transcodedContentType = AudioMimeTypes[result.transcodedSuffix];\n\t\t}\n\t\treturn result;\n\t}\n\n\tstatic packNowPlaying(nowPlaying: NowPlaying, state: State): Subsonic.NowPlayingEntry {\n\t\tlet entry: Subsonic.Child;\n\t\tswitch (nowPlaying.obj.type) {\n\t\t\tcase DBObjectType.track:\n\t\t\t\tentry = FORMAT.packTrack(<Track>nowPlaying.obj, state);\n\t\t\t\tbreak;\n\t\t\tcase DBObjectType.episode:\n\t\t\t\tentry = FORMAT.packPodcastEpisode(<Episode>nowPlaying.obj, state);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tentry = {\n\t\t\t\t\tid: nowPlaying.obj.id,\n\t\t\t\t\tisDir: false,\n\t\t\t\t\ttitle: 'Unknown'\n\t\t\t\t};\n\t\t}\n\t\tconst nowPlay = <Subsonic.NowPlayingEntry>entry;\n\t\tnowPlay.username = nowPlaying.user.name;\n\t\tnowPlay.minutesAgo = Math.round(moment.duration(moment().diff(moment(nowPlaying.time))).asMinutes());\n\t\tnowPlay.playerId = 0;\n\t\treturn nowPlay;\n\t}\n\n\tstatic packFolder(folder: Folder, state: State): Subsonic.Child {\n\t\treturn {\n\t\t\tid: folder.id,\n\t\t\tpath: folder.path,\n\t\t\tparent: folder.parentID,\n\t\t\tcreated: FORMAT.formatSubSonicDate(folder.stat.created),\n\t\t\ttitle: folder.tag.title || '',\n\t\t\talbum: folder.tag.album,\n\t\t\tgenre: folder.tag.genre,\n\t\t\tartist: folder.tag.artist,\n\t\t\tyear: folder.tag.year,\n\t\t\tcoverArt: folder.id,\n\t\t\tuserRating: state ? state.rated : undefined,\n\t\t\t// \"albumId\": '',  // TODO: folder albumId if only one?\n\t\t\t// \"artistId\": '',  // TODO: folder artistId if only one?\n\t\t\tisDir: true,\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined\n\t\t};\n\t}\n\n\tstatic packPodcast(podcast: Podcast, status?: PodcastStatus): Subsonic.PodcastChannel {\n\t\treturn {\n\t\t\tid: podcast.id,\n\t\t\turl: podcast.url,\n\t\t\terrorMessage: podcast.errorMessage,\n\t\t\ttitle: podcast.tag ? podcast.tag.title : undefined,\n\t\t\tstatus: status ? PodcastStatus[status] : PodcastStatus[podcast.status],\n\t\t\tdescription: podcast.tag ? podcast.tag.description : undefined,\n\t\t\tcoverArt: podcast.id,\n\t\t\toriginalImageUrl: podcast.tag ? podcast.tag.image : undefined\n\t\t};\n\t}\n\n\tstatic packPodcastEpisode(episode: Episode, state: State, status?: PodcastStatus): Subsonic.PodcastEpisode {\n\t\tconst result: Subsonic.PodcastEpisode = {\n\t\t\t// albumId:episode.albumId,\n\t\t\t// artistId:episode.artistId,\n\t\t\t// averageRating:episode.averageRating, // TODO: podcast episode state.averageRating\n\t\t\t// bookmarkPosition:episode.bookmarkPosition, // TODO: podcast episode state.bookmarkPosition\n\t\t\tstreamId: episode.id,\n\t\t\tcoverArt: episode.id,\n\t\t\tchannelId: episode.podcastID,\n\t\t\tdescription: episode.summary,\n\t\t\tpublishDate: episode.date !== undefined ? this.formatSubSonicDate(episode.date) : undefined,\n\t\t\ttitle: episode.name,\n\t\t\tstatus: status ? PodcastStatus[status] : PodcastStatus[episode.status],\n\t\t\tid: episode.id,\n\t\t\tparent: episode.podcastID,\n\t\t\tartist: episode.tag ? episode.tag.artist : episode.author,\n\t\t\talbum: episode.tag ? episode.tag.album : undefined,\n\t\t\ttrack: episode.tag ? episode.tag.track : undefined,\n\t\t\tyear: episode.tag ? episode.tag.year : undefined,\n\t\t\tgenre: episode.tag ? episode.tag.genre : undefined,\n\t\t\tdiscNumber: episode.tag ? episode.tag.disc : undefined,\n\t\t\ttype: 'podcast',\n\t\t\tplayCount: state && state.played ? state.played : 0,\n\t\t\tstarred: state && state.faved ? this.formatSubSonicDate(state.faved) : undefined,\n\t\t\tuserRating: state ? state.rated : undefined,\n\t\t\tisVideo: false,\n\t\t\tisDir: false,\n\t\t\tsuffix: undefined,\n\t\t\ttranscodedSuffix: undefined,\n\t\t\ttranscodedContentType: undefined,\n\t\t\tpath: undefined,\n\t\t\tsize: undefined,\n\t\t\tcreated: undefined,\n\t\t\tduration: undefined,\n\t\t\tbitRate: undefined\n\t\t};\n\t\tif (episode.path) {\n\t\t\tresult.suffix = fileSuffix(episode.path);\n\t\t\tif (result.suffix !== AudioFormatType.mp3) {\n\t\t\t\tresult.transcodedSuffix = AudioFormatType.mp3;\n\t\t\t\tresult.transcodedContentType = AudioMimeTypes[result.transcodedSuffix];\n\t\t\t}\n\t\t\tresult.contentType = AudioMimeTypes[result.suffix];\n\t\t\tif (episode.stat) {\n\t\t\t\tresult.size = episode.stat.size;\n\t\t\t\tresult.created = FORMAT.formatSubSonicDate(episode.stat.created);\n\t\t\t}\n\t\t\tif (episode.media) {\n\t\t\t\tresult.duration = episode.media.duration;\n\t\t\t\tresult.bitRate = episode.media.bitRate !== undefined ? Math.round(episode.media.bitRate / 1000) : -1;\n\t\t\t}\n\t\t}\n\t\tif (status) {\n\t\t\tresult.status = status;\n\t\t}\n\t\treturn result;\n\t}\n\n\tstatic packPlaylist(playlist: Playlist): Subsonic.Playlist {\n\t\treturn {\n\t\t\tid: playlist.id,\n\t\t\tname: playlist.name,\n\t\t\tcomment: playlist.comment || '',\n\t\t\t'public': playlist.isPublic,\n\t\t\tduration: playlist.duration,\n\t\t\tcreated: FORMAT.formatSubSonicDate(playlist.created),\n\t\t\tchanged: FORMAT.formatSubSonicDate(playlist.changed),\n\t\t\tcoverArt: playlist.coverArt,\n\t\t\tallowedUser: playlist.allowedUser,\n\t\t\tsongCount: playlist.trackIDs.length,\n\t\t\towner: playlist.userID\n\t\t};\n\t}\n\n\tstatic packPlaylistWithSongs(playlist: Playlist, tracks: Array<Track>, states: States): Subsonic.PlaylistWithSongs {\n\t\tconst result = <Subsonic.PlaylistWithSongs>FORMAT.packPlaylist(playlist);\n\t\tresult.entry = tracks.map(track => FORMAT.packTrack(track, states[track.id]));\n\t\treturn result;\n\t}\n\n\tstatic packBookmark(bookmark: Bookmark, username: string, child: Subsonic.Child): Subsonic.Bookmark {\n\t\treturn {\n\t\t\tentry: child,\n\t\t\tusername: username,\n\t\t\tposition: bookmark.position,\n\t\t\tcomment: bookmark.comment,\n\t\t\tcreated: FORMAT.formatSubSonicDate(bookmark.created),\n\t\t\tchanged: FORMAT.formatSubSonicDate(bookmark.changed)\n\t\t};\n\t}\n\n\tstatic packSimilarSongs(childs: Array<Subsonic.Child>): Subsonic.SimilarSongs {\n\t\treturn {\n\t\t\tsong: childs\n\t\t};\n\t}\n\n\tstatic packSimilarSongs2(childs: Array<Subsonic.Child>): Subsonic.SimilarSongs2 {\n\t\treturn {\n\t\t\tsong: childs\n\t\t};\n\t}\n\n\tstatic packPlayQueue(playqueue: PlayQueue, user: User, childs: Array<Subsonic.Child>): Subsonic.PlayQueue {\n\t\treturn {\n\t\t\tentry: childs,\n\t\t\tcurrent: playqueue.currentID !== undefined ? parseInt(playqueue.currentID, 10) : undefined,\n\t\t\tposition: playqueue.position,\n\t\t\tusername: user.name,\n\t\t\tchanged: playqueue.changed > 0 ? FORMAT.formatSubSonicDate(playqueue.changed) : '',\n\t\t\tchangedBy: playqueue.changedBy || ''\n\t\t};\n\t}\n\n\tstatic packRadio(radio: Radio): Subsonic.InternetRadioStation {\n\t\treturn {\n\t\t\tid: radio.id,\n\t\t\tname: radio.name,\n\t\t\tstreamUrl: radio.url,\n\t\t\thomePageUrl: radio.homepage\n\t\t};\n\t}\n\n\tstatic packGenre(genre: Genre): Subsonic.Genre {\n\t\treturn {\n\t\t\tcontent: genre.name,\n\t\t\tsongCount: genre.trackCount,\n\t\t\talbumCount: genre.albumCount,\n\t\t\tartistCount: genre.artistCount\n\t\t};\n\t}\n\n\tstatic packChatMessage(message: ChatMessage): Subsonic.ChatMessage {\n\t\treturn {\n\t\t\tusername: message.username,\n\t\t\ttime: message.time,\n\t\t\tmessage: message.message\n\t\t};\n\t}\n}\n","import {Store} from '../store/store';\nimport {AudioModule} from '../../modules/audio/audio.module';\nimport Logger from '../../utils/logger';\nimport {WaveformService} from '../waveform/waveform.service';\nimport {Track, TrackTag} from '../../objects/track/track.model';\nimport {ImageModule} from '../../modules/image/image.module';\nimport {deepCompare} from '../../utils/deep-compare';\nimport {AlbumType, ArtworkImageType, FileTyp, FolderType, FolderTypesAlbum, RootScanStrategy, TrackTagFormatType} from '../../model/jam-types';\nimport path from 'path';\nimport fse from 'fs-extra';\nimport {ensureTrailingPathSeparator} from '../../utils/fs-utils';\nimport {getFileType} from '../../utils/filetype';\nimport {Artwork, Folder, FolderTag} from '../../objects/folder/folder.model';\nimport {Artist} from '../../objects/artist/artist.model';\nimport {Album} from '../../objects/album/album.model';\nimport {updatePlayListTracks} from '../../objects/playlist/playlist.service';\nimport moment from 'moment';\nimport {md5string} from '../../utils/md5';\nimport {DBObjectType} from '../../db/db.types';\nimport {Jam} from '../../model/jam-rest-data';\n\nconst log = Logger('IO');\n\n/**\n * Handles file system reading / db syncing\n */\n\nexport interface ScanDir {\n\tname: string;\n\trootID: string;\n\tstat: {\n\t\tctime: number,\n\t\tmtime: number,\n\t};\n\tdirectories: Array<ScanDir>;\n\tfiles: Array<ScanFile>;\n}\n\nexport interface ScanFile {\n\tname: string;\n\ttype: FileTyp;\n\tstat: {\n\t\tctime: number,\n\t\tmtime: number,\n\t\tsize: number\n\t};\n}\n\nexport interface MatchDir extends ScanDir {\n\tname: string;\n\trootID: string;\n\tstat: {\n\t\tctime: number,\n\t\tmtime: number,\n\t};\n\tdirectories: Array<MatchDir>;\n\tfiles: Array<MatchFile>;\n\tlevel: number;\n\ttag?: FolderTag;\n\tparent?: MatchDir;\n\tfolder?: Folder;\n\tmetaStat?: MetaStat;\n}\n\nexport interface MatchFile extends ScanFile {\n\tname: string;\n\ttype: FileTyp;\n\tstat: {\n\t\tctime: number,\n\t\tmtime: number,\n\t\tsize: number\n\t};\n\trootID: string;\n\ttrack?: Track;\n}\n\nexport interface MergeTrackInfo {\n\ttrack: Track;\n\tdir: MatchDir;\n}\n\nexport interface UpdateMergeTrackInfo extends MergeTrackInfo {\n\toldTrack: Track;\n}\n\nexport interface MergeChanges {\n\tnewArtists: Array<Artist>;\n\tupdateArtists: Array<Artist>;\n\tremovedArtists: Array<Artist>;\n\n\tnewAlbums: Array<Album>;\n\tupdateAlbums: Array<Album>;\n\tremovedAlbums: Array<Album>;\n\n\tnewTracks: Array<MergeTrackInfo>;\n\tupdateTracks: Array<UpdateMergeTrackInfo>;\n\tremovedTracks: Array<Track>;\n\n\tnewFolders: Array<Folder>;\n\tupdateFolders: Array<Folder>;\n\tremovedFolders: Array<Folder>;\n\n\tstart: number;\n\tend: number;\n}\n\nfunction printTree(match: MatchDir, level: number = 0) {\n\tconst prefix = ' '.repeat(level);\n\tif (match.folder) {\n\t\tconsole.log(prefix + ' ' + path.basename(match.name), '[' + match.folder.tag.type + ']', FolderTypesAlbum.indexOf(match.folder.tag.type) >= 0 ? '[' + match.folder.tag.albumType + ']' : '');\n\t} else {\n\t\tconsole.log(prefix + ' ' + path.basename(match.name), '[new]');\n\t}\n\t// console.log(prefix + JSON.stringify(match.tag));\n\tfor (const sub of match.directories) {\n\t\tprintTree(sub, level + 1);\n\t}\n\t// if (wFiles) {\n\t// \tfor (const f of match.files) {\n\t// \t\tif (f.type === FileTyp.AUDIO) {\n\t// \t\t\tconsole.log(prefix + '  ' + path.basename(f.name), f.track ? '' : '[new]');\n\t// \t\t}\n\t// \t}\n\t// }\n}\n\nfunction logChange(name: string, list: Array<any>) {\n\tif (list.length > 0) {\n\t\tlog.info(name, list.length);\n\t}\n}\n\nexport function logChanges(changes: MergeChanges) {\n\tconst v = moment.utc(changes.end - changes.start).format('HH:mm:ss.SSS');\n\tlog.info('Duration:', v);\n\tlogChange('Added Tracks', changes.newTracks);\n\tlogChange('Updated Tracks', changes.updateTracks);\n\tlogChange('Removed Tracks', changes.removedTracks);\n\tlogChange('Added Folders', changes.newFolders);\n\tlogChange('Updated Folders', changes.updateFolders);\n\tlogChange('Removed Folders', changes.removedFolders);\n\tlogChange('Added Artists', changes.newArtists);\n\tlogChange('Updated Artists', changes.updateArtists);\n\tlogChange('Removed Artists', changes.removedArtists);\n\tlogChange('Added Albums', changes.newAlbums);\n\tlogChange('Updated Albums', changes.updateAlbums);\n\tlogChange('Removed Albums', changes.removedAlbums);\n}\n\nexport const cVariousArtist = 'Various Artists';\nexport const cUnknownArtist = '[Unknown Artist]';\nexport const cUnknownAlbum = '[Unknown Album]';\n\ninterface MetaStatValue<T> {\n\tcount: number;\n\tval: T;\n}\n\ninterface MetaStatString extends MetaStatValue<string> {\n}\n\ninterface MetaStatNumber extends MetaStatValue<number> {\n}\n\ninterface MetaStat {\n\tartist?: string;\n\tartistSort?: string;\n\talbum?: string;\n\tgenre?: string;\n\tmbArtistID?: string;\n\tmbAlbumID?: string;\n\tmbReleaseGroupID?: string;\n\tmbAlbumType?: string;\n\tyear?: number;\n\thasMultipleArtists: boolean;\n\thasMultipleAlbums: boolean;\n\ttrackCount: number;\n\talbumType: AlbumType;\n}\n\nfunction convert2Numlist(o: { [key: string]: { count: number, val: string }; }): Array<MetaStatNumber> {\n\treturn Object.keys(o).map(key => {\n\t\treturn {count: o[key].count, val: Number(o[key].val)};\n\t}).sort((a, b) => {\n\t\treturn a.count - b.count;\n\t});\n}\n\nfunction convert2list(o: { [key: string]: { count: number, val: string }; }): Array<MetaStatString> {\n\treturn Object.keys(o).map(key => {\n\t\treturn o[key];\n\t}).sort((a, b) => {\n\t\treturn a.count - b.count;\n\t});\n}\n\nfunction getMostUsedTagValue<T>(list: Array<MetaStatValue<T>>, multi?: T): T | undefined {\n\tif (list.length === 0) {\n\t\treturn undefined;\n\t}\n\tif (list.length === 1) {\n\t\treturn list[0].val;\n\t}\n\tlist = list.sort((a, b) => b.count - a.count);\n\tif (list[0].count - list[1].count > 4) {\n\t\treturn list[0].val;\n\t}\n\tif (list.length > 3 && multi !== undefined) {\n\t\treturn multi;\n\t}\n\tconst cleaned = list.filter((o) => {\n\t\treturn o.count > 1;\n\t});\n\tif (cleaned.length > 1 && multi !== undefined) {\n\t\treturn multi;\n\t}\n\tif (cleaned.length > 0) {\n\t\treturn cleaned[0].val;\n\t}\n\tif (multi !== undefined) {\n\t\treturn multi;\n\t}\n\treturn list[0].val;\n}\n\nfunction splitDirectoryName(name: string): { title: string; year?: number; } {\n\tconst result: { title: string; year?: number; } = {title: path.basename(name).trim()};\n\t// year title | year - title | (year) title | [year] title\n\tconst parts = result.title.split(' ');\n\tconst s = parts[0].replace(/[^\\w\\s]/gi, '');\n\tif (s.length === 4) {\n\t\tconst y = parseInt(s, 10);\n\t\tif (!isNaN(y)) {\n\t\t\tresult.year = y;\n\t\t\tparts.shift();\n\t\t\tif (parts[0] === '-') {\n\t\t\t\tparts.shift();\n\t\t\t}\n\t\t\tresult.title = parts.join(' ');\n\t\t}\n\t}\n\treturn result;\n}\n\nfunction folderHasChanged(dir: MatchDir): boolean {\n\treturn (!dir.folder) ||\n\t\t(dir.stat.mtime !== dir.folder.stat.modified) ||\n\t\t(dir.stat.ctime !== dir.folder.stat.created) ||\n\t\t(!deepCompare(dir.folder.tag, dir.tag));\n}\n\nfunction trackHasChanged(file: MatchFile): boolean {\n\treturn (!file.track) ||\n\t\t(file.stat.mtime !== file.track.stat.modified) ||\n\t\t(file.stat.ctime !== file.track.stat.created) ||\n\t\t(file.stat.size !== file.track.stat.size);\n}\n\nfunction getArtistMBArtistID(trackInfo: MergeTrackInfo): string | undefined {\n\tif (trackInfo.dir.folder && trackInfo.dir.folder.tag.artist === cVariousArtist) {\n\t\treturn;\n\t} else {\n\t\treturn trackInfo.track.tag.mbAlbumArtistID || trackInfo.track.tag.mbArtistID;\n\t}\n}\n\nfunction getArtistNameSort(trackInfo: MergeTrackInfo): string | undefined {\n\tif (trackInfo.dir.folder && trackInfo.dir.folder.tag.artist === cVariousArtist) {\n\t\treturn;\n\t} else {\n\t\treturn trackInfo.track.tag.artistSort;\n\t}\n}\n\nfunction getArtistName(trackInfo: MergeTrackInfo): string {\n\treturn trackInfo.track.tag.albumArtist || trackInfo.track.tag.artist || cUnknownArtist;\n}\n\nfunction slugify(s: string): string {\n\treturn s.replace(/[\\[\\]\\. -]/g, '').toLowerCase();\n}\n\nfunction getArtistSlug(trackInfo: MergeTrackInfo): string {\n\treturn slugify(getArtistName(trackInfo));\n}\n\nfunction getAlbumName(trackInfo: MergeTrackInfo): string {\n\tif (trackInfo.dir.folder && trackInfo.dir.folder.tag.albumType === AlbumType.compilation) {\n\t\treturn trackInfo.dir.folder.tag.album || cUnknownAlbum;\n\t} else {\n\t\treturn trackInfo.track.tag.album || cUnknownAlbum;\n\t}\n}\n\nfunction getAlbumSlug(trackInfo: MergeTrackInfo): string {\n\treturn slugify(getAlbumName(trackInfo));\n}\n\nfunction extractAlbumName(name: string): string {\n\tconst result = name\n\t\t.replace(/\\(((\\d\\d\\d\\d)|(\\d* ?cds)|(cd ?\\d*)|(disc ?\\d*)|(disc ?\\d*:.*)|(bonus.*)|(.*edition)|(.*retail)|(\\d* of \\d*)|(eps?|bootleg|deluxe|promo|single|lp|limited edition|retro|ost|uvs|demp|demos|remastered|remix|live|remixes|vinyl|collection|maxi|bonus disc))\\)/gi, '')\n\t\t.replace(/\\[((\\d\\d\\d\\d)|(\\d* ?cds)|(cd ?\\d*)|(disc ?\\d*)|(disc ?\\d*:.*)|(bonus.*)|(.*edition)|(.*retail)|(\\d* of \\d*)|(eps?|bootleg|deluxe|promo|single|lp|limited edition|retro|ost|uvs|demp|demos|remastered|remix|live|remixes|vinyl|collection|maxi|bonus disc))\\]/gi, '')\n\t\t.replace(/-? cd\\d*/gi, '')\n\t\t.trim();\n\tif (result.length === 0) {\n\t\treturn name.trim();\n\t}\n\treturn result;\n}\n\nexport function generateArtworkId(folderID: string, filename: string): string {\n\tconst id = folderID + '-' + md5string(filename + filename);\n\treturn id;\n}\n\nexport class ScanService {\n\tprivate artistCache: Array<Artist> = [];\n\tprivate albumCache: Array<Album> = [];\n\tprivate strategy = RootScanStrategy.auto;\n\tprivate settings: Jam.AdminSettingsLibrary = {\n\t\tscanAtStart: true,\n\t\taudioBookGenreNames: []\n\t};\n\n\tconstructor(private store: Store, private audioModule: AudioModule, private imageModule: ImageModule, private waveformService: WaveformService) {\n\t}\n\n\tprivate buildMetaStat(dir: MatchDir): MetaStat {\n\t\tconst stats: {\n\t\t\t[name: string]: { [key: string]: { count: number, val: string }; };\n\t\t\tartist: { [key: string]: { count: number, val: string }; };\n\t\t\tartistSort: { [key: string]: { count: number, val: string }; };\n\t\t\talbum: { [key: string]: { count: number, val: string }; };\n\t\t\tgenre: { [key: string]: { count: number, val: string }; };\n\t\t\tmbArtistID: { [key: string]: { count: number, val: string }; };\n\t\t\tmbAlbumID: { [key: string]: { count: number, val: string }; };\n\t\t\tmbReleaseGroupID: { [key: string]: { count: number, val: string }; };\n\t\t\tmbAlbumType: { [key: string]: { count: number, val: string }; };\n\t\t\tyear: { [key: string]: { count: number, val: string }; };\n\t\t} = {\n\t\t\tartist: {},\n\t\t\tartistSort: {},\n\t\t\talbum: {},\n\t\t\tgenre: {},\n\t\t\tyear: {},\n\t\t\tmbArtistID: {},\n\t\t\tmbReleaseGroupID: {},\n\t\t\tmbAlbumID: {},\n\t\t\tmbAlbumType: {}\n\t\t};\n\t\tlet trackCount = 0;\n\n\t\tfunction statID(name: string, val?: string) {\n\t\t\tif (val && val.trim().length > 0) {\n\t\t\t\tconst slug = val.split(' ')[0];\n\t\t\t\tstats[name][slug] = stats[name][val] || {count: 0, val: slug};\n\t\t\t\tstats[name][slug].count += 1;\n\t\t\t}\n\t\t}\n\n\t\tfunction statNumber(name: string, val?: number) {\n\t\t\tif (val !== undefined) {\n\t\t\t\tconst slug = val.toString();\n\t\t\t\tstats[name][slug] = stats[name][slug] || {count: 0, val: val};\n\t\t\t\tstats[name][slug].count += 1;\n\t\t\t}\n\t\t}\n\n\t\tfunction statSlugValue(name: string, val?: string) {\n\t\t\tif (val && val.trim().length > 0) {\n\t\t\t\tconst slug = slugify(val);\n\t\t\t\tstats[name][slug] = stats[name][slug] || {count: 0, val: val};\n\t\t\t\tstats[name][slug].count += 1;\n\t\t\t}\n\t\t}\n\n\t\tfor (const file of dir.files) {\n\t\t\tif (file.type === FileTyp.AUDIO) {\n\t\t\t\ttrackCount++;\n\t\t\t\tif (file.track && file.track.tag) {\n\t\t\t\t\tconst tracktag = file.track.tag;\n\t\t\t\t\tstatSlugValue('artist', tracktag.albumArtist || tracktag.artist);\n\t\t\t\t\tstatSlugValue('artistSort', tracktag.albumArtistSort || tracktag.artistSort);\n\t\t\t\t\tstatSlugValue('genre', tracktag.genre);\n\t\t\t\t\tstatSlugValue('album', tracktag.album ? extractAlbumName(tracktag.album) : undefined);\n\t\t\t\t\tstatNumber('year', tracktag.year);\n\t\t\t\t\tstatSlugValue('mbAlbumType', tracktag.mbAlbumType);\n\t\t\t\t\tstatID('mbArtistID', tracktag.mbArtistID);\n\t\t\t\t\tstatID('mbAlbumID', tracktag.mbAlbumID);\n\t\t\t\t\tstatID('mbReleaseGroupID', tracktag.mbReleaseGroupID);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const sub of dir.directories) {\n\t\t\tif (sub.folder && sub.tag && (sub.tag.type !== FolderType.extras)) {\n\t\t\t\tconst subtag = sub.tag;\n\t\t\t\tstatSlugValue('artist', subtag.artist);\n\t\t\t\tstatSlugValue('artistSort', subtag.artistSort);\n\t\t\t\tstatSlugValue('album', subtag.album ? extractAlbumName(subtag.album) : undefined);\n\t\t\t\tstatSlugValue('genre', subtag.genre);\n\t\t\t\tstatNumber('year', subtag.year);\n\t\t\t\tstatSlugValue('mbAlbumType', subtag.mbAlbumType);\n\t\t\t\tstatID('mbArtistID', subtag.mbArtistID);\n\t\t\t\tstatID('mbAlbumID', subtag.mbAlbumID);\n\t\t\t\tstatID('mbReleaseGroupID', subtag.mbReleaseGroupID);\n\t\t\t}\n\t\t}\n\n\t\t// to easy to process lists\n\t\tconst artists = convert2list(stats.artist);\n\t\tconst artistSorts = convert2list(stats.artistSort);\n\t\tconst albums = convert2list(stats.album);\n\t\tconst genres = convert2list(stats.genre);\n\t\tconst years = convert2Numlist(stats.year);\n\t\tconst mbArtistIDs = convert2list(stats.mbArtistID);\n\t\tconst mbAlbumIDs = convert2list(stats.mbAlbumID);\n\t\tconst mbReleaseGroupIDs = convert2list(stats.mbReleaseGroupID);\n\t\tconst mbAlbumTypes = convert2list(stats.mbAlbumType);\n\n\t\t// heuristically most used values\n\t\tconst album = getMostUsedTagValue<string>(albums, extractAlbumName(path.basename(dir.name)));\n\t\tconst artist = getMostUsedTagValue<string>(artists, cVariousArtist);\n\t\tlet artistSort = getMostUsedTagValue<string>(artistSorts);\n\t\tconst genre = getMostUsedTagValue<string>(genres);\n\t\tconst mbAlbumID = getMostUsedTagValue<string>(mbAlbumIDs, '');\n\t\tconst mbReleaseGroupID = getMostUsedTagValue<string>(mbReleaseGroupIDs, '');\n\t\tconst mbAlbumType = getMostUsedTagValue<string>(mbAlbumTypes, '');\n\t\tconst mbArtistID = getMostUsedTagValue<string>(mbArtistIDs, '');\n\t\tconst year = getMostUsedTagValue<number>(years);\n\n\t\t// determinate album type\n\t\tconst hasMultipleArtists = artist === cVariousArtist;\n\t\tconst hasMultipleAlbums = albums.length > 1;\n\t\tif (hasMultipleArtists) {\n\t\t\tartistSort = undefined;\n\t\t}\n\t\tlet albumType = AlbumType.unknown;\n\t\tif (mbAlbumType) {\n\t\t\tconst t = mbAlbumType.toLowerCase();\n\t\t\tif (t.indexOf('audiobook') >= 0) {\n\t\t\t\talbumType = AlbumType.audiobook;\n\t\t\t} else if (t.indexOf('compilation') >= 0) {\n\t\t\t\talbumType = AlbumType.compilation;\n\t\t\t} else if (t.indexOf('album') >= 0) {\n\t\t\t\talbumType = AlbumType.album;\n\t\t\t}\n\t\t}\n\t\tif (genre && albumType === AlbumType.unknown) {\n\t\t\tconst g = genre.toLowerCase();\n\t\t\tconst audioBook = this.settings.audioBookGenreNames.find(a => a.toLowerCase().localeCompare(g) === 0);\n\t\t\tif (audioBook) {\n\t\t\t\talbumType = AlbumType.audiobook;\n\t\t\t}\n\t\t}\n\t\tif (albumType === AlbumType.unknown) {\n\t\t\tif (this.strategy === RootScanStrategy.audiobook) {\n\t\t\t\talbumType = AlbumType.audiobook;\n\t\t\t} else if (this.strategy === RootScanStrategy.compilation) {\n\t\t\t\talbumType = AlbumType.compilation;\n\t\t\t} else if (this.strategy === RootScanStrategy.artistalbum) {\n\t\t\t\talbumType = AlbumType.album;\n\t\t\t} else {\n\t\t\t\tif (hasMultipleArtists) {\n\t\t\t\t\talbumType = AlbumType.compilation;\n\t\t\t\t} else {\n\t\t\t\t\talbumType = AlbumType.album;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\ttrackCount,\n\t\t\talbumType,\n\t\t\thasMultipleArtists,\n\t\t\thasMultipleAlbums,\n\t\t\talbum,\n\t\t\tartist,\n\t\t\tartistSort,\n\t\t\tgenre,\n\t\t\tmbAlbumID,\n\t\t\tmbReleaseGroupID,\n\t\t\tmbAlbumType,\n\t\t\tmbArtistID,\n\t\t\tyear\n\t\t};\n\t}\n\n\tprivate async match(dir: ScanDir, changes: MergeChanges): Promise<MatchDir> {\n\t\tconst result: MatchDir = this.cloneScanDir(dir, undefined, 0);\n\t\tresult.folder = await this.store.folderStore.searchOne({path: dir.name});\n\t\tawait this.matchDirR(result, changes);\n\t\tconst removedFolders: Array<Folder> = changes.removedFolders;\n\t\tconst removedTracks: Array<Track> = changes.removedTracks;\n\t\tfor (const sub of changes.removedFolders) {\n\t\t\tconst folderList = await this.store.folderStore.search({inPath: sub.path});\n\t\t\tfor (const folder of folderList) {\n\t\t\t\tif (!removedFolders.find(f => f.id === folder.id)) {\n\t\t\t\t\tremovedFolders.push(folder);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst trackList = await this.store.trackStore.search({inPath: sub.path});\n\t\t\tfor (const track of trackList) {\n\t\t\t\tif (!removedTracks.find(t => t.id === track.id)) {\n\t\t\t\t\tremovedTracks.push(track);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tchanges.removedTracks = removedTracks;\n\t\tchanges.removedFolders = removedFolders;\n\t\treturn result;\n\t}\n\n\tprivate cloneScanDir(dir: ScanDir, parent: MatchDir | undefined, level: number): MatchDir {\n\t\tconst result: MatchDir = {\n\t\t\trootID: dir.rootID,\n\t\t\tparent,\n\t\t\tlevel,\n\t\t\tname: dir.name,\n\t\t\tstat: dir.stat,\n\t\t\tfolder: undefined,\n\t\t\tfiles: dir.files.map(file => {\n\t\t\t\treturn {name: file.name, type: file.type, stat: file.stat, rootID: dir.rootID};\n\t\t\t}),\n\t\t\tdirectories: []\n\t\t};\n\t\tresult.directories = dir.directories.map(sub => this.cloneScanDir(sub, result, level + 1));\n\t\treturn result;\n\t}\n\n\tprivate async matchDirR(dir: MatchDir, changes: MergeChanges): Promise<void> {\n\t\tlog.debug('Comparing:', dir.name);\n\t\tconst tracks = await this.store.trackStore.search({path: dir.name});\n\t\ttracks.forEach(track => {\n\t\t\tconst filename = path.join(track.path, track.name);\n\t\t\tconst file = dir.files.find(f => f.name === filename);\n\t\t\tif (file) {\n\t\t\t\tfile.track = track;\n\t\t\t} else {\n\t\t\t\tchanges.removedTracks.push(track);\n\t\t\t}\n\t\t});\n\t\tif (dir.folder) {\n\t\t\tconst folders = await this.store.folderStore.search({parentID: dir.folder.id});\n\t\t\tfor (const subFolder of folders) {\n\t\t\t\tconst subDir = dir.directories.find(sd => sd.name === subFolder.path);\n\t\t\t\tif (!subDir) {\n\t\t\t\t\tchanges.removedFolders.push(subFolder);\n\t\t\t\t} else {\n\t\t\t\t\tsubDir.folder = subFolder;\n\t\t\t\t\tawait this.matchDirR(subDir, changes);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async scanDirR(dir: string, stat: fse.Stats, rootID: string): Promise<ScanDir> {\n\t\tlog.debug('Scanning:', dir);\n\t\tconst result: ScanDir = {\n\t\t\tname: ensureTrailingPathSeparator(dir),\n\t\t\tstat: {\n\t\t\t\tctime: stat.ctime.valueOf(),\n\t\t\t\tmtime: stat.mtime.valueOf()\n\t\t\t},\n\t\t\trootID,\n\t\t\tdirectories: [],\n\t\t\tfiles: []\n\t\t};\n\t\tconst folders: Array<{ dir: string, stat: fse.Stats }> = [];\n\t\tconst list = await fse.readdir(dir);\n\t\tfor (const filename of list) {\n\t\t\tif (filename[0] !== '.') {\n\t\t\t\tconst sub = path.join(dir, filename);\n\t\t\t\tconst subStat = await fse.stat(sub);\n\t\t\t\tif (subStat.isDirectory()) {\n\t\t\t\t\tfolders.push({dir: sub, stat: subStat});\n\t\t\t\t} else {\n\t\t\t\t\tconst file: ScanFile = {\n\t\t\t\t\t\tname: sub,\n\t\t\t\t\t\ttype: getFileType(sub),\n\t\t\t\t\t\tstat: {\n\t\t\t\t\t\t\tctime: subStat.ctime.valueOf(),\n\t\t\t\t\t\t\tmtime: subStat.mtime.valueOf(),\n\t\t\t\t\t\t\tsize: subStat.size\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tresult.files.push(file);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const folder of folders) {\n\t\t\tconst sub = await this.scanDirR(folder.dir, folder.stat, rootID);\n\t\t\tresult.directories.push(sub);\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async scan(dir: string, rootID: string): Promise<ScanDir> {\n\t\tconst stat = await fse.stat(dir);\n\t\treturn this.scanDirR(dir, stat, rootID);\n\t}\n\n\tprivate buildDefaultTag(dir: MatchDir): FolderTag {\n\t\treturn {\n\t\t\tlevel: dir.level,\n\t\t\ttype: FolderType.unknown,\n\t\t\ttrackCount: dir.files.filter(t => t.type === FileTyp.AUDIO).length,\n\t\t\tfolderCount: dir.directories.length,\n\t\t};\n\t}\n\n\tprivate buildFolder(dir: MatchDir): Folder {\n\t\treturn {\n\t\t\tid: '',\n\t\t\trootID: dir.rootID,\n\t\t\tpath: ensureTrailingPathSeparator(dir.name),\n\t\t\tparentID: (dir.parent && dir.parent.folder ? dir.parent.folder.id : undefined),\n\t\t\tstat: {\n\t\t\t\tcreated: dir.stat.ctime,\n\t\t\t\tmodified: dir.stat.mtime\n\t\t\t},\n\t\t\ttag: dir.tag || this.buildDefaultTag(dir),\n\t\t\ttype: DBObjectType.folder\n\t\t};\n\t}\n\n\tprivate async buildTrack(file: MatchFile, parent: Folder): Promise<Track> {\n\t\tlog.info('Reading Track:', file.name);\n\t\tconst data = await this.audioModule.read(file.name);\n\t\tconst tag: TrackTag = data.tag || {format: TrackTagFormatType.none};\n\t\tif (!tag.title) {\n\t\t\ttag.title = path.basename(file.name);\n\t\t}\n\t\treturn {\n\t\t\tid: '',\n\t\t\trootID: file.rootID,\n\t\t\talbumID: '',\n\t\t\tartistID: '',\n\t\t\tparentID: (parent ? parent.id : ''),\n\t\t\tname: path.basename(file.name),\n\t\t\tpath: ensureTrailingPathSeparator(path.dirname(file.name)),\n\t\t\tstat: {\n\t\t\t\tcreated: file.stat.ctime,\n\t\t\t\tmodified: file.stat.mtime,\n\t\t\t\tsize: file.stat.size\n\t\t\t},\n\t\t\tmedia: data.media || {},\n\t\t\ttag,\n\t\t\ttype: DBObjectType.track\n\t\t};\n\t}\n\n\tprivate async buildMerge(dir: MatchDir, changes: MergeChanges): Promise<void> {\n\t\tif (!dir.folder) {\n\t\t\tconst folder = this.buildFolder(dir);\n\t\t\tfolder.id = await this.store.trackStore.getNewId();\n\t\t\tdir.folder = folder;\n\t\t\tchanges.newFolders.push(folder);\n\t\t}\n\t\tfor (const sub of dir.directories) {\n\t\t\tawait this.buildMerge(sub, changes);\n\t\t}\n\t\tfor (const file of dir.files) {\n\t\t\tif (file.type === FileTyp.AUDIO && dir.folder) {\n\t\t\t\tif (!file.track) {\n\t\t\t\t\tconst track = await this.buildTrack(file, dir.folder);\n\t\t\t\t\ttrack.id = await this.store.trackStore.getNewId();\n\t\t\t\t\tfile.track = track;\n\t\t\t\t\tchanges.newTracks.push({track, dir});\n\t\t\t\t} else if (trackHasChanged(file)) {\n\t\t\t\t\tconst old = file.track;\n\t\t\t\t\tif (!old) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst track = await this.buildTrack(file, dir.folder);\n\t\t\t\t\ttrack.id = old.id;\n\t\t\t\t\tfile.track = track;\n\t\t\t\t\tchanges.updateTracks.push({track, dir, oldTrack: old});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async mergeR(dir: MatchDir, changes: MergeChanges): Promise<void> {\n\t\tif (dir.folder) {\n\t\t\tif (folderHasChanged(dir)) {\n\t\t\t\tconst folder = this.buildFolder(dir);\n\t\t\t\tfolder.id = dir.folder.id;\n\t\t\t\tdir.folder = folder;\n\t\t\t\tconst newFolder = changes.newFolders.find(f => f.id === folder.id);\n\t\t\t\tif (!newFolder) {\n\t\t\t\t\tchanges.updateFolders.push(folder);\n\t\t\t\t} else {\n\t\t\t\t\tchanges.newFolders = changes.newFolders.filter(f => f.id !== folder.id);\n\t\t\t\t\tchanges.newFolders.push(folder);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (const d of dir.directories) {\n\t\t\t\tawait this.mergeR(d, changes);\n\t\t\t}\n\t\t} else {\n\t\t\treturn Promise.reject(Error('db entry must exists to compare ' + dir.name));\n\t\t}\n\t}\n\n\tprivate async merge(dir: MatchDir, forceMetaRefresh: boolean, rootID: string, changes: MergeChanges): Promise<void> {\n\t\tawait this.buildMerge(dir, changes);\n\t\tawait this.buildMergeTags(dir);\n\t\tawait this.mergeR(dir, changes);\n\t\tawait this.mergeMeta(dir, forceMetaRefresh, rootID, changes);\n\t}\n\n\tprivate collectFolderImages(dir: MatchDir): Array<Artwork> {\n\t\tif (!dir.folder) {\n\t\t\tlog.error('folder obj must has been created at this point');\n\t\t\treturn [];\n\t\t}\n\t\tconst folderID = dir.folder.id;\n\t\treturn dir.files.filter(file => file.type === FileTyp.IMAGE).map(file => {\n\t\t\tconst name = path.basename(file.name);\n\t\t\tconst lname = name.toLowerCase();\n\t\t\tconst types: Array<ArtworkImageType> = [];\n\t\t\tfor (const t in ArtworkImageType) {\n\t\t\t\tif (!Number(t)) {\n\t\t\t\t\tif (lname.indexOf(t) >= 0) {\n\t\t\t\t\t\ttypes.push(<ArtworkImageType>t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ((types.indexOf(ArtworkImageType.front) < 0) && (lname.indexOf('cover') >= 0 || lname.indexOf('folder') >= 0)) {\n\t\t\t\ttypes.push(ArtworkImageType.front);\n\t\t\t}\n\t\t\tif (types.length === 0) {\n\t\t\t\ttypes.push(ArtworkImageType.other);\n\t\t\t}\n\t\t\ttypes.sort((a, b) => a.localeCompare(b));\n\t\t\tconst id = generateArtworkId(folderID, name);\n\t\t\treturn {id, name, types, stat: {created: file.stat.ctime, modified: file.stat.mtime, size: file.stat.size}};\n\t\t});\n\t}\n\n\tprivate buildFolderTag(dir: MatchDir): FolderTag {\n\t\tconst metaStat = dir.metaStat;\n\t\tif (!metaStat) {\n\t\t\tthrow Error('internal error, metastat must exists');\n\t\t}\n\t\tconst nameSplit = splitDirectoryName(dir.name);\n\t\tconst images = this.collectFolderImages(dir);\n\t\tlet imageName: string | undefined;\n\t\tlet image = images.find(i => i.types.length === 1 && (i.types.indexOf(ArtworkImageType.front) >= 0));\n\t\tif (!image) {\n\t\t\timage = images.find(i => i.types.length === 1 && (i.types.indexOf(ArtworkImageType.artist) >= 0));\n\t\t}\n\t\tif (image) {\n\t\t\timageName = image.name;\n\t\t}\n\t\treturn {\n\t\t\ttrackCount: dir.files.filter(t => t.type === FileTyp.AUDIO).length,\n\t\t\tfolderCount: dir.directories.length,\n\t\t\tlevel: dir.level,\n\t\t\ttype: FolderType.unknown,\n\t\t\talbum: metaStat.album,\n\t\t\talbumType: metaStat.albumType,\n\t\t\tartist: metaStat.artist,\n\t\t\tartistSort: metaStat.artistSort,\n\t\t\ttitle: nameSplit.title,\n\t\t\timage: imageName,\n\t\t\tartworks: images,\n\t\t\tgenre: metaStat.genre,\n\t\t\tmbAlbumID: metaStat.mbAlbumID,\n\t\t\tmbReleaseGroupID: metaStat.mbReleaseGroupID,\n\t\t\tmbAlbumType: metaStat.mbAlbumType,\n\t\t\tmbArtistID: metaStat.mbArtistID,\n\t\t\tyear: (nameSplit.year !== undefined) ? nameSplit.year : metaStat.year\n\t\t};\n\t}\n\n\tprivate markMultiAlbumChilds(dir: MatchDir) {\n\t\tif (dir.tag && dir.tag.type !== FolderType.extras) {\n\t\t\tthis.setTagType(dir.tag, FolderType.multialbum);\n\t\t}\n\t\tdir.directories.forEach(d => {\n\t\t\tif (dir.tag && d.tag && d.tag.type !== FolderType.extras) {\n\t\t\t\t// parent multialbum gets same album type as child multialbum folder\n\t\t\t\tdir.tag.albumType = d.tag.albumType;\n\t\t\t}\n\t\t\tthis.markMultiAlbumChilds(d);\n\t\t});\n\t}\n\n\tprivate markArtistChilds(dir: MatchDir) {\n\t\tif (dir.tag && dir.tag.type === FolderType.artist) {\n\t\t\tthis.setTagType(dir.tag, FolderType.collection);\n\t\t}\n\t\tdir.directories.forEach(d => {\n\t\t\tthis.markArtistChilds(d);\n\t\t});\n\t}\n\n\tprivate applyFolderTagType(dir: MatchDir) {\n\t\tif (!dir.tag || !dir.metaStat) {\n\t\t\treturn;\n\t\t}\n\t\tconst metaStat = dir.metaStat;\n\t\tconst name = path.basename(dir.name).toLowerCase();\n\t\tlet result: FolderType = FolderType.unknown;\n\t\tif (dir.level === 0) {\n\t\t\tresult = FolderType.collection;\n\t\t} else if (name.match(/\\[(extra|various)\\]/) || name.match(/^(extra|various)$/)) {\n\t\t\t// TODO: generalise extra folder detection\n\t\t\tresult = FolderType.extras;\n\t\t} else if (metaStat.trackCount > 0) {\n\t\t\tconst dirCount = dir.directories.filter(d => !!d.tag && d.tag.type !== FolderType.extras).length;\n\t\t\tif (dirCount === 0) {\n\t\t\t\tresult = FolderType.album;\n\t\t\t} else {\n\t\t\t\tresult = FolderType.multialbum;\n\t\t\t}\n\t\t} else if (dir.directories.length > 0) {\n\t\t\tif (metaStat.hasMultipleAlbums) {\n\t\t\t\tif (metaStat.hasMultipleArtists) {\n\t\t\t\t\tresult = FolderType.collection;\n\t\t\t\t} else {\n\t\t\t\t\tresult = FolderType.artist;\n\t\t\t\t}\n\t\t\t} else if (dir.directories.length === 1) {\n\t\t\t\tresult = FolderType.artist;\n\t\t\t} else {\n\t\t\t\tresult = FolderType.multialbum;\n\t\t\t}\n\t\t} else if (dir.directories.length === 0 && dir.files.filter(f => f.type === FileTyp.AUDIO).length === 0) {\n\t\t\tresult = FolderType.extras;\n\t\t} else {\n\t\t\tresult = FolderType.album;\n\t\t}\n\t\tif (result === FolderType.multialbum) {\n\t\t\tconst a = dir.directories.find(d => {\n\t\t\t\treturn (!!d.tag && d.tag.type === FolderType.artist);\n\t\t\t});\n\t\t\tif (a) {\n\t\t\t\tresult = FolderType.collection;\n\t\t\t}\n\t\t}\n\t\tthis.setTagType(dir.tag, result);\n\t\tif (result === FolderType.multialbum) {\n\t\t\tthis.markMultiAlbumChilds(dir);\n\t\t} else if (result === FolderType.artist) {\n\t\t\tfor (const sub of dir.directories) {\n\t\t\t\tthis.markArtistChilds(sub);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate setTagType(tag: FolderTag, type: FolderType) {\n\t\ttag.type = type;\n\t\tswitch (type) {\n\t\t\tcase FolderType.collection:\n\t\t\t\ttag.albumType = undefined;\n\t\t\t\ttag.genre = undefined;\n\t\t\t\ttag.mbArtistID = undefined;\n\t\t\t\ttag.mbAlbumID = undefined;\n\t\t\t\ttag.mbAlbumType = undefined;\n\t\t\t\ttag.mbReleaseGroupID = undefined;\n\t\t\t\ttag.artist = undefined;\n\t\t\t\ttag.artistSort = undefined;\n\t\t\t\ttag.album = undefined;\n\t\t\t\ttag.year = undefined;\n\t\t\t\treturn;\n\t\t\tcase FolderType.artist:\n\t\t\t\ttag.albumType = undefined;\n\t\t\t\ttag.genre = undefined;\n\t\t\t\ttag.mbAlbumID = undefined;\n\t\t\t\ttag.mbAlbumType = undefined;\n\t\t\t\ttag.mbReleaseGroupID = undefined;\n\t\t\t\ttag.album = undefined;\n\t\t\t\ttag.year = undefined;\n\t\t\t\treturn;\n\t\t}\n\t}\n\n\tprivate async buildMergeTags(dir: MatchDir): Promise<void> {\n\t\tfor (const sub of dir.directories) {\n\t\t\tawait this.buildMergeTags(sub);\n\t\t}\n\t\tif (dir.folder) {\n\t\t\tdir.metaStat = this.buildMetaStat(dir);\n\t\t\tdir.tag = this.buildFolderTag(dir);\n\t\t}\n\t\tthis.applyFolderTagType(dir);\n\t}\n\n\tprivate async findArtistInDB(trackInfo: MergeTrackInfo): Promise<Artist | undefined> {\n\t\tconst mbArtistID = trackInfo.track.tag.mbAlbumArtistID || trackInfo.track.tag.mbArtistID;\n\t\tif (mbArtistID) {\n\t\t\tconst artist = await this.store.artistStore.searchOne({mbArtistID});\n\t\t\tif (artist) {\n\t\t\t\treturn artist;\n\t\t\t}\n\t\t}\n\t\treturn this.store.artistStore.searchOne({slug: getArtistSlug(trackInfo)});\n\t}\n\n\tprivate async findArtistInCache(trackInfo: MergeTrackInfo): Promise<Artist | undefined> {\n\t\tconst mbArtistID = trackInfo.track.tag.mbAlbumArtistID || trackInfo.track.tag.mbArtistID;\n\t\tif (mbArtistID) {\n\t\t\tconst artist = this.artistCache.find(a => a.mbArtistID === mbArtistID);\n\t\t\tif (artist) {\n\t\t\t\treturn artist;\n\t\t\t}\n\t\t}\n\t\tconst slug = getArtistSlug(trackInfo);\n\t\treturn this.artistCache.find(a => a.slug === slug);\n\t}\n\n\tprivate updateArtist(artist: Artist, trackInfo: MergeTrackInfo) {\n\t\tartist.slug = getArtistSlug(trackInfo);\n\t\tartist.name = getArtistName(trackInfo);\n\t\tartist.nameSort = getArtistNameSort(trackInfo);\n\t\tartist.mbArtistID = getArtistMBArtistID(trackInfo);\n\t}\n\n\tprivate async buildArtist(trackInfo: MergeTrackInfo): Promise<Artist> {\n\t\treturn {\n\t\t\tid: await this.store.artistStore.getNewId(),\n\t\t\ttype: DBObjectType.artist,\n\t\t\trootIDs: [],\n\t\t\tslug: getArtistSlug(trackInfo),\n\t\t\tname: getArtistName(trackInfo),\n\t\t\tnameSort: getArtistNameSort(trackInfo),\n\t\t\tmbArtistID: getArtistMBArtistID(trackInfo),\n\t\t\talbumTypes: [],\n\t\t\talbumIDs: [],\n\t\t\ttrackIDs: [],\n\t\t\tcreated: Date.now()\n\t\t};\n\t}\n\n\tprivate async findOrCreateArtist(trackInfo: MergeTrackInfo, changes: MergeChanges): Promise<Artist> {\n\t\tlet artist = await this.findArtistInCache(trackInfo);\n\t\tif (artist) {\n\t\t\treturn artist;\n\t\t}\n\t\tartist = await this.findArtistInDB(trackInfo);\n\t\tif (!artist) {\n\t\t\tartist = await this.buildArtist(trackInfo);\n\t\t\tchanges.newArtists.push(artist);\n\t\t} else {\n\t\t\tthis.updateArtist(artist, trackInfo);\n\t\t\tchanges.updateArtists.push(artist);\n\t\t}\n\t\tthis.artistCache.push(artist);\n\t\treturn artist;\n\t}\n\n\tprivate async findCompilationArtist(changes: MergeChanges): Promise<Artist | undefined> {\n\t\tconst slug = slugify(cVariousArtist);\n\t\tlet artist = await this.artistCache.find(a => a.slug === slug);\n\t\tif (artist) {\n\t\t\treturn artist;\n\t\t}\n\t\tartist = await this.store.artistStore.searchOne({slug});\n\t\tif (artist) {\n\t\t\tthis.artistCache.push(artist);\n\t\t}\n\t\treturn artist;\n\t}\n\n\tprivate async findOrCreateCompilationArtist(changes: MergeChanges): Promise<Artist> {\n\t\tlet artist = await this.findCompilationArtist(changes);\n\t\tif (!artist) {\n\t\t\tartist = {\n\t\t\t\tid: await this.store.artistStore.getNewId(),\n\t\t\t\ttype: DBObjectType.artist,\n\t\t\t\trootIDs: [],\n\t\t\t\tslug: slugify(cVariousArtist),\n\t\t\t\tname: cVariousArtist,\n\t\t\t\talbumTypes: [AlbumType.compilation, AlbumType.album, AlbumType.audiobook],\n\t\t\t\talbumIDs: [],\n\t\t\t\ttrackIDs: [],\n\t\t\t\tcreated: Date.now()\n\t\t\t};\n\t\t\tchanges.newArtists.push(artist);\n\t\t\tthis.artistCache.push(artist);\n\t\t\treturn artist;\n\t\t}\n\t\treturn artist;\n\t}\n\n\tprivate async findAlbumInDB(trackInfo: MergeTrackInfo, artistID: string): Promise<Album | undefined> {\n\t\tif (trackInfo.track.tag.mbAlbumID) {\n\t\t\tconst album = await this.store.albumStore.searchOne({mbAlbumID: trackInfo.track.tag.mbAlbumID});\n\t\t\tif (album) {\n\t\t\t\treturn album;\n\t\t\t}\n\t\t}\n\t\treturn this.store.albumStore.searchOne({slug: getAlbumSlug(trackInfo), artistID});\n\t}\n\n\tprivate async findAlbumInCache(trackInfo: MergeTrackInfo, artistID: string): Promise<Album | undefined> {\n\t\tif (trackInfo.track.tag.mbAlbumID) {\n\t\t\tconst album = await this.albumCache.find(a => a.mbAlbumID === trackInfo.track.tag.mbAlbumID);\n\t\t\tif (album) {\n\t\t\t\treturn album;\n\t\t\t}\n\t\t}\n\t\tconst name = getAlbumName(trackInfo);\n\t\treturn this.albumCache.find(a => (a.name === name) && (a.artistID === artistID));\n\t}\n\n\tprivate updateAlbum(album: Album, trackInfo: MergeTrackInfo) {\n\t\talbum.albumType = trackInfo.dir.folder && trackInfo.dir.folder.tag && trackInfo.dir.folder.tag.albumType !== undefined ? trackInfo.dir.folder.tag.albumType : AlbumType.unknown;\n\t\talbum.name = getAlbumName(trackInfo);\n\t\talbum.artist = getArtistName(trackInfo);\n\t\talbum.mbArtistID = getArtistMBArtistID(trackInfo);\n\t\talbum.mbAlbumID = trackInfo.track.tag.mbAlbumID;\n\t\talbum.genre = trackInfo.track.tag.genre;\n\t\talbum.year = trackInfo.track.tag.year;\n\t}\n\n\tprivate async buildAlbum(trackInfo: MergeTrackInfo, artistID: string): Promise<Album> {\n\t\treturn {\n\t\t\tid: await this.store.albumStore.getNewId(),\n\t\t\ttype: DBObjectType.album,\n\t\t\tslug: getAlbumSlug(trackInfo),\n\t\t\tname: getAlbumName(trackInfo),\n\t\t\talbumType: trackInfo.dir.folder && trackInfo.dir.folder.tag && trackInfo.dir.folder.tag.albumType !== undefined ? trackInfo.dir.folder.tag.albumType : AlbumType.unknown,\n\t\t\tartist: getArtistName(trackInfo),\n\t\t\tartistID: artistID,\n\t\t\tmbArtistID: getArtistMBArtistID(trackInfo),\n\t\t\tmbAlbumID: trackInfo.track.tag.mbAlbumID,\n\t\t\tgenre: trackInfo.track.tag.genre,\n\t\t\ttrackIDs: [],\n\t\t\trootIDs: [],\n\t\t\tyear: trackInfo.track.tag.year,\n\t\t\tduration: trackInfo.track.media.duration || 0,\n\t\t\tcreated: Date.now()\n\t\t};\n\t}\n\n\tprivate async findOrCreateAlbum(trackInfo: MergeTrackInfo, artistID: string, changes: MergeChanges): Promise<Album> {\n\t\tlet album = await this.findAlbumInCache(trackInfo, artistID);\n\t\tif (album) {\n\t\t\treturn album;\n\t\t}\n\t\talbum = await this.findAlbumInDB(trackInfo, artistID);\n\t\tif (!album) {\n\t\t\talbum = await this.buildAlbum(trackInfo, artistID);\n\t\t\tchanges.newAlbums.push(album);\n\t\t} else {\n\t\t\tthis.updateAlbum(album, trackInfo);\n\t\t\tchanges.updateAlbums.push(album);\n\t\t}\n\t\tthis.albumCache.push(album);\n\t\treturn album;\n\t}\n\n\tprivate async getAlbumByID(id: string, changes?: MergeChanges): Promise<Album | undefined> {\n\t\tlet album = this.albumCache.find(a => a.id === id);\n\t\tif (album) {\n\t\t\treturn album;\n\t\t}\n\t\talbum = await this.store.albumStore.byId(id);\n\t\tif (album) {\n\t\t\tthis.albumCache.push(album);\n\t\t\tif (changes) {\n\t\t\t\tchanges.updateAlbums.push(album);\n\t\t\t}\n\t\t}\n\t\treturn album;\n\t}\n\n\tprivate async getArtistByID(id: string, changes: MergeChanges): Promise<Artist | undefined> {\n\t\tlet artist = this.artistCache.find(a => a.id === id);\n\t\tif (artist) {\n\t\t\treturn artist;\n\t\t}\n\t\tartist = await this.store.artistStore.byId(id);\n\t\tif (artist) {\n\t\t\tthis.artistCache.push(artist);\n\t\t\tchanges.updateArtists.push(artist);\n\t\t}\n\t\treturn artist;\n\t}\n\n\tprivate async getTrackByID(id: string, changes: MergeChanges): Promise<Track | undefined> {\n\t\tconst trackInfo = changes.newTracks.find(a => a.track.id === id);\n\t\tif (trackInfo) {\n\t\t\treturn trackInfo.track;\n\t\t}\n\t\treturn await this.store.trackStore.byId(id);\n\t}\n\n\tprivate async getTracksByID(ids: Array<string>, changes: MergeChanges): Promise<Array<Track>> {\n\t\tconst result: Array<Track> = [];\n\t\tfor (const id of ids) {\n\t\t\tconst track = await this.getTrackByID(id, changes);\n\t\t\tif (track) {\n\t\t\t\tresult.push(track);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async getAlbumById(id: string, changes: MergeChanges): Promise<Album | undefined> {\n\t\tlet album = changes.newAlbums.find(a => a.id === id);\n\t\tif (album) {\n\t\t\treturn album;\n\t\t}\n\t\talbum = changes.updateAlbums.find(a => a.id === id);\n\t\tif (album) {\n\t\t\treturn album;\n\t\t}\n\t\treturn await this.store.albumStore.byId(id);\n\t}\n\n\tprivate async getAlbumsById(ids: Array<string>, changes?: MergeChanges): Promise<Array<Album>> {\n\t\tconst result: Array<Album> = [];\n\t\tfor (const id of ids) {\n\t\t\tconst track = await this.getAlbumByID(id, changes);\n\t\t\tif (track) {\n\t\t\t\tresult.push(track);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async addMeta(trackInfo: MergeTrackInfo, changes: MergeChanges): Promise<void> {\n\t\tif (trackInfo.dir.folder) {\n\t\t\tconst artist = await this.findOrCreateArtist(trackInfo, changes);\n\t\t\tartist.trackIDs.push(trackInfo.track.id);\n\t\t\tif (artist.rootIDs.indexOf(trackInfo.dir.rootID) < 0) {\n\t\t\t\tartist.rootIDs.push(trackInfo.dir.rootID);\n\t\t\t}\n\t\t\ttrackInfo.track.artistID = artist.id;\n\t\t\tlet album: Album;\n\t\t\tif (trackInfo.dir.folder.tag.artist === cVariousArtist) {\n\t\t\t\tconst compilationArtist = await this.findOrCreateCompilationArtist(changes);\n\t\t\t\tif (compilationArtist !== artist) {\n\t\t\t\t\tcompilationArtist.trackIDs.push(trackInfo.track.id);\n\t\t\t\t\tif (compilationArtist.rootIDs.indexOf(trackInfo.dir.rootID) < 0) {\n\t\t\t\t\t\tcompilationArtist.rootIDs.push(trackInfo.dir.rootID);\n\t\t\t\t\t}\n\t\t\t\t\tif (changes.newArtists.indexOf(compilationArtist) < 0 && changes.updateArtists.indexOf(compilationArtist) < 0) {\n\t\t\t\t\t\tchanges.updateArtists.push(compilationArtist);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\talbum = await this.findOrCreateAlbum(trackInfo, compilationArtist.id, changes);\n\t\t\t\talbum.artist = compilationArtist.name;\n\t\t\t\talbum.albumType = AlbumType.compilation;\n\t\t\t\tif (compilationArtist.albumIDs.indexOf(album.id) < 0) {\n\t\t\t\t\tcompilationArtist.albumIDs.push(album.id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\talbum = await this.findOrCreateAlbum(trackInfo, artist.id, changes);\n\t\t\t\talbum.albumType = (trackInfo.dir.folder.tag.albumType === undefined) ? AlbumType.unknown : trackInfo.dir.folder.tag.albumType;\n\t\t\t}\n\t\t\talbum.trackIDs.push(trackInfo.track.id);\n\t\t\ttrackInfo.track.albumID = album.id;\n\t\t\talbum.duration += (trackInfo.track.media.duration || 0);\n\t\t\tif (album.rootIDs.indexOf(trackInfo.dir.rootID) < 0) {\n\t\t\t\talbum.rootIDs.push(trackInfo.dir.rootID);\n\t\t\t}\n\t\t\tif (artist.albumTypes.indexOf(album.albumType) < 0) {\n\t\t\t\tartist.albumTypes.push(album.albumType);\n\t\t\t}\n\t\t\tif (artist.albumIDs.indexOf(album.id) < 0) {\n\t\t\t\tartist.albumIDs.push(album.id);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async removeMeta(track: Track, compilationArtist: Artist | undefined, changes: MergeChanges): Promise<void> {\n\t\tconst album = await this.getAlbumByID(track.albumID, changes);\n\t\tif (album) {\n\t\t\talbum.trackIDs = album.trackIDs.filter(id => id !== track.id);\n\t\t}\n\t\tconst artist = await this.getArtistByID(track.artistID, changes);\n\t\tif (artist) {\n\t\t\tartist.trackIDs = artist.trackIDs.filter(id => id !== track.id);\n\t\t}\n\t\tif (compilationArtist && compilationArtist.trackIDs.indexOf(track.id) >= 0) {\n\t\t\tcompilationArtist.trackIDs = compilationArtist.trackIDs.filter(id => id !== track.id);\n\t\t\tif (changes.newArtists.indexOf(compilationArtist) < 0 && changes.updateArtists.indexOf(compilationArtist) < 0) {\n\t\t\t\tchanges.updateArtists.push(compilationArtist);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate collectMergeTracks(dir: MatchDir): Array<MergeTrackInfo> {\n\t\tlet result = dir.files.filter(file => !!file.track).map(p => {\n\t\t\treturn {\n\t\t\t\ttrack: <Track>p.track,\n\t\t\t\tdir\n\t\t\t};\n\t\t});\n\t\tfor (const sub of dir.directories) {\n\t\t\tresult = result.concat(this.collectMergeTracks(sub));\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async mergeMeta(dir: MatchDir, forceMetaRefresh: boolean, rootID: string, changes: MergeChanges): Promise<void> {\n\t\t// merge new\n\t\tlog.debug('merge meta tracks new', changes.newTracks.length);\n\t\tfor (const trackInfo of changes.newTracks) {\n\t\t\tawait this.addMeta(trackInfo, changes);\n\t\t}\n\t\tconst compilationArtist = await this.findCompilationArtist(changes);\n\t\t// remove missing\n\t\tlog.debug('merge meta tracks remove', changes.removedTracks.length);\n\t\tfor (const track of changes.removedTracks) {\n\t\t\tawait this.removeMeta(track, compilationArtist, changes);\n\t\t}\n\t\t// update updated\n\t\tlog.debug('merge meta tracks update', changes.updateTracks.length);\n\t\tfor (const trackInfo of changes.updateTracks) {\n\t\t\tawait this.removeMeta(trackInfo.oldTrack, compilationArtist, changes);\n\t\t\tawait this.addMeta(trackInfo, changes);\n\t\t}\n\n\t\tif (forceMetaRefresh) {\n\t\t\tconst allArtistIDs = await this.store.artistStore.searchIDs({rootID});\n\t\t\tfor (const id of allArtistIDs) {\n\t\t\t\tawait this.getArtistByID(id, changes);\n\t\t\t}\n\t\t\tconst allAlbumIDs = await this.store.albumStore.searchIDs({rootID});\n\t\t\tfor (const id of allAlbumIDs) {\n\t\t\t\tawait this.getAlbumByID(id, changes);\n\t\t\t}\n\t\t}\n\n\t\tchanges.removedArtists = changes.updateArtists.filter(a => a.trackIDs.length === 0);\n\t\tchanges.updateArtists = changes.updateArtists.filter(a => changes.removedArtists.indexOf(a) < 0 && changes.newArtists.indexOf(a) < 0);\n\t\tchanges.removedAlbums = changes.updateAlbums.filter(a => a.trackIDs.length === 0);\n\t\tchanges.updateAlbums = changes.updateAlbums.filter(a => changes.removedAlbums.indexOf(a) < 0 && changes.newAlbums.indexOf(a) < 0);\n\t\tlog.debug('refresh albums', changes.updateAlbums.length);\n\t\tconst flatTracks = this.collectMergeTracks(dir);\n\t\tfor (const album of changes.updateAlbums) {\n\t\t\tconst rootIDs: Array<string> = [];\n\t\t\tlet duration = 0;\n\t\t\tconst trackInfos = flatTracks.filter(t => t.track && album.trackIDs.indexOf(t.track.id) >= 0);\n\t\t\tfor (const trackInfo of trackInfos) {\n\t\t\t\tif (trackInfo.track) {\n\t\t\t\t\tif (rootIDs.indexOf(trackInfo.track.rootID) < 0) {\n\t\t\t\t\t\trootIDs.push(trackInfo.track.rootID);\n\t\t\t\t\t}\n\t\t\t\t\tduration += (trackInfo.track.media.duration || 0);\n\t\t\t\t\tthis.updateAlbum(album, trackInfo);\n\t\t\t\t}\n\t\t\t}\n\t\t\talbum.rootIDs = rootIDs;\n\t\t\talbum.duration = duration;\n\t\t}\n\t\tlog.debug('refresh artists', changes.updateArtists.length);\n\t\tfor (const artist of changes.updateArtists) {\n\t\t\tconst rootIDs: Array<string> = [];\n\t\t\tconst albumTypes: Array<AlbumType> = [];\n\t\t\tconst trackInfos = flatTracks.filter(t => t.track && artist.trackIDs.indexOf(t.track.id) >= 0);\n\t\t\tfor (const trackInfo of trackInfos) {\n\t\t\t\tif (trackInfo.track) {\n\t\t\t\t\tif (rootIDs.indexOf(trackInfo.track.rootID) < 0) {\n\t\t\t\t\t\trootIDs.push(trackInfo.track.rootID);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.updateArtist(artist, trackInfo);\n\t\t\t}\n\t\t\tconst albums = await this.getAlbumsById(artist.albumIDs);\n\t\t\tfor (const album of albums) {\n\t\t\t\tif (albumTypes.indexOf(album.albumType) < 0) {\n\t\t\t\t\talbumTypes.push(album.albumType);\n\t\t\t\t}\n\t\t\t}\n\t\t\tartist.albumTypes = albumTypes;\n\t\t\tartist.rootIDs = rootIDs;\n\t\t}\n\t}\n\n\t/*\n\n\tclearID3(store: Store, imageModule: ImageModule, removeTracks: Array<Track>): Promise<void> {\n\t\tif (removeTracks.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tlog.debug('Cleaning ID3');\n\t\tconst trackIDs = removeTracks.map(track => track.id);\n\t\tconst albums = await store.albumStore.search({trackIDs});\n\t\talbums.forEach(album => {\n\t\t\tlet duration = 0;\n\t\t\talbum.trackIDs = album.trackIDs.filter(id => {\n\t\t\t\tconst track = removeTracks.find(t => t.id === id);\n\t\t\t\tif (track) {\n\t\t\t\t\tduration += (track.media.duration || 0);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t});\n\t\t\talbum.duration -= duration;\n\t\t});\n\t\tconst removeAlbums = albums.filter(album => album.trackIDs.length === 0).map(album => album.id);\n\t\tconst updateAlbums = albums.filter(album => album.trackIDs.length !== 0);\n\t\tif (removeAlbums.length > 0) {\n\t\t\tawait store.albumStore.remove(removeAlbums);\n\t\t\tawait store.stateStore.removeByQuery({destIDs: removeAlbums, type: DBObjectType.album});\n\t\t}\n\t\tif (updateAlbums.length > 0) {\n\t\t\tawait store.albumStore.replaceMany(updateAlbums);\n\t\t}\n\t\tconst artists = await store.artistStore.search({trackIDs});\n\t\tartists.forEach(artist => {\n\t\t\tartist.trackIDs = artist.trackIDs.filter(id => trackIDs.indexOf(id) < 0);\n\t\t\tartist.albumIDs = artist.albumIDs.filter(id => removeAlbums.indexOf(id) < 0);\n\t\t});\n\t\tconst removeArtists = artists.filter(artist => artist.trackIDs.length === 0).map(artist => artist.id);\n\t\tconst updateArtists = artists.filter(artist => artist.trackIDs.length !== 0);\n\t\tif (removeArtists.length > 0) {\n\t\t\tawait store.artistStore.remove(removeArtists);\n\t\t\tawait store.stateStore.removeByQuery({destIDs: removeArtists, type: DBObjectType.artist});\n\t\t}\n\t\tif (updateArtists.length > 0) {\n\t\t\tawait store.artistStore.replaceMany(updateArtists);\n\t\t}\n\t\tconst ids = removeAlbums.concat(removeArtists);\n\t\tawait imageModule.clearImageCacheByIDs(ids);\n\t}\n\n\t*/\n\n\tprivate async clean(changes: MergeChanges): Promise<void> {\n\t\tlet ids: Array<string> = [];\n\t\tif (changes.removedAlbums.length > 0) {\n\t\t\tlog.debug('Cleaning albums', changes.removedAlbums.length);\n\t\t\tconst albumIDs = changes.removedAlbums.map(a => a.id);\n\t\t\tawait this.store.albumStore.remove(albumIDs);\n\t\t\tawait this.store.stateStore.removeByQuery({destIDs: albumIDs, type: DBObjectType.album});\n\t\t}\n\t\tif (changes.removedArtists.length > 0) {\n\t\t\tlog.debug('Cleaning artists', changes.removedArtists.length);\n\t\t\tconst artistIDs = changes.removedArtists.map(a => a.id);\n\t\t\tawait this.store.artistStore.remove(artistIDs);\n\t\t\tawait this.store.stateStore.removeByQuery({destIDs: artistIDs, type: DBObjectType.artist});\n\t\t}\n\t\tif (changes.removedFolders.length > 0) {\n\t\t\tlog.debug('Cleaning folders', changes.removedFolders.length);\n\t\t\tconst folderIDs = changes.removedFolders.map(folder => folder.id);\n\t\t\tawait this.store.folderStore.remove(folderIDs);\n\t\t\tawait this.store.stateStore.removeByQuery({destIDs: folderIDs, type: DBObjectType.folder});\n\t\t\tids = folderIDs;\n\t\t}\n\t\tif (changes.removedTracks.length > 0) {\n\t\t\tlog.debug('Cleaning tracks', changes.removedTracks.length);\n\t\t\tconst trackIDs = changes.removedTracks.map(track => track.id);\n\t\t\tids = ids.concat(trackIDs);\n\t\t\tawait this.store.trackStore.remove(trackIDs);\n\t\t\tawait this.store.stateStore.removeByQuery({destIDs: trackIDs, type: DBObjectType.track});\n\t\t\tawait this.store.bookmarkStore.removeByQuery({destIDs: trackIDs});\n\t\t\tconst playlists = await this.store.playlistStore.search({trackIDs: trackIDs});\n\t\t\tif (playlists.length > 0) {\n\t\t\t\tfor (const playlist of playlists) {\n\t\t\t\t\tplaylist.trackIDs = playlist.trackIDs.filter(id => trackIDs.indexOf(id) < 0);\n\t\t\t\t\tif (playlist.trackIDs.length === 0) {\n\t\t\t\t\t\tawait this.store.playlistStore.remove(playlist.id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tawait updatePlayListTracks(this.store.trackStore, playlist);\n\t\t\t\t\t\tawait this.store.playlistStore.replace(playlist);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\tif (ids.length > 0) {\n\t\t\tawait this.imageModule.clearImageCacheByIDs(ids);\n\t\t\tawait this.waveformService.clearWaveformCacheByIDs(ids);\n\t\t}\n\t\t// await clearID3(this.store, this.imageModule, removeTracks);\n\t\t// await clearID3(this.store, this.imageModule, changes.removedTracks);\n\t}\n\n\tprivate emptyChanges(): MergeChanges {\n\t\tthis.artistCache = [];\n\t\tthis.albumCache = [];\n\t\tconst changes: MergeChanges = {\n\t\t\tnewArtists: [],\n\t\t\tupdateArtists: [],\n\t\t\tremovedArtists: [],\n\n\t\t\tnewAlbums: [],\n\t\t\tupdateAlbums: [],\n\t\t\tremovedAlbums: [],\n\n\t\t\tnewTracks: [],\n\t\t\tupdateTracks: [],\n\t\t\tremovedTracks: [],\n\n\t\t\tnewFolders: [],\n\t\t\tupdateFolders: [],\n\t\t\tremovedFolders: [],\n\t\t\tstart: Date.now(),\n\t\t\tend: 0,\n\t\t};\n\t\treturn changes;\n\t}\n\n\tprivate async storeChanges(changes: MergeChanges): Promise<void> {\n\t\tawait this.store.trackStore.bulk(changes.newTracks.map(t => t.track));\n\t\tawait this.store.trackStore.upsert(changes.updateTracks.map(t => t.track));\n\t\tawait this.store.folderStore.bulk(changes.newFolders);\n\t\tawait this.store.folderStore.upsert(changes.updateFolders);\n\n\t\tawait this.store.albumStore.bulk(changes.newAlbums);\n\t\tawait this.store.albumStore.upsert(changes.updateAlbums);\n\t\tawait this.store.artistStore.bulk(changes.newArtists);\n\t\tawait this.store.artistStore.upsert(changes.updateArtists);\n\t}\n\n\tasync run(dir: string, rootID: string, strategy: RootScanStrategy, forceMetaRefresh: boolean): Promise<MergeChanges> {\n\t\tthis.strategy = strategy || RootScanStrategy.auto;\n\t\tlog.info('Start:', dir);\n\t\t/*\n \tProcessing:\n\n \t* read folders and files stats into tree\n \t* build new folder/files objs into tree\n \t* build Album and Artist meta data\n \t* store data in db\n \t* clean db for removed folders and files\n\n\t\t */\n\n\t\tconst changes = this.emptyChanges();\n\n\t\t// first, scan the filesystem\n\t\tconst scan: ScanDir = await this.scan(dir, rootID);\n\n\t\t// second, match db entries\n\t\tlog.info('Matching:', dir);\n\t\tconst match: MatchDir = await this.match(scan, changes);\n\n\t\t// third, merge\n\t\tlog.info('Merging:', dir);\n\t\tawait this.merge(match, forceMetaRefresh, rootID, changes);\n\t\t// printTree(match);\n\n\t\t// fourth, store\n\t\tlog.info('Storing:', dir);\n\t\tawait this.storeChanges(changes);\n\n\t\t// fifth, clean\n\t\tlog.info('Cleaning:', dir);\n\t\tawait this.clean(changes);\n\n\t\tchanges.end = Date.now();\n\t\treturn changes;\n\t}\n\n\tasync removeRoot(rootID: string): Promise<MergeChanges> {\n\t\tconst changes = this.emptyChanges();\n\t\tchanges.removedTracks = await this.store.trackStore.search({rootID});\n\t\tchanges.removedFolders = await this.store.folderStore.search({rootID});\n\t\tconst trackIDs = changes.removedTracks.map(t => t.id);\n\t\tconst artists = await this.store.artistStore.search({rootID});\n\t\tfor (const artist of artists) {\n\t\t\tartist.rootIDs = artist.rootIDs.filter(r => r !== rootID);\n\t\t\tif (artist.rootIDs.length === 0) {\n\t\t\t\tchanges.removedArtists.push(artist);\n\t\t\t} else {\n\t\t\t\tartist.trackIDs = artist.trackIDs.filter(trackID => trackIDs.indexOf(trackID) < 0);\n\t\t\t\tif (artist.trackIDs.length === 0) {\n\t\t\t\t\tchanges.removedArtists.push(artist);\n\t\t\t\t} else {\n\t\t\t\t\tchanges.updateArtists.push(artist);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconst albums = await this.store.albumStore.search({rootID});\n\t\tfor (const album of albums) {\n\t\t\talbum.rootIDs = album.rootIDs.filter(r => r !== rootID);\n\t\t\tif (album.rootIDs.length === 0) {\n\t\t\t\tchanges.removedAlbums.push(album);\n\t\t\t} else {\n\t\t\t\talbum.trackIDs = album.trackIDs.filter(trackID => trackIDs.indexOf(trackID) < 0);\n\t\t\t\tif (album.trackIDs.length === 0) {\n\t\t\t\t\tchanges.removedAlbums.push(album);\n\t\t\t\t} else {\n\t\t\t\t\tchanges.updateAlbums.push(album);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tawait this.store.albumStore.upsert(changes.updateAlbums);\n\t\tawait this.store.artistStore.upsert(changes.updateArtists);\n\t\tawait this.clean(changes);\n\t\tawait this.store.rootStore.remove(rootID);\n\t\treturn changes;\n\t}\n\n\tasync buildMatchFileFromDB(track: Track): Promise<MatchFile> {\n\t\tconst match: MatchFile = {\n\t\t\trootID: track.rootID,\n\t\t\ttrack,\n\t\t\tname: path.join(track.path, track.name),\n\t\t\ttype: FileTyp.AUDIO,\n\t\t\tstat: {\n\t\t\t\tctime: track.stat.created,\n\t\t\t\tmtime: track.stat.modified,\n\t\t\t\tsize: track.stat.size\n\t\t\t}\n\t\t};\n\t\treturn match;\n\t}\n\n\tasync buildMatchDirFromDBData(folder: Folder, data: { folders: Array<Folder>, tracks: Array<Track> }, parent?: MatchDir): Promise<MatchDir> {\n\t\tconst match: MatchDir = {\n\t\t\tname: folder.path,\n\t\t\tlevel: folder.tag.level,\n\t\t\trootID: folder.rootID,\n\t\t\ttag: folder.tag,\n\t\t\tstat: {ctime: folder.stat.created, mtime: folder.stat.modified},\n\t\t\tparent,\n\t\t\tfolder: folder,\n\t\t\tfiles: [],\n\t\t\tdirectories: [],\n\t\t\tmetaStat: undefined\n\t\t};\n\t\tconst folders = data.folders.filter(f => f.parentID === folder.id);\n\t\tfor (const f of folders) {\n\t\t\tmatch.directories.push(await this.buildMatchDirFromDBData(f, data, match));\n\t\t}\n\t\tconst tracks = data.tracks.filter(t => t.parentID === folder.id);\n\t\tfor (const t of tracks) {\n\t\t\tmatch.files.push(await this.buildMatchFileFromDB(t));\n\t\t}\n\t\tif (folder.tag.artworks) {\n\t\t\tfor (const art of folder.tag.artworks) {\n\t\t\t\tconst matchFile: MatchFile = {\n\t\t\t\t\trootID: folder.rootID,\n\t\t\t\t\tname: path.join(folder.path, art.name),\n\t\t\t\t\ttype: FileTyp.IMAGE,\n\t\t\t\t\tstat: {\n\t\t\t\t\t\tctime: art.stat.created,\n\t\t\t\t\t\tmtime: art.stat.modified,\n\t\t\t\t\t\tsize: art.stat.size\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tmatch.files.push(matchFile);\n\t\t\t}\n\t\t}\n\t\treturn match;\n\t}\n\n\tasync refreshTracks(rootID: string, trackIDs: Array<string>, strategy: RootScanStrategy) {\n\t\tthis.strategy = strategy || RootScanStrategy.auto;\n\t\tconst changes = this.emptyChanges();\n\n\t\tconst folders = await this.store.folderStore.search({rootID});\n\t\tconst tracks = await this.store.trackStore.search({rootID});\n\n\t\tconst folder = folders.find(f => f.tag.level === 0);\n\t\tif (!folder) {\n\t\t\treturn Promise.reject(Error('Root folder not found'));\n\t\t}\n\n\t\tconst match: MatchDir = await this.buildMatchDirFromDBData(folder, {folders, tracks});\n\n\t\tconst changedDirs: Array<MatchDir> = [];\n\t\tconst changedFiles: Array<MatchFile> = [];\n\n\t\tfunction collectR(dir: MatchDir) {\n\t\t\tfor (const file of dir.files) {\n\t\t\t\tif (file.track && trackIDs.indexOf(file.track.id) >= 0) {\n\t\t\t\t\tchangedFiles.push(file);\n\t\t\t\t\tif (changedDirs.indexOf(dir) < 0) {\n\t\t\t\t\t\tchangedDirs.push(dir);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (const sub of dir.directories) {\n\t\t\t\tcollectR(sub);\n\t\t\t}\n\t\t}\n\n\t\tcollectR(match);\n\n\t\tfor (const file of changedFiles) {\n\t\t\tconst stat = await fse.stat(file.name);\n\t\t\tfile.stat = {\n\t\t\t\tctime: stat.ctime.valueOf(),\n\t\t\t\tmtime: stat.mtime.valueOf(),\n\t\t\t\tsize: stat.size\n\t\t\t};\n\t\t}\n\t\tfor (const dir of changedDirs) {\n\t\t\tconst stat = await fse.stat(dir.name);\n\t\t\tdir.stat = {\n\t\t\t\tctime: stat.ctime.valueOf(),\n\t\t\t\tmtime: stat.mtime.valueOf()\n\t\t\t};\n\t\t}\n\n\t\tawait this.merge(match, false, rootID, changes);\n\t\t// printTree(match);\n\t\tawait this.storeChanges(changes);\n\t\tawait this.clean(changes);\n\t\tchanges.end = Date.now();\n\t\treturn changes;\n\n\t}\n\n\tpublic setSettings(settings: Jam.AdminSettingsLibrary) {\n\t\tthis.settings = settings;\n\t}\n}\n","import {AudioFormatType, FileTyp} from '../model/jam-types';\nimport {fileSuffix} from './fs-utils';\n\nexport const SupportedReadImageFormat = ['bmp', 'png', 'jpeg', 'jpg', 'gif', 'tiff'];\nexport const SupportedWriteImageFormat = ['bmp', 'png', 'jpeg', 'jpg', 'tiff'];\n\nexport const SupportedAudioFormat: Array<AudioFormatType> = [AudioFormatType.mp3, AudioFormatType.flac, AudioFormatType.m4a, AudioFormatType.ogg, AudioFormatType.oga, AudioFormatType.webma, AudioFormatType.wav];\nexport const SupportedTranscodeAudioFormat: Array<AudioFormatType> = [AudioFormatType.mp3, AudioFormatType.flv, AudioFormatType.ogg, AudioFormatType.oga, AudioFormatType.flac, AudioFormatType.m4a];\n\nexport function getFileType(filename: string): FileTyp {\n\tconst suffix = fileSuffix(filename);\n\tif (SupportedReadImageFormat.indexOf(suffix) >= 0) {\n\t\treturn FileTyp.IMAGE;\n\t} else if (SupportedAudioFormat.indexOf(<AudioFormatType>suffix) >= 0) {\n\t\treturn FileTyp.AUDIO;\n\t} else if (['tag'].indexOf(suffix) >= 0) {\n\t\treturn FileTyp.TAG;\n\t} else if (['bak'].indexOf(suffix) >= 0) {\n\t\treturn FileTyp.BACKUP;\n\t}\n\treturn FileTyp.OTHER;\n}\n","module.exports = require(\"request\");","import express from 'express';\nimport {IApiBinaryResult, NodeError} from '../../typings';\nimport path from 'path';\nimport {toXML} from '../../utils/to-xml';\nimport {SubsonicParameterRequest} from './parameters';\nimport {FORMAT} from './format';\n\nexport class ApiResponder {\n\n\tpublic static ok(req: express.Request, res: express.Response) {\n\t\tApiResponder.send(req, res, FORMAT.packOK());\n\t}\n\n\tprivate static send(req: express.Request, res: express.Response, data: any) {\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\tconst params = (<SubsonicParameterRequest>req).parameters;\n\t\tif ((params.format === 'jsonp') && (params.callback)) {\n\t\t\tres.status(200).send(params.callback + '(' + JSON.stringify(data) + ');');\n\t\t} else if (params.format === 'json') {\n\t\t\tres.status(200).json(data);\n\t\t} else {\n\t\t\tres.set('Content-Type', 'application/xml');\n\t\t\tres.status(200).send(toXML(data));\n\t\t}\n\t}\n\n\tpublic static data(req: express.Request, res: express.Response, data: any) {\n\t\tApiResponder.send(req, res, FORMAT.packResponse(data));\n\t}\n\n\tpublic static error(req: express.Request, res: express.Response, err: NodeError) {\n\t\tif (err.fail) {\n\t\t\tApiResponder.send(req, res, FORMAT.packFail(err.fail, err.text));\n\t\t} else {\n\t\t\tApiResponder.send(req, res, FORMAT.packFail(FORMAT.FAIL.GENERIC, (typeof err === 'string' ? err : (err.message || 'Unknown Error')).toString()));\n\t\t}\n\t}\n\n\tpublic static binary(req: express.Request, res: express.Response, data: IApiBinaryResult) {\n\t\tif (data.pipe) {\n\t\t\tdata.pipe.pipe(res);\n\t\t} else if (data.buffer) {\n\t\t\tres.set('Content-Type', data.buffer.contentType);\n\t\t\tres.set('Content-Length', data.buffer.buffer.length.toString());\n// \t\t\tres.set('Cache-Control', 'public, max-age=' + config.max_age);\n\t\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\t\tres.status(200).send(data.buffer.buffer);\n\t\t} else if (data.file) {\n\t\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\t\tres.sendFile(data.file.filename, data.file.name || path.basename(data.file.filename));\n\t\t}\n\t}\n}\n","module.exports = require(\"crypto\");","import crypto from 'crypto';\nimport {randomString} from './random';\n\nfunction generateSalt(): string {\n\treturn randomString(16);\n}\n\nexport function hashSalt(password: string, salt: string): string {\n\t/** Hashing algorithm sha512 */\n\tconst hash = crypto.createHmac('sha512', salt);\n\thash.update(password);\n\treturn hash.digest('hex');\n}\n\nexport function hashSaltPassword(password: string): { salt: string, hash: string } {\n\tconst salt = generateSalt();\n\treturn {salt, hash: hashSalt(password, salt)};\n}\n","module.exports = require(\"fs\");","export const JAMSERVE_VERSION = '0.1.2';\nexport const JAMAPI_VERSION = '0.1.1';\n","module.exports = require(\"express\");","import express from 'express';\nimport {IApiBinaryResult, NodeError} from '../../typings';\nimport path from 'path';\n\nexport class ApiResponder {\n\n\tpublic static ok(res: express.Response) {\n\t\tres.status(200).json({});\n\t}\n\n\tpublic static data(res: express.Response, data: any) {\n\t\tres.status(200).json(data);\n\t}\n\n\tpublic static error(res: express.Response, err: NodeError) {\n\t\tconst msg = (typeof err === 'string' ? err : (err.message || 'Guru Meditation')).toString();\n\t\tconst code = (typeof err.failCode === 'number' ? err.failCode : 500);\n\t\tres.status(code || 500).json({error: msg});\n\t}\n\n\tpublic static binary(res: express.Response, data: IApiBinaryResult) {\n\t\tif (data.json) {\n\t\t\tres.status(200).json(data.json);\n\t\t} else if (data.pipe) {\n\t\t\tdata.pipe.pipe(res);\n\t\t} else if (data.buffer) {\n\t\t\tres.set('Content-Type', data.buffer.contentType);\n\t\t\tres.set('Content-Length', data.buffer.buffer.length.toString());\n// \t\t\tres.set('Cache-Control', 'public, max-age=' + config.max_age);\n\t\t\tres.status(200).send(data.buffer.buffer);\n\t\t} else if (data.file) {\n\t\t\tres.sendFile(data.file.filename, data.file.name || path.basename(data.file.filename));\n\t\t}\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Track, TrackTag} from './track.model';\n\nexport function formatTrackTag(tag: TrackTag): Jam.TrackTag {\n\tlet mbz: Jam.TrackMBTag | undefined = {\n\t\trecordingID: tag.mbRecordingID,\n\t\treleaseTrackID: tag.mbReleaseTrackID,\n\t\treleaseGroupID: tag.mbReleaseGroupID,\n\t\ttrackID: tag.mbTrackID,\n\t\tartistID: tag.mbArtistID,\n\t\treleaseID: tag.mbAlbumID\n\t};\n\tif (!Object.keys(mbz).find(key => !!(<any>mbz)[key])) {\n\t\tmbz = undefined;\n\t}\n\treturn {\n\t\ttrackNr: tag.track,\n\t\tdisc: tag.discTotal !== undefined && tag.discTotal > 1 ? tag.disc : undefined,\n\t\tyear: tag.year,\n\t\ttitle: tag.title,\n\t\tartist: tag.artist,\n\t\talbum: tag.album,\n\t\tgenre: tag.genre,\n\t\tmusicbrainz: mbz\n\t};\n}\n\nexport function formatTrack(track: Track, includes: JamParameters.IncludesTrack): Jam.Track {\n\tincludes = includes || {};\n\treturn {\n\t\tid: track.id,\n\t\tparentID: track.parentID,\n\t\tartistID: track.artistID,\n\t\talbumID: track.albumID,\n\t\tname: track.name,\n\t\tcreated: track.stat.created,\n\t\tduration: track.media.duration || -1,\n\t\tmedia: includes.trackMedia ? {\n\t\t\tbitRate: track.media.bitRate || -1,\n\t\t\tformat: track.media.format || '',\n\t\t\tchannels: track.media.channels || -1,\n\t\t\tsampleRate: track.media.sampleRate || -1\n\t\t} : undefined,\n\t\ttag: includes.trackTag ? formatTrackTag(track.tag) : undefined\n\t};\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {User, UserRoles} from './user.model';\n\nfunction formatRoles(roles: UserRoles): Jam.Roles {\n\treturn {\n\t\t// coverArt: roles.coverArtRole ? true : undefined,\n\t\tstream: roles.stream ? true : undefined,\n\t\tupload: roles.upload ? true : undefined,\n\t\tadmin: roles.admin ? true : undefined,\n\t\tpodcast: roles.podcast ? true : undefined,\n\t\t// settings: roles.settingsRole ? true : undefined,\n\t\t// download: roles.downloadRole ? true : undefined,\n\t\t// playlist: roles.playlistRole ? true : undefined,\n\t\t// comment: roles.commentRole ? true : undefined,\n\t\t// jukebox: roles.jukeboxRole ? true : undefined,\n\t\t// share: roles.shareRole ? true : undefined,\n\t\t// videoConversion: roles.videoConversionRole ? true : undefined\n\t};\n}\n\nexport function formatUser(user: User): Jam.User {\n\treturn {\n\t\tid: user.id,\n\t\tcreated: user.created,\n\t\tname: user.name,\n\t\temail: user.email,\n\t\troles: formatRoles(user.roles)\n\t};\n}\n\n\nexport function formatSessionUser(user: User): Jam.SessionUser {\n\treturn {\n\t\tid: user.id,\n\t\tcreated: user.created,\n\t\tname: user.name,\n\t\troles: formatRoles(user.roles)\n\t};\n}\n\n","import {DBObjectType} from '../../db/db.types';\nimport {Playlist} from './playlist.model';\nimport {Track} from '../track/track.model';\nimport {PlaylistStore, SearchQueryPlaylist} from './playlist.store';\nimport {TrackStore} from '../track/track.store';\nimport {BaseStoreService} from '../base/base.service';\n\nexport async function updatePlayListTracks(trackStore: TrackStore, playlist: Playlist): Promise<void> {\n\tconst tracks = await trackStore.byIds(playlist.trackIDs);\n\tconst trackHash: { [id: string]: Track } = {};\n\ttracks.forEach(track => {\n\t\ttrackHash[track.id] = track;\n\t});\n\tplaylist.trackIDs = playlist.trackIDs.filter(id => !!trackHash[id]);\n\tplaylist.duration = 0;\n\tplaylist.trackIDs.forEach(id => {\n\t\tconst track = trackHash[id];\n\t\tplaylist.duration += (track.media.duration || 0);\n\t});\n}\n\nexport class PlaylistService extends BaseStoreService<Playlist, SearchQueryPlaylist> {\n\n\tconstructor(public playlistStore: PlaylistStore, private trackStore: TrackStore) {\n\t\tsuper(playlistStore);\n\t}\n\n\tasync create(name: string, comment: string | undefined, isPublic: boolean, userID: string, trackIDs: Array<string>): Promise<Playlist> {\n\t\tconst now = Date.now();\n\t\tconst playlist: Playlist = {\n\t\t\tid: '',\n\t\t\ttype: DBObjectType.playlist,\n\t\t\tname: name,\n\t\t\tcomment: comment,\n\t\t\tisPublic: isPublic,\n\t\t\tuserID: userID,\n\t\t\tcreated: now,\n\t\t\tchanged: now,\n\t\t\ttrackIDs: trackIDs,\n\t\t\tduration: 0\n\t\t};\n\t\tawait updatePlayListTracks(this.trackStore, playlist);\n\t\tplaylist.id = await this.playlistStore.add(playlist);\n\t\treturn playlist;\n\t}\n\n\tasync update(playlist: Playlist): Promise<void> {\n\t\tawait updatePlayListTracks(this.trackStore, playlist);\n\t\tawait this.playlistStore.replace(playlist);\n\t}\n\n\tasync remove(playlist: Playlist): Promise<void> {\n\t\treturn this.playlistStore.remove(playlist.id);\n\t}\n}\n","module.exports = require(\"limiter\");","import {getBinPath} from './which';\nimport {spawn} from 'child_process';\n\nexport async function spawnToolStream(binName: string, envName: string, args: Array<string>, onData: (buffer: Buffer) => void): Promise<string> {\n\tconst bin = await getBinPath(binName, envName);\n\tif (!bin || bin.length === 0) {\n\t\treturn Promise.reject(Error('Tool binary not found ' + binName));\n\t}\n\treturn new Promise<string>((resolve, reject) => {\n\t\tconst child = spawn(bin, args);\n\t\tlet stderr = '';\n\t\tchild.stdout.on('data', (data: Buffer) => {\n\t\t\tonData(data);\n\t\t});\n\t\tchild.stderr.on('data', (data: Buffer) => {\n\t\t\tstderr += data.toString();\n\t\t});\n\t\tchild.on('close', (code: number) => {\n\t\t\tresolve(stderr);\n\t\t});\n\t});\n}\n\nexport async function spawnTool(binName: string, envName: string, args: Array<string>): Promise<string> {\n\tconst bin = await getBinPath(binName, envName);\n\tif (!bin || bin.length === 0) {\n\t\treturn Promise.reject(Error('Tool binary not found ' + binName));\n\t}\n\treturn new Promise<string>((resolve, reject) => {\n\t\tconst child = spawn(bin, args);\n\t\tlet result = '';\n\t\tlet error = '';\n\t\tchild.stdout.on('data', (data: Buffer) => {\n\t\t\tresult += data.toString();\n\t\t});\n\t\tchild.stderr.on('data', (data: Buffer) => {\n\t\t\terror += data.toString();\n\t\t});\n\t\tchild.on('close', (code: number) => {\n\t\t\tresolve(result);\n\t\t});\n\t});\n}\n\nexport async function spawnToolJson<T>(binName: string, envName: string, args: Array<string>): Promise<T> {\n\tconst data = await spawnTool(binName, envName, args);\n\treturn JSON.parse(data);\n}\n","module.exports = require(\"fluent-ffmpeg\");","import request from 'request';\nimport fs from 'fs';\nimport * as http from 'http';\nimport {fileDeleteIfExists} from './fs-utils';\n\nexport function downloadFile(url: string, filename: string): Promise<void> {\n\treturn new Promise<void>((resolve, reject) => {\n\t\trequest.get(url)\n\t\t\t.on('error', (err: Error) => {\n\t\t\t\treject(err);\n\t\t\t})\n\t\t\t.on('complete', (res: { statusCode: number }) => {\n\t\t\t\tif (res.statusCode !== 200) {\n\t\t\t\t\tfileDeleteIfExists(filename).then(() => {\n\t\t\t\t\t\treject(new Error(http.STATUS_CODES[res.statusCode]));\n\t\t\t\t\t}).catch(e => {\n\t\t\t\t\t\treject(new Error(http.STATUS_CODES[res.statusCode]));\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.pipe(fs.createWriteStream(filename));\n\t});\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {formatTrackTag} from '../track/track.format';\nimport {Episode} from './episode.model';\nimport {PodcastStatus} from '../../model/jam-types';\n\nexport function formatEpisode(episode: Episode, includes: JamParameters.IncludesTrack, status: PodcastStatus): Jam.PodcastEpisode {\n\treturn {\n\t\tid: episode.id,\n\t\tparentID: '',\n\t\tcreated: episode.stat ? episode.stat.created : 0,\n\t\tpodcastID: episode.podcastID,\n\t\tstatus: <Jam.PodcastEpisodeStatusType>status,\n\t\terrorMessage: episode.error,\n\t\tname: episode.name,\n\t\tduration: episode.media ? (episode.media.duration || -1) : -1,\n\t\tdate: episode.date,\n\t\tsummary: episode.summary,\n\t\tguid: episode.guid,\n\t\tauthor: episode.author,\n\t\tlink: episode.link,\n\t\tmedia: includes.trackMedia && episode.media ? {\n\t\t\tbitRate: episode.media.bitRate || -1,\n\t\t\tformat: episode.media.format || '',\n\t\t\tchannels: episode.media.channels || -1,\n\t\t\tsampleRate: episode.media.sampleRate || -1\n\t\t} : undefined,\n\t\ttag: includes.trackTag && episode.tag ? formatTrackTag(episode.tag) : undefined\n\t};\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {ArtistIndex, FolderIndex} from './index.model';\n\nexport function formatArtistIndex(index: ArtistIndex): Jam.ArtistIndex {\n\treturn {\n\t\tlastModified: index.lastModified,\n\t\tgroups: index.groups.map(i => ({\n\t\t\tname: i.name,\n\t\t\tentries: i.entries.map(e => {\n\t\t\t\treturn {\n\t\t\t\t\tname: e.artist.name,\n\t\t\t\t\ttrackCount: e.artist.trackIDs.length,\n\t\t\t\t\talbumCount: e.artist.albumIDs.length,\n\t\t\t\t\tartistID: e.artist.id\n\t\t\t\t};\n\t\t\t})\n\t\t}))\n\t};\n}\n\nexport function formatFolderIndex(index: FolderIndex): Jam.FolderIndex {\n\treturn {\n\t\tlastModified: index.lastModified,\n\t\tgroups: index.groups.map(i => ({\n\t\t\tname: i.name,\n\t\t\tentries: i.entries.map(e => {\n\t\t\t\treturn {\n\t\t\t\t\tname: e.name,\n\t\t\t\t\ttrackCount: e.trackCount,\n\t\t\t\t\tfolderID: e.folder.id\n\t\t\t\t};\n\t\t\t})\n\t\t}))\n\t};\n}\n","module.exports = require(\"express-session\");","import {OpenAPIObject, OperationObject, ParameterObject, RequestBodyObject, SchemaObject} from '../model/openapi-spec';\nimport express from 'express';\nimport Logger from './logger';\nimport {Definition} from 'typescript-json-schema';\nimport {validateJSON, jsonValidator, JSONValidator} from './validate-json';\n\nconst log = Logger('CheckApiParameters');\n\nfunction validOAParameter(query: any, param: ParameterObject): string | null {\n\tif (!query) {\n\t\treturn 'Missing parameter collection ' + param.name;\n\t}\n\tconst schema = <SchemaObject>param.schema;\n\tlet value = query[param.name];\n\t// set default values\n\tif (value === undefined) {\n\t\tif (schema && schema.default !== undefined) {\n\t\t\tquery[param.name] = schema.default;\n\t\t\tvalue = schema.default;\n\t\t}\n\t}\n\t// check required\n\tif (value === undefined) {\n\t\tif (param.required) {\n\t\t\treturn 'Missing required parameter ' + param.name;\n\t\t}\n\t\treturn null;\n\t}\n\t// sanitize & check string parameter type\n\tif (schema.type === 'boolean') {\n\t\tif (['true', 'yes', '1'].indexOf(value.toString()) >= 0) {\n\t\t\tquery[param.name] = true;\n\t\t\tvalue = true;\n\t\t} else if (['false', 'no', '0'].indexOf(value.toString()) >= 0) {\n\t\t\tquery[param.name] = false;\n\t\t\tvalue = false;\n\t\t} else {\n\t\t\treturn 'Invalid boolean parameter ' + param.name;\n\t\t}\n\t\tquery[param.name] = value;\n\t} else if (['float', 'long', 'double', 'number', 'integer'].indexOf(schema.type || '') >= 0) {\n\t\tlet num = Number(value.toString());\n\t\tif (isNaN(num)) {\n\t\t\treturn 'Invalid number parameter ' + param.name;\n\t\t}\n\t\tif (schema.type === 'integer') {\n\t\t\tnum = Math.floor(num);\n\t\t}\n\t\tif (schema.minimum !== undefined && schema.minimum > num) {\n\t\t\treturn 'Invalid number parameter ' + param.name + '; minimum is ' + schema.minimum;\n\t\t}\n\t\tif (schema.maximum !== undefined && schema.maximum < num) {\n\t\t\treturn 'Invalid number parameter ' + param.name + '; maximum is ' + schema.maximum;\n\t\t}\n\t\tquery[param.name] = num;\n\t} else if (schema.type === 'string') {\n\t\tconst s = value.toString().trim();\n\t\t// if (s.length === 0) {\n\t\t// \treturn 'Empty string parameter ' + param.name;\n\t\t// }\n\t\tif (schema.enum) {\n\t\t\tif (schema.enum.indexOf(s) < 0) {\n\t\t\t\treturn 'Invalid enum string parameter ' + param.name + ': ' + s;\n\t\t\t}\n\t\t}\n\t\tquery[param.name] = s;\n\t} else if (schema.type === 'array') {\n\t\tconst items = <SchemaObject>(schema.items || {type: 'unknown'});\n\t\tif (items.type === 'string') {\n\t\t\tconst list = ((Array.isArray(value) ? value : [value]) || []).map(s => s.toString().trim());\n\t\t\tif (items.enum) {\n\t\t\t\tfor (let i = 0; i < list.length; i++) {\n\t\t\t\t\tconst s = list[i];\n\t\t\t\t\tif (items.enum.indexOf(s) < 0) {\n\t\t\t\t\t\treturn 'Invalid enum string parameter ' + param.name + ': ' + s;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tquery[param.name] = list;\n\t\t} else if (['float', 'long', 'double', 'number', 'integer'].indexOf(items.type || '') >= 0) {\n\t\t\tconst list = ((Array.isArray(value) ? value : [value]) || []).map(id => {\n\t\t\t\tlet num = Number(id.toString());\n\t\t\t\tif (items.type === 'integer') {\n\t\t\t\t\tnum = Math.floor(num);\n\t\t\t\t}\n\t\t\t\treturn num;\n\t\t\t});\n\t\t\tfor (let i = 0; i < list.length; i++) {\n\t\t\t\tconst num = list[i];\n\t\t\t\tif (isNaN(num)) {\n\t\t\t\t\treturn 'Invalid number array parameter ' + param.name;\n\t\t\t\t}\n\t\t\t\tif (items.minimum !== undefined && items.minimum > num) {\n\t\t\t\t\treturn 'Invalid number array parameter ' + param.name + '; minimum is ' + items.minimum;\n\t\t\t\t}\n\t\t\t\tif (schema.maximum !== undefined && schema.maximum < num) {\n\t\t\t\t\treturn 'Invalid number array parameter ' + items.name + '; maximum is ' + items.maximum;\n\t\t\t\t}\n\t\t\t}\n\t\t\tquery[param.name] = list;\n\t\t} else {\n\t\t\tconsole.log('TODO: validOAParameter list type', schema, value);\n\t\t}\n\t}\n\treturn null;\n}\n\nfunction createJSONValidator(def: any, apiSchema: any): JSONValidator {\n\tconst specialSchema = Object.assign({}, def);\n\tspecialSchema.definitions = apiSchema.definitions;\n\treturn jsonValidator(specialSchema);\n}\n\nasync function checkAORequestBody(cmd: OperationObject, apiSchema: any, body: any): Promise<void> {\n\tif (!cmd.requestBody || !(<RequestBodyObject>cmd.requestBody).content || !(<RequestBodyObject>cmd.requestBody).content['application/json']) {\n\t\treturn;\n\t}\n\tif (!body) {\n\t\treturn Promise.reject(Error('Missing Request Body'));\n\t}\n\tconst schema = (<RequestBodyObject>cmd.requestBody).content['application/json'].schema;\n\tif (!schema || !schema.$ref) {\n\t\treturn Promise.reject(Error('Unimplemented POST schema'));\n\t}\n\tconst def = apiSchema.definitions[schema.$ref.split('/')[3]];\n\tif (!def) {\n\t\treturn Promise.reject(Error('Unknown POST schema' + schema.$ref));\n\t}\n\tif (!def.validator) {\n\t\tdef.validator = createJSONValidator(def, apiSchema);\n\t}\n\tconst result = await validateJSON(body, def.validator);\n\tif (result.errors.length > 0) {\n\t\tconsole.error(def, body, result.errors);\n\t\treturn Promise.reject(Error(JSON.stringify(result.errors)));\n\t}\n}\n\nasync function checkAOParameters(cmd: OperationObject, schema: Definition, req: express.Request): Promise<void> {\n\tif (!cmd.parameters) {\n\t\treturn;\n\t}\n\tlet error: string | null = null;\n\tcmd.parameters.find(param => {\n\t\tparam = <ParameterObject>param;\n\t\tif (param.in === 'query') {\n\t\t\terror = validOAParameter(req.query, param);\n\t\t} else if (param.in === 'path') {\n\t\t\terror = validOAParameter(req.params, param);\n\t\t} else if (param.in === 'header') {\n\t\t\terror = validOAParameter(req.headers, param);\n\t\t} else if (param.in === 'cookie') {\n\t\t\terror = validOAParameter(req.cookies, param);\n\t\t} else {\n\t\t\tlog.info('Invalid/Unknown parameter spec', param);\n\t\t}\n\t\treturn !!error;\n\t});\n\tif (error) {\n\t\treturn Promise.reject(Error(error));\n\t}\n}\n\nexport async function checkOpenApiParameters(name: string, req: express.Request, openapi: OpenAPIObject, schema: Definition, forceMethod?: string): Promise<void> {\n\tconst cmdPath = openapi.paths[name];\n\tif (!cmdPath) {\n\t\tlog.info('cmd not found to validate', name);\n\t\treturn;\n\t}\n\tconst method = forceMethod || req.method.toLowerCase();\n\tconst cmd = cmdPath[method];\n\tif (!cmd) {\n\t\tlog.info('cmd method ' + req.method + ' not found to validate', req.path);\n\t\treturn;\n\t}\n\tif (method === 'get') {\n\t\tawait checkAOParameters(cmd, schema, req);\n\t} else {\n\t\tawait checkAORequestBody(cmd, schema, req.body);\n\t}\n}\n","\nexport function hexEncode(n: string): string {\n\tconst i: Array<string> = [];\n\tconst r: Array<string> = [];\n\tconst u = '0123456789abcdef';\n\tfor (let t = 0; t < 256; t++) {\n\t\t/* tslint:disable */\n\t\ti[t] = u.charAt(t >> 4) + u.charAt(t & 15);\n\t\t/* tslint:enable */\n\t}\n\tfor (let t = 0; t < n.length; t++) {\n\t\tr[t] = i[n.charCodeAt(t)];\n\t}\n\treturn r.join('');\n}\n\nexport function hexDecode(hex: string): string {\n\tlet str = '';\n\tfor (let i = 0; i < hex.length; i += 2) {\n\t\tstr += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n\t}\n\treturn str.trim();\n}\n","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 41;","import {Engine} from './engine/engine';\nimport {configureLogger} from './utils/logger';\nimport {Server} from './api/server';\nimport {loadConfig} from './config';\nimport {Store} from './engine/store/store';\nimport {DBElastic} from './db/elasticsearch/db-elastic';\nimport {DBNedb} from './db/nedb/db-nedb';\nimport {Database} from './db/db.model';\nimport program from 'commander';\n\nconst pack = require('../package.json');\nprogram\n\t.version(pack.version, '-v, --version')\n\t.usage('[options]')\n\t.option('-r, --reset', 'reset the db')\n\t.option('-c, --config <folder>', 'config file folder')\n\t.parse(process.argv);\n\nconst config = loadConfig(program.config);\n\nconfigureLogger(config.log.level);\n\nlet db: Database;\nif (config.database.use === 'elasticsearch') {\n\tdb = new DBElastic(config.database.options.elasticsearch);\n} else {\n\tdb = new DBNedb(config.getDataPath(['nedb']));\n}\nconst store = new Store(db);\nconst engine = new Engine(config, store, pack.version);\nconst server = new Server(engine);\n\nasync function run(): Promise<void> {\n\ttry {\n\t\tawait engine.start();\n\t\tawait server.start();\n\t\tif (engine.settingsService.settings.library.scanAtStart) {\n\t\t\tengine.ioService.refresh();\n\t\t}\n\t} catch (e) {\n\t\tconsole.error('Error on startup', e);\n\t\treturn;\n\t}\n}\n\nasync function stop(): Promise<void> {\n\ttry {\n\t\tawait server.stop();\n\t\tawait engine.stop();\n\t\tprocess.exit();\n\t} catch (e) {\n\t\tconsole.error('Error on startdown', e);\n\t\tprocess.exit(1);\n\t}\n}\n\nasync function runClearDB(): Promise<void> {\n\tawait engine.store.open();\n\tawait engine.store.reset();\n\tawait engine.store.close();\n}\n\nif (program.reset) {\n\trunClearDB().then(() => {\n\t\tconsole.log('done.');\n\t}).catch(e => {\n\t\tconsole.error(e);\n\t});\n} else {\n\n\tprocess.on('SIGTERM', () => {\n\t\tstop().catch(e => {\n\t\t\tconsole.error(e);\n\t\t});\n\t});\n\n\trun().catch(e => {\n\t\tconsole.error(e);\n\t});\n}\n\n","import path from 'path';\nimport fse from 'fs-extra';\nimport {IoService} from './io/io.service';\nimport {Store} from './store/store';\nimport {AudioModule} from '../modules/audio/audio.module';\nimport {DBObjectType} from '../db/db.types';\nimport {IndexService} from './index/index.service';\nimport {MetaDataService} from '../objects/metadata/metadata.service';\nimport {UserService} from '../objects/user/user.service';\nimport {ChatService} from './chat/chat.service';\nimport {GenreService} from './genre/genre.service';\nimport {PodcastService} from '../objects/podcast/podcast.service';\nimport {NowPlayingService} from './nowplaying/nowplaying.service';\nimport {RootService} from '../objects/root/root.service';\nimport {PlaylistService} from '../objects/playlist/playlist.service';\nimport {PlayQueueService} from '../objects/playqueue/playqueue.service';\nimport {Config} from '../config';\nimport {WaveformService} from './waveform/waveform.service';\nimport {StreamService} from './stream/stream.service';\nimport {BookmarkService} from '../objects/bookmark/bookmark.service';\nimport {StateService} from '../objects/state/state.service';\nimport {ImageService} from './image/image.service';\nimport {DownloadService} from './download/download.service';\nimport {User} from '../objects/user/user.model';\nimport {Root} from '../objects/root/root.model';\nimport {RadioService} from '../objects/radio/radio.service';\nimport {FolderService} from '../objects/folder/folder.service';\nimport {ImageModule} from '../modules/image/image.module';\nimport {TrackService} from '../objects/track/track.service';\nimport {ArtistService} from '../objects/artist/artist.service';\nimport {AlbumService} from '../objects/album/album.service';\nimport {EpisodeService} from '../objects/episode/episode.service';\nimport {ThirdPartyConfig} from '../config/thirdparty.config';\nimport {hashSaltPassword} from '../utils/salthash';\nimport {randomString} from '../utils/random';\nimport {ScanService} from './scan/scan.service';\nimport {StatsService} from './stats/stats.service';\nimport {SettingsService} from '../objects/settings/settings.service';\nimport {RootScanStrategy} from '../model/jam-types';\n\nexport class Engine {\n\tpublic ioService: IoService;\n\tpublic audioModule: AudioModule;\n\tpublic imageModule: ImageModule;\n\tpublic waveformService: WaveformService;\n\tpublic metaDataService: MetaDataService;\n\tpublic indexService: IndexService;\n\tpublic scanService: ScanService;\n\tpublic userService: UserService;\n\tpublic rootService: RootService;\n\tpublic chatService: ChatService;\n\tpublic genreService: GenreService;\n\tpublic playQueueService: PlayQueueService;\n\tpublic podcastService: PodcastService;\n\tpublic episodeService: EpisodeService;\n\tpublic playlistService: PlaylistService;\n\tpublic nowPlayingService: NowPlayingService;\n\tpublic streamService: StreamService;\n\tpublic bookmarkService: BookmarkService;\n\tpublic stateService: StateService;\n\tpublic imageService: ImageService;\n\tpublic downloadService: DownloadService;\n\tpublic radioService: RadioService;\n\tpublic folderService: FolderService;\n\tpublic trackService: TrackService;\n\tpublic artistService: ArtistService;\n\tpublic albumService: AlbumService;\n\tpublic statsService: StatsService;\n\tpublic settingsService: SettingsService;\n\n\tconstructor(public config: Config, public store: Store, public version: string) {\n\t\tthis.chatService = new ChatService();\n\t\tthis.audioModule = new AudioModule(ThirdPartyConfig);\n\t\tthis.waveformService = new WaveformService(config.getDataPath(['cache', 'waveforms']));\n\t\tthis.imageModule = new ImageModule(config.getDataPath(['cache', 'images']));\n\t\tthis.stateService = new StateService(this.store.stateStore);\n\t\tthis.folderService = new FolderService(this.store.folderStore, this.store.trackStore, this.stateService, this.imageModule);\n\t\tthis.trackService = new TrackService(this.store.trackStore, this.folderService, this.stateService);\n\t\tthis.indexService = new IndexService(this.store.artistStore, this.store.folderStore, this.store.trackStore);\n\t\tthis.scanService = new ScanService(this.store, this.audioModule, this.imageModule, this.waveformService);\n\t\tthis.settingsService = new SettingsService(store.settingsStore, this.chatService, this.indexService, this.scanService, version);\n\t\tthis.artistService = new ArtistService(this.store.artistStore, this.store.trackStore, this.folderService, this.stateService);\n\t\tthis.albumService = new AlbumService(this.store.albumStore, this.store.trackStore, this.folderService, this.stateService);\n\t\tthis.userService = new UserService(this.config.getDataPath(['images']), this.store.userStore, this.store.stateStore, this.store.playlistStore,\n\t\t\tthis.store.bookmarkStore, this.store.playQueueStore, this.imageModule);\n\t\tthis.imageService = new ImageService(this.imageModule, this.trackService, this.folderService, this.artistService, this.albumService, this.userService);\n\t\tthis.genreService = new GenreService(this.store.trackStore);\n\t\tthis.statsService = new StatsService(this.store);\n\t\tthis.ioService = new IoService(this.store.rootStore, this.scanService, this.indexService, this.genreService, this.statsService);\n\t\tthis.downloadService = new DownloadService(this.store.trackStore);\n\t\tthis.nowPlayingService = new NowPlayingService(this.stateService);\n\t\tthis.streamService = new StreamService();\n\t\tthis.playlistService = new PlaylistService(this.store.playlistStore, this.store.trackStore);\n\t\tthis.playQueueService = new PlayQueueService(this.store.playQueueStore);\n\t\tthis.bookmarkService = new BookmarkService(this.store.bookmarkStore);\n\t\tthis.episodeService = new EpisodeService(config.getDataPath(['podcasts']), this.store.episodeStore, this.stateService, this.audioModule);\n\t\tthis.podcastService = new PodcastService(this.store.podcastStore, this.episodeService, this.stateService);\n\t\tthis.metaDataService = new MetaDataService(this.store.metaStore, this.store.folderStore, this.store.trackStore, this.store.albumStore, this.store.artistStore, this.audioModule);\n\t\tthis.rootService = new RootService(this.store.rootStore);\n\t\tthis.radioService = new RadioService(this.store.radioStore);\n\t}\n\n\tprivate async checkFirstStart(): Promise<void> {\n\t\tif (!this.config.firstStart) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.config.firstStart.adminUser) {\n\t\t\tconst count = await this.store.userStore.count();\n\t\t\tif (count === 0) {\n\t\t\t\tconst adminUser = this.config.firstStart.adminUser;\n\t\t\t\tconst pw = hashSaltPassword(adminUser.pass || '');\n\t\t\t\tconst user: User = {\n\t\t\t\t\tid: '',\n\t\t\t\t\tname: adminUser.name,\n\t\t\t\t\tsalt: pw.salt,\n\t\t\t\t\thash: pw.hash,\n\t\t\t\t\tsubsonic_pass: randomString(10),\n\t\t\t\t\temail: adminUser.mail || '',\n\t\t\t\t\ttype: DBObjectType.user,\n\t\t\t\t\t// ldapAuthenticated: true,\n\t\t\t\t\tscrobblingEnabled: true,\n\t\t\t\t\tcreated: Date.now(),\n\t\t\t\t\troles: {\n\t\t\t\t\t\tstream: true,\n\t\t\t\t\t\tupload: true,\n\t\t\t\t\t\tadmin: true,\n\t\t\t\t\t\tpodcast: true,\n\t\t\t\t\t\t// coverArtRole: true,\n\t\t\t\t\t\t// settingsRole: true,\n\t\t\t\t\t\t// downloadRole: true,\n\t\t\t\t\t\t// playlistRole: true,\n\t\t\t\t\t\t// commentRole: true,\n\t\t\t\t\t\t// jukeboxRole: true,\n\t\t\t\t\t\t// videoConversionRole: true,\n\t\t\t\t\t\t// shareRole: true\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tawait this.userService.create(user);\n\t\t\t}\n\t\t}\n\t\tif (this.config.firstStart.roots) {\n\t\t\tconst count = await this.store.rootStore.count();\n\t\t\tif (count === 0) {\n\t\t\t\tconst firstStartRoots = this.config.firstStart.roots;\n\t\t\t\tfor (const first of firstStartRoots) {\n\t\t\t\t\tconst root: Root = {\n\t\t\t\t\t\tid: '',\n\t\t\t\t\t\tcreated: Date.now(),\n\t\t\t\t\t\ttype: DBObjectType.root,\n\t\t\t\t\t\tname: first.name,\n\t\t\t\t\t\tpath: first.path,\n\t\t\t\t\t\tstrategy: <RootScanStrategy>first.strategy || RootScanStrategy.auto\n\t\t\t\t\t};\n\t\t\t\t\tawait this.store.rootStore.add(root);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async checkDataPaths(): Promise<void> {\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'cache', 'waveforms'));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'cache', 'uploads'));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'cache', 'images'));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'images'));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'session'));\n\t\tawait fse.ensureDir(path.resolve(this.config.paths.data, 'podcasts'));\n\t}\n\n\tasync start(): Promise<void> {\n\t\t// check paths\n\t\tawait this.checkDataPaths();\n\t\t// open store\n\t\tawait this.store.open();\n\t\t// load settings\n\t\tawait this.settingsService.loadSettings();\n\t\t// first start?\n\t\tawait this.checkFirstStart();\n\t}\n\n\tasync stop(): Promise<void> {\n\t\tawait this.store.close();\n\t}\n\n\n}\n\n","import Logger from '../../utils/logger';\nimport {Subsonic} from '../../model/subsonic-rest-data';\nimport {Root, RootStatus} from '../../objects/root/root.model';\nimport {Track} from '../../objects/track/track.model';\nimport {IndexService} from '../index/index.service';\nimport {GenreService} from '../genre/genre.service';\nimport {logChanges, ScanService} from '../scan/scan.service';\nimport {RootStore} from '../../objects/root/root.store';\nimport {StatsService} from '../stats/stats.service';\n\nconst log = Logger('IO');\n\nexport enum ScanRequestMode {\n\trefreshRoot,\n\trefreshTracks,\n\tremoveRoot\n}\n\nexport interface ScanRequest {\n\troot: Root;\n\tmode: ScanRequestMode;\n\n\trun(): Promise<void>;\n}\n\nexport class ScanRequestRefreshRoot implements ScanRequest {\n\tmode = ScanRequestMode.refreshRoot;\n\n\tconstructor(public root: Root, public forceMetaRefresh: boolean, public scanService: ScanService) {\n\n\t}\n\n\tasync run(): Promise<void> {\n\t\tlog.info('Scanning Root', this.root.path);\n\t\ttry {\n\t\t\tconst changes = await this.scanService.run(this.root.path, this.root.id, this.root.strategy, this.forceMetaRefresh);\n\t\t\tlogChanges(changes);\n\t\t} catch (e) {\n\t\t\tlog.error('Scanning Error', this.root.path, e.toString());\n\t\t\tif (['EACCES', 'ENOENT'].indexOf((<any>e).code) >= 0) {\n\t\t\t\treturn Promise.reject(Error('Directory not found/no access/error in filesystem'));\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nexport class ScanRequestRemoveRoot implements ScanRequest {\n\tmode = ScanRequestMode.removeRoot;\n\n\tconstructor(public root: Root, public scanService: ScanService) {\n\n\t}\n\n\tasync run(): Promise<void> {\n\t\tlog.info('Removing Root', this.root.path);\n\t\ttry {\n\t\t\tconst changes = await this.scanService.removeRoot(this.root.id);\n\t\t\tlogChanges(changes);\n\t\t} catch (e) {\n\t\t\tlog.error('Removing Error', this.root.path, e.toString());\n\t\t\tif (['EACCES', 'ENOENT'].indexOf((<any>e).code) >= 0) {\n\t\t\t\treturn Promise.reject(Error('Directory not found/no access/error in filesystem'));\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class ScanRequestRefreshTracks implements ScanRequest {\n\tmode = ScanRequestMode.refreshTracks;\n\n\tconstructor(public root: Root, public scanService: ScanService, public trackIDs: Array<string>) {\n\n\t}\n\n\tasync run(): Promise<void> {\n\t\tlog.info('Refresh Tracks in Root', this.root.path);\n\t\ttry {\n\t\t\tconst changes = await this.scanService.refreshTracks(this.root.id, this.trackIDs, this.root.strategy);\n\t\t\tlogChanges(changes);\n\t\t} catch (e) {\n\t\t\tlog.error('Refresh Tracks Error', this.root.path, e.toString());\n\t\t\tif (['EACCES', 'ENOENT'].indexOf((<any>e).code) >= 0) {\n\t\t\t\treturn Promise.reject(Error('Directory not found/no access/error in filesystem'));\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class IoService {\n\tpublic scanning = false;\n\tprivate scanningCount: undefined | number;\n\tprivate rootstatus: { [id: string]: RootStatus } = {};\n\tprivate queue: Array<ScanRequest> = [];\n\tprivate delayedTrackRefresh: { [rootID: string]: { request: ScanRequestRefreshTracks, timeout?: NodeJS.Timeout } } = {};\n\n\tconstructor(private rootStore: RootStore, private scanService: ScanService, private indexService: IndexService, private genreService: GenreService, private statsService: StatsService) {\n\t}\n\n\tgetScanStatus(): Subsonic.ScanStatus {\n\t\treturn {scanning: this.scanning, count: this.scanningCount};\n\t}\n\n\tgetRootStatus(id: string): RootStatus {\n\t\treturn this.rootstatus[id];\n\t}\n\n\tprivate async runRequest(cmd: ScanRequest): Promise<void> {\n\t\tthis.rootstatus[cmd.root.id] = {lastScan: Date.now(), scanning: true};\n\t\ttry {\n\t\t\tawait cmd.run();\n\t\t\tthis.rootstatus[cmd.root.id] = {lastScan: Date.now()};\n\t\t} catch (e) {\n\t\t\tthis.rootstatus[cmd.root.id] = {lastScan: Date.now(), error: e.toString()};\n\t\t}\n\t\tawait this.indexService.buildIndexes();\n\t\tawait this.genreService.refresh();\n\t\tawait this.statsService.refresh();\n\t}\n\n\tprivate findRequest(root: Root, mode: ScanRequestMode): ScanRequest | undefined {\n\t\treturn this.queue.find(c => !!c.root && (c.root.id === root.id && c.mode === mode));\n\t}\n\n\tprivate async next(): Promise<void> {\n\t\tconst cmd = this.queue.shift();\n\t\tif (cmd) {\n\t\t\tawait this.runRequest(cmd);\n\t\t\tawait this.next();\n\t\t}\n\t}\n\n\tprivate run(): void {\n\t\tif (this.scanning) {\n\t\t\treturn;\n\t\t}\n\t\tthis.scanning = true;\n\t\tlog.info('Start Scanning');\n\t\tthis.next()\n\t\t\t.then(() => {\n\t\t\t\tthis.scanning = false;\n\t\t\t\tlog.info('Stop Scanning');\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\tthis.scanning = false;\n\t\t\t\tlog.info('Stop Scanning');\n\t\t\t\tlog.error(e);\n\t\t\t});\n\n\t}\n\n\trefresh(): void {\n\t\tthis.rootStore.all()\n\t\t\t.then((roots) => {\n\t\t\t\t\tfor (const root of roots) {\n\t\t\t\t\t\tif (!this.findRequest(root, ScanRequestMode.refreshRoot)) {\n\t\t\t\t\t\t\tthis.queue.push(new ScanRequestRefreshRoot(root, false, this.scanService));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tthis.run();\n\t\t\t\t}\n\t\t\t);\n\t}\n\n\trefreshTrack(track: Track): void {\n\t\tthis.rootStore.byId(track.rootID).then((root) => {\n\t\t\tif (!root) {\n\t\t\t\tlog.error(Error('Track root not found: ' + track.rootID));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet delayedCmd = this.delayedTrackRefresh[track.rootID];\n\t\t\tif (delayedCmd) {\n\t\t\t\tif (delayedCmd.timeout) {\n\t\t\t\t\tclearTimeout(delayedCmd.timeout);\n\t\t\t\t}\n\t\t\t\tif (delayedCmd.request.trackIDs.indexOf(track.id) < 0) {\n\t\t\t\t\tdelayedCmd.request.trackIDs.push(track.id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdelayedCmd = {request: new ScanRequestRefreshTracks(root, this.scanService, [track.id]), timeout: undefined};\n\t\t\t\tthis.delayedTrackRefresh[track.rootID] = delayedCmd;\n\t\t\t}\n\t\t\tdelayedCmd.timeout = setTimeout(() => {\n\t\t\t\tdelete this.delayedTrackRefresh[track.rootID];\n\t\t\t\tthis.queue.push(delayedCmd.request);\n\t\t\t\tthis.run();\n\t\t\t}, 10000);\n\t\t});\n\t}\n\n\trefreshRoot(root: Root, forceMetaRefresh: boolean): void {\n\t\tconst oldRequest = this.findRequest(root, ScanRequestMode.refreshRoot);\n\t\tif (!oldRequest) {\n\t\t\tthis.queue.push(new ScanRequestRefreshRoot(root, forceMetaRefresh, this.scanService));\n\t\t\tthis.run();\n\t\t} else if (forceMetaRefresh) {\n\t\t\t(<ScanRequestRefreshRoot>oldRequest).forceMetaRefresh = true;\n\t\t\toldRequest.root = root;\n\t\t}\n\t}\n\n\tremoveRoot(root: Root): void {\n\t\tif (!this.findRequest(root, ScanRequestMode.removeRoot)) {\n\t\t\tthis.queue.push(new ScanRequestRemoveRoot(root, this.scanService));\n\t\t\tthis.run();\n\t\t}\n\t}\n}\n","module.exports = require(\"winston\");","module.exports = require(\"winston-timer\");","export function deepCompare(a: any, b: any, ignore?: Array<string>): boolean {\n\tconst ignoreList: Array<string> = ignore || [];\n\tconst compare = (oa: any, ob: any) => {\n\t\tif (a === undefined) {\n\t\t\treturn false;\n\t\t}\n\t\tif (b === undefined) {\n\t\t\treturn false;\n\t\t}\n\t\tif (typeof oa === 'object') {\n\t\t\tif (!deepCompare(oa, ob, ignore)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (oa !== ob) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t};\n\tif (a === undefined) {\n\t\treturn false;\n\t}\n\tif (b === undefined) {\n\t\treturn false;\n\t}\n\tlet key;\n\tfor (key in a) {\n\t\tif (a.hasOwnProperty(key) && ignoreList.indexOf(key) < 0) {\n\t\t\tif (!compare(a[key], b[key])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\tfor (key in b) {\n\t\tif (b.hasOwnProperty(key) && ignoreList.indexOf(key) < 0) {\n\t\t\tif (!compare(a[key], b[key])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\treturn true;\n}\n","import crypto from 'crypto';\n\nexport function md5string(s: string): string {\n\treturn crypto.createHash('md5').update(s).digest('hex');\n}\n","import {ID3v1, ID3v2, IID3V1, IID3V2, IMP3, MP3, simplifyTag} from 'jamp3';\nimport {ChartLyricsClient, ChartLyricsResult} from './clients/chartlyrics-client';\nimport {AcoustidClient} from './clients/acoustid-client';\nimport {LastFMClient} from './clients/lastfm-client';\nimport {MusicbrainzClient} from './clients/musicbrainz-client';\nimport {MusicbrainzClientApi} from './clients/musicbrainz-client.interface';\nimport {LastFM} from '../../model/lastfm-rest-data';\nimport {Acoustid} from '../../model/acoustid-rest-data';\nimport {MusicBrainz} from '../../model/musicbrainz-rest-data';\nimport {fileSuffix} from '../../utils/fs-utils';\nimport {cleanGenre} from '../../utils/genres';\nimport {Jam} from '../../model/jam-rest-data';\nimport {TrackMedia, TrackTag} from '../../objects/track/track.model';\nimport fse from 'fs-extra';\nimport {ThirdpartyToolsConfig} from '../../config/thirdparty.config';\nimport {probe, ProbeResult} from './tools/ffprobe';\nimport {ID3v1_GENRES} from 'jamp3/dist/lib/id3v1/id3v1_consts';\nimport {AcousticbrainzClient} from './clients/acousticbrainz-client';\nimport {AcousticBrainz} from '../../model/acousticbrainz-rest-data';\nimport {CoverArtArchiveClient} from './clients/coverartarchive-client';\nimport {CoverArtArchive} from '../../model/coverartarchive-rest-data';\nimport {AudioFormatType, CoverArtArchiveLookupType, TrackTagFormatType, TrackTagID3v2FormatTypes} from '../../model/jam-types';\nimport {WikiData, WikipediaClient} from './clients/wikipedia-client';\n\nexport interface AudioScanResult {\n\tmedia?: TrackMedia;\n\ttag?: TrackTag;\n}\n\nclass FORMAT {\n\tstatic packJamServeMedia(data?: IMP3.MPEG): TrackMedia {\n\t\tif (!data) {\n\t\t\treturn {};\n\t\t}\n\t\treturn {\n\t\t\tformat: AudioFormatType.mp3,\n\t\t\tduration: data.durationEstimate,\n\t\t\tbitRate: data.bitRate,\n\t\t\tsampleRate: data.sampleRate,\n\t\t\tchannels: data.channels,\n\t\t\tencoded: data.encoded,\n\t\t\tmode: data.mode,\n\t\t\tversion: data.version + ' ' + data.layer\n\t\t};\n\t}\n\n\tstatic packProbeJamServeMedia(data: ProbeResult): TrackMedia {\n\t\tif (!data.streams) {\n\t\t\treturn {};\n\t\t}\n\t\tconst stream = data.streams.filter(s => s.codec_type === 'audio')[0];\n\t\tif (!stream) {\n\t\t\treturn {};\n\t\t}\n\t\treturn {\n\t\t\tformat: <AudioFormatType>data.format.format_name,\n\t\t\tduration: Number(data.format.duration),\n\t\t\tbitRate: Number(data.format.bit_rate),\n\t\t\tsampleRate: Number(stream.sample_rate),\n\t\t\tchannels: stream.channels,\n\t\t\tmode: stream.channel_layout,\n\t\t\tversion: stream.codec_long_name\n\t\t};\n\t}\n\n\tstatic packProbeJamServeTag(data: ProbeResult): TrackTag {\n\t\tconst simple = data.format.tags;\n\t\tif (!simple) {\n\t\t\treturn {format: TrackTagFormatType.none};\n\t\t}\n\t\tconst track = Number(simple.track);\n\t\tconst year = Number(simple.DATE);\n\t\tconst disc = Number(simple.disc);\n\t\treturn {\n\t\t\tformat: TrackTagFormatType.ffmpeg,\n\t\t\tartist: simple.ARTIST,\n\t\t\ttitle: simple.TITLE,\n\t\t\talbum: simple.ALBUM,\n\t\t\tyear: isNaN(year) ? undefined : year,\n\t\t\ttrack: isNaN(track) ? undefined : track,\n\t\t\tdisc: isNaN(disc) ? undefined : disc,\n\t\t\tgenre: simple.GENRE ? cleanGenre(simple.GENRE) : undefined,\n\t\t\talbumArtist: simple.album_artist || simple['ALBUM ARTIST'],\n\t\t\talbumSort: simple.album_sort_order,\n\t\t\talbumArtistSort: simple.album_artist_sort || simple.album_artist_sort_order,\n\t\t\tartistSort: simple.artist_sort,\n\t\t\ttitleSort: simple.title_sort_order,\n\t\t\tmbTrackID: simple.TRACKID,\n\t\t\tmbAlbumType: simple.ALBUMTYPE,\n\t\t\tmbAlbumArtistID: simple.ALBUMARTISTID,\n\t\t\tmbArtistID: simple.ARTISTID,\n\t\t\tmbAlbumID: simple.ALBUMID,\n\t\t\tmbReleaseTrackID: simple.RELEASETRACKID,\n\t\t\tmbReleaseGroupID: simple.RELEASEGROUPID,\n\t\t\tmbRecordingID: simple.RECORDINGID,\n\t\t\tmbAlbumStatus: simple.ALBUMSTATUS,\n\t\t\tmbReleaseCountry: simple.RELEASECOUNTRY\n\t\t};\n\t}\n\n\tstatic packID3v1JamServeTag(data?: IID3V1.Tag): TrackTag | undefined {\n\t\tif (!data) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst simple = data.value;\n\t\treturn {\n\t\t\tformat: TrackTagFormatType.id3v1,\n\t\t\tartist: simple.artist,\n\t\t\ttitle: simple.title,\n\t\t\talbum: simple.album,\n\t\t\tyear: isNaN(Number(simple.year)) ? undefined : Number(simple.year),\n\t\t\ttrack: simple.track,\n\t\t\tgenre: (simple.genreIndex !== undefined && !!ID3v1_GENRES[simple.genreIndex]) ? ID3v1_GENRES[simple.genreIndex] : undefined,\n\t\t};\n\t}\n\n\tstatic packID3v2JamServeTag(data?: IID3V2.Tag): TrackTag | undefined {\n\t\tif (!data) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst simple = simplifyTag(data);\n\t\t// ? simplifyTag(result.id3v2) : undefined\n\t\tlet year: number | undefined = simple.year;\n\t\tif (simple.release_year) {\n\t\t\tconst y = Number(simple.release_year);\n\t\t\tif (!isNaN(y)) {\n\t\t\t\tyear = y;\n\t\t\t}\n\t\t}\n\t\tif (simple.originalyear) {\n\t\t\tconst y = Number(simple.originalyear);\n\t\t\tif (!isNaN(y)) {\n\t\t\t\tyear = y;\n\t\t\t}\n\t\t}\n\t\tif (simple.original_release_year) {\n\t\t\tconst y = Number(simple.original_release_year);\n\t\t\tif (!isNaN(y)) {\n\t\t\t\tyear = y;\n\t\t\t}\n\t\t}\n\t\tif (simple.release_date) {\n\t\t\tconst y = parseInt(simple.release_date.slice(0, 4), 10);\n\t\t\tif (!isNaN(y)) {\n\t\t\t\tyear = y;\n\t\t\t}\n\t\t}\n\t\tconst format = TrackTagID3v2FormatTypes[data.head ? data.head.rev : -1] || TrackTagFormatType.none;\n\t\treturn {\n\t\t\tformat,\n\t\t\talbum: simple.album,\n\t\t\talbumSort: simple.album_sort_order,\n\t\t\talbumArtist: simple.album_artist,\n\t\t\talbumArtistSort: simple.album_artist_sort || simple.album_artist_sort_order,\n\t\t\tartist: simple.artist,\n\t\t\tartistSort: simple.artist_sort,\n\t\t\tgenre: simple.genre ? cleanGenre(simple.genre) : undefined,\n\t\t\tdisc:  simple.disc,\n\t\t\tdiscTotal: simple.disc_total,\n\t\t\ttitle: simple.title,\n\t\t\ttitleSort: simple.title_sort_order,\n\t\t\ttrack: simple.track,\n\t\t\ttrackTotal: simple.track_total,\n\t\t\tyear: year,\n\t\t\tmbTrackID: simple.TRACKID,\n\t\t\tmbAlbumType: simple.ALBUMTYPE,\n\t\t\tmbAlbumArtistID: simple.ALBUMARTISTID,\n\t\t\tmbArtistID: simple.ARTISTID,\n\t\t\tmbAlbumID: simple.ALBUMID,\n\t\t\tmbReleaseTrackID: simple.RELEASETRACKID,\n\t\t\tmbReleaseGroupID: simple.RELEASEGROUPID,\n\t\t\tmbRecordingID: simple.RECORDINGID,\n\t\t\tmbAlbumStatus: simple.ALBUMSTATUS,\n\t\t\tmbReleaseCountry: simple.RELEASECOUNTRY\n\t\t};\n\t}\n\n}\n\nexport class AudioModule {\n\tmusicbrainz: MusicbrainzClient;\n\tacoustid: AcoustidClient;\n\tlastFM: LastFMClient;\n\tchartLyrics: ChartLyricsClient;\n\tacousticbrainz: AcousticbrainzClient;\n\tcoverArtArchive: CoverArtArchiveClient;\n\twikipedia: WikipediaClient;\n\tprivate isSaving: { [filename: string]: boolean } = {};\n\n\tconstructor(tools: ThirdpartyToolsConfig) {\n\t\tthis.musicbrainz = new MusicbrainzClient({userAgent: tools.musicbrainz.userAgent, retryOn: true});\n\t\tthis.acousticbrainz = new AcousticbrainzClient({userAgent: tools.acousticbrainz.userAgent, retryOn: true});\n\t\tthis.lastFM = new LastFMClient({key: tools.lastfm.apiKey, userAgent: tools.lastfm.userAgent});\n\t\tthis.acoustid = new AcoustidClient({key: tools.acoustid.apiKey, userAgent: tools.acoustid.userAgent});\n\t\tthis.chartLyrics = new ChartLyricsClient(tools.chartlyrics.userAgent);\n\t\tthis.wikipedia = new WikipediaClient(tools.wikipedia.userAgent);\n\t\tthis.coverArtArchive = new CoverArtArchiveClient({userAgent: tools.coverartarchive.userAgent, retryOn: true});\n\t}\n\n\tasync read(filename: string): Promise<AudioScanResult> {\n\t\tconst suffix = fileSuffix(filename);\n\t\tif (suffix === AudioFormatType.mp3) {\n\t\t\tconst mp3 = new MP3();\n\t\t\ttry {\n\t\t\t\tconst result = await mp3.read({filename, mpegQuick: true, mpeg: true, id3v2: true});\n\t\t\t\tif (!result) {\n\t\t\t\t\treturn {tag: {format: TrackTagFormatType.none}, media: {}};\n\t\t\t\t} else {\n\t\t\t\t\tif (result.id3v2) {\n\t\t\t\t\t\treturn {tag: FORMAT.packID3v2JamServeTag(result.id3v2), media: FORMAT.packJamServeMedia(result.mpeg)};\n\t\t\t\t\t}\n\t\t\t\t\tconst id3v1 = new ID3v1();\n\t\t\t\t\tconst v1 = await id3v1.read(filename);\n\t\t\t\t\tif (!v1) {\n\t\t\t\t\t\treturn {tag: {format: TrackTagFormatType.none}, media: FORMAT.packJamServeMedia(result.mpeg)};\n\t\t\t\t\t}\n\t\t\t\t\treturn {tag: FORMAT.packID3v1JamServeTag(v1), media: FORMAT.packJamServeMedia(result.mpeg)};\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(e);\n\t\t\t\treturn {tag: {format: TrackTagFormatType.none}, media: {}};\n\t\t\t}\n\t\t} else {\n\t\t\tconst p = await probe(filename, []);\n\t\t\tif (!p) {\n\t\t\t\treturn {tag: {format: TrackTagFormatType.none}, media: {}};\n\t\t\t} else {\n\t\t\t\treturn {tag: FORMAT.packProbeJamServeTag(p), media: FORMAT.packProbeJamServeMedia(p)};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync saveID3v2(filename: string, tag: Jam.ID3Tag): Promise<void> {\n\t\tif (this.isSaving[filename]) {\n\t\t\tconsole.error('Another save is in progress', filename);\n\t\t\treturn Promise.reject(Error('Another save is in progress'));\n\t\t}\n\t\tthis.isSaving[filename] = true;\n\t\ttry {\n\t\t\tconst exists = await fse.pathExists(filename + '.bak.org');\n\t\t\tif (!exists) {\n\t\t\t\tawait fse.copy(filename, filename + '.bak.org');\n\t\t\t}\n\t\t\tconst frames: Array<IID3V2.Frame> = [];\n\t\t\tObject.keys(tag.frames).map(id => {\n\t\t\t\tconst f = tag.frames[id] || [];\n\t\t\t\tf.forEach(value => {\n\t\t\t\t\tif (value && value.hasOwnProperty('bin')) {\n\t\t\t\t\t\tconst binValue = <any>value;\n\t\t\t\t\t\tbinValue.bin = Buffer.from(binValue.bin, 'base64');\n\t\t\t\t\t}\n\t\t\t\t\tframes.push({id, head: {statusFlags: {}, formatFlags: {}, size: 0}, value});\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t});\n\t\t\tconst t: IID3V2.Tag = {\n\t\t\t\tid: 'ID3v2',\n\t\t\t\thead: {\n\t\t\t\t\tver: tag.version,\n\t\t\t\t\trev: 0,\n\t\t\t\t\tsize: 0,\n\t\t\t\t\tvalid: true\n\t\t\t\t},\n\t\t\t\tstart: 0,\n\t\t\t\tend: 0,\n\t\t\t\tframes\n\t\t\t};\n\t\t\tconst id3v2 = new ID3v2();\n\t\t\tawait id3v2.write(filename, t, tag.version, 0);\n\t\t\tdelete this.isSaving[filename];\n\t\t} catch (e) {\n\t\t\tdelete this.isSaving[filename];\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync readID3v2(filename: string): Promise<Jam.ID3Tag> {\n\t\tconst id3v2 = new ID3v2();\n\t\tconst id3v2tag = await id3v2.read(filename);\n\t\tif (!id3v2tag || !id3v2tag.head) {\n\t\t\treturn Promise.reject(Error('No ID3v2 Tag found'));\n\t\t}\n\t\tconst tag: Jam.ID3Tag = {\n\t\t\tversion: id3v2tag.head.ver,\n\t\t\tframes: {}\n\t\t};\n\t\tid3v2tag.frames.forEach(frame => {\n\t\t\tconst f = tag.frames[frame.id] || [];\n\t\t\tif (frame.value && frame.value.hasOwnProperty('bin')) {\n\t\t\t\tconst binValue = <any>frame.value;\n\t\t\t\tbinValue.bin = binValue.bin.toString('base64');\n\t\t\t}\n\t\t\tf.push(frame.value);\n\t\t\ttag.frames[frame.id] = f;\n\t\t});\n\t\treturn tag;\n\t}\n\n\tasync readID3v2Image(filename: string, type: number): Promise<{ buffer?: Buffer, mimeType?: string }> {\n\t\tconst id3v2 = new ID3v2();\n\t\tconst tag = await id3v2.read(filename);\n\t\tif (!tag) {\n\t\t\treturn {};\n\t\t}\n\t\tconst frame = tag.frames.find(f => {\n\t\t\tif (['APIC', 'PIC'].indexOf(f.id) >= 0) {\n\t\t\t\treturn (<IID3V2.FrameValue.Pic>f.value).pictureType === type;\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t\tif (!frame) {\n\t\t\treturn {};\n\t\t}\n\t\treturn {buffer: (<IID3V2.FrameValue.Pic>frame.value).bin, mimeType: (<IID3V2.FrameValue.Pic>frame.value).mimeType};\n\t}\n\n\tasync acoustidLookup(filename: string, includes: string | undefined): Promise<Array<Acoustid.Result>> {\n\t\treturn this.acoustid.acoustid(filename, includes);\n\t}\n\n\tasync musicbrainzSearch(type: string, query: MusicbrainzClientApi.SearchQuery): Promise<MusicBrainz.Response> {\n\t\treturn this.musicbrainz.search({type: type, query});\n\t}\n\n\tasync musicbrainzLookup(type: string, id: string, inc: string | undefined): Promise<MusicBrainz.Response> {\n\t\treturn this.musicbrainz.lookup({type: type, id, inc});\n\t}\n\n\tasync acousticbrainzLookup(id: string, nr: number | undefined): Promise<AcousticBrainz.Response> {\n\t\treturn this.acousticbrainz.highLevel(id, nr);\n\t}\n\n\tasync coverartarchiveLookup(type: string, id: string): Promise<CoverArtArchive.Response> {\n\t\tif (type === CoverArtArchiveLookupType.release) {\n\t\t\treturn this.coverArtArchive.releaseImages(id);\n\t\t} else if (type === CoverArtArchiveLookupType.releaseGroup) {\n\t\t\treturn this.coverArtArchive.releaseGroupImages(id);\n\t\t} else {\n\t\t\treturn Promise.reject(Error('Invalid CoverArtArchive Lookup Type'));\n\t\t}\n\t}\n\n\tasync lastFMLookup(type: string, id: string): Promise<LastFM.Result> {\n\t\t// TODO: get more than 50\n\t\treturn this.lastFM.lookup(type, id);\n\t}\n\n\tasync getLyrics(artist: string, song: string): Promise<ChartLyricsResult | undefined> {\n\t\treturn this.chartLyrics.search(artist, song);\n\t}\n\n\tasync wikipediaSummary(title: string, lang: string | undefined): Promise<{ title: string, url: string, summary: string } | undefined> {\n\t\treturn await this.wikipedia.summary(title, lang);\n\t}\n\n\tasync wikidataID(id: string): Promise<WikiData.Entity | undefined> {\n\t\treturn await this.wikipedia.wikidata(id);\n\t}\n}\n","module.exports = require(\"jamp3\");","import {WebserviceXMLClient} from '../../../utils/webservice-xml-client';\n\nexport interface ChartLyricsResult {\n\tid: string;\n\ttrackId: string;\n\tchecksum: string;\n\tsong: string;\n\tartist: string;\n\turl: string;\n\tcovertArtUrl: string;\n\trank: string;\n\tcorrectUrl: string;\n\tlyric: string;\n}\n\nexport class ChartLyricsClient extends WebserviceXMLClient {\n\n\tconstructor(userAgent: string) {\n\t\tsuper(1, 1000, userAgent);\n\t}\n\n\tasync search(artistName: string, songName: string): Promise<ChartLyricsResult | undefined> {\n\t\tconst opts = {\n\t\t\tartist: artistName,\n\t\t\tsong: songName\n\t\t};\n\t\tconst data = await this.getJson<any>('http://api.chartlyrics.com/apiv1.asmx/SearchLyricDirect', opts);\n\t\tif (!data || !data.GetLyricResult) {\n\t\t\treturn;\n\t\t}\n\t\tconst o = data.GetLyricResult;\n\t\tconst result: ChartLyricsResult = {\n\t\t\tid: (o ? o.LyricId[0] : '') || '',\n\t\t\ttrackId: (o ? o.TrackId[0] : '') || '',\n\t\t\tchecksum: (o ? o.LyricChecksum[0] : '') || '',\n\t\t\tsong: (o ? o.LyricSong[0] : '') || '',\n\t\t\tartist: (o ? o.LyricArtist[0] : '') || '',\n\t\t\turl: (o ? o.LyricUrl[0] : '') || '',\n\t\t\tcovertArtUrl: (o ? o.LyricCovertArtUrl[0] : '') || '',\n\t\t\trank: (o ? o.LyricRank[0] : '') || '',\n\t\t\tcorrectUrl: (o ? o.LyricCorrectUrl[0] : '') || '',\n\t\t\tlyric: (o ? o.Lyric[0] : '') || ''\n\t\t};\n\t\treturn result;\n\t}\n}\n","import rateLimiter from 'limiter';\nimport request from 'request';\nimport xml2js from 'xml2js';\n\nexport class WebserviceXMLClient {\n\tprivate limiter: rateLimiter.RateLimiter;\n\tprivate userAgent: string;\n\n\tconstructor(requestPerInterval: number, requestIntervalMS: number, userAgent: string) {\n\t\tthis.limiter = new rateLimiter.RateLimiter(requestPerInterval, requestIntervalMS);\n\t\tthis.userAgent = userAgent;\n\t}\n\n\tprotected async getJson<T>(url: string, parameters: object | undefined): Promise<T> {\n\t\tconst options: request.Options = {\n\t\t\turl,\n\t\t\theaders: {'User-Agent': this.userAgent},\n\t\t\tqs: parameters\n\t\t};\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tthis.limiter.removeTokens(1, () => {\n\t\t\t\trequest(options, (err, response, body) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t}\n\t\t\t\t\txml2js.parseString(body, (err2, result) => {\n\t\t\t\t\t\tif (err2) {\n\t\t\t\t\t\t\treturn reject(err2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresolve(<T>result);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\n\t\t});\n\t}\n\n}\n","module.exports = require(\"xml2js\");","import {fpcalc, FPCalcOptions, FPCalcResult} from '../tools/fpcalc';\nimport {WebserviceClient} from '../../../utils/webservice-client';\nimport {Acoustid} from '../../../model/acoustid-rest-data';\nimport Logger from '../../../utils/logger';\n\nconst log = Logger('Acoustid');\n\n// const ALL_META_DEFAULT = 'recordings recordingids releases releaseids releasegroups releasegroupids tracks compress usermeta sources';\n\nconst META_DEFAULT = 'recordings releases releasegroups tracks compress usermeta sources';\n\ndeclare namespace AcoustidClient {\n\n\texport interface AcoustidClientOptions {\n\t\tkey: string;\n\t\tuserAgent: string;\n\t\tmeta?: string;\n\t\tfpcalc?: FPCalcOptions;\n\t}\n\n}\n\nexport class AcoustidClient extends WebserviceClient {\n\toptions: AcoustidClient.AcoustidClientOptions;\n\n\tconstructor(options: AcoustidClient.AcoustidClientOptions) {\n\t\t// \"not more than 3 per second\" https://acoustid.org/webservice\n\t\tsuper(3, 1000, options.userAgent);\n\t\tthis.options = options;\n\t}\n\n\tprivate async get(fp: FPCalcResult, includes: string | undefined): Promise<Array<Acoustid.Result>> {\n\t\tincludes = includes || this.options.meta || META_DEFAULT;\n\t\tlog.info('requesting by fingerprint', includes);\n\t\tconst data = await this.getJson<Acoustid.Results>('http://api.acoustid.org/v2/lookup', {\n\t\t\tformat: 'json',\n\t\t\tmeta: includes,\n\t\t\tclient: this.options.key,\n\t\t\tduration: fp.duration.toFixed(0),\n\t\t\tfingerprint: fp.fingerprint\n\t\t});\n\t\tif (data.status !== 'ok') {\n\t\t\treturn Promise.reject(Error(data.status));\n\t\t}\n\t\treturn data.results;\n\t}\n\n\tasync acoustid(file: string, includes: string | undefined): Promise<Array<Acoustid.Result>> {\n\t\ttry {\n\t\t\tconst result = await fpcalc(file, this.options.fpcalc || {});\n\t\t\treturn this.get(result, includes);\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\treturn [];\n\t\t}\n\t}\n}\n","import {spawnToolJson} from '../../../utils/tool';\n\nexport interface FPCalcOptions {\n\tlength?: number;\n\traw?: boolean;\n}\n\nexport interface FPCalcResult {\n\tduration: number;\n\tfingerprint: string;\n\tfingerprintRaw?: Buffer;\n}\n\nexport async function fpcalc(filename: string, options: FPCalcOptions): Promise<FPCalcResult> {\n\tconst cmds: Array<string> = ['-json'];\n\tif (options.length) {\n\t\tcmds.push('-length', options.length.toFixed(0));\n\t}\n\tif (options.raw) {\n\t\tcmds.push('-raw');\n\t}\n\treturn await spawnToolJson<FPCalcResult>('fpcalc', 'FPCALC_PATH', [...cmds, filename]);\n}\n","import path from 'path';\nimport {NodeDataCallback} from '../typings';\nimport fse from 'fs-extra';\n\nexport const isWindows = process && (process.platform === 'win32' || /^(msys|cygwin)$/.test(process.env.OSTYPE || ''));\n\nconst cache: { [name: string]: string; } = {};\n\nconst COLON = isWindows ? ';' : ':';\n\nfunction getPathInfo(cmd: string, opt: any) {\n\tconst colon = opt.colon || COLON;\n\tlet pathEnv = opt.path || process.env.PATH || '';\n\tlet pathExt = [''];\n\n\tpathEnv = pathEnv.split(colon);\n\n\tlet pathExtExe = '';\n\tif (isWindows) {\n\t\tpathEnv.unshift(process.cwd());\n\t\tpathExtExe = (opt.pathExt || process.env.PATHEXT || '.EXE;.CMD;.BAT;.COM');\n\t\tpathExt = pathExtExe.split(colon);\n\n\n\t\t// Always test the cmd itself first.  isexe will check to make sure\n\t\t// it's found in the pathExt set.\n\t\tif (cmd.indexOf('.') !== -1 && pathExt[0] !== '') {\n\t\t\tpathExt.unshift('');\n\t\t}\n\t}\n\n\t// If it has a slash, then we don't bother searching the pathenv.\n\t// just check the file itself, and that's it.\n\tif (cmd.match(/\\//) || isWindows && cmd.match(/\\\\/)) {\n\t\tpathEnv = [''];\n\t}\n\n\treturn {\n\t\tenv: pathEnv,\n\t\text: pathExt,\n\t\textExe: pathExtExe\n\t};\n}\n\nfunction getNotFoundError(cmd: string): Error {\n\tconst er = new Error('not found: ' + cmd);\n\t(<any>er).code = 'ENOENT';\n\treturn er;\n}\n\nfunction checkWindowsMode(filename: string, options: { pathExt?: string }, stat: fse.Stats): boolean {\n\tif (!stat.isSymbolicLink() && !stat.isFile()) {\n\t\treturn false;\n\t}\n\tconst pathext = options.pathExt !== undefined ? options.pathExt : process.env.PATHEXT;\n\tif (!pathext) {\n\t\treturn true;\n\t}\n\tconst pathexts = pathext.split(';');\n\tif (pathexts.indexOf('') !== -1) {\n\t\treturn true;\n\t}\n\tfor (let i = 0; i < pathexts.length; i++) {\n\t\tconst p = pathexts[i].toLowerCase();\n\t\tif (p && filename.substr(-p.length).toLowerCase() === p) {\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nfunction checkMode(filename: string, options: { pathExt?: string }, stat: fse.Stats): boolean {\n\tconst mod = stat.mode;\n\tconst uid = stat.uid;\n\tconst gid = stat.gid;\n\tconst myUid = /*options.uid !== undefined ? options.uid :*/ process.getuid && process.getuid();\n\tconst myGid = /*options.gid !== undefined ? options.gid :*/ process.getgid && process.getgid();\n\tconst u = parseInt('100', 8);\n\tconst g = parseInt('010', 8);\n\tconst o = parseInt('001', 8);\n\tconst ug = u | g;\n\tconst ret = (mod & o) ||\n\t\t(mod & g) && gid === myGid ||\n\t\t(mod & u) && uid === myUid ||\n\t\t(mod & ug) && myUid === 0;\n\treturn !!ret;\n}\n\nfunction isexeStat(filename: string, options: { pathExt?: string }, stat: fse.Stats) {\n\tif (!stat.isFile()) {\n\t\treturn false;\n\t}\n\tif (!isWindows) {\n\t\treturn checkMode(filename, options, stat);\n\t} else {\n\t\treturn checkWindowsMode(filename, options, stat);\n\t}\n}\n\nfunction isexe(filename: string, options: { pathExt?: string }, cb: NodeDataCallback<boolean>) {\n\tfse.stat(filename, (err, stat) => {\n\t\tcb(err, err ? false : isexeStat(filename, options, stat));\n\t});\n}\n\nexport function whichs(cmd: string, cb: (error: Error | null, result?: Array<string>) => void) {\n\tconst opt: { all?: boolean } = {};\n\tconst info = getPathInfo(cmd, opt);\n\tconst pathEnv = info.env;\n\tconst pathExt = info.ext;\n\tconst pathExtExe = info.extExe;\n\tconst found: Array<string> = [];\n\n\t(function F(i, l) {\n\t\tif (i === l) {\n\t\t\tif (opt.all && found.length) {\n\t\t\t\treturn cb(null, found);\n\t\t\t} else {\n\t\t\t\treturn cb(getNotFoundError(cmd));\n\t\t\t}\n\t\t}\n\n\t\tlet pathPart = pathEnv[i];\n\t\tif (pathPart.charAt(0) === '\"' && pathPart.slice(-1) === '\"') {\n\t\t\tpathPart = pathPart.slice(1, -1);\n\t\t}\n\n\t\tlet p = path.join(pathPart, cmd);\n\t\tif (!pathPart && (/^\\.[\\\\\\/]/).test(cmd)) {\n\t\t\tp = cmd.slice(0, 2) + p;\n\t\t}\n\t\t(function E(ii, ll) {\n\t\t\tif (ii === ll) {\n\t\t\t\treturn F(i + 1, l);\n\t\t\t}\n\t\t\tconst ext = pathExt[ii];\n\t\t\tisexe(p + ext, {pathExt: pathExtExe}, (err, is) => {\n\t\t\t\tif (!err && is) {\n\t\t\t\t\tif (opt.all) {\n\t\t\t\t\t\tfound.push(p + ext);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn cb(null, [p + ext]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn E(ii + 1, ll);\n\t\t\t});\n\t\t})(0, pathExt.length);\n\t})(0, pathEnv.length);\n}\n\nasync function which(name: string): Promise<string | undefined> {\n\treturn new Promise<string | undefined>((resolve, reject) => {\n\t\twhichs(name, (err, result) => {\n\t\t\tif (err) {\n\t\t\t\treject(err);\n\t\t\t} else if (result && result.length > 0) {\n\t\t\t\tresolve(result[0]);\n\t\t\t} else {\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t});\n}\n\nasync function localBin(name: string): Promise<string | undefined> {\n\tconst s = path.join('.', 'bin', 'tools', name, process.platform, process.arch, name) + (isWindows ? '.exe' : '');\n\tconst exists = await fse.pathExists(s);\n\tif (exists) {\n\t\treturn s;\n\t}\n}\n\nasync function enviroment(envName: string): Promise<string | undefined> {\n\tconst s = process.env[envName];\n\tif (s && s.length > 0) {\n\t\tconst exists = await fse.pathExists(s);\n\t\tif (exists) {\n\t\t\treturn s;\n\t\t}\n\t}\n}\n\nexport async function getBinPath(name: string, envName: string): Promise<string | undefined> {\n\tif (name in cache) {\n\t\treturn cache[name];\n\t}\n\ttry {\n\t\t// Try envName\n\t\tconst s = await enviroment(envName);\n\t\tif (s && s.length > 0) {\n\t\t\tcache[name] = s;\n\t\t\treturn s;\n\t\t}\n\t} catch (e) {\n\t}\n\ttry {\n\t\t// Search in the PATH\n\t\tconst s = await which(name);\n\t\tif (s && s.length > 0) {\n\t\t\tcache[name] = s;\n\t\t\treturn s;\n\t\t}\n\t} catch (e) {\n\t}\n\ttry {\n\t\t// Search in the PATH\n\t\tconst s = await localBin(name);\n\t\tif (s && s.length > 0) {\n\t\t\tcache[name] = s;\n\t\t\treturn s;\n\t\t}\n\t} catch (e) {\n\t}\n}\n","module.exports = require(\"child_process\");","import {WebserviceClient} from '../../../utils/webservice-client';\nimport {LastFM} from '../../../model/lastfm-rest-data';\nimport Logger from '../../../utils/logger';\nimport {LastFMClientApi} from './lastfm-client.interface';\n\nconst log = Logger('LastFM');\n\nexport class LastFMClient extends WebserviceClient {\n\toptions: LastFMClientApi.LastFMClientApiOptions;\n\n\tconstructor(options: LastFMClientApi.LastFMClientApiOptions) {\n\t\t// \"not make more than 5 requests per originating IP address per second\" https://www.last.fm/api/tos\n\t\tsuper(5, 1000, options.userAgent);\n\t\tthis.options = options;\n\t}\n\n\tprivate beautify(obj: any): any {\n\n\t\tconst walk = (o: any, parent: any): any => {\n\t\t\tif (o === null) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tif (o === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tif (Array.isArray(o)) {\n\t\t\t\treturn o.map((sub: any) => walk(sub, parent)).filter((sub: any) => sub !== undefined);\n\t\t\t}\n\t\t\tif (typeof o === 'object') {\n\t\t\t\tconst result: any = {};\n\t\t\t\tObject.keys(o).forEach(key => {\n\t\t\t\t\tconst sub = walk(o[key], o);\n\t\t\t\t\tif (sub !== undefined) {\n\t\t\t\t\t\tif (key === '#text') {\n\t\t\t\t\t\t\tresult['url'] = sub;\n\t\t\t\t\t\t} else if (key === '@attr') {\n\t\t\t\t\t\t\tObject.keys(sub).forEach(subkey => {\n\t\t\t\t\t\t\t\tresult[subkey] = sub[subkey];\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else if (key === 'tags') {\n\t\t\t\t\t\t\tif (sub.tag) {\n\t\t\t\t\t\t\t\tif (!Array.isArray(sub.tag)) {\n\t\t\t\t\t\t\t\t\tsub.tag = [sub.tag];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tresult[key] = sub.tag;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[key] = sub;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (key === 'streamable') {\n\t\t\t\t\t\t\tresult[key] = {\n\t\t\t\t\t\t\t\tsample: sub['#text'],\n\t\t\t\t\t\t\t\tfulltrack: sub['fulltrack'],\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tif (sub.tag) {\n\t\t\t\t\t\t\t\tif (!Array.isArray(sub.tag)) {\n\t\t\t\t\t\t\t\t\tsub.tag = [sub.tag];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tresult[key] = sub.tag;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[key] = sub;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (key === 'image') {\n\t\t\t\t\t\t\tconst images = Array.isArray(sub) ? sub : [sub];\n\t\t\t\t\t\t\tresult[key] = images.filter(img => img.url && img.url.length > 0);\n\t\t\t\t\t\t} else if (key === 'tracks') {\n\t\t\t\t\t\t\tif (sub.track) {\n\t\t\t\t\t\t\t\tif (!Array.isArray(sub.track)) {\n\t\t\t\t\t\t\t\t\tsub.track = [sub.track];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tresult[key] = sub.track;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[key] = sub;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (key === 'links') {\n\t\t\t\t\t\t\tif (sub.link) {\n\t\t\t\t\t\t\t\tif (!Array.isArray(sub.link)) {\n\t\t\t\t\t\t\t\t\tsub.link = [sub.link];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tresult[key] = sub.link;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresult[key] = sub;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresult[key] = sub;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\treturn o;\n\t\t};\n\t\treturn walk(obj, {});\n\t}\n\n\tprivate async get(api: string, params: { [name: string]: string; }): Promise<LastFM.Result> {\n\t\tlog.info('requesting', api, JSON.stringify(params));\n\t\tparams['method'] = api;\n\t\tconst sorted_params: { [name: string]: string; } = {'method': api};\n\t\tObject.keys(params).forEach(key => {\n\t\t\tsorted_params[key] = params[key];\n\t\t});\n\t\tsorted_params['api_key'] = this.options.key;\n\t\tsorted_params['format'] = 'json';\n\t\ttry {\n\t\t\tconst data = await this.getJson('http://ws.audioscrobbler.com/2.0/', sorted_params);\n\t\t\treturn <LastFM.Result>this.beautify(data);\n\t\t} catch (e) {\n\t\t\tlog.error(e);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync artist(artist: string): Promise<LastFM.Artist | undefined> {\n\t\t// https://www.last.fm/api/show/artist.getInfo\n\t\tconst data = await this.get('artist.getInfo', {artist});\n\t\treturn data.artist;\n\t}\n\n\tasync trackID(mbid: string): Promise<LastFM.Track | undefined> {\n\t\t// https://www.last.fm/api/show/artist.getInfo\n\t\tconst data = await this.get('artist.getInfo', {mbid});\n\t\treturn data.track;\n\t}\n\n\tasync artistID(mbid: string): Promise<LastFM.Artist | undefined> {\n\t\t// https://www.last.fm/api/show/artist.getInfo\n\t\tconst data = await this.get('artist.getInfo', {mbid});\n\t\treturn data.artist;\n\t}\n\n\tasync album(album: string, artist: string): Promise<LastFM.Album | undefined> {\n\t\t// https://www.last.fm/api/show/album.getInfo\n\t\tconst data = await this.get('album.getInfo', {artist, album});\n\t\treturn data.album;\n\t}\n\n\tasync albumID(mbid: string): Promise<LastFM.Album | undefined> {\n\t\t// https://www.last.fm/api/show/album.getInfo\n\t\tconst data = await this.get('album.getInfo', {mbid});\n\t\treturn data.album;\n\t}\n\n\tasync albumIDTopTags(mbid: string): Promise<LastFM.TopTracks | undefined> {\n\t\t// https://www.last.fm/api/show/album.getTopTags\n\t\tconst data = await this.get('album.getTopTags', {mbid});\n\t\treturn data.toptracks;\n\t}\n\n\tasync similarTrack(track: string, artist: string): Promise<LastFM.SimilarTracks | undefined> {\n\t\t// https://www.last.fm/api/show/track.getSimilar\n\t\tconst data = await this.get('track.getSimilar', {track, artist});\n\t\treturn data.similartracks;\n\t}\n\n\tasync similarTrackID(mbid: string): Promise<LastFM.SimilarTracks | undefined> {\n\t\t// https://www.last.fm/api/show/track.getSimilar\n\t\tconst data = await this.get('track.getSimilar', {mbid});\n\t\treturn data.similartracks;\n\t}\n\n\tasync topArtistSongs(artist: string): Promise<LastFM.TopTracks | undefined> {\n\t\t// https://www.last.fm/api/show/artist.getTopTracks\n\t\tconst data = await this.get('artist.getTopTracks', {artist});\n\t\treturn data.toptracks;\n\t}\n\n\tasync topArtistSongsID(mbid: string): Promise<LastFM.TopTracks | undefined> {\n\t\t// https://www.last.fm/api/show/artist.getTopTracks\n\t\tconst data = await this.get('artist.getTopTracks', {mbid});\n\t\treturn data.toptracks;\n\t}\n\n\tasync lookup(type: string, id: string): Promise<LastFM.Result> {\n\t\tif (type === 'album') {\n\t\t\tconst album = await this.albumID(id);\n\t\t\treturn {album};\n\t\t} else if (type === 'album-toptracks') {\n\t\t\tconst toptracks = await this.albumIDTopTags(id);\n\t\t\treturn {toptracks};\n\t\t} else if (type === 'artist') {\n\t\t\tconst artist = await this.artistID(id);\n\t\t\treturn {artist};\n\t\t} else if (type === 'track') {\n\t\t\tconst track = await this.trackID(id);\n\t\t\treturn {track};\n\t\t} else if (type === 'track-similar') {\n\t\t\tconst similartracks = await this.similarTrackID(id);\n\t\t\treturn {similartracks};\n\t\t} else if (type === 'artist-toptracks') {\n\t\t\tconst toptracks = await this.topArtistSongsID(id);\n\t\t\treturn {toptracks};\n\t\t} else {\n\t\t\treturn Promise.reject(Error('Invalid LastFM lookup type parameter'));\n\t\t}\n\t}\n\n}\n","import {WebserviceClient} from '../../../utils/webservice-client';\nimport {LookupBrowseTypes, LookupIncludes} from './musicbrainz-client.types';\nimport {MusicBrainz} from '../../../model/musicbrainz-rest-data';\nimport Logger from '../../../utils/logger';\nimport {MusicbrainzClientApi} from './musicbrainz-client.interface';\n\nconst log = Logger('Musicbrainz');\n\nexport class MusicbrainzClient extends WebserviceClient {\n\toptions = {\n\t\thost: 'http://musicbrainz.org',\n\t\tport: 80,\n\t\tbasePath: '/ws/2/',\n\t\tuserAgent: '',\n\t\tlimit: 25,\n\t\tretryOn: false,\n\t\tretryDelay: 3000,\n\t\tretryCount: 3\n\t};\n\n\tconstructor(options: MusicbrainzClientApi.Options) {\n\t\t// https://musicbrainz.org/doc/XML_Web_Service/Rate_Limiting \"Currently that rate is (on average) 1 request per second. (per ip)\"\n\t\tsuper(1, 1000, options.userAgent);\n\t\tthis.options = Object.assign({}, this.options, options);\n\t}\n\n\tprivate beautify(obj: any): any {\n\t\tconst formatKey = (key: string): string => {\n\t\t\treturn key.split('-').map((value, index) => {\n\t\t\t\tif (index === 0) {\n\t\t\t\t\treturn value;\n\t\t\t\t}\n\t\t\t\treturn value[0].toUpperCase() + value.slice(1);\n\t\t\t}).join('');\n\t\t};\n\n\t\tconst walk = (o: any): any => {\n\t\t\tif (o === null) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tif (o === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tif (Array.isArray(o)) {\n\t\t\t\treturn o.map((sub: any) => walk(sub)).filter((sub: any) => sub !== undefined);\n\t\t\t}\n\t\t\tif (typeof o === 'object') {\n\t\t\t\tconst result: any = {};\n\t\t\t\tObject.keys(o).forEach(key => {\n\t\t\t\t\tconst sub = walk(o[key]);\n\t\t\t\t\tif (sub !== undefined) {\n\t\t\t\t\t\tresult[formatKey(key)] = sub;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\treturn o;\n\t\t};\n\t\treturn walk(obj);\n\t}\n\n\tprivate concatSearchQuery(query: MusicbrainzClientApi.SearchQuery): string {\n\t\treturn Object.keys(query)\n\t\t\t.filter(key => ((<any>query)[key] !== undefined && (<any>query)[key] !== null))\n\t\t\t.map(key => key + ':\"' + encodeURIComponent((<any>query)[key]) + '\"')\n\t\t\t.join('%20AND%20');\n\t}\n\n\tprivate async get(req: MusicbrainzClientApi.Request): Promise<any> {\n\t\tconst q = Object.keys(req.query)\n\t\t\t.filter(key => (req.query[key] !== undefined && req.query[key] !== null))\n\t\t\t.map(key => key + '=' + req.query[key]);\n\t\tq.push('limit=' + (req.limit || this.options.limit || 25));\n\t\tq.push('offset=' + (req.offset || 0));\n\t\tq.push('fmt=json');\n\t\tconst url = this.options.host + (this.options.port !== 80 ? ':' + this.options.port : '') + req.path + '?' + q.join('&');\n\n\t\tconst isRateLimitError = (body: any): boolean => {\n\t\t\treturn (body && body.error && body.error.indexOf('allowable rate limit') >= 0);\n\t\t\t// \"error\":\"Your requests are exceeding the allowable rate limit. Please see http://wiki.musicbrainz.org/XMLWebService for more information.\"\n\t\t};\n\t\tconst options = this.options;\n\t\tconst get = this.get;\n\n\t\tasync function retry(error: Error): Promise<any> {\n\t\t\tif (options.retryOn && req.retry < options.retryCount) {\n\t\t\t\treq.retry++;\n\t\t\t\tlog.info('rate limit hit, retrying in ' + options.retryDelay + 'ms');\n\t\t\t\treturn new Promise<any>((resolve, reject) => {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tget(req).then(resolve).catch(reject);\n\t\t\t\t\t}, options.retryDelay);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(error);\n\t\t\t}\n\t\t}\n\n\t\tlog.info('requesting', JSON.stringify(req));\n\t\ttry {\n\t\t\tconst data = await this.getJson<any>(url, undefined);\n\t\t\tif (isRateLimitError(data)) {\n\t\t\t\treturn retry(Error(data.error));\n\t\t\t}\n\t\t\treturn data;\n\t\t} catch (e) {\n\t\t\tconst statusCode = e.statusCode;\n\t\t\tif (statusCode === 502 || statusCode === 503) {\n\t\t\t\treturn retry(e);\n\t\t\t} else {\n\t\t\t\tlog.error(e);\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync search(params: MusicbrainzClientApi.ParameterSearch): Promise<MusicBrainz.Response> {\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + params.type + '/',\n\t\t\tquery: {query: this.concatSearchQuery(params.query || {})},\n\t\t\tretry: 0,\n\t\t\tlimit: params.limit,\n\t\t\toffset: params.offset\n\t\t});\n\t\treturn this.beautify(data);\n\t}\n\n\tasync luceneSearch(params: MusicbrainzClientApi.ParameterLuceneSearch): Promise<MusicBrainz.Response> {\n\t\t// https://lucene.apache.org/core/4_3_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#package_description\n\t\tif (!params.query || params.query.length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid query for type ' + params.type));\n\t\t}\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + params.type + '/',\n\t\t\tquery: {\n\t\t\t\tquery: encodeURIComponent(params.query || '')\n\t\t\t},\n\t\t\tretry: 0,\n\t\t\tlimit: params.limit,\n\t\t\toffset: params.offset\n\t\t});\n\t\tconst result: any = {};\n\t\tresult[params.type] = data || {};\n\t\treturn this.beautify(result);\n\t}\n\n\tasync lookup(params: MusicbrainzClientApi.ParameterLookup): Promise<MusicBrainz.Response> {\n\t\tif (!params.id || params.id.length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid lookup id for type ' + params.type));\n\t\t}\n\t\tconst lookup = LookupIncludes[params.type];\n\t\tconst inc = params.inc || LookupIncludes[params.type].join('+');\n\t\tif (!lookup) {\n\t\t\treturn Promise.reject(Error('Invalid Lookup'));\n\t\t}\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + params.type + '/' + params.id,\n\t\t\tquery: {\n\t\t\t\tmbid: params.id,\n\t\t\t\tinc: inc\n\t\t\t},\n\t\t\tretry: 0,\n\t\t\tlimit: params.limit,\n\t\t\toffset: params.offset\n\t\t});\n\t\tconst result: any = {};\n\t\tresult[params.type] = data || {};\n\t\treturn this.beautify(result);\n\t}\n\n\tasync browse(params: MusicbrainzClientApi.ParameterBrowse): Promise<MusicBrainz.Response> {\n\t\tconst invalidKey = Object.keys(params.lookupIds).find(key => !LookupBrowseTypes[params.type] || LookupBrowseTypes[params.type].indexOf(key) < 0);\n\t\tif (invalidKey) {\n\t\t\treturn Promise.reject(Error('Invalid browse lookup key for type ' + params.type + ': ' + invalidKey));\n\t\t}\n\t\tconst query = Object.assign({inc: params.inc}, params.lookupIds);\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + params.type,\n\t\t\tquery,\n\t\t\tretry: 0,\n\t\t\tlimit: params.limit,\n\t\t\toffset: params.offset\n\t\t});\n\t\tconst result: any = {};\n\t\tresult[params.type] = data || {};\n\t\treturn this.beautify(result);\n\t}\n\n}\n","export const LookupBrowseTypes: { [type: string]: Array<string> } = {\n\tarea: ['collection'],\n\tartist: ['area', 'collection', 'recording', 'release', 'release-group', 'work'],\n\tcollection: ['area', 'artist', 'editor', 'event', 'label', 'place', 'recording', 'release', 'release-group', 'work'],\n\tevent: ['area', 'artist', 'collection', 'place'],\n\tinstrument: ['collection'],\n\tlabel: ['area', 'collection', 'release'],\n\tplace: ['area', 'collection'],\n\trecording: ['artist', 'collection', 'release'],\n\trelease: ['area', 'artist', 'collection', 'label', 'track', 'track_artist', 'recording', 'release-group'],\n\t'release-group': ['artist', 'collection', 'release'],\n\tseries: ['collection'],\n\twork: ['artist', 'collection'],\n\turl: ['resource']\n};\n\nexport const LookupIncludes: { [type: string]: Array<string> } = {\n\tarea: [],\n\tartist: ['recordings', 'releases', 'release-groups', 'works', 'aliases', 'artist-rels', 'url-rels', 'tags', 'ratings'],\n\tcollection: ['user-collections'],\n\tevent: [],\n\tinstrument: [],\n\tlabel: ['releases'],\n\tplace: [],\n\trecording: ['artists', 'releases', 'artist-credits', 'aliases', 'tags', 'ratings', 'annotation'],\n\trelease: ['artists', 'collections', 'labels', 'recordings', 'release-groups', 'discids', 'media', 'isrcs', 'artist-credits', 'aliases', 'tags', 'url-rels', 'annotation'],\n\t'release-group': ['artists', 'releases', 'media', 'artist-credits', 'aliases', 'tags', 'ratings', 'url-rels', 'annotation'],\n\tseries: [],\n\twork: [],\n\turl: []\n};\n\nexport const enum LookupEntity {\n\tarea = 'area',\n\tartist = 'artist',\n\tcollection = 'collection',\n\tevent = 'event',\n\tinstrument = 'instrument',\n\tlabel = 'label',\n\tplace = 'place',\n\trecording = 'recording',\n\trelease = 'release',\n\treleaseGroup = 'release-group',\n\tseries = 'series',\n\twork = 'work',\n\turl = 'url'\n}\n","let GenresSlugs: { [slug: string]: string }; // will be build on first use\n\nconst genreByNumbers = [\n\t'Blues',\n\t'Classic Rock',\n\t'Country',\n\t'Dance',\n\t'Disco',\n\t'Funk',\n\t'Grunge',\n\t'Hip Hop',\n\t'Jazz',\n\t'Metal',\n\t'New Age',\n\t'Oldies',\n\t'Other',\n\t'Pop',\n\t'R&B',\n\t'Rap',\n\t'Reggae',\n\t'Rock',\n\t'Techno',\n\t'Industrial',\n\t'Alternative',\n\t'Ska',\n\t'Death Metal',\n\t'Pranks',\n\t'Soundtrack',\n\t'Euro-Techno',\n\t'Ambient',\n\t'Trip-Hop',\n\t'Vocal',\n\t'Jazz+Funk',\n\t'Fusion',\n\t'Trance',\n\t'Classical',\n\t'Instrumental',\n\t'Acid',\n\t'House',\n\t'Game',\n\t'Sound Clip',\n\t'Gospel',\n\t'Noise',\n\t'Alternative Rock',\n\t'Bass',\n\t'Soul',\n\t'Punk',\n\t'Space',\n\t'Meditative',\n\t'Instrumental Pop',\n\t'Instrumental Rock',\n\t'Ethnic',\n\t'Gothic',\n\t'Darkwave',\n\t'Techno-Industrial',\n\t'Electronic',\n\t'Pop-Folk',\n\t'Eurodance',\n\t'Dream',\n\t'Southern Rock',\n\t'Comedy',\n\t'Cult',\n\t'Gangsta Rap',\n\t'Top 40',\n\t'Christian Rap',\n\t'Pop-Funk',\n\t'Jungle',\n\t'Native American',\n\t'Cabaret',\n\t'New Wave',\n\t'Psychedelic',\n\t'Rave',\n\t'Showtunes',\n\t'Trailer',\n\t'Lo-Fi',\n\t'Tribal',\n\t'Acid Punk',\n\t'Acid Jazz',\n\t'Polka',\n\t'Retro',\n\t'Musical',\n\t'Rock & Roll',\n\t'Hard Rock',\n\t'Folk',\n\t'Folk-Rock',\n\t'National Folk',\n\t'Swing',\n\t'Fast Fusion',\n\t'Bebop',\n\t'Latin',\n\t'Revival',\n\t'Celtic',\n\t'Bluegrass',\n\t'Avantgarde',\n\t'Gothic Rock',\n\t'Progressive Rock',\n\t'Psychedelic Rock',\n\t'Symphonic Rock',\n\t'Slow Rock',\n\t'Big Band',\n\t'Chorus',\n\t'Easy Listening',\n\t'Acoustic',\n\t'Humour',\n\t'Speech',\n\t'Chanson',\n\t'Opera',\n\t'Chamber Music',\n\t'Sonata',\n\t'Symphony',\n\t'Booty Bass',\n\t'Primus',\n\t'Porn Groove',\n\t'Satire',\n\t'Slow Jam',\n\t'Club',\n\t'Tango',\n\t'Samba',\n\t'Folklore',\n\t'Ballad',\n\t'Power Ballad',\n\t'Rhythmic Soul',\n\t'Freestyle',\n\t'Duet',\n\t'Punk Rock',\n\t'Drum Solo',\n\t'A Cappella',\n\t'Euro-House',\n\t'Dance Hall',\n\t'Goa',\n\t'Drum & Bass',\n\t'Club-House',\n\t'Hardcore',\n\t'Terror',\n\t'Indie',\n\t'BritPop',\n\t'Weltmusik',\n\t'Polsk Punk',\n\t'Beat',\n\t'Christian Gangsta Rap',\n\t'Heavy Metal',\n\t'Black Metal',\n\t'Crossover',\n\t'Contemporary Christian',\n\t'Christian Rock',\n\t'Merengue',\n\t'Salsa',\n\t'Thrash Metal',\n\t'Anime',\n\t'JPop',\n\t'Synthpop',\n\t'Abstract',\n\t'Art Rock',\n\t'Baroque',\n\t'Bhangra',\n\t'Big Beat',\n\t'Breakbeat',\n\t'Chillout',\n\t'Downtempo',\n\t'Dub',\n\t'EBM',\n\t'Eclectic',\n\t'Electro',\n\t'Electroclash',\n\t'Emo',\n\t'Experimental',\n\t'Garage',\n\t'Global',\n\t'IDM',\n\t'Illbient',\n\t'Industro-Goth',\n\t'Jam Band',\n\t'Krautrock',\n\t'Leftfield',\n\t'Lounge',\n\t'Math Rock',\n\t'New Romantic',\n\t'Nu-Breakz',\n\t'Post-Punk',\n\t'Post-Rock',\n\t'Psytrance',\n\t'Shoegaze',\n\t'Space Rock',\n\t'Trop Rock',\n\t'World Music',\n\t'Neoclassical',\n\t'Audiobook',\n\t'Audio Theatre',\n\t'Neue Deutsche Welle',\n\t'Podcast',\n\t'Indie Rock',\n\t'G-Funk',\n\t'Dubstep',\n\t'Garage Rock',\n\t'Psybient'];\n\nexport const Genres: Array<string> = [\n\t'2 Tone',\n\t'2-Step Garage',\n\t'4-Beat',\n\t'A Cappella',\n\t'Abstract',\n\t'Acid',\n\t'Acid Breaks',\n\t'Acid House',\n\t'Acid Jazz',\n\t'Acid Punk',\n\t'Acid Rock',\n\t'Acid Techno',\n\t'Acid Trance',\n\t'Acousmatic Music',\n\t'Acoustic',\n\t'Adult Contemporary',\n\t'African',\n\t'African Blues',\n\t'African Heavy Metal',\n\t'African Hip Hop',\n\t'Afro / Cosmic Disco',\n\t'Afro-Cuban Jazz',\n\t'Afrobeat',\n\t'Aggrotech',\n\t'Alternative',\n\t'Alternative Country',\n\t'Alternative Dance',\n\t'Alternative Hip Hop',\n\t'Alternative Metal',\n\t'Alternative Rock',\n\t'Ambient',\n\t'Ambient Dub',\n\t'Ambient House',\n\t'American Folk Revival',\n\t'Americana',\n\t'Anarcho Punk',\n\t'Anime',\n\t'Anti-folk',\n\t'Apala',\n\t'Arab Pop',\n\t'Art Punk',\n\t'Art Rock',\n\t'Asian',\n\t'Asian American Jazz',\n\t'Asian Underground',\n\t'Atlanta Hip Hop',\n\t'Audio Theatre',\n\t'Audiobook',\n\t'Australian Country Music',\n\t'Australian Hip Hop',\n\t'AustroPop',\n\t'Avant-garde',\n\t'Avant-garde Jazz',\n\t'Avant-garde Metal',\n\t'Avantgarde',\n\t'Ax',\n\t'Bachata',\n\t'Background Music',\n\t'Baila',\n\t'Baithak Gana',\n\t'Bakersfield sound',\n\t'Balearic Beat',\n\t'Balearic Trance',\n\t'Ballad',\n\t'Baltimore Club',\n\t'Banda',\n\t'Baroque',\n\t'Baroque Pop',\n\t'Bass',\n\t'Bassline',\n\t'Baul',\n\t'Beat',\n\t'Beat Music',\n\t'Beautiful Music',\n\t'Bebop',\n\t'Benga',\n\t'Berlin School',\n\t'Bhangra',\n\t'Big Band',\n\t'Big Beat',\n\t'Big Room',\n\t'Bikutsi',\n\t'BitPop',\n\t'Black Metal',\n\t'Blue-Eyed Soul',\n\t'Bluegrass',\n\t'Blues',\n\t'Blues Country',\n\t'Blues Rock',\n\t'Blues Shouter',\n\t'Bolero',\n\t'Bongo Flava',\n\t'Boogie',\n\t'Boogie-Woogie',\n\t'Booty Bass',\n\t'Bossa Nova',\n\t'Bounce Music',\n\t'Bouncy House',\n\t'Bouncy Techno',\n\t'Bouyon',\n\t'Brazilian',\n\t'Brazilian Rock',\n\t'Breakbeat',\n\t'Breakbeat Hardcore',\n\t'Breakcore',\n\t'Breakstep',\n\t'Brega',\n\t'Brick City club',\n\t'Brill Building',\n\t'British Blues',\n\t'British Dance Band',\n\t'British Folk revival',\n\t'British Hip Hop',\n\t'BritPop',\n\t'Broken Beat',\n\t'Brostep',\n\t'Bubblegum Dance',\n\t'Bubblegum Pop',\n\t'Bullerengue',\n\t'C-Pop',\n\t'Cabaret',\n\t'Cadence-lypso',\n\t'Cajun',\n\t'Cajun fiddle tunes',\n\t'Calypso',\n\t'Canadian Blues',\n\t'Cancin',\n\t'Canterbury scene',\n\t'Canzone',\n\t'Cape Jazz',\n\t'Caribbean',\n\t'Celtic',\n\t'Celtic Metal',\n\t'Celtic Music',\n\t'Celtic Punk',\n\t'Cha Cha Cha',\n\t'Chalga',\n\t'Chamber Jazz',\n\t'Chamber Music',\n\t'Chanson',\n\t'Chap Hop',\n\t'Chicago Blues',\n\t'Chicago Hip Hop',\n\t'Chicago House',\n\t'Chicano Rap',\n\t'Chicha',\n\t'Chill-out',\n\t'Chillout',\n\t'Chillstep',\n\t'Chillwave',\n\t'Chimurenga',\n\t'Chinese Rock',\n\t'Chiptune',\n\t'Chopped & Screwed',\n\t'Choro',\n\t'Chorus',\n\t'Christian Country Music',\n\t'Christian Gangsta Rap',\n\t'Christian Hip Hop',\n\t'Christian Metal',\n\t'Christian Pop',\n\t'Christian Punk',\n\t'Christian Rap',\n\t'Christian Rock',\n\t'Chutney',\n\t'Chutney soca',\n\t'Classic Country',\n\t'Classic female Blues',\n\t'Classic Rock',\n\t'Classical',\n\t'Classical crossover',\n\t'Close harmony',\n\t'Club',\n\t'Club-House',\n\t'Coldwave',\n\t'Comedy',\n\t'Compas',\n\t'Complextro',\n\t'Congolese rumba',\n\t'Conscious Hip Hop',\n\t'Contemporary Christian',\n\t'Contemporary Folk',\n\t'Contemporary R&B',\n\t'Continental Jazz',\n\t'Cool Jazz',\n\t'Country',\n\t'Country Blues',\n\t'Country Pop',\n\t'Country Rap',\n\t'Country Rock',\n\t'Country-Rap',\n\t'Coup-Dcal',\n\t'Western Music',\n\t'CowPunk',\n\t'Criolla',\n\t'Crossover',\n\t'Crossover Jazz',\n\t'Crossover Thrash',\n\t'Crunk',\n\t'Crunkcore',\n\t'Crust Punk',\n\t'Crustgrind',\n\t'Cult',\n\t'Cumbia',\n\t'Cumbia Rap',\n\t'Cybergrind',\n\t'D-beat',\n\t'Dance',\n\t'Dance Hall',\n\t'Dance-Pop',\n\t'Dance-Punk',\n\t'Dance-Rock',\n\t'Dancehall',\n\t'Dancehall Music',\n\t'Dangdut',\n\t'Dansband Music',\n\t'Dark Ambient',\n\t'Dark Cabaret',\n\t'Dark Electro',\n\t'Dark Wave',\n\t'Darkcore',\n\t'Darkcore jungle',\n\t'Darkstep',\n\t'Darkwave',\n\t'Death \\'n\\' roll',\n\t'Death industrial',\n\t'Death Metal',\n\t'Death-Doom',\n\t'Deathcore',\n\t'DeathRock',\n\t'Deep Funk',\n\t'Deep House',\n\t'Delta Blues',\n\t'Desert Rock',\n\t'Detroit Blues',\n\t'Detroit Hip Hop',\n\t'Detroit Techno',\n\t'Digital hardcore',\n\t'Disco',\n\t'Disco polo',\n\t'Diva House',\n\t'Dixieland',\n\t'Djent',\n\t'Doom Metal',\n\t'Doomcore',\n\t'Downtempo',\n\t'Dream',\n\t'Dream Pop',\n\t'Dream Trance',\n\t'Drill',\n\t'Drill & Bass',\n\t'Drone Metal',\n\t'Drone Music',\n\t'Drum & Bass',\n\t'Drum Solo',\n\t'Drumstep',\n\t'Dub',\n\t'Dub Techno',\n\t'Dubstep',\n\t'Dubstyle',\n\t'Dubtronica',\n\t'Duet',\n\t'Dunedin Sound',\n\t'Dutch House',\n\t'East Coast Hip Hop',\n\t'Easy Listening',\n\t'EBM',\n\t'Eclectic',\n\t'Electric Blues',\n\t'Electro',\n\t'Electro House',\n\t'Electro Music',\n\t'Electro Swing',\n\t'Electro-Industrial',\n\t'Electroacoustic',\n\t'Electroacoustic Music',\n\t'Electroclash',\n\t'Electronic',\n\t'Electronic Body Music',\n\t'Electronic Rock',\n\t'Electronica',\n\t'Electronicore',\n\t'ElectroPop',\n\t'ElectroPunk',\n\t'Elevator Music',\n\t'Emo',\n\t'Ethereal Wave',\n\t'Ethnic',\n\t'Ethnic electronica',\n\t'Ethno Jazz',\n\t'Euro Disco',\n\t'Euro-House',\n\t'Euro-Techno',\n\t'Eurobeat',\n\t'Eurodance',\n\t'European free Jazz',\n\t'EuroPop',\n\t'Experimental',\n\t'Experimental Hip Hop',\n\t'Experimental Music',\n\t'Experimental Rock',\n\t'Fado',\n\t'Fann at-Tanbura',\n\t'Fast Fusion',\n\t'Fidget House',\n\t'Fijiri',\n\t'Filk Music',\n\t'Filmi',\n\t'Flamenco',\n\t'Florida Breaks',\n\t'Folk',\n\t'Folk Metal',\n\t'Folk Pop',\n\t'Folk Punk',\n\t'Folk Rock',\n\t'Folk-Rock',\n\t'Folklore',\n\t'Folktronica',\n\t'Forr',\n\t'Franco-Country',\n\t'Freak Folk',\n\t'Freakbeat',\n\t'Free Funk',\n\t'Free Improvisation',\n\t'Free Jazz',\n\t'Free Tekno',\n\t'Freestyle',\n\t'Freestyle Music',\n\t'Freestyle Rap',\n\t'French House',\n\t'French Pop',\n\t'Frevo',\n\t'Fuji Music',\n\t'Full On',\n\t'Funk',\n\t'Funk Carioca',\n\t'Funk Metal',\n\t'Funkstep',\n\t'Funktronica',\n\t'Funky House',\n\t'Furniture Music',\n\t'Fusion',\n\t'Future Garage',\n\t'Future House',\n\t'FuturePop',\n\t'G-Funk',\n\t'Gabba',\n\t'Game',\n\t'Game Boy Music',\n\t'Gamelan',\n\t'Gangsta Rap',\n\t'Garage',\n\t'Garage House',\n\t'Garage Punk',\n\t'Garage Rock',\n\t'Genge',\n\t'Ghetto House',\n\t'Ghettotech',\n\t'Glam Metal',\n\t'Glam Rock',\n\t'Glitch',\n\t'Glitch Hop',\n\t'Global',\n\t'Go-go',\n\t'Goa',\n\t'Goa Trance',\n\t'Golden Age Hip Hop',\n\t'Goregrind',\n\t'Gospel',\n\t'Gospel Blues',\n\t'Gothic',\n\t'Gothic Metal',\n\t'Gothic Rock',\n\t'Grime',\n\t'Grindcore',\n\t'Grindie',\n\t'Groove Metal',\n\t'Grunge',\n\t'Grupera',\n\t'Guajira',\n\t'Gypsy Jazz',\n\t'Gypsy Punk',\n\t'Happy Hardcore',\n\t'Hard Bop',\n\t'Hard House',\n\t'Hard NRG',\n\t'Hard Rock',\n\t'Hard Trance',\n\t'Hardbag',\n\t'Hardcore',\n\t'Hardcore Rap',\n\t'Hardcore Hip Hop',\n\t'Hardcore Punk',\n\t'Hardstep',\n\t'Hardstyle',\n\t'Heavy Metal',\n\t'Hellbilly Music',\n\t'Hi-NRG',\n\t'Highlife',\n\t'Hill Country Blues',\n\t'Hip Hop',\n\t'Hip Hop Soul',\n\t'Hip House',\n\t'Hip Pop',\n\t'Hip Hop',\n\t'Hiplife',\n\t'Hokum',\n\t'Hokum Blues',\n\t'Honky Tonk',\n\t'Horror Punk',\n\t'Horrorcore',\n\t'House',\n\t'House Music',\n\t'Houston Hip Hop',\n\t'Huayno',\n\t'Humour',\n\t'Hyphy',\n\t'IDM',\n\t'Igbo highlife',\n\t'Igbo Rap',\n\t'Illbient',\n\t'Indian Pop',\n\t'Indie',\n\t'Indie Folk',\n\t'Indie Pop',\n\t'Indie Rock',\n\t'Indietronica',\n\t'Industrial',\n\t'Industrial Folk',\n\t'Industrial Hip Hop',\n\t'Industrial Metal',\n\t'Industrial Music',\n\t'Industrial Rock',\n\t'Industro-Goth',\n\t'Instrumental',\n\t'Instrumental Country',\n\t'Instrumental Hip Hop',\n\t'Instrumental Pop',\n\t'Instrumental Rock',\n\t'Iranian Pop',\n\t'Isicathamiya',\n\t'Isolationism',\n\t'Italo Dance',\n\t'Italo Disco',\n\t'Italo House',\n\t'J-Pop',\n\t'Jam Band',\n\t'Jangle Pop',\n\t'Japanoise',\n\t'Jazz',\n\t'Jazz Blues',\n\t'Jazz Fusion',\n\t'Jazz House',\n\t'Jazz Rap',\n\t'Jazz Rock',\n\t'Jazz-Funk',\n\t'Jazz+Funk',\n\t'Jerkin\\'',\n\t'Jersey Club',\n\t'Jit',\n\t'JPop',\n\t'Jj',\n\t'Jump Blues',\n\t'Jump-up',\n\t'Jumpstyle',\n\t'Jungle',\n\t'K-Pop',\n\t'Kadongo Kamu',\n\t'Kansas City Blues',\n\t'Kansas City Jazz',\n\t'Kapuka',\n\t'Keroncong',\n\t'Khaliji',\n\t'Kizomba',\n\t'Krautrock',\n\t'Kuduro',\n\t'Kwaito',\n\t'Kwassa Kwassa',\n\t'Kwela',\n\t'Lak',\n\t'Lambada',\n\t'Laptronica',\n\t'Latin',\n\t'Latin alternative',\n\t'Latin ballad',\n\t'Latin Christian',\n\t'Latin House',\n\t'Latin Jazz',\n\t'Latin Metal',\n\t'Latin Pop',\n\t'Latin Rock',\n\t'Latin Swing',\n\t'Lavani',\n\t'Leftfield',\n\t'Lento Violento',\n\t'Liquid Dubstep',\n\t'Liquid Funk',\n\t'Livetronica',\n\t'Liwa',\n\t'Lo-fi',\n\t'Lo-Fi',\n\t'Louisiana Blues',\n\t'Louisiana Swamp Pop',\n\t'Lounge',\n\t'Lounge Music',\n\t'Lovers Rock',\n\t'Low Bap',\n\t'Lowercase',\n\t'Luk Krung',\n\t'Luk Thung',\n\t'Lyrical Hip Hop',\n\t'M-Base',\n\t'Mafioso Rap',\n\t'Mainstream Jazz',\n\t'Mkina',\n\t'Makossa',\n\t'Maloya',\n\t'Mambo',\n\t'MandoPop',\n\t'Manila Sound',\n\t'Maracatu',\n\t'Mariachi',\n\t'Marrabenta',\n\t'Math Rock',\n\t'Mathcore',\n\t'Mbalax',\n\t'Mbaqanga',\n\t'Mbube',\n\t'Medieval Metal',\n\t'Meditative',\n\t'Melbourne Bounce',\n\t'Melodic Death Metal',\n\t'Melodic Metalcore',\n\t'Memphis Blues',\n\t'Merengue',\n\t'MerenRap',\n\t'Mringue',\n\t'Metal',\n\t'Metalcore',\n\t'Mexican Pop',\n\t'Mexican Son',\n\t'Miami Bass',\n\t'Microhouse',\n\t'Middle of the road',\n\t'Midwest Hip Hop',\n\t'Minimal Techno',\n\t'Minimal Wave',\n\t'Modal Jazz',\n\t'Moombahcore',\n\t'Moombahton',\n\t'Morlam',\n\t'Morna',\n\t'Mosambique',\n\t'Motswako',\n\t'Msica Criolla',\n\t'Msica Popular Brasileira',\n\t'Msica Sertaneja',\n\t'Musical',\n\t'Musique Concrte',\n\t'Nagoya Kei',\n\t'Nashville Sound',\n\t'National Folk',\n\t'Native American',\n\t'NDW',\n\t'Ndombolo',\n\t'NederPop',\n\t'Neo Soul',\n\t'Neo-Bop Jazz',\n\t'Neo-Psychedelia',\n\t'Neo-Swing',\n\t'Neoclassical',\n\t'Neoclassical Metal',\n\t'Neofolk',\n\t'Neotraditional Country',\n\t'Nerdcore',\n\t'Neue Deutsche Welle',\n\t'NeuroFunk',\n\t'Neurohop',\n\t'New Age',\n\t'New Beat',\n\t'New jack swing',\n\t'New Jersey Hip Hop',\n\t'New Prog',\n\t'New Rave',\n\t'New Romantic',\n\t'New Romanticism',\n\t'New School Hip Hop',\n\t'New Wave',\n\t'New-age Music',\n\t'Nintendocore',\n\t'Nitzhonot',\n\t'No wave',\n\t'Noise',\n\t'Noise Rock',\n\t'Noisegrind',\n\t'Nortec',\n\t'Norteo',\n\t'Northern Soul',\n\t'Novelty Ragtime',\n\t'Nu Jazz',\n\t'Nu Metal',\n\t'Nu Skool Breaks',\n\t'Nu-Breakz',\n\t'Nu-Disco',\n\t'Nu-Funk',\n\t'Nu-Gaze',\n\t'Nu-NRG',\n\t'Nueva cancin',\n\t'Old School Hip Hop',\n\t'Oldies',\n\t'Opera',\n\t'Operatic Pop',\n\t'Orchestral Jazz',\n\t'Original Pilipino Music',\n\t'Other',\n\t'Outlaw Country',\n\t'Outsider House',\n\t'P-Funk',\n\t'Pagan Metal',\n\t'Pagode',\n\t'Paisley Underground',\n\t'Palm-wine',\n\t'Piedmont Blues',\n\t'Pinoy Pop',\n\t'Podcast',\n\t'Political Hip Hop',\n\t'Polka',\n\t'Polsk Punk',\n\t'Pop',\n\t'Pop Punk',\n\t'Pop Rap',\n\t'Pop Rock',\n\t'Pop Soul',\n\t'Pop Sunda',\n\t'Pop-Folk',\n\t'Pop-Funk',\n\t'Porn Groove',\n\t'Porro',\n\t'Post-Bop',\n\t'Post-Disco',\n\t'Post-Grunge',\n\t'Post-Hardcore',\n\t'Post-Metal',\n\t'Post-Punk',\n\t'Post-Punk Revival',\n\t'Post-Rock',\n\t'Power Ballad',\n\t'Power Electronics',\n\t'Power Metal',\n\t'Power Noise',\n\t'Power Pop',\n\t'Powerviolence',\n\t'Pranks',\n\t'Primus',\n\t'Progressive Bluegrass',\n\t'Progressive Country',\n\t'Progressive Folk',\n\t'Progressive House',\n\t'Progressive Metal',\n\t'Progressive Pop',\n\t'Progressive Rock',\n\t'Progressive Trance',\n\t'Protest Song',\n\t'Psybient',\n\t'Psychedelic',\n\t'Psychedelic Folk',\n\t'Psychedelic Pop',\n\t'Psychedelic Rock',\n\t'Psychedelic Trance',\n\t'Psychobilly',\n\t'Punkabilly',\n\t'Psytrance',\n\t'Punk',\n\t'Punk Blues',\n\t'Punk Jazz',\n\t'Punk Rock',\n\t'Punta',\n\t'Punta Rock',\n\t'R&B',\n\t'Raga Rock',\n\t'Ragga',\n\t'Ragga Jungle',\n\t'Raggacore',\n\t'Ragini',\n\t'Ragtime',\n\t'Ra',\n\t'Ranchera',\n\t'Rap',\n\t'Rap Metal',\n\t'Rap Music',\n\t'Rap Opera',\n\t'Rap Rock',\n\t'Rapcore',\n\t'Rara tech',\n\t'Rasin',\n\t'Rave',\n\t'Reactionary Bluegrass',\n\t'Rebetiko',\n\t'Red Dirt',\n\t'Reggae',\n\t'Reggae Espaol',\n\t'Spanish Reggae',\n\t'Reggae Fusion',\n\t'Reggaestep',\n\t'Reggaeton',\n\t'Regional Mexican',\n\t'Retro',\n\t'Revival',\n\t'Rhythm & Blues',\n\t'Rhythmic Soul',\n\t'Riot grrrl',\n\t'Rock',\n\t'Rock & Roll',\n\t'Rock en Espaol',\n\t'Rock in Opposition',\n\t'Rockabilly',\n\t'Rocksteady',\n\t'Rumba',\n\t'Russian Pop',\n\t'Sadcore',\n\t'Sakara',\n\t'Salsa',\n\t'Salsa romntica',\n\t'Samba',\n\t'Samba Rock',\n\t'Sambass',\n\t'Satire',\n\t'Sawt',\n\t'Schlager',\n\t'Screamo',\n\t'Sega',\n\t'Seggae',\n\t'Semba',\n\t'Sertanejo',\n\t'Shangaan electro',\n\t'Shibuya-kei',\n\t'Shoegaze',\n\t'Showtunes',\n\t'Singer-songwriter',\n\t'Ska',\n\t'Ska Jazz',\n\t'Ska Punk',\n\t'Skate Punk',\n\t'Skiffle',\n\t'Skweee',\n\t'Slow Jam',\n\t'Slow Rock',\n\t'Slowcore',\n\t'Sludge Metal',\n\t'Smooth Jazz',\n\t'Snap Music',\n\t'Soca',\n\t'Soft Rock',\n\t'Son',\n\t'Son Cubano',\n\t'Sonata',\n\t'Songo',\n\t'Songo-Salsa',\n\t'Sophisti-Pop',\n\t'Soukous',\n\t'Soul',\n\t'Soul Blues',\n\t'Soul Jazz',\n\t'Sound Clip',\n\t'Soundtrack',\n\t'Southern Hip Hop',\n\t'Southern Rock',\n\t'Southern Soul',\n\t'Space',\n\t'Space Age Pop',\n\t'Space Disco',\n\t'Space Music',\n\t'Space Rock',\n\t'Speech',\n\t'Speed garage',\n\t'Speed Metal',\n\t'Speedcore',\n\t'St.Louis Blues',\n\t'St.Louis Hip Hop',\n\t'Stoner Rock',\n\t'Straight-ahead Jazz',\n\t'Street Punk',\n\t'Stride Jazz',\n\t'Sufi Rock',\n\t'SungPoetry',\n\t'Sunshine Pop',\n\t'Suomisaundi',\n\t'Surf Pop',\n\t'Surf Rock',\n\t'Swamp Blues',\n\t'Swing',\n\t'Symphonic black Metal',\n\t'Symphonic Metal',\n\t'Symphonic Rock',\n\t'Symphony',\n\t'Synthpop',\n\t'SynthPop',\n\t'Synthwave',\n\t'Taarab',\n\t'Tango',\n\t'Tech House',\n\t'Tech Trance',\n\t'Techdombe',\n\t'Technical death Metal',\n\t'Techno',\n\t'Techno-Industrial',\n\t'Techstep',\n\t'Tecno Brega',\n\t'Tecnobrega',\n\t'Teen Pop',\n\t'Tejano',\n\t'Terror',\n\t'Texas Blues',\n\t'Texas Country',\n\t'Thai Pop',\n\t'Third stream',\n\t'Thrash Metal',\n\t'Thrashcore',\n\t'Timba',\n\t'Top 40',\n\t'Trad Jazz',\n\t'Traditional Country Music',\n\t'Traditional Pop Music',\n\t'Trailer',\n\t'Trance',\n\t'Trance Music',\n\t'TRap',\n\t'TRapstep',\n\t'Tribal',\n\t'Tribal House',\n\t'Trip hop',\n\t'Trip-Hop',\n\t'Trival',\n\t'Trop Rock',\n\t'Tropical',\n\t'Tropical House',\n\t'Tropicalia',\n\t'TropiPop',\n\t'Truck-driving Country',\n\t'Turkish Pop',\n\t'Turntablism',\n\t'Twin Cities Hip Hop',\n\t'Twoubadou',\n\t'UK Funky',\n\t'UK Garage',\n\t'UK Hardcore',\n\t'Unblack Metal',\n\t'Underground Hip Hop',\n\t'Uplifting Trance',\n\t'Urban Pasifika',\n\t'V-Pop',\n\t'Vallenato',\n\t'Vaporwave',\n\t'Video game Music',\n\t'Viking Metal',\n\t'VisPop',\n\t'Visual Kei',\n\t'Vocal',\n\t'Vocal Jazz',\n\t'Vocal Trance',\n\t'War Metal',\n\t'Weltmusik',\n\t'West Coast Blues',\n\t'West Coast Hip Hop',\n\t'West Coast Jazz',\n\t'Western swing',\n\t'Witch House',\n\t'Wonky',\n\t'Wonky Pop',\n\t'World Fusion',\n\t'World Music',\n\t'Worldbeat',\n\t'Zouglou',\n\t'Zouk',\n\t'Zouk-Lambada',\n\t'Zydeco'\n];\n\nfunction slugify(genre: string): string {\n\treturn genre.replace(/[& \\-\\.]/g, '').toLowerCase();\n}\n\nexport function getKnownGenre(genre: string): string | undefined {\n\tconst slug = slugify(genre);\n\tif (!GenresSlugs) {\n\t\tGenresSlugs = {};\n\t\tGenres.forEach(g => {\n\t\t\tGenresSlugs[slugify(g)] = g;\n\t\t});\n\t}\n\treturn GenresSlugs[slug];\n}\n\nexport function cleanGenre(genre: string): string {\n\tconst results: Array<string> = [];\n\tconst parts = genre.split('/');\n\tparts.forEach((part: string) => {\n\t\t// test for (number)\n\t\tpart = part.trim();\n\t\tconst numpart = /\\((\\d+)\\)/.exec(part);\n\t\tlet num: number | undefined;\n\t\tif (numpart) {\n\t\t\tnum = parseInt(numpart[1], 10);\n\t\t\tpart = part.slice(0, numpart.index) + part.slice(numpart.index + numpart[0].length);\n\t\t}\n\t\tif (part.length === 0 && (num !== undefined)) {\n\t\t\tconst s = genreByNumbers[num];\n\t\t\tif (s) {\n\t\t\t\tpart = s;\n\t\t\t}\n\t\t}\n\t\tif (part.length > 0) {\n\t\t\tconst slug = slugify(part);\n\t\t\tlet result: string | undefined;\n\t\t\tif (!GenresSlugs) {\n\t\t\t\tGenresSlugs = {};\n\t\t\t\tGenres.forEach(g => {\n\t\t\t\t\tGenresSlugs[slugify(g)] = g;\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (GenresSlugs && GenresSlugs[slug]) {\n\t\t\t\tresult = GenresSlugs[slug];\n\t\t\t}\n\t\t\tif (!result && part.indexOf(' & ') >= 0) {\n\t\t\t\tconst subParts = part.split('&');\n\t\t\t\tsubParts.forEach(sub => {\n\t\t\t\t\tsub = cleanGenre(sub);\n\t\t\t\t\tif (results.indexOf(sub) < 0) {\n\t\t\t\t\t\tresults.push(sub);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (result) {\n\t\t\t\tif (results.indexOf(result) < 0) {\n\t\t\t\t\tresults.push(result);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (results.indexOf(part) < 0) {\n\t\t\t\t\tresults.push(part);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n\treturn results.join(' / ');\n}\n","import {spawnToolJson} from '../../../utils/tool';\n\nexport interface ProbeResult {\n\tformat: {\n\t\tfilename: string;\n\t\tnb_streams: number;\n\t\tnb_programs: number;\n\t\tformat_name: string; // 'mp3',\n\t\tformat_long_name: string; // 'MP2/3 (MPEG audio layer 2/3)',\n\t\tstart_time: string; // '0.000000',\n\t\tduration: string; // '662.499375',\n\t\tsize: string; // '10600329',\n\t\tbit_rate: string; // '128004',\n\t\tprobe_score: number;\n\t\ttags: { [name: string]: string; };\n\t};\n\tframes?: Array<{\n\t\tmedia_type: string; //  'audio',\n\t\tstream_index: number; // 0,\n\t\tkey_frame: number; // 1,\n\t\tpkt_pts: number; // 0,\n\t\tpkt_pts_time: string; //  '0.000000',\n\t\tpkt_dts: number; // 0,\n\t\tpkt_dts_time: string; //  '0.000000',\n\t\tbest_effort_timestamp: number; // 0,\n\t\tbest_effort_timestamp_time: string; //  '0.000000',\n\t\tpkt_duration: number; // 508032,\n\t\tpkt_duration_time: string; //  '0.036000',\n\t\tpkt_pos: string; // '0',\n\t\tpkt_size: string; // '288',\n\t\tsample_fmt: string; //  'fltp',\n\t\tnb_samples: number; // 1152,\n\t\tchannels: number; // 1,\n\t\tchannel_layout: string; //  'mono'\n\t}>;\n\tstreams?: Array<{\n\t\tindex: number;\n\t\twidth: number;\n\t\theight: number;\n\t\tcodec_name: string;\n\t\tcodec_long_name: string;\n\t\tcodec_type: string;\n\t\tcodec_time_base: string; // '1/44100',\n\t\tcodec_tag_string: string; //  '[0][0][0][0]',\n\t\tmode: string;\n\t\tchannels: number;\n\t\tbits_per_sample: number;\n\t\tcodec_tag: string; //  '0x0000',\n\t\tsample_fmt: string; //  'fltp',\n\t\tsample_rate: string; //  '44100',\n\t\tchannel_layout: string; //  'stereo',\n\t\tr_frame_rate: string; // '0/0',\n\t\tavg_frame_rate: string; // '0/0',\n\t\ttime_base: string; // '1/14112000',\n\t\tnb_read_frames: string; // \"10020\";\n\t\tstart_pts: number;\n\t\tstart_time: string;\n\t\tduration_ts: number;\n\t\tduration: string;\n\t\tbit_rate: string;\n\t\tdisposition?: {\n\t\t\tdefault: number;\n\t\t\tdub: number;\n\t\t\toriginal: number;\n\t\t\tcomment: number;\n\t\t\tlyrics: number;\n\t\t\tkaraoke: number;\n\t\t\tforced: number;\n\t\t\thearing_impaired: number;\n\t\t\tvisual_impaired: number;\n\t\t\tclean_effects: number;\n\t\t\tattached_pic: number;\n\t\t\ttimed_thumbnails: number;\n\t\t};\n\t\tside_data_list?: Array<{\n\t\t\tside_data_type: string; // 'Replay Gain'\n\t\t}>;\n\t}>;\n}\n\nexport async function probe(filename: string, cmds: Array<string>): Promise<ProbeResult> {\n\treturn spawnToolJson<ProbeResult>('ffprobe', 'FFPROBE_PATH', ['-print_format', 'json', '-show_error', '-show_streams', '-show_format', ...cmds, filename]);\n}\n","module.exports = require(\"jamp3/dist/lib/id3v1/id3v1_consts\");","import {WebserviceClient} from '../../../utils/webservice-client';\nimport Logger from '../../../utils/logger';\nimport {AcousticBrainz} from '../../../model/acousticbrainz-rest-data';\n\nconst log = Logger('AcousticBrainz');\n\ndeclare namespace AcousticbrainzClientApi {\n\n\texport interface Request {\n\t\tpath: string;\n\t\tquery: { [name: string]: string | undefined };\n\t\tretry: number;\n\t}\n\n\texport interface Options {\n\t\thost?: string;\n\t\tport?: number;\n\t\tbasePath?: string;\n\t\tuserAgent: string;\n\t\tretryOn?: boolean;\n\t\tretryDelay?: number;\n\t\tretryCount?: number;\n\t}\n\n}\n\nexport class AcousticbrainzClient extends WebserviceClient {\n\toptions = {\n\t\thost: 'https://acousticbrainz.org',\n\t\tport: 80,\n\t\tbasePath: '/api/v1/',\n\t\tuserAgent: '',\n\t\tretryOn: false,\n\t\tretryDelay: 3000,\n\t\tretryCount: 3\n\t};\n\n\tconstructor(options: AcousticbrainzClientApi.Options) {\n\t\t// unknown rate limit, using same from musicbrainz https://musicbrainz.org/doc/XML_Web_Service/Rate_Limiting \"Currently that rate is (on average) 1 request per second. (per ip)\"\n\t\tsuper(1, 1000, options.userAgent);\n\t\tthis.options = Object.assign({}, this.options, options);\n\t}\n\n\tasync highLevel(mbid: string, nr?: number): Promise<AcousticBrainz.Response> {\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + mbid + '/high-level',\n\t\t\tquery: {\n\t\t\t\tn: (nr !== undefined ? nr.toString() : undefined)\n\t\t\t},\n\t\t\tretry: 0\n\t\t});\n\t\treturn data;\n\t}\n\n\tprivate async get(req: AcousticbrainzClientApi.Request): Promise<any> {\n\t\tconst q = Object.keys(req.query)\n\t\t\t.filter(key => (req.query[key] !== undefined && req.query[key] !== null))\n\t\t\t.map(key => key + '=' + req.query[key]);\n\t\tconst url = this.options.host + (this.options.port !== 80 ? ':' + this.options.port : '') + req.path + '?' + q.join('&');\n\n\t\tconst isRateLimitError = (body: any): boolean => {\n\t\t\treturn (body && body.error && body.error.indexOf('allowable rate limit') >= 0);\n\t\t\t// \"error\":\"Your requests are exceeding the allowable rate limit. Please see http://wiki.musicbrainz.org/XMLWebService for more information.\"\n\t\t};\n\t\tconst options = this.options;\n\t\tconst get = this.get;\n\n\t\tasync function retry(error: Error): Promise<any> {\n\t\t\tif (options.retryOn && req.retry < options.retryCount) {\n\t\t\t\treq.retry++;\n\t\t\t\tlog.info('rate limit hit, retrying in ' + options.retryDelay + 'ms');\n\t\t\t\treturn new Promise<any>((resolve, reject) => {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tget(req).then(resolve).catch(reject);\n\t\t\t\t\t}, options.retryDelay);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(error);\n\t\t\t}\n\t\t}\n\n\t\tlog.info('requesting', JSON.stringify(req));\n\t\ttry {\n\t\t\tconst data = await this.getJson<any>(url, undefined);\n\t\t\tif (isRateLimitError(data)) {\n\t\t\t\treturn retry(Error(data.error));\n\t\t\t}\n\t\t\treturn data;\n\t\t} catch (e) {\n\t\t\tconst statusCode = e.statusCode;\n\t\t\tif (statusCode === 502 || statusCode === 503) {\n\t\t\t\treturn retry(e);\n\t\t\t} else {\n\t\t\t\tlog.error(e);\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n\n}\n","import {WebserviceClient} from '../../../utils/webservice-client';\nimport Logger from '../../../utils/logger';\nimport {CoverArtArchive} from '../../../model/coverartarchive-rest-data';\n\nconst log = Logger('CoverArtArchive');\n\ndeclare namespace CoverArtArchiveClientApi {\n\n\texport interface Request {\n\t\tpath: string;\n\t\tquery: { [name: string]: string | undefined };\n\t\tretry: number;\n\t}\n\n\texport interface Options {\n\t\thost?: string;\n\t\tport?: number;\n\t\tbasePath?: string;\n\t\tuserAgent: string;\n\t\tretryOn?: boolean;\n\t\tretryDelay?: number;\n\t\tretryCount?: number;\n\t}\n\n}\n\nexport class CoverArtArchiveClient extends WebserviceClient {\n\toptions = {\n\t\thost: 'https://coverartarchive.org',\n\t\tport: 80,\n\t\tbasePath: '/',\n\t\tuserAgent: '',\n\t\tlimit: 25,\n\t\tretryOn: false,\n\t\tretryDelay: 3000,\n\t\tretryCount: 3\n\t};\n\n\tconstructor(options: CoverArtArchiveClientApi.Options) {\n\t\t// https://musicbrainz.org/doc/Cover_Art_Archive/API#Rate_limiting_rules\n\t\t// there are currently no rate limiting rules in place at http://coverartarchive.org.\n\n\t\t// nevertheless, we limit this to 10 per second\n\t\tsuper(10, 1000, options.userAgent);\n\t\tthis.options = Object.assign({}, this.options, options);\n\t}\n\n\tasync releaseImages(mbid: string): Promise<CoverArtArchive.Response> {\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + 'release/' + mbid + '/',\n\t\t\tquery: {},\n\t\t\tretry: 0\n\t\t});\n\t\treturn data;\n\t}\n\n\tasync releaseGroupImages(mbid: string): Promise<CoverArtArchive.Response> {\n\t\tconst data = await this.get({\n\t\t\tpath: this.options.basePath + 'release-group/' + mbid + '/',\n\t\t\tquery: {},\n\t\t\tretry: 0\n\t\t});\n\t\treturn data;\n\t}\n\n\tprivate async get(req: CoverArtArchiveClientApi.Request): Promise<CoverArtArchive.Response> {\n\t\tconst q = Object.keys(req.query)\n\t\t\t.filter(key => (req.query[key] !== undefined && req.query[key] !== null))\n\t\t\t.map(key => key + '=' + req.query[key]);\n\t\tconst url = this.options.host + (this.options.port !== 80 ? ':' + this.options.port : '') + req.path + '?' + q.join('&');\n\n\t\tconst isRateLimitError = (body: any): boolean => {\n\t\t\treturn (body && body.error && body.error.indexOf('allowable rate limit') >= 0);\n\t\t};\n\t\tconst options = this.options;\n\t\tconst get = this.get;\n\n\t\tasync function retry(error: Error): Promise<any> {\n\t\t\tif (options.retryOn && req.retry < options.retryCount) {\n\t\t\t\treq.retry++;\n\t\t\t\tlog.info('rate limit hit, retrying in ' + options.retryDelay + 'ms');\n\t\t\t\treturn new Promise<any>((resolve, reject) => {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tget(req).then(resolve).catch(reject);\n\t\t\t\t\t}, options.retryDelay);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(error);\n\t\t\t}\n\t\t}\n\n\t\tlog.info('requesting', JSON.stringify(req));\n\t\ttry {\n\t\t\tconst data = await this.getJson<any>(url, undefined);\n\t\t\tif (isRateLimitError(data)) {\n\t\t\t\treturn retry(Error(data.error));\n\t\t\t}\n\t\t\treturn data;\n\t\t} catch (e) {\n\t\t\tif (e instanceof SyntaxError) {\n\t\t\t\t// coverartarchive response is html on empty data\n\t\t\t\t// <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\">\n\t\t\t\t// <title>404 Not Found</title>\n\t\t\t\t// <h1>Not Found</h1>\n\t\t\t\t// <p>No cover art found for release {{mbid}}</p>\n\t\t\t\t// */\n\t\t\t\treturn Promise.resolve({images: []});\n\t\t\t}\n\t\t\tconst statusCode = e.statusCode;\n\t\t\tif (statusCode === 502 || statusCode === 503) {\n\t\t\t\treturn retry(e);\n\t\t\t} else {\n\t\t\t\tlog.error(e);\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t}\n\t}\n\n}\n","import {WebserviceClient} from '../../../utils/webservice-client';\nimport Logger from '../../../utils/logger';\n\nconst log = Logger('Wikipedia');\n\nexport declare namespace WikiData {\n\n\texport interface SiteLink {\n\t\tsite: string;\n\t\ttitle: string;\n\t\tbadges: Array<string>;\n\t}\n\n\texport interface Entity {\n\t\ttype: string;\n\t\tid: string;\n\t\tsitelinks: {\n\t\t\t[name: string]: SiteLink;\n\t\t};\n\t}\n\n\texport interface Response {\n\t\tentities: {\n\t\t\t[id: string]: Entity;\n\t\t};\n\t}\n\n}\n\n\nexport declare namespace Wikipedia {\n\n\texport interface Summary {\n\t\ttype: string;\n\t\ttitle: string;\n\t\tdisplaytitle: string;\n\t\tnamespace: {\n\t\t\tid: number;\n\t\t\ttext: string;\n\t\t},\n\t\twikibase_item: string;\n\t\ttitles: {\n\t\t\tcanonical: string;\n\t\t\tnormalized: string;\n\t\t\tdisplay: string;\n\t\t},\n\t\tpageid: number;\n\t\tthumbnail: {\n\t\t\tsource: string;\n\t\t\twidth: number;\n\t\t\theight: number;\n\t\t},\n\t\toriginalimage: {\n\t\t\tsource: string;\n\t\t\twidth: number;\n\t\t\theight: number;\n\t\t},\n\t\tlang: string;\n\t\tdir: string;\n\t\trevision: string;\n\t\ttid: string;\n\t\ttimestamp: string;\n\t\tdescription: string;\n\t\tcontent_urls: {\n\t\t\tdesktop: {\n\t\t\t\tpage: string;\n\t\t\t\trevisions: string;\n\t\t\t\tedit: string;\n\t\t\t\ttalk: string;\n\t\t\t},\n\t\t\tmobile: {\n\t\t\t\tpage: string;\n\t\t\t\trevisions: string;\n\t\t\t\tedit: string;\n\t\t\t\ttalk: string;\n\t\t\t}\n\t\t},\n\t\tapi_urls: {\n\t\t\tsummary: string;\n\t\t\tmetadata: string;\n\t\t\treferences: string;\n\t\t\tmedia: string;\n\t\t\tedit_html: string;\n\t\t\ttalk_page_html: string;\n\t\t},\n\t\textract: string;\n\t\textract_html: string;\n\t}\n\n\texport interface Response {\n\t\tsummary?: Summary;\n\t}\n\n}\n\nexport declare namespace WikiPHPApi {\n\n\texport interface Page {\n\t\tpageid: number;\n\t\tns: number;\n\t\ttitle: string;\n\t\textract: string;\n\t}\n\n\texport interface Summary {\n\t\tbatchcomplete: string;\n\t\twarnings?: {\n\t\t\textracts?: {\n\t\t\t\t[id: string]: string;\n\t\t\t}\n\t\t};\n\t\tquery: {\n\t\t\tpages: {\n\t\t\t\t[name: string]: Page;\n\t\t\t};\n\t\t};\n\t}\n\n}\n\n\nexport class WikipediaClient extends WebserviceClient {\n\n\tconstructor(userAgent: string) {\n\t\t// \"no more than 200 requests/s to this API\" https://en.wikipedia.org/api/rest_v1/#!/Page_content/get_page_summary_title\n\t\tsuper(200, 1000, userAgent);\n\t}\n\n\tasync summary(title: string, lang: string | undefined): Promise<{ title: string, url: string, summary: string } | undefined> {\n\t\tlog.info('requesting summary', title);\n\t\tconst url = `https://${(lang || 'en')}.wikipedia.org/w/api.php`;\n\t\tconst data: WikiPHPApi.Summary = await this.getJson<WikiPHPApi.Summary>(url, {\n\t\t\taction: 'query',\n\t\t\tprop: 'extracts',\n\t\t\tformat: 'json',\n\t\t\texintro: 1,\n\t\t\tredirects: 1,\n\t\t\ttitles: title\n\t\t});\n\t\tif (!data || !data.query || !data.query.pages) {\n\t\t\treturn;\n\t\t}\n\t\tconst pages = data.query.pages;\n\t\tconst page = pages[Object.keys(pages)[0]];\n\t\tif (!page) {\n\t\t\treturn;\n\t\t}\n\t\treturn {title: page.title, summary: page.extract, url: `https://${(lang || 'en')}.wikipedia.org/wiki/${encodeURIComponent(page.title)}`};\n\t}\n\n\n\tasync summary_rest(title: string, lang: string | undefined): Promise<string | undefined> {\n\t\tlog.info('requesting summary', title);\n\t\tconst url = `https://${(lang || 'en')}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;\n\t\tconst data: Wikipedia.Summary = await this.getJson<Wikipedia.Summary>(url, {redirect: 'true'});\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\t\treturn data.extract_html;\n\t}\n\n\tasync wikidata(id: string):\n\t\tPromise<WikiData.Entity | undefined> {\n\t\tlog.info('requesting wikidata enttity', id);\n\t\tconst url = `https://www.wikidata.org/w/api.php?action=wbgetentities&format=json&props=sitelinks&ids=${(id)}`;\n\t\tconst data = await this.getJson<WikiData.Response>(url, {});\n\t\tif (!data || !data.entities) {\n\t\t\treturn;\n\t\t}\n\t\treturn data.entities[id];\n\t}\n}\n","import path from 'path';\nimport {ArtistIndex, ArtistIndexEntry, FolderIndex, FolderIndexEntry, Indexes} from './index.model';\nimport {Folder} from '../../objects/folder/folder.model';\nimport {ArtistStore} from '../../objects/artist/artist.store';\nimport {FolderStore} from '../../objects/folder/folder.store';\nimport {TrackStore} from '../../objects/track/track.store';\nimport {AlbumType} from '../../model/jam-types';\nimport {DebouncePromises} from '../../utils/debounce-promises';\nimport Logger from '../../utils/logger';\nimport {Jam} from '../../model/jam-rest-data';\n\nconst log = Logger('IndexService');\n\nexport class IndexTreeBuilder {\n\tprivate ignore: string;\n\n\tconstructor(indexConfig: Jam.AdminSettingsIndex, private artistStore: ArtistStore, private folderStore: FolderStore, private trackStore: TrackStore) {\n\t\tthis.ignore = indexConfig.ignoreArticles.join('|');\n\t}\n\n\tremoveArticles(name: string): string {\n\t\t// /^(?:(?:the|los|les)\\s+)?(.*)/gi\n\t\tconst matches = new RegExp('^(?:(?:' + this.ignore + ')\\\\s+)?(.*)', 'gi').exec(name);\n\t\treturn matches ? matches[1] : name;\n\t}\n\n\tgetIndexChar(name: string, sortname?: string): string {\n\t\tconst c = (sortname || this.removeArticles(name) || '').trim().toUpperCase().charAt(0);\n\t\tconst regex_symbols = /[-!$%^&*()_+|~=`{}\\[\\]:\\/;<>?,.@#\\d]/;\n\t\tif (c.match(regex_symbols) === null) {\n\t\t\treturn c;\n\t\t}\n\t\treturn '#';\n\t}\n\n\tasync buildArtistIndex(): Promise<ArtistIndex> {\n\t\tconst result: ArtistIndex = {groups: [], lastModified: Date.now()};\n\t\tconst artists = await this.artistStore.search({albumType: AlbumType.album});\n\t\tartists.forEach(artist => {\n\t\t\tconst entry: ArtistIndexEntry = {artist};\n\t\t\tconst indexChar = this.getIndexChar(artist.name, artist.nameSort);\n\t\t\tlet group = result.groups.find(g => g.name === indexChar);\n\t\t\tif (!group) {\n\t\t\t\tgroup = {name: indexChar, entries: []};\n\t\t\t\tresult.groups.push(group);\n\t\t\t}\n\t\t\tgroup.entries.push(entry);\n\t\t});\n\t\tresult.groups.forEach(group => {\n\t\t\tgroup.entries.sort((a, b) => {\n\t\t\t\treturn a.artist.name.localeCompare(b.artist.name);\n\t\t\t});\n\t\t});\n\t\tresult.groups.sort((a, b) => {\n\t\t\treturn a.name.localeCompare(b.name);\n\t\t});\n\t\treturn result;\n\t}\n\n\tprivate async getTotalTrackCount(folder: Folder): Promise<number> {\n\t\treturn this.trackStore.searchCount({inPath: folder.path});\n\t}\n\n\tasync buildFolderIndex(): Promise<FolderIndex> {\n\t\tconst result: FolderIndex = {groups: [], lastModified: Date.now()};\n\t\tconst folders = await this.folderStore.search({level: 1});\n\t\tfor (const folder of folders) {\n\t\t\tconst trackCount = await this.getTotalTrackCount(folder);\n\t\t\tconst entry: FolderIndexEntry = {\n\t\t\t\tname: path.basename(folder.path),\n\t\t\t\tnameSort: folder.tag.artistSort || this.removeArticles(path.basename(folder.path)),\n\t\t\t\ttrackCount: trackCount || 0,\n\t\t\t\tfolder\n\t\t\t};\n\t\t\tconst indexChar = this.getIndexChar(entry.name, entry.nameSort);\n\t\t\tlet group = result.groups.find(g => g.name === indexChar);\n\t\t\tif (!group) {\n\t\t\t\tgroup = {name: indexChar, entries: []};\n\t\t\t\tresult.groups.push(group);\n\t\t\t}\n\t\t\tgroup.entries.push(entry);\n\t\t}\n\t\tresult.groups.forEach(group => {\n\t\t\tgroup.entries.sort((a, b) => {\n\t\t\t\treturn a.nameSort.localeCompare(b.nameSort);\n\t\t\t});\n\t\t});\n\t\tresult.groups.sort((a, b) => {\n\t\t\treturn a.name.localeCompare(b.name);\n\t\t});\n\t\treturn result;\n\t}\n\n\tasync buildIndexes(): Promise<Indexes> {\n\t\tconst folderIndex = await this.buildFolderIndex();\n\t\tconst artistIndex = await this.buildArtistIndex();\n\t\treturn {folderIndex, artistIndex};\n\t}\n}\n\nexport class IndexService {\n\tprivate cached?: Indexes;\n\tprivate indexCacheDebounce = new DebouncePromises<Indexes>();\n\tpublic indexConfig: Jam.AdminSettingsIndex = {ignoreArticles: []};\n\n\tconstructor(private artistStore: ArtistStore, private folderStore: FolderStore, private trackStore: TrackStore) {\n\t}\n\n\tpublic setSettings(indexConfig: Jam.AdminSettingsIndex) {\n\t\tthis.indexConfig = indexConfig;\n\t\tif (this.cached) {\n\t\t\tthis.cached = undefined;\n\t\t}\n\t}\n\n\tasync buildIndexes(): Promise<Indexes> {\n\t\tlog.debug('Building Indexes');\n\t\tconst builder = new IndexTreeBuilder(this.indexConfig, this.artistStore, this.folderStore, this.trackStore);\n\t\tthis.cached = await builder.buildIndexes();\n\t\treturn this.cached;\n\t}\n\n\tasync getIndexes(): Promise<Indexes> {\n\t\tif (this.cached) {\n\t\t\treturn this.cached;\n\t\t}\n\t\tconst cacheID = 'index';\n\t\tif (this.indexCacheDebounce.isPending(cacheID)) {\n\t\t\treturn this.indexCacheDebounce.append(cacheID);\n\t\t}\n\t\tthis.indexCacheDebounce.setPending(cacheID);\n\t\ttry {\n\t\t\tconst result = await this.buildIndexes();\n\t\t\tawait this.indexCacheDebounce.resolve(cacheID, result);\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tawait this.indexCacheDebounce.reject(cacheID, e);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync getFolderIndex(): Promise<FolderIndex> {\n\t\tconst indexes = await this.getIndexes();\n\t\treturn indexes.folderIndex;\n\t}\n\n\tasync getArtistIndex(): Promise<ArtistIndex> {\n\t\tconst indexes = await this.getIndexes();\n\t\treturn indexes.artistIndex;\n\t}\n\n\tfilterFolderIndex(rootID: string | undefined, folderIndex: FolderIndex): FolderIndex {\n\t\tif (!rootID) {\n\t\t\treturn folderIndex;\n\t\t}\n\t\treturn {\n\t\t\tlastModified: folderIndex.lastModified,\n\t\t\tgroups: folderIndex.groups.map(group => {\n\t\t\t\treturn {\n\t\t\t\t\tname: group.name,\n\t\t\t\t\tentries: group.entries.filter(entry => entry.folder.rootID === rootID)\n\t\t\t\t};\n\t\t\t}).filter(group => group.entries.length > 0)\n\t\t};\n\t}\n\n\tfilterArtistIndex(rootID: string | undefined, artistIndex: ArtistIndex): ArtistIndex {\n\t\tif (!rootID) {\n\t\t\treturn artistIndex;\n\t\t}\n\t\treturn {\n\t\t\tlastModified: artistIndex.lastModified,\n\t\t\tgroups: artistIndex.groups.map(group => {\n\t\t\t\treturn {\n\t\t\t\t\tname: group.name,\n\t\t\t\t\tentries: group.entries.filter(entry => entry.artist.rootIDs.indexOf(rootID) >= 0)\n\t\t\t\t};\n\t\t\t}).filter(group => group.entries.length > 0)\n\t\t};\n\t}\n\n}\n","import {FolderType, LastFMLookupType, MusicBrainzLookupType, MusicBrainzSearchType} from '../../model/jam-types';\nimport {AudioModule} from '../../modules/audio/audio.module';\nimport {shuffle} from '../../utils/random';\nimport {MetaData} from './metadata.model';\nimport {Folder} from '../folder/folder.model';\nimport {Artist} from '../artist/artist.model';\nimport {Album} from '../album/album.model';\nimport {Track} from '../track/track.model';\nimport {ArtistStore} from '../artist/artist.store';\nimport {AlbumStore} from '../album/album.store';\nimport {TrackStore} from '../track/track.store';\nimport {FolderStore} from '../folder/folder.store';\nimport {BaseStoreService} from '../base/base.service';\nimport {MetaDataStore, SearchQueryMetaData} from './metadata.store';\nimport {MusicbrainzClientApi} from '../../modules/audio/clients/musicbrainz-client.interface';\nimport {MusicBrainz} from '../../model/musicbrainz-rest-data';\nimport {MetaDataType} from './metadata.types';\nimport {DBObjectType} from '../../db/db.types';\nimport {Acoustid} from '../../model/acoustid-rest-data';\nimport path from 'path';\nimport {LastFM} from '../../model/lastfm-rest-data';\nimport {CoverArtArchive} from '../../model/coverartarchive-rest-data';\nimport {AcousticBrainz} from '../../model/acousticbrainz-rest-data';\nimport {Jam} from '../../model/jam-rest-data';\n\nfunction stripInlineLastFM(content: string): string {\n\treturn (content || '').replace(/<a href=\".*\">Read more on Last\\.fm<\\/a>\\.?/g, '')\n\t\t.replace(/<a .* href=\".*\">Read more on Last\\.fm<\\/a>\\.?/g, '')\n\t\t.replace('User-contributed text is available under the Creative Commons By-SA License; additional terms may apply.', '');\n}\n\nfunction stripInlineWikipediaHTML(content: string): string {\n\treturn (content || '')\n\t\t.replace(/<p class=\"mw-empty-elt\">\\s*<\\/p>/g, '')\n\t\t.replace(/<p>/g, '')\n\t\t.replace(/<\\/p>/g, '\\n');\n}\n\ninterface SimilarArtist {\n\tname: string;\n\turl: string;\n\tmbid: string;\n}\n\ninterface Song {\n\tname: string;\n\tartist: string;\n\tmbid: string;\n\turl: string;\n}\n\nexport class MetaDataService extends BaseStoreService<MetaData, SearchQueryMetaData> {\n\n\tconstructor(private metadataStore: MetaDataStore, private folderStore: FolderStore, private trackStore: TrackStore, private albumStore: AlbumStore, private artistStore: ArtistStore, private audioModule: AudioModule) {\n\t\tsuper(metadataStore);\n\t}\n\n\tprivate async getMusicBrainzIDWikipediaArtistInfo(mbArtistID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst result = await this.musicbrainzLookup(MusicBrainzLookupType.artist, mbArtistID);\n\t\tif (result && result.artist && result.artist.relations) {\n\t\t\tlet rel = result.artist.relations.find(r => r.type === 'wikidata');\n\t\t\tif (rel && rel.url && rel.url.resource) {\n\t\t\t\tconst list = rel.url.resource.split('/');\n\t\t\t\tconst id = list[list.length - 1];\n\t\t\t\tconst wiki = await this.wikidataSummary(id, 'en');\n\t\t\t\tif (wiki && wiki.summary) {\n\t\t\t\t\tconst info: Jam.ExtendedInfo = {\n\t\t\t\t\t\turl: wiki.summary.url,\n\t\t\t\t\t\tdescription: stripInlineWikipediaHTML(wiki.summary.summary),\n\t\t\t\t\t\tsource: 'Wikipedia',\n\t\t\t\t\t\tlicense: 'Creative Commons BY-SA license',\n\t\t\t\t\t\tlicenseUrl: 'https://creativecommons.org/licenses/by-sa/3.0/'\n\t\t\t\t\t};\n\t\t\t\t\treturn info;\n\t\t\t\t}\n\t\t\t}\n\t\t\trel = result.artist.relations.find(r => r.type === 'wikipedia');\n\t\t\tif (rel && rel.url && rel.url.resource) {\n\t\t\t\tconst list = rel.url.resource.split('/');\n\t\t\t\tconst title = list[list.length - 1];\n\t\t\t\tconst lang = list[2].split('.')[0];\n\t\t\t\tconst wiki = await this.wikipediaSummary(title, lang);\n\t\t\t\tif (wiki && wiki.summary) {\n\t\t\t\t\tconst info: Jam.ExtendedInfo = {\n\t\t\t\t\t\turl: wiki.summary.url,\n\t\t\t\t\t\tdescription: stripInlineWikipediaHTML(wiki.summary.summary),\n\t\t\t\t\t\tsource: 'Wikipedia',\n\t\t\t\t\t\tlicense: 'Creative Commons BY-SA license',\n\t\t\t\t\t\tlicenseUrl: 'https://creativecommons.org/licenses/by-sa/3.0/'\n\t\t\t\t\t};\n\t\t\t\t\treturn info;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getMusicBrainzIDWikipediaAlbumInfo(mbReleaseID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst result = await this.musicbrainzLookup(MusicBrainzLookupType.release, mbReleaseID);\n\t\tif (result && result.release && result.release.relations) {\n\t\t\tconst rel = result.release.relations.find(r => r.type === 'wikidata');\n\t\t\tif (rel && rel.url && rel.url.resource) {\n\t\t\t\tconst list = rel.url.resource.split('/');\n\t\t\t\tconst id = list[list.length - 1];\n\t\t\t\tconst wiki = await this.wikidataSummary(id, 'en');\n\t\t\t\tif (wiki && wiki.summary) {\n\t\t\t\t\tconst info: Jam.ExtendedInfo = {\n\t\t\t\t\t\turl: wiki.summary.url,\n\t\t\t\t\t\tdescription: stripInlineWikipediaHTML(wiki.summary.summary),\n\t\t\t\t\t\tsource: 'Wikipedia',\n\t\t\t\t\t\tlicense: 'Creative Commons BY-SA license',\n\t\t\t\t\t\tlicenseUrl: 'https://creativecommons.org/licenses/by-sa/3.0/'\n\t\t\t\t\t};\n\t\t\t\t\treturn info;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getLastFMArtistInfo(mbArtistID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst result = await this.lastFMLookup(LastFMLookupType.artist, mbArtistID);\n\t\tif (result && result.artist && result.artist.bio && result.artist.bio.content) {\n\t\t\tconst info: Jam.ExtendedInfo = {\n\t\t\t\turl: result.artist.url,\n\t\t\t\tdescription: stripInlineLastFM(result.artist.bio.content),\n\t\t\t\tsource: 'LastFM',\n\t\t\t\tlicense: 'Creative Commons BY-SA license',\n\t\t\t\tlicenseUrl: 'https://creativecommons.org/licenses/by-sa/3.0/'\n\t\t\t};\n\t\t\treturn info;\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getLastFMAlbumInfo(mbReleaseID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst result = await this.lastFMLookup(LastFMLookupType.album, mbReleaseID);\n\t\tif (result && result.album && result.album.wiki && result.album.wiki.content) {\n\t\t\tconst info: Jam.ExtendedInfo = {\n\t\t\t\turl: result.album.url,\n\t\t\t\tdescription: stripInlineLastFM(result.album.wiki.content),\n\t\t\t\tsource: 'LastFM',\n\t\t\t\tlicense: 'Creative Commons BY-SA license',\n\t\t\t\tlicenseUrl: 'https://creativecommons.org/licenses/by-sa/3.0/'\n\t\t\t};\n\t\t\treturn info;\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getArtistInfoByMusicBrainzID(mbArtistID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tlet info = await this.getMusicBrainzIDWikipediaArtistInfo(mbArtistID);\n\t\tif (info) {\n\t\t\treturn info;\n\t\t}\n\t\tinfo = await this.getLastFMArtistInfo(mbArtistID);\n\t\tif (info) {\n\t\t\treturn info;\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getAlbumInfoByMusicBrainzID(mbReleaseID: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tlet info = await this.getMusicBrainzIDWikipediaAlbumInfo(mbReleaseID);\n\t\tif (info) {\n\t\t\treturn info;\n\t\t}\n\t\tinfo = await this.getLastFMAlbumInfo(mbReleaseID);\n\t\tif (info) {\n\t\t\treturn info;\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getArtistInfoByName(artistName: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst res = await this.musicbrainzSearch(MusicBrainzSearchType.artist, {artist: artistName});\n\t\tif (res && res.artists && res.artists.length === 1) {\n\t\t\tconst info = await this.getArtistInfoByMusicBrainzID(res.artists[0].id);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tconst lastfm = await this.lastFMArtistSearch(artistName);\n\t\tif (lastfm && lastfm.artist && lastfm.artist.mbid) {\n\t\t\tconst info = await this.getArtistInfoByMusicBrainzID(lastfm.artist.mbid);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate async getAlbumInfoByName(albumName: string, artistName: string): Promise<Jam.ExtendedInfo | undefined> {\n\t\tconst res = await this.musicbrainzSearch(MusicBrainzSearchType.release, {release: albumName, artist: artistName});\n\t\tif (res && res.releases && res.releases.length > 1) {\n\t\t\tconst info = await this.getAlbumInfoByMusicBrainzID(res.releases[0].id);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tconst lastfm = await this.lastFMAlbumSearch(albumName, artistName);\n\t\tif (lastfm && lastfm.album && lastfm.album.mbid) {\n\t\t\tconst info = await this.getAlbumInfoByMusicBrainzID(lastfm.album.mbid);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\t// ExtendedInfos\n\n\tasync getArtistInfo(artist: Artist): Promise<Jam.ExtendedInfo | undefined> {\n\t\tif (artist.mbArtistID) {\n\t\t\tconst info = await this.getArtistInfoByMusicBrainzID(artist.mbArtistID);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tif (artist.name) {\n\t\t\tconst info = await this.getArtistInfoByName(artist.name);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tasync getAlbumInfo(album: Album): Promise<Jam.ExtendedInfo | undefined> {\n\t\tif (album.mbAlbumID) {\n\t\t\tconst info = await this.getAlbumInfoByMusicBrainzID(album.mbAlbumID);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tif (album.name && album.artist) {\n\t\t\tconst info = await this.getAlbumInfoByName(album.name, album.artist);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tasync getFolderArtistInfo(folder: Folder): Promise<Jam.ExtendedInfo | undefined> {\n\t\tif (folder.tag.mbArtistID) {\n\t\t\tconst info = await this.getArtistInfoByMusicBrainzID(folder.tag.mbArtistID);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tif (folder.tag.artist) {\n\t\t\tconst info = await this.getArtistInfoByName(folder.tag.artist);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tasync getFolderAlbumInfo(folder: Folder): Promise<Jam.ExtendedInfo | undefined> {\n\t\tif (folder.tag.mbAlbumID) {\n\t\t\tconst info = await this.getAlbumInfoByMusicBrainzID(folder.tag.mbAlbumID);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\tif (folder.tag.album && folder.tag.artist) {\n\t\t\tconst info = await this.getAlbumInfoByName(folder.tag.album, folder.tag.artist);\n\t\t\tif (info) {\n\t\t\t\treturn info;\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\t// similar artists\n\n\tprivate async getLastFMSimilarArtists(mbArtistID: string): Promise<Array<SimilarArtist>> {\n\t\tconst lastfm = await this.lastFMLookup(LastFMLookupType.artist, mbArtistID);\n\t\tif (lastfm && lastfm.artist && lastfm.artist.similar && lastfm.artist.similar.artist) {\n\t\t\treturn lastfm.artist.similar.artist;\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate async findSimilarArtistFolders(similarArtists: Array<SimilarArtist>): Promise<Array<Folder>> {\n\t\tconst names: Array<string> = [];\n\t\tsimilarArtists.forEach(a => {\n\t\t\tif (a.name) {\n\t\t\t\tnames.push(a.name);\n\t\t\t}\n\t\t});\n\t\treturn await this.folderStore.search({types: [FolderType.artist], artists: names});\n\t}\n\n\tprivate async findSimilarArtists(similarArtists: Array<SimilarArtist>): Promise<Array<Artist>> {\n\t\tconst names: Array<string> = [];\n\t\tsimilarArtists.forEach(a => {\n\t\t\tif (a.name) {\n\t\t\t\tnames.push(a.name);\n\t\t\t}\n\t\t});\n\t\treturn await this.artistStore.search({names});\n\t}\n\n\tprivate async getSimilarArtistsInfo(mbArtistID?: string, artist?: string): Promise<Array<SimilarArtist>> {\n\t\tlet similar: Array<SimilarArtist> = [];\n\t\tif (mbArtistID) {\n\t\t\tsimilar = await this.getLastFMSimilarArtists(mbArtistID);\n\t\t} else if (artist) {\n\t\t\tconst a = await this.lastFMArtistSearch(artist);\n\t\t\tif (a && a.artist) {\n\t\t\t\tsimilar = await this.getLastFMSimilarArtists(a.artist.mbid);\n\t\t\t}\n\t\t}\n\t\treturn similar;\n\t}\n\n\tasync getSimilarArtists(artist: Artist): Promise<Array<Artist>> {\n\t\tconst similar = await this.getSimilarArtistsInfo(artist.mbArtistID, artist.name);\n\t\tif (similar && similar.length > 0) {\n\t\t\treturn this.findSimilarArtists(similar);\n\t\t}\n\t\treturn [];\n\t}\n\n\tasync getSimilarArtistFolders(folder: Folder): Promise<Array<Folder>> {\n\t\tconst similar = await this.getSimilarArtistsInfo(folder.tag.mbArtistID, folder.tag.artist);\n\t\tif (similar && similar.length > 0) {\n\t\t\treturn this.findSimilarArtistFolders(similar);\n\t\t}\n\t\treturn [];\n\t}\n\n\t// similar tracks\n\n\tprivate async findSimilarTracks(songs: Array<Song>): Promise<Array<Track>> {\n\t\tconst ids: Array<Song> = [];\n\t\tconst vals: Array<Song> = [];\n\t\tconst result: Array<Track> = [];\n\t\tsongs.forEach(sim => {\n\t\t\tif (sim.mbid) {\n\t\t\t\tids.push(sim);\n\t\t\t} else {\n\t\t\t\tvals.push(sim);\n\t\t\t}\n\t\t});\n\t\tconst mbTrackIDs = ids.map(track => track.mbid || '-').filter(id => id !== '-');\n\t\tconst tracks = await this.trackStore.search({mbTrackIDs});\n\t\tids.forEach(sim => {\n\t\t\tconst t = tracks.find(tr => tr.tag.mbTrackID === sim.mbid);\n\t\t\tif (!t) {\n\t\t\t\tvals.push(sim);\n\t\t\t} else {\n\t\t\t\tresult.push(t);\n\t\t\t}\n\t\t});\n\t\tfor (const sim of vals) {\n\t\t\tconst track = await this.trackStore.searchOne({title: sim.name, artist: sim.artist});\n\t\t\tif (track) {\n\t\t\t\tresult.push(track);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async getSimilarSongs(similar: Array<SimilarArtist>): Promise<Array<Song>> {\n\t\tlet tracks: Array<Song> = [];\n\t\tfor (const artist of similar) {\n\t\t\tlet data: LastFM.Result | undefined;\n\t\t\tif (artist.mbid) {\n\t\t\t\tdata = await this.lastFMTopTracksArtistID(artist.mbid);\n\t\t\t} else if (artist.name) {\n\t\t\t\tdata = await this.lastFMTopTracksArtist(artist.name);\n\t\t\t}\n\t\t\tif (data && data.toptracks && data.toptracks.track) {\n\t\t\t\ttracks = tracks.concat(data.toptracks.track.map(song => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tname: song.name,\n\t\t\t\t\t\tartist: song.artist.name,\n\t\t\t\t\t\tmbid: song.mbid,\n\t\t\t\t\t\turl: song.url\n\t\t\t\t\t};\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t\treturn shuffle(tracks);\n\t}\n\n\tprivate async getSimilarArtistTracks(similars: Array<SimilarArtist>): Promise<Array<Track>> {\n\t\tif (!similars || similars.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconst songs = await this.getSimilarSongs(similars);\n\t\treturn await this.findSimilarTracks(songs);\n\t}\n\n\tasync getTopTracks(artist: string): Promise<Array<Track>> {\n\t\tconst result = await this.lastFMTopTracksArtist(artist);\n\t\tif (result && result.toptracks && result.toptracks.track) {\n\t\t\tconst songs: Array<Song> = result.toptracks.track.map(t => {\n\t\t\t\treturn {\n\t\t\t\t\tname: t.name,\n\t\t\t\t\tartist: t.artist.name,\n\t\t\t\t\tmbid: t.mbid,\n\t\t\t\t\turl: t.url\n\t\t\t\t};\n\t\t\t});\n\t\t\treturn await this.findSimilarTracks(songs);\n\t\t}\n\t\treturn [];\n\t}\n\n\tasync getAlbumSimilarTracks(album: Album): Promise<Array<Track>> {\n\t\tconst similar = await this.getSimilarArtistsInfo(album.mbArtistID, album.artist);\n\t\treturn this.getSimilarArtistTracks(similar);\n\t}\n\n\tasync getArtistSimilarTracks(artist: Artist): Promise<Array<Track>> {\n\t\tconst similar = await this.getSimilarArtistsInfo(artist.mbArtistID, artist.name);\n\t\treturn this.getSimilarArtistTracks(similar);\n\t}\n\n\tasync getFolderSimilarTracks(folder: Folder): Promise<Array<Track>> {\n\t\tconst similar = await this.getSimilarArtistsInfo(folder.tag.mbArtistID, folder.tag.artist);\n\t\treturn this.getSimilarArtistTracks(similar);\n\t}\n\n\tasync getTrackSimilarTracks(track: Track): Promise<Array<Track>> {\n\t\tif (track.tag.mbTrackID) {\n\t\t\tconst data = await this.lastFMSimilarTracks(track.tag.mbTrackID);\n\t\t\tif (data && data.similartracks && data.similartracks.track) {\n\t\t\t\tconst songs = data.similartracks.track.map(t => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tname: t.name,\n\t\t\t\t\t\tartist: t.artist.name,\n\t\t\t\t\t\tmbid: t.mbid,\n\t\t\t\t\t\turl: t.url\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\treturn await this.findSimilarTracks(songs);\n\t\t\t}\n\t\t}\n\t\treturn [];\n\t}\n\n\t// generic searches\n\n\tasync musicbrainzSearch(type: string, query: MusicbrainzClientApi.SearchQuery): Promise<MusicBrainz.Response> {\n\t\tconst name = 'search-' + type + JSON.stringify(query);\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.musicbrainz});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst brainz = await this.audioModule.musicbrainzSearch(type, query);\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.musicbrainz, data: brainz});\n\t\treturn brainz;\n\t}\n\n\tasync acoustidLookupTrack(track: Track, includes: string | undefined): Promise<Array<Acoustid.Result>> {\n\t\tconst acoustid = await this.audioModule.acoustidLookup(path.join(track.path, track.name), includes);\n\t\treturn acoustid;\n\t}\n\n\tasync lastFMLookup(type: string, mbid: string): Promise<LastFM.Result> {\n\t\tconst name = 'lookup-' + type + mbid;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = await this.audioModule.lastFMLookup(type, mbid);\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync lastFMAlbumSearch(album: string, artist: string): Promise<LastFM.Result> {\n\t\tconst name = 'search-album-' + album + '//' + artist;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = {album: await this.audioModule.lastFM.album(album, artist)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync lastFMArtistSearch(artist: string): Promise<LastFM.Result> {\n\t\tconst name = 'search-artist-' + artist;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = {artist: await this.audioModule.lastFM.artist(artist)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync lastFMTopTracksArtist(artist: string): Promise<LastFM.Result> {\n\t\tconst name = 'toptracks-artist-' + artist;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = {toptracks: await this.audioModule.lastFM.topArtistSongs(artist)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync lastFMTopTracksArtistID(mbid: string): Promise<LastFM.Result> {\n\t\tconst name = 'toptracks-artistid-' + mbid;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = {toptracks: await this.audioModule.lastFM.topArtistSongsID(mbid)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync lastFMSimilarTracks(mbid: string): Promise<LastFM.Result> {\n\t\tconst name = 'similar-trackid-' + mbid;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.lastfm});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst lastfm = {similartracks: await this.audioModule.lastFM.similarTrackID(mbid)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.lastfm, data: lastfm});\n\t\treturn lastfm;\n\t}\n\n\tasync acousticbrainzLookup(mbid: string, nr: number | undefined): Promise<AcousticBrainz.Response> {\n\t\tconst name = 'lookup-' + mbid + (nr !== undefined) ? '-' + nr : '';\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.acousticbrainz});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst abrainz = await this.audioModule.acousticbrainzLookup(mbid, nr);\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.acousticbrainz, data: abrainz});\n\t\treturn abrainz;\n\t}\n\n\tasync coverartarchiveLookup(type: string, mbid: string): Promise<CoverArtArchive.Response> {\n\t\tconst name = 'lookup-' + type + mbid;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.coverartarchive});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst caa = await this.audioModule.coverartarchiveLookup(type, mbid);\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.coverartarchive, data: caa});\n\t\treturn caa;\n\t}\n\n\tasync musicbrainzLookup(type: string, mbid: string, inc?: string): Promise<MusicBrainz.Response> {\n\t\tconst name = 'lookup-' + type + mbid + (inc ? inc : '');\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.musicbrainz});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst brainz = await this.audioModule.musicbrainzLookup(type, mbid, inc);\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.musicbrainz, data: brainz});\n\t\treturn brainz;\n\t}\n\n\tasync wikipediaSummary(title: string, lang: string | undefined): Promise<Jam.WikipediaResponse> {\n\t\tlang = lang || 'en';\n\t\tconst name = 'summary-' + title + '/' + lang;\n\t\tconst result = await this.metadataStore.searchOne({name, dataType: MetaDataType.wikipedia});\n\t\tif (result) {\n\t\t\treturn result.data;\n\t\t}\n\t\tconst pedia = {summary: await this.audioModule.wikipediaSummary(title, lang)};\n\t\tawait this.metadataStore.add({id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.wikipedia, data: pedia});\n\t\treturn pedia;\n\t}\n\n\tasync wikidataSummary(id: string, lang: string | undefined): Promise<Jam.WikipediaResponse> {\n\t\tconst name = 'wikidata-sitelinks-' + id;\n\t\tlet result = await this.metadataStore.searchOne({name, dataType: MetaDataType.wikidata});\n\t\tif (!result) {\n\t\t\tconst entity = await this.audioModule.wikidataID(id);\n\t\t\tif (!entity) {\n\t\t\t\treturn {};\n\t\t\t}\n\t\t\tresult = {id: '', name, type: DBObjectType.metadata, dataType: MetaDataType.wikidata, data: entity};\n\t\t\tawait this.metadataStore.add(result);\n\t\t}\n\t\tlang = lang || 'en';\n\t\tconst site = lang + 'wiki';\n\t\tif (result.data && result.data.sitelinks) {\n\t\t\tconst langSite = result.data.sitelinks[site];\n\t\t\tif (!langSite) {\n\t\t\t\treturn {};\n\t\t\t}\n\t\t\treturn await this.wikipediaSummary(langSite.title, lang);\n\t\t}\n\t\treturn {};\n\t}\n\n}\n","\nexport enum MetaDataType {\n\tmusicbrainz,\n\twikipedia,\n\twikidata,\n\tacoustid,\n\tacousticbrainz,\n\tcoverartarchive,\n\tlastfm\n}\n","import {fileDeleteIfExists} from '../../utils/fs-utils';\nimport path from 'path';\nimport {User} from './user.model';\nimport {Md5} from 'md5-typescript';\nimport {SearchQueryUser, UserStore} from './user.store';\nimport {StateStore} from '../state/state.store';\nimport {PlaylistStore} from '../playlist/playlist.store';\nimport {PlayQueueStore} from '../playqueue/playqueue.store';\nimport {BookmarkStore} from '../bookmark/bookmark.store';\nimport {IApiBinaryResult} from '../../typings';\nimport {ImageModule} from '../../modules/image/image.module';\nimport {BaseStoreService} from '../base/base.service';\nimport {hashSalt, hashSaltPassword} from '../../utils/salthash';\n\nconst commonPassword = require('common-password-checker');\n\nexport class UserService extends BaseStoreService<User, SearchQueryUser> {\n\tprivate cached: {\n\t\t[id: string]: User;\n\t} = {};\n\n\tconstructor(public userAvatarPath: string, public userStore: UserStore, private stateStore: StateStore, private playlistStore: PlaylistStore, private bookmarkStore: BookmarkStore,\n\t\t\t\tprivate playQueueStore: PlayQueueStore, private imageModule: ImageModule) {\n\t\tsuper(userStore);\n\t}\n\n\tasync getUserImage(user: User, size?: number, format?: string): Promise<IApiBinaryResult | undefined> {\n\t\tif (user.avatar) {\n\t\t\treturn this.imageModule.get(user.id, path.join(this.userAvatarPath, user.avatar), size, format);\n\t\t}\n\t}\n\n\tasync setUserImage(user: User, filename: string): Promise<void> {\n\t\tconst destFileName = 'avatar-' + user.id + '.png';\n\t\tconst destName = path.join(this.userAvatarPath, destFileName);\n\t\tawait fileDeleteIfExists(destName);\n\t\tawait this.imageModule.createAvatar(filename, destName);\n\t\tawait this.imageModule.clearImageCacheByID(user.id);\n\t\tuser.avatar = destFileName;\n\t\tuser.avatarLastChanged = Date.now();\n\t\tawait this.update(user);\n\t}\n\n\tasync create(user: User): Promise<string> {\n\t\tif (!user.name || user.name.trim().length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tconst existingUser = await this.getByName(user.name);\n\t\tif (existingUser) {\n\t\t\treturn Promise.reject(Error('Username already exists'));\n\t\t}\n\t\treturn this.userStore.add(user);\n\t}\n\n\tasync update(user: User): Promise<void> {\n\t\tawait this.userStore.replace(user);\n\t\tdelete this.cached[user.id];\n\t}\n\n\tasync remove(user: User): Promise<void> {\n\t\tdelete this.cached[user.id];\n\t\tawait this.stateStore.removeByQuery({userID: user.id});\n\t\tawait this.playlistStore.removeByQuery({userID: user.id});\n\t\tawait this.bookmarkStore.removeByQuery({userID: user.id});\n\t\tawait this.playQueueStore.removeByQuery({userID: user.id});\n\t\tawait this.imageModule.clearImageCacheByID(user.id);\n\t\tawait this.userStore.remove(user.id);\n\t\t// TODO: remove user chat msg on user.delete\n\t\tif (user.avatar) {\n\t\t\tawait fileDeleteIfExists(path.join(this.userAvatarPath, user.avatar));\n\t\t}\n\t}\n\n\tasync getByName(name: string): Promise<User | undefined> {\n\t\tif (!name || name.trim().length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tconst ids = Object.keys(this.cached);\n\t\tfor (const id of ids) {\n\t\t\tif (this.cached[id].name === name) {\n\t\t\t\treturn this.cached[id];\n\t\t\t}\n\t\t}\n\t\tconst user = await this.userStore.searchOne({name});\n\t\tif (user) {\n\t\t\tthis.cached[user.id] = user;\n\t\t}\n\t\treturn user;\n\t}\n\n\tasync getByID(id: string): Promise<User | undefined> {\n\t\tlet user: User | undefined = this.cached[id];\n\t\tif (user) {\n\t\t\treturn user;\n\t\t}\n\t\tuser = await this.userStore.byId(id);\n\t\tif (user) {\n\t\t\tthis.cached[id] = user;\n\t\t}\n\t\treturn user;\n\t}\n\n\tasync auth(name: string, pass: string): Promise<User> {\n\t\tif ((!pass) || (!pass.length)) {\n\t\t\treturn Promise.reject(Error('Invalid Password'));\n\t\t}\n\t\tconst user = await this.getByName(name);\n\t\tif (!user) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tconst hash = hashSalt(pass, user.salt);\n\t\tif (hash !== user.hash) {\n\t\t\treturn Promise.reject(Error('Invalid Password'));\n\t\t}\n\t\treturn user;\n\t}\n\n\tasync authSubsonic(name: string, pass: string): Promise<User> {\n\t\tif ((!pass) || (!pass.length)) {\n\t\t\treturn Promise.reject(Error('Invalid Password'));\n\t\t}\n\t\tconst user = await this.getByName(name);\n\t\tif (!user) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tif (pass !== user.subsonic_pass) {\n\t\t\treturn Promise.reject(Error('Invalid Password'));\n\t\t}\n\t\treturn user;\n\t}\n\n\tasync authToken(name: string, token: string, salt: string): Promise<User> {\n\t\tif (!name || name.trim().length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tif ((!token) || (!token.length)) {\n\t\t\treturn Promise.reject(Error('Invalid Token'));\n\t\t}\n\t\tconst user = await this.getByName(name);\n\t\tif (!user) {\n\t\t\treturn Promise.reject(Error('Invalid Username'));\n\t\t}\n\t\tconst t = Md5.init(user.subsonic_pass + salt);\n\t\tif (token !== t) {\n\t\t\treturn Promise.reject(Error('Invalid Token'));\n\t\t}\n\t\treturn user;\n\t}\n\n\tpublic clearCache() {\n\t\tthis.cached = {};\n\t}\n\n\tasync setUserPassword(user: User, pass: string): Promise<void> {\n\t\tawait this.testPassword(pass);\n\t\tconst pw = hashSaltPassword(pass);\n\t\tuser.salt = pw.salt;\n\t\tuser.hash = pw.hash;\n\t\tawait this.userStore.replace(user);\n\t\tdelete this.cached[user.id];\n\t}\n\n\tasync testPassword(password: string): Promise<void> {\n\t\tif ((!password) || (!password.trim().length)) {\n\t\t\treturn Promise.reject(Error('Invalid Password'));\n\t\t}\n\t\tif (password.length < 4) {\n\t\t\treturn Promise.reject(Error('Password is too short'));\n\t\t}\n\t\tif (commonPassword(password)) {\n\t\t\treturn Promise.reject(Error('Your password is found in the most frequently used password list and too easy to guess'));\n\t\t}\n\t}\n\n\tasync setUserEmail(user: User, email: string): Promise<void> {\n\t\tif ((!email) || (!email.trim().length)) {\n\t\t\treturn Promise.reject(Error('Invalid Email'));\n\t\t}\n\t\tuser.email = email;\n\t\tawait this.userStore.replace(user);\n\t\tdelete this.cached[user.id];\n\t}\n}\n","module.exports = require(\"md5-typescript\");","module.exports = require(\"common-password-checker\");","import moment from 'moment';\nimport {ChatMessage} from './chat.model';\nimport {User} from '../../objects/user/user.model';\nimport {Jam} from '../../model/jam-rest-data';\n\nexport class ChatService {\n\tprivate messages: Array<ChatMessage> = [];\n\tprivate duration: moment.Duration = moment.duration(0, 's');\n\tprivate chatConfig: Jam.AdminSettingsChat = {maxMessages: 0, maxAge: {value: 0, unit: 's'}};\n\n\tconstructor() {\n\t}\n\n\tsetSettings(chatConfig: Jam.AdminSettingsChat) {\n\t\tthis.chatConfig = chatConfig;\n\t\tthis.duration = moment.duration(this.chatConfig.maxAge.value, <moment.unitOfTime.Base>this.chatConfig.maxAge.unit);\n\t}\n\n\tasync cleanOld(): Promise<void> {\n\t\tconst d = moment().subtract(this.duration).valueOf();\n\t\tthis.messages = this.messages.filter(c => d < c.time);\n\t}\n\n\tasync find(time: number): Promise<ChatMessage | undefined> {\n\t\treturn this.messages.find(msg => msg.time === time);\n\t}\n\n\tasync remove(message: ChatMessage): Promise<void> {\n\t\tthis.messages = this.messages.filter(msg => msg.time !== message.time);\n\t}\n\n\tasync get(since?: number): Promise<Array<ChatMessage>> {\n\t\tawait this.cleanOld();\n\t\tlet list: Array<ChatMessage> = this.messages;\n\t\tif (since !== undefined && !isNaN(since)) {\n\t\t\tlist = list.filter(msg => msg.time > since);\n\t\t}\n\t\treturn list;\n\t}\n\n\tasync add(message: string, user: User): Promise<ChatMessage> {\n\t\tawait this.cleanOld();\n\t\tconst c = {\n\t\t\tmessage: message,\n\t\t\ttime: Date.now(),\n\t\t\tusername: user.name,\n\t\t\tuserID: user.id\n\t\t};\n\t\tthis.messages.push(c);\n\t\tif (this.messages.length > this.chatConfig.maxMessages) {\n\t\t\tthis.messages.shift();\n\t\t}\n\t\treturn c;\n\t}\n\n}\n","import {Genre} from './genre.model';\nimport {TrackStore} from '../../objects/track/track.store';\n\nexport interface GenreInfo {\n\tname: string;\n\tsections: Array<{\n\t\trootID: string;\n\t\ttrackCount: number;\n\t\tartistCount: number;\n\t\talbumCount: number;\n\t}>;\n}\n\nexport class GenreService {\n\tprivate genres: Array<GenreInfo> = [];\n\n\tconstructor(private trackStore: TrackStore) {\n\t}\n\n\tasync refresh(): Promise<void> {\n\t\t// logger.info('Build Genres');\n\t\tconst genreHash: {\n\t\t\t[name: string]: {\n\t\t\t\troots: {\n\t\t\t\t\t[id: string]: {\n\t\t\t\t\t\tcount: number;\n\t\t\t\t\t\tartists: { [name: string]: number };\n\t\t\t\t\t\talbums: { [name: string]: number };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} = {};\n\n\t\tawait this.trackStore.iterate(async (tracks) => {\n\t\t\tfor (const track of tracks) {\n\t\t\t\tconst genre = track.tag.genre || '[No genre]';\n\t\t\t\tconst data = genreHash[genre] || {roots: {}};\n\t\t\t\tconst section = data.roots[track.rootID] || {count: 0, artists: {}, albums: {}};\n\t\t\t\tsection.count++;\n\t\t\t\tif (track.artistID) {\n\t\t\t\t\tsection.artists[track.artistID] = (section.artists[track.artistID] || 0) + 1;\n\t\t\t\t}\n\t\t\t\tif (track.albumID) {\n\t\t\t\t\tsection.albums[track.albumID] = (section.albums[track.albumID] || 0) + 1;\n\t\t\t\t}\n\t\t\t\tdata.roots[track.rootID] = section;\n\t\t\t\tgenreHash[genre] = data;\n\t\t\t}\n\t\t});\n\n\t\tthis.genres = Object.keys(genreHash).map(key => {\n\t\t\tconst data = genreHash[key];\n\t\t\treturn {\n\t\t\t\tname: key,\n\t\t\t\tsections: Object.keys(data.roots).map(sec => {\n\t\t\t\t\tconst section = data.roots[sec];\n\t\t\t\t\treturn {\n\t\t\t\t\t\trootID: sec,\n\t\t\t\t\t\tartistCount: Object.keys(section.artists).length,\n\t\t\t\t\t\talbumCount: Object.keys(section.albums).length,\n\t\t\t\t\t\ttrackCount: section.count\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t};\n\t\t});\n\t}\n\n\tasync getGenres(rootID?: string): Promise<Array<Genre>> {\n\t\tif (this.genres.length === 0) {\n\t\t\tawait this.refresh();\n\t\t}\n\t\treturn this.genres.map(g => {\n\t\t\tconst genre = {\n\t\t\t\tname: g.name,\n\t\t\t\talbumCount: 0,\n\t\t\t\tartistCount: 0,\n\t\t\t\ttrackCount: 0\n\t\t\t};\n\t\t\tg.sections.forEach(section => {\n\t\t\t\tif (!rootID || section.rootID === rootID) {\n\t\t\t\t\tgenre.albumCount += section.albumCount;\n\t\t\t\t\tgenre.artistCount += section.artistCount;\n\t\t\t\t\tgenre.trackCount += section.trackCount;\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn genre;\n\t\t}).filter(genre => genre.trackCount > 0);\n\t}\n\n}\n","import {Feed} from '../../utils/feed';\nimport Logger from '../../utils/logger';\nimport {PodcastStatus} from '../../model/jam-types';\nimport {Podcast} from './podcast.model';\nimport {Episode} from '../episode/episode.model';\nimport {PodcastStore, SearchQueryPodcast} from './podcast.store';\nimport {EpisodeService} from '../episode/episode.service';\nimport {DebouncePromises} from '../../utils/debounce-promises';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\nimport {DBObjectType} from '../../db/db.types';\n\nconst log = Logger('PodcastService');\n\nexport class PodcastService extends BaseListService<Podcast, SearchQueryPodcast> {\n\tprivate podcastRefreshDebounce = new DebouncePromises<void>();\n\n\tconstructor(public podcastStore: PodcastStore, private episodeService: EpisodeService, stateService: StateService) {\n\t\tsuper(podcastStore, stateService);\n\t}\n\n\tisDownloading(podcastId: string): boolean {\n\t\treturn this.podcastRefreshDebounce.isPending(podcastId);\n\t}\n\n\tasync create(url: string): Promise<Podcast> {\n\t\tconst podcast: Podcast = {\n\t\t\tid: '',\n\t\t\ttype: DBObjectType.podcast,\n\t\t\tcreated: Date.now(),\n\t\t\tlastCheck: 0,\n\t\t\turl: url,\n\t\t\tstatus: PodcastStatus.new\n\t\t};\n\t\tpodcast.id = await this.podcastStore.add(podcast);\n\t\treturn podcast;\n\t}\n\n\tasync remove(podcast: Podcast): Promise<void> {\n\t\tawait this.podcastStore.remove(podcast.id);\n\t\tawait this.episodeService.removeEpisodes(podcast.id);\n\t}\n\n\tasync refresh(podcast: Podcast): Promise<void> {\n\t\tif (this.podcastRefreshDebounce.isPending(podcast.id)) {\n\t\t\treturn this.podcastRefreshDebounce.append(podcast.id);\n\t\t}\n\t\tthis.podcastRefreshDebounce.setPending(podcast.id);\n\t\ttry {\n\t\t\tlog.debug('Refreshing Podcast', podcast.url);\n\t\t\tconst feed = new Feed();\n\t\t\tlet episodes: Array<Episode> = [];\n\t\t\ttry {\n\t\t\t\tconst result = await feed.get(podcast);\n\t\t\t\tif (result) {\n\t\t\t\t\tpodcast.tag = result.tag;\n\t\t\t\t\tepisodes = result.episodes;\n\t\t\t\t}\n\t\t\t\tpodcast.status = PodcastStatus.completed;\n\t\t\t\tpodcast.errorMessage = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tlog.info('Refreshing Podcast failed', e);\n\t\t\t\tpodcast.status = PodcastStatus.error;\n\t\t\t\tpodcast.errorMessage = (e || '').toString();\n\t\t\t}\n\t\t\tpodcast.lastCheck = Date.now();\n\t\t\tawait this.podcastStore.replace(podcast);\n\t\t\tconst newEpisodes = await this.episodeService.mergeEpisodes(podcast.id, episodes);\n\t\t\tlog.info(podcast.url + ': New Episodes: ' + newEpisodes.length);\n\t\t\tawait this.podcastRefreshDebounce.resolve(podcast.id, undefined);\n\t\t} catch (e) {\n\t\t\tawait this.podcastRefreshDebounce.resolve(podcast.id, undefined);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync refreshPodcasts(): Promise<void> {\n\t\tlog.info('Refreshing');\n\t\tconst podcasts = await this.podcastStore.all();\n\t\tfor (const podcast of podcasts) {\n\t\t\tawait this.refresh(podcast);\n\t\t}\n\t\tlog.info('Refreshed');\n\t}\n}\n","import {NodeError, NodeErrorCallback} from '../typings';\nimport zlib from 'zlib';\nimport stream from 'stream';\nimport request from 'request';\nimport FeedParser from 'feedparser';\nimport iconv from 'iconv-lite';\nimport {PodcastStatus} from '../model/jam-types';\nimport {Subsonic} from '../model/subsonic-rest-data';\nimport {PodcastTag} from '../objects/podcast/podcast.model';\nimport {Episode, PodcastEpisodeChapter} from '../objects/episode/episode.model';\nimport {DBObjectType} from '../db/db.types';\n\nexport class Feed {\n\n\tconstructor() {\n\n\t}\n\n\tprivate getParams(str: string): { [key: string]: string } {\n\t\treturn str.split(';').reduce(\n\t\t\t(para: { [key: string]: string }, param: string) => {\n\t\t\t\tconst parts = param.split('=').map(function(part) {\n\t\t\t\t\treturn part.trim();\n\t\t\t\t});\n\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\tpara[parts[0]] = parts[1];\n\t\t\t\t}\n\t\t\t\treturn para;\n\t\t\t}, {});\n\t}\n\n\tprivate maybeDecompress(res: stream.Readable, encoding: string, done: NodeErrorCallback): stream.Readable {\n\t\tlet decompress;\n\t\tif (encoding.match(/\\bdeflate\\b/)) {\n\t\t\tdecompress = zlib.createInflate();\n\t\t\tdecompress.on('error', done);\n\t\t} else if (encoding.match(/\\bgzip\\b/)) {\n\t\t\tdecompress = zlib.createGunzip();\n\t\t\tdecompress.on('error', done);\n\t\t}\n\t\treturn decompress ? res.pipe(decompress) : res;\n\t}\n\n\tprivate maybeTranslate(res: stream.Readable, charset: string, done: NodeErrorCallback): stream.Readable {\n\t\t// Use iconv if its not utf8 already.\n\t\tif (charset && !/utf-*8/i.test(charset)) {\n\t\t\ttry {\n\t\t\t\tconst iv = iconv.decodeStream(charset);\n\t\t\t\t// console.log('Converting from charset %s to utf-8', charset);\n\t\t\t\tiv.on('error', done);\n\t\t\t\t// If we're using iconv, stream will be the output of iconv\n\t\t\t\t// otherwise it will remain the output of request\n\t\t\t\tres = <any>res.pipe(iv); // TODO: iconv stream doesn't return a stream.Readable?\n\t\t\t} catch (err) {\n\t\t\t\tres.emit('error', err);\n\t\t\t}\n\t\t}\n\t\treturn res;\n\t}\n\n\tprivate async fetch(url: string): Promise<{ feed: FeedParser.Node, posts: Array<FeedParser.Item> }> {\n\t\tconst posts: Array<FeedParser.Item> = [];\n\t\tlet feed: any;\n\t\tlet doneReported = false;\n\t\tconst req = request(url, {timeout: 10000, pool: false});\n\t\treq.setMaxListeners(50);\n\t\t// Some feeds do not respond without user-agent and accept headers.\n\t\treq.setHeader('user-agent', 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36');\n\t\treq.setHeader('accept', 'text/html,application/xhtml+xml');\n\n\t\tconst feedparser = new FeedParser({});\n\n\t\tfeedparser.on('readable', function streamResponse() {\n\t\t\tconst response = feedparser; // this;\n\t\t\tfeed = response.meta;\n\t\t\tlet item = response.read();\n\t\t\twhile (item) {\n\t\t\t\tposts.push(item);\n\t\t\t\titem = response.read();\n\t\t\t}\n\t\t});\n\n\t\treturn new Promise<{ feed: FeedParser.Node, posts: Array<FeedParser.Item> }>((resolve, reject) => {\n\t\t\tconst done = (err: NodeError) => {\n\t\t\t\tif (doneReported) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdoneReported = true;\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve({feed, posts});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\treq.on('error', done);\n\t\t\treq.on('response', (res: request.Response) => {\n\t\t\t\tif (res.statusCode !== 200) {\n\t\t\t\t\treq.abort();\n\t\t\t\t\treturn done(new Error('Bad status code ' + res.statusCode + (res.statusMessage ? ' ' + res.statusMessage : '')));\n\t\t\t\t}\n\t\t\t\tconst encoding = res.headers['content-encoding'] || 'identity';\n\t\t\t\tconst charset = this.getParams(res.headers['content-type'] || '').charset;\n\t\t\t\tlet pipestream = this.maybeDecompress(res, encoding, done);\n\t\t\t\tpipestream = this.maybeTranslate(pipestream, charset, done);\n\t\t\t\tpipestream.pipe(feedparser);\n\t\t\t});\n\n\t\t\tfeedparser.on('error', done);\n\t\t\tfeedparser.on('end', done);\n\n\t\t});\n\t}\n\n\tpublic async get(podcast: Subsonic.PodcastChannel): Promise<{ tag: PodcastTag, episodes: Array<Episode> }> {\n\t\tconst data = await this.fetch(podcast.url);\n\t\tconst tag: PodcastTag = {\n\t\t\ttitle: data.feed.title,\n\t\t\tdescription: data.feed.description,\n\t\t\tlink: data.feed.link,\n\t\t\tauthor: data.feed.author,\n\t\t\tgenerator: data.feed.generator,\n\t\t\timage: data.feed.image && data.feed.image.url ? data.feed.image.url : undefined,\n\t\t\tcategories: data.feed.categories\n\t\t};\n\t\tif (data.feed['itunes:summary'] && data.feed['itunes:summary']['#']) {\n\t\t\ttag.description = data.feed['itunes:summary']['#'];\n\t\t}\n\t\tconst episodes: Array<Episode> = data.posts.map(post => {\n\t\t\tlet chapters: Array<PodcastEpisodeChapter> = [];\n\n\t\t\tconst pscChaps: any = (<any>post)['psc:chapters'];\n\t\t\tif (pscChaps) {\n\t\t\t\tconst pscChap: Array<any> = pscChaps['psc:chapter'];\n\t\t\t\tif (pscChap) {\n\t\t\t\t\tchapters = pscChap.map(item => item['@']);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tid: '',\n\t\t\t\tpodcastID: podcast.id,\n\t\t\t\tstatus: PodcastStatus.new,\n\t\t\t\ttype: DBObjectType.episode,\n\t\t\t\tauthor: post.author,\n\t\t\t\tlink: post.link,\n\t\t\t\tguid: post.guid,\n\t\t\t\tsummary: post.summary,\n\t\t\t\tenclosures: <any>post.enclosures, // TODO: validate podcast enclosures (wrong interface description?)\n\t\t\t\tdate: post.date ? post.date.valueOf() : 0,\n\t\t\t\tname: post.title,\n\t\t\t\tchapters: chapters\n\t\t\t};\n\t\t});\n\t\treturn {tag, episodes};\n\t}\n\n}\n","module.exports = require(\"zlib\");","module.exports = require(\"feedparser\");","module.exports = require(\"iconv-lite\");","import {DBObjectType} from '../../db/db.types';\nimport {NowPlaying} from './nowplaying.model';\nimport {User} from '../../objects/user/user.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport {Track} from '../../objects/track/track.model';\nimport {StateService} from '../../objects/state/state.service';\n\nexport class NowPlayingService {\n\tplaying: Array<NowPlaying> = [];\n\n\tconstructor(private stateService: StateService) {\n\t}\n\n\tasync getNowPlaying(): Promise<Array<NowPlaying>> {\n\t\treturn this.playing;\n\t}\n\n\tclear() {\n\t\tthis.playing = [];\n\t}\n\n\tasync reportEpisode(episode: Episode, user: User): Promise<void> {\n\t\tthis.playing = this.playing.filter(np => (np.user.id !== user.id));\n\t\tthis.playing.push({\n\t\t\ttime: Date.now(),\n\t\t\tobj: episode,\n\t\t\tuser: user\n\t\t});\n\t\tawait this.stateService.reportPlaying(episode.id, DBObjectType.episode, user.id);\n\t\tawait this.stateService.reportPlaying(episode.podcastID, DBObjectType.podcast, user.id);\n\t}\n\n\tasync reportTrack(track: Track, user: User): Promise<void> {\n\t\tthis.playing = this.playing.filter(np => (np.user.id !== user.id));\n\t\tthis.playing.push({\n\t\t\ttime: Date.now(),\n\t\t\tobj: track,\n\t\t\tuser: user\n\t\t});\n\t\tawait this.stateService.reportPlaying(track.id, DBObjectType.track, user.id);\n\t\tawait this.stateService.reportPlaying(track.albumID, DBObjectType.album, user.id);\n\t\tawait this.stateService.reportPlaying(track.artistID, DBObjectType.artist, user.id);\n\t\tawait this.stateService.reportPlaying(track.parentID, DBObjectType.folder, user.id);\n\t}\n}\n","import {Root} from './root.model';\nimport {RootStore, SearchQueryRoot} from './root.store';\nimport {BaseStoreService} from '../base/base.service';\n\nexport class RootService extends BaseStoreService<Root, SearchQueryRoot> {\n\n\tconstructor(public rootStore: RootStore) {\n\t\tsuper(rootStore);\n\t}\n\n\tprivate async checkUsedPath(dir: string, roots: Array<Root>): Promise<void> {\n\t\tfor (const r of roots) {\n\t\t\tif (dir.indexOf(r.path) === 0 || r.path.indexOf(dir) === 0) {\n\t\t\t\treturn Promise.reject(Error('Root path already used'));\n\t\t\t}\n\t\t}\n\t}\n\n\tasync create(root: Root): Promise<string> {\n\t\tconst roots = await this.rootStore.all();\n\t\tawait this.checkUsedPath(root.path, roots);\n\t\treturn this.rootStore.add(root);\n\t}\n\n\tasync update(root: Root): Promise<void> {\n\t\tconst roots = await this.rootStore.all();\n\t\tawait this.checkUsedPath(root.path, roots.filter(r => r.id !== root.id));\n\t\tawait this.rootStore.replace(root);\n\t}\n\n\tasync remove(root: Root): Promise<void> {\n\t\tawait this.rootStore.remove(root.id);\n\t}\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {PlayQueue} from './playqueue.model';\nimport {PlayQueueStore, SearchQueryPlayQueue} from './playqueue.store';\nimport {BaseStoreService} from '../base/base.service';\n\nexport class PlayQueueService extends BaseStoreService<PlayQueue, SearchQueryPlayQueue> {\n\n\tconstructor(private playQueueStore: PlayQueueStore) {\n\t\tsuper(playQueueStore);\n\t}\n\n\tasync getQueueOrCreate(userID: string, client?: string): Promise<PlayQueue> {\n\t\tlet playQueue = await this.get(userID);\n\t\tif (!playQueue) {\n\t\t\tplayQueue = this.emptyPlaylist(userID, client);\n\t\t\tplayQueue.id = await this.playQueueStore.add(playQueue);\n\t\t}\n\t\treturn playQueue;\n\t}\n\n\temptyPlaylist(userID: string, client?: string): PlayQueue {\n\t\treturn {\n\t\t\tid: '',\n\t\t\ttype: DBObjectType.playqueue,\n\t\t\tuserID,\n\t\t\ttrackIDs: [],\n\t\t\tchanged: Date.now(),\n\t\t\tchangedBy: client || 'Unknown Client'\n\t\t};\n\t}\n\n\tasync get(userID: string): Promise<PlayQueue | undefined> {\n\t\treturn this.playQueueStore.searchOne({userID});\n\t}\n\n\tasync save(userID: string, trackIDs: Array<string>, currentID: string | undefined, position: number | undefined, client?: string): Promise<PlayQueue> {\n\t\tlet playQueue = await this.playQueueStore.searchOne({userID});\n\t\tif (!playQueue) {\n\t\t\tplayQueue = {\n\t\t\t\tid: '',\n\t\t\t\ttype: DBObjectType.playqueue,\n\t\t\t\tuserID,\n\t\t\t\ttrackIDs,\n\t\t\t\tcurrentID,\n\t\t\t\tposition,\n\t\t\t\tchanged: Date.now(),\n\t\t\t\tchangedBy: client || 'Unknown Client'\n\t\t\t};\n\t\t\tplayQueue.id = await this.playQueueStore.add(playQueue);\n\t\t} else {\n\t\t\tplayQueue.trackIDs = trackIDs;\n\t\t\tplayQueue.currentID = currentID;\n\t\t\tplayQueue.position = position;\n\t\t\tplayQueue.changed = Date.now();\n\t\t\tplayQueue.changedBy = client || 'Unknown Client';\n\t\t\tawait this.playQueueStore.replace(playQueue);\n\t\t}\n\t\treturn playQueue;\n\t}\n\n\tasync remove(userID: string): Promise<void> {\n\t\tconst playQueue = await this.get(userID);\n\t\tif (playQueue) {\n\t\t\tawait this.playQueueStore.remove(playQueue.id);\n\t\t}\n\t}\n\n}\n","import path from 'path';\nimport Logger from '../../utils/logger';\nimport {IApiBinaryResult} from '../../typings';\nimport {DebouncePromises} from '../../utils/debounce-promises';\nimport {WaveformGenerator} from '../../modules/audio/tools/ffmpeg-waveform';\nimport fse from 'fs-extra';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport WaveformFormatType = JamParameters.WaveformFormatType;\n\nconst log = Logger('WaveformService');\n\nexport class WaveformService {\n\tprivate waveformCacheDebounce = new DebouncePromises<IApiBinaryResult>();\n\n\tconstructor(private waveformCachePath: string) {\n\t}\n\n\tprivate getCacheID(id: string, format: string): string {\n\t\treturn 'waveform-' + id + '.' + format;\n\t}\n\n\tprivate async generateWaveform(filename: string, format: WaveformFormatType): Promise<IApiBinaryResult> {\n\t\tconst wf = new WaveformGenerator();\n\t\tswitch (format) {\n\t\t\tcase 'svg':\n\t\t\t\treturn {buffer: {buffer: Buffer.from(await wf.svg(filename)), contentType: 'image/svg+xml'}};\n\t\t\tcase 'json':\n\t\t\t\treturn {json: await wf.json(filename)};\n\t\t\tcase 'dat':\n\t\t\t\treturn {buffer: {buffer: await wf.binary(filename), contentType: 'application/binary'}};\n\t\t}\n\t\treturn Promise.reject(Error('Invalid Format for Waveform generation'));\n\t}\n\n\tasync clearWaveformCacheByIDs(ids: Array<string>): Promise<void> {\n\t\tconst searches = ids.filter(id => id.length > 0).map(id => this.getCacheID(id, ''));\n\t\tif (searches.length > 0) {\n\t\t\tlet list = await fse.readdir(this.waveformCachePath);\n\t\t\tlist = list.filter(name => {\n\t\t\t\treturn searches.findIndex(s => name.indexOf(s) === 0) >= 0;\n\t\t\t});\n\t\t\tfor (const filename of list) {\n\t\t\t\tawait fse.unlink(path.resolve(this.waveformCachePath, filename));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async get(id: string, filename: string, format: WaveformFormatType): Promise<IApiBinaryResult> {\n\t\tif (!filename || !(await fse.pathExists(filename))) {\n\t\t\treturn Promise.reject(Error('Invalid filename for waveform generation'));\n\t\t}\n\t\tconst cacheID = this.getCacheID(id, format);\n\t\tif (this.waveformCacheDebounce.isPending(cacheID)) {\n\t\t\treturn this.waveformCacheDebounce.append(cacheID);\n\t\t}\n\t\tthis.waveformCacheDebounce.setPending(cacheID);\n\t\ttry {\n\t\t\tlet result: IApiBinaryResult;\n\t\t\tconst cachefile = path.join(this.waveformCachePath, cacheID);\n\t\t\tconst exists = await fse.pathExists(cachefile);\n\t\t\tif (exists) {\n\t\t\t\tresult = {file: {filename: cachefile, name: cacheID}};\n\t\t\t} else {\n\t\t\t\tresult = await this.generateWaveform(filename, format);\n\t\t\t\tif (result.buffer) {\n\t\t\t\t\tlog.debug('Writing waveform cache file', cachefile);\n\t\t\t\t\tawait fse.writeFile(cachefile, result.buffer.buffer);\n\t\t\t\t} else if (result.json) {\n\t\t\t\t\tlog.debug('Writing waveform cache file', cachefile);\n\t\t\t\t\tawait fse.writeFile(cachefile, JSON.stringify(result.json));\n\t\t\t\t}\n\t\t\t}\n\t\t\tawait this.waveformCacheDebounce.resolve(cacheID, result);\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tawait this.waveformCacheDebounce.reject(cacheID, e);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync getTrackWaveform(track: Track, format: WaveformFormatType): Promise<IApiBinaryResult> {\n\t\treturn await this.get(track.id, path.join(track.path, track.name), format);\n\t}\n\n\tasync getEpisodeWaveform(episode: Episode, format: WaveformFormatType): Promise<IApiBinaryResult> {\n\t\tif (episode.path && episode.media) {\n\t\t\treturn await this.get(episode.id, episode.path, format);\n\t\t} else {\n\t\t\treturn Promise.reject(Error('Podcast episode not ready'));\n\t\t}\n\t}\n}\n","import SVGO from 'svgo';\nimport fs from 'fs';\nimport {PassThrough, Readable, Stream, Transform, TransformCallback} from 'stream';\nimport Logger from '../../../utils/logger';\nimport Ffmpeg from 'fluent-ffmpeg';\n\n// import WaveformData from 'waveform-data';\nconst WaveformData = require('waveform-data');\n\nconst log = Logger('Waveform');\n\nexport interface IWaveformData {\n\tversion: number;\n\tsample_rate: number;\n\tsamples_per_pixel: number;\n\tbits: number;\n\tlength: number;\n\tdata: Array<number>;\n}\n\n/**\n class WaveformStream & class Waveform\n\n based on https://github.com/StreamMachine/sm-waveform\n MIT: https://github.com/StreamMachine/sm-waveform/blob/master/LICENSE\n\n */\n\nclass WaveformStream extends Transform {\n\t_buf = new PassThrough;\n\t_out = new PassThrough;\n\t_ffmpeg: Ffmpeg.FfmpegCommand;\n\t_sampleRate: number;\n\t_samplesPerPixel: number;\n\t_started = false;\n\t_min: number | null = null;\n\t_max: number | null = null;\n\t_samples = 0;\n\t_total = 0;\n\n\tconstructor(_at__samplesPerPixel?: number, _at__sampleRate?: number) {\n\t\tsuper({writableObjectMode: false, readableObjectMode: true, highWaterMark: 1024});\n\t\tthis._samplesPerPixel = _at__samplesPerPixel != null ? _at__samplesPerPixel : 256;\n\t\tthis._sampleRate = _at__sampleRate != null ? _at__sampleRate : 44100;\n\t\tconst options: Ffmpeg.FfmpegCommandOptions = {\n\t\t\tsource: <Readable>this._buf\n\t\t};\n\t\tthis._ffmpeg = Ffmpeg(options).addOptions(['-f s16le', '-ac 1', '-acodec pcm_s16le', '-ar ' + this._sampleRate]);\n\t\tthis._ffmpeg.on('start', (cmd: string) => {\n\t\t\tlog.debug('ffmpeg started with ' + cmd);\n\t\t\tthis._started = true;\n\t\t\treturn this.emit('_started');\n\t\t});\n\t\tlet errored = false;\n\t\tthis._ffmpeg.on('error', (err: any) => {\n\t\t\tif (err.code === 'ENOENT') {\n\t\t\t\terrored = true;\n\t\t\t\tlog.debug('ffmpeg failed to start.');\n\t\t\t\treturn this.emit('done', 'ffmpeg failed to start');\n\t\t\t} else {\n\t\t\t\terrored = true;\n\t\t\t\tlog.debug('ffmpeg decoding error: ' + err);\n\t\t\t\treturn this.emit('done', 'ffmpeg decoding error: ' + err);\n\t\t\t}\n\t\t});\n\t\tthis._ffmpeg.on('end', () => {\n\t\t\tif (!errored) {\n\t\t\t\treturn this.emit('done');\n\t\t\t}\n\t\t});\n\t\tthis._ffmpeg.writeToStream(this._out);\n\t\tthis._out.on('readable', () => this.start());\n\t}\n\n\tstart() {\n\t\tlet oddByte: number | null = null;\n\t\tlet i: number;\n\t\tlet value: number;\n\t\tlet data: Buffer | undefined = this._out.read();\n\t\twhile (data && data.length > 0) {\n\t\t\ti = 0;\n\t\t\tif (oddByte != null) {\n\t\t\t\tvalue = ((data.readInt8(0, true) << 8) | oddByte);\n\t\t\t\toddByte = null;\n\t\t\t\ti = 1;\n\t\t\t} else {\n\t\t\t\tvalue = data.readInt16LE(0, true);\n\t\t\t\ti = 2;\n\t\t\t}\n\t\t\tthis.readResults(value, i, data);\n\t\t\tdata = this._out.read();\n\t\t}\n\t}\n\n\treadResults(value: number, pos: number, data: Buffer) {\n\t\tconst dataLen = data.length;\n\t\twhile (true) {\n\t\t\tthis._min = this._min === null ? value : Math.min(this._min, value);\n\t\t\tthis._max = this._max === null ? value : Math.max(this._max, value);\n\t\t\tthis._samples += 1;\n\t\t\tif (this._samples === this._samplesPerPixel) {\n\t\t\t\tthis.push([Math.round(this._min), Math.round(this._max)]);\n\t\t\t\tthis._min = null;\n\t\t\t\tthis._max = null;\n\t\t\t\tthis._samples = 0;\n\t\t\t}\n\t\t\tif (pos >= dataLen) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvalue = data.readInt16LE(pos, true);\n\t\t\tpos += 2;\n\t\t}\n\t}\n\n\t_transform(chunk: Buffer, encoding: string, cb: TransformCallback) {\n\t\tthis._total += chunk.length;\n\t\t// debug('_trans chunk: ' + chunk.length + '/' + this._total);\n\t\tif (this._started) {\n\t\t\treturn this._buf.write(chunk, encoding, <any>cb);\n\t\t} else {\n\t\t\treturn this.once('_started', () => {\n\t\t\t\treturn this._buf.write(chunk, encoding, <any>cb);\n\t\t\t});\n\t\t}\n\t}\n\n\t_flush(cb: TransformCallback) {\n\t\tthis._buf.end();\n\t\treturn this._out.once('end', () => {\n\t\t\tif (this._samples > 0) {\n\t\t\t\tthis.push([this._min, this._max]);\n\t\t\t}\n\t\t\treturn cb();\n\t\t});\n\t}\n\n}\n\ninterface WaveformOptions {\n\tsamplesPerPixel: number;\n\tsampleRate: number;\n}\n\nclass Waveform {\n\n\t_samples: Array<number> = [];\n\n\tconstructor(private stream: Stream, private opts: WaveformOptions) {\n\t\tthis.opts = Object.assign({\n\t\t\tsamplesPerPixel: 256,\n\t\t\tsampleRate: 44100\n\t\t}, opts || {});\n\t}\n\n\trun(cb: (err?: Error) => void) {\n\t\tconst ws = new WaveformStream(this.opts.samplesPerPixel, this.opts.sampleRate);\n\t\tws.on('readable', () => {\n\t\t\tlet px = ws.read();\n\t\t\twhile (px && px.length > 0) {\n\t\t\t\tthis._samples.push(px[0]);\n\t\t\t\tthis._samples.push(px[1]);\n\t\t\t\tpx = ws.read();\n\t\t\t}\n\t\t});\n\t\tws.on('done', (err) => {\n\t\t\tcb(err);\n\t\t});\n\t\tthis.stream.pipe(ws);\n\t}\n\n\tasBinary(): Buffer {\n\t\t// https://github.com/bbc/audiowaveform/blob/master/doc/DataFormat.md\n\t\tconst result = Buffer.alloc(20 + (this._samples.length * 2));\n\t\tresult.writeInt32LE(1, 0); // version\n\t\tresult.writeUInt32LE(0, 4); // flags 0 (lsb) \t0: 16-bit resolution, 1: 8-bit resolution 1-31 \tUnused\n\t\tresult.writeInt32LE(this.opts.sampleRate, 8); // Sample rate\n\t\tresult.writeInt32LE(this.opts.samplesPerPixel, 12); // Samples per pixel\n\t\tresult.writeInt32LE(this._samples.length / 2, 16); // Length of waveform data (number of minimum and maximum value pairs)\n\t\tlet pos = 20;\n\t\tthis._samples.forEach(num => {\n\t\t\tresult.writeInt16LE(num, pos);\n\t\t\tpos += 2;\n\t\t});\n\t\treturn result;\n\t}\n\n\tasJSON(): IWaveformData {\n\t\t// https://github.com/bbc/audiowaveform/blob/master/doc/DataFormat.md\n\t\treturn {\n\t\t\tversion: 1,\n\t\t\tsample_rate: this.opts.sampleRate,\n\t\t\tsamples_per_pixel: this.opts.samplesPerPixel,\n\t\t\tbits: 16,\n\t\t\tlength: this._samples.length / 2,\n\t\t\tdata: this._samples\n\t\t};\n\t}\n\n}\n\nexport class WaveformGenerator {\n\n\tasync binary(filename: string): Promise<Buffer> {\n\t\tconst wf: Waveform = await this.generateWaveform(filename);\n\t\treturn wf.asBinary();\n\t}\n\n\tasync json(filename: string): Promise<IWaveformData> {\n\t\tconst wf: Waveform = await this.generateWaveform(filename);\n\t\treturn wf.asJSON();\n\t}\n\n\tasync svg(filename: string): Promise<string> {\n\t\tconst data = await this.json(filename);\n\t\tconst svg = this.buildSvg(data);\n\t\tconst svgo = new SVGO();\n\t\tconst optimized = await svgo.optimize(svg);\n\t\treturn optimized.data;\n\t}\n\n\tprivate async generateWaveform(filename: string): Promise<Waveform> {\n\t\tconst stream = fs.createReadStream(filename);\n\t\treturn new Promise<Waveform>((resolve, reject) => {\n\t\t\tconst wf: Waveform = new Waveform(stream, {\n\t\t\t\tsamplesPerPixel: 256,\n\t\t\t\tsampleRate: 44100\n\t\t\t});\n\t\t\twf.run((err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(wf);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate buildSvg(data: IWaveformData): string {\n\t\tconst width = 4000;\n\t\tconst height = 256;\n\t\tif (data.data.length > 0) {\n\t\t\tlet wfd = WaveformData.create(data);\n\t\t\tconst samplesPerPixel = Math.floor(wfd.duration * wfd.adapter.sample_rate / (width * 2));\n\t\t\tif (samplesPerPixel < 256) {\n\t\t\t\twfd = wfd.resample({width: width * 2, scale: 256});\n\t\t\t} else {\n\t\t\t\twfd = wfd.resample({width: width * 2});\n\t\t\t}\n\t\t\twfd.adapter.data.data = wfd.adapter.data.data.slice(0, width * 2);\n\t\t\tdata = wfd.adapter.data;\n\t\t}\n\t\tconst totalPeaks = data.data.length;\n\t\tconst d: Array<string> = [];\n\t\tfor (let peakNumber = 0; peakNumber < totalPeaks; peakNumber++) {\n\t\t\tconst num = (data.data[peakNumber] / height) + (height / 2);\n\t\t\tif (peakNumber % 2 === 0) {\n\t\t\t\td.push(`M${~~(peakNumber / 2)}, ${num}`);\n\t\t\t} else {\n\t\t\t\td.push(`L${~~(peakNumber / 2)}, ${num}`);\n\t\t\t}\n\t\t}\n\t\tconst result = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" xml:space=\"preserve\" version=\"1.1\" preserveAspectRatio=\"none\"\n     viewBox=\"0 0 ${width} ${height}\" style=\"fill-rule:evenodd;clip-rule:evenodd;\">\n\t\t<path stroke=\"green\" d=\"${d.join(' ')}\" />\n</svg>`;\n\t\treturn result;\n\t}\n\n}\n","module.exports = require(\"svgo\");","module.exports = require(\"stream\");","module.exports = require(\"waveform-data\");","import {IApiBinaryResult} from '../../typings';\nimport {PreTranscoder, Transcoder} from '../../modules/audio/transcoder';\nimport {fileSuffix} from '../../utils/fs-utils';\nimport path from 'path';\nimport fse from 'fs-extra';\nimport {GenericError} from '../../api/jam/error';\nimport {User} from '../../objects/user/user.model';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport {AudioFormatType} from '../../model/jam-types';\n\nexport class StreamService {\n\n\tconstructor() {\n\n\t}\n\n\tasync streamFile(filename: string, id: string, sourceFormat?: string, destFormat?: string, maxBitRate?: number): Promise<IApiBinaryResult> {\n\t\tconst exists = await fse.pathExists(filename);\n\t\tif (!exists) {\n\t\t\treturn Promise.reject(Error('File not found'));\n\t\t}\n\t\tdestFormat = destFormat || AudioFormatType.mp3;\n\t\tif (destFormat[0] === '.') {\n\t\t\tdestFormat = destFormat.slice(1);\n\t\t}\n\t\tconst bitRate = maxBitRate || 0;\n\t\tif (destFormat !== 'raw' && Transcoder.needsTranscoding(sourceFormat || fileSuffix(filename), destFormat, bitRate)) {\n\t\t\tif (!Transcoder.validTranscoding(<AudioFormatType>destFormat)) {\n\t\t\t\treturn Promise.reject(Error('Unsupported transcoding format'));\n\t\t\t}\n\t\t\treturn {pipe: new PreTranscoder(filename, destFormat, bitRate)};\n\t\t\t// return {pipe: new Transcoder(filename, f, bitRate, media.duration)};\n\t\t} else {\n\t\t\treturn {file: {filename, name: id + '.' + destFormat}};\n\t\t}\n\t}\n\n\tasync streamTrack(track: Track, format: string | undefined, maxBitRate: number | undefined, user: User): Promise<IApiBinaryResult> {\n\t\treturn this.streamFile(path.join(track.path, track.name), track.id, track.media.format, format, maxBitRate);\n\t}\n\n\tasync streamEpisode(episode: Episode, format: string | undefined, maxBitRate: number | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tif (episode.path && episode.media) {\n\t\t\treturn this.streamFile(episode.path, episode.id, episode.media.format, format, maxBitRate);\n\t\t} else {\n\t\t\treturn Promise.reject(GenericError('Podcast episode not ready'));\n\t\t}\n\t}\n\n\n}\n","import ffmpeg from 'fluent-ffmpeg';\nimport express from 'express';\nimport tmp from 'tmp';\nimport {IStreamData} from '../../typings';\nimport Logger from '../../utils/logger';\nimport * as fs from 'fs';\nimport {SupportedTranscodeAudioFormat} from '../../utils/filetype';\nimport {AudioFormatType} from '../../model/jam-types';\n\nconst log = Logger('audio.transcoder');\n\nexport class Transcoder implements IStreamData {\n\tfilename: string;\n\tformat: string;\n\tmaxBitRate: number;\n\tduration?: number;\n\n\tconstructor(filename: string, format: string, maxBitRate: number, duration?: number) {\n\t\tthis.filename = filename;\n\t\tthis.format = format;\n\t\tthis.maxBitRate = maxBitRate;\n\t\tthis.duration = duration;\n\t\tif (maxBitRate <= 0) {\n\t\t\tthis.maxBitRate = 128;\n\t\t}\n\t}\n\n\tstatic needsTranscoding(mediaFormat: string, format: string, maxBitRate: number): boolean {\n\t\treturn (format !== mediaFormat) || (maxBitRate > 0);\n\t}\n\n\tstatic validTranscoding(format: AudioFormatType): boolean {\n\t\treturn SupportedTranscodeAudioFormat.indexOf(format) >= 0;\n\t}\n\n\tstatic async getAvailableFormats(): Promise<Array<{ format: string, name: string }>> {\n\t\treturn new Promise<Array<{ format: string, name: string }>>((resolve, reject) => {\n\t\t\tffmpeg().getAvailableFormats((err, formats) => {\n\t\t\t\tif (err || !formats) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tresolve(Object.keys(formats).filter(key => formats[key].canDemux).map(key => {\n\t\t\t\t\treturn {format: key, name: formats[key].description};\n\t\t\t\t}));\n\t\t\t});\n\t\t});\n\t}\n\n\t//\n\t// private getSize(cb: (length: number) => void) {\n\t// \tif (this.duration !== undefined && this.duration > 0) {\n\t// \t\tconst length = Math.round((this.maxBitRate * 1000 * this.duration) / 8);\n\t// \t\treturn cb(length);\n\t// \t}\n\t// \tffmpeg.ffprobe(this.filename, (err, metadata) => {\n\t// \t\tlet length = 0;\n\t// \t\tif (metadata && metadata.format && metadata.format.duration) {\n\t// \t\t\tconst duration = metadata.format ? parseInt(metadata.format.duration, 10) : 0;\n\t// \t\t\tlength = Math.round((this.maxBitRate * 1000 * duration) / 8);\n\t// \t\t}\n\t// \t\tcb(length);\n\t// \t});\n\t// }\n\n\tpipe(stream: express.Response) {\n\t\tlog.info('Start transcode streaming', this.format, this.maxBitRate);\n\t\tconst proc = ffmpeg(<ffmpeg.FfmpegCommandOptions>{source: this.filename, nolog: true});\n\t\tif (this.format === AudioFormatType.mp3) {\n\t\t\tproc.withAudioCodec('libmp3lame');\n\t\t}\n\t\tproc.withNoVideo()\n\t\t\t.toFormat(this.format)\n\t\t\t.withAudioBitrate(this.maxBitRate + 'k')\n\t\t\t.on('end', () => {\n\t\t\t\tlog.debug('file has been transcoded successfully');\n\t\t\t})\n\t\t\t.on('error', (err: Error) => {\n\t\t\t\tlog.error('an error happened while transcoding: ' + err.message);\n\t\t\t});\n\t\tstream.contentType(this.format);\n\t\tproc.writeToStream(stream, {end: true});\n\t}\n\n}\n\nexport class PreTranscoder implements IStreamData {\n\tfilename: string;\n\tformat: string;\n\tmaxBitRate: number;\n\n\tconstructor(filename: string, format: string, maxBitRate: number) {\n\t\tthis.filename = filename;\n\t\tthis.format = format;\n\t\tthis.maxBitRate = maxBitRate;\n\t\tif (maxBitRate <= 0) {\n\t\t\tthis.maxBitRate = 128;\n\t\t}\n\t}\n\n\tpipe(stream: express.Response) {\n\t\tlog.info('Start transcode first and stream after', this.format, this.maxBitRate);\n\t\ttmp.file((err, filename, fd, cleanupCallback) => {\n\t\t\tif (err) {\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\tconst proc = ffmpeg(<ffmpeg.FfmpegCommandOptions>{source: this.filename, nolog: true});\n\t\t\tif (this.format === AudioFormatType.mp3) {\n\t\t\t\tproc.withAudioCodec('libmp3lame');\n\t\t\t}\n\t\t\tproc.withNoVideo()\n\t\t\t\t.toFormat(this.format)\n\t\t\t\t.withAudioBitrate(this.maxBitRate + 'k')\n\t\t\t\t.on('end', () => {\n\t\t\t\t\tlog.info('file has been transcoded successfully, sending it now');\n\t\t\t\t\tstream.contentType(this.format);\n\t\t\t\t\tstream.setHeader('Content-Length', fs.statSync(filename).size);\n\t\t\t\t\tconst rs = fs.createReadStream(filename, {autoClose: true});\n\t\t\t\t\trs.on('end', () => {\n\t\t\t\t\t\tcleanupCallback();\n\t\t\t\t\t});\n\t\t\t\t\trs.on('error', () => {\n\t\t\t\t\t\tcleanupCallback();\n\t\t\t\t\t});\n\t\t\t\t\trs.pipe(stream);\n\t\t\t\t})\n\t\t\t\t.on('error', (err2: Error) => {\n\t\t\t\t\tcleanupCallback();\n\t\t\t\t\tconst msg = 'an error happened while transcoding: ' + err2.message;\n\t\t\t\t\tstream.status(400).send(msg);\n\t\t\t\t\tlog.error(msg);\n\t\t\t\t});\n\t\t\tproc.save(filename);\n\t\t});\n\t}\n\n}\n","module.exports = require(\"tmp\");","import {DBObjectType} from '../../db/db.types';\nimport {BookmarkStore, SearchQueryBookmark} from './bookmark.store';\nimport {Bookmark} from './bookmark.model';\nimport {BaseStoreService} from '../base/base.service';\n\nexport class BookmarkService extends BaseStoreService<Bookmark, SearchQueryBookmark> {\n\n\tconstructor(public bookmarkStore: BookmarkStore) {\n\t\tsuper(bookmarkStore);\n\t}\n\n\tasync getAll(userID: string): Promise<Array<Bookmark>> {\n\t\treturn await this.bookmarkStore.search({userID});\n\t}\n\n\tasync get(trackID: string, userID: string): Promise<Bookmark | undefined> {\n\t\treturn await this.bookmarkStore.searchOne({userID, destID: trackID});\n\t}\n\n\tasync create(destID: string, userID: string, position: number, comment: string | undefined): Promise<Bookmark> {\n\t\tlet bookmark = await this.bookmarkStore.searchOne({destID, userID});\n\t\tif (!bookmark) {\n\t\t\tbookmark = {\n\t\t\t\tid: '',\n\t\t\t\ttype: DBObjectType.bookmark,\n\t\t\t\tdestID,\n\t\t\t\tuserID,\n\t\t\t\tposition,\n\t\t\t\tcomment,\n\t\t\t\tcreated: Date.now(),\n\t\t\t\tchanged: Date.now()\n\t\t\t};\n\t\t\tbookmark.id = await this.bookmarkStore.add(bookmark);\n\t\t} else {\n\t\t\tbookmark.comment = comment;\n\t\t\tbookmark.position = position;\n\t\t\tbookmark.changed = Date.now();\n\t\t\tawait this.bookmarkStore.replace(bookmark);\n\t\t}\n\t\treturn bookmark;\n\t}\n\n\tasync remove(trackID: string, userID: string): Promise<void> {\n\t\tawait this.bookmarkStore.removeByQuery({destID: trackID, userID});\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {SearchQueryState, StateStore} from './state.store';\nimport {State, States} from './state.model';\nimport {BaseStoreService} from '../base/base.service';\n\nexport class StateService extends BaseStoreService<State, SearchQueryState> {\n\n\tconstructor(public stateStore: StateStore) {\n\t\tsuper(stateStore);\n\t}\n\n\tprivate emptyState(destID: string, destType: DBObjectType, userID: string): State {\n\t\treturn {\n\t\t\tid: '',\n\t\t\ttype: DBObjectType.state,\n\t\t\tdestID,\n\t\t\tdestType,\n\t\t\tplayed: 0,\n\t\t\tlastplayed: 0,\n\t\t\tfaved: undefined,\n\t\t\trated: 0,\n\t\t\tuserID\n\t\t};\n\t}\n\n\tasync fav(id: string, type: DBObjectType, userID: string, remove: boolean): Promise<State> {\n\t\tconst state = await this.findOrCreate(id, userID, type);\n\t\tif (remove) {\n\t\t\tif (state.faved === undefined) {\n\t\t\t\treturn state;\n\t\t\t}\n\t\t\tstate.faved = undefined;\n\t\t} else {\n\t\t\tif (state.faved !== undefined) {\n\t\t\t\treturn state;\n\t\t\t}\n\t\t\tstate.faved = Date.now();\n\t\t}\n\t\tif (state.id.length === 0) {\n\t\t\tawait this.stateStore.add(state);\n\t\t} else {\n\t\t\tawait this.stateStore.replace(state);\n\t\t}\n\t\treturn state;\n\t}\n\n\tasync rate(id: string, type: DBObjectType, userID: string, rating: number): Promise<State> {\n\t\tconst state = await this.findOrCreate(id, userID, type);\n\t\tif (rating === 0) {\n\t\t\tstate.rated = undefined;\n\t\t} else {\n\t\t\tstate.rated = rating;\n\t\t}\n\t\tif (state.id.length === 0) {\n\t\t\tawait this.stateStore.add(state);\n\t\t} else {\n\t\t\tawait this.stateStore.replace(state);\n\t\t}\n\t\treturn state;\n\t}\n\n\tasync findOrCreate(destID: string, userID: string, type: DBObjectType): Promise<State> {\n\t\tconst state = await this.stateStore.searchOne({userID, destID, type});\n\t\treturn state || this.emptyState(destID, type, userID);\n\t}\n\n\tasync findOrCreateMany(destIDs: Array<string>, userID: string, type: DBObjectType): Promise<States> {\n\t\tif (!destIDs || destIDs.length === 0) {\n\t\t\treturn {};\n\t\t}\n\t\tconst list = await this.stateStore.search({userID, type, destIDs});\n\t\tconst result: { [id: string]: State } = {};\n\t\tlist.forEach((state) => {\n\t\t\tresult[state.destID] = state;\n\t\t});\n\t\tdestIDs.forEach((id) => {\n\t\t\tif (!result[id]) {\n\t\t\t\tresult[id] = this.emptyState(id, type, userID);\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t}\n\n\tasync getHighestRatedDestIDs(type: DBObjectType, userID: string): Promise<Array<string>> {\n\t\tconst states = await this.stateStore.search({userID, type, minRating: 1});\n\t\tconst ratings = states.filter(state => state.rated !== undefined).sort((a, b) => <number>b.rated - <number>a.rated);\n\t\treturn ratings.map(a => a.destID);\n\t}\n\n\tasync getAvgHighestDestIDs(type: DBObjectType): Promise<Array<string>> {\n\t\tconst states = await this.stateStore.search({type});\n\t\tconst ratings: { [id: string]: Array<number> } = {};\n\t\tstates.forEach(state => {\n\t\t\tif (state.rated !== undefined) {\n\t\t\t\tratings[state.destID] = ratings[state.destID] || [];\n\t\t\t\tratings[state.destID].push(state.rated);\n\t\t\t}\n\t\t});\n\t\tconst list = Object.keys(ratings).map(key => {\n\t\t\treturn {\n\t\t\t\tid: key,\n\t\t\t\tavg: ratings[key].reduce((b, c) => (b + c), 0) / ratings[key].length\n\t\t\t};\n\t\t}).sort((a, b) => (b.avg - a.avg));\n\t\treturn list.map(a => a.id);\n\t}\n\n\tasync getFrequentlyPlayedDestIDs(type: DBObjectType, userID: string): Promise<Array<string>> {\n\t\tconst states = await this.stateStore.search({userID, type, isPlayed: true});\n\t\tstates.sort((a, b) => b.played - a.played);\n\t\treturn states.map(a => a.destID);\n\t}\n\n\tasync getFavedDestIDs(type: DBObjectType, userID: string): Promise<Array<string>> {\n\t\tconst states = await this.stateStore.search({userID, type, isFaved: true});\n\t\tstates.sort((a, b) => <number>b.faved - <number>a.faved);\n\t\treturn states.map(a => a.destID);\n\t}\n\n\tasync getRecentlyPlayedDestIDs(type: DBObjectType, userID: string): Promise<Array<string>> {\n\t\tconst states = await this.stateStore.search({userID, type, isPlayed: true});\n\t\tstates.sort((a, b) => b.lastplayed - a.lastplayed);\n\t\treturn states.map(a => a.destID);\n\t}\n\n\tasync reportPlaying(id: string, type: DBObjectType, userID: string): Promise<State> {\n\t\tconst state = await this.findOrCreate(id, userID, type);\n\t\tstate.played++;\n\t\tstate.lastplayed = Date.now();\n\t\tawait this.stateStore.upsert([state]);\n\t\treturn state;\n\t}\n\n}\n","import {IApiBinaryResult} from '../../typings';\nimport {FolderType} from '../../model/jam-types';\nimport path from 'path';\nimport {ImageModule} from '../../modules/image/image.module';\nimport {Folder} from '../../objects/folder/folder.model';\nimport {Track} from '../../objects/track/track.model';\nimport {User} from '../../objects/user/user.model';\nimport {Album} from '../../objects/album/album.model';\nimport {Artist} from '../../objects/artist/artist.model';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport {Playlist} from '../../objects/playlist/playlist.model';\nimport {Podcast} from '../../objects/podcast/podcast.model';\nimport {FolderService} from '../../objects/folder/folder.service';\nimport {TrackService} from '../../objects/track/track.service';\nimport {ArtistService} from '../../objects/artist/artist.service';\nimport {AlbumService} from '../../objects/album/album.service';\nimport {UserService} from '../../objects/user/user.service';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\n\nexport class ImageService {\n\n\tconstructor(private imageModule: ImageModule, private trackService: TrackService,\n\t\t\t\tprivate folderService: FolderService, private artistService: ArtistService,\n\t\t\t\tprivate albumService: AlbumService, private userService: UserService) {\n\t}\n\n\tasync getObjImage(o: DBObject, size?: number, format?: string): Promise<IApiBinaryResult> {\n\t\tlet result: IApiBinaryResult | undefined;\n\t\tswitch (o.type) {\n\t\t\tcase DBObjectType.track:\n\t\t\t\tconst track = <Track>o;\n\t\t\t\tresult = await this.trackService.getTrackImage(track, size, format);\n\t\t\t\tbreak;\n\t\t\tcase DBObjectType.folder:\n\t\t\t\tconst folder = <Folder>o;\n\t\t\t\tresult = await this.folderService.getFolderImage(folder, size, format);\n\t\t\t\tbreak;\n\t\t\tcase DBObjectType.artist:\n\t\t\t\tconst artist = <Artist>o;\n\t\t\t\tresult = await this.artistService.getArtistImage(artist, size, format);\n\t\t\t\tbreak;\n\t\t\tcase DBObjectType.album:\n\t\t\t\tconst album = <Album>o;\n\t\t\t\tresult = await this.albumService.getAlbumImage(album, size, format);\n\t\t\t\tbreak;\n\t\t\tcase DBObjectType.user:\n\t\t\t\tconst user = <User>o;\n\t\t\t\tresult = await this.userService.getUserImage(user, size, format);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t\tif (!result) {\n\t\t\treturn this.paintImage(o, size, format);\n\t\t} else {\n\t\t\treturn result;\n\t\t}\n\t}\n\n\tasync paintImage(obj: DBObject, size?: number, format?: string): Promise<IApiBinaryResult> {\n\t\tconst getCoverArtText = (o: DBObject): string => {\n\t\t\tswitch (o.type) {\n\t\t\t\tcase DBObjectType.track:\n\t\t\t\t\tconst track = <Track>o;\n\t\t\t\t\treturn track.tag && track.tag.title ? track.tag.title : path.basename(track.path);\n\t\t\t\tcase DBObjectType.folder:\n\t\t\t\t\tconst folder = <Folder>o;\n\t\t\t\t\tlet result: string | undefined;\n\t\t\t\t\tif (folder.tag) {\n\t\t\t\t\t\tif (folder.tag.type === FolderType.artist) {\n\t\t\t\t\t\t\tresult = folder.tag.artist;\n\t\t\t\t\t\t} else if ([FolderType.multialbum, FolderType.album].indexOf(folder.tag.type) >= 0) {\n\t\t\t\t\t\t\tresult = folder.tag.album;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!result || result.length === 0) {\n\t\t\t\t\t\tresult = path.basename(folder.path);\n\t\t\t\t\t}\n\t\t\t\t\treturn result;\n\t\t\t\tcase DBObjectType.episode:\n\t\t\t\t\tconst episode: Episode = <Episode>o;\n\t\t\t\t\tlet text: string | undefined = episode.tag ? episode.tag.title : undefined;\n\t\t\t\t\tif (!text && episode.path) {\n\t\t\t\t\t\ttext = path.basename(episode.path);\n\t\t\t\t\t}\n\t\t\t\t\tif (!text) {\n\t\t\t\t\t\ttext = 'podcast';\n\t\t\t\t\t}\n\t\t\t\t\treturn text;\n\t\t\t\tcase DBObjectType.playlist:\n\t\t\t\t\tconst playlist: Playlist = <Playlist>o;\n\t\t\t\t\treturn playlist.name;\n\t\t\t\tcase DBObjectType.podcast:\n\t\t\t\t\tconst podcast: Podcast = <Podcast>o;\n\t\t\t\t\treturn podcast.tag ? podcast.tag.title : podcast.url;\n\t\t\t\tcase DBObjectType.album:\n\t\t\t\t\tconst album: Album = <Album>o;\n\t\t\t\t\treturn album.name;\n\t\t\t\tcase DBObjectType.artist:\n\t\t\t\t\tconst artist: Artist = <Artist>o;\n\t\t\t\t\treturn artist.name;\n\t\t\t\tcase DBObjectType.user:\n\t\t\t\t\tconst user: User = <User>o;\n\t\t\t\t\treturn user.name;\n\t\t\t\tdefault:\n\t\t\t\t\treturn DBObjectType[o.type];\n\t\t\t}\n\t\t};\n\t\tconst s = getCoverArtText(obj);\n\t\treturn this.imageModule.paint(s, size || 128, format);\n\t}\n\n}\n","import {IApiBinaryResult} from '../../typings';\nimport path from 'path';\nimport {CompressFolderStream, CompressListStream} from '../../utils/compress-stream';\nimport {DBObjectType} from '../../db/db.types';\nimport {User} from '../../objects/user/user.model';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Track} from '../../objects/track/track.model';\nimport {Folder} from '../../objects/folder/folder.model';\nimport {Artist} from '../../objects/artist/artist.model';\nimport {Album} from '../../objects/album/album.model';\nimport {Playlist} from '../../objects/playlist/playlist.model';\nimport {TrackStore} from '../../objects/track/track.store';\nimport {Episode} from '../../objects/episode/episode.model';\n\nexport class DownloadService {\n\n\tconstructor(private trackStore: TrackStore) {\n\n\t}\n\n\tprivate async downloadEpisode(episode: Episode, format?: string): Promise<IApiBinaryResult> {\n\t\tif (!episode.path) {\n\t\t\treturn Promise.reject(Error('Podcast episode not ready'));\n\t\t}\n\t\treturn {pipe: new CompressListStream([episode.path], path.basename(episode.path), format)};\n\t}\n\n\tprivate async downloadTrack(track: Track, format?: string): Promise<IApiBinaryResult> {\n\t\treturn {pipe: new CompressListStream([path.join(track.path, track.name)], path.basename(track.name), format)};\n\t}\n\n\tprivate async downloadFolder(folder: Folder, format?: string): Promise<IApiBinaryResult> {\n\t\treturn {pipe: new CompressFolderStream(folder.path, path.basename(folder.path), format)};\n\t}\n\n\tprivate async downloadArtist(artist: Artist, format?: string): Promise<IApiBinaryResult> {\n\t\tconst tracks = await this.trackStore.byIds(artist.trackIDs);\n\t\tconst fileList = tracks.map(t => path.join(t.path, t.name));\n\t\treturn {pipe: new CompressListStream(fileList, artist.name, format)};\n\t}\n\n\tprivate async downloadAlbum(album: Album, format?: string): Promise<IApiBinaryResult> {\n\t\tconst tracks = await this.trackStore.byIds(album.trackIDs);\n\t\tconst fileList = tracks.map(t => path.join(t.path, t.name));\n\t\treturn {pipe: new CompressListStream(fileList, album.name, format)};\n\t}\n\n\tprivate async downloadPlaylist(playlist: Playlist, format: string | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tif (playlist.userID !== user.id && !playlist.isPublic) {\n\t\t\treturn Promise.reject(Error('Unauthorized'));\n\t\t}\n\t\tconst tracks = await this.trackStore.byIds(playlist.trackIDs);\n\t\tconst fileList = tracks.map(t => path.join(t.path, t.name));\n\t\t// TODO: add playlist index file m3u/pls\n\t\treturn {pipe: new CompressListStream(fileList, playlist.name, format)};\n\t}\n\n\tasync getObjDownload(o: DBObject, format: string | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tswitch (o.type) {\n\t\t\tcase DBObjectType.track:\n\t\t\t\treturn this.downloadTrack(<Track>o, format);\n\t\t\tcase DBObjectType.folder:\n\t\t\t\treturn this.downloadFolder(<Folder>o, format);\n\t\t\tcase DBObjectType.artist:\n\t\t\t\treturn this.downloadArtist(<Artist>o, format);\n\t\t\tcase DBObjectType.album:\n\t\t\t\treturn this.downloadAlbum(<Album>o, format);\n\t\t\tcase DBObjectType.episode:\n\t\t\t\treturn this.downloadEpisode(<Episode>o, format);\n\t\t\tcase DBObjectType.playlist:\n\t\t\t\treturn this.downloadPlaylist(<Playlist>o, format, user);\n\t\t}\n\t\treturn Promise.reject(Error('Invalid Download Type'));\n\t}\n\n}\n","import archiver from 'archiver';\nimport express from 'express';\nimport {IStreamData} from '../typings';\nimport * as path from 'path';\nimport {replaceFileSystemChars} from './fs-utils';\n\nabstract class BaseCompressStream implements IStreamData {\n\tpublic filename: string;\n\tpublic streaming = true;\n\tpublic format: string;\n\n\tprotected constructor(filename: string, format?: string) {\n\t\tthis.filename = replaceFileSystemChars(filename, '_').replace(/ /g, '_');\n\t\tthis.format = format || 'zip';\n\t\tif (!CompressListStream.isSupportedFormat(this.format)) {\n\t\t\tthrow new Error('Unsupported Download Format');\n\t\t}\n\t}\n\n\tstatic isSupportedFormat(format: string): boolean {\n\t\treturn ['zip', 'tar'].indexOf(format) >= 0;\n\t}\n\n\tpipe(stream: express.Response) {\n\t\t// logger.verbose('Start streaming');\n\t\tconst format = 'zip';\n\t\tconst archive = archiver(<archiver.Format>this.format, {zlib: {level: 0}});\n\t\tarchive.on('error', (err) => {\n\t\t\t// logger.error('archiver err ' + err);\n\t\t\tthrow err;\n\t\t});\n\t\tstream.contentType('zip');\n\t\tstream.setHeader('Content-Disposition', 'attachment; filename=\"' + (this.filename || 'download') + '.' + format + '\"');\n\t\t// stream.setHeader('Content-Length', stat.size); do NOT report wrong size!\n\t\tstream.on('finish', () => {\n\t\t\t// logger.verbose('streamed ' + archive.pointer() + ' total bytes');\n\t\t\tthis.streaming = false;\n\t\t});\n\t\tarchive.pipe(stream);\n\t\tthis.run(archive);\n\t\tarchive.finalize();\n\t}\n\n\tprotected abstract run(archive: archiver.Archiver): void;\n}\n\n\nexport class CompressFolderStream extends BaseCompressStream {\n\n\tconstructor(public folder: string, filename: string, format?: string) {\n\t\tsuper(filename, format);\n\t}\n\n\tprotected run(archive: archiver.Archiver): void {\n\t\tarchive.directory(this.folder, false);\n\t}\n}\n\nexport class CompressListStream extends BaseCompressStream {\n\tpublic list: Array<string> = [];\n\n\tconstructor(list: Array<string>, filename: string, format?: string) {\n\t\tsuper(filename, format);\n\t\tthis.list = list;\n\t}\n\n\tprotected run(archive: archiver.Archiver): void {\n\t\tthis.list.forEach(file => {\n\t\t\tarchive.file(file, {name: path.basename(file)});\n\t\t});\n\t}\n\n}\n","module.exports = require(\"archiver\");","import {DBObjectType} from '../../db/db.types';\nimport {Radio} from './radio.model';\nimport {RadioStore, SearchQueryRadio} from './radio.store';\nimport {BaseStoreService} from '../base/base.service';\n\nexport class RadioService extends BaseStoreService<Radio, SearchQueryRadio> {\n\n\tconstructor(public radioStore: RadioStore) {\n\t\tsuper(radioStore);\n\t}\n\n\tasync create(name: string, url: string, homepageUrl?: string): Promise<Radio> {\n\t\tconst radio: Radio = {\n\t\t\tid: '',\n\t\t\ttype: DBObjectType.radio,\n\t\t\tname,\n\t\t\thomepage: homepageUrl,\n\t\t\turl,\n\t\t\tcreated: Date.now(),\n\t\t\tchanged: Date.now()\n\t\t};\n\t\tradio.id = await this.radioStore.add(radio);\n\t\treturn radio;\n\t}\n\n\tasync update(radio: Radio, name?: string, url?: string, homepageUrl?: string): Promise<void> {\n\t\tradio.homepage = homepageUrl || radio.homepage;\n\t\tradio.url = url || radio.url;\n\t\tradio.name = name || radio.name;\n\t\tradio.changed = Date.now();\n\t\tawait this.radioStore.replace(radio);\n\t}\n\n\tasync remove(radio: Radio): Promise<void> {\n\t\tawait this.radioStore.remove(radio.id);\n\t}\n}\n","import {Artwork, Folder} from './folder.model';\nimport {FolderStore, SearchQueryFolder} from './folder.store';\nimport {containsFolderSystemChars, ensureTrailingPathSeparator, fileDeleteIfExists, replaceFolderSystemChars} from '../../utils/fs-utils';\nimport {TrackStore} from '../track/track.store';\nimport path from 'path';\nimport fse from 'fs-extra';\nimport Logger from '../../utils/logger';\nimport {IApiBinaryResult} from '../../typings';\nimport {ArtworkImageType, FolderTypeImageName} from '../../model/jam-types';\nimport {ImageModule} from '../../modules/image/image.module';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\nimport {generateArtworkId} from '../../engine/scan/scan.service';\n\nconst log = Logger('FolderService');\n\nexport class FolderService extends BaseListService<Folder, SearchQueryFolder> {\n\n\tconstructor(public folderStore: FolderStore, private trackStore: TrackStore, stateService: StateService, public imageModule: ImageModule) {\n\t\tsuper(folderStore, stateService);\n\t}\n\n\tasync renameFolder(folder: Folder, name: string): Promise<void> {\n\t\tif (containsFolderSystemChars(name)) {\n\t\t\treturn Promise.reject(Error('Invalid Folder Name'));\n\t\t}\n\t\tname = replaceFolderSystemChars(name, '').trim();\n\t\tif (name.length === 0 || ['.', '..'].indexOf(name) >= 0) {\n\t\t\treturn Promise.reject(Error('Invalid Folder Name'));\n\t\t}\n\t\tconst p = path.dirname(folder.path);\n\t\tconst newPath = path.join(p, name);\n\t\tconst exists = await fse.pathExists(newPath);\n\t\tif (exists) {\n\t\t\treturn Promise.reject(Error('Directory already exists'));\n\t\t}\n\t\tawait fse.rename(folder.path, newPath);\n\t\tconst folders = await this.folderStore.search({inPath: folder.path});\n\t\tfor (const f of folders) {\n\t\t\tconst rest = f.path.slice(folder.path.length - 1);\n\t\t\tif (rest.length > 0 && rest[0] !== path.sep) {\n\t\t\t\tlog.error('WRONG inPath MATCH', rest, folder.path, f.path);\n\t\t\t} else {\n\t\t\t\tf.path = newPath + ensureTrailingPathSeparator(rest);\n\t\t\t\tawait this.folderStore.replace(f);\n\t\t\t}\n\t\t}\n\t\tconst tracks = await this.trackStore.search({inPath: folder.path});\n\t\tfor (const t of tracks) {\n\t\t\tt.path = t.path.replace(folder.path, ensureTrailingPathSeparator(newPath));\n\t\t\tawait this.trackStore.replace(t);\n\t\t}\n\t\tfolder.path = ensureTrailingPathSeparator(newPath);\n\t}\n\n\tasync collectFolderPath(folderId: string | undefined): Promise<Array<Folder>> {\n\t\tconst result: Array<Folder> = [];\n\t\tconst store = this.folderStore;\n\n\t\tasync function collect(id?: string): Promise<void> {\n\t\t\tif (!id) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst folder = await store.byId(id);\n\t\t\tif (folder) {\n\t\t\t\tresult.unshift(folder);\n\t\t\t\tawait collect(folder.parentID);\n\t\t\t}\n\t\t}\n\n\t\tawait collect(folderId);\n\t\treturn result;\n\t}\n\n\tasync getFolderImage(folder: Folder, size?: number, format?: string): Promise<IApiBinaryResult | undefined> {\n\t\tif (!folder.tag.image) {\n\t\t\tif (!folder.tag.image) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\treturn await this.imageModule.get(folder.id, path.join(folder.path, folder.tag.image), size, format);\n\t}\n\n\tasync setFolderImage(folder: Folder, filename: string): Promise<void> {\n\t\tconst destFileName = FolderTypeImageName[folder.tag.type] + path.extname(filename);\n\t\tconst destName = path.join(folder.path, destFileName);\n\t\tawait fileDeleteIfExists(destName);\n\t\tawait fse.copy(filename, destName);\n\t\tfolder.tag.image = destFileName;\n\t\tawait this.folderStore.replace(folder);\n\t}\n\n\tasync getArtworkImage(folder: Folder, artwork: Artwork, size?: number, format?: string): Promise<IApiBinaryResult> {\n\t\treturn await this.imageModule.get(artwork.id, path.join(folder.path, artwork.name), size, format);\n\t}\n\n\tasync setFrontArtworkImage(folder: Folder): Promise<void> {\n\t\tif (folder.tag.image) {\n\t\t\treturn;\n\t\t}\n\t\tif (folder.tag.artworks) {\n\t\t\tconst artwork = folder.tag.artworks.find(a => a.types.indexOf(ArtworkImageType.front) >= 0);\n\t\t\tif (artwork) {\n\t\t\t\tfolder.tag.image = artwork.name;\n\t\t\t\tawait this.folderStore.replace(folder);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync removeArtworkImage(folder: Folder, artwork: Artwork): Promise<void> {\n\t\tif (!folder.tag.artworks) {\n\t\t\treturn;\n\t\t}\n\t\tfolder.tag.artworks = (folder.tag.artworks || []).filter(art => art.id !== artwork.id);\n\t\tconst clearID = [];\n\t\tif (folder.tag.image === artwork.name) {\n\t\t\tfolder.tag.image = undefined;\n\t\t\tclearID.push(folder.id);\n\t\t}\n\t\tclearID.push(artwork.id);\n\t\tawait this.folderStore.replace(folder);\n\t\tconst destName = path.join(folder.path, artwork.name);\n\t\tawait fileDeleteIfExists(destName);\n\t\tconsole.log(clearID);\n\t\tawait this.imageModule.clearImageCacheByIDs(clearID);\n\t\tawait this.setFrontArtworkImage(folder);\n\t}\n\n\tasync downloadFolderArtwork(folder: Folder, imageUrl: string, types: Array<ArtworkImageType>): Promise<Artwork> {\n\t\tconst name = types.sort((a, b) => a.localeCompare(b)).join('-');\n\t\tconst filename = await this.imageModule.storeImage(folder.path, name, imageUrl);\n\t\tconst stat = await fse.stat(path.join(folder.path, filename));\n\t\tconst artwork = {\n\t\t\tid: generateArtworkId(folder.id, filename),\n\t\t\tname: filename,\n\t\t\ttypes,\n\t\t\tstat: {\n\t\t\t\tcreated: stat.ctime.valueOf(),\n\t\t\t\tmodified: stat.mtime.valueOf(),\n\t\t\t\tsize: stat.size\n\t\t\t}\n\t\t};\n\t\tfolder.tag.artworks = folder.tag.artworks || [];\n\t\tfolder.tag.artworks.push(artwork);\n\t\tawait this.folderStore.replace(folder);\n\t\tawait this.setFrontArtworkImage(folder);\n\t\treturn artwork;\n\t}\n\n}\n","import path from 'path';\nimport Logger from '../../utils/logger';\nimport {downloadFile} from '../../utils/download';\nimport {fileDeleteIfExists} from '../../utils/fs-utils';\nimport {IApiBinaryResult} from '../../typings';\nimport Jimp from 'jimp';\nimport mimeTypes from 'mime-types';\nimport {DebouncePromises} from '../../utils/debounce-promises';\nimport fse from 'fs-extra';\nimport {SupportedWriteImageFormat} from '../../utils/filetype';\n\ntype JimpFont = any;\n\nconst log = Logger('Images');\n\n/**\n * Handles image access/reading/writing/transforming\n */\n\nexport class ImageModule {\n\tprivate format = 'png';\n\tprivate font: JimpFont | undefined;\n\tprivate imageCacheDebounce = new DebouncePromises<IApiBinaryResult>();\n\n\tconstructor(private imageCachePath: string) {\n\t}\n\n\tasync storeImage(filepath: string, name: string, imageUrl: string): Promise<string> {\n\t\tlog.debug('Requesting image', imageUrl);\n\t\tconst imageext = path.extname(imageUrl).split('?')[0].trim().toLowerCase();\n\t\tif (imageext.length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid Image Url'));\n\t\t}\n\t\tlet filename = name + imageext;\n\t\tlet nr = 2;\n\t\twhile (await fse.pathExists(path.join(filepath, filename))) {\n\t\t\tfilename = name + '-' + nr + imageext;\n\t\t\tnr++;\n\t\t}\n\t\tawait downloadFile(imageUrl, path.join(filepath, filename));\n\t\tlog.info('image downloaded', filename);\n\t\treturn filename;\n\t}\n\n\tasync paint(text: string, size: number | undefined, format: string | undefined): Promise<IApiBinaryResult> {\n\t\tsize = size || 320;\n\t\tconst image = new Jimp(360, 360, '#282828');\n\t\tif (!this.font) {\n\t\t\tthis.font = await Jimp.loadFont(Jimp.FONT_SANS_32_WHITE);\n\t\t}\n\t\timage.print(this.font, 10, 10, {\n\t\t\ttext: text,\n\t\t\talignmentX: Jimp.HORIZONTAL_ALIGN_CENTER,\n\t\t\talignmentY: Jimp.VERTICAL_ALIGN_MIDDLE\n\t\t}, 340, 340);\n\t\t// image.greyscale();\n\t\timage.resize(size, size);\n\t\tconst mime = mimeTypes.lookup(format ? format : this.format);\n\t\tif (!mime) {\n\t\t\treturn Promise.reject('Unknown Image Format Request');\n\t\t}\n\t\tconst buffer = await image.getBufferAsync(mime);\n\t\treturn {\n\t\t\tbuffer: {\n\t\t\t\tbuffer: buffer,\n\t\t\t\tcontentType: mime\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async getImage(filename: string, size: number | undefined, name: string): Promise<IApiBinaryResult> {\n\t\tlet fileFormat = path.extname(filename);\n\t\tif (fileFormat[0] === '.') {\n\t\t\tfileFormat = fileFormat.slice(1);\n\t\t}\n\t\treturn this.getImageAs(filename, fileFormat, size, name);\n\t}\n\n\tprivate async getImageAs(filename: string, format: string, size: number | undefined, name: string): Promise<IApiBinaryResult> {\n\t\tlet fileFormat = path.extname(filename);\n\t\tif (fileFormat[0] === '.') {\n\t\t\tfileFormat = fileFormat.slice(1);\n\t\t}\n\t\tconst exists = await fse.pathExists(filename);\n\t\tif (!exists) {\n\t\t\treturn Promise.reject(Error('File not found'));\n\t\t}\n\t\tif (size || (fileFormat !== format)) {\n\t\t\tconst image = await Jimp.read(filename);\n\t\t\tconst mime = mimeTypes.lookup(format);\n\t\t\tif (!mime) {\n\t\t\t\treturn Promise.reject('Unknown Image Format Request');\n\t\t\t}\n\t\t\tif (size) {\n\t\t\t\timage.crop(1, 1, image.getWidth() - 2, image.getHeight() - 2);\n\t\t\t\t// image.autocrop({cropOnlyFrames: false, tolerance: 0.0004, cropSymmetric: true});\n\t\t\t\timage.contain(size, size);\n\t\t\t}\n\t\t\tconst buffer = await image.getBufferAsync(mime);\n\t\t\treturn {\n\t\t\t\tbuffer: {\n\t\t\t\t\tbuffer: buffer,\n\t\t\t\t\tcontentType: mime\n\t\t\t\t}\n\t\t\t};\n\t\t} else {\n\t\t\treturn {file: {filename, name}};\n\t\t}\n\t}\n\n\tasync get(id: string, filename: string, size: number | undefined, format?: string): Promise<IApiBinaryResult> {\n\t\tif (!filename) {\n\t\t\treturn Promise.reject(Error('Invalid Path'));\n\t\t}\n\t\tif (format && SupportedWriteImageFormat.indexOf(format) < 0) {\n\t\t\treturn Promise.reject(Error('Invalid Format'));\n\t\t}\n\t\tif (format || size) {\n\t\t\tconst cacheID = 'thumb-' + id + (size ? '-' + size : '') + '.' + (format || this.format);\n\t\t\tif (this.imageCacheDebounce.isPending(cacheID)) {\n\t\t\t\treturn this.imageCacheDebounce.append(cacheID);\n\t\t\t}\n\t\t\tthis.imageCacheDebounce.setPending(cacheID);\n\t\t\ttry {\n\t\t\t\tlet result: IApiBinaryResult;\n\t\t\t\tconst cachefile = path.join(this.imageCachePath, cacheID);\n\t\t\t\tconst exists = await fse.pathExists(cachefile);\n\t\t\t\tif (exists) {\n\t\t\t\t\tresult = {file: {filename: cachefile, name: cacheID}};\n\t\t\t\t} else {\n\t\t\t\t\tif (format) {\n\t\t\t\t\t\tresult = await this.getImageAs(filename, format, size, cacheID);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult = await this.getImage(filename, size, cacheID);\n\t\t\t\t\t}\n\t\t\t\t\tif (result.buffer) {\n\t\t\t\t\t\tlog.debug('Writing image cache file', cachefile);\n\t\t\t\t\t\tawait fse.writeFile(cachefile, result.buffer.buffer);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tawait this.imageCacheDebounce.resolve(cacheID, result);\n\t\t\t\treturn result;\n\t\t\t} catch (e) {\n\t\t\t\tawait this.imageCacheDebounce.reject(cacheID, e);\n\t\t\t\treturn Promise.reject(e);\n\t\t\t}\n\t\t} else {\n\t\t\treturn this.getImage(filename, size, id + '.' + (format || this.format));\n\t\t}\n\t}\n\n\tasync resizeImage(filename: string, destination: string, size: number): Promise<void> {\n\t\tconst image = await Jimp.read(filename);\n\t\timage.contain(size, size);\n\t\tawait image.writeAsync(destination);\n\t}\n\n\tasync clearImageCacheByIDs(ids: Array<string>): Promise<void> {\n\t\tconst searches = ids.filter(id => id.length > 0).map(id => 'thumb-' + id);\n\t\tif (searches.length > 0) {\n\t\t\tlet list = await fse.readdir(this.imageCachePath);\n\t\t\tlist = list.filter(name => {\n\t\t\t\treturn searches.findIndex(s => name.indexOf(s) === 0) >= 0;\n\t\t\t});\n\t\t\tfor (const filename of list) {\n\t\t\t\tawait fse.unlink(path.resolve(this.imageCachePath, filename));\n\t\t\t}\n\t\t}\n\t}\n\n\tasync clearImageCacheByID(id: string): Promise<void> {\n\t\tif (id.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst search = 'thumb-' + id;\n\t\tlet list = await fse.readdir(this.imageCachePath);\n\t\tlist = list.filter(name => name.indexOf(search) === 0);\n\t\tfor (const filename of list) {\n\t\t\tawait fse.unlink(path.resolve(this.imageCachePath, filename));\n\t\t}\n\t}\n\n\tasync createAvatar(filename: string, destination: string): Promise<void> {\n\t\tif ((!filename)) {\n\t\t\treturn Promise.reject(Error('Invalid Path'));\n\t\t}\n\t\tconst exists = await fse.pathExists(filename);\n\t\tif (!exists) {\n\t\t\treturn Promise.reject(Error('File not found'));\n\t\t}\n\t\tawait this.resizeImage(filename, filename + '.new', 64);\n\t\tawait fileDeleteIfExists(destination);\n\t\tawait fse.rename(filename + '.new', destination);\n\t}\n\n}\n","module.exports = require(\"http\");","module.exports = require(\"jimp\");","module.exports = require(\"mime-types\");","import {Track} from './track.model';\nimport {IApiBinaryResult} from '../../typings';\nimport {SearchQueryTrack, TrackStore} from './track.store';\nimport {FolderService} from '../folder/folder.service';\nimport {Folder} from '../folder/folder.model';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\nimport {replaceFileSystemChars} from '../../utils/fs-utils';\nimport path from 'path';\nimport fse from 'fs-extra';\n\nexport class TrackService extends BaseListService<Track, SearchQueryTrack> {\n\n\tconstructor(public trackStore: TrackStore, private folderService: FolderService, stateService: StateService) {\n\t\tsuper(trackStore, stateService);\n\t}\n\n\tasync getTrackFolder(track: Track): Promise<Folder | undefined> {\n\t\treturn await this.folderService.folderStore.byId(track.parentID);\n\t}\n\n\tasync getTrackImage(track: Track, size?: number, format?: string): Promise<IApiBinaryResult | undefined> {\n\t\tconst folder = await this.getTrackFolder(track);\n\t\tif (folder) {\n\t\t\treturn this.folderService.getFolderImage(folder, size, format);\n\t\t}\n\t}\n\n\tasync renameTrack(track: Track, name: string): Promise<void> {\n\t\tname = replaceFileSystemChars(name, '').trim();\n\t\tif (name.length === 0) {\n\t\t\treturn Promise.reject(Error('Invalid Name'));\n\t\t}\n\t\tconst ext = path.extname(name).toLowerCase();\n\t\tconst ext2 = path.extname(track.name).toLowerCase();\n\t\tif (ext !== ext2) {\n\t\t\treturn Promise.reject(Error('Changing File extension not supported ' + ext + '=>' + ext2));\n\t\t}\n\t\tconst newPath = path.join(track.path, name);\n\t\tconst exists = await fse.pathExists(newPath);\n\t\tif (exists) {\n\t\t\treturn Promise.reject(Error('File already exists'));\n\t\t}\n\t\tawait fse.rename(path.join(track.path, track.name), path.join(track.path, name));\n\t\ttrack.name = name;\n\t\tawait this.trackStore.upsert([track]);\n\t}\n}\n","import {IApiBinaryResult} from '../../typings';\nimport {TrackStore} from '../track/track.store';\nimport {FolderService} from '../folder/folder.service';\nimport {Artist} from './artist.model';\nimport {ArtworkImageType, FolderType} from '../../model/jam-types';\nimport {ArtistStore, SearchQueryArtist} from './artist.store';\nimport {Folder} from '../folder/folder.model';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\nimport {cVariousArtist} from '../../engine/scan/scan.service';\n\nexport class ArtistService extends BaseListService<Artist, SearchQueryArtist> {\n\n\n\tconstructor(public artistStore: ArtistStore, private trackStore: TrackStore, private folderService: FolderService, stateService: StateService) {\n\t\tsuper(artistStore, stateService);\n\t}\n\n\tasync getArtistFolder(artist: Artist): Promise<Folder | undefined> {\n\t\tif (artist.trackIDs.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst track = await this.trackStore.byId(artist.trackIDs[0]);\n\t\tif (!track) {\n\t\t\treturn;\n\t\t}\n\t\tconst folders = await this.folderService.collectFolderPath(track.parentID);\n\t\tif (folders.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tlet folder = folders.find(f => f.tag.type === FolderType.artist);\n\t\tif (!folder) {\n\t\t\tfolder = folders[folders.length - 1];\n\t\t}\n\t\treturn folder;\n\t}\n\n\tasync getArtistImage(artist: Artist, size?: number, format?: string): Promise<IApiBinaryResult | undefined> {\n\t\tif (artist.name === cVariousArtist) {\n\t\t\treturn this.folderService.imageModule.paint(cVariousArtist, size, format);\n\t\t}\n\t\tconst folder = await this.getArtistFolder(artist);\n\t\tif (folder) {\n\t\t\treturn this.folderService.getFolderImage(folder, size, format);\n\t\t}\n\t}\n\n}\n","import {Album} from './album.model';\nimport {IApiBinaryResult} from '../../typings';\nimport {TrackStore} from '../track/track.store';\nimport {AlbumStore, SearchQueryAlbum} from './album.store';\nimport {FolderService} from '../folder/folder.service';\nimport {ArtworkImageType, FolderTypesAlbum} from '../../model/jam-types';\nimport {Folder} from '../folder/folder.model';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\n\nexport class AlbumService extends BaseListService<Album, SearchQueryAlbum> {\n\n\tconstructor(public albumStore: AlbumStore, private trackStore: TrackStore, private folderService: FolderService, stateService: StateService) {\n\t\tsuper(albumStore, stateService);\n\t}\n\n\tasync getAlbumFolder(album: Album): Promise<Folder | undefined> {\n\t\tif (album.trackIDs.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst track = await this.trackStore.byId(album.trackIDs[0]);\n\t\tif (!track) {\n\t\t\treturn;\n\t\t}\n\t\tlet folders = await this.folderService.collectFolderPath(track.parentID);\n\t\tif (folders.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tfolders = folders.sort((a, b) => b.tag.level - a.tag.level);\n\t\tlet folder = folders[0];\n\t\tfor (const f of folders) {\n\t\t\tif (FolderTypesAlbum.indexOf(f.tag.type) >= 0) {\n\t\t\t\tfolder = f;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn folder;\n\t}\n\n\tasync getAlbumImage(album: Album, size?: number, format?: string): Promise<IApiBinaryResult | undefined> {\n\t\tconst folder = await this.getAlbumFolder(album);\n\t\tif (folder) {\n\t\t\treturn this.folderService.getFolderImage(folder, size, format);\n\t\t}\n\t}\n}\n","import {fileDeleteIfExists, fileSuffix, pathDeleteIfExists} from '../../utils/fs-utils';\nimport {SupportedAudioFormat} from '../../utils/filetype';\nimport path from 'path';\nimport Logger from '../../utils/logger';\nimport {AudioModule} from '../../modules/audio/audio.module';\nimport {downloadFile} from '../../utils/download';\nimport fse from 'fs-extra';\nimport {EpisodeStore, SearchQueryEpisode} from './episode.store';\nimport {Episode} from './episode.model';\nimport {AudioFormatType, PodcastStatus} from '../../model/jam-types';\nimport {DebouncePromises} from '../../utils/debounce-promises';\nimport {BaseListService} from '../base/base.list.service';\nimport {StateService} from '../state/state.service';\n\nconst log = Logger('EpisodeService');\n\nexport class EpisodeService extends BaseListService<Episode, SearchQueryEpisode> {\n\tprivate episodeDownloadDebounce = new DebouncePromises<void>();\n\n\tconstructor(private podcastsPath: string, public episodeStore: EpisodeStore, stateService: StateService, private audioModule: AudioModule) {\n\t\tsuper(episodeStore, stateService);\n\t}\n\n\tisDownloading(podcastEpisodeId: string): boolean {\n\t\treturn this.episodeDownloadDebounce.isPending(podcastEpisodeId);\n\t}\n\n\tprivate async downloadEpisodeFile(episode: Episode): Promise<string> {\n\t\tlet url = '';\n\t\tif (episode.enclosures && episode.enclosures.length > 0) {\n\t\t\turl = episode.enclosures[0].url;\n\t\t} else {\n\t\t\tthrow new Error('No podcast episode url found');\n\t\t}\n\t\tconst suffix = fileSuffix(url);\n\t\tif (SupportedAudioFormat.indexOf(<AudioFormatType>suffix) < 0) {\n\t\t\tthrow new Error('Unsupported Podcast audio format');\n\t\t}\n\t\tconst p = path.resolve(this.podcastsPath, episode.podcastID);\n\t\tawait fse.ensureDir(p);\n\t\tconst filename = path.join(p, episode.id + '.' + suffix);\n\t\tlog.info('retrieving file', url);\n\t\tawait downloadFile(url, filename);\n\t\treturn filename;\n\t}\n\n\tasync downloadEpisode(episode: Episode): Promise<void> {\n\t\tif (this.episodeDownloadDebounce.isPending(episode.id)) {\n\t\t\treturn this.episodeDownloadDebounce.append(episode.id);\n\t\t}\n\t\tthis.episodeDownloadDebounce.setPending(episode.id);\n\t\ttry {\n\t\t\ttry {\n\t\t\t\tconst filename = await this.downloadEpisodeFile(episode);\n\t\t\t\tconst stat = await fse.stat(filename);\n\t\t\t\tconst result = await this.audioModule.read(filename);\n\t\t\t\tepisode.status = PodcastStatus.completed;\n\t\t\t\tepisode.tag = result.tag;\n\t\t\t\tepisode.media = result.media;\n\t\t\t\tepisode.stat = {\n\t\t\t\t\tcreated: stat.ctime.valueOf(),\n\t\t\t\t\tmodified: stat.mtime.valueOf(),\n\t\t\t\t\tsize: stat.size\n\t\t\t\t};\n\t\t\t\tepisode.path = filename;\n\t\t\t} catch (e) {\n\t\t\t\tepisode.status = PodcastStatus.error;\n\t\t\t\tepisode.error = (e || '').toString();\n\t\t\t}\n\t\t\tawait this.episodeStore.replace(episode);\n\t\t\tawait this.episodeDownloadDebounce.resolve(episode.id, undefined);\n\t\t} catch (e) {\n\t\t\tawait this.episodeDownloadDebounce.resolve(episode.id, undefined);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync removeEpisodes(podcastID: string): Promise<void> {\n\t\tconst removeEpisodes = await this.episodeStore.search({podcastID});\n\t\tconst ids = removeEpisodes.map(episode => episode.id);\n\t\tawait this.episodeStore.remove(ids);\n\t\tfor (const episode of removeEpisodes) {\n\t\t\tif (episode.path) {\n\t\t\t\tawait fileDeleteIfExists(episode.path);\n\t\t\t}\n\t\t}\n\t\tconst p = path.resolve(this.podcastsPath, podcastID);\n\t\tawait pathDeleteIfExists(p);\n\t}\n\n\tasync deleteEpisode(episode: Episode): Promise<void> {\n\t\tif (!episode.path) {\n\t\t\treturn;\n\t\t}\n\t\tawait fileDeleteIfExists(episode.path);\n\t\tepisode.path = undefined;\n\t\tepisode.stat = undefined;\n\t\tepisode.media = undefined;\n\t\tepisode.status = PodcastStatus.deleted;\n\t\tawait this.episodeStore.replace(episode);\n\t}\n\n\tasync mergeEpisodes(podcastID: string, episodes: Array<Episode>): Promise<Array<Episode>> {\n\t\tif ((!episodes) || (!episodes.length)) {\n\t\t\treturn [];\n\t\t}\n\t\tconst epi = await this.episodeStore.search({podcastID});\n\t\tconst links = epi.map(e => e.link);\n\t\tepisodes = episodes.filter(e => links.indexOf(e.link) < 0);\n\t\tawait this.episodeStore.upsert(episodes);\n\t\treturn episodes;\n\t}\n\n}\n","/*\n\tThird Party Web Services\n */\n\nimport {JAMSERVE_VERSION} from '../version';\n\nexport interface ThirdpartyToolsConfig {\n\tacoustid: {\n\t\tapiKey: string;\n\t\tuserAgent: string;\n\t};\n\tlastfm: {\n\t\tapiKey: string;\n\t\tuserAgent: string;\n\t};\n\tmusicbrainz: {\n\t\tuserAgent: string;\n\t};\n\tacousticbrainz: {\n\t\tuserAgent: string;\n\t};\n\tcoverartarchive: {\n\t\tuserAgent: string;\n\t};\n\tchartlyrics: {\n\t\tuserAgent: string;\n\t};\n\twikipedia: {\n\t\tuserAgent: string;\n\t};\n}\n\nexport const userAgent = 'JamServe/' + JAMSERVE_VERSION;\n\nexport const ThirdPartyConfig: ThirdpartyToolsConfig = {\n\t/*\n\t\tAcoustid\n\t\thttps://acoustid.org/\n\t\taudio identification via fingerprinting\n\t */\n\tacoustid: {apiKey: 'xuwbosoqd4', userAgent},\n\t/*\n\t\tLastFM\n\t\thttps://www.last.fm/api\n\t\tmusic database\n\t */\n\tlastfm: {apiKey: 'ead198fb293eefea29e8a5b8f0908e55', userAgent},\n\t/*\n\t\tMusicBrainz\n\t\thttps://musicbrainz.org/\n\t\topen music encyclopedia\n\t */\n\tmusicbrainz: {userAgent: userAgent + ' ( jamserve@protonmail.com )'},\n\t/*\n\t\tAcousticBrainz\n\t\thttps://acousticbrainz.org/\n\t\tcrowd sourced acoustic information\n \t*/\n\tacousticbrainz: {userAgent: userAgent + ' ( jamserve@protonmail.com )'},\n\t/*\n\t\tCoverArtArchive\n\t\thttps://coverartarchive.org/\n\t\tcover art from Internet Archive (archive.org) via musicbrainz ids\n \t*/\n\tcoverartarchive: {userAgent: userAgent + ' ( jamserve@protonmail.com )'},\n\t/*\n\t\tWikipedia\n\t\thttps://en.wikipedia.org/api/rest_v1/#/\n \t*/\n\twikipedia: {userAgent: userAgent + ' ( jamserve@protonmail.com )'},\n\t/*\n\t\tChart Lyrics\n\t\thttp://www.chartlyrics.com/\n\t\tlyrics database\n\t */\n\tchartlyrics: {userAgent}\n};\n","import {Stats} from './stats.model';\nimport {Store} from '../store/store';\nimport {AlbumType} from '../../model/jam-types';\n\nexport class StatsService {\n\tprivate stats: Array<Stats> = [];\n\n\tconstructor(private store: Store) {\n\t}\n\n\tasync refresh(): Promise<void> {\n\t\tthis.stats = [];\n\t}\n\n\tasync getStats(rootID?: string): Promise<Stats> {\n\t\tlet stat = this.stats.find(s => s.rootID === rootID);\n\t\tif (!stat) {\n\t\t\tstat = {\n\t\t\t\trootID,\n\t\t\t\talbum: await this.store.albumStore.searchCount({rootID}),\n\t\t\t\talbumTypes: {\n\t\t\t\t\talbum: await this.store.albumStore.searchCount({rootID, albumType: AlbumType.album}),\n\t\t\t\t\tcompilation: await this.store.albumStore.searchCount({rootID, albumType: AlbumType.compilation}),\n\t\t\t\t\taudiobook: await this.store.albumStore.searchCount({rootID, albumType: AlbumType.audiobook}),\n\t\t\t\t},\n\t\t\t\tartist: await this.store.artistStore.searchCount({rootID}),\n\t\t\t\tartistTypes: {\n\t\t\t\t\talbum: await this.store.artistStore.searchCount({rootID, albumType: AlbumType.album}),\n\t\t\t\t\tcompilation: await this.store.artistStore.searchCount({rootID, albumType: AlbumType.compilation}),\n\t\t\t\t\taudiobook: await this.store.artistStore.searchCount({rootID, albumType: AlbumType.audiobook}),\n\t\t\t\t},\n\t\t\t\tfolder: await this.store.folderStore.searchCount({rootID}),\n\t\t\t\ttrack: await this.store.trackStore.searchCount({rootID})\n\t\t\t};\n\t\t\tthis.stats.push(stat);\n\t\t}\n\t\treturn stat;\n\t}\n\n}\n","import {SettingsStore} from './settings.store';\nimport {Jam} from '../../model/jam-rest-data';\nimport {defaultSettings} from '../../config/settings.default';\nimport {DBObjectType} from '../../db/db.types';\nimport {ChatService} from '../../engine/chat/chat.service';\nimport {IndexService} from '../../engine/index/index.service';\nimport {ScanService} from '../../engine/scan/scan.service';\n\nexport class SettingsService {\n\tpublic settings: Jam.AdminSettings = defaultSettings;\n\n\tconstructor(public settingsStore: SettingsStore, private chatService: ChatService, private indexService: IndexService, private scanService: ScanService, private version: string) {\n\n\t}\n\n\tasync get(): Promise<Jam.AdminSettings> {\n\t\treturn this.settings;\n\t}\n\n\tprivate setSettings(settings: Jam.AdminSettings) {\n\t\tthis.settings = settings;\n\t\tthis.chatService.setSettings(this.settings.chat);\n\t\tthis.indexService.setSettings(this.settings.index);\n\t\tthis.scanService.setSettings(this.settings.library);\n\t}\n\n\tasync loadSettings(): Promise<void> {\n\t\tlet settings = await this.settingsStore.searchOne({section: 'jamserve'});\n\t\tif (!settings) {\n\t\t\tsettings = {\n\t\t\t\tid: '',\n\t\t\t\ttype: DBObjectType.settings,\n\t\t\t\tsection: 'jamserve',\n\t\t\t\tdata: defaultSettings,\n\t\t\t\tversion: this.version\n\t\t\t};\n\t\t\tawait this.settingsStore.add(settings);\n\t\t}\n\t\tthis.setSettings(settings.data);\n\t}\n\n\tasync updateSettings(settings: Jam.AdminSettings): Promise<void> {\n\t\tthis.setSettings(settings);\n\t}\n}\n","import {Jam} from '../model/jam-rest-data';\n\nexport const defaultSettings: Jam.AdminSettings = {\n\tchat: {\n\t\tmaxMessages: 100,\n\t\tmaxAge: {value: 1, unit: 'day'}\n\t},\n\tindex: {\n\t\tignoreArticles: ['The', 'El', 'La', 'Los', 'Las', 'Le', 'Les', 'Die']\n\t},\n\tlibrary: {\n\t\tscanAtStart: true,\n\t\taudioBookGenreNames: ['audiobook', 'audio book', 'audiobooks', 'audio books', 'hrspiel', 'hrspiele', 'hrbuch', 'hrbucher']\n\t}\n};\n","import express from 'express';\nimport {Engine} from '../engine/engine';\nimport bodyParser from 'body-parser';\nimport {initJamRouter} from './jam/router';\nimport {initSubsonicRouter} from './subsonic/router';\nimport path from 'path';\nimport * as http from 'http';\nimport Logger from '../utils/logger';\nimport helmet from 'helmet';\n\nconst log = Logger('Server');\n\nexport interface EngineRequest extends express.Request {\n\tengine: Engine;\n}\n\nexport class Server {\n\tapp: express.Application;\n\tengine: Engine;\n\tserver: http.Server | undefined;\n\n\tconstructor(engine: Engine) {\n\t\tthis.engine = engine;\n\t\tconst app: express.Application = express();\n\t\tapp.use(bodyParser.urlencoded({extended: true, limit: '10mb'}));\n\t\tapp.use(bodyParser.json({limit: '10mb'}));\n\t\tapp.use(bodyParser.json({type: 'application/vnd.api+json', limit: '10mb'}));\n\n\t\tapp.use(helmet());\n\n\t\tfunction EngineMiddleWare(req: express.Request, res: express.Response, next: express.NextFunction) {\n\t\t\t(<EngineRequest>req).engine = engine;\n\t\t\tnext();\n\t\t}\n\n\t\tapp.use(EngineMiddleWare);\n\t\tapp.use('/api/v1', initJamRouter(engine));\n\t\tapp.use('/rest', initSubsonicRouter(engine));\n\n\t\t// frontend (jamberry config file)\n\t\tapp.get('/assets/config/config.js', (req, res) => {\n\t\t\tres.sendFile(path.resolve('./config/jamberry.config.js'));\n\t\t});\n\t\t// frontend (any)\n\t\tapp.get('/*', express.static(path.resolve(engine.config.paths.frontend)));\n\t\tapp.get('/*', (req: express.Request, res: express.Response) => {\n\t\t\tres.sendFile(path.join(path.resolve(engine.config.paths.frontend), 'index.html'));\n\t\t});\n\n\t\tthis.app = app;\n\t}\n\n\tgetURL(): string {\n\t\treturn 'http://' + (this.engine.config.server.listen === '127.0.0.1' ? 'localhost' : this.engine.config.server.listen) + ':' + this.engine.config.server.port;\n\t}\n\n\tasync start(): Promise<void> {\n\t\tthis.server = this.app.listen(this.engine.config.server.port, this.engine.config.server.listen);\n\t\tlog.info('Listening ' + this.getURL());\n\t}\n\n\tasync stop(): Promise<void> {\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\t\tif (this.server) {\n\t\t\t\t\tthis.server.close(resolve);\n\t\t\t\t\t// this.server.unref();\n\t\t\t\t} else {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n}\n\n","module.exports = require(\"body-parser\");","import express from 'express';\nimport {CheckAuthMiddleWare, UserRequest} from './login';\nimport {ApiResponder} from './response';\nimport multer from 'multer';\nimport path from 'path';\nimport Logger from '../../utils/logger';\nimport {JamController} from './api';\nimport {Engine} from '../../engine/engine';\nimport {Jam} from '../../model/jam-rest-data';\nimport cors, {CorsOptions} from 'cors';\nimport {SessionJSONFileStore} from '../../utils/session-storage';\nimport session from 'express-session';\nimport passport from 'passport';\nimport passportJWT from 'passport-jwt';\nimport passportLocal from 'passport-local';\nimport jwt from 'jsonwebtoken';\nimport {NotFoundError, UnauthError} from './error';\nimport {Register, registerAccessControlApi, RegisterCallback, registerPublicApi} from './routes';\nimport {apiCheck} from './check';\nimport {getMaxAge} from '../../utils/max-age';\nimport {formatUser} from '../../objects/user/user.format';\nimport {User} from '../../objects/user/user.model';\nimport {JAMAPI_VERSION} from '../../version';\n\nconst autoUploadTempReap = require('multer-autoreap'); // TODO: multer-autoreap types\nconst rateLimit = require('express-rate-limit');\n\nconst LoginLimiter = rateLimit({\n\twindowMs: 60 * 60 * 1000, // 1 hour window\n\tmax: 5, // start blocking after 5 requests\n\tmessage: 'Too many login requests from this IP, please try again after an hour'\n});\n\nconst log = Logger('Jam.Api');\n\ninterface JWTPayload {\n\tid: string;\n\texp?: number;\n\tclient: string;\n}\n\nfunction CallSessionLoginHandler(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\tpassport.authenticate('local', (err, user, info) => {\n\t\tif (err || !user) {\n\t\t\treturn next();\n\t\t}\n\t\treq.login(user, (err2) => {\n\t\t\tif (err2) {\n\t\t\t\tlog.error(err2);\n\t\t\t\treturn next();\n\t\t\t}\n\t\t\tconst client = req.body.client || 'Unknown Client';\n\t\t\treq.client = client;\n\t\t\tconst maxAge = getMaxAge(req.engine.config.server.jwt.maxAge);\n\t\t\tconst tokenData: JWTPayload = {\n\t\t\t\tid: user.id,\n\t\t\t\texp: maxAge > 0 ? Math.floor((Date.now() + maxAge) / 1000) : undefined,\n\t\t\t\tclient\n\t\t\t};\n\t\t\tconst token = jwt.sign(tokenData, req.engine.config.server.jwt.secret);\n\t\t\tconst result: Jam.Session = {version: JAMAPI_VERSION, allowedCookieDomains: req.engine.config.server.session.allowedCookieDomains, jwt: token, user: formatUser(req.user)};\n\t\t\tApiResponder.data(res, result);\n\t\t});\n\t})(req, res, next);\n}\n\nfunction CallSessionLogoutHandler(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\treq.logout();\n\tApiResponder.ok(res);\n}\n\nasync function checkRoles(user: User, roles?: Array<string>): Promise<void> {\n\tif (roles && roles.length > 0) {\n\t\tfor (const role of roles) {\n\t\t\tif (!user.roles[role]) {\n\t\t\t\treturn Promise.reject(UnauthError());\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport function initJamRouter(engine: Engine): express.Router {\n\tconst api = new JamController(engine);\n\n\tconst UPLOAD_PATH = engine.config.getDataPath(['cache', 'uploads']);\n\tconst upload = multer({dest: `${UPLOAD_PATH}/`}); // multer configuration\n\n\tconst router = express.Router();\n\n\t// if (router.get('env') === 'production') {\n\t// \trouter.set('trust proxy', 1) // trust first proxy\n\t// \tsess.cookie.secure = true // serve secure cookies\n\t// }\n\tconst maxAge = getMaxAge(engine.config.server.session.cookie.maxAge);\n\trouter.use(session({\n\t\tname: engine.config.server.session.cookie.name,\n\t\tsecret: engine.config.server.session.secret,\n\t\tstore: new SessionJSONFileStore(engine.config.getDataPath(['session', 'sessions.json'])),\n\t\tresave: false,\n\t\tsaveUninitialized: false,\n\t\tcookie: {\n\t\t\tsecure: engine.config.server.session.cookie.secure,\n\t\t\tmaxAge: maxAge > 0 ? maxAge : undefined\n\t\t}\n\t}));\n\trouter.use(passport.initialize());\n\trouter.use(passport.session());\n\tpassport.serializeUser((user: User, done) => {\n\t\tdone(null, user.id);\n\t});\n\tpassport.deserializeUser((id: string, done) => {\n\t\tengine.userService.getByID(id).then(user => done(null, user ? user : false)).catch(done);\n\t});\n\n\tpassport.use('local', new passportLocal.Strategy(\n\t\t{usernameField: 'username', passwordField: 'password'},\n\t\t(username, password, done) => {\n\t\t\tengine.userService.auth(username, password).then(user => done(null, user ? user : false)).catch(done);\n\t\t}\n\t));\n\tpassport.use('jwt-header', new passportJWT.Strategy(\n\t\t{\n\t\t\tjwtFromRequest: passportJWT.ExtractJwt.fromAuthHeaderAsBearerToken(),\n\t\t\tsecretOrKey: engine.config.server.jwt.secret\n\t\t},\n\t\t(jwt_payload, done) => {\n\t\t\tengine.userService.getByID(jwt_payload.id).then(user => done(null, user ? user : false, jwt_payload)).catch(done);\n\t\t}\n\t));\n\tpassport.use('jwt-parameter', new passportJWT.Strategy(\n\t\t{\n\t\t\tjwtFromRequest: passportJWT.ExtractJwt.fromUrlQueryParameter('bearer'),\n\t\t\tsecretOrKey: engine.config.server.jwt.secret\n\t\t},\n\t\t(jwt_payload, done) => {\n\t\t\tengine.userService.getByID(jwt_payload.id).then(user => done(null, user ? user : false, jwt_payload)).catch(done);\n\t\t}\n\t));\n\n\tfunction jwtParameterAuthMiddleware(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\t\tif (req.user) {\n\t\t\treturn next();\n\t\t}\n\t\tpassport.authenticate('jwt-parameter', {session: false}, (err, user, info: JWTPayload) => {\n\t\t\tif (err) {\n\t\t\t\tlog.error(err);\n\t\t\t\treturn next();\n\t\t\t}\n\t\t\treq.jwt = !!user;\n\t\t\treq.client = info.client;\n\t\t\treq.user = user;\n\t\t\tnext();\n\t\t})(req, res, next);\n\t}\n\n\tfunction jwtHeaderAuthMiddleware(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\t\tif (req.user) {\n\t\t\treturn next();\n\t\t}\n\t\tpassport.authenticate('jwt-header', {session: false}, (err, user, info: JWTPayload) => {\n\t\t\tif (err) {\n\t\t\t\tlog.error(err);\n\t\t\t\treturn next();\n\t\t\t}\n\t\t\treq.jwt = !!user;\n\t\t\treq.client = info.client;\n\t\t\treq.user = user;\n\t\t\tnext();\n\t\t})(req, res, next);\n\t}\n\n\trouter.use((req, res, next) => {\n\t\tlog.info(req.originalUrl);\n\t\tnext();\n\t});\n\n\trouter.use(<express.RequestHandler>jwtHeaderAuthMiddleware);\n\trouter.use(<express.RequestHandler>jwtParameterAuthMiddleware);\n\n\n\trouter.use(cors({\n\t\tpreflightContinue: false,\n\t\tcredentials: true,\n\t\tallowedHeaders: ['Content-Type', 'Authorization'],\n\t\torigin: true,\n\t\tmethods: ['GET', 'POST']\n\t}));\n\n\tconst register: Register = {\n\t\tget: (name: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => {\n\t\t\trouter.get(name, apiCheck(apiCheckName || name), async (req, res) => {\n\t\t\t\ttry {\n\t\t\t\t\tawait checkRoles(req.user, roles);\n\t\t\t\t\tawait execute(req, res);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tawait ApiResponder.error(res, e);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tpost: (name: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => {\n\t\t\trouter.post(name, apiCheck(apiCheckName || name), async (req, res) => {\n\t\t\t\ttry {\n\t\t\t\t\tawait checkRoles(req.user, roles);\n\t\t\t\t\tawait execute(req, res);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tawait ApiResponder.error(res, e);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tupload: (name: string, field: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => {\n\t\t\trouter.post(name, upload.single(field), apiCheck(apiCheckName || name), autoUploadTempReap, async (req, res) => {\n\t\t\t\ttry {\n\t\t\t\t\tawait checkRoles(req.user, roles);\n\t\t\t\t\tawait execute(req, res);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tawait ApiResponder.error(res, e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tregisterPublicApi(register, api);\n\trouter.post('/login', LoginLimiter, apiCheck('/login'), <express.RequestHandler>CallSessionLoginHandler);\n\n\tconst corsOptionsDelegate = function(req: express.Request, callback: (err: Error | null, options: CorsOptions) => void) {\n\t\tconst origins = engine.config.server.session.allowedCookieDomains || [];\n\t\tconst corsOptions: CorsOptions = {\n\t\t\tpreflightContinue: false,\n\t\t\tcredentials: true,\n\t\t\tallowedHeaders: ['Content-Type', 'Authorization'],\n\t\t\torigin: function(origin, cb) {\n\t\t\t\tif (origins.indexOf(origin) !== -1 || !origin) {\n\t\t\t\t\tcb(null, true);\n\t\t\t\t} else {\n\t\t\t\t\tif (req.method === 'OPTIONS' || req.jwt) {\n\t\t\t\t\t\tcb(null, true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcb(new Error('Not allowed by CORS'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tmethods: ['GET', 'POST']\n\t\t};\n\t\tcallback(null, corsOptions); // callback expects two parameters: error and options\n\t};\n\trouter.use(cors(corsOptionsDelegate));\n\n\trouter.post('/logout', <express.RequestHandler>CallSessionLogoutHandler);\n\trouter.use('/docs', express.static(path.resolve('./dist/docs/api/')));\n\n\trouter.use(<express.RequestHandler>CheckAuthMiddleWare); // ensure req.user exists for all requests after this\n\n\tregisterAccessControlApi(register, api);\n\n\trouter.use((req, res, next) => {\n\t\tApiResponder.error(res, NotFoundError('jam api cmd not found'));\n\t});\n\n\treturn router;\n}\n","import express from 'express';\nimport {EngineRequest} from '../server';\nimport {User} from '../../objects/user/user.model';\n\n/**\n * Fill user into req.user express requests\n */\nexport interface UserRequest extends EngineRequest {\n\tuser: User;\n\tclient: string;\n\tjwt: boolean;\n}\n\nexport function CheckAuthMiddleWare(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\tif (!req.client && req.session && req.session.client) {\n\t\treq.client = req.session.client;\n\t}\n\tif (req.user) {\n\t\treturn next();\n\t}\n\treturn res.status(401).json({error: 'Unauthorized'});\n}\n","module.exports = require(\"multer\");","import {Engine} from '../../engine/engine';\nimport {Jam} from '../../model/jam-rest-data';\nimport {EpisodeController} from '../../objects/episode/episode.controller';\nimport {PodcastController} from '../../objects/podcast/podcast.controller';\nimport {AlbumController} from '../../objects/album/album.controller';\nimport {ArtistController} from '../../objects/artist/artist.controller';\nimport {PlaylistController} from '../../objects/playlist/playlist.controller';\nimport {TrackController} from '../../objects/track/track.controller';\nimport {FolderController} from '../../objects/folder/folder.controller';\nimport {RootController} from '../../objects/root/root.controller';\nimport {UserController} from '../../objects/user/user.controller';\nimport {ChatController} from '../../engine/chat/chat.controller';\nimport {MetadataController} from '../../objects/metadata/metadata.controller';\nimport {StreamController} from '../../engine/stream/stream.controller';\nimport {formatSessionUser} from '../../objects/user/user.format';\nimport {GenreController} from '../../engine/genre/genre.controller';\nimport {NowPlayingController} from '../../engine/nowplaying/nowplaying.controller';\nimport {ImageController} from '../../engine/image/image.controller';\nimport {DownloadController} from '../../engine/download/download.controller';\nimport {User} from '../../objects/user/user.model';\nimport {WaveformController} from '../../engine/waveform/waveform.controller';\nimport {AutocompleteController} from '../../engine/autocomplete/autocomplete.controller';\nimport {BookmarkController} from '../../objects/bookmark/bookmark.controller';\nimport {PlayQueueController} from '../../objects/playqueue/playqueue.controller';\nimport {RadioController} from '../../objects/radio/radio.controller';\nimport {JAMAPI_VERSION} from '../../version';\nimport {StatsController} from '../../engine/stats/stats.controller';\nimport {SettingsController} from '../../objects/settings/settings.controller';\n\nexport interface JamRequest<T> {\n\tquery: T;\n\tuser: User;\n\tclient?: string;\n\tfile?: string;\n}\n\nexport class JamController {\n\talbumController: AlbumController;\n\tartistController: ArtistController;\n\tautocompleteController: AutocompleteController;\n\tbookmarkController: BookmarkController;\n\tchatController: ChatController;\n\tdownloadController: DownloadController;\n\tepisodeController: EpisodeController;\n\tfolderController: FolderController;\n\tgenreController: GenreController;\n\timageController: ImageController;\n\tmetadataController: MetadataController;\n\tnowPlayingController: NowPlayingController;\n\tplaylistController: PlaylistController;\n\tplayqueueController: PlayQueueController;\n\tpodcastController: PodcastController;\n\tradioController: RadioController;\n\tsettingsController: SettingsController;\n\trootController: RootController;\n\tstreamController: StreamController;\n\ttrackController: TrackController;\n\tuserController: UserController;\n\twaveformController: WaveformController;\n\tstatsController: StatsController;\n\n\tconstructor(private engine: Engine) {\n\t\tthis.settingsController = new SettingsController(this.engine.settingsService);\n\t\tthis.streamController = new StreamController(this.engine.streamService, this.engine.nowPlayingService, this.engine.store);\n\t\tthis.chatController = new ChatController(this.engine.chatService);\n\t\tthis.genreController = new GenreController(engine.genreService);\n\t\tthis.statsController = new StatsController(engine.statsService);\n\t\tthis.nowPlayingController = new NowPlayingController(engine.nowPlayingService);\n\t\tthis.imageController = new ImageController(this.engine.store, this.engine.imageService);\n\t\tthis.downloadController = new DownloadController(this.engine.store, this.engine.downloadService);\n\t\tthis.waveformController = new WaveformController(this.engine.store, this.engine.waveformService);\n\t\tthis.autocompleteController = new AutocompleteController(this.engine.store);\n\t\tthis.radioController = new RadioController(this.engine.radioService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.rootController = new RootController(this.engine.rootService, this.engine.ioService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.trackController = new TrackController(this.engine.trackService, this.engine.folderService, this.engine.audioModule, this.engine.bookmarkService, this.engine.metaDataService, this.streamController, this.engine.ioService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.episodeController = new EpisodeController(this.engine.episodeService, this.streamController,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.podcastController = new PodcastController(this.engine.podcastService, this.episodeController,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.albumController = new AlbumController(this.engine.albumService, this.trackController, this.engine.metaDataService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.artistController = new ArtistController(this.engine.artistService, this.trackController, this.albumController, this.engine.metaDataService, this.engine.indexService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.folderController = new FolderController(this.engine.folderService, this.trackController, this.engine.metaDataService, this.engine.indexService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.userController = new UserController(this.engine.userService,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.playlistController = new PlaylistController(this.engine.playlistService, this.trackController,\n\t\t\tthis.engine.stateService, this.engine.imageService, this.engine.downloadService);\n\t\tthis.bookmarkController = new BookmarkController(this.engine.bookmarkService, this.trackController);\n\t\tthis.playqueueController = new PlayQueueController(this.engine.playQueueService, this.trackController);\n\t\tthis.metadataController = new MetadataController(this.engine.metaDataService, this.trackController);\n\t}\n\n\tasync ping(req: JamRequest<{}>): Promise<Jam.Ping> {\n\t\treturn {version: JAMAPI_VERSION};\n\t}\n\n\tasync session(req: JamRequest<{}>): Promise<Jam.Session> {\n\t\treturn {version: JAMAPI_VERSION, allowedCookieDomains: this.engine.config.server.session.allowedCookieDomains, user: req.user ? formatSessionUser(req.user) : undefined};\n\t}\n\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {PodcastStatus} from '../../model/jam-types';\nimport {IApiBinaryResult} from '../../typings';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatEpisode} from './episode.format';\nimport {formatState} from '../state/state.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryEpisode} from './episode.store';\nimport {Episode} from './episode.model';\nimport {User} from '../user/user.model';\nimport {EpisodeService} from './episode.service';\nimport {StreamController} from '../../engine/stream/stream.controller';\nimport {BaseListController} from '../base/base.list.controller';\nimport {DBObjectType} from '../../db/db.types';\n\nexport class EpisodeController extends BaseListController<JamParameters.Episode, JamParameters.Episodes, JamParameters.IncludesEpisode, SearchQueryEpisode, JamParameters.EpisodeSearch, Episode, Jam.PodcastEpisode> {\n\n\tconstructor(\n\t\tprivate episodeService: EpisodeService,\n\t\tprivate streamController: StreamController,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(episodeService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Episode>): Array<Episode> {\n\t\treturn items.sort((a, b) => {\n\t\t\t\tif (!a.tag) {\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t\tif (!b.tag) {\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t\tif (a.tag.track !== undefined && b.tag.track !== undefined) {\n\t\t\t\t\tconst res = a.tag.track - b.tag.track;\n\t\t\t\t\tif (res !== 0) {\n\t\t\t\t\t\treturn res;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn a.date - b.date;\n\t\t\t}\n\t\t);\n\t}\n\n\tasync prepare(episode: Episode, includes: JamParameters.IncludesEpisode, user: User): Promise<Jam.PodcastEpisode> {\n\t\tconst result = formatEpisode(episode, includes,\n\t\t\tthis.episodeService.isDownloading(episode.id) ? PodcastStatus.downloading : episode.status\n\t\t);\n\t\tif (includes.trackState) {\n\t\t\tconst state = await this.stateService.findOrCreate(episode.id, user.id, DBObjectType.episode);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.EpisodeSearch, user: User): Promise<SearchQueryEpisode> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tname: query.name,\n\t\t\tpodcastID: query.podcastID,\n\t\t\tstatus: query.status,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync retrieve(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst episode = await this.byID(req.query.id);\n\t\tif (!episode.path) {\n\t\t\tthis.episodeService.downloadEpisode(episode); // do not wait\n\t\t}\n\t}\n\n\tasync stream(req: JamRequest<JamParameters.Stream>): Promise<IApiBinaryResult> {\n\t\tconst episode = await this.byID(req.query.id);\n\t\treturn await this.streamController.streamEpisode(episode, req.query.format, req.query.maxBitRate, req.user);\n\t}\n\n\tasync status(req: JamRequest<JamParameters.ID>): Promise<Jam.PodcastEpisodeStatus> {\n\t\tconst episode = await this.byID(req.query.id);\n\t\treturn {\n\t\t\tstatus: this.episodeService.isDownloading(episode.id) ? PodcastStatus.downloading : episode.status\n\t\t};\n\t}\n\n\tasync list(req: JamRequest<JamParameters.PodcastEpisodeList>): Promise<Array<Jam.PodcastEpisode>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {PodcastStatus} from '../../model/jam-types';\nimport {JamRequest} from '../../api/jam/api';\nimport {EpisodeController} from '../episode/episode.controller';\nimport {formatPodcast} from './podcast.format';\nimport {PodcastService} from './podcast.service';\nimport {formatState} from '../state/state.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryPodcast} from './podcast.store';\nimport {Podcast} from './podcast.model';\nimport {User} from '../user/user.model';\nimport {BaseListController} from '../base/base.list.controller';\nimport {DBObjectType} from '../../db/db.types';\n\nexport class PodcastController extends BaseListController<JamParameters.Podcast, JamParameters.Podcasts, JamParameters.IncludesPodcast, SearchQueryPodcast, JamParameters.PodcastSearch, Podcast, Jam.Podcast> {\n\n\tconstructor(\n\t\tprivate podcastService: PodcastService,\n\t\tprivate episodeController: EpisodeController,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(podcastService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Podcast>): Array<Podcast> {\n\t\treturn items.sort((a, b) => (a.tag && a.tag.title ? a.tag.title : a.url).localeCompare((b.tag && b.tag.title ? b.tag.title : b.url)));\n\t}\n\n\tasync prepare(podcast: Podcast, includes: JamParameters.IncludesPodcast, user: User): Promise<Jam.Podcast> {\n\t\tconst result = formatPodcast(podcast, this.podcastService.isDownloading(podcast.id) ? PodcastStatus.downloading : podcast.status);\n\t\tif (includes.podcastState) {\n\t\t\tconst state = await this.stateService.findOrCreate(podcast.id, user.id, DBObjectType.podcast);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\tif (includes.podcastEpisodes) {\n\t\t\tresult.episodes = await this.episodeController.prepareByQuery({podcastID: podcast.id}, includes, user);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.PodcastSearch, user: User): Promise<SearchQueryPodcast> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\turl: query.url,\n\t\t\ttitle: query.title,\n\t\t\tstatus: query.status,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync tracks(req: JamRequest<JamParameters.Tracks>): Promise<Array<Jam.PodcastEpisode>> {\n\t\treturn this.episodeController.prepareByQuery({podcastIDs: req.query.ids}, req.query, req.user);\n\t}\n\n\tasync refreshAll(req: JamRequest<{}>): Promise<void> {\n\t\tthis.podcastService.refreshPodcasts(); // do not wait\n\t}\n\n\tasync refresh(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst podcast = await this.byID(req.query.id);\n\t\tthis.podcastService.refresh(podcast); // do not wait\n\t}\n\n\tasync create(req: JamRequest<JamParameters.PodcastNew>): Promise<Jam.Podcast> {\n\t\tconst podcast = await this.podcastService.create(req.query.url);\n\t\treturn this.prepare(podcast, {}, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst podcast = await this.byID(req.query.id);\n\t\tawait this.podcastService.remove(podcast);\n\t}\n\n\tasync status(req: JamRequest<JamParameters.ID>): Promise<Jam.PodcastStatus> {\n\t\tconst podcast = await this.byID(req.query.id);\n\t\treturn {\n\t\t\tlastCheck: podcast.lastCheck,\n\t\t\tstatus: <Jam.PodcastStatusType>(this.podcastService.isDownloading(podcast.id) ? PodcastStatus[PodcastStatus.downloading] : PodcastStatus[podcast.status])\n\t\t};\n\t}\n\n\tasync list(req: JamRequest<JamParameters.PodcastList>): Promise<Array<Jam.Podcast>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Podcast} from './podcast.model';\nimport {PodcastStatus} from '../../model/jam-types';\n\nexport function formatPodcast(podcast: Podcast, status: PodcastStatus): Jam.Podcast {\n\treturn {\n\t\tid: podcast.id,\n\t\turl: podcast.url,\n\t\tcreated: podcast.created,\n\t\tlastCheck: podcast.lastCheck > 0 ? podcast.lastCheck : undefined,\n\t\tstatus: <Jam.PodcastStatusType>status,\n\t\terrorMessage: podcast.errorMessage,\n\t\tname: podcast.tag ? podcast.tag.title : podcast.url,\n\t\tdescription: podcast.tag ? podcast.tag.description : undefined\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {paginate} from '../../utils/paginate';\nimport {JamRequest} from '../../api/jam/api';\nimport {BaseListController} from '../base/base.list.controller';\nimport {TrackController} from '../track/track.controller';\nimport {formatAlbum} from './album.format';\nimport {SearchQueryAlbum} from './album.store';\nimport {MetaDataService} from '../metadata/metadata.service';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {Album} from './album.model';\nimport {User} from '../user/user.model';\nimport {AlbumService} from './album.service';\nimport {Track} from '../track/track.model';\n\nexport class AlbumController extends BaseListController<JamParameters.Album, JamParameters.Albums, JamParameters.IncludesAlbum, SearchQueryAlbum, JamParameters.AlbumSearch, Album, Jam.Album> {\n\n\tconstructor(\n\t\tprivate albumService: AlbumService,\n\t\tprivate trackController: TrackController,\n\t\tprivate metaDataService: MetaDataService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(albumService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Album>): Array<Album> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tsortAlbumTracks(a: Track, b: Track): number {\n\t\tlet res = (b.tag.disc || 0) - (a.tag.disc || 0);\n\t\tif (res === 0) {\n\t\t\tres = (b.tag.track || 0) - (a.tag.track || 0);\n\t\t}\n\t\treturn res;\n\t}\n\n\tasync prepare(album: Album, includes: JamParameters.IncludesAlbum, user: User): Promise<Jam.Album> {\n\t\tconst result = formatAlbum(album, includes);\n\t\tif (includes.albumState) {\n\t\t\tresult.state = await this.stateService.findOrCreate(album.id, user.id, DBObjectType.album);\n\t\t}\n\t\tif (includes.albumInfo) {\n\t\t\tresult.info = await this.metaDataService.getAlbumInfo(album);\n\t\t}\n\t\tif (includes.albumTracks) {\n\t\t\tresult.tracks = await this.trackController.prepareListByIDs(album.trackIDs, includes, user, this.sortAlbumTracks);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.AlbumSearch, user: User): Promise<SearchQueryAlbum> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tname: query.name,\n\t\t\trootID: query.rootID,\n\t\t\tartist: query.artist,\n\t\t\tartistID: query.artistID,\n\t\t\ttrackID: query.trackID,\n\t\t\tmbAlbumID: query.mbAlbumID,\n\t\t\tmbArtistID: query.mbArtistID,\n\t\t\talbumType: query.albumType,\n\t\t\talbumTypes: query.albumTypes,\n\t\t\tgenre: query.genre,\n\t\t\tnewerThan: query.newerThan,\n\t\t\tfromYear: query.fromYear,\n\t\t\ttoYear: query.toYear,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync similarTracks(req: JamRequest<JamParameters.SimilarTracks>): Promise<Array<Jam.Track>> {\n\t\tconst album = await this.byID(req.query.id);\n\t\tconst tracks = await this.metaDataService.getAlbumSimilarTracks(album);\n\t\treturn this.trackController.prepareList(paginate(tracks, req.query.amount, req.query.offset), req.query, req.user);\n\t}\n\n\tasync list(req: JamRequest<JamParameters.AlbumList>): Promise<Array<Jam.Album>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n\n\tasync tracks(req: JamRequest<JamParameters.Tracks>): Promise<Array<Jam.Track>> {\n\t\tconst albums = await this.byIDs(req.query.ids);\n\t\tlet trackIDs: Array<string> = [];\n\t\talbums.forEach(album => {\n\t\t\ttrackIDs = trackIDs.concat(album.trackIDs);\n\t\t});\n\t\treturn this.trackController.prepareListByIDs(trackIDs, req.query, req.user, this.sortAlbumTracks);\n\t}\n\n\tasync info(req: JamRequest<JamParameters.ID>): Promise<Jam.Info> {\n\t\tconst album = await this.byID(req.query.id);\n\t\treturn {info: await this.metaDataService.getAlbumInfo(album)};\n\t}\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Album} from './album.model';\n\nexport function formatAlbum(album: Album, includes: JamParameters.IncludesAlbum): Jam.Album {\n\tlet mbz: any = {\n\t\tartistID: album.mbArtistID,\n\t\talbumID: album.mbAlbumID\n\t};\n\tif (!Object.keys(mbz).find(key => !!mbz[key])) {\n\t\tmbz = undefined;\n\t}\n\treturn {\n\t\tid: album.id,\n\t\tname: album.name,\n\t\talbumType: album.albumType,\n\t\tcreated: album.created,\n\t\tartist: album.artist,\n\t\tartistID: album.artistID,\n\t\ttrackCount: album.trackIDs.length,\n\t\ttag: {\n\t\t\tgenre: album.genre,\n\t\t\tyear: album.year,\n\t\t\tduration: album.duration,\n\t\t\tcreated: album.created,\n\t\t\tmusicbrainz: mbz\n\t\t},\n\t\ttrackIDs: includes.albumTrackIDs ? album.trackIDs : undefined,\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {paginate} from '../../utils/paginate';\nimport {JamRequest} from '../../api/jam/api';\nimport {BaseListController} from '../base/base.list.controller';\nimport {TrackController} from '../track/track.controller';\nimport {AlbumController} from '../album/album.controller';\nimport {formatArtist} from './artist.format';\nimport {formatState} from '../state/state.format';\nimport {formatArtistIndex} from '../../engine/index/index.format';\nimport {MetaDataService} from '../metadata/metadata.service';\nimport {SearchQueryArtist} from './artist.store';\nimport {IndexService} from '../../engine/index/index.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {StateService} from '../state/state.service';\nimport {Artist} from './artist.model';\nimport {User} from '../user/user.model';\nimport {ArtistService} from './artist.service';\nimport {Album} from '../album/album.model';\nimport {Track} from '../track/track.model';\n\nexport class ArtistController extends BaseListController<JamParameters.Artist, JamParameters.Artists, JamParameters.IncludesArtist, SearchQueryArtist, JamParameters.ArtistSearch, Artist, Jam.Artist> {\n\n\tconstructor(\n\t\tprivate artistService: ArtistService,\n\t\tprivate trackController: TrackController,\n\t\tprivate albumController: AlbumController,\n\t\tprivate metaDataService: MetaDataService,\n\t\tprivate indexService: IndexService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(artistService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Artist>): Array<Artist> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tsortArtistAlbums(a: Album, b: Album): number {\n\t\tlet res = a.albumType.localeCompare(b.albumType);\n\t\tif (res === 0) {\n\t\t\tres = (b.year || 0) - (a.year || 0);\n\t\t}\n\t\treturn res;\n\t}\n\n\tsortArtistTracks(a: Track, b: Track): number {\n\t\tlet res = a.parentID.localeCompare(b.parentID);\n\t\tif (res === 0) {\n\t\t\tres = (b.tag.disc || 0) - (a.tag.disc || 0);\n\t\t}\n\t\tif (res === 0) {\n\t\t\tres = (b.tag.track || 0) - (a.tag.track || 0);\n\t\t}\n\t\treturn res;\n\t}\n\n\tasync prepare(artist: Artist, includes: JamParameters.IncludesArtist, user: User): Promise<Jam.Artist> {\n\t\tconst result = formatArtist(artist, includes);\n\t\tif (includes.artistState) {\n\t\t\tconst state = await this.stateService.findOrCreate(artist.id, user.id, DBObjectType.artist);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\tif (includes.artistInfo) {\n\t\t\tresult.info = await this.metaDataService.getArtistInfo(artist);\n\t\t}\n\t\tif (includes.artistSimilar) {\n\t\t\tresult.similar = await this.prepareList(await this.metaDataService.getSimilarArtists(artist), {}, user);\n\t\t}\n\t\tif (includes.artistTracks) {\n\t\t\tresult.tracks = await this.trackController.prepareListByIDs(artist.trackIDs, includes, user, this.sortArtistTracks);\n\t\t}\n\t\tif (includes.artistAlbums) {\n\t\t\tresult.albums = await this.albumController.prepareListByIDs(artist.albumIDs, includes, user, this.sortArtistAlbums);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.ArtistSearch, user: User): Promise<SearchQueryArtist> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tname: query.name,\n\t\t\trootID: query.rootID,\n\t\t\talbumID: query.albumID,\n\t\t\tmbArtistID: query.mbArtistID,\n\t\t\t// genre: query.genre,\n\t\t\tnewerThan: query.newerThan,\n\t\t\t// fromYear: query.fromYear,\n\t\t\t// toYear: query.toYear,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync similar(req: JamRequest<JamParameters.Artist>): Promise<Array<Jam.Artist>> {\n\t\tconst artist = await this.byID(req.query.id);\n\t\tconst list = await this.metaDataService.getSimilarArtists(artist);\n\t\treturn this.prepareList(list, req.query, req.user);\n\t}\n\n\tasync similarTracks(req: JamRequest<JamParameters.SimilarTracks>): Promise<Array<Jam.Track>> {\n\t\tconst artist = await this.byID(req.query.id);\n\t\tconst tracks = await this.metaDataService.getArtistSimilarTracks(artist);\n\t\treturn this.trackController.prepareList(paginate(tracks, req.query.amount, req.query.offset), req.query, req.user);\n\t}\n\n\tasync list(req: JamRequest<JamParameters.ArtistList>): Promise<Array<Jam.Artist>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n\n\tasync index(req: JamRequest<JamParameters.Index>): Promise<Jam.ArtistIndex> {\n\t\tconst artistIndex = await this.indexService.getArtistIndex();\n\t\treturn formatArtistIndex(this.indexService.filterArtistIndex(req.query.rootID, artistIndex));\n\t}\n\n\tasync tracks(req: JamRequest<JamParameters.Tracks>): Promise<Array<Jam.Track>> {\n\t\tconst artists = await this.byIDs(req.query.ids);\n\t\tlet trackIDs: Array<string> = [];\n\t\tartists.forEach(artist => {\n\t\t\ttrackIDs = trackIDs.concat(artist.trackIDs);\n\t\t});\n\t\treturn this.trackController.prepareListByIDs(trackIDs, req.query, req.user, this.sortArtistTracks);\n\t}\n\n\tasync info(req: JamRequest<JamParameters.ID>): Promise<Jam.Info> {\n\t\tconst artist = await this.byID(req.query.id);\n\t\treturn {info: await this.metaDataService.getArtistInfo(artist)};\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Artist} from './artist.model';\n\nexport function formatArtist(artist: Artist, includes: JamParameters.IncludesArtist): Jam.Artist {\n\tlet mbz: any = {\n\t\tartistID: artist.mbArtistID\n\t};\n\tif (!Object.keys(mbz).find(key => !!mbz[key])) {\n\t\tmbz = undefined;\n\t}\n\treturn {\n\t\tid: artist.id,\n\t\tname: artist.name,\n\t\talbumCount: artist.albumIDs.length,\n\t\talbumTypes: artist.albumTypes,\n\t\talbumIDs: includes.artistAlbumIDs ? artist.albumIDs : undefined,\n\t\ttrackIDs: includes.artistTracksIDs ? artist.trackIDs : undefined,\n\t\ttrackCount: artist.trackIDs.length,\n\t\tcreated: artist.created,\n\t\tmusicbrainz: mbz\n\t};\n}\n","import {BaseController} from '../base/base.controller';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {UnauthError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {TrackController} from '../track/track.controller';\nimport {formatState} from '../state/state.format';\nimport {formatPlaylist} from './playlist.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryPlaylist} from './playlist.store';\nimport {PlaylistService} from './playlist.service';\nimport {Playlist} from './playlist.model';\nimport {User} from '../user/user.model';\n\nexport class PlaylistController extends BaseController<JamParameters.Playlist, JamParameters.Playlists, JamParameters.IncludesPlaylist, SearchQueryPlaylist, JamParameters.PlaylistSearch, Playlist, Jam.Playlist> {\n\n\tconstructor(\n\t\tprivate playlistService: PlaylistService,\n\t\tprivate trackController: TrackController,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(playlistService, stateService, imageService, downloadService);\n\t}\n\n\t// TODO: filter none public playlist in base api functions?\n\n\tdefaultSort(items: Array<Playlist>): Array<Playlist> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tasync prepare(playlist: Playlist, includes: JamParameters.IncludesPlaylist, user: User): Promise<Jam.Playlist> {\n\t\tconst result = formatPlaylist(playlist, includes);\n\t\tif (includes.playlistState) {\n\t\t\tconst state = await this.stateService.findOrCreate(playlist.id, user.id, DBObjectType.artist);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\tif (includes.playlistTracks) {\n\t\t\tresult.tracks = await this.trackController.prepareListByIDs(playlist.trackIDs, includes, user);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.PlaylistSearch, user: User): Promise<SearchQueryPlaylist> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tname: query.name,\n\t\t\tuserID: user.id,\n\t\t\tisPublic: query.isPublic,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync create(req: JamRequest<JamParameters.PlaylistNew>): Promise<Jam.Playlist> {\n\t\tconst playlist = await this.playlistService.create(req.query.name, req.query.comment, req.query.isPublic === undefined ? false : req.query.isPublic, req.user.id, req.query.trackIDs || []);\n\t\treturn this.prepare(playlist, {playlistTracksIDs: true, playlistState: true}, req.user);\n\t}\n\n\tasync update(req: JamRequest<JamParameters.PlaylistUpdate>): Promise<void> {\n\t\tconst playlist = await this.byID(req.query.id);\n\t\tif (playlist.userID !== req.user.id) {\n\t\t\treturn Promise.reject(UnauthError());\n\t\t}\n\t\tplaylist.name = req.query.name || playlist.name;\n\t\tplaylist.comment = req.query.comment || playlist.comment;\n\t\tplaylist.isPublic = req.query.isPublic === undefined ? playlist.isPublic : req.query.isPublic;\n\t\tplaylist.changed = Date.now();\n\t\tplaylist.trackIDs = req.query.trackIDs || [];\n\t\tawait this.playlistService.update(playlist);\n\t}\n\n\tasync tracks(req: JamRequest<JamParameters.Tracks>): Promise<Array<Jam.Track>> {\n\t\tlet playlists = await this.byIDs(req.query.ids);\n\t\tplaylists = playlists.filter(playlist => playlist.userID === req.user.id);\n\t\tlet trackIDs: Array<string> = [];\n\t\tplaylists.forEach(playlist => {\n\t\t\ttrackIDs = trackIDs.concat(playlist.trackIDs);\n\t\t});\n\t\treturn this.trackController.prepareListByIDs(trackIDs, req.query, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst playlist = await this.byID(req.query.id);\n\t\tif (playlist.userID !== req.user.id) {\n\t\t\treturn Promise.reject(UnauthError());\n\t\t}\n\t\tawait this.playlistService.remove(playlist);\n\t}\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Playlist} from './playlist.model';\n\nexport function formatPlaylist(playlist: Playlist, includes: JamParameters.IncludesPlaylist): Jam.Playlist {\n\treturn {\n\t\tid: playlist.id,\n\t\tname: playlist.name,\n\t\tuserID: playlist.userID,\n\t\tcomment: playlist.comment,\n\t\tisPublic: playlist.isPublic,\n\t\tduration: playlist.duration,\n\t\tcreated: playlist.created,\n\t\tchanged: playlist.changed,\n\t\ttrackCount: playlist.trackIDs.length,\n\t\ttrackIDs: includes.playlistTracksIDs ? playlist.trackIDs : undefined\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport path from 'path';\nimport {IApiBinaryResult} from '../../typings';\nimport {paginate} from '../../utils/paginate';\nimport {JamRequest} from '../../api/jam/api';\nimport {BaseListController} from '../base/base.list.controller';\nimport {formatTrack} from './track.format';\nimport {SearchQueryTrack} from './track.store';\nimport {AudioModule} from '../../modules/audio/audio.module';\nimport {BookmarkService} from '../bookmark/bookmark.service';\nimport {MetaDataService} from '../metadata/metadata.service';\nimport {formatState} from '../state/state.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {Track} from './track.model';\nimport {User} from '../user/user.model';\nimport {IoService} from '../../engine/io/io.service';\nimport {StreamController} from '../../engine/stream/stream.controller';\nimport {TrackService} from './track.service';\nimport {FolderService} from '../folder/folder.service';\nimport {AudioFormatType} from '../../model/jam-types';\nimport {ID3v2FrameValues} from '../../model/id3v2-frame-values';\n\nexport class TrackController extends BaseListController<JamParameters.Track, JamParameters.Tracks, JamParameters.IncludesTrack, SearchQueryTrack, JamParameters.TrackSearch, Track, Jam.Track> {\n\n\tconstructor(\n\t\tprivate trackService: TrackService,\n\t\tprivate folderService: FolderService,\n\t\tprivate audioModule: AudioModule,\n\t\tprivate bookmarkService: BookmarkService,\n\t\tprivate metaService: MetaDataService,\n\t\tprivate streamController: StreamController,\n\t\tprivate ioService: IoService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(trackService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(tracks: Array<Track>): Array<Track> {\n\t\treturn tracks.sort((a, b) => {\n\t\t\t\tif (a.tag.track !== undefined && b.tag.track !== undefined) {\n\t\t\t\t\tconst res = a.tag.track - b.tag.track;\n\t\t\t\t\tif (res !== 0) {\n\t\t\t\t\t\treturn res;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn a.name.localeCompare(b.name);\n\t\t\t}\n\t\t);\n\t}\n\n\tasync prepare(track: Track, includes: JamParameters.IncludesTrack, user: User): Promise<Jam.Track> {\n\t\tconst result = formatTrack(track, includes);\n\t\tif (includes.trackID3) {\n\t\t\tresult.tagID3 = await this.getID3(track);\n\t\t}\n\t\tif (includes.trackState) {\n\t\t\tconst state = await this.stateService.findOrCreate(track.id, user.id, DBObjectType.track);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.TrackSearch, user: User): Promise<SearchQueryTrack> {\n\t\tlet inPath: string | undefined;\n\t\tif (query.childOfID) {\n\t\t\tconst folder = await this.folderService.folderStore.byId(query.childOfID);\n\t\t\tif (folder) {\n\t\t\t\tinPath = folder.path;\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\trootID: query.rootID,\n\t\t\tparentID: query.parentID,\n\t\t\tparentIDs: query.parentIDs,\n\t\t\tinPath,\n\t\t\tartist: query.artist,\n\t\t\ttitle: query.title,\n\t\t\talbum: query.album,\n\t\t\tgenre: query.genre,\n\t\t\tnewerThan: query.newerThan,\n\t\t\tfromYear: query.fromYear,\n\t\t\ttoYear: query.toYear,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\t// more track api\n\n\tasync getID3(track: Track): Promise<Jam.ID3Tag | undefined> {\n\t\tif (track.media.format === AudioFormatType.mp3) {\n\t\t\ttry {\n\t\t\t\treturn await this.audioModule.readID3v2(path.join(track.path, track.name));\n\t\t\t} catch (e) {\n\t\t\t\tconst frames: ID3v2FrameValues.Frames = {};\n\t\t\t\tif (track.tag.album) {\n\t\t\t\t\tframes['TALB'] = [{text: track.tag.album}];\n\t\t\t\t}\n\t\t\t\tif (track.tag.artist) {\n\t\t\t\t\tframes['TPE1'] = [{text: track.tag.artist}];\n\t\t\t\t}\n\t\t\t\tif (track.tag.title) {\n\t\t\t\t\tframes['TIT2'] = [{text: track.tag.title}];\n\t\t\t\t}\n\t\t\t\tif (track.tag.year) {\n\t\t\t\t\tframes['TDRC'] = [{text: track.tag.year.toString()}];\n\t\t\t\t}\n\t\t\t\tif (track.tag.track) {\n\t\t\t\t\tframes['TRCK'] = [{text: track.tag.track.toString()}];\n\t\t\t\t}\n\t\t\t\tif (track.tag.genre) {\n\t\t\t\t\tframes['TCON'] = [{text: track.tag.genre}];\n\t\t\t\t}\n\t\t\t\treturn {version: 4, frames};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync tagID3(req: JamRequest<JamParameters.ID>): Promise<Jam.ID3Tag> {\n\t\tconst track = await this.byID(req.query.id);\n\t\tconst result = await this.getID3(track);\n\t\tif (!result) {\n\t\t\treturn Promise.reject(Error('Not a mp3 file'));\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync tagID3s(req: JamRequest<JamParameters.IDs>): Promise<Jam.ID3Tags> {\n\t\tlet tracks = await this.byIDs(req.query.ids);\n\t\ttracks = this.defaultSort(tracks);\n\t\tconst result: Jam.ID3Tags = {};\n\t\tfor (const track of tracks) {\n\t\t\tconst tag = await this.getID3(track);\n\t\t\tif (tag) {\n\t\t\t\tresult[track.id] = tag;\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync tagID3Update(req: JamRequest<JamParameters.TagID3Update>): Promise<void> {\n\t\tconst track = await this.byID(req.query.id);\n\t\tawait this.audioModule.saveID3v2(path.join(track.path, track.name), req.query.tag);\n\t\tthis.ioService.refreshTrack(track);\n\t}\n\n\t// async tagID3sUpdate(req: JamRequest<JamParameters.TagID3sUpdate>): Promise<void> {\n\t// \tconst tracks = await this.byIDs(req.query.tagID3s.map(tagID3 => tagID3.id));\n\t// \tconst list: Array<{ track?: Track; tag: Jam.ID3Tag }> = req.query.tagID3s.map(tagID3 => {\n\t// \t\treturn {track: tracks.find(t => t.id === tagID3.id), tag: tagID3.tag};\n\t// \t});\n\t// \tfor (const item of list) {\n\t// \t\tif (!item.track) {\n\t// \t\t\treturn Promise.reject(NotFoundError());\n\t// \t\t}\n\t// \t\tawait this.audioModule.saveID3v2(path.join(item.track.path, item.track.name), item.tag);\n\t// \t}\n\t// \tthis.ioService.refreshTracks(tracks);\n\t// }\n\n\tasync stream(req: JamRequest<JamParameters.Stream>): Promise<IApiBinaryResult> {\n\t\tconst track = await this.byID(req.query.id);\n\t\treturn await this.streamController.streamTrack(track, req.query.format, req.query.maxBitRate, req.user);\n\t}\n\n\tasync similar(req: JamRequest<JamParameters.SimilarTracks>): Promise<Array<Jam.Track>> {\n\t\tconst track = await this.byID(req.query.id);\n\t\tconst tracks = await this.metaService.getTrackSimilarTracks(track);\n\t\treturn this.prepareList(paginate(tracks, req.query.amount, req.query.offset), req.query, req.user);\n\t}\n\n\tasync list(req: JamRequest<JamParameters.TrackList>): Promise<Array<Jam.Track>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n\n\tasync nameUpdate(req: JamRequest<JamParameters.TrackEditName>): Promise<void> {\n\t\tconst track = await this.byID(req.query.id);\n\t\tawait this.trackService.renameTrack(track, req.query.name);\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {ArtworkImageType, FolderType, FolderTypesAlbum} from '../../model/jam-types';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {paginate} from '../../utils/paginate';\nimport {JamRequest} from '../../api/jam/api';\nimport {BaseListController} from '../base/base.list.controller';\nimport {TrackController} from '../track/track.controller';\nimport {formatFolder, formatFolderArtwork, formatFolderArtworks} from './folder.format';\nimport {formatState} from '../state/state.format';\nimport {formatFolderIndex} from '../../engine/index/index.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryFolder} from './folder.store';\nimport {SearchQueryTrack} from '../track/track.store';\nimport {MetaDataService} from '../metadata/metadata.service';\nimport {IndexService} from '../../engine/index/index.service';\nimport {User} from '../user/user.model';\nimport {FolderService} from './folder.service';\nimport path from 'path';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Artwork, Folder} from './folder.model';\nimport {IApiBinaryResult} from '../../typings';\nimport {FolderRulesChecker} from '../../engine/health/folder.rule';\nimport {DBObjectType} from '../../db/db.types';\n\nexport class FolderController extends BaseListController<JamParameters.Folder, JamParameters.Folders, JamParameters.IncludesFolderChildren, SearchQueryFolder, JamParameters.FolderSearch, Folder, Jam.Folder> {\n\tchecker = new FolderRulesChecker();\n\n\tconstructor(\n\t\tprotected folderService: FolderService,\n\t\tprivate trackController: TrackController,\n\t\tprivate metadataService: MetaDataService,\n\t\tprivate indexService: IndexService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(folderService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Folder>): Array<Folder> {\n\t\treturn items.sort((a, b) => (a.tag && a.tag.title ? a.tag.title : path.basename(a.path)).localeCompare((b.tag && b.tag.title ? b.tag.title : path.basename(b.path))));\n\t}\n\n\tasync prepare(folder: Folder, includes: JamParameters.IncludesFolderChildren, user: User): Promise<Jam.Folder> {\n\t\tconst result = formatFolder(folder, includes);\n\t\tif (includes.folderChildren || includes.folderTracks) {\n\t\t\tresult.tracks = await this.trackController.prepareByQuery({parentID: folder.id}, includes, user);\n\t\t}\n\t\tif (includes.folderChildren || includes.folderSubfolders) {\n\t\t\tconst folders = await this.folderService.folderStore.search({parentID: folder.id, sorts: [{field: 'name', descending: false}]});\n\t\t\t// TODO: introduce children includes?\n\t\t\tresult.folders = await this.prepareList(folders,\n\t\t\t\t{folderState: includes.folderState, folderHealth: includes.folderHealth, folderCounts: includes.folderCounts, folderTag: includes.folderTag}\n\t\t\t\t, user);\n\t\t}\n\t\tif (includes.folderState) {\n\t\t\tconst state = await this.stateService.findOrCreate(folder.id, user.id, DBObjectType.folder);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\tif (includes.folderInfo) {\n\t\t\tif (folder.tag.type === FolderType.artist) {\n\t\t\t\tresult.info = await this.metadataService.getFolderArtistInfo(folder);\n\t\t\t} else if (FolderTypesAlbum.indexOf(folder.tag.type) >= 0) {\n\t\t\t\tresult.info = await this.metadataService.getFolderAlbumInfo(folder);\n\t\t\t}\n\t\t}\n\t\tif (includes.folderSimilar) {\n\t\t\tif (folder.tag.type === FolderType.artist) {\n\t\t\t\t// TODO: introduce children includes?\n\t\t\t\tresult.similar = await this.prepareList(await this.metadataService.getSimilarArtistFolders(folder),\n\t\t\t\t\t{folderState: includes.folderState, folderCounts: includes.folderCounts, folderTag: includes.folderTag}\n\t\t\t\t\t, user);\n\t\t\t}\n\t\t}\n\t\tif (includes.folderHealth) {\n\t\t\tresult.health = await this.checker.run(folder);\n\t\t}\n\t\tif (includes.folderParents) {\n\t\t\tconst parents = await this.folderService.collectFolderPath(folder.parentID);\n\t\t\tresult.parents = parents.map(parent => {\n\t\t\t\treturn {\n\t\t\t\t\tid: parent.id,\n\t\t\t\t\tname: path.basename(parent.path)\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.FolderSearch, user: User): Promise<SearchQueryFolder> {\n\t\tlet inPath: string | undefined;\n\t\tif (query.childOfID) {\n\t\t\tconst folder = await this.folderService.folderStore.byId(query.childOfID);\n\t\t\tif (folder) {\n\t\t\t\tinPath = folder.path;\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tid: query.id,\n\t\t\trootID: query.rootID,\n\t\t\tparentID: query.parentID,\n\t\t\tinPath,\n\t\t\tartist: query.artist,\n\t\t\ttitle: query.title,\n\t\t\talbum: query.album,\n\t\t\tgenre: query.genre,\n\t\t\tlevel: query.level,\n\t\t\tnewerThan: query.newerThan,\n\t\t\tfromYear: query.fromYear,\n\t\t\ttoYear: query.toYear,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\ttypes: query.type ? [query.type] : undefined,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\t/* more folder api */\n\n\tasync subfolders(req: JamRequest<JamParameters.FolderSubFolders>): Promise<Array<Jam.Folder>> {\n\t\tconst list = await this.folderService.folderStore.search({parentID: req.query.id});\n\t\treturn this.prepareList(list, req.query, req.user);\n\t}\n\n\tasync tracks(req: JamRequest<JamParameters.FolderTracks>): Promise<Array<Jam.Track>> {\n\t\tconst folders = await this.byIDs(req.query.ids);\n\t\tconst trackQuery: SearchQueryTrack = req.query.recursive ? {inPaths: folders.map(folder => folder.path)} : {parentIDs: folders.map(folder => folder.id)};\n\t\treturn this.trackController.prepareByQuery(trackQuery, req.query, req.user);\n\t}\n\n\tasync children(req: JamRequest<JamParameters.FolderChildren>): Promise<Jam.FolderChildren> {\n\t\tconst folders = await this.folderService.folderStore.search({parentID: req.query.id});\n\t\tconst resultTracks = await this.trackController.prepareByQuery({parentID: req.query.id}, req.query, req.user);\n\t\tconst resultFolders = await this.prepareList(folders, req.query, req.user);\n\t\treturn {folders: resultFolders, tracks: resultTracks};\n\t}\n\n\tasync imageUploadUpdate(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tif (!req.file) {\n\t\t\treturn Promise.reject(InvalidParamError('Image upload failed'));\n\t\t}\n\t\tconst folder = await this.byID(req.query.id);\n\t\tawait this.folderService.setFolderImage(folder, req.file);\n\t}\n\n\tasync nameUpdate(req: JamRequest<JamParameters.FolderEditName>): Promise<void> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\tawait this.folderService.renameFolder(folder, req.query.name);\n\t}\n\n\tasync artistInfo(req: JamRequest<JamParameters.ID>): Promise<Jam.Info> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\treturn {info: await this.metadataService.getFolderArtistInfo(folder)};\n\t}\n\n\tasync artistSimilar(req: JamRequest<JamParameters.Folder>): Promise<Array<Jam.Folder>> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\tconst list = await this.metadataService.getSimilarArtistFolders(folder);\n\t\treturn this.prepareList(list, req.query, req.user);\n\t}\n\n\tasync albumInfo(req: JamRequest<JamParameters.ID>): Promise<Jam.Info> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\treturn {info: await this.metadataService.getFolderAlbumInfo(folder)};\n\t}\n\n\tasync artistSimilarTracks(req: JamRequest<JamParameters.SimilarTracks>): Promise<Array<Jam.Track>> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\tconst tracks = await this.metadataService.getFolderSimilarTracks(folder);\n\t\treturn this.trackController.prepareList(paginate(tracks, req.query.amount, req.query.offset), req.query, req.user);\n\t}\n\n\tasync list(req: JamRequest<JamParameters.FolderList>): Promise<Array<Jam.Folder>> {\n\t\treturn this.getList(req.query, req.query, req.query, req.user);\n\t}\n\n\tasync index(req: JamRequest<JamParameters.Index>): Promise<Jam.FolderIndex> {\n\t\tconst folderIndex = await this.indexService.getFolderIndex();\n\t\treturn formatFolderIndex(this.indexService.filterFolderIndex(req.query.rootID, folderIndex));\n\t}\n\n\tasync artworks(req: JamRequest<JamParameters.ID>): Promise<Array<Jam.ArtworkImage>> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\treturn formatFolderArtworks(folder);\n\t}\n\n\tprivate async artworkByID(id: string): Promise<{ artwork: Artwork, folder: Folder }> {\n\t\tconst folderID = id.split('-')[0];\n\t\tconst folder = await this.byID(folderID);\n\t\tconst artwork = (folder.tag.artworks || []).find(art => art.id === id);\n\t\tif (!artwork) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\treturn {folder, artwork};\n\t}\n\n\tasync artworkImage(req: JamRequest<JamParameters.Image>): Promise<IApiBinaryResult> {\n\t\tconst {folder, artwork} = await this.artworkByID(req.query.id);\n\t\treturn await this.folderService.getArtworkImage(folder, artwork, req.query.size, req.query.format);\n\t}\n\n\tasync artworkCreate(req: JamRequest<JamParameters.FolderArtworkNew>): Promise<Jam.ArtworkImage> {\n\t\tconst folder = await this.byID(req.query.id);\n\t\tconst artwork = await this.folderService.downloadFolderArtwork(folder, req.query.url, <Array<ArtworkImageType>>req.query.types);\n\t\treturn formatFolderArtwork(artwork);\n\t}\n\n\tasync artworkDelete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst {folder, artwork} = await this.artworkByID(req.query.id);\n\t\treturn await this.folderService.removeArtworkImage(folder, artwork);\n\t}\n\n\tasync health(req: JamRequest<JamParameters.FolderHealth>): Promise<Array<Jam.Folder>> {\n\t\tconst list = await this.service.store.search(await this.translateQuery(req.query, req.user));\n\t\treq.query.folderHealth = true;\n\t\tconst folders = await this.prepareList(list, req.query, req.user);\n\t\treturn folders.filter(f => f.health && f.health.length > 0);\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport path from 'path';\nimport {FolderType, FolderTypesAlbum} from '../../model/jam-types';\nimport {Artwork, Folder} from './folder.model';\n\nexport function formatFolderArtwork(artwork: Artwork): Jam.ArtworkImage {\n\treturn {\n\t\tid: artwork.id,\n\t\tname: artwork.name,\n\t\ttypes: artwork.types,\n\t\tsize: artwork.stat.size\n\t};\n}\n\nexport function formatFolderArtworks(folder: Folder): Array<Jam.ArtworkImage> {\n\tif (!folder.tag.artworks) {\n\t\treturn [];\n\t}\n\treturn folder.tag.artworks.map(artwork => formatFolderArtwork(artwork));\n}\n\nfunction formatFolderTag(folder: Folder): Jam.FolderTag {\n\tconst isAlbum = FolderTypesAlbum.indexOf(folder.tag.type) >= 0;\n\tconst isArtist = folder.tag.type === FolderType.artist;\n\tlet mbz: Jam.FolderMBTag | undefined = {\n\t\tartistID: isArtist || isAlbum ? folder.tag.mbArtistID : undefined,\n\t\treleaseID: isAlbum ? folder.tag.mbAlbumID : undefined,\n\t\treleaseGroupID: isAlbum ? folder.tag.mbReleaseGroupID : undefined\n\t};\n\tif (!Object.keys(mbz).find(key => !!(<any>mbz)[key])) {\n\t\tmbz = undefined;\n\t}\n\treturn {\n\t\tartist: folder.tag.artist,\n\t\tartistSort: folder.tag.artistSort,\n\t\talbum: isAlbum ? folder.tag.album : undefined,\n\t\talbumType: isAlbum ? folder.tag.albumType : undefined,\n\t\tgenre: folder.tag.genre,\n\t\tyear: isAlbum ? folder.tag.year : undefined,\n\t\tmusicbrainz: mbz\n\t};\n}\n\nexport function formatFolder(folder: Folder, includes: JamParameters.IncludesFolder): Jam.Folder {\n\tincludes = includes || {};\n\treturn {\n\t\tid: folder.id,\n\t\tlevel: folder.tag ? folder.tag.level : -1,\n\t\tparentID: folder.parentID,\n\t\tname: path.basename(folder.path),\n\t\tcreated: folder.stat.created,\n\t\ttrackCount: includes.folderCounts ? folder.tag.trackCount : undefined,\n\t\tfolderCount: includes.folderCounts ? folder.tag.folderCount : undefined,\n\t\ttype: <Jam.FolderType>((folder.tag.type !== undefined) ? (FolderType[folder.tag.type] || 'unknown') : 'unknown'),\n\t\ttag: includes.folderTag ? formatFolderTag(folder) : undefined,\n\t\tartworks: includes.folderArtworks ? formatFolderArtworks(folder) : undefined\n\t};\n}\n","import {Rule, RuleResult} from './rule.model';\nimport {Folder, FolderTag} from '../../objects/folder/folder.model';\nimport {FolderType, FolderTypesAlbum} from '../../model/jam-types';\nimport path from 'path';\nimport {replaceFolderSystemChars} from '../../utils/fs-utils';\nimport {Jam} from '../../model/jam-rest-data';\n\nexport abstract class FolderRule implements Rule<Folder> {\n\n\tprotected constructor(public id: string, public name: string) {\n\n\t}\n\n\tabstract run(folder: Folder): Promise<RuleResult | undefined>;\n}\n\nexport class FolderAlbumTagsRule extends FolderRule {\n\n\tconstructor() {\n\t\tsuper('folder.album.tags.exists', 'Album folder values are missing');\n\t}\n\n\tasync run(folder: Folder): Promise<RuleResult | undefined> {\n\t\tif (FolderTypesAlbum.indexOf(folder.tag.type) >= 0) {\n\t\t\tconst missing = [];\n\t\t\tif (!folder.tag.album) {\n\t\t\t\tmissing.push('album');\n\t\t\t}\n\t\t\tif (!folder.tag.artist) {\n\t\t\t\tmissing.push('artist');\n\t\t\t}\n\t\t\tif (!folder.tag.year) {\n\t\t\t\tmissing.push('year');\n\t\t\t}\n\t\t\tif (!folder.tag.genre) {\n\t\t\t\tmissing.push('genre');\n\t\t\t}\n\t\t\tif (!folder.tag.mbAlbumID) {\n\t\t\t\tmissing.push('musicbrainz album id');\n\t\t\t} else {\n\t\t\t\tif (!folder.tag.mbAlbumType) {\n\t\t\t\t\tmissing.push('musicbrainz album type');\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (missing.length > 0) {\n\t\t\t\treturn {details: missing.join(',')};\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nexport class FolderAlbumNameRule extends FolderRule {\n\n\tconstructor() {\n\t\tsuper('folder.album.name.conform', 'Album folder name is not conform');\n\t}\n\n\tgetNiceFolderName(tag: FolderTag): string {\n\t\tconst year = tag.year ? tag.year.toString() : '';\n\t\tlet name = (tag.album || '')\n\t\t\t.replace(/[!?]/g, '')\n\t\t\t.replace(/[\\//]/g, '-');\n\t\tname = replaceFolderSystemChars(name, '_');\n\t\tconst s = (year.length > 0 ? '[' + replaceFolderSystemChars(year, '_') + '] ' : '') + name;\n\t\treturn s.trim();\n\t}\n\n\tcheckName(folder: Folder): RuleResult | undefined {\n\t\tif ((folder.tag.album) && (folder.tag.year) && (folder.tag.year > 0)) {\n\t\t\tconst nameSlug = path.basename(folder.path).trim().replace(/[_:!?\\/ ]/g, '').toLowerCase();\n\t\t\tconst nicename = this.getNiceFolderName(folder.tag);\n\t\t\tconst nicenameSlug = nicename.replace(/[_:!?\\/ ]/g, '').toLowerCase();\n\t\t\tif (nameSlug.localeCompare(nicenameSlug) !== 0) {\n\t\t\t\treturn {details: nicename};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run(folder: Folder): Promise<RuleResult | undefined> {\n\t\tif (folder.tag.type === FolderType.album) {\n\t\t\treturn this.checkName(folder);\n\t\t} else if ((folder.tag.type === FolderType.multialbum) && (folder.tag.trackCount === 0)) {\n\t\t\treturn this.checkName(folder);\n\t\t}\n\t}\n\n}\n\nexport class FolderAlbumImageRule extends FolderRule {\n\n\tconstructor() {\n\t\tsuper('folder.album.image.exists', 'Album folder image is missing');\n\t}\n\n\tasync run(folder: Folder): Promise<RuleResult | undefined> {\n\t\tif ((FolderTypesAlbum.indexOf(folder.tag.type) >= 0) && (!folder.tag.image)) {\n\t\t\treturn {};\n\t\t}\n\t}\n\n}\n\nexport class FolderArtistImageRule extends FolderRule {\n\n\tconstructor() {\n\t\tsuper('folder.artist.image.exists', 'Artist folder image is missing');\n\t}\n\n\tasync run(folder: Folder): Promise<RuleResult | undefined> {\n\t\tif ((folder.tag.type === FolderType.artist) && (!folder.tag.image)) {\n\t\t\treturn {};\n\t\t}\n\t}\n\n}\n\nexport class FolderArtistNameRule extends FolderRule {\n\n\tconstructor() {\n\t\tsuper('folder.artist.name.conform', 'Artist folder name is not conform');\n\t}\n\n\tcheckName(folder: Folder): RuleResult | undefined {\n\t\tif (folder.tag.artist) {\n\t\t\tconst nameSlug = path.basename(folder.path).trim().replace(/[_:!?\\/ ]/g, '').toLowerCase();\n\t\t\tconst artistName = replaceFolderSystemChars(folder.tag.artist, '_');\n\t\t\tconst artistNameSlug = artistName.replace(/[_:!?\\/ ]/g, '').toLowerCase();\n\t\t\tif (nameSlug.localeCompare(artistNameSlug) !== 0) {\n\t\t\t\treturn {details: artistName};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run(folder: Folder): Promise<RuleResult | undefined> {\n\t\tif (folder.tag.type === FolderType.artist) {\n\t\t\treturn this.checkName(folder);\n\t\t}\n\t}\n\n}\n\nexport class FolderRulesChecker {\n\trules: Array<FolderRule> = [];\n\n\tconstructor() {\n\t\tthis.rules.push(new FolderAlbumTagsRule());\n\t\tthis.rules.push(new FolderAlbumNameRule());\n\t\tthis.rules.push(new FolderAlbumImageRule());\n\t\tthis.rules.push(new FolderArtistImageRule());\n\t\tthis.rules.push(new FolderArtistNameRule());\n\t}\n\n\tasync run(folder: Folder): Promise<Array<Jam.Problem>> {\n\t\tconst result: Array<Jam.Problem> = [];\n\t\tfor (const rule of this.rules) {\n\t\t\tconst match = await rule.run(folder);\n\t\t\tif (match) {\n\t\t\t\tresult.push({\n\t\t\t\t\tid: rule.id,\n\t\t\t\t\tname: rule.name,\n\t\t\t\t\tdetails: match.details\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n}\n","import {BaseController} from '../base/base.controller';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {JamRequest} from '../../api/jam/api';\nimport {SearchQueryRoot} from './root.store';\nimport {RootService} from './root.service';\nimport {formatRoot} from './root.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {Root} from './root.model';\nimport {User} from '../user/user.model';\nimport {IoService} from '../../engine/io/io.service';\nimport {RootScanStrategy} from '../../model/jam-types';\n\nexport class RootController extends BaseController<JamParameters.ID, JamParameters.IDs, {}, SearchQueryRoot, JamParameters.RootSearch, Root, Jam.Root> {\n\n\tconstructor(\n\t\tprivate rootService: RootService,\n\t\tprivate ioService: IoService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(rootService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Root>): Array<Root> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tasync prepare(root: Root, includes: {}, user: User): Promise<Jam.Root> {\n\t\treturn formatRoot(root, this.ioService.getRootStatus(root.id));\n\t}\n\n\tasync translateQuery(query: JamParameters.RootSearch, user: User): Promise<SearchQueryRoot> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync create(req: JamRequest<JamParameters.RootNew>): Promise<Jam.Root> {\n\t\tconst root: Root = {\n\t\t\tid: '',\n\t\t\tcreated: Date.now(),\n\t\t\ttype: DBObjectType.root,\n\t\t\tname: req.query.name,\n\t\t\tpath: req.query.path,\n\t\t\tstrategy: <RootScanStrategy>req.query.strategy\n\t\t};\n\t\troot.id = await this.rootService.create(root);\n\t\treturn this.prepare(root, {}, req.user);\n\t}\n\n\tasync update(req: JamRequest<JamParameters.RootUpdate>): Promise<Jam.Root> {\n\t\tconst root = await this.byID(req.query.id);\n\t\troot.name = req.query.name;\n\t\troot.path = req.query.path;\n\t\tconst forceRefreshMeta = root.strategy !== req.query.strategy;\n\t\troot.strategy = <RootScanStrategy>req.query.strategy;\n\t\tawait this.rootService.update(root);\n\t\tthis.ioService.refreshRoot(root, forceRefreshMeta);\n\t\treturn this.prepare(root, {}, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst root = await this.byID(req.query.id);\n\t\tawait this.ioService.removeRoot(root);\n\t}\n\n\tasync scanAll(req: JamRequest<{}>): Promise<void> {\n\t\tthis.ioService.refresh();\n\t}\n\n\tasync scan(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst root = await this.byID(req.query.id);\n\t\tthis.ioService.refreshRoot(root, false);\n\t}\n\n\tasync status(req: JamRequest<JamParameters.ID>): Promise<Jam.RootStatus> {\n\t\tconst root = await this.byID(req.query.id);\n\t\treturn this.ioService.getRootStatus(root.id);\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Root, RootStatus} from './root.model';\n\nexport function formatRoot(root: Root, rootState: RootStatus): Jam.Root {\n\treturn {\n\t\tid: root.id,\n\t\tname: root.name,\n\t\tcreated: root.created,\n\t\tpath: root.path,\n\t\tstatus: rootState,\n\t\tstrategy: root.strategy\n\t};\n}\n","import {BaseController} from '../base/base.controller';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {GenericError, InvalidParamError, UnauthError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatUser} from './user.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryUser} from './user.store';\nimport {UserService} from './user.service';\nimport {User} from './user.model';\nimport {hashSaltPassword} from '../../utils/salthash';\nimport {randomString} from '../../utils/random';\n\nexport class UserController extends BaseController<JamParameters.ID, JamParameters.IDs, {}, SearchQueryUser, JamParameters.UserSearch, User, Jam.User> {\n\n\tconstructor(\n\t\tprivate userService: UserService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(userService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<User>): Array<User> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tasync prepare(item: User, includes: {}, user: User): Promise<Jam.User> {\n\t\treturn formatUser(item);\n\t}\n\n\tasync translateQuery(query: JamParameters.UserSearch, user: User): Promise<SearchQueryUser> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tname: query.name,\n\t\t\tisAdmin: query.isAdmin,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync create(req: JamRequest<JamParameters.UserNew>): Promise<Jam.User> {\n\t\tconst pass = randomString(10);\n\t\tconst pw = hashSaltPassword(pass);\n\t\tconst u: User = {\n\t\t\tid: '',\n\t\t\tname: req.query.name || '',\n\t\t\tsalt: pw.salt,\n\t\t\thash: pw.hash,\n\t\t\temail: '',\n\t\t\tsubsonic_pass: randomString(10),\n\t\t\ttype: DBObjectType.user,\n\t\t\tcreated: Date.now(),\n\t\t\t// ldapAuthenticated: false,\n\t\t\tscrobblingEnabled: false,\n\t\t\troles: {\n\t\t\t\tadmin: req.query.roleAdmin !== undefined ? req.query.roleAdmin : false,\n\t\t\t\tstream: req.query.roleStream !== undefined ? req.query.roleStream : true,\n\t\t\t\tupload: req.query.roleUpload !== undefined ? req.query.roleUpload : false,\n\t\t\t\tpodcast: req.query.rolePodcast !== undefined ? req.query.rolePodcast : false,\n\t\t\t\t// settingsRole: false,\n\t\t\t\t// jukeboxRole: false,\n\t\t\t\t// downloadRole: false,\n\t\t\t\t// playlistRole: false,\n\t\t\t\t// coverArtRole: false,\n\t\t\t\t// commentRole: false,\n\t\t\t\t// shareRole: false,\n\t\t\t\t// videoConversionRole: false\n\t\t\t}\n\t\t};\n\t\tu.id = await this.userService.create(u);\n\t\treturn this.prepare(u, {}, req.user);\n\t}\n\n\n\tasync update(req: JamRequest<JamParameters.UserUpdate>): Promise<Jam.User> {\n\t\tconst u = await this.byID(req.query.id);\n\t\tif (req.query.name) {\n\t\t\tif (req.query.name !== u.name) {\n\t\t\t\tconst u2 = await this.userService.getByName(req.query.name);\n\t\t\t\tif (u2) {\n\t\t\t\t\treturn Promise.reject(GenericError('Username already exists'));\n\t\t\t\t}\n\t\t\t}\n\t\t\tu.name = req.query.name.trim();\n\t\t}\n\t\tif (req.query.email) {\n\t\t\tu.email = req.query.email.trim();\n\t\t}\n\t\tif (req.query.roleAdmin !== undefined) {\n\t\t\tu.roles.admin = req.query.roleAdmin;\n\t\t}\n\t\tif (req.query.rolePodcast !== undefined) {\n\t\t\tu.roles.podcast = req.query.rolePodcast;\n\t\t}\n\t\tif (req.query.roleStream !== undefined) {\n\t\t\tu.roles.stream = req.query.roleStream;\n\t\t}\n\t\tif (req.query.roleUpload !== undefined) {\n\t\t\tu.roles.upload = req.query.roleUpload;\n\t\t}\n\t\tawait this.userService.update(u);\n\t\treturn this.prepare(u, {}, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst u = await this.byID(req.query.id);\n\t\tawait this.userService.remove(u);\n\t}\n\n\tasync imageUploadUpdate(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tif (!req.file) {\n\t\t\treturn Promise.reject(InvalidParamError('Image upload failed'));\n\t\t}\n\t\tconst u = await this.byID(req.query.id);\n\t\tif (u.id === req.user.id || req.user.roles.admin) {\n\t\t\treturn await this.userService.setUserImage(u, req.file);\n\t\t}\n\t\treturn Promise.reject(UnauthError());\n\t}\n\n\tasync passwordUpdate(req: JamRequest<JamParameters.UserPasswordUpdate>): Promise<void> {\n\t\tconst u = await this.byID(req.query.id);\n\t\tif (u.id === req.user.id || req.user.roles.admin) {\n\t\t\treturn await this.userService.setUserPassword(u, req.query.password);\n\t\t}\n\t\treturn Promise.reject(UnauthError());\n\t}\n\n\tasync emailUpdate(req: JamRequest<JamParameters.UserEmailUpdate>): Promise<void> {\n\t\tconst u = await this.byID(req.query.id);\n\t\tif (u.id === req.user.id || req.user.roles.admin) {\n\t\t\treturn await this.userService.setUserEmail(u, req.query.email);\n\t\t}\n\t\treturn Promise.reject(UnauthError());\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {NotFoundError, UnauthError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatChatMessage} from './chat.format';\nimport {ChatService} from './chat.service';\n\nexport class ChatController {\n\n\tconstructor(private chatService: ChatService) {\n\t}\n\n\tasync list(req: JamRequest<JamParameters.Chat>): Promise<Array<Jam.ChatMessage>> {\n\t\tconst messages = await this.chatService.get(req.query.since);\n\t\treturn messages.map(msg => formatChatMessage(msg));\n\t}\n\n\tasync create(req: JamRequest<JamParameters.ChatNew>): Promise<void> {\n\t\tawait this.chatService.add(req.query.message, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ChatDelete>): Promise<void> {\n\t\tconst message = await this.chatService.find(req.query.time);\n\t\tif (!message) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\tif (message.userID !== req.user.id) {\n\t\t\treturn Promise.reject(UnauthError());\n\t\t}\n\t\tawait this.chatService.remove(message);\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {ChatMessage} from './chat.model';\n\nexport function formatChatMessage(message: ChatMessage): Jam.ChatMessage {\n\treturn {\n\t\tusername: message.username,\n\t\tuserID: message.userID,\n\t\ttime: message.time,\n\t\tmessage: message.message\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {MusicBrainz} from '../../model/musicbrainz-rest-data';\nimport {Acoustid} from '../../model/acoustid-rest-data';\nimport {LastFM} from '../../model/lastfm-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {TrackController} from '../track/track.controller';\nimport {AcousticBrainz} from '../../model/acousticbrainz-rest-data';\nimport {CoverArtArchive} from '../../model/coverartarchive-rest-data';\nimport {MetaDataService} from './metadata.service';\nimport {Jam} from '../../model/jam-rest-data';\n\nexport class MetadataController {\n\n\tconstructor(private metadataService: MetaDataService, private trackController: TrackController) {\n\t}\n\n\tasync musicbrainzSearch(req: JamRequest<JamParameters.MusicBrainzSearch>): Promise<MusicBrainz.Response> {\n\t\tconst query = Object.assign({}, req.query);\n\t\tdelete query.type;\n\t\treturn await this.metadataService.musicbrainzSearch(req.query.type, query);\n\t}\n\n\tasync acoustidLookup(req: JamRequest<JamParameters.AcoustidLookup>): Promise<Array<Acoustid.Result>> {\n\t\tconst track = await this.trackController.byID(req.query.id);\n\t\treturn await this.metadataService.acoustidLookupTrack(track, req.query.inc);\n\t}\n\n\tasync lastfmLookup(req: JamRequest<JamParameters.LastFMLookup>): Promise<LastFM.Result> {\n\t\treturn await this.metadataService.lastFMLookup(req.query.type, req.query.id);\n\t}\n\n\tasync acousticbrainzLookup(req: JamRequest<JamParameters.AcousticBrainzLookup>): Promise<AcousticBrainz.Response> {\n\t\treturn await this.metadataService.acousticbrainzLookup(req.query.id, req.query.nr);\n\t}\n\n\tasync coverartarchiveLookup(req: JamRequest<JamParameters.CoverArtArchiveLookup>): Promise<CoverArtArchive.Response> {\n\t\treturn await this.metadataService.coverartarchiveLookup(req.query.type, req.query.id);\n\t}\n\n\tasync musicbrainzLookup(req: JamRequest<JamParameters.MusicBrainzLookup>): Promise<MusicBrainz.Response> {\n\t\treturn await this.metadataService.musicbrainzLookup(req.query.type, req.query.id, req.query.inc);\n\t}\n\n\tasync wikipediaSummary(req: JamRequest<JamParameters.WikipediaSummary>): Promise<Jam.WikipediaResponse> {\n\t\treturn await this.metadataService.wikipediaSummary(req.query.title, req.query.lang);\n\t}\n\n\tasync wikidataSummary(req: JamRequest<JamParameters.WikidataSummary>): Promise<Jam.WikipediaResponse> {\n\t\treturn await this.metadataService.wikidataSummary(req.query.id, req.query.lang);\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {IApiBinaryResult} from '../../typings';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {StreamService} from './stream.service';\nimport {Store} from '../store/store';\nimport {NowPlayingService} from '../nowplaying/nowplaying.service';\nimport {DBObject} from '../../objects/base/base.model';\nimport {User} from '../../objects/user/user.model';\nimport {DBObjectType} from '../../db/db.types';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\n\nexport class StreamController {\n\n\tconstructor(private streamService: StreamService, private nowPlayingService: NowPlayingService, private store: Store) {\n\n\t}\n\n\tasync streamTrack(track: Track, format: string | undefined, maxBitRate: number | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tconst result = await this.streamService.streamTrack(track, format, maxBitRate, user);\n\t\tthis.nowPlayingService.reportTrack(track, user); // do not wait\n\t\treturn result;\n\t}\n\n\tasync streamEpisode(episode: Episode, format: string | undefined, maxBitRate: number | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tconst result = await this.streamService.streamEpisode(episode, format, maxBitRate, user);\n\t\tthis.nowPlayingService.reportEpisode(episode, user); // do not wait\n\t\treturn result;\n\t}\n\n\tprivate async streamDBObject(o: DBObject, format: string | undefined, maxBitRate: number | undefined, user: User): Promise<IApiBinaryResult> {\n\t\tswitch (o.type) {\n\t\t\tcase DBObjectType.track:\n\t\t\t\treturn this.streamTrack(<Track>o, format, maxBitRate, user);\n\t\t\tcase DBObjectType.episode:\n\t\t\t\treturn this.streamEpisode(<Episode>o, format, maxBitRate, user);\n\n\t\t}\n\t\treturn Promise.reject(Error('Invalid Object Type for Streaming'));\n\t}\n\n\tasync stream(req: JamRequest<JamParameters.PathStream>): Promise<IApiBinaryResult> {\n\t\tconst id = req.query.id;\n\t\tif (!id || id.length === 0) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst obj = await this.store.findInAll(id);\n\t\tif (!obj) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\tconst result = await this.streamDBObject(obj, req.query.format, undefined, req.user);\n\t\tif (!result) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\treturn result;\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatGenre} from './genre.format';\nimport {GenreService} from './genre.service';\n\nexport class GenreController {\n\n\tconstructor(private genreService: GenreService) {\n\n\t}\n\n\tasync list(req: JamRequest<JamParameters.Genres>): Promise<Array<Jam.Genre>> {\n\t\tconst genres = await this.genreService.getGenres(req.query.rootID);\n\t\treturn genres.map(genre => formatGenre(genre));\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Genre} from './genre.model';\n\nexport function formatGenre(genre: Genre): Jam.Genre {\n\treturn {\n\t\tname: genre.name,\n\t\ttrackCount: genre.trackCount,\n\t\talbumCount: genre.albumCount,\n\t\tartistCount: genre.artistCount\n\t};\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {NowPlayingService} from './nowplaying.service';\nimport {packNowPlaying} from './nowplaying.format';\n\nexport class NowPlayingController {\n\n\tconstructor(private nowplayingService: NowPlayingService) {\n\n\t}\n\n\tasync list(req: JamRequest<{}>): Promise<Array<Jam.NowPlaying>> {\n\t\tconst list = await this.nowplayingService.getNowPlaying();\n\t\treturn list.map(entry => packNowPlaying(entry));\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport moment from 'moment';\nimport {DBObjectType} from '../../db/db.types';\nimport {formatTrack} from '../../objects/track/track.format';\nimport {formatEpisode} from '../../objects/episode/episode.format';\nimport {NowPlaying} from './nowplaying.model';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\n\nexport function packNowPlaying(entry: NowPlaying): Jam.NowPlaying {\n\tconst playing: Jam.NowPlaying = {\n\t\tusername: entry.user.name,\n\t\tminutesAgo: Math.round(moment.duration(moment().diff(moment(entry.time))).asMinutes())\n\t};\n\tswitch (entry.obj.type) {\n\t\tcase DBObjectType.track:\n\t\t\tplaying.track = formatTrack(<Track>entry.obj, {});\n\t\t\tbreak;\n\t\tcase DBObjectType.episode:\n\t\t\tconst episode = <Episode>entry.obj;\n\t\t\tplaying.track = formatEpisode(episode, {}, episode.status);\n\t\t\tbreak;\n\t}\n\treturn playing;\n}\n\n","import {JamRequest} from '../../api/jam/api';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {IApiBinaryResult} from '../../typings';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {ImageService} from './image.service';\nimport {Store} from '../store/store';\n\nexport class ImageController {\n\tconstructor(\n\t\tprivate store: Store,\n\t\tprivate imageService: ImageService\n\t) {\n\t}\n\n\tasync image(req: JamRequest<JamParameters.Image>): Promise<IApiBinaryResult> {\n\t\tconst id = req.query.id;\n\t\tif (!id || id.length === 0) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst obj = await this.store.findInAll(id);\n\t\tif (!obj) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\tconst result = await this.imageService.getObjImage(obj, req.query.size, req.query.format);\n\t\tif (!result) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\treturn result;\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {IApiBinaryResult} from '../../typings';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {DownloadService} from './download.service';\nimport {Store} from '../store/store';\n\nexport class DownloadController {\n\n\tconstructor(\n\t\tprivate store: Store,\n\t\tprivate downloadService: DownloadService\n\t) {\n\t}\n\n\tasync download(req: JamRequest<JamParameters.Download>): Promise<IApiBinaryResult> {\n\t\tconst id = req.query.id;\n\t\tif (!id || id.length === 0) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst obj = await this.store.findInAll(id);\n\t\tif (!obj) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\tconst result = await this.downloadService.getObjDownload(obj, req.query.format, req.user);\n\t\tif (!result) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\treturn result;\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {IApiBinaryResult} from '../../typings';\nimport {InvalidParamError, NotFoundError} from '../../api/jam/error';\nimport {JamRequest} from '../../api/jam/api';\nimport {Store} from '../store/store';\nimport {WaveformService} from './waveform.service';\nimport {DBObjectType} from '../../db/db.types';\nimport {Track} from '../../objects/track/track.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport WaveformFormatType = JamParameters.WaveformFormatType;\n\nexport class WaveformController {\n\tconstructor(private store: Store, private waveformService: WaveformService) {\n\n\t}\n\n\tasync waveform(req: JamRequest<JamParameters.Waveform>): Promise<IApiBinaryResult> {\n\t\tconst id = req.query.id;\n\t\tif (!id || id.length === 0) {\n\t\t\treturn Promise.reject(InvalidParamError());\n\t\t}\n\t\tconst obj = await this.store.findInAll(id);\n\t\tif (!obj) {\n\t\t\treturn Promise.reject(NotFoundError());\n\t\t}\n\t\tconst format = req.query.format || <WaveformFormatType>'svg';\n\t\tswitch (obj.type) {\n\t\t\tcase DBObjectType.track:\n\t\t\t\treturn await this.waveformService.getTrackWaveform(<Track>obj, format);\n\t\t\tcase DBObjectType.episode:\n\t\t\t\treturn await this.waveformService.getEpisodeWaveform(<Episode>obj, format);\n\t\t}\n\t\treturn Promise.reject(Error('Invalid Object Type for Waveform generation'));\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {Store} from '../store/store';\nimport {JamRequest} from '../../api/jam/api';\n\nexport class AutocompleteController {\n\n\tconstructor(private store: Store) {\n\n\t}\n\n\tasync autocomplete(req: JamRequest<JamParameters.AutoComplete>): Promise<Jam.AutoComplete> {\n\t\treturn await this.autocompleteQuery(req.query);\n\t}\n\n\tasync autocompleteQuery(query: JamParameters.AutoComplete): Promise<Jam.AutoComplete> {\n\t\tconst result: Jam.AutoComplete = {};\n\t\tif (query.track !== undefined && query.track > 0) {\n\t\t\tconst list = await this.store.trackStore.search({query: query.query, amount: query.track});\n\t\t\tresult.tracks = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.tag.title || ''};\n\t\t\t});\n\t\t}\n\t\tif (query.album !== undefined && query.album > 0) {\n\t\t\tconst list = await this.store.albumStore.search({query: query.query, amount: query.album});\n\t\t\tresult.albums = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.name};\n\t\t\t});\n\t\t}\n\t\tif (query.artist !== undefined && query.artist > 0) {\n\t\t\tconst list = await this.store.artistStore.search({query: query.query, amount: query.artist});\n\t\t\tresult.artists = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.name};\n\t\t\t});\n\t\t}\n\t\tif (query.folder !== undefined && query.folder > 0) {\n\t\t\tconst list = await this.store.artistStore.search({query: query.query, amount: query.folder});\n\t\t\tresult.folders = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.name};\n\t\t\t});\n\t\t}\n\t\tif (query.playlist !== undefined && query.playlist > 0) {\n\t\t\tconst list = await this.store.playlistStore.search({query: query.query, amount: query.playlist});\n\t\t\tresult.playlists = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.name};\n\t\t\t});\n\t\t}\n\t\tif (query.podcast !== undefined && query.podcast > 0) {\n\t\t\tconst list = await this.store.podcastStore.search({query: query.query, amount: query.podcast});\n\t\t\tresult.podcasts = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.tag ? o.tag.title : ''};\n\t\t\t});\n\t\t}\n\t\tif (query.episode !== undefined && query.episode > 0) {\n\t\t\tconst list = await this.store.episodeStore.search({query: query.query, amount: query.episode});\n\t\t\tresult.episodes = list.map(o => {\n\t\t\t\treturn {id: o.id, name: o.name};\n\t\t\t});\n\t\t}\n\t\treturn result;\n\t}\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {User} from '../user/user.model';\nimport {Bookmark} from './bookmark.model';\nimport {SearchQueryBookmark} from './bookmark.store';\nimport {TrackController} from '../track/track.controller';\nimport {formatBookmark} from './bookmark.format';\nimport {BookmarkService} from './bookmark.service';\n\nexport class BookmarkController {\n\n\tconstructor(\n\t\tprivate bookmarkService: BookmarkService,\n\t\tprivate trackController: TrackController\n\t) {\n\t}\n\n\tdefaultSort(items: Array<Bookmark>): Array<Bookmark> {\n\t\treturn items.sort((a, b) => b.changed - a.changed);\n\t}\n\n\tasync prepare(bookmark: Bookmark, includes: JamParameters.IncludesBookmark, user: User): Promise<Jam.Bookmark> {\n\t\tconst result = formatBookmark(bookmark);\n\t\tif (includes.bookmarkTrack) {\n\t\t\tresult.track = await this.trackController.prepareByID(bookmark.id, includes, user);\n\t\t}\n\t\treturn result;\n\t}\n\n\ttranslateQuery(query: JamParameters.BookmarkSearch, user: User): SearchQueryBookmark {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\tuserID: query.userID,\n\t\t\tdestID: query.trackID,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync create(req: JamRequest<JamParameters.BookmarkCreate>): Promise<Jam.Bookmark> {\n\t\tconst track = await this.trackController.byID(req.query.trackID);\n\t\tconst bookmark = await this.bookmarkService.create(track.id, req.user.id, req.query.position || 0, req.query.comment);\n\t\treturn this.prepare(bookmark, {}, req.user);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tawait this.bookmarkService.remove(req.query.id, req.user.id);\n\t}\n\n\tasync list(req: JamRequest<JamParameters.BookmarkList>): Promise<Array<Jam.Bookmark>> {\n\t\tconst bookmarks = await this.bookmarkService.getAll(req.user.id);\n\t\tconst result = bookmarks.map(bookmark => formatBookmark(bookmark));\n\t\tif (req.query.bookmarkTrack) {\n\t\t\tconst tracks = await this.trackController.prepareListByIDs(bookmarks.map(b => b.destID), req.query, req.user);\n\t\t\tresult.forEach(bookmark => {\n\t\t\t\tbookmark.track = tracks.find(t => t.id === bookmark.trackID);\n\t\t\t});\n\t\t}\n\t\treturn result;\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Bookmark} from './bookmark.model';\n\nexport function formatBookmark(bookmark: Bookmark): Jam.Bookmark {\n\treturn {\n\t\tid: bookmark.id,\n\t\ttrackID: bookmark.destID,\n\t\tcomment: bookmark.comment,\n\t\tcreated: bookmark.created,\n\t\tchanged: bookmark.changed,\n\t\tposition: bookmark.position\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {TrackController} from '../track/track.controller';\nimport {formatPlayQueue} from './playqueue.format';\nimport {PlayQueueService} from './playqueue.service';\n\nexport class PlayQueueController {\n\n\tconstructor(\n\t\tprivate playqueueService: PlayQueueService,\n\t\tprivate trackController: TrackController\n\t) {\n\t}\n\n\tasync get(req: JamRequest<JamParameters.PlayQueue>): Promise<Jam.PlayQueue> {\n\t\tconst playQueue = await this.playqueueService.getQueueOrCreate(req.user.id, req.client);\n\t\tconst result = formatPlayQueue(playQueue, req.query);\n\t\tif (req.query.playQueueTracks) {\n\t\t\tresult.tracks = await this.trackController.prepareListByIDs(playQueue.trackIDs, req.query, req.user);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync update(req: JamRequest<JamParameters.PlayQueueSet>): Promise<Jam.PlayQueue> {\n\t\treturn await this.playqueueService.save(req.user.id, req.query.trackIDs, req.query.currentID, req.query.position, req.client);\n\t}\n\n\tasync delete(req: JamRequest<{}>): Promise<void> {\n\t\tawait this.playqueueService.remove(req.user.id);\n\t}\n\n\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {PlayQueue} from './playqueue.model';\n\nexport function formatPlayQueue(playQueue: PlayQueue, includes: JamParameters.IncludesPlayQueue): Jam.PlayQueue {\n\treturn {\n\t\tchanged: playQueue.changed,\n\t\tchangedBy: playQueue.changedBy,\n\t\tcurrentID: playQueue.currentID,\n\t\tposition: playQueue.position,\n\t\ttrackIDs: includes.playQueueTrackIDs ? playQueue.trackIDs : undefined\n\t};\n}\n","import {BaseController} from '../base/base.controller';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {DBObjectType} from '../../db/db.types';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatRadio} from './radio.format';\nimport {RadioService} from './radio.service';\nimport {formatState} from '../state/state.format';\nimport {StateService} from '../state/state.service';\nimport {ImageService} from '../../engine/image/image.service';\nimport {DownloadService} from '../../engine/download/download.service';\nimport {SearchQueryRadio} from './radio.store';\nimport {Radio} from './radio.model';\nimport {User} from '../user/user.model';\n\nexport class RadioController extends BaseController<JamParameters.Radio, JamParameters.Radios, JamParameters.IncludesRadio, SearchQueryRadio, JamParameters.RadioSearch, Radio, Jam.Radio> {\n\n\tconstructor(\n\t\tprivate radioService: RadioService,\n\t\tprotected stateService: StateService,\n\t\tprotected imageService: ImageService,\n\t\tprotected downloadService: DownloadService\n\t) {\n\t\tsuper(radioService, stateService, imageService, downloadService);\n\t}\n\n\tdefaultSort(items: Array<Radio>): Array<Radio> {\n\t\treturn items.sort((a, b) => a.name.localeCompare(b.name));\n\t}\n\n\tasync prepare(radio: Radio, includes: JamParameters.IncludesRadio, user: User): Promise<Jam.Radio> {\n\t\tconst result = formatRadio(radio);\n\t\tif (includes.radioState) {\n\t\t\tconst state = await this.stateService.findOrCreate(radio.id, user.id, DBObjectType.radio);\n\t\t\tresult.state = formatState(state);\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync translateQuery(query: JamParameters.RadioSearch, user: User): Promise<SearchQueryRadio> {\n\t\treturn {\n\t\t\tquery: query.query,\n\t\t\turl: query.url,\n\t\t\tname: query.name,\n\t\t\thomepage: query.homepage,\n\t\t\toffset: query.offset,\n\t\t\tamount: query.amount,\n\t\t\tsorts: query.sortField ? [{field: query.sortField, descending: !!query.sortDescending}] : undefined\n\t\t};\n\t}\n\n\tasync create(req: JamRequest<JamParameters.RadioNew>): Promise<Jam.Radio> {\n\t\tconst radio = await this.radioService.create(req.query.name, req.query.url, req.query.homepage);\n\t\treturn this.prepare(radio, {radioState: true}, req.user);\n\t}\n\n\tasync update(req: JamRequest<JamParameters.RadioUpdate>): Promise<void> {\n\t\tconst radio = await this.byID(req.query.id);\n\t\tawait this.radioService.update(radio, req.query.name, req.query.url, req.query.homepage);\n\t}\n\n\tasync delete(req: JamRequest<JamParameters.ID>): Promise<void> {\n\t\tconst radio = await this.byID(req.query.id);\n\t\tawait this.radioService.remove(radio);\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Radio} from './radio.model';\n\nexport function formatRadio(radio: Radio): Jam.Radio {\n\treturn {\n\t\tid: radio.id,\n\t\turl: radio.url,\n\t\tcreated: radio.created,\n\t\tchanged: radio.changed,\n\t\tname: radio.name,\n\t\thomepage: radio.homepage,\n\t};\n}\n","import {JamParameters} from '../../model/jam-rest-params';\nimport {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\nimport {formatStats} from './stats.format';\nimport {StatsService} from './stats.service';\n\nexport class StatsController {\n\n\tconstructor(private statsService: StatsService) {\n\n\t}\n\n\tasync get(req: JamRequest<JamParameters.Stats>): Promise<Jam.Stats> {\n\t\tconst stats = await this.statsService.getStats(req.query.rootID);\n\t\treturn formatStats(stats);\n\t}\n\n}\n","import {Jam} from '../../model/jam-rest-data';\nimport {Stats} from './stats.model';\n\nexport function formatStats(stats: Stats): Jam.Stats {\n\treturn {\n\t\trootID: stats.rootID,\n\t\talbum: stats.album,\n\t\talbumTypes: {\n\t\t\talbum: stats.albumTypes.album,\n\t\t\tcompilation: stats.albumTypes.compilation,\n\t\t\taudiobook: stats.albumTypes.audiobook\n\t\t},\n\t\tartistTypes: {\n\t\t\talbum: stats.artistTypes.album,\n\t\t\tcompilation: stats.artistTypes.compilation,\n\t\t\taudiobook: stats.artistTypes.audiobook\n\t\t},\n\t\tartist: stats.artist,\n\t\tfolder: stats.folder,\n\t\ttrack: stats.track\n\t};\n}\n","import {SettingsService} from './settings.service';\nimport {Jam} from '../../model/jam-rest-data';\nimport {JamRequest} from '../../api/jam/api';\n\nexport class SettingsController {\n\n\tconstructor(public settingsService: SettingsService) {\n\t}\n\n\tasync admin(req: JamRequest<{}>): Promise<Jam.AdminSettings> {\n\t\treturn await this.settingsService.get();\n\t}\n\n\tasync adminUpdate(req: JamRequest<Jam.AdminSettings>): Promise<void> {\n\t\tawait this.settingsService.updateSettings(req.query);\n\t}\n}\n","module.exports = require(\"cors\");","import fse from 'fs-extra';\nimport path from 'path';\nimport {Store} from 'express-session';\nimport {Express} from 'express';\n\nexport interface Sessions {\n\t[key: string]: Express.SessionData;\n}\n\nexport class SessionJSONFileStore extends Store {\n\tfilename: string;\n\tcache: Sessions = {};\n\n\tconstructor(filename: string) {\n\t\tsuper();\n\t\tthis.filename = path.resolve(filename || 'sessions.json');\n\t\tthis.init().catch(e => {\n\t\t\tconsole.log('SessionJSONFileStore', e);\n\t\t});\n\t}\n\n\tasync init() {\n\t\tawait fse.ensureDir(path.dirname(this.filename));\n\t\tconst exists = await fse.pathExists(this.filename);\n\t\tif (exists) {\n\t\t\tconst archive = await fse.readJson(this.filename);\n\t\t\tObject.keys(archive).forEach(key => {\n\t\t\t\tconst sessionData = archive[key];\n\t\t\t\tif (sessionData.cookie.expires !== undefined && typeof sessionData.cookie.expires !== 'boolean') {\n\t\t\t\t\tsessionData.cookie.expires = new Date(sessionData.cookie.expires);\n\t\t\t\t}\n\t\t\t\tif (!this.expired(sessionData)) {\n\t\t\t\t\tthis.cache[key] = sessionData;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate expired(data: Express.SessionData): boolean {\n\t\tif (data.cookie && data.cookie.expires instanceof Date) {\n\t\t\treturn data.cookie.expires.valueOf() < Date.now();\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate savejson(callback?: (err?: Error) => void): void {\n\t\tfse.writeFile(this.filename, JSON.stringify(this.cache), (err) => {\n\t\t\tif (callback) {\n\t\t\t\tcallback(err);\n\t\t\t}\n\t\t});\n\t}\n\n\tget: (sid: string, callback: (err: any, data?: Express.SessionData | null) => void) => void = (sid, callback) => {\n\t\tconst sessionData = this.cache[sid];\n\t\tif (sessionData && this.expired(sessionData)) {\n\t\t\treturn this.destroy(sid, (err) => {\n\t\t\t\tcallback(err);\n\t\t\t});\n\t\t}\n\t\tcallback(null, sessionData);\n\t}\n\n\tset: (sid: string, data: Express.SessionData, callback?: (err?: any) => void) => void = (sid, data, callback) => {\n\t\tthis.cache[sid] = data;\n\t\tthis.savejson(callback);\n\t}\n\n\tdestroy: (sid: string, callback?: (err?: any) => void) => void = (sid, callback) => {\n\t\tdelete this.cache[sid];\n\t\tthis.savejson(callback);\n\t}\n\n\tall: (callback: (err: any, obj?: { [sid: string]: Express.SessionData; } | null) => void) => void = (callback) => {\n\t\tcallback(null, this.cache);\n\t}\n\n\tlength: (callback: (err: any, length?: number | null) => void) => void = (callback) => {\n\t\tcallback(null, Object.keys(this.cache).length);\n\t}\n\n\tclear: (callback?: (err?: any) => void) => void = (callback) => {\n\t\tthis.cache = {};\n\t\tthis.savejson(callback);\n\t}\n\n\t// touch: (sid: string, session: Express.Session, callback?: (err?: any) => void) => void = (sid, session, callback) => {\n\t// \tthis.set(sid, session, callback);\n\t// };\n\n}\n\n","module.exports = require(\"passport\");","module.exports = require(\"passport-jwt\");","module.exports = require(\"passport-local\");","module.exports = require(\"jsonwebtoken\");","// THIS FILE IS GENERATED, DO NOT EDIT MANUALLY\n\nimport {Jam} from '../../model/jam-rest-data';\nimport {MusicBrainz} from '../../model/musicbrainz-rest-data';\nimport {Acoustid} from '../../model/acoustid-rest-data';\nimport {AcousticBrainz} from '../../model/acousticbrainz-rest-data';\nimport {LastFM} from '../../model/lastfm-rest-data';\nimport {CoverArtArchive} from '../../model/coverartarchive-rest-data';\nimport {JamParameters} from '../../model/jam-rest-params';\nimport {JamController, JamRequest} from './api';\nimport {ApiResponder} from './response';\nimport express from 'express';\nimport {IApiBinaryResult} from '../../typings';\n\nexport type RegisterCallback = (req: express.Request, res: express.Response) => Promise<void>;\nexport interface Register {\n\tget: (name: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => void;\n\tpost: (name: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => void;\n\tupload: (name: string, field: string, execute: RegisterCallback, apiCheckName?: string, roles?: Array<string>) => void;\n}\n\nexport function registerPublicApi(register: Register, api: JamController): void {\n\tregister.get('/ping', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Ping = await api.ping(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/session', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Session = await api.session(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n}\n\nexport function registerAccessControlApi(register: Register, api: JamController): void {\n\tregister.get('/lastfm/lookup', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.LastFMLookup> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: LastFM.Result = await api.metadataController.lastfmLookup(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/acoustid/lookup', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.AcoustidLookup> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Acoustid.Result> = await api.metadataController.acoustidLookup(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/musicbrainz/lookup', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.MusicBrainzLookup> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: MusicBrainz.Response = await api.metadataController.musicbrainzLookup(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/musicbrainz/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.MusicBrainzSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: MusicBrainz.Response = await api.metadataController.musicbrainzSearch(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/acousticbrainz/lookup', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.AcousticBrainzLookup> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: AcousticBrainz.Response = await api.metadataController.acousticbrainzLookup(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/coverartarchive/lookup', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.CoverArtArchiveLookup> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: CoverArtArchive.Response = await api.metadataController.coverartarchiveLookup(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/wikipedia/summary', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.WikipediaSummary> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.WikipediaResponse = await api.metadataController.wikipediaSummary(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/wikidata/summary', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.WikidataSummary> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.WikipediaResponse = await api.metadataController.wikidataSummary(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/autocomplete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.AutoComplete> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.AutoComplete = await api.autocompleteController.autocomplete(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/genre/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Genres> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Genre> = await api.genreController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/stats', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Stats> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Stats = await api.statsController.get(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/nowPlaying/list', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.NowPlaying> = await api.nowPlayingController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/chat/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Chat> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.ChatMessage> = await api.chatController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/index', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Index> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.FolderIndex = await api.folderController.index(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Folder> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Folder = await api.folderController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Folders> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/children', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderChildren> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.FolderChildren = await api.folderController.children(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderTracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.folderController.tracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/subfolders', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderSubFolders> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.subfolders(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/artist/similar', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Folder> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.artistSimilar(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/artist/info', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Info = await api.folderController.artistInfo(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/album/info', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Info = await api.folderController.albumInfo(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/health', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderHealth> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Folder> = await api.folderController.health(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.folderController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.folderController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/artist/similar/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.SimilarTracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.folderController.artistSimilarTracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/folder/artworks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.ArtworkImage> = await api.folderController.artworks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Track> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Track = await api.trackController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Tracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.trackController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/tagID3', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.ID3Tag = await api.trackController.tagID3(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/tagID3s', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.ID3Tags = await api.trackController.tagID3s(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.TrackSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.trackController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.trackController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.trackController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.TrackList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.trackController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/track/similar', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.SimilarTracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.trackController.similar(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Episode> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.PodcastEpisode = await api.episodeController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Episodes> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.PodcastEpisode> = await api.episodeController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.EpisodeSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.PodcastEpisode> = await api.episodeController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/retrieve', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tawait api.episodeController.retrieve(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/episode/retrieve', ['podcast']);\n\n\tregister.get('/episode/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.episodeController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.episodeController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/status', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.PodcastEpisodeStatus = await api.episodeController.status(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/episode/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PodcastEpisodeList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.PodcastEpisode> = await api.episodeController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Podcast> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Podcast = await api.podcastController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Podcasts> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Podcast> = await api.podcastController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/status', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.PodcastStatus = await api.podcastController.status(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PodcastSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Podcast> = await api.podcastController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/refreshAll', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tawait api.podcastController.refreshAll(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/podcast/refreshAll', ['podcast']);\n\n\tregister.get('/podcast/refresh', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tawait api.podcastController.refresh(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/podcast/refresh', ['podcast']);\n\n\tregister.get('/podcast/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.podcastController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.podcastController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/podcast/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PodcastList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Podcast> = await api.podcastController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/radio/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Radio> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Radio = await api.radioController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/radio/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Radios> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Radio> = await api.radioController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/radio/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Radios> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Radio> = await api.radioController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/radio/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.radioController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/radio/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.radioController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Artist> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Artist = await api.artistController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Artists> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Artist> = await api.artistController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ArtistSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Artist> = await api.artistController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.artistController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.artistController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ArtistList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Artist> = await api.artistController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/similar/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.SimilarTracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.artistController.similarTracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/similar', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Artist> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Artist> = await api.artistController.similar(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/index', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Index> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.ArtistIndex = await api.artistController.index(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Tracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.artistController.tracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/artist/info', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Info = await api.artistController.info(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Album> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Album = await api.albumController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Albums> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Album> = await api.albumController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.AlbumList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Album> = await api.albumController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.AlbumSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Album> = await api.albumController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.albumController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.albumController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/similar/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.SimilarTracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.albumController.similarTracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Tracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.albumController.tracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/album/info', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Info = await api.albumController.info(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Playlist> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Playlist = await api.playlistController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Playlists> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Playlist> = await api.playlistController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PlaylistSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Playlist> = await api.playlistController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/state', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.State = await api.playlistController.state(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/states', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.States = await api.playlistController.states(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/playlist/tracks', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Tracks> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Track> = await api.playlistController.tracks(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/user/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.User = await api.userController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/user/id', ['admin']);\n\n\tregister.get('/user/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.User> = await api.userController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/user/ids', ['admin']);\n\n\tregister.get('/user/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.UserSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.User> = await api.userController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/user/search', ['admin']);\n\n\tregister.get('/playqueue/get', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PlayQueue> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.PlayQueue = await api.playqueueController.get(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/bookmark/list', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.BookmarkList> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Bookmark> = await api.bookmarkController.list(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/root/id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.Root = await api.rootController.id(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/root/ids', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.IDs> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Root> = await api.rootController.ids(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/root/search', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.RootSearch> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Array<Jam.Root> = await api.rootController.search(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/root/scan', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tawait api.rootController.scan(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/root/scan', ['admin']);\n\n\tregister.get('/root/scanAll', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tawait api.rootController.scanAll(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/root/scanAll', ['admin']);\n\n\tregister.get('/root/status', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.RootStatus = await api.rootController.status(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.get('/settings/admin', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: Jam.AdminSettings = await api.settingsController.admin(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/settings/admin', ['admin']);\n\n\tregister.get('/folder/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.folderController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/folder/download', ['stream']);\n\n\tregister.get('/folder/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.folderController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/folder/artwork/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.folderController.artworkImage(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/track/stream', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Stream> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.trackController.stream(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/track/stream', ['stream']);\n\n\tregister.get('/track/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.trackController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/track/download', ['stream']);\n\n\tregister.get('/track/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.trackController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/episode/stream', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Stream> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.episodeController.stream(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/episode/stream', ['stream']);\n\n\tregister.get('/episode/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.episodeController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/episode/download', ['stream']);\n\n\tregister.get('/episode/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.episodeController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/podcast/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.podcastController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/podcast/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.podcastController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/podcast/download', ['stream']);\n\n\tregister.get('/artist/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.artistController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/artist/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.artistController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/artist/download', ['stream']);\n\n\tregister.get('/album/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.albumController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/album/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.albumController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/album/download', ['stream']);\n\n\tregister.get('/playlist/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.playlistController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/playlist/download', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.playlistController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/playlist/download', ['stream']);\n\n\tregister.get('/user/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.userController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/root/image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.query, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.rootController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t});\n\n\tregister.get('/image/:id-:size.:format', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Image> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.imageController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/image/{id}-{size}.{format}');\n\n\tregister.get('/image/:id-:size', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PathImageSize> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.imageController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/image/{id}-{size}');\n\n\tregister.get('/image/:id.:format', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PathImageFormat> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.imageController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/image/{id}.{format}');\n\n\tregister.get('/image/:id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.imageController.image(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/image/{id}');\n\n\tregister.get('/stream/:id.:format', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PathStream> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.streamController.stream(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/stream/{id}.{format}', ['stream']);\n\n\tregister.get('/stream/:id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.streamController.stream(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/stream/{id}', ['stream']);\n\n\tregister.get('/waveform/:id.:format', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Waveform> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.waveformController.waveform(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/waveform/{id}.{format}', ['stream']);\n\n\tregister.get('/download/:id', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.downloadController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/download/{id}', ['stream']);\n\n\tregister.get('/download/:id.:format', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Download> = {query: req.params, user: req.user, client: req.client};\n\t\tconst result: IApiBinaryResult = await api.downloadController.download(options);\n\t\tawait ApiResponder.binary(res, result);\n\t}, '/download/{id}.{format}', ['stream']);\n\n\tregister.post('/bookmark/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.BookmarkCreate> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.Bookmark = await api.bookmarkController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.post('/bookmark/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.bookmarkController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/chat/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ChatNew> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.chatController.create(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/chat/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ChatDelete> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.chatController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/radio/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.RadioNew> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.Radio = await api.radioController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/radio/create', ['admin']);\n\n\tregister.post('/radio/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.RadioUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.radioController.update(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/radio/update', ['admin']);\n\n\tregister.post('/radio/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.radioController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/radio/delete', ['admin']);\n\n\tregister.post('/track/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.trackController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/track/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.trackController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/track/tagID3/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.TagID3Update> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.trackController.tagID3Update(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/track/tagID3/update', ['admin']);\n\n\tregister.post('/track/name/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.TrackEditName> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.trackController.nameUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/track/name/update', ['admin']);\n\n\tregister.upload('/folder/imageUpload/update', 'image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client, file: req.file ? req.file.path : undefined};\n\t\tawait api.folderController.imageUploadUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/folder/imageUpload/update', ['admin']);\n\n\tregister.post('/folder/artwork/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderArtworkNew> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.folderController.artworkCreate(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/folder/artwork/create', ['admin']);\n\n\tregister.post('/folder/artwork/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.folderController.artworkDelete(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/folder/artwork/delete', ['admin']);\n\n\tregister.post('/folder/name/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.FolderEditName> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.folderController.nameUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/folder/name/update', ['admin']);\n\n\tregister.post('/folder/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.folderController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/folder/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.folderController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/album/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.albumController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/album/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.albumController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/artist/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.artistController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/artist/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.artistController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/episode/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.episodeController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/episode/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.episodeController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/podcast/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PodcastNew> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.Podcast = await api.podcastController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/podcast/create', ['podcast']);\n\n\tregister.post('/podcast/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.podcastController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/podcast/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.podcastController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/podcast/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.podcastController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/podcast/delete', ['podcast']);\n\n\tregister.post('/playlist/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PlaylistNew> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.Playlist = await api.playlistController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t});\n\n\tregister.post('/playlist/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PlaylistUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playlistController.update(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/playlist/fav/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Fav> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playlistController.favUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/playlist/rate/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.Rate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playlistController.rateUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/playlist/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playlistController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/playqueue/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.PlayQueueSet> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playqueueController.update(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/playqueue/delete', async (req, res) => {\n\t\tconst options: JamRequest<{}> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.playqueueController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/user/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.UserNew> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.User = await api.userController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/user/create', ['admin']);\n\n\tregister.post('/user/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.UserUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.userController.update(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/user/update', ['admin']);\n\n\tregister.post('/user/password/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.UserPasswordUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.userController.passwordUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/user/email/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.UserEmailUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.userController.emailUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.upload('/user/imageUpload/update', 'image', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client, file: req.file ? req.file.path : undefined};\n\t\tawait api.userController.imageUploadUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t});\n\n\tregister.post('/user/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.userController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/user/delete', ['admin']);\n\n\tregister.post('/root/create', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.RootNew> = {query: req.body, user: req.user, client: req.client};\n\t\tconst result: Jam.Root = await api.rootController.create(options);\n\t\tawait ApiResponder.data(res, result);\n\t}, '/root/create', ['admin']);\n\n\tregister.post('/root/update', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.RootUpdate> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.rootController.update(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/root/update', ['admin']);\n\n\tregister.post('/root/delete', async (req, res) => {\n\t\tconst options: JamRequest<JamParameters.ID> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.rootController.delete(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/root/delete', ['admin']);\n\n\tregister.post('/settings/admin/update', async (req, res) => {\n\t\tconst options: JamRequest<Jam.AdminSettings> = {query: req.body, user: req.user, client: req.client};\n\t\tawait api.settingsController.adminUpdate(options);\n\t\tawait ApiResponder.ok(res);\n\t}, '/settings/admin/update', ['admin']);\n}\n","import {OpenAPIObject} from '../../model/openapi-spec';\nimport express from 'express';\nimport {checkOpenApiParameters} from '../../utils/openapi-parameters-check';\nimport {ApiResponder} from './response';\n\nconst openapi: OpenAPIObject = require('../../model/jam-openapi.json');\nconst JamApiSchema = require('../../model/jam-rest-api.schema.json');\n\nexport function apiCheck(name: string): express.RequestHandler {\n\tfunction CheckApiParametersHandler(req: express.Request, res: express.Response, next: express.NextFunction) {\n\t\tcheckOpenApiParameters(name, req, openapi, JamApiSchema).then(() => {\n\t\t\tnext();\n\t\t}).catch((e) => {\n\t\t\tApiResponder.error(res, e);\n\t\t});\n\t}\n\treturn CheckApiParametersHandler;\n}\n","import ajv from 'ajv';\n\nconst jsonvalidator = new ajv(); // options can be passed, e.g. {allErrors: true}\n\nexport type JSONValidator = ajv.ValidateFunction;\n\nexport function jsonValidator(schema: any): JSONValidator {\n\treturn jsonvalidator.compile(schema);\n}\n\nexport async function validateJSON(data: any, schemaValidator: JSONValidator): Promise<{ errors: Array<ajv.ErrorObject> }> {\n\tconst valid = await schemaValidator(data);\n\tif (valid) {\n\t\treturn {errors: []};\n\t} else if (schemaValidator.errors) {\n\t\treturn {errors: schemaValidator.errors};\n\t} else {\n\t\treturn {\n\t\t\terrors: [{\n\t\t\t\tkeyword: 'unknown',\n\t\t\t\tdataPath: 'unknown',\n\t\t\t\tschemaPath: 'unknown',\n\t\t\t\tparams: []\n\t\t\t}]\n\t\t};\n\t}\n}\n","module.exports = require(\"ajv\");","import moment from 'moment';\n\nexport function getMaxAge(maxAgeSpec: { value: number; unit: string }): number {\n\tlet maxAge = 0;\n\tif (maxAgeSpec.value > 0) {\n\t\tmaxAge = moment.duration(maxAgeSpec.value, <moment.unitOfTime.Base>maxAgeSpec.unit).asMilliseconds();\n\t}\n\treturn maxAge;\n}\n","module.exports = require(\"multer-autoreap\");","module.exports = require(\"express-rate-limit\");","import express from 'express';\nimport {CheckAuthMiddleWare, SubsonicLoginMiddleWare} from './login';\nimport {SubsonicParameterMiddleWare, SubsonicParameterRequest} from './parameters';\nimport Logger from '../../utils/logger';\nimport {FORMAT} from './format';\nimport {SubsonicApi} from './api';\nimport {Engine} from '../../engine/engine';\nimport {Subsonic} from '../../model/subsonic-rest-data';\nimport cors from 'cors';\nimport {registerApi, SubsonicRolesHandler} from './routes';\nimport {ApiResponder} from './response';\n\nconst log = Logger('Subsonic.Api');\n\nexport function AdminMiddleWare(req: SubsonicParameterRequest, res: express.Response, next: express.NextFunction) {\n\tif (!req.user || !req.user.roles.admin) {\n\t\tApiResponder.error(req, res, {fail: FORMAT.FAIL.UNAUTH});\n\t}\n\tnext();\n}\n\nexport function PodcastAdminMiddleWare(req: SubsonicParameterRequest, res: express.Response, next: express.NextFunction) {\n\tif (!req.user || !req.user.roles.podcast) {\n\t\tApiResponder.error(req, res, {fail: FORMAT.FAIL.UNAUTH});\n\t}\n\tnext();\n}\n\nexport function ShareMiddleWare(req: SubsonicParameterRequest, res: express.Response, next: express.NextFunction) {\n\tif (!req.user || !req.user.roles.shareRole) {\n\t\tApiResponder.error(req, res, {fail: FORMAT.FAIL.UNAUTH});\n\t}\n\tnext();\n}\n\nexport function JukeboxMiddleWare(req: SubsonicParameterRequest, res: express.Response, next: express.NextFunction) {\n\tif (!req.user || !req.user.roles.jukeboxRole) {\n\t\tApiResponder.error(req, res, {fail: FORMAT.FAIL.UNAUTH});\n\t}\n\tnext();\n}\n\nexport function initSubsonicRouter(engine: Engine): express.Router {\n\tconst api = new SubsonicApi(engine);\n\tconst roles: SubsonicRolesHandler = {\n\t\tadmin: <express.RequestHandler>AdminMiddleWare,\n\t\tpodcast: <express.RequestHandler>PodcastAdminMiddleWare,\n\t\tshare: <express.RequestHandler>ShareMiddleWare,\n\t\tjukebox: <express.RequestHandler>JukeboxMiddleWare\n\t};\n\n\tconst router = express.Router();\n\t// router.options('*', cors());\n\trouter.use((req, res, next) => {\n\t\tlog.info(req.method, req.originalUrl);\n\t\tnext();\n\t});\n\n\trouter.use(SubsonicParameterMiddleWare);\n\trouter.use(<express.RequestHandler>SubsonicLoginMiddleWare);\n\trouter.use(<express.RequestHandler>CheckAuthMiddleWare);\n\tregisterApi(router, api, roles);\n\n\trouter.use((req, res, next) => {\n\t\tres.status(404).send('subsonic api cmd not found');\n\t});\n\n\treturn router;\n}\n","/*\n\nAuthentication\n\nIf your targeting API version 1.12.0 or earlier, authentication is performed by sending the password as clear text or hex-encoded. Examples:\n\nhttp://your-server/rest/ping.view?u=joe&p=sesame&v=1.12.0&c=myapp\nhttp://your-server/rest/ping.view?u=joe&p=enc:736573616d65&v=1.12.0&c=myapp\n\nStarting with API version 1.13.0, the recommended authentication scheme is to send an authentication token, calculated as a one-way salted hash of the password.\n\nThis involves two steps:\n\n    For each REST call, generate a random string called the salt. Send this as parameter s.\n    Use a salt length of at least six characters.\n    Calculate the authentication token as follows: token = md5(password + salt). The md5() function takes a string and returns the 32-byte ASCII hexadecimal representation of the MD5 hash, using lower case characters for the hex values. The '+' operator represents concatenation of the two strings. Treat the strings as UTF-8 encoded when calculating the hash. Send the result as parameter t.\n\nFor example: if the password is sesame and the random salt is c19b2d, then token = md5(\"sesamec19b2d\") = 26719a1196d2a940705a59634eb18eab. The corresponding request URL then becomes:\n\nhttp://your-server/rest/ping.view?u=joe&t=26719a1196d2a940705a59634eb18eab&s=c19b2d&v=1.12.0&c=myapp\n\n */\n\nimport express from 'express';\nimport {SubsonicParameterRequest} from './parameters';\nimport {ApiResponder} from './response';\nimport {FORMAT} from './format';\nimport {User} from '../../objects/user/user.model';\nimport {hexDecode} from '../../utils/hex';\n\n/**\n * Fill user into req.user express requests\n */\nexport interface UserRequest extends SubsonicParameterRequest {\n\tuser: User;\n\tclient: string;\n}\n\nasync function validateCredentials(req: SubsonicParameterRequest): Promise<User> {\n\tif (req.user) {\n\t\treturn <User>req.user;\n\t}\n\tif (req.parameters.password) {\n\t\tlet pass = req.parameters.password;\n\t\tif (pass.indexOf('enc:') === 0) {\n\t\t\tpass = hexDecode(pass.slice(4)).trim();\n\t\t}\n\t\treturn req.engine.userService.authSubsonic(req.parameters.username, pass);\n\t} else if (req.parameters.token && req.parameters.salt) {\n\t\treturn req.engine.userService.authToken(req.parameters.username, req.parameters.token, req.parameters.salt);\n\t} else {\n\t\treturn Promise.reject('Invalid Login Type');\n\t}\n}\n\nexport function SubsonicLoginMiddleWare(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\tif (req.user) {\n\t\treturn next();\n\t}\n\tif (!req.parameters) {\n\t\treturn next();\n\t}\n\treq.client = req.parameters.client;\n\tvalidateCredentials(req)\n\t\t.then(user => {\n\t\t\treq.user = user;\n\t\t\tnext();\n\t\t})\n\t\t.catch(e => {\n\t\t\tnext();\n\t\t});\n}\n\nexport function CheckAuthMiddleWare(req: UserRequest, res: express.Response, next: express.NextFunction) {\n\tif (req.user) {\n\t\treturn next();\n\t}\n\treturn ApiResponder.error(req, res, {fail: FORMAT.FAIL.UNAUTH});\n}\n","import util from 'util';\n\nexport function toXML(obj: any): string {\n\n\tconst xmls = (s: any): string => s.toString().replace(/&/g, '&amp;')\n\t\t.replace(/</g, '&lt;')\n\t\t.replace(/>/g, '&gt;')\n\t\t.replace(/\"/g, '&quot;')\n\t\t.replace(/'/g, '&apos;');\n\n\tconst xmli = (o: any) => {\n\t\tlet s = '';\n\t\tObject.keys(o).forEach(key => {\n\t\t\tif ((key !== 'content')) {\n\t\t\t\tconst sub = o[key];\n\t\t\t\tif (!util.isArray(sub) && (typeof sub !== 'object')) {\n\t\t\t\t\tconst val = JSON.stringify(sub);\n\t\t\t\t\tif (val !== undefined) {\n\t\t\t\t\t\ts += ' ' + key + '=\"' + xmls(sub) + '\"';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn s;\n\t};\n\n\tconst xmlc = (o: any): string => {\n\t\tfor (const key in o) {\n\t\t\tif (key === 'content' && o.hasOwnProperty(key)) {\n\t\t\t\treturn o[key];\n\t\t\t}\n\t\t}\n\t\treturn '';\n\t};\n\n\tconst xmlo = (o: any): string => {\n\t\tlet s = '';\n\t\tObject.keys(o).forEach(key => {\n\t\t\tconst sub = o[key];\n\t\t\tif (util.isArray(sub)) {\n\t\t\t\tsub.forEach((entry) => {\n\t\t\t\t\tconst val = xmlc(entry) + xmlo(entry);\n\t\t\t\t\ts += '<' + key + xmli(entry);\n\t\t\t\t\tif (val.length > 0) {\n\t\t\t\t\t\ts += '>' + val + '</' + key + '>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\ts += ' />';\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (typeof sub === 'object') {\n\t\t\t\tconst val = xmlo(sub);\n\t\t\t\ts += '<' + key + xmli(sub);\n\t\t\t\tif (val.length > 0) {\n\t\t\t\t\ts += '>' + val + '</' + key + '>';\n\t\t\t\t} else {\n\t\t\t\t\ts += ' />';\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn s;\n\t};\n\n\tconst xml = (o: any): string => {\n\t\tlet s = '';\n\t\tObject.keys(o).forEach(key => {\n\t\t\tconst val = xmlo(o[key]);\n\t\t\ts += '<' + key + xmli(o[key]);\n\t\t\tif (val.length > 0) {\n\t\t\t\ts += '>' + val + '</' + key + '>';\n\t\t\t} else {\n\t\t\t\ts += ' />';\n\t\t\t}\n\t\t});\n\t\treturn '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' + s;\n\t};\n\n\treturn xml(obj);\n}\n","module.exports = require(\"util\");","import express from 'express';\nimport {EngineRequest} from '../server';\n\nexport interface SubsonicBaseParams {\n\tusername: string;\n\tpassword?: string;\n\ttoken?: string;\n\tsalt?: string;\n\tformat: string;\n\tclient: string;\n\tversion: string;\n\tcallback?: string;\n}\n\nfunction processParams(req: express.Request): SubsonicBaseParams {\n\t/*\n\tParameter \tRequired \tDefault \tComment\n\tu \tYes \t\tThe username.\n\tp \tYes* \t\tThe password, either in clear text or hex-encoded with a \"enc:\" prefix. Since 1.13.0 this should only be used for testing purposes.\n\tt \tYes* \t\t(Since 1.13.0) The authentication token computed as md5(password + salt). See below for details.\n\ts \tYes* \t\t(Since 1.13.0) A random string (\"salt\") used as input for computing the password hash. See below for details.\n\tv \tYes \t\tThe protocol version implemented by the client, i.e., the version of the subsonic-rest-api.xsd schema used (see below).\n\tc \tYes \t\tA unique string identifying the client application.\n\tf \tNo \txml \tRequest data to be returned in this format. Supported values are \"xml\", \"json\" (since 1.4.0) and \"jsonp\" (since 1.6.0). If using jsonp, specify name of javascript callback function using a callback parameter.\n\t */\n\tconst params: SubsonicBaseParams = {\n\t\tusername: req.query.u,\n\t\tpassword: req.query.p,\n\t\tformat: req.query.f,\n\t\tversion: req.query.v,\n\t\ttoken: req.query.t,\n\t\tsalt: req.query.s,\n\t\tclient: req.query.c,\n\t\tcallback: req.query.callback\n\t};\n\tdelete req.query.t;\n\tdelete req.query.u;\n\tdelete req.query.p;\n\tdelete req.query.f;\n\tdelete req.query.v;\n\tdelete req.query.c;\n\tdelete req.query.s;\n\tdelete req.query.callback;\n\treturn params;\n}\n\nexport interface SubsonicParameterRequest extends EngineRequest {\n\tparameters: SubsonicBaseParams;\n}\n\nexport function SubsonicParameterMiddleWare(req: express.Request, res: express.Response, next: express.NextFunction) {\n\t(<SubsonicParameterRequest>req).parameters = processParams(req);\n\tnext();\n}\n","import {IApiBinaryResult} from '../../typings';\nimport {Engine} from '../../engine/engine';\nimport {FolderType, FolderTypesAlbum, LastFMLookupType, PodcastStatus} from '../../model/jam-types';\nimport {randomItems} from '../../utils/random';\nimport {paginate} from '../../utils/paginate';\nimport {FORMAT} from './format';\nimport {Subsonic} from '../../model/subsonic-rest-data';\nimport {SubsonicParameters} from '../../model/subsonic-rest-params';\nimport {BaseStore, SearchQuery} from '../../objects/base/base.store';\nimport {User} from '../../objects/user/user.model';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Album} from '../../objects/album/album.model';\nimport {Artist} from '../../objects/artist/artist.model';\nimport {Folder} from '../../objects/folder/folder.model';\nimport {Track} from '../../objects/track/track.model';\nimport {Playlist} from '../../objects/playlist/playlist.model';\nimport {Episode} from '../../objects/episode/episode.model';\nimport {State} from '../../objects/state/state.model';\nimport {Podcast} from '../../objects/podcast/podcast.model';\nimport {Bookmark} from '../../objects/bookmark/bookmark.model';\nimport {SearchQueryTrack} from '../../objects/track/track.store';\nimport {hexDecode} from '../../utils/hex';\nimport {DBObjectType} from '../../db/db.types';\n\n/*\n\thttp://www.subsonic.org/pages/api.jsp\n */\n\nexport interface ApiOptions<T> {\n\tquery: T;\n\tuser: User;\n\tclient?: string;\n}\n\nexport class SubsonicApi {\n\n\tconstructor(public engine: Engine) {\n\t}\n\n\t/* helper functions */\n\n\tprivate async prepareList<T extends DBObject, R>(type: DBObjectType, objs: Array<T>, pack: (o: T, state: State) => R, user: User): Promise<Array<R>> {\n\t\tconst states = await this.engine.stateService.findOrCreateMany(objs.map(o => o.id), user.id, type);\n\t\treturn objs.map(o => {\n\t\t\treturn pack(o, states[o.id]);\n\t\t});\n\t}\n\n\tprivate async prepareObj<T extends DBObject, R>(type: DBObjectType, obj: T, pack: (o: T, state: State) => R, user: User): Promise<R> {\n\t\tconst state = await this.engine.stateService.findOrCreate(obj.id, user.id, type);\n\t\treturn pack(obj, state);\n\t}\n\n\tprivate async prepareAlbums(albums: Array<Album>, user: User): Promise<Array<Subsonic.AlbumID3>> {\n\t\treturn this.prepareList<Album, Subsonic.AlbumID3>(DBObjectType.album, albums, FORMAT.packAlbum, user);\n\t}\n\n\tprivate async prepareArtists(artists: Array<Artist>, user: User): Promise<Array<Subsonic.ArtistID3>> {\n\t\treturn this.prepareList<Artist, Subsonic.ArtistID3>(DBObjectType.artist, artists, FORMAT.packArtist, user);\n\t}\n\n\tprivate async prepareFolders(folders: Array<Folder>, user: User): Promise<Array<Subsonic.Child>> {\n\t\treturn this.prepareList<Folder, Subsonic.Child>(DBObjectType.folder, folders, FORMAT.packFolder, user);\n\t}\n\n\tprivate async prepareFolderArtists(folders: Array<Folder>, user: User): Promise<Array<Subsonic.Artist>> {\n\t\treturn this.prepareList<Folder, Subsonic.Artist>(DBObjectType.folder, folders, FORMAT.packFolderArtist, user);\n\t}\n\n\tprivate async prepareTrack(track: Track, user: User): Promise<Subsonic.Child> {\n\t\treturn this.prepareObj<Track, Subsonic.Child>(DBObjectType.track, track, FORMAT.packTrack, user);\n\t}\n\n\tprivate async prepareTracks(tracks: Array<Track>, user: User): Promise<Array<Subsonic.Child>> {\n\t\treturn this.prepareList<Track, Subsonic.Child>(DBObjectType.track, tracks, FORMAT.packTrack, user);\n\t}\n\n\tprivate async prepareBookmarks(bookmarks: Array<Bookmark>, user: User): Promise<Array<Subsonic.Bookmark>> {\n\n\t\tconst removeDups = (list: Array<string>): Array<string> => {\n\t\t\treturn list.filter(function(item, pos) {\n\t\t\t\treturn list.indexOf(item) === pos;\n\t\t\t});\n\t\t};\n\n\t\tconst trackIDs = removeDups(bookmarks.map(bookmark => bookmark.destID));\n\t\tconst userIds = removeDups(bookmarks.map(bookmark => bookmark.userID));\n\t\tconst tracks = await this.engine.store.trackStore.byIds(trackIDs);\n\t\tconst childs = await this.prepareTracks(tracks, user);\n\t\tconst users = await this.engine.store.userStore.byIds(userIds);\n\t\tconst result: Array<Subsonic.Bookmark> = [];\n\t\tbookmarks.forEach(bookmark => {\n\t\t\tconst entry = childs.find(child => child.id === bookmark.destID);\n\t\t\tconst bookmarkuser = users.find(u => u.id === bookmark.userID);\n\t\t\tif (entry && bookmarkuser) {\n\t\t\t\tresult.push(FORMAT.packBookmark(bookmark, bookmarkuser ? bookmarkuser.name : '', entry));\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t}\n\n\tprivate async preparePlaylist(playlist: Playlist, user: User): Promise<Subsonic.PlaylistWithSongs> {\n\t\tconst tracks = await this.engine.store.trackStore.byIds(playlist.trackIDs);\n\t\tconst states = await this.engine.stateService.findOrCreateMany(playlist.trackIDs || [], user.id, DBObjectType.track);\n\t\treturn FORMAT.packPlaylistWithSongs(playlist, tracks, states);\n\t}\n\n\tprivate async prepareEpisodes(episodes: Array<Episode>, user: User): Promise<Array<Subsonic.PodcastEpisode>> {\n\t\tconst states = await this.engine.stateService.findOrCreateMany(episodes.map(episode => episode.id), user.id, DBObjectType.episode);\n\t\treturn episodes.map(episode => {\n\t\t\treturn FORMAT.packPodcastEpisode(episode, states[episode.id], (this.engine.episodeService.isDownloading(episode.id) ? PodcastStatus.downloading : episode.status));\n\t\t});\n\t}\n\n\tprivate async collectStateChangeObjects(req: ApiOptions<SubsonicParameters.State>): Promise<{ [type: string]: Array<DBObject> }> {\n\t\tconst typesObjs: { [type: string]: Array<DBObject> } = {};\n\t\tif (req.query.id) {\n\t\t\tconst ids = Array.isArray(req.query.id) ? req.query.id : [req.query.id];\n\t\t\tconst list = await this.engine.store.findMultiInAll(ids);\n\t\t\tlist.forEach(item => {\n\t\t\t\ttypesObjs[item.type] = typesObjs[item.type] || [];\n\t\t\t\ttypesObjs[item.type].push(item);\n\t\t\t});\n\t\t}\n\t\tif (req.query.albumId) {\n\t\t\tconst ids = Array.isArray(req.query.albumId) ? req.query.albumId : [req.query.albumId];\n\t\t\tconst list = await this.engine.store.albumStore.byIds(ids);\n\t\t\ttypesObjs[DBObjectType.album] = (typesObjs[DBObjectType.album] || []).concat(list);\n\t\t}\n\t\tif (req.query.artistId) {\n\t\t\tconst ids = Array.isArray(req.query.artistId) ? req.query.artistId : [req.query.artistId];\n\t\t\tconst list = await this.engine.store.artistStore.byIds(ids);\n\t\t\ttypesObjs[DBObjectType.artist] = (typesObjs[DBObjectType.artist] || []).concat(list);\n\t\t}\n\t\treturn typesObjs;\n\t}\n\n\t/* api functions */\n\n\tasync ping(req: ApiOptions<{}>): Promise<void> {\n\t\t/*\n\t\t ping\n\n\t\t http://your-server/rest/ping.view\n\t\t Since 1.0.0\n\n\t\t Used to test connectivity with the server. Takes no extra parameters.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\treturn;\n\t}\n\n\tasync getLicense(req: ApiOptions<{}>): Promise<{ license: Subsonic.License }> {\n\t\t/*\n\t\t getLicense\n\n\t\t http://your-server/rest/getLicense.view\n\t\t Since 1.0.0\n\n\t\t Get details about the software license. Takes no extra parameters. Please note that access to the REST API requires that the server has a valid license (after a 30-day trial period). To get a license key you must upgrade to Subsonic Premium.\n\n\t\t Returns a <subsonic-response> element with a nested <license> element on success.\n\t\t */\n\t\treturn {license: {valid: true, email: 'dummy', licenseExpires: '', trialExpires: ''}};\n\t}\n\n\tasync getMusicDirectory(req: ApiOptions<SubsonicParameters.ID>): Promise<{ directory: Subsonic.Directory }> {\n\t\t/*\n\t\t getMusicDirectory\n\n\t\t http://your-server/rest/getMusicDirectory.view\n\t\t Since 1.0.0\n\n\t\t Returns a listing of all files in a music directory. Typically used to get list of albums for an artist, or list of songs for an album.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the music folder. Obtained by calls to getIndexes or getMusicDirectory.\n\n\t\t Returns a <subsonic-response> element with a nested <directory> element on success.\n\t\t */\n\t\tconst folder = await this.byID<Folder>(req.query.id, this.engine.store.folderStore);\n\t\tconst tracks = await this.engine.store.trackStore.search({path: folder.path});\n\t\ttracks.sort((a, b) => {\n\t\t\tconst a1 = (a.tag ? a.tag.track : '') || '';\n\t\t\tconst b1 = (b.tag ? b.tag.track : '') || '';\n\t\t\tif (a1 < b1) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif (a1 > b1) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\treturn 0;\n\t\t});\n\t\tconst folders = await this.engine.store.folderStore.search({parentID: folder.id});\n\t\tfolders.sort((a, b) => {\n\t\t\tconst a1 = (a.tag ? a.tag.album : '') || '';\n\t\t\tconst b1 = (b.tag ? b.tag.album : '') || '';\n\t\t\tif (a1 < b1) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif (a1 > b1) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\treturn 0;\n\t\t});\n\n\t\tlet childs: Array<Subsonic.Child> = [];\n\t\tlet list = await this.prepareFolders(folders, req.user);\n\t\tchilds = childs.concat(list);\n\t\tlist = await this.prepareTracks(tracks, req.user);\n\t\tchilds = childs.concat(list);\n\t\tconst state = await this.engine.stateService.findOrCreate(folder.id, req.user.id, DBObjectType.folder);\n\t\tconst directory = FORMAT.packDirectory(folder, state);\n\t\tdirectory.child = childs;\n\t\treturn {directory};\n\t}\n\n\tasync getIndexes(req: ApiOptions<SubsonicParameters.Indexes>): Promise<{ indexes: Subsonic.Indexes }> {\n\t\t/*\n\t\t getIndexes\n\n\t\t http://your-server/rest/getIndexes.view\n\t\t Since 1.0.0\n\n\t\t Returns an indexed structure of all artists.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t musicFolderId \tNo \t\tIf specified, only return artists in the music folder with the given ID. See getMusicFolders.\n\t\t ifModifiedSince \tNo \t\tIf specified, only return a result if the artist collection has changed since the given time (in milliseconds since 1 Jan 1970).\n\n\t\t Returns a <subsonic-response> element with a nested <indexes> element on success.\n\t\t */\n\n\t\tconst folderIndex = await this.engine.indexService.getFolderIndex();\n\t\tif (req.query.ifModifiedSince && req.query.ifModifiedSince > 0 && (folderIndex.lastModified <= req.query.ifModifiedSince)) {\n\t\t\tconst empty: any = {};\n\t\t\treturn empty;\n\t\t} else {\n\t\t\tconst index = this.engine.indexService.filterFolderIndex(req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined, folderIndex);\n\t\t\tlet ids: Array<string> = [];\n\t\t\tindex.groups.forEach(entry => {\n\t\t\t\tids = ids.concat(entry.entries.map(e => e.folder.id));\n\t\t\t});\n\t\t\tconst states = await this.engine.stateService.findOrCreateMany(ids, req.user.id, DBObjectType.folder);\n\t\t\treturn {\n\t\t\t\tindexes: {\n\t\t\t\t\tlastModified: index.lastModified,\n\t\t\t\t\tignoredArticles: (this.engine.indexService.indexConfig.ignoreArticles || []).join(' '),\n\t\t\t\t\tindex: FORMAT.packFolderIndex(index, states),\n\t\t\t\t\t// shortcut?: Artist[]; use unknown, there is no api to add/remove shortcuts\n\t\t\t\t\t// child?: Child[]; use unknown\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\tasync getArtists(req: ApiOptions<SubsonicParameters.MusicFolderID>): Promise<{ artists: Subsonic.ArtistsID3 }> {\n\t\t/*\n\t\t getArtists\n\n\t\t http://your-server/rest/getArtists.view\n\t\t Since 1.8.0\n\n\t\t Similar to getIndexes, but organizes music according to ID3 tags.\n\n         Parameter \tRequired \tDefault \tComment\n\t\t musicFolderId \tNo \t\tIf specified, only return artists in the music folder with the given ID. See getMusicFolders.\n\n\t\t Returns a <subsonic-response> element with a nested <artists> element on success.\n\t\t */\n\t\tconst artistIndex = await this.engine.indexService.getArtistIndex();\n\t\tconst index = this.engine.indexService.filterArtistIndex(req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined, artistIndex);\n\t\tlet ids: Array<string> = [];\n\t\tindex.groups.forEach(entry => {\n\t\t\tids = ids.concat(entry.entries.map(e => e.artist.id));\n\t\t});\n\t\tconst states = await this.engine.stateService.findOrCreateMany(ids, req.user.id, DBObjectType.artist);\n\t\treturn {\n\t\t\tartists: {\n\t\t\t\tignoredArticles: (this.engine.indexService.indexConfig.ignoreArticles || []).join(' '),\n\t\t\t\tindex: FORMAT.packArtistIndex(index, states)\n\t\t\t}\n\t\t};\n\t}\n\n\tasync getAlbumList(req: ApiOptions<SubsonicParameters.AlbumList>): Promise<{ albumList: Subsonic.AlbumList }> {\n\t\t/*\n\t\t getAlbumList\n\n\t\t http://your-server/rest/getAlbumList.view\n\t\t Since 1.2.0\n\n\t\t Returns a list of random, newest, highest rated etc. albums. Similar to the album lists on the home page of the Subsonic web interface.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t type \tYes \t\tThe list type. Must be one of the following: random, newest, highest, frequent, recent.\n\t\t Since 1.8.0 you can also use alphabeticalByName or alphabeticalByArtist to page through all albums alphabetically, and starred to retrieve starred albums.\n\t\t Since 1.10.1 you can use byYear and byGenre to list albums in a given year range or genre.\n\t\t size \tNo \t10 \tThe number of albums to return. Max 500.\n\t\t offset \tNo \t0 \tThe list offset. Useful if you for example want to page through the list of newest albums.\n\t\t fromYear \tYes (if type is byYear) \t\tThe first year in the range.\n\t\t toYear \tYes (if type is byYear) \t\tThe last year in the range.\n\t\t genre \tYes (if type is byGenre) \t\tThe name of the genre, e.g., \"Rock\".\n\n\t\t Returns a <subsonic-response> element with a nested <albumList> element on success.\n\t\t */\n\t\tconst amount = req.query.size || 20;\n\t\tconst offset = req.query.offset || 0;\n\t\tlet ids: Array<string> = [];\n\t\tlet folders: Array<Folder> = [];\n\t\tswitch (req.query.type) {\n\t\t\tcase 'random':\n\t\t\t\tids = await this.engine.store.folderStore.searchIDs({types: FolderTypesAlbum});\n\t\t\t\tfolders = await this.engine.store.folderStore.byIds(randomItems<string>(ids, amount));\n\t\t\t\tbreak;\n\t\t\tcase 'newest':\n\t\t\t\tfolders = await this.engine.store.folderStore.search({types: FolderTypesAlbum, offset, amount, sorts: [{field: 'created', descending: true}]});\n\t\t\t\tbreak;\n\t\t\tcase 'alphabeticalByArtist':\n\t\t\t\tfolders = await this.engine.store.folderStore.search({types: FolderTypesAlbum, offset, amount, sorts: [{field: 'artist', descending: false}]});\n\t\t\t\tbreak;\n\t\t\tcase 'alphabeticalByName':\n\t\t\t\tfolders = await this.engine.store.folderStore.search({types: FolderTypesAlbum, offset, amount, sorts: [{field: 'album', descending: false}]});\n\t\t\t\tbreak;\n\t\t\tcase 'starred':\n\t\t\t\tids = await this.engine.folderService.getFavedIDs({types: FolderTypesAlbum}, req.user);\n\t\t\t\tfolders = await this.engine.store.folderStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'frequent':\n\t\t\t\tids = await this.engine.folderService.getFrequentlyPlayedIDs({types: FolderTypesAlbum}, req.user);\n\t\t\t\tfolders = await this.engine.store.folderStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'recent':\n\t\t\t\tids = await this.engine.folderService.getRecentlyPlayedIDs({types: FolderTypesAlbum}, req.user);\n\t\t\t\tfolders = await this.engine.store.folderStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'highest':\n\t\t\t\tids = await this.engine.folderService.getHighestRatedIDs({types: FolderTypesAlbum}, req.user);\n\t\t\t\tfolders = await this.engine.store.folderStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'byGenre':\n\t\t\t\tfolders = await this.engine.store.folderStore.search({types: FolderTypesAlbum, offset, amount, genre: req.query.genre || ''});\n\t\t\t\tbreak;\n\t\t\tcase 'byYear':\n\t\t\t\tfolders = await this.engine.store.folderStore.search({offset, amount, types: FolderTypesAlbum, fromYear: req.query.fromYear, toYear: req.query.toYear});\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER, text: 'Unknown Album List Type'});\n\t\t}\n\t\tconst result = await this.prepareFolders(folders, req.user);\n\t\treturn {albumList: {album: result}};\n\t}\n\n\tasync getAlbumList2(req: ApiOptions<SubsonicParameters.AlbumList2>): Promise<{ albumList2: Subsonic.AlbumList2 }> {\n\t\t/*\t getAlbumList2\n\n\t\t http://your-server/rest/getAlbumList2.view\n\t\t Since 1.8.0\n\n\t\t Similar to getAlbumList, but organizes music according to ID3 tags.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t type \tYes \t\tThe list type. Must be one of the following: random, newest, frequent, recent, starred, alphabeticalByName or alphabeticalByArtist. Since 1.10.1 you can use byYear and byGenre to list albums in a given year range or genre.\n\t\t size \tNo \t10 \tThe number of albums to return. Max 500\n\t\t offset \tNo \t0 \tThe list offset. Useful if you for example want to page through the list of newest albums.\n\t\t fromYear \tYes (if type is byYear) \t\tThe first year in the range.\n\t\t toYear \tYes (if type is byYear) \t\tThe last year in the range.\n\t\t genre \tYes (if type is byGenre) \t\tThe name of the genre, e.g., \"Rock\".\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) Only return albums in the music folder with the given ID. See getMusicFolders.\n\n\t\t Returns a <subsonic-response> element with a nested <albumList2> element on success.\n\t\t */\n\n\t\tconst amount = Math.min(req.query.size || 20, 500);\n\t\tconst offset = req.query.offset || 0;\n\t\tconst rootID = req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined;\n\t\tlet albums: Array<Album> = [];\n\t\tlet ids: Array<string> = [];\n\t\tswitch (req.query.type) {\n\t\t\tcase 'random':\n\t\t\t\tids = await this.engine.store.albumStore.searchIDs({rootID});\n\t\t\t\talbums = await this.engine.store.albumStore.byIds(randomItems<string>(ids, amount));\n\t\t\t\tbreak;\n\t\t\tcase 'byGenre':\n\t\t\t\talbums = await this.engine.store.albumStore.search({amount, offset, genre: req.query.genre || '', rootID});\n\t\t\t\tbreak;\n\t\t\tcase 'byYear':\n\t\t\t\talbums = await this.engine.store.albumStore.search({amount, offset, fromYear: req.query.fromYear, toYear: req.query.toYear, rootID});\n\t\t\t\tbreak;\n\t\t\tcase 'newest':\n\t\t\t\talbums = await this.engine.store.albumStore.search({rootID, offset, amount, sorts: [{field: 'created', descending: true}]});\n\t\t\t\tbreak;\n\t\t\tcase 'alphabeticalByArtist':\n\t\t\t\talbums = await this.engine.store.albumStore.search({rootID, offset, amount, sorts: [{field: 'artist', descending: false}]});\n\t\t\t\tbreak;\n\t\t\tcase 'alphabeticalByName':\n\t\t\t\talbums = await this.engine.store.albumStore.search({rootID, offset, amount, sorts: [{field: 'name', descending: false}]});\n\t\t\t\tbreak;\n\t\t\tcase 'starred':\n\t\t\t\tids = await this.engine.albumService.getFavedIDs({rootID}, req.user);\n\t\t\t\talbums = await this.engine.store.albumStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'frequent':\n\t\t\t\tids = await this.engine.albumService.getFrequentlyPlayedIDs({rootID}, req.user);\n\t\t\t\talbums = await this.engine.store.albumStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'recent':\n\t\t\t\tids = await this.engine.albumService.getRecentlyPlayedIDs({rootID}, req.user);\n\t\t\t\talbums = await this.engine.store.albumStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tcase 'highest':\n\t\t\t\tids = await this.engine.albumService.getHighestRatedIDs({rootID}, req.user);\n\t\t\t\talbums = await this.engine.store.albumStore.byIds(paginate(ids, amount, offset));\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER, text: 'Unknown Album List Type'});\n\t\t}\n\t\tconst result = await this.prepareAlbums(albums, req.user);\n\t\treturn {albumList2: {album: result}};\n\t}\n\n\tasync getCoverArt(req: ApiOptions<SubsonicParameters.CoverArt>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t getCoverArt\n\n\t\t http://your-server/rest/getCoverArt.view\n\t\t Since 1.0.0\n\n\t\t Returns a cover art image.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe ID of a song, album or artist.\n\t\t size \tNo \t\tIf specified, scale image to this size.\n\n\t\t Returns the cover art image in binary form.\n\t\t */\n\t\tconst o = await this.engine.store.findInAll(req.query.id);\n\t\tif (!o) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\treturn await this.engine.imageService.getObjImage(o, req.query.size);\n\t}\n\n\tasync getAvatar(req: ApiOptions<SubsonicParameters.Username>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t getAvatar\n\n\t\t http://your-server/rest/getAvatar.view\n\t\t Since 1.8.0\n\n\t\t Returns the avatar (personal image) for a user.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe user in question.\n\n\t\t Returns the avatar image in binary form.\n\t\t */\n\t\tconst name = req.query.username;\n\t\tconst user = await this.engine.userService.getByName(name);\n\t\tif (!user) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\treturn await this.engine.imageService.getObjImage(user);\n\t}\n\n\tasync getAlbumInfo(req: ApiOptions<SubsonicParameters.ID>): Promise<{ albumInfo: Subsonic.AlbumInfo }> {\n\t\t/*\n\t\t http://your-server/rest/getAlbumInfo\n\t\t Since 1.14.0\n\n\t\t Returns album notes, image URLs etc, using data from last.fm.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe album or song ID.\n\n\t\t Returns a <subsonic-response> element with a nested <albumInfo> element on success.\n\t\t */\n\t\tconst folder = await this.engine.store.folderStore.byId(req.query.id);\n\t\tif (folder) {\n\t\t\tif (folder.tag.mbAlbumID) {\n\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.album, folder.tag.mbAlbumID);\n\t\t\t\tif (lastfm && lastfm.album) {\n\t\t\t\t\treturn {albumInfo: FORMAT.packAlbumInfo(lastfm.album)};\n\t\t\t\t}\n\t\t\t} else if (folder.tag.album && folder.tag.artist) {\n\t\t\t\tconst al = await this.engine.metaDataService.lastFMAlbumSearch(folder.tag.album, folder.tag.artist);\n\t\t\t\tif (al && al.album) {\n\t\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.album, al.album.mbid);\n\t\t\t\t\tif (lastfm && lastfm.album) {\n\t\t\t\t\t\treturn {albumInfo: FORMAT.packAlbumInfo(lastfm.album)};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn {albumInfo: {}};\n\t}\n\n\tasync getAlbumInfo2(req: ApiOptions<SubsonicParameters.ID>): Promise<{ albumInfo: Subsonic.AlbumInfo }> {\n\t\t/*\n\t\t http://your-server/rest/getAlbumInfo2\n\n\t\t Since 1.14.0\n\n\t\tSimilar to getAlbumInfo, but organizes music according to ID3 tags.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe album ID.\n\n\t\tReturns a <subsonic-response> element with a nested <albumInfo> element on success.\n\t\t */\n\t\tconst album = await this.engine.store.albumStore.byId(req.query.id);\n\t\tif (album) {\n\t\t\tif (album.mbAlbumID) {\n\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.album, album.mbAlbumID);\n\t\t\t\tif (lastfm && lastfm.album) {\n\t\t\t\t\treturn {albumInfo: FORMAT.packAlbumInfo(lastfm.album)};\n\t\t\t\t}\n\t\t\t} else if (album.name && album.artist) {\n\t\t\t\tconst al = await this.engine.metaDataService.lastFMAlbumSearch(album.name, album.artist);\n\t\t\t\tif (al && al.album) {\n\t\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.album, al.album.mbid);\n\t\t\t\t\tif (lastfm && lastfm.album) {\n\t\t\t\t\t\treturn {albumInfo: FORMAT.packAlbumInfo(lastfm.album)};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn {albumInfo: {}};\n\t}\n\n\tasync getArtistInfo(req: ApiOptions<SubsonicParameters.ArtistInfo>): Promise<{ artistInfo: Subsonic.ArtistInfo }> {\n\t\t/*\n\t\t http://your-server/rest/getArtistInfo Since 1.11.0\n\n\t\tReturns artist info with biography, image URLs and similar artists, using data from last.fm.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe artist, album or song ID.\n\t\tcount \tNo \t20 \tMax number of similar artists to return.\n\t\tincludeNotPresent \tNo \tfalse \tWhether to return artists that are not present in the media library.\n\n\t\tReturns a <subsonic-response> element with a nested <artistInfo> element on success.\n\t\t */\n\t\t// TODO: repair subsonic artistinfo similar\n\t\t// let includeNotPresent = false;\n\t\t// if (req.query.includeNotPresent !== undefined) {\n\t\t// \tincludeNotPresent = req.query.includeNotPresent;\n\t\t// }\n\t\t// const limitCount = req.query.count || 20;\n\n\t\t// let similar = artistInfo.similar || [];\n\t\t// similar = paginate(similar, limitCount, 0);\n\t\t// const folders: Array<Folder> = similar.filter(s => !!s.folder).map(s => <Folder>s.folder);\n\t\t// const children = await this.prepareFolders(folders, req.user);\n\t\t// const artists: Array<Subsonic.Artist> = similar.map(s => {\n\t\t// \tlet child: Subsonic.Child | undefined;\n\t\t// \tif (s.folder) {\n\t\t// \t\tconst f = s.folder;\n\t\t// \t\tchild = children.find(c => c.id === f.id);\n\t\t// \t}\n\t\t// \tif (child) {\n\t\t// \t\treturn {\n\t\t// \t\t\tid: child.id,\n\t\t// \t\t\tname: s.name,\n\t\t// \t\t\tstarred: child.starred,\n\t\t// \t\t\tuserRating: child.userRating,\n\t\t// \t\t\taverageRating: child.averageRating\n\t\t// \t\t};\n\t\t// \t}\n\t\t// \treturn {\n\t\t// \t\tid: '-1', // report an invalid id (as does subsonic/airsonic)\n\t\t// \t\tname: s.name\n\t\t// \t};\n\t\t// });\n\n\t\tconst folder = await this.engine.store.folderStore.byId(req.query.id);\n\t\tif (folder) {\n\t\t\tif (folder.tag.mbArtistID) {\n\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.artist, folder.tag.mbArtistID);\n\t\t\t\tif (lastfm && lastfm.artist) {\n\t\t\t\t\treturn {artistInfo: FORMAT.packArtistInfo(lastfm.artist)};\n\t\t\t\t}\n\t\t\t} else if (folder.tag.artist) {\n\t\t\t\tconst al = await this.engine.metaDataService.lastFMArtistSearch(folder.tag.artist);\n\t\t\t\tif (al && al.artist) {\n\t\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.artist, al.artist.mbid);\n\t\t\t\t\tif (lastfm && lastfm.artist) {\n\t\t\t\t\t\treturn {artistInfo: FORMAT.packArtistInfo(lastfm.artist)};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn {artistInfo: {}};\n\t}\n\n\tasync getArtistInfo2(req: ApiOptions<SubsonicParameters.ArtistInfo>): Promise<{ artistInfo2: Subsonic.ArtistInfo2 }> {\n\t\t/*\n\t\t http://your-server/rest/getArtistInfo2\n\t\t Since 1.11.0\n\n\t\tSimilar to getArtistInfo, but organizes music according to ID3 tags.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe artist ID.\n\t\tcount \tNo \t20 \tMax number of similar artists to return.\n\t\tincludeNotPresent \tNo \tfalse \tWhether to return artists that are not present in the media library.\n\n\t\t Returns a <subsonic-response> element with a nested <artistInfo2> element on success.\n\t\t*/\n\t\t// TODO: repair subsonic artistinfo similar\n\t\t// let includeNotPresent = false;\n\t\t// if (req.query.includeNotPresent !== undefined) {\n\t\t// \tincludeNotPresent = req.query.includeNotPresent;\n\t\t// }\n\t\t// const ids = (infos.similar || []).filter(sim => !!sim.artist).map(sim => (<Artist>sim.artist).id);\n\t\t// const states = await this.engine.stateService.findOrCreateMany(ids, req.user.id, DBObjectType.artist);\n\t\t// const result: Array<Subsonic.ArtistID3> = [];\n\t\t// (infos.similar || []).forEach(sim => {\n\t\t// \tif (sim.artist) {\n\t\t// \t\tresult.push(FORMAT.packArtist(sim.artist, states[sim.artist.id]));\n\t\t// \t} else if (includeNotPresent) {\n\t\t// \t\tresult.push({\n\t\t// \t\t\tid: '-1', // report an invalid id (as does subsonic/airsonic)\n\t\t// \t\t\tname: sim.name,\n\t\t// \t\t\talbumCount: 0\n\t\t// \t\t});\n\t\t// \t}\n\t\t// });\n\t\tconst artist = await this.engine.store.folderStore.byId(req.query.id);\n\t\tif (artist) {\n\t\t\tif (artist.tag.mbArtistID) {\n\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.artist, artist.tag.mbArtistID);\n\t\t\t\tif (lastfm && lastfm.artist) {\n\t\t\t\t\treturn {artistInfo2: FORMAT.packArtistInfo2(lastfm.artist)};\n\t\t\t\t}\n\t\t\t} else if (artist.tag.artist) {\n\t\t\t\tconst al = await this.engine.metaDataService.lastFMArtistSearch(artist.tag.artist);\n\t\t\t\tif (al && al.artist) {\n\t\t\t\t\tconst lastfm = await this.engine.metaDataService.lastFMLookup(LastFMLookupType.artist, al.artist.mbid);\n\t\t\t\t\tif (lastfm && lastfm.artist) {\n\t\t\t\t\t\treturn {artistInfo2: FORMAT.packArtistInfo2(lastfm.artist)};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn {artistInfo2: {}};\n\t}\n\n\tasync getTopSongs(req: ApiOptions<SubsonicParameters.TopSongs>): Promise<{ topSongs: Subsonic.TopSongs }> {\n\t\t/*\n\t\t  http://your-server/rest/getTopSongs Since 1.13.0\n\n\t\tReturns top songs for the given artist, using data from last.fm.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tartist \tYes \t\tThe artist name.\n\t\tcount \tNo \t50 \tMax number of songs to return.\n\n\t\tReturns a <subsonic-response> element with a nested <topSongs> element on success.\n\t\t */\n\t\tconst limitCount = req.query.count || 50;\n\t\tlet tracks = await this.engine.metaDataService.getTopTracks(req.query.artist);\n\t\ttracks = tracks.slice(0, limitCount);\n\t\tconst childs = await this.prepareTracks(tracks, req.user);\n\t\treturn {topSongs: {song: childs}};\n\t}\n\n\tasync getSimilarSongs(req: ApiOptions<SubsonicParameters.SimilarSongs>): Promise<{ similarSongs: Subsonic.SimilarSongs }> {\n\t\t/*\n\t\t http://your-server/rest/getSimilarSongs Since 1.11.0\n\n\t\tReturns a random collection of songs from the given artist and similar artists, using data from last.fm. Typically used for artist radio features.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe artist, album or song ID.\n\t\tcount \tNo \t50 \tMax number of songs to return.\n\n\t\tReturns a <subsonic-response> element with a nested <similarSongs> element on success.\n\t\t */\n\t\tconst o = await this.engine.store.findInAll(req.query.id);\n\t\tif (!o) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t} else {\n\t\t\tlet tracks: Array<Track> = [];\n\t\t\tswitch (o.type) {\n\t\t\t\tcase DBObjectType.track:\n\t\t\t\t\ttracks = await this.engine.metaDataService.getTrackSimilarTracks(<Track>o);\n\t\t\t\t\tbreak;\n\t\t\t\tcase DBObjectType.folder:\n\t\t\t\t\ttracks = await this.engine.metaDataService.getFolderSimilarTracks(<Folder>o);\n\t\t\t\t\tbreak;\n\t\t\t\tcase DBObjectType.artist:\n\t\t\t\t\ttracks = await this.engine.metaDataService.getArtistSimilarTracks(<Artist>o);\n\t\t\t\t\tbreak;\n\t\t\t\tcase DBObjectType.album:\n\t\t\t\t\ttracks = await this.engine.metaDataService.getAlbumSimilarTracks(<Album>o);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst limit = paginate(tracks, req.query.count || 50, 0);\n\t\t\tconst childs = await this.prepareTracks(limit, req.user);\n\t\t\treturn {similarSongs: FORMAT.packSimilarSongs(childs)};\n\t\t}\n\t}\n\n\tasync getSimilarSongs2(req: ApiOptions<SubsonicParameters.SimilarSongs>): Promise<{ similarSongs2: Subsonic.SimilarSongs2 }> {\n\t\t/*\n\t\t http://your-server/rest/getSimilarSongs2\n\t\t Since 1.11.0\n\n\t\tSimilar to getSimilarSongs, but organizes music according to ID3 tags.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe artist ID.\n\t\tcount \tNo \t50 \tMax number of songs to return.\n\n\t\tReturns a <subsonic-response> element with a nested <similarSongs2> element on success.\n\t\t */\n\t\tconst artist = await this.byID<Artist>(req.query.id, this.engine.store.artistStore);\n\t\tconst tracks = await this.engine.metaDataService.getArtistSimilarTracks(artist);\n\t\tconst limit = paginate(tracks, req.query.count || 50, 0);\n\t\tconst childs = await this.prepareTracks(limit, req.user);\n\t\treturn {similarSongs2: FORMAT.packSimilarSongs2(childs)};\n\t}\n\n\tasync download(req: ApiOptions<SubsonicParameters.ID>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t download\n\n\t\t http://your-server/rest/download.view\n\t\t Since 1.0.0\n\n\t\t Downloads a given media file. Similar to stream, but this method returns the original media data without transcoding or downsampling.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the file to download. Obtained by calls to getMusicDirectory.\n\n\t\t Returns binary data on success, or an XML document on error (in which case the HTTP content type will start with \"text/xml\").\n\t\t */\n\t\tconst o = await this.engine.store.findInAll(req.query.id);\n\t\tif (!o) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t} else {\n\t\t\treturn this.engine.downloadService.getObjDownload(o, undefined, req.user);\n\t\t}\n\t}\n\n\tasync stream(req: ApiOptions<SubsonicParameters.Stream>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t stream\n\n\t\t http://your-server/rest/stream.view\n\t\t Since 1.0.0\n\n\t\t Streams a given media file.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the file to stream. Obtained by calls to getMusicDirectory.\n\t\t maxBitRate \tNo \t\t(Since 1.2.0) If specified, the server will attempt to limit the bitrate to this value, in kilobits per second. If set to zero, no limit is imposed.\n\t\t format \tNo \t\t(Since 1.6.0) Specifies the preferred target format (e.g., \"mp3\" or \"flv\") in case there are multiple applicable transcodings. Starting with 1.9.0 you can use the special value \"raw\" to disable transcoding.\n\t\t timeOffset \tNo \t\tOnly applicable to video streaming. If specified, start streaming at the given offset (in seconds) into the video. Typically used to implement video skipping.\n\t\t size \tNo \t\t(Since 1.6.0) Only applicable to video streaming. Requested video size specified as WxH, for instance \"640x480\".\n\t\t estimateContentLength \tNo \tfalse \t(Since 1.8.0). If set to \"true\", the Content-Length HTTP header will be set to an estimated value for transcoded or downsampled media.\n\t\t converted \tNo \tfalse \t(Since 1.14.0) Only applicable to video streaming. Subsonic can optimize videos for streaming by converting them to MP4. If a conversion exists for the video in question, then setting this parameter to \"true\" will cause the converted video to be returned instead of the original.\n\n\t\t Returns binary data on success, or an XML document on error (in which case the HTTP content type will start with \"text/xml\").\n\t\t */\n\t\tconst o = await this.engine.store.findInAll(req.query.id);\n\t\tif (!o) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t} else {\n\t\t\tswitch (o.type) {\n\t\t\t\tcase DBObjectType.track:\n\t\t\t\t\tconst res = await this.engine.streamService.streamTrack(<Track>o, req.query.format, req.query.maxBitRate, req.user);\n\t\t\t\t\tthis.engine.nowPlayingService.reportTrack(<Track>o, req.user);\n\t\t\t\t\treturn res;\n\t\t\t\tcase DBObjectType.episode:\n\t\t\t\t\tconst result = await this.engine.streamService.streamEpisode(<Episode>o, req.query.format, req.query.maxBitRate, req.user);\n\t\t\t\t\tthis.engine.nowPlayingService.reportEpisode(<Episode>o, req.user);\n\t\t\t\t\treturn result;\n\t\t\t}\n\t\t\treturn Promise.reject(Error('Invalid Object Type for Streaming'));\n\t\t}\n\t}\n\n\tasync getSong(req: ApiOptions<SubsonicParameters.ID>): Promise<{ song: Subsonic.Child }> {\n\t\t/*\n\t\t getSong\n\n\t\t http://your-server/rest/getSong.view\n\t\t Since 1.8.0\n\n\t\t Returns details for a song.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe song ID.\n\n\t\t Returns a <subsonic-response> element with a nested <song> element on success.\n\t\t */\n\t\tconst track = await this.byID<Track>(req.query.id, this.engine.store.trackStore);\n\t\tconst child = await this.prepareTrack(track, req.user);\n\t\treturn {song: child};\n\t}\n\n\tasync getGenres(req: ApiOptions<{}>): Promise<{ genres: Subsonic.Genres }> {\n\t\t/*\n\t\t getGenres\n\n\t\t http://your-server/rest/getGenres.view\n\t\t Since 1.9.0\n\n\t\t Returns all genres.\n\n\t\t Returns a <subsonic-response> element with a nested <genres> element on success.\n\t\t */\n\t\tconst genres = await this.engine.genreService.getGenres();\n\t\tconst list: Array<Subsonic.Genre> = genres.map(genre => FORMAT.packGenre(genre));\n\t\tif (list.length === 0) {\n\t\t\tconst dummy: Subsonic.Genre = {\n\t\t\t\tcontent: '-',\n\t\t\t\tsongCount: 0,\n\t\t\t\tartistCount: 0,\n\t\t\t\talbumCount: 0\n\t\t\t};\n\t\t\tlist.push(dummy);\n\t\t}\n\t\treturn {genres: {genre: list}};\n\t}\n\n\tasync getMusicFolders(req: ApiOptions<{}>): Promise<{ musicFolders: Subsonic.MusicFolders }> {\n\t\t/*\n\t\t getMusicFolders\n\n\t\t http://your-server/rest/getMusicFolders.view\n\t\t Since 1.0.0\n\n\t\t Returns all configured top-level music folders. Takes no extra parameters.\n\n\t\t Returns a <subsonic-response> element with a nested <musicFolders> element on success.\n\t\t */\n\t\tconst list = await this.engine.store.rootStore.all();\n\t\treturn {musicFolders: {musicFolder: list.map(FORMAT.packRoot)}};\n\t}\n\n\tasync getUser(req: ApiOptions<SubsonicParameters.Username>): Promise<{ user: Subsonic.User }> {\n\n\t\t/*\n\t\t getUser\n\n\t\t http://your-server/rest/getUser.view\n\t\t Since 1.3.0\n\n\t\t Get details about a given user, including which authorization roles it has. Can be used to enable/disable certain features in the client, such as jukebox control.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe name of the user to retrieve. You can only retrieve your own user unless you have admin privileges.\n\n\t\t Returns a <subsonic-response> element with a nested <user> element on success.\n\t\t */\n\n\t\tif ((!req.query.username) || (req.user.name === req.query.username)) {\n\t\t\treturn {user: FORMAT.packUser(req.user)};\n\t\t} else if (!req.user.roles.admin) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t} else {\n\t\t\tconst u = await this.engine.userService.getByName(req.query.username);\n\t\t\tif (!u) {\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t\t} else {\n\t\t\t\treturn {user: FORMAT.packUser(u)};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync star(req: ApiOptions<SubsonicParameters.State>): Promise<void> {\n\t\t/*\n\t\t http://your-server/rest/star.view\n\t\t Since 1.8.0\n\n\t\t Attaches a star to a song, album or artist.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tNo \t\tThe ID of the file (song) or folder (album/artist) to star. Multiple parameters allowed.\n\t\t albumId \tNo \t\tThe ID of an album to star. Use this rather than id if the client accesses the media collection according to ID3 tags rather than file structure. Multiple parameters allowed.\n\t\t artistId \tNo \t\tThe ID of an artist to star. Use this rather than id if the client accesses the media collection according to ID3 tags rather than file structure. Multiple parameters allowed.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst typesObjs = await this.collectStateChangeObjects(req);\n\t\tfor (const key of Object.keys(typesObjs)) {\n\t\t\tconst type: DBObjectType = parseInt(key, 10);\n\t\t\tfor (const item of typesObjs[type]) {\n\t\t\t\tawait this.engine.stateService.fav(item.id, type, req.user.id, false);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync unstar(req: ApiOptions<SubsonicParameters.State>): Promise<void> {\n\t\t/*\n\t\t http://your-server/rest/unstar.view\n\t\t Since 1.8.0\n\n\t\t Removes the star from a song, album or artist.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tNo \t\tThe ID of the file (song) or folder (album/artist) to unstar. Multiple parameters allowed.\n\t\t albumId \tNo \t\tThe ID of an album to unstar. Use this rather than id if the client accesses the media collection according to ID3 tags rather than file structure. Multiple parameters allowed.\n\t\t artistId \tNo \t\tThe ID of an artist to unstar. Use this rather than id if the client accesses the media collection according to ID3 tags rather than file structure. Multiple parameters allowed.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst typesObjs = await this.collectStateChangeObjects(req);\n\t\tfor (const key of Object.keys(typesObjs)) {\n\t\t\tconst type: DBObjectType = parseInt(key, 10);\n\t\t\tfor (const item of typesObjs[type]) {\n\t\t\t\tawait this.engine.stateService.fav(item.id, type, req.user.id, true);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync setRating(req: ApiOptions<SubsonicParameters.Rate>): Promise<void> {\n\t\t/*\n\t\t setRating\n\n\t\t http://your-server/rest/setRating.view\n\t\t Since 1.6.0\n\n\t\t Sets the rating for a music file.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the file (song) or folder (album/artist) to rate.\n\t\t rating \tYes \t\tThe rating between 1 and 5 (inclusive), or 0 to remove the rating.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tif ((req.query.rating < 0) || (req.query.rating > 5)) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER});\n\t\t}\n\t\tconst typesObjs = await this.collectStateChangeObjects(req);\n\t\tfor (const key of Object.keys(typesObjs)) {\n\t\t\tconst type: DBObjectType = parseInt(key, 10);\n\t\t\tfor (const item of typesObjs[type]) {\n\t\t\t\tawait this.engine.stateService.rate(item.id, type, req.user.id, req.query.rating);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync getNowPlaying(req: ApiOptions<{}>): Promise<{ nowPlaying: Subsonic.NowPlaying }> {\n\t\t/*\n\t\t getNowPlaying\n\n\t\t http://your-server/rest/getNowPlaying.view\n\t\t Since 1.0.0\n\n\t\t Returns what is currently being played by all users. Takes no extra parameters.\n\n\t\t Returns a <subsonic-response> element with a nested <nowPlaying> element on success.\n\t\t */\n\t\tconst list = await this.engine.nowPlayingService.getNowPlaying();\n\t\tconst result: Array<Subsonic.NowPlayingEntry> = [];\n\t\tfor (const entry of list) {\n\t\t\tconst state = await this.engine.stateService.findOrCreate(entry.obj.id, req.user.id, entry.obj.type);\n\t\t\tresult.push(FORMAT.packNowPlaying(entry, state));\n\t\t}\n\t\treturn {nowPlaying: {entry: result}};\n\t}\n\n\tasync getUsers(req: ApiOptions<{}>): Promise<{ users: Subsonic.Users }> {\n\t\t/* getUsers\n\n\t\t http://your-server/rest/getUsers.view\n\t\t Since 1.8.0\n\n\t\t Get details about all users, including which authorization roles they have. Only users with admin privileges are allowed to req this method.\n\n\t\t Returns a <subsonic-response> element with a nested <users> element on success.\n\t\t */\n\t\tconst users = await this.engine.store.userStore.all();\n\t\treturn {users: {user: users.map(FORMAT.packUser)}};\n\t}\n\n\tasync updateUser(req: ApiOptions<SubsonicParameters.UpdateUser>): Promise<void> {\n\t\t/*\n\t\t updateUser\n\n\t\t http://your-server/rest/updateUser.view\n\t\t Since 1.10.1\n\n\t\t Modifies an existing Subsonic user, using the following parameters:\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe name of the user.\n\t\t password \tNo \t\tThe password of the user, either in clear text of hex-encoded (see above).\n\t\t email \tNo \t\tThe email address of the user.\n\t\t ldapAuthenticated \tNo \t\tWhether the user is authenicated in LDAP.\n\t\t adminRole \tNo \t\tWhether the user is administrator.\n\t\t settingsRole \tNo \t\tWhether the user is allowed to change settings and password.\n\t\t streamRole \tNo \t\tWhether the user is allowed to play files.\n\t\t jukeboxRole \tNo \t\tWhether the user is allowed to play files in jukebox mode.\n\t\t downloadRole \tNo \t\tWhether the user is allowed to download files.\n\t\t uploadRole \tNo \t\tWhether the user is allowed to upload files.\n\t\t coverArtRole \tNo \t\tWhether the user is allowed to change cover art and tags.\n\t\t commentRole \tNo \t\tWhether the user is allowed to create and edit comments and ratings.\n\t\t podcastRole \tNo \t\tWhether the user is allowed to administrate Podcasts.\n\t\t shareRole \tNo \t\tWhether the user is allowed to share files with anyone.\n\t\t videoConversionRole \tNo \tfalse \t(Since 1.15.0) Whether the user is allowed to start video conversions.\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) IDs of the music folders the user is allowed access to. Include the parameter once for each folder.\n\t\t maxBitRate \tNo \t\t(Since 1.13.0) The maximum bit rate (in Kbps) for the user. Audio streams of higher bit rates are automatically downsampled to this bit rate. Legal values: 0 (no limit), 32, 40, 48, 56, 64, 80, 96, 112, 128, 160, 192, 224, 256, 320.\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\n\t\tconst getBool = (b: boolean | undefined, def: boolean): boolean => {\n\t\t\treturn b === undefined ? def : b;\n\t\t};\n\t\tconst username = req.query.username;\n\t\tconst u = await this.engine.userService.getByName(username);\n\t\tif (!u) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\tif (req.query.email) {\n\t\t\tu.email = req.query.email;\n\t\t}\n\t\tif (req.query.password) {\n\t\t\tu.subsonic_pass = req.query.password;\n\t\t}\n\t\tif (req.query.musicFolderId) {\n\t\t\tu.allowedfolder = (Array.isArray(req.query.musicFolderId) ? req.query.musicFolderId : [req.query.musicFolderId]).map(id => id.toString());\n\t\t}\n\t\tif (req.query.maxBitRate !== undefined) {\n\t\t\tu.maxBitRate = req.query.maxBitRate || 0;\n\t\t}\n\t\tif (req.query.username) {\n\t\t\tu.name = req.query.username;\n\t\t}\n\t\t// u.ldapAuthenticated = getBool(req.query.ldapAuthenticated, u.ldapAuthenticated);\n\t\t// u.scrobblingEnabled = getBool(req.query.scrobblingEnabled, u.scrobblingEnabled);\n\t\tu.roles.admin = getBool(req.query.adminRole, u.roles.admin);\n\t\t// u.roles.settingsRole = getBool(req.query.settingsRole, u.roles.settingsRole);\n\t\tu.roles.stream = getBool(req.query.streamRole, u.roles.stream);\n\t\t// u.roles.jukeboxRole = getBool(req.query.jukeboxRole, u.roles.jukeboxRole);\n\t\t// u.roles.downloadRole = getBool(req.query.downloadRole, u.roles.downloadRole);\n\t\tu.roles.upload = getBool(req.query.uploadRole, u.roles.upload);\n\t\t// u.roles.coverArtRole = getBool(req.query.coverArtRole, u.roles.coverArtRole);\n\t\t// u.roles.commentRole = getBool(req.query.commentRole, u.roles.commentRole);\n\t\tu.roles.podcast = getBool(req.query.podcastRole, u.roles.podcast);\n\t\t// u.roles.playlistRole = getBool(req.query.playlistRole, u.roles.playlistRole);\n\t\t// u.roles.shareRole = getBool(req.query.shareRole, u.roles.shareRole);\n\t\t// u.roles.videoConversionRole = getBool(req.query.videoConversionRole, u.roles.videoConversionRole);\n\t\tawait this.engine.userService.update(u);\n\t}\n\n\tasync createUser(req: ApiOptions<SubsonicParameters.UpdateUser>): Promise<void> {\n\t\t/*\n\t\t createUser\n\n\t\t http://your-server/rest/createUser.view\n\t\t Since 1.1.0\n\n\t\t Creates a new Subsonic user, using the following parameters:\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe name of the new user.\n\t\t password \tYes \t\tThe password of the new user, either in clear text of hex-encoded (see above).\n\t\t email \tYes \t\tThe email address of the new user.\n\t\t ldapAuthenticated \tNo \tfalse \tWhether the user is authenicated in LDAP.\n\t\t adminRole \tNo \tfalse \tWhether the user is administrator.\n\t\t settingsRole \tNo \ttrue \tWhether the user is allowed to change settings and password.\n\t\t streamRole \tNo \ttrue \tWhether the user is allowed to play files.\n\t\t jukeboxRole \tNo \tfalse \tWhether the user is allowed to play files in jukebox mode.\n\t\t downloadRole \tNo \tfalse \tWhether the user is allowed to download files.\n\t\t uploadRole \tNo \tfalse \tWhether the user is allowed to upload files.\n\t\t playlistRole \tNo \tfalse \tWhether the user is allowed to create and delete playlists. Since 1.8.0, changing this role has no effect.\n\t\t coverArtRole \tNo \tfalse \tWhether the user is allowed to change cover art and tags.\n\t\t commentRole \tNo \tfalse \tWhether the user is allowed to create and edit comments and ratings.\n\t\t podcastRole \tNo \tfalse \tWhether the user is allowed to administrate Podcasts.\n\t\t shareRole \tNo \tfalse \t(Since 1.8.0)Whether the user is allowed to share files with anyone.\n\t\t videoConversionRole \tNo \tfalse \t(Since 1.15.0) Whether the user is allowed to start video conversions.\n\t\t musicFolderId \tNo \tAll folders \t(Since 1.12.0) IDs of the music folders the user is allowed access to. Include the parameter once for each folder.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\n\t\tif (\n\t\t\t(!req.query.username) || (req.query.username.length === 0) ||\n\t\t\t(!req.query.password) || (req.query.password.length === 0) ||\n\t\t\t(!req.query.email) || (req.query.email.length === 0)\n\t\t) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER});\n\t\t}\n\t\tconst getBool = (b: boolean | undefined, def: boolean): boolean => {\n\t\t\treturn b === undefined ? def : b;\n\t\t};\n\t\tconst u: User = {\n\t\t\tid: '',\n\t\t\tname: req.query.username || '',\n\t\t\tsalt: '',\n\t\t\thash: '',\n\t\t\tsubsonic_pass: req.query.password || 'invalid',\n\t\t\temail: req.query.email || 'invalid',\n\t\t\tavatarLastChanged: Date.now(),\n\t\t\tcreated: Date.now(),\n\t\t\ttype: DBObjectType.user,\n\t\t\t// ldapAuthenticated: getBool(req.query.ldapAuthenticated, false),\n\t\t\tscrobblingEnabled: false, // getBool(req.query.scrobblingEnabled, false),\n\t\t\troles: {\n\t\t\t\tadmin: getBool(req.query.adminRole, false),\n\t\t\t\t// settingsRole: getBool(req.query.settingsRole, true),\n\t\t\t\tstream: getBool(req.query.streamRole, true),\n\t\t\t\t// jukeboxRole: getBool(req.query.jukeboxRole, false),\n\t\t\t\t// downloadRole: getBool(req.query.downloadRole, false),\n\t\t\t\tupload: getBool(req.query.uploadRole, false),\n\t\t\t\t// playlistRole: getBool(req.query.playlistRole, false),\n\t\t\t\t// coverArtRole: getBool(req.query.coverArtRole, false),\n\t\t\t\t// commentRole: getBool(req.query.commentRole, false),\n\t\t\t\tpodcast: getBool(req.query.podcastRole, false),\n\t\t\t\t// shareRole: getBool(req.query.shareRole, false),\n\t\t\t\t// videoConversionRole: getBool(req.query.videoConversionRole, false)\n\t\t\t}\n\t\t};\n\t\tif (u.subsonic_pass.indexOf('enc:') === 0) {\n\t\t\tu.subsonic_pass = hexDecode(u.subsonic_pass.slice(4)).trim();\n\t\t}\n\t\tawait this.engine.userService.create(u);\n\t}\n\n\tasync deleteUser(req: ApiOptions<SubsonicParameters.Username>): Promise<void> {\n\t\t/*\n\t\t deleteUser\n\n\t\t http://your-server/rest/deleteUser.view\n\t\t Since 1.3.0\n\n\t\t Deletes an existing Subsonic user, using the following parameters:\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe name of the user to delete.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst u = await this.engine.userService.getByName(req.query.username);\n\t\tif (!u) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\tawait this.engine.userService.remove(u);\n\t}\n\n\tasync changePassword(req: ApiOptions<SubsonicParameters.ChangePassword>): Promise<void> {\n\t\t/*\n\t\t changePassword\n\n\t\t http://your-server/rest/changePassword.view\n\t\t Since 1.1.0\n\n\t\t Changes the password of an existing Subsonic user, using the following parameters. You can only change your own password unless you have admin privileges.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tYes \t\tThe name of the user which should change its password.\n\t\t password \tYes \t\tThe new password of the new user, either in clear text of hex-encoded (see above).\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tif (\n\t\t\t(!req.query.username) ||\n\t\t\t(!req.query.password) ||\n\t\t\t(req.query.password.length === 0)\n\t\t) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER});\n\t\t}\n\t\tif (req.query.username !== req.user.name) {\n\t\t\tif (!req.user.roles.admin) {\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t\t}\n\t\t}\n\t\tconst u = await this.engine.userService.getByName(req.query.username);\n\t\tif (!u) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\tu.subsonic_pass = req.query.password;\n\t\tif (u.subsonic_pass.indexOf('enc:') === 0) {\n\t\t\tu.subsonic_pass = hexDecode(u.subsonic_pass.slice(4)).trim();\n\t\t}\n\t\tawait this.engine.userService.update(u);\n\t}\n\n\tasync getChatMessages(req: ApiOptions<SubsonicParameters.ChatMessages>): Promise<{ chatMessages: Subsonic.ChatMessages }> {\n\t\t/*\n\t\t getChatMessages\n\n\t\t http://your-server/rest/getChatMessages.view\n\t\t Since 1.2.0\n\n\t\t Returns the current visible (non-expired) chat messages.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t since \tNo \t\tOnly return messages newer than this time (in millis since Jan 1 1970).\n\n\t\t Returns a <subsonic-response> element with a nested <chatMessages> element on success.\n\t\t */\n\t\tconst messages = await this.engine.chatService.get(req.query.since);\n\t\treturn {chatMessages: {chatMessage: messages.map(msg => FORMAT.packChatMessage(msg))}};\n\t}\n\n\tasync addChatMessage(req: ApiOptions<SubsonicParameters.ChatMessage>): Promise<void> {\n\t\t/*\n\t\t addChatMessage\n\n\t\t http://your-server/rest/addChatMessage.view\n\t\t Since 1.2.0\n\n\t\t Adds a message to the chat log.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t message \tYes \t\tThe chat message.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tawait this.engine.chatService.add(req.query.message, req.user);\n\t}\n\n\tasync getPlaylists(req: ApiOptions<SubsonicParameters.Playlists>): Promise<{ playlists: Subsonic.Playlists }> {\n\t\t/*\n\t\t getPlaylists\n\n\t\t http://your-server/rest/getPlaylists.view\n\t\t Since 1.0.0\n\n\t\t Returns all playlists a user is allowed to play.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t username \tno \t\t(Since 1.8.0) If specified, return playlists for this user rather than for the authenticated user. The authenticated user must have admin role if this parameter is used.\n\n\t\t Returns a <subsonic-response> element with a nested <playlists> element on success.\n\t\t */\n\t\tlet userID = req.user.id;\n\t\tif ((req.query.username) && (req.query.username !== req.user.name)) {\n\t\t\tif (!req.user.roles.admin) {\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t\t}\n\t\t\tconst u = await this.engine.userService.getByName(req.query.username);\n\t\t\tif (!u) {\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t\t}\n\t\t\tuserID = u.id;\n\t\t}\n\t\tconst list = await this.engine.store.playlistStore.search({userID, isPublic: req.user.id !== userID});\n\t\tconst playlists: Subsonic.Playlists = {};\n\t\tconst result: Array<Subsonic.Playlist> = [];\n\t\tfor (const playlist of list) {\n\t\t\tconst plist = await this.preparePlaylist(playlist, req.user);\n\t\t\tresult.push(plist);\n\t\t}\n\t\tplaylists.playlist = result;\n\t\treturn {playlists};\n\t}\n\n\tasync getPlaylist(req: ApiOptions<SubsonicParameters.ID>): Promise<{ playlist: Subsonic.Playlist }> {\n\t\t/*\n\t\t getPlaylist\n\n\t\t http://your-server/rest/getPlaylist.view\n\t\t Since 1.0.0\n\n\t\t Returns a listing of files in a saved playlist.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tyes \t\tID of the playlist to return, as obtained by getPlaylists.\n\n\t\t Returns a <subsonic-response> element with a nested <playlist> element on success.\n\t\t */\n\n\t\tconst playlist = await this.byID<Playlist>(req.query.id, this.engine.store.playlistStore);\n\t\tif (playlist.userID !== req.user.id) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t}\n\t\tconst result = await this.preparePlaylist(playlist, req.user);\n\t\treturn {playlist: result};\n\t}\n\n\tasync createPlaylist(req: ApiOptions<SubsonicParameters.PlaylistCreate>): Promise<{ playlist: Subsonic.PlaylistWithSongs }> {\n\t\t/*\n\t\t createPlaylist\n\n\t\t http://your-server/rest/createPlaylist.view\n\t\t Since 1.2.0\n\n\t\t Creates (or updates) a playlist.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t playlistId \tYes (if updating) \t\tThe playlist ID.\n\t\t name \tYes (if creating) \t\tThe human-readable name of the playlist.\n\t\t songId \tYes \t\tID of a song in the playlist. Use one songId parameter for each song in the playlist.\n\n\t\t Since 1.14.0 the newly created/updated playlist is returned. In earlier versions an empty <subsonic-response> element is returned.\n\t\t */\n\t\tlet playlist: Playlist | undefined;\n\t\tif (!req.query.playlistId && !req.query.name) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.PARAMETER});\n\t\t} else if (req.query.playlistId) {\n\t\t\tconst updateQuery: SubsonicParameters.PlaylistUpdate = {\n\t\t\t\tplaylistId: req.query.playlistId,\n\t\t\t\tname: req.query.name,\n\t\t\t\tsongIdToAdd: req.query.songId\n\t\t\t};\n\t\t\t(<any>req).query = updateQuery;\n\t\t\tawait this.updatePlaylist(<ApiOptions<SubsonicParameters.PlaylistUpdate>>req);\n\t\t\tplaylist = await this.byID<Playlist>(req.query.playlistId, this.engine.store.playlistStore);\n\t\t} else if (req.query.name) {\n\t\t\tplaylist = await this.engine.playlistService.create(req.query.name, undefined, false, req.user.id, req.query.songId !== undefined ? (Array.isArray(req.query.songId) ? req.query.songId : [req.query.songId]) : []);\n\t\t}\n\t\tif (!playlist) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\tconst tracks = await this.engine.store.trackStore.byIds(playlist.trackIDs);\n\t\tconst states = await this.engine.stateService.findOrCreateMany(playlist.trackIDs, req.user.id, DBObjectType.track);\n\t\treturn {playlist: FORMAT.packPlaylistWithSongs(playlist, tracks, states)};\n\t}\n\n\tasync updatePlaylist(req: ApiOptions<SubsonicParameters.PlaylistUpdate>): Promise<void> {\n\t\t/*\n\t\t updatePlaylist\n\n\t\t http://your-server/rest/updatePlaylist.view\n\t\t Since 1.8.0\n\n\t\t Updates a playlist. Only the owner of a playlist is allowed to update it.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t playlistId \tYes \t\tThe playlist ID.\n\t\t name \tNo \t\tThe human-readable name of the playlist.\n\t\t comment \tNo \t\tThe playlist comment.\n\t\t public \tNo \t\ttrue if the playlist should be visible to all users, false otherwise.\n\t\t songIdToAdd \tNo \t\tAdd this song with this ID to the playlist. Multiple parameters allowed.\n\t\t songIndexToRemove \tNo \t\tRemove the song at this position in the playlist. Multiple parameters allowed.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst playlist = await this.byID<Playlist>(req.query.playlistId, this.engine.store.playlistStore);\n\t\tif (req.user.id !== playlist.userID) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t}\n\n\t\tconst removetracks = req.query.songIndexToRemove !== undefined ? (Array.isArray(req.query.songIndexToRemove) ? req.query.songIndexToRemove : [req.query.songIndexToRemove]) : [];\n\t\tplaylist.trackIDs = playlist.trackIDs.filter((id, index) => removetracks.indexOf(index) < 0);\n\n\t\tconst tracks: Array<string> = playlist.trackIDs;\n\t\tif (req.query.songIdToAdd) {\n\t\t\tconst songadd = req.query.songIdToAdd !== undefined ? (Array.isArray(req.query.songIdToAdd) ? req.query.songIdToAdd : [req.query.songIdToAdd]) : [];\n\t\t\tplaylist.trackIDs = tracks.concat(songadd);\n\t\t}\n\t\tplaylist.name = req.query.name || playlist.name;\n\t\tplaylist.comment = req.query.comment || playlist.comment;\n\t\tplaylist.isPublic = req.query.public !== undefined ? req.query.public : playlist.isPublic;\n\t\tplaylist.changed = Date.now();\n\t\tawait this.engine.playlistService.update(playlist);\n\t}\n\n\tasync deletePlaylist(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t deletePlaylist\n\n\t\t http://your-server/rest/deletePlaylist.view\n\t\t Since 1.2.0\n\n\t\t Deletes a saved playlist.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tyes \t\tID of the playlist to delete, as obtained by getPlaylists.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst playlist = await this.byID<Playlist>(req.query.id, this.engine.store.playlistStore);\n\t\tif (playlist.userID !== req.user.id) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.UNAUTH});\n\t\t}\n\t\tawait this.engine.playlistService.remove(playlist);\n\t}\n\n\tasync getStarred(req: ApiOptions<SubsonicParameters.MusicFolderID>): Promise<{ starred: Subsonic.Starred }> {\n\t\t/*\n\t\t getStarred\n\n\t\t http://your-server/rest/getStarred.view\n\t\t Since 1.8.0\n\n\t\t Returns starred songs, albums and artists.\n\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) Only return results from the music folder with the given ID. See getMusicFolders.\n\n\t\t Returns a <subsonic-response> element with a nested <starred> element on success.\n\t\t */\n\t\tconst rootID = (req.query.musicFolderId !== undefined ? req.query.musicFolderId.toString() : undefined);\n\t\tconst starred: Subsonic.Starred = {};\n\t\tconst trackIDs = await this.engine.trackService.getFavedIDs({rootID}, req.user);\n\t\tif (trackIDs.length > 0) {\n\t\t\tconst tracks = await this.engine.store.trackStore.byIds(trackIDs);\n\t\t\tstarred.song = await this.prepareTracks(tracks, req.user);\n\t\t}\n\t\tconst artistFolderIDs = await this.engine.folderService.getFavedIDs({types: [FolderType.artist], rootID}, req.user);\n\t\tif (artistFolderIDs.length > 0) {\n\t\t\tconst folders = await this.engine.store.folderStore.byIds(artistFolderIDs);\n\t\t\tstarred.artist = await this.prepareFolderArtists(folders, req.user);\n\t\t}\n\t\tconst albumFolderIDs = await this.engine.folderService.getFavedIDs({types: FolderTypesAlbum, rootID}, req.user);\n\t\tif (albumFolderIDs.length > 0) {\n\t\t\tconst folders = await this.engine.store.folderStore.byIds(albumFolderIDs);\n\t\t\tstarred.album = await this.prepareFolders(folders, req.user);\n\t\t}\n\t\treturn {starred};\n\t}\n\n\tasync getStarred2(req: ApiOptions<SubsonicParameters.MusicFolderID>): Promise<{ starred2: Subsonic.Starred2 }> {\n\t\t/*\n\t\t getStarred2\n\n\t\t http://your-server/rest/getStarred2.view\n\t\t Since 1.8.0\n\n\t\t Similar to getStarred, but organizes music according to ID3 tags.\n\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) Only return results from the music folder with the given ID. See getMusicFolders\n\n\t\t Returns a <subsonic-response> element with a nested <starred2> element on success.\n\n\t\t */\n\t\tconst rootID = (req.query.musicFolderId !== undefined ? req.query.musicFolderId.toString() : undefined);\n\t\tconst starred2: Subsonic.Starred2 = {};\n\t\tconst trackIDs = await this.engine.trackService.getFavedIDs({rootID}, req.user);\n\t\tif (trackIDs.length > 0) {\n\t\t\tconst tracks = await this.engine.store.trackStore.byIds(trackIDs);\n\t\t\tstarred2.song = await this.prepareTracks(tracks, req.user);\n\t\t}\n\t\tconst albumIDs = await this.engine.albumService.getFavedIDs({rootID}, req.user);\n\t\tif (albumIDs.length > 0) {\n\t\t\tconst albums = await this.engine.store.albumStore.byIds(albumIDs);\n\t\t\tstarred2.album = await this.prepareAlbums(albums, req.user);\n\t\t}\n\t\tconst artistIDs = await this.engine.artistService.getFavedIDs({rootID}, req.user);\n\t\tif (artistIDs.length > 0) {\n\t\t\tconst artists = await this.engine.store.artistStore.byIds(artistIDs);\n\t\t\tstarred2.artist = await this.prepareArtists(artists, req.user);\n\t\t}\n\t\treturn {starred2};\n\t}\n\n\tasync refreshPodcasts(req: ApiOptions<{}>): Promise<void> {\n\t\t/*\n\t\t refreshPodcasts\n\n\t\t http://your-server/rest/refreshPodcasts.view\n\t\t Since 1.9.0\n\n\t\t Requests the server to check for new Podcast episodes. Note: The user must be authorized for Podcast administration (see Settings > Users > user is allowed to administrate Podcasts).\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tthis.engine.podcastService.refreshPodcasts(); // do not wait\n\t}\n\n\tasync createPodcastChannel(req: ApiOptions<SubsonicParameters.PodcastChannel>): Promise<void> {\n\t\t/*\n\t\t createPodcastChannel\n\n\t\t http://your-server/rest/createPodcastChannel.view\n\t\t Since 1.9.0\n\n\t\t Adds a new Podcast channel. Note: The user must be authorized for Podcast administration (see Settings > Users > user is allowed to administrate Podcasts).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t url \tYes \t\tThe URL of the Podcast to add.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tawait this.engine.podcastService.create(req.query.url);\n\t}\n\n\tasync getPodcasts(req: ApiOptions<SubsonicParameters.PodcastChannels>): Promise<{ podcasts: Subsonic.Podcasts }> {\n\t\t/*\n\t\t getPodcasts\n\n\t\t http://your-server/rest/getPodcasts.view\n\t\t Since 1.6.0\n\n\t\t Returns all Podcast channels the server subscribes to, and (optionally) their episodes.\n\t\t This method can also be used to return details for only one channel - refer to the id parameter.\n\t\t A typical use case for this method would be to first retrieve all channels without episodes,\n\t\t and then retrieve all episodes for the single channel the user selects.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t includeEpisodes \tNo \ttrue \t(Since 1.9.0) Whether to include Podcast episodes in the returned result.\n\t\t id \tNo \t\t(Since 1.9.0) If specified, only return the Podcast channel with this ID.\n\n\t\t Returns a <subsonic-response> element with a nested <podcasts> element on success.\n\t\t */\n\n\t\tlet includeEpisodes = false;\n\t\tif (req.query.includeEpisodes !== undefined) {\n\t\t\tincludeEpisodes = req.query.includeEpisodes;\n\t\t}\n\t\tlet podcastList: Array<Podcast> = [];\n\t\tif (req.query.id) {\n\t\t\tconst podcast = await this.engine.store.podcastStore.byId(req.query.id);\n\t\t\tif (podcast) {\n\t\t\t\tpodcastList.push(podcast);\n\t\t\t} else {\n\t\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t\t}\n\t\t} else {\n\t\t\tpodcastList = await this.engine.store.podcastStore.all();\n\t\t}\n\t\tconst channel = podcastList.map(podcast => FORMAT.packPodcast(podcast, (this.engine.podcastService.isDownloading(podcast.id) ? PodcastStatus.downloading : undefined)));\n\t\tconst podcasts: Subsonic.Podcasts = {channel};\n\t\tif (includeEpisodes) {\n\t\t\tfor (const podcast of channel) {\n\t\t\t\tconst episodes = await this.engine.store.episodeStore.search({podcastID: podcast.id});\n\t\t\t\tpodcast.episode = await this.prepareEpisodes(episodes.sort((a, b) => (b.date || 0) - (a.date || 0)), req.user);\n\t\t\t}\n\t\t}\n\t\treturn {podcasts};\n\t}\n\n\tasync getNewestPodcasts(req: ApiOptions<SubsonicParameters.PodcastEpisodesNewest>): Promise<{ newestPodcasts: Subsonic.NewestPodcasts }> {\n\t\t/*\n\t\t http://your-server/rest/getNewestPodcasts Since 1.13.0\n\n\t\tReturns the most recently published Podcast episodes.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tcount \tNo \t20 \tThe maximum number of episodes to return.\n\n\t\tReturns a <subsonic-response> element with a nested <newestPodcasts> element on success.\n\t\t */\n\t\t// TODO: do this with a limit & sort db request\n\t\tlet episodes = await this.engine.store.episodeStore.all();\n\t\tepisodes = episodes.sort((a, b) => {\n\t\t\treturn (b.date || 0) - (a.date || 0);\n\t\t});\n\t\tconst newestPodcasts: Subsonic.NewestPodcasts = {};\n\t\tnewestPodcasts.episode = await this.prepareEpisodes(paginate(episodes, req.query.count || 20, 0), req.user);\n\t\treturn {newestPodcasts};\n\t}\n\n\tasync byID<T extends DBObject>(id: string, objstore: BaseStore<T, SearchQuery>): Promise<T> {\n\t\tconst item = await objstore.byId(id);\n\t\tif (!item) {\n\t\t\treturn Promise.reject({fail: FORMAT.FAIL.NOTFOUND});\n\t\t}\n\t\treturn item;\n\t}\n\n\tasync deletePodcastChannel(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t deletePodcastChannel\n\n\t\t http://your-server/rest/deletePodcastChannel.view\n\t\t Since 1.9.0\n\n\t\t Deletes a Podcast channel. Note: The user must be authorized for Podcast administration (see Settings > Users > user is allowed to administrate Podcasts).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe ID of the Podcast channel to delete.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst podcast = await this.byID<Podcast>(req.query.id, this.engine.store.podcastStore);\n\t\tawait this.engine.podcastService.remove(podcast);\n\t}\n\n\tasync downloadPodcastEpisode(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t downloadPodcastEpisode\n\n\t\t http://your-server/rest/downloadPodcastEpisode.view\n\t\t Since 1.9.0\n\n\t\t Request the server to start downloading a given Podcast episode. Note: The user must be authorized for Podcast administration (see Settings > Users > user is allowed to administrate Podcasts).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe ID of the Podcast episode to download.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\n\t\tconst episode = await this.byID<Episode>(req.query.id, this.engine.store.episodeStore);\n\t\tif (!episode.path) {\n\t\t\tthis.engine.episodeService.downloadEpisode(episode); // do not wait\n\t\t}\n\t}\n\n\tasync deletePodcastEpisode(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t deletePodcastEpisode\n\n\t\t http://your-server/rest/deletePodcastEpisode.view\n\t\t Since 1.9.0\n\n\t\t Deletes a Podcast episode. Note: The user must be authorized for Podcast administration (see Settings > Users > user is allowed to administrate Podcasts).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe ID of the Podcast episode to delete.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst episode = await this.byID<Episode>(req.query.id, this.engine.store.episodeStore);\n\t\tawait this.engine.episodeService.deleteEpisode(episode);\n\t}\n\n\tasync getBookmarks(req: ApiOptions<{}>): Promise<{ bookmarks: Subsonic.Bookmarks }> {\n\t\t/*\n\t\t getBookmarks\n\n\t\t http://your-server/rest/getBookmarks.view\n\t\t Since 1.9.0\n\n\t\t Returns all bookmarks for this user. A bookmark is a position within a certain media file.\n\n\t\t Returns a <subsonic-response> element with a nested <bookmarks> element on success.\n\t\t */\n\t\tconst bookmarklist = await this.engine.bookmarkService.getAll(req.user.id);\n\t\tconst bookmarks: Subsonic.Bookmarks = {};\n\t\tbookmarks.bookmark = await this.prepareBookmarks(bookmarklist, req.user);\n\t\treturn {bookmarks};\n\t}\n\n\tasync createBookmark(req: ApiOptions<SubsonicParameters.Bookmark>): Promise<void> {\n\t\t/*\n\t\t createBookmark\n\n\t\t http://your-server/rest/createBookmark.view\n\t\t Since 1.9.0\n\n\t\t Creates or updates a bookmark (a position within a media file). Bookmarks are personal and not visible to other users.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tID of the media file to bookmark. If a bookmark already exists for this file it will be overwritten.\n\t\t position \tYes \t\tThe position (in milliseconds) within the media file.\n\t\t comment \tNo \t\tA user-defined comment.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst track = await this.byID<Track>(req.query.id, this.engine.store.trackStore);\n\t\tawait this.engine.bookmarkService.create(track.id, req.user.id, req.query.position, req.query.comment);\n\t}\n\n\tasync deleteBookmark(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t deleteBookmark\n\n\t\t http://your-server/rest/deleteBookmark.view\n\t\t Since 1.9.0\n\n\t\t Deletes the bookmark for a given file.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tID of the media file for which to delete the bookmark. Other users' bookmarks are not affected.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tawait this.engine.bookmarkService.remove(req.query.id, req.user.id);\n\t}\n\n\tasync getRandomSongs(req: ApiOptions<SubsonicParameters.RandomSong>): Promise<{ randomSongs: Subsonic.Songs }> {\n\t\t/*\n\t\t getRandomSongs\n\n\t\t http://your-server/rest/getRandomSongs.view\n\t\t Since 1.2.0\n\n\t\t Returns random songs matching the given criteria.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t size \tNo \t10 \tThe maximum number of songs to return. Max 500.\n\t\t genre \tNo \t\tOnly returns songs belonging to this genre.\n\t\t fromYear \tNo \t\tOnly return songs published after or in this year.\n\t\t toYear \tNo \t\tOnly return songs published before or in this year.\n\t\t musicFolderId \tNo \t\tOnly return songs in the music folder with the given ID. See getMusicFolders.\n\n\t\t Returns a <subsonic-response> element with a nested <randomSongs> element on success.\n\t\t */\n\n\t\tconst amount = Math.min(req.query.size || 10, 500);\n\t\tconst query: SearchQueryTrack = {\n\t\t\tgenre: req.query.genre,\n\t\t\tfromYear: req.query.fromYear,\n\t\t\ttoYear: req.query.toYear,\n\t\t\trootID: req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined\n\t\t};\n\t\tconst randomSongs: Subsonic.Songs = {};\n\t\tconst trackids = await this.engine.store.trackStore.searchIDs(query);\n\t\tif (trackids.length > 0) {\n\t\t\tconst limit: Array<string> = randomItems(trackids, amount);\n\t\t\tconst tracks = await this.engine.store.trackStore.byIds(limit);\n\t\t\trandomSongs.song = await this.prepareTracks(tracks, req.user);\n\t\t}\n\t\treturn {randomSongs};\n\t}\n\n\tasync getSongsByGenre(req: ApiOptions<SubsonicParameters.SongsByGenre>): Promise<{ songsByGenre: Subsonic.Songs }> {\n\t\t/*\n\t\t getSongsByGenre\n\n\t\t http://your-server/rest/getSongsByGenre.view\n\t\t Since 1.9.0\n\n\t\t Returns songs in a given genre.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t genre \tYes \t\tThe genre, as returned by getGenres.\n\t\t count \tNo \t10 \tThe maximum number of songs to return. Max 500.\n\t\t offset \tNo \t0 \tThe offset. Useful if you want to page through the songs in a genre.\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) Only return albums in the music folder with the given ID. See getMusicFolders\n\n\t\t Returns a <subsonic-response> element with a nested <songsByGenre> element on success.\n\t\t */\n\t\tconst songsByGenre: Subsonic.Songs = {};\n\t\tconst tracklist = await this.engine.store.trackStore.searchIDs({genre: req.query.genre, rootID: req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined});\n\t\tconst limit = paginate(tracklist, req.query.count || 10, req.query.offset || 0);\n\t\tconst tracks = await this.engine.store.trackStore.byIds(limit);\n\t\tsongsByGenre.song = await this.prepareTracks(tracks, req.user);\n\t\treturn {songsByGenre};\n\t}\n\n\tasync search(req: ApiOptions<SubsonicParameters.Search>): Promise<{ searchResult: Subsonic.SearchResult }> {\n\t\t/*\n\t\t search\n\n\t\t http://your-server/rest/search.view\n\t\t Since 1.0.0\n\t\t Deprecated since 1.4.0, use search2 instead.\n\n\t\t Returns a listing of files matching the given search criteria. Supports paging through the result.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t artist \tNo \t\tArtist to search for.\n\t\t album \tNo \t\tAlbum to search for.\n\t\t title \tNo \t\tSong title to search for.\n\t\t any \tNo \t\tSearches all fields.\n\t\t count \tNo \t20 \tMaximum number of results to return.\n\t\t offset \tNo \t0 \tSearch result offset. Used for paging.\n\t\t newerThan \tNo \t\tOnly return matches that are newer than this. Given as milliseconds since 1970.\n\n\t\t Returns a <subsonic-response> element with a nested <searchResult> element on success.\n\t\t */\n\t\tif (req.query.any) {\n\t\t\treq.query.artist = req.query.any;\n\t\t\treq.query.album = req.query.any;\n\t\t\treq.query.title = req.query.any;\n\t\t}\n\t\tlet list = await this.engine.store.trackStore.searchIDs({\n\t\t\tartist: req.query.artist,\n\t\t\talbum: req.query.album,\n\t\t\ttitle: req.query.title,\n\t\t\tnewerThan: req.query.newerThan\n\t\t});\n\t\tconst searchResult: Subsonic.SearchResult = {offset: req.query.offset || 0, totalHits: list.length};\n\t\tlist = paginate(list, req.query.count || 20, req.query.offset || 0);\n\t\tconst tracks = await this.engine.store.trackStore.byIds(list);\n\t\tsearchResult.match = await this.prepareTracks(tracks, req.user);\n\t\treturn {searchResult};\n\t}\n\n\tasync search2(req: ApiOptions<SubsonicParameters.Search2>): Promise<{ searchResult2: Subsonic.SearchResult2 }> {\n\t\t/*\n\t\t search2\n\n\t\t http://your-server/rest/search2.view\n\t\t Since 1.4.0\n\n\t\t Returns albums, artists and songs matching the given search criteria. Supports paging through the result.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t query \tYes \t\tSearch query.\n\t\t artistCount \tNo \t20 \tMaximum number of artists to return.\n\t\t artistOffset \tNo \t0 \tSearch result offset for artists. Used for paging.\n\t\t albumCount \tNo \t20 \tMaximum number of albums to return.\n\t\t albumOffset \tNo \t0 \tSearch result offset for albums. Used for paging.\n\t\t songCount \tNo \t20 \tMaximum number of songs to return.\n\t\t songOffset \tNo \t0 \tSearch result offset for songs. Used for paging.\n\t\t musicFolderId \tNo \t\t(Since 1.12.0) Only return results from the music folder with the given ID. See getMusicFolders\n\n\t\t Returns a <subsonic-response> element with a nested <searchResult2> element on success.\n\t\t */\n\n\t\tconst searchResult2: Subsonic.SearchResult2 = {};\n\t\tconst rootID = req.query.musicFolderId ? req.query.musicFolderId.toString() : undefined;\n\t\tconst tracklist = await this.engine.store.trackStore.searchIDs({query: req.query.query, rootID});\n\t\tif (tracklist.length > 0) {\n\t\t\tconst limit = paginate(tracklist, req.query.songCount || 20, req.query.songOffset || 0);\n\t\t\tconst tracks = await this.engine.store.trackStore.byIds(limit);\n\t\t\tsearchResult2.song = await this.prepareTracks(tracks, req.user);\n\t\t}\n\t\tconst folderlist = await this.engine.store.folderStore.search({query: req.query.query, rootID});\n\t\tif (folderlist.length > 0) {\n\t\t\tconst states = await this.engine.stateService.findOrCreateMany(folderlist.map(f => f.id), req.user.id, DBObjectType.folder);\n\t\t\tconst artists: Array<Subsonic.Artist> = [];\n\t\t\tconst albums: Array<Subsonic.Child> = [];\n\t\t\tfolderlist.forEach(folder => {\n\t\t\t\tif (folder.tag.type === FolderType.artist) {\n\t\t\t\t\tartists.push(FORMAT.packFolderArtist(folder, states[folder.id]));\n\t\t\t\t} else {\n\t\t\t\t\talbums.push(FORMAT.packFolder(folder, states[folder.id]));\n\t\t\t\t}\n\t\t\t});\n\t\t\tsearchResult2.artist = paginate(artists, req.query.artistCount || 20, req.query.artistOffset || 0);\n\t\t\tsearchResult2.album = paginate(albums, req.query.albumCount || 20, req.query.albumOffset || 0);\n\t\t}\n\t\treturn {searchResult2};\n\t}\n\n\tasync search3(req: ApiOptions<SubsonicParameters.Search2>): Promise<{ searchResult3: Subsonic.SearchResult3 }> {\n\t\t/*\n\t\t search3\n\n\t\t http://your-server/rest/search3.view\n\t\t Since 1.8.0\n\n\t\t Similar to search2, but organizes music according to ID3 tags.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t query \tYes \t\tSearch query.\n\t\t artistCount \tNo \t20 \tMaximum number of artists to return.\n\t\t artistOffset \tNo \t0 \tSearch result offset for artists. Used for paging.\n\t\t albumCount \tNo \t20 \tMaximum number of albums to return.\n\t\t albumOffset \tNo \t0 \tSearch result offset for albums. Used for paging.\n\t\t songCount \tNo \t20 \tMaximum number of songs to return.\n\t\t songOffset \tNo \t0 \tSearch result offset for songs. Used for paging.\n\n\t\t Returns a <subsonic-response> element with a nested <searchResult3> element on success.\n\t\t */\n\n\t\tconst searchResult3: Subsonic.SearchResult3 = {};\n\t\tconst tracklist = await this.engine.store.trackStore.searchIDs({query: req.query.query});\n\t\tif (tracklist.length > 0) {\n\t\t\tconst limit = paginate(tracklist, req.query.songCount || 20, req.query.songOffset || 0);\n\t\t\tconst tracks = await this.engine.store.trackStore.byIds(limit);\n\t\t\tsearchResult3.song = await this.prepareTracks(tracks, req.user);\n\t\t}\n\t\tconst albumlist = await this.engine.store.albumStore.searchIDs({query: req.query.query});\n\t\tif (albumlist.length > 0) {\n\t\t\tconst limit = paginate(albumlist, req.query.albumCount || 20, req.query.albumOffset || 0);\n\t\t\tconst albums = await this.engine.store.albumStore.byIds(limit);\n\t\t\tsearchResult3.album = await this.prepareAlbums(albums, req.user);\n\t\t}\n\t\tconst artistlist = await this.engine.store.artistStore.searchIDs({query: req.query.query});\n\t\tif (artistlist.length > 0) {\n\t\t\tconst limit = paginate(artistlist, req.query.artistCount || 20, req.query.artistOffset || 0);\n\t\t\tconst artists = await this.engine.store.artistStore.byIds(limit);\n\t\t\tsearchResult3.artist = await this.prepareArtists(artists, req.user);\n\t\t}\n\t\treturn {searchResult3};\n\t}\n\n\tasync getScanStatus(req: ApiOptions<{}>): Promise<{ scanStatus: Subsonic.ScanStatus }> {\n\t\t/*\n\t\thttp://your-server/rest/getScanStatus Since 1.15.0\n\n\t\tReturns the current status for media library scanning. Takes no extra parameters.\n\n\t\tReturns a <subsonic-response> element with a nested <scanStatus> element on success.\n\t\t */\n\t\treturn {scanStatus: this.engine.ioService.getScanStatus()};\n\t}\n\n\tasync startScan(req: ApiOptions<{}>): Promise<void> {\n\t\t/*\n\t\thttp://your-server/rest/startScan Since 1.15.0\n\n\t\tInitiates a rescan of the media libraries. Takes no extra parameters.\n\n\t\tReturns a <subsonic-response> element with a nested <scanStatus> element on success.\n\t\t */\n\t\tthis.engine.ioService.refresh();\n\t}\n\n\tasync getArtist(req: ApiOptions<SubsonicParameters.ID>): Promise<{ artist: Subsonic.ArtistWithAlbumsID3 }> {\n\t\t/*\n\t\t getArtist\n\n\t\t http://your-server/rest/getArtist.view\n\t\t Since 1.8.0\n\n\t\t Returns details for an artist, including a list of albums. This method organizes music according to ID3 tags.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe artist ID.\n\n\t\t Returns a <subsonic-response> element with a nested <artist> element on success.\n\t\t */\n\t\tconst artist = await this.byID<Artist>(req.query.id, this.engine.store.artistStore);\n\t\tconst albumlist = await this.engine.store.albumStore.search({artistID: artist.id});\n\t\talbumlist.sort((a, b) => {\n\t\t\treturn (a.year || 0) - (b.year || 0);\n\t\t});\n\t\tconst state = await this.engine.stateService.findOrCreate(artist.id, req.user.id, DBObjectType.artist);\n\t\tconst states = await this.engine.stateService.findOrCreateMany(albumlist.map(a => a.id), req.user.id, DBObjectType.album);\n\t\tconst artistid3 = <Subsonic.ArtistWithAlbumsID3>FORMAT.packArtist(artist, state);\n\t\tartistid3.album = albumlist.map(a => FORMAT.packAlbum(a, states[a.id]));\n\t\treturn {artist: artistid3};\n\t}\n\n\tasync getAlbum(req: ApiOptions<SubsonicParameters.ID>): Promise<{ album: Subsonic.AlbumWithSongsID3 }> {\n\t\t/*\n\t\t getAlbum\n\n\t\t http://your-server/rest/getAlbum.view\n\t\t Since 1.8.0\n\n\t\t Returns details for an album, including a list of songs. This method organizes music according to ID3 tags.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tThe album ID.\n\n\t\t Returns a <subsonic-response> element with a nested <album> element on success.\n\t\t */\n\t\tconst album = await this.byID<Album>(req.query.id, this.engine.store.albumStore);\n\t\tconst tracks = await this.engine.store.trackStore.byIds(album.trackIDs);\n\t\tconst state = await this.engine.stateService.findOrCreate(album.id, req.user.id, DBObjectType.album);\n\t\ttracks.sort((a, b) => {\n\t\t\treturn (a.tag.track || 0) - (b.tag.track || 0);\n\t\t});\n\t\tconst childs = await this.prepareTracks(tracks, req.user);\n\t\tconst albumid3 = <Subsonic.AlbumWithSongsID3>FORMAT.packAlbum(album, state);\n\t\talbumid3.song = childs;\n\t\treturn {album: albumid3};\n\t}\n\n\tasync getLyrics(req: ApiOptions<SubsonicParameters.Lyrics>): Promise<{ lyrics: Subsonic.Lyrics }> {\n\t\t/*\n\t\t getLyrics\n\n\t\t http://your-server/rest/getLyrics.view\n\t\t Since 1.2.0\n\n\t\t Searches for and returns lyrics for a given song.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t artist \tNo \t\tThe artist name.\n\t\t title \tNo \t\tThe song title.\n\n\t\t Returns a <subsonic-response> element with a nested <lyrics> element on success. The <lyrics> element is empty if no matching lyrics was found.\n\t\t */\n\t\tif (!req.query.artist || !req.query.title) {\n\t\t\treturn {lyrics: {content: ''}};\n\t\t}\n\t\tconst lyrics = await this.engine.audioModule.getLyrics(req.query.artist, req.query.title);\n\t\tif (!lyrics) {\n\t\t\treturn {lyrics: {content: ''}};\n\t\t}\n\t\treturn {lyrics: {artist: lyrics.artist, title: lyrics.song, content: lyrics.lyric.replace(/\\r\\n/g, '\\n')}};\n\t}\n\n\tasync getPlayQueue(req: ApiOptions<{}>): Promise<{ playQueue: Subsonic.PlayQueue }> {\n\t\t/*\n\t\t http://your-server/rest/getPlayQueue Since 1.12.0\n\n\t\tReturns the state of the play queue for this user (as set by savePlayQueue).\n\t\tThis includes the tracks in the play queue, the currently playing track, and the position within this track.\n\t\t Typically used to allow a user to move between different clients/apps while retaining the same play queue\n\t\t (for instance when listening to an audio book).\n\n\t\tReturns a <subsonic-response> element with a nested <playQueue> element on success,\n\t\tor an empty <subsonic-response> if no play queue has been saved.\n\t\t */\n\t\tconst playqueue = await this.engine.playQueueService.get(req.user.id);\n\t\tif (!playqueue) {\n\t\t\tconst empty: any = {};\n\t\t\treturn empty;\n\t\t}\n\t\tconst tracks = await this.engine.store.trackStore.byIds(playqueue.trackIDs);\n\t\tconst childs = await this.prepareTracks(tracks, req.user);\n\t\treturn {playQueue: FORMAT.packPlayQueue(playqueue, req.user, childs)};\n\t}\n\n\tasync savePlayQueue(req: ApiOptions<SubsonicParameters.PlayQueue>): Promise<void> {\n\t\t/*\n\t\t http://your-server/rest/savePlayQueue Since 1.12.0\n\n\t\tSaves the state of the play queue for this user. This includes the tracks in the play queue,\n\t\tthe currently playing track, and the position within this track. Typically used to allow a user to move between different clients/apps\n\t\twhile retaining the same play queue (for instance when listening to an audio book).\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tID of a song in the play queue. Use one id parameter for each song in the play queue.\n\t\tcurrent \tNo \t\tThe ID of the current playing song.\n\t\tposition \tNo \t\tThe position in milliseconds within the currently playing song.\n\n\t\tReturns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst ids: Array<string> = req.query.id ? (Array.isArray(req.query.id) ? req.query.id : [req.query.id]) : [];\n\t\tawait this.engine.playQueueService.save(req.user.id, ids, req.query.current, req.query.position, req.client);\n\t}\n\n\tasync deleteInternetRadioStation(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\tdeleteInternetRadioStation\n\n\t\thttp://your-server/rest/deleteInternetRadioStation Since 1.16.0\n\n\t\tDeletes an existing internet radio station. Only users with admin privileges are allowed to call this method.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe ID for the station.\n\n\t\tReturns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst radio = await this.byID(req.query.id, await this.engine.store.radioStore);\n\t\tawait this.engine.store.radioStore.remove(radio.id);\n\t}\n\n\tasync createInternetRadioStation(req: ApiOptions<SubsonicParameters.InternetRadioCreate>): Promise<void> {\n\t\t/*\n\t\tcreateInternetRadioStation\n\n\t\thttp://your-server/rest/createInternetRadioStation Since 1.16.0\n\n\t\tAdds a new internet radio station. Only users with admin privileges are allowed to call this method.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tstreamUrl \tYes \t\tThe stream URL for the station.\n\t\tname \tYes \t\tThe user-defined name for the station.\n\t\thomepageUrl \tNo \t\tThe home page URL for the station.\n\n\t\tReturns an empty <subsonic-response> element on success.\n\t\t */\n\t\tawait this.engine.radioService.create(req.query.name, req.query.streamUrl, req.query.homepageUrl);\n\t}\n\n\tasync updateInternetRadioStation(req: ApiOptions<SubsonicParameters.InternetRadioUpdate>): Promise<void> {\n\t\t/*\n\t\tupdateInternetRadioStation\n\n\t\thttp://your-server/rest/updateInternetRadioStation Since 1.16.0\n\n\t\tUpdates an existing internet radio station. Only users with admin privileges are allowed to call this method.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe ID for the station.\n\t\tstreamUrl \tYes \t\tThe stream URL for the station.\n\t\tname \tYes \t\tThe user-defined name for the station.\n\t\thomepageUrl \tNo \t\tThe home page URL for the station.\n\n\t\tReturns an empty <subsonic-response> element on success.\n\t\t */\n\t\tconst radio = await this.byID(req.query.id, await this.engine.store.radioStore);\n\t\tawait this.engine.radioService.update(radio, req.query.name, req.query.streamUrl, req.query.homepageUrl);\n\t}\n\n\tasync getInternetRadioStations(req: ApiOptions<{}>): Promise<{ internetRadioStations: Subsonic.InternetRadioStations }> {\n\t\t/*\n\t\t getInternetRadioStations\n\n\t\t http://your-server/rest/getInternetRadioStations.view\n\t\t Since 1.9.0\n\n\t\t Returns all internet radio stations. Takes no extra parameters.\n\n\t\t Returns a <subsonic-response> element with a nested <internetRadioStations> element on success.\n\t\t */\n\t\tconst radios = await this.engine.store.radioStore.all();\n\t\treturn {internetRadioStations: {internetRadioStation: radios.filter(radio => !radio.disabled).map(radio => FORMAT.packRadio(radio))}};\n\t}\n\n\t/* Maybe implement someday? */\n\n\tasync getVideos(req: ApiOptions<{}>): Promise<{ videos: Subsonic.Videos }> {\n\t\t/*\n\t\t getVideos\n\n\t\t http://your-server/rest/getVideos.view\n\t\t Since 1.8.0\n\n\t\t Returns all video files.\n\n\t\t Returns a <subsonic-response> element with a nested <videos> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {videos: {}};\n\t}\n\n\tasync getVideoInfo(req: ApiOptions<SubsonicParameters.ID>): Promise<{ videoInfo: Subsonic.VideoInfo }> {\n\t\t/*.\n\t\t http://your-server/rest/getVideoInfo Since 1.14.0\n\n\t\tReturns details for a video, including information about available audio tracks, subtitles (captions) and conversions.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe video ID.\n\n\t\tReturns a <subsonic-response> element with a nested <videoInfo> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {videoInfo: {id: ''}};\n\t}\n\n\tasync getCaptions(req: ApiOptions<SubsonicParameters.Captions>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t http://your-server/rest/getCaptions Since 1.14.0\n\n\t\tReturns captions (subtitles) for a video. Use getVideoInfo to get a list of available captions.\n\t\tParameter \tRequired \tDefault \tComment\n\t\tid \tYes \t\tThe ID of the video.\n\t\tformat \tNo \t\tPreferred captions format (\"srt\" or \"vtt\").\n\n\t\tReturns the raw video captions.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {};\n\t}\n\n\tasync scrobble(req: ApiOptions<SubsonicParameters.Scrobble>): Promise<void> {\n\t\t/*\n\t\t scrobble\n\n\t\t http://your-server/rest/scrobble.view\n\t\t Since 1.5.0\n\n\t\t Registers the local playback of one or more media files. Typically used when playing media that is cached on the client. This operation includes the following:\n\n\t\t\t\"Scrobbles\" the media files on last.fm if the user has configured his/her last.fm credentials on the Subsonic server (Settings > Personal).\n\t\t\tUpdates the play count and last played timestamp for the media files. (Since 1.11.0)\n\t\t\tMakes the media files appear in the \"Now playing\" page in the web app, and appear in the list of songs returned by getNowPlaying (Since 1.11.0)\n\n\t\t Since 1.8.0 you may specify multiple id (and optionally time) parameters to scrobble multiple files.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the file to scrobble.\n\t\t time \tNo \t\t(Since 1.8.0) The time (in milliseconds since 1 Jan 1970) at which the song was listened to.\n\t\t submission \tNo \tTrue \tWhether this is a \"submission\" or a \"now playing\" notification.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t}\n\n\tasync getShares(req: ApiOptions<{}>): Promise<{ shares: Subsonic.Shares }> {\n\t\t/*\n\t\t getShares\n\n\t\t http://your-server/rest/getShares.view\n\t\t Since 1.6.0\n\n\t\t Returns information about shared media this user is allowed to manage. Takes no extra parameters.\n\n\t\t Returns a <subsonic-response> element with a nested <shares> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {shares: {}};\n\t}\n\n\tasync createShare(req: ApiOptions<SubsonicParameters.Share>): Promise<void> {\n\t\t/*\n\t\t createShare\n\n\t\t http://your-server/rest/createShare.view\n\t\t Since 1.6.0\n\n\t\t Creates a public URL that can be used by anyone to stream music or video from the Subsonic server.\n\t\t The URL is short and suitable for posting on Facebook, Twitter etc. Note: The user must be authorized to share (see Settings > Users > user is allowed to share files with anyone).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tID of a song, album or video to share. Use one id parameter for each entry to share.\n\t\t description \tNo \t\tA user-defined description that will be displayed to people visiting the shared media.\n\t\t expires \tNo \t\tThe time at which the share expires. Given as milliseconds since 1970.\n\n\t\t Returns a <subsonic-response> element with a nested <shares> element on success, which in turns contains a single <share> element for the newly created share.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t}\n\n\tasync updateShare(req: ApiOptions<SubsonicParameters.Share>): Promise<void> {\n\t\t/*\n\t\t updateShare\n\n\t\t http://your-server/rest/updateShare.view\n\t\t Since 1.6.0\n\n\t\t Updates the description and/or expiration date for an existing share.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tID of the share to update.\n\t\t description \tNo \t\tA user-defined description that will be displayed to people visiting the shared media.\n\t\t expires \tNo \t\tThe time at which the share expires. Given as milliseconds since 1970, or zero to remove the expiration.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t}\n\n\tasync deleteShare(req: ApiOptions<SubsonicParameters.ID>): Promise<void> {\n\t\t/*\n\t\t deleteShare\n\n\t\t http://your-server/rest/deleteShare.view\n\t\t Since 1.6.0\n\n\t\t Deletes an existing share.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tID of the share to delete.\n\n\t\t Returns an empty <subsonic-response> element on success.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t}\n\n\tasync hls(req: ApiOptions<SubsonicParameters.HLS>): Promise<IApiBinaryResult> {\n\t\t/*\n\t\t hls\n\n\t\t http://your-server/rest/hls.m3u8\n\t\t Since 1.8.0\n\n\t\t Creates an HLS (HTTP Live Streaming) playlist used for streaming video or audio. HLS is a streaming protocol implemented by Apple and works by breaking the overall stream\n\t\t into a sequence of small HTTP-based file downloads. It's supported by iOS and newer versions of Android.\n\t\t This method also supports adaptive bitrate streaming, see the bitRate parameter.\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t id \tYes \t\tA string which uniquely identifies the media file to stream.\n\t\t bitRate \tNo \t\tIf specified, the server will attempt to limit the bitrate to this value, in kilobits per second. If this parameter is specified more than once,\n\t\t the server will create a variant playlist, suitable for adaptive bitrate streaming. The playlist will support streaming at all the specified bitrates.\n\t\t The server will automatically choose video dimensions that are suitable for the given bitrates. Since 1.9.0 you may explicitly request a certain width (480)\n\t\t  and height (360) like so: bitRate=1000@480x360\n\n\t\t Returns an M3U8 playlist on success (content type \"application/vnd.apple.mpegurl\"), or an XML document on error (in which case the HTTP content type will start with \"text/xml\").\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {};\n\t}\n\n\tasync jukeboxControl(req: ApiOptions<SubsonicParameters.Jukebox>): Promise<{ jukeboxStatus: Subsonic.JukeboxStatus }> {\n\t\t/*\n\t\t jukeboxControl\n\n\t\t http://your-server/rest/jukeboxControl.view\n\t\t Since 1.2.0\n\n\t\t Controls the jukebox, i.e., playback directly on the server's audio hardware. Note: The user must be authorized to control the jukebox (see Settings > Users > user is allowed to play files in jukebox mode).\n\t\t Parameter \tRequired \tDefault \tComment\n\t\t action \tYes \t\tThe operation to perform. Must be one of: get, status (since 1.7.0), set (since 1.7.0), start, stop, skip, add, clear, remove, shuffle, setGain\n\t\t index \tNo \t\tUsed by skip and remove. Zero-based index of the song to skip to or remove.\n\t\t offset \tNo \t\t(Since 1.7.0) Used by skip. Start playing this many seconds into the track.\n\t\t id \tNo \t\tUsed by add and set. ID of song to add to the jukebox playlist. Use multiple id parameters to add many songs in the same request. (set is similar to a clear followed by a add, but will not change the currently playing track.)\n\t\t gain \tNo \t\tUsed by setGain to control the playback volume. A float value between 0.0 and 1.0.\n\n\t\t Returns a <jukeboxStatus> element on success, unless the get action is used, in which case a nested <jukeboxPlaylist> element is returned.\n\t\t */\n\t\tPromise.reject('not implemented');\n\t\treturn {jukeboxStatus: {currentIndex: 0, playing: false, gain: 0}};\n\t}\n\n}\n\n","import {Subsonic} from '../../model/subsonic-rest-data';\nimport {SubsonicParameters} from '../../model/subsonic-rest-params';\nimport {ApiOptions, SubsonicApi} from './api';\nimport {ApiResponder} from './response';\nimport express from 'express';\nimport {IApiBinaryResult} from '../../typings';\nimport {apiCheck} from './check';\n\nexport interface SubsonicRolesHandler {\n\tpodcast: express.RequestHandler;\n\tshare: express.RequestHandler;\n\tadmin: express.RequestHandler;\n\tjukebox: express.RequestHandler;\n}\n\nexport function registerApi(router: express.Router, api: SubsonicApi, roles: SubsonicRolesHandler): void {\n\trouter.all('/addChatMessage.view', apiCheck('/addChatMessage.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ChatMessage> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.addChatMessage(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/changePassword.view', apiCheck('/changePassword.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ChangePassword> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.changePassword(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createBookmark.view', apiCheck('/createBookmark.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Bookmark> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.createBookmark(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createPlaylist.view', apiCheck('/createPlaylist.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PlaylistCreate> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { playlist: Subsonic.PlaylistWithSongs } = await api.createPlaylist(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createPodcastChannel.view', roles.podcast, apiCheck('/createPodcastChannel.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PodcastChannel> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.createPodcastChannel(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createShare.view', roles.share, apiCheck('/createShare.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Share> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.createShare(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createUser.view', roles.admin, apiCheck('/createUser.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.CreateUser> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.createUser(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deleteBookmark.view', apiCheck('/deleteBookmark.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deleteBookmark(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deleteInternetRadioStation.view', roles.admin, apiCheck('/deleteInternetRadioStation.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deleteInternetRadioStation(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deletePlaylist.view', apiCheck('/deletePlaylist.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deletePlaylist(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deletePodcastChannel.view', roles.podcast, apiCheck('/deletePodcastChannel.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deletePodcastChannel(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deletePodcastEpisode.view', roles.podcast, apiCheck('/deletePodcastEpisode.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deletePodcastEpisode(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deleteShare.view', apiCheck('/deleteShare.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deleteShare(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/deleteUser.view', roles.admin, apiCheck('/deleteUser.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Username> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.deleteUser(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/downloadPodcastEpisode.view', roles.podcast, apiCheck('/downloadPodcastEpisode.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.downloadPodcastEpisode(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAlbum.view', apiCheck('/getAlbum.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { album: Subsonic.AlbumWithSongsID3 } = await api.getAlbum(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAlbumInfo.view', apiCheck('/getAlbumInfo.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { albumInfo: Subsonic.AlbumInfo } = await api.getAlbumInfo(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAlbumInfo2.view', apiCheck('/getAlbumInfo2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { albumInfo: Subsonic.AlbumInfo } = await api.getAlbumInfo2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAlbumList.view', apiCheck('/getAlbumList.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.AlbumList> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { albumList: Subsonic.AlbumList } = await api.getAlbumList(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAlbumList2.view', apiCheck('/getAlbumList2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.AlbumList2> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { albumList2: Subsonic.AlbumList2 } = await api.getAlbumList2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getArtist.view', apiCheck('/getArtist.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { artist: Subsonic.ArtistWithAlbumsID3 } = await api.getArtist(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getArtistInfo.view', apiCheck('/getArtistInfo.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ArtistInfo> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { artistInfo: Subsonic.ArtistInfo } = await api.getArtistInfo(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getArtistInfo2.view', apiCheck('/getArtistInfo2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ArtistInfo> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { artistInfo2: Subsonic.ArtistInfo2 } = await api.getArtistInfo2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getArtists.view', apiCheck('/getArtists.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.MusicFolderID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { artists: Subsonic.ArtistsID3 } = await api.getArtists(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getBookmarks.view', apiCheck('/getBookmarks.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { bookmarks: Subsonic.Bookmarks } = await api.getBookmarks(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getChatMessages.view', apiCheck('/getChatMessages.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ChatMessages> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { chatMessages: Subsonic.ChatMessages } = await api.getChatMessages(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getGenres.view', apiCheck('/getGenres.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { genres: Subsonic.Genres } = await api.getGenres(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getIndexes.view', apiCheck('/getIndexes.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Indexes> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { indexes: Subsonic.Indexes } = await api.getIndexes(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getInternetRadioStations.view', apiCheck('/getInternetRadioStations.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { internetRadioStations: Subsonic.InternetRadioStations } = await api.getInternetRadioStations(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/createInternetRadioStation.view', roles.admin, apiCheck('/createInternetRadioStation.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.InternetRadioCreate> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.createInternetRadioStation(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/updateInternetRadioStation.view', roles.admin, apiCheck('/updateInternetRadioStation.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.InternetRadioUpdate> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.updateInternetRadioStation(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getLicense.view', apiCheck('/getLicense.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { license: Subsonic.License } = await api.getLicense(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getLyrics.view', apiCheck('/getLyrics.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Lyrics> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { lyrics: Subsonic.Lyrics } = await api.getLyrics(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getMusicDirectory.view', apiCheck('/getMusicDirectory.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { directory: Subsonic.Directory } = await api.getMusicDirectory(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getMusicFolders.view', apiCheck('/getMusicFolders.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { musicFolders: Subsonic.MusicFolders } = await api.getMusicFolders(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getNewestPodcasts.view', apiCheck('/getNewestPodcasts.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PodcastEpisodesNewest> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { newestPodcasts: Subsonic.NewestPodcasts } = await api.getNewestPodcasts(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getNowPlaying.view', apiCheck('/getNowPlaying.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { nowPlaying: Subsonic.NowPlaying } = await api.getNowPlaying(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getPlaylist.view', apiCheck('/getPlaylist.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { playlist: Subsonic.PlaylistWithSongs } = await api.getPlaylist(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getPlaylists.view', apiCheck('/getPlaylists.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Playlists> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { playlists: Subsonic.Playlists } = await api.getPlaylists(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getPlayQueue.view', apiCheck('/getPlayQueue.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { playQueue: Subsonic.PlayQueue } = await api.getPlayQueue(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getPodcasts.view', apiCheck('/getPodcasts.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PodcastChannels> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { podcasts: Subsonic.Podcasts } = await api.getPodcasts(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getRandomSongs.view', apiCheck('/getRandomSongs.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.RandomSong> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { randomSongs: Subsonic.Songs } = await api.getRandomSongs(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getScanStatus.view', apiCheck('/getScanStatus.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { scanStatus: Subsonic.ScanStatus } = await api.getScanStatus(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/startScan.view', apiCheck('/startScan.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.startScan(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getShares.view', apiCheck('/getShares.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { shares: Subsonic.Shares } = await api.getShares(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getSimilarSongs.view', apiCheck('/getSimilarSongs.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.SimilarSongs> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { similarSongs: Subsonic.SimilarSongs } = await api.getSimilarSongs(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getSimilarSongs2.view', apiCheck('/getSimilarSongs2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.SimilarSongs> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { similarSongs2: Subsonic.SimilarSongs2 } = await api.getSimilarSongs2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getSong.view', apiCheck('/getSong.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { song: Subsonic.Child } = await api.getSong(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getSongsByGenre.view', apiCheck('/getSongsByGenre.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.SongsByGenre> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { songsByGenre: Subsonic.Songs } = await api.getSongsByGenre(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getStarred.view', apiCheck('/getStarred.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.MusicFolderID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { starred: Subsonic.Starred } = await api.getStarred(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getStarred2.view', apiCheck('/getStarred2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.MusicFolderID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { starred2: Subsonic.Starred2 } = await api.getStarred2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getTopSongs.view', apiCheck('/getTopSongs.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.TopSongs> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { topSongs: Subsonic.TopSongs } = await api.getTopSongs(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getUser.view', apiCheck('/getUser.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Username> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { user: Subsonic.User } = await api.getUser(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getUsers.view', roles.admin, apiCheck('/getUsers.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { users: Subsonic.Users } = await api.getUsers(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getVideoInfo.view', apiCheck('/getVideoInfo.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.ID> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { videoInfo: Subsonic.VideoInfo } = await api.getVideoInfo(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getVideos.view', apiCheck('/getVideos.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { videos: Subsonic.Videos } = await api.getVideos(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/jukeboxControl.view', roles.jukebox, apiCheck('/jukeboxControl.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Jukebox> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { jukeboxStatus: Subsonic.JukeboxStatus } = await api.jukeboxControl(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/ping.view', apiCheck('/ping.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.ping(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/refreshPodcasts.view', roles.podcast, apiCheck('/refreshPodcasts.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<{}> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.refreshPodcasts(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/savePlayQueue.view', apiCheck('/savePlayQueue.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PlayQueue> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.savePlayQueue(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/scrobble.view', apiCheck('/scrobble.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Scrobble> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.scrobble(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/search.view', apiCheck('/search.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Search> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { searchResult: Subsonic.SearchResult } = await api.search(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/search2.view', apiCheck('/search2.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Search2> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { searchResult2: Subsonic.SearchResult2 } = await api.search2(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/search3.view', apiCheck('/search3.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Search2> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: { searchResult3: Subsonic.SearchResult3 } = await api.search3(options);\n\t\t\tawait ApiResponder.data(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/setRating.view', apiCheck('/setRating.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Rate> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.setRating(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/star.view', apiCheck('/star.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.State> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.star(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/unstar.view', apiCheck('/unstar.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.State> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.unstar(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/updatePlaylist.view', apiCheck('/updatePlaylist.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.PlaylistUpdate> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.updatePlaylist(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/updateShare.view', apiCheck('/updateShare.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Share> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.updateShare(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/updateUser.view', roles.admin, apiCheck('/updateUser.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.UpdateUser> = {query: req.query, user: req.user, client: req.client};\n\t\t\tawait api.updateUser(options);\n\t\t\tawait ApiResponder.ok(req, res);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getAvatar.view', apiCheck('/getAvatar.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Username> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.getAvatar(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getCaptions.view', apiCheck('/getCaptions.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Captions> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.getCaptions(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/getCoverArt.view', apiCheck('/getCoverArt.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.CoverArt> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.getCoverArt(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/hls.view', apiCheck('/hls.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.HLS> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.hls(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/stream.view', apiCheck('/stream.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Stream> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.stream(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n\n\trouter.all('/download.view', apiCheck('/download.view'), async (req, res) => {\n\t\ttry {\n\t\t\tconst options: ApiOptions<SubsonicParameters.Download> = {query: req.query, user: req.user, client: req.client};\n\t\t\tconst result: IApiBinaryResult = await api.download(options);\n\t\t\tawait ApiResponder.binary(req, res, result);\n\t\t} catch (e) {\n\t\t\tawait ApiResponder.error(req, res, e);\n\t\t}\n\t});\n}\n","import express from 'express';\nimport {checkOpenApiParameters} from '../../utils/openapi-parameters-check';\nimport {ApiResponder} from './response';\nimport {FORMAT} from './format';\nimport {OpenAPIObject} from '../../model/openapi-spec';\n\nconst SubsonicApiSchema = require('../../model/subsonic-rest-api.schema.json');\nconst openapi: OpenAPIObject = require('../../model/subsonic-openapi.json');\n\nexport function apiCheck(name: string): express.RequestHandler {\n\tfunction CheckApiParametersHandler(req: express.Request, res: express.Response, next: express.NextFunction) {\n\t\tcheckOpenApiParameters(name, req, openapi, SubsonicApiSchema, 'get').then(() => {\n\t\t\tnext();\n\t\t}).catch((e) => {\n\t\t\tApiResponder.error(req, res, {fail: FORMAT.FAIL.PARAMETER, text: e.toString()});\n\t\t});\n\t}\n\treturn CheckApiParametersHandler;\n}\n","module.exports = require(\"helmet\");","import path from 'path';\nimport {ElasticsearchConfig} from './db/elasticsearch/config-elastic';\n\ntype LogLevel = 'error' | 'warn' | 'info' | 'debug';\n\nexport interface BaseConfig {\n\tlog: { level: LogLevel };\n\tserver: ServerConfig;\n\tdatabase: DBConfig;\n\tpaths: {\n\t\tdata: string,\n\t\tfrontend: string\n\t};\n}\n\nexport interface DBConfig {\n\tuse: string;\n\toptions: {\n\t\telasticsearch: ElasticsearchConfig;\n\t\tnedb?: {};\n\t};\n}\n\nexport interface ServerConfig {\n\tlisten: string;\n\tport: number;\n\tsession: {\n\t\tallowedCookieDomains: Array<string>;\n\t\tsecret: string;\n\t\tcookie: {\n\t\t\tname: string;\n\t\t\tsecure: boolean\n\t\t\tmaxAge: {\n\t\t\t\tvalue: number;\n\t\t\t\tunit: string;\n\t\t\t};\n\t\t};\n\t};\n\tjwt: {\n\t\tsecret: string;\n\t\tmaxAge: {\n\t\t\tvalue: number;\n\t\t\tunit: string;\n\t\t};\n\t};\n}\n\nexport interface Config extends BaseConfig {\n\tfirstStart?: {\n\t\tadminUser?: {\n\t\t\tname: string;\n\t\t\tpass: string;\n\t\t\tmail: string;\n\t\t};\n\t\troots?: Array<{ name: string; path: string; strategy?: string }>;\n\t};\n\n\tgetDataPath(parts: Array<string>): string;\n}\n\nexport function extendConfig(config: BaseConfig): Config {\n\tconst result = <Config>config;\n\tresult.getDataPath = (parts: Array<string>): string => {\n\t\treturn path.resolve(config.paths.data, ...parts);\n\t};\n\treturn result;\n}\n\ndeclare var __non_webpack_require__: any;\n\nexport function loadConfig(configPath?: string): Config {\n\tconfigPath = configPath && configPath.length > 0 ? configPath : path.join(process.cwd(), 'config');\n\tconst configFile = path.join(configPath, 'config.js');\n\tconst configFirstStartFile = path.join(configPath, 'firststart.config.js');\n\tlet config: Config;\n\tif (__non_webpack_require__) {\n\t\tconfig = __non_webpack_require__(configFile);\n\t\tconfig.firstStart = __non_webpack_require__(configFirstStartFile);\n\t} else {\n\t\tconfig = require(configFile);\n\t\tconfig.firstStart = require(configFirstStartFile);\n\t}\n\treturn extendConfig(config);\n}\n","import {UserStore} from '../../objects/user/user.store';\nimport {TrackStore} from '../../objects/track/track.store';\nimport {FolderStore} from '../../objects/folder/folder.store';\nimport {EpisodeStore} from '../../objects/episode/episode.store';\nimport {AlbumStore} from '../../objects/album/album.store';\nimport {ArtistStore} from '../../objects/artist/artist.store';\nimport {RadioStore} from '../../objects/radio/radio.store';\nimport {PlayQueueStore} from '../../objects/playqueue/playqueue.store';\nimport {RootStore} from '../../objects/root/root.store';\nimport {BookmarkStore} from '../../objects/bookmark/bookmark.store';\nimport {PodcastStore} from '../../objects/podcast/podcast.store';\nimport {PlaylistStore} from '../../objects/playlist/playlist.store';\nimport {StateStore} from '../../objects/state/state.store';\nimport {BaseStore, SearchQuery} from '../../objects/base/base.store';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Database} from '../../db/db.model';\nimport Logger from '../../utils/logger';\nimport {MetaDataStore} from '../../objects/metadata/metadata.store';\nimport {SettingsStore} from '../../objects/settings/settings.store';\n\nconst log = Logger('Store');\n\nexport class Store {\n\tpublic settingsStore: SettingsStore;\n\tpublic trackStore: TrackStore;\n\tpublic folderStore: FolderStore;\n\tpublic userStore: UserStore;\n\tpublic stateStore: StateStore;\n\tpublic playlistStore: PlaylistStore;\n\tpublic podcastStore: PodcastStore;\n\tpublic episodeStore: EpisodeStore;\n\tpublic bookmarkStore: BookmarkStore;\n\tpublic rootStore: RootStore;\n\tpublic artistStore: ArtistStore;\n\tpublic albumStore: AlbumStore;\n\tpublic playQueueStore: PlayQueueStore;\n\tpublic radioStore: RadioStore;\n\tpublic metaStore: MetaDataStore;\n\n\tconstructor(public db: Database) {\n\t\tthis.settingsStore = new SettingsStore(this.db);\n\t\tthis.trackStore = new TrackStore(this.db);\n\t\tthis.folderStore = new FolderStore(this.db);\n\t\tthis.userStore = new UserStore(this.db);\n\t\tthis.stateStore = new StateStore(this.db);\n\t\tthis.playlistStore = new PlaylistStore(this.db);\n\t\tthis.podcastStore = new PodcastStore(this.db);\n\t\tthis.episodeStore = new EpisodeStore(this.db);\n\t\tthis.bookmarkStore = new BookmarkStore(this.db);\n\t\tthis.artistStore = new ArtistStore(this.db);\n\t\tthis.albumStore = new AlbumStore(this.db);\n\t\tthis.playQueueStore = new PlayQueueStore(this.db);\n\t\tthis.radioStore = new RadioStore(this.db);\n\t\tthis.rootStore = new RootStore(this.db);\n\t\tthis.metaStore = new MetaDataStore(this.db);\n\t}\n\n\tasync reset(): Promise<void> {\n\t\tawait this.db.reset();\n\t}\n\n\tasync check(): Promise<void> {\n\t\tawait this.db.check();\n\t}\n\n\tasync open(): Promise<void> {\n\t\tawait this.db.open();\n\t}\n\n\tasync close(): Promise<void> {\n\t\tawait this.db.close();\n\t}\n\n\tasync findInAll(id: string): Promise<DBObject | undefined> {\n\t\tconst stores: Array<BaseStore<DBObject, SearchQuery>> =\n\t\t\t[this.folderStore, this.trackStore, this.albumStore, this.artistStore, this.podcastStore, this.episodeStore, this.playlistStore, this.artistStore, this.albumStore, this.radioStore, this.userStore];\n\t\tfor (const store of stores) {\n\t\t\tconst obj = await store.byId(id);\n\t\t\tif (obj) {\n\t\t\t\treturn obj;\n\t\t\t}\n\t\t}\n\t}\n\n\tasync findMultiInAll(ids: Array<string>): Promise<Array<DBObject>> {\n\t\tlet result: Array<DBObject> = [];\n\t\tconst stores: Array<BaseStore<DBObject, SearchQuery>> =\n\t\t\t[this.folderStore, this.trackStore, this.albumStore, this.artistStore, this.podcastStore, this.episodeStore, this.playlistStore, this.artistStore, this.albumStore, this.radioStore, this.userStore];\n\t\tfor (const store of stores) {\n\t\t\tconst objs = await store.byIds(ids);\n\t\t\tresult = result.concat(objs);\n\t\t}\n\t\treturn result;\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {User} from './user.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryUser extends SearchQuery {\n\tname?: string;\n\tisAdmin?: boolean;\n}\n\nexport class UserStore extends BaseStore<User, SearchQueryUser> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.user, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryUser): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('name', query.name);\n\t\tq.bool('roles.admin', query.isAdmin);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Track} from './track.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\nimport {ensureTrailingPathSeparator} from '../../utils/fs-utils';\n\nexport interface SearchQueryTrack extends SearchQuery {\n\tpath?: string;\n\tinPath?: string;\n\tinPaths?: Array<string>;\n\tartist?: string;\n\tartistID?: string;\n\tparentID?: string;\n\tparentIDs?: Array<string>;\n\tmbTrackID?: string;\n\tmbTrackIDs?: Array<string>;\n\trootID?: string;\n\trootIDs?: Array<string>;\n\ttitle?: string;\n\talbum?: string;\n\tgenre?: string;\n\tnewerThan?: number;\n\tfromYear?: number;\n\ttoYear?: number;\n}\n\nexport class TrackStore extends BaseStore<Track, SearchQueryTrack> {\n\tfieldMap: { [name: string]: string } = {\n\t\t'path': 'path',\n\t\t'parentID': 'parentID',\n\t\t'parentIDs': 'parentID',\n\t\t'rootID': 'rootID',\n\t\t'rootIDs': 'rootID',\n\t\t'artistID': 'artistID',\n\t\t'artist': 'tag.artist',\n\t\t'mbTrackID': 'tag.mbTrackID',\n\t\t'title': 'tag.title',\n\t\t'album': 'tag.album',\n\t\t'year': 'tag.year',\n\t\t'genre': 'tag.genre',\n\t\t'created': 'stat.created'\n\t};\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.track, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryTrack): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.terms('parentID', query.parentIDs);\n\t\tq.term('path', query.path);\n\t\tq.startsWiths('path', query.inPaths ? query.inPaths.map(s => ensureTrailingPathSeparator(s)) : undefined);\n\t\tq.startsWith('path', query.inPath ? ensureTrailingPathSeparator(query.inPath) : undefined);\n\t\tq.term('tag.genre', query.genre);\n\t\tq.term('rootID', query.rootID);\n\t\tq.terms('rootID', query.rootIDs);\n\t\tq.term('parentID', query.parentID);\n\t\tq.term('tag.mbTrackID', query.mbTrackID);\n\t\tq.terms('tag.mbTrackID', query.mbTrackIDs);\n\t\tq.term('tag.artist', query.artist);\n\t\tq.term('tag.title', query.title);\n\t\tq.match('tag.title', query.query);\n\t\tq.term('tag.album', query.album);\n\t\tq.term('artistID', query.artistID);\n\t\tq.range('tag.year', query.toYear, query.fromYear);\n\t\tq.range('stat.created', undefined, query.newerThan);\n\t\treturn q.get(query, this.fieldMap);\n\t}\n\n\t// async genres(): Promise<Array<string>> {\n\t// \treturn await this.group.distinct('tag.genre');\n\t// }\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Folder} from './folder.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\nimport {ensureTrailingPathSeparator} from '../../utils/fs-utils';\n\nexport interface SearchQueryFolder extends SearchQuery {\n\trootID?: string;\n\tparentID?: string;\n\tparentIDs?: Array<string>;\n\tpath?: string;\n\tinPath?: string;\n\tartist?: string;\n\tartists?: Array<string>;\n\ttitle?: string;\n\talbum?: string;\n\tgenre?: string;\n\tlevel?: number;\n\tnewerThan?: number;\n\tfromYear?: number;\n\ttoYear?: number;\n\tmbAlbumID?: string;\n\tmbArtistID?: string;\n\ttypes?: Array<string>;\n}\n\nexport class FolderStore extends BaseStore<Folder, SearchQueryFolder> {\n\tfieldMap: { [name: string]: string } = {\n\t\t'parentID': 'parentID',\n\t\t'parentIDs': 'parentID',\n\t\t'rootID': 'rootID',\n\t\t'artist': 'tag.artist',\n\t\t'title': 'tag.title',\n\t\t'type': 'tag.type',\n\t\t'year': 'tag.year',\n\t\t'created': 'stat.created',\n\t\t'album': 'tag.album',\n\t\t'path': 'path',\n\t\t'level': 'tag.level',\n\t\t'genre': 'tag.genre'\n\t};\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.folder, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryFolder): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('path', query.path);\n\t\tq.startsWith('path', query.inPath ? ensureTrailingPathSeparator(query.inPath) : undefined);\n\t\tq.term('tag.mbAlbumID', query.mbAlbumID);\n\t\tq.term('tag.mbArtistID', query.mbArtistID);\n\t\tq.term('tag.genre', query.genre);\n\t\tq.term('tag.title', query.title);\n\t\tq.term('tag.album', query.album);\n\t\tq.term('rootID', query.rootID);\n\t\tq.term('parentID', query.parentID);\n\t\tq.terms('parentID', query.parentIDs);\n\t\tq.term('tag.level', query.level);\n\t\tq.term('tag.artist', query.artist);\n\t\tq.terms('tag.artist', query.artists);\n\t\tq.terms('tag.type', query.types);\n\t\tq.range('tag.year', query.toYear, query.fromYear);\n\t\tq.range('stat.created', undefined, query.newerThan);\n\t\tq.match('tag.title', query.query);\n\t\treturn q.get(query, this.fieldMap);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Episode} from './episode.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryEpisode extends SearchQuery {\n\tpodcastID?: string;\n\tpodcastIDs?: Array<string>;\n\tname?: string;\n\tstatus?: string;\n\tnewerThan?: number;\n}\n\nexport class EpisodeStore extends BaseStore<Episode, SearchQueryEpisode> {\n\tfieldMap: { [name: string]: string } = {\n\t\t'podcastIDs': 'podcastID',\n\t\t'podcastID': 'podcastID',\n\t\t'status': 'status',\n\t\t'date': 'date',\n\t\t'name': 'name',\n\t\t'created': 'stat.created'\n\t};\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.episode, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryEpisode): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.terms('podcastID', query.podcastIDs);\n\t\tq.term('podcastID', query.podcastID);\n\t\tq.term('status', query.status);\n\t\tq.term('name', query.name);\n\t\tq.range('date', undefined, query.newerThan);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query, this.fieldMap);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Album} from './album.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryAlbum extends SearchQuery {\n\tname?: string;\n\tslug?: string;\n\trootID?: string;\n\tartist?: string;\n\tartistID?: string;\n\ttrackID?: string;\n\ttrackIDs?: Array<string>;\n\talbumType?: string;\n\talbumTypes?: Array<string>;\n\tmbAlbumID?: string;\n\tmbArtistID?: string;\n\tgenre?: string;\n\tnewerThan?: number;\n\tfromYear?: number;\n\ttoYear?: number;\n}\n\nexport class AlbumStore extends BaseStore<Album, SearchQueryAlbum> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.album, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryAlbum): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('rootIDs', query.rootID);\n\t\tq.term('artistID', query.artistID);\n\t\tq.term('genre', query.genre);\n\t\tq.term('mbAlbumID', query.mbAlbumID);\n\t\tq.term('mbArtistID', query.mbArtistID);\n\t\tq.term('trackIDs', query.trackID);\n\t\tq.term('albumType', query.albumType);\n\t\tq.terms('albumType', query.albumTypes);\n\t\tq.terms('trackIDs', query.trackIDs);\n\t\tq.term('artist', query.artist);\n\t\tq.term('name', query.name);\n\t\tq.term('slug', query.slug);\n\t\tq.range('year', query.toYear, query.fromYear);\n\t\tq.range('created', undefined, query.newerThan);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Artist} from './artist.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryArtist extends SearchQuery {\n\tname?: string;\n\tslug?: string;\n\tnames?: Array<string>;\n\tid?: string;\n\tids?: Array<string>;\n\ttrackID?: string;\n\ttrackIDs?: Array<string>;\n\trootID?: string;\n\tmbArtistID?: string;\n\talbumID?: string;\n\talbumType?: string;\n\talbumTypes?: Array<string>;\n\t// genre?: string;\n\tnewerThan?: number;\n\t// fromYear?: number;\n\t// toYear?: number;\n}\n\nexport class ArtistStore extends BaseStore<Artist, SearchQueryArtist> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.artist, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryArtist): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.terms('trackIDs', query.trackIDs);\n\t\tq.terms('name', query.names);\n\t\tq.term('rootIDs', query.rootID);\n\t\tq.term('albumIDs', query.albumID);\n\t\tq.term('trackIDs', query.trackID);\n\t\tq.term('name', query.name);\n\t\tq.term('albumTypes', query.albumType);\n\t\tq.terms('albumTypes', query.albumTypes);\n\t\tq.term('slug', query.slug);\n\t\t// q.term('genre', query.genre);\n\t\tq.term('mbArtistID', query.mbArtistID);\n\t\t// q.range('year', query.toYear, query.fromYear);\n\t\tq.range('created', undefined, query.newerThan);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Radio} from './radio.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryRadio extends SearchQuery {\n\tname?: string;\n\turl?: string;\n\thomepage?: string;\n}\n\nexport class RadioStore extends BaseStore<Radio, SearchQueryRadio> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.radio, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryRadio): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('url', query.url);\n\t\tq.term('homepage', query.homepage);\n\t\tq.term('name', query.name);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query);\n\t}\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {PlayQueue} from './playqueue.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryPlayQueue extends SearchQuery {\n\tuserID?: string;\n}\n\nexport class PlayQueueStore extends BaseStore<PlayQueue, SearchQueryPlayQueue> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.playqueue, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryPlayQueue): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('userID', query.userID);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Root} from './root.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryRoot extends SearchQuery {\n\tname?: string;\n\tpath?: string;\n}\n\nexport class RootStore extends BaseStore<Root, SearchQueryRoot> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.root, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryRoot): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('name', query.name);\n\t\tq.term('path', query.path);\n\t\tq.match('name', query.query);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Bookmark} from './bookmark.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryBookmark extends SearchQuery {\n\tuserID?: string;\n\tdestID?: string;\n\tdestIDs?: Array<string>;\n}\n\nexport class BookmarkStore extends BaseStore<Bookmark, SearchQueryBookmark> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.bookmark, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryBookmark): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('userID', query.userID);\n\t\tq.term('destID', query.destID);\n\t\tq.terms('destID', query.destIDs);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Podcast} from './podcast.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryPodcast extends SearchQuery {\n\turl?: string;\n\ttitle?: string;\n\tstatus?: string;\n\tnewerThan?: number;\n}\n\nexport class PodcastStore extends BaseStore<Podcast, SearchQueryPodcast> {\n\tfieldMap: { [name: string]: string } = {\n\t\t'url': 'url',\n\t\t'title': 'tag.title',\n\t\t'status': 'status',\n\t\t'query': 'tag.title',\n\t\t'created': 'created'\n\t};\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.podcast, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryPodcast): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('url', query.url);\n\t\tq.term('tag.title', query.title);\n\t\tq.term('status', query.status);\n\t\tq.range('created', undefined, query.newerThan);\n\t\tq.match('tag.title', query.query);\n\t\treturn q.get(query, this.fieldMap);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Playlist} from './playlist.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryPlaylist extends SearchQuery {\n\tname?: string;\n\tuserID?: string;\n\tisPublic?: boolean;\n\ttrackID?: string;\n\ttrackIDs?: Array<string>;\n\tnewerThan?: number;\n}\n\nexport class PlaylistStore extends BaseStore<Playlist, SearchQueryPlaylist> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.playlist, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryPlaylist): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('trackIDs', query.trackID);\n\t\tq.terms('trackIDs', query.trackIDs);\n\t\tq.term('userID', query.userID);\n\t\tq.term('name', query.name);\n\t\tq.bool('isPublic', query.isPublic);\n\t\tq.match('name', query.query);\n\t\tq.range('created', undefined, query.newerThan);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {State} from './state.model';\nimport {Database, DatabaseQuery} from '../../db/db.model';\n\nexport interface SearchQueryState extends SearchQuery {\n\tdestID?: string;\n\tdestIDs?: Array<string>;\n\tuserID?: string;\n\ttype?: DBObjectType;\n\tisPlayed?: boolean;\n\tisFaved?: boolean;\n\tminRating?: number;\n\tmaxRating?: number;\n}\n\nexport class StateStore extends BaseStore<State, SearchQueryState> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.state, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryState): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('userID', query.userID);\n\t\tq.term('destID', query.destID);\n\t\tq.terms('destID', query.destIDs);\n\t\tq.term('destType', query.type);\n\t\tq.notNull('faved', query.isFaved);\n\t\tq.range('rated', query.maxRating, query.minRating);\n\t\tq.range('played', undefined, query.isPlayed ? 1 : undefined);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Database, DatabaseQuery} from '../../db/db.model';\nimport {MetaData} from './metadata.model';\nimport {MetaDataType} from './metadata.types';\n\nexport interface SearchQueryMetaData extends SearchQuery {\n\tname?: string;\n\tdataType?: MetaDataType;\n}\n\nexport class MetaDataStore extends BaseStore<MetaData, SearchQueryMetaData> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.metadata, db);\n\t}\n\n\tprotected transformQuery(query: SearchQueryMetaData): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('name', query.name);\n\t\tq.term('dataType', query.dataType);\n\t\treturn q.get(query);\n\t}\n\n}\n","import {DBObjectType} from '../../db/db.types';\nimport {BaseStore, QueryHelper, SearchQuery} from '../base/base.store';\nimport {Database, DatabaseQuery} from '../../db/db.model';\nimport {Settings} from './settings.model';\n\nexport interface SearchQuerySettings extends SearchQuery {\n\tsection?: string;\n}\n\nexport class SettingsStore extends BaseStore<Settings, SearchQuerySettings> {\n\n\tconstructor(db: Database) {\n\t\tsuper(DBObjectType.settings, db);\n\t}\n\n\tprotected transformQuery(query: SearchQuerySettings): DatabaseQuery {\n\t\tconst q = new QueryHelper();\n\t\tq.term('section', query.section);\n\t\treturn q.get(query);\n\t}\n\n}\n","import elasticsearch from 'elasticsearch';\nimport {DBObjectType} from '../db.types';\nimport {ESSequence} from './es-sequence';\nimport Logger from '../../utils/logger';\nimport {mapping} from './mapping';\nimport {wait} from '../../utils/wait';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Database, DatabaseIndex, DatabaseQuery} from '../db.model';\nimport {ElasticsearchConfig} from './config-elastic';\n\nconst log = Logger('DB.elastic');\n\nexport class DBIndexElastic<T extends DBObject> implements DatabaseIndex<T> {\n\tprotected _index: string;\n\tprotected _type: string;\n\tprotected _map: any;\n\tpublic type: DBObjectType;\n\tpublic db: DBElastic;\n\n\tconstructor(type: DBObjectType, db: DBElastic) {\n\t\tthis.type = type;\n\t\tif (type === undefined) {\n\t\t\tthis._index = db.indexName('*'); // 'all';\n\t\t\tthis._type = '';\n\t\t} else {\n\t\t\tthis._type = DBObjectType[type];\n\t\t\tthis._index = db.indexName(DBObjectType[type]);\n\t\t}\n\t\tthis._map = mapping[this._type];\n\t\tthis.db = db;\n\t}\n\n\tprivate hit2Obj(hit: any): T {\n\t\thit._source.id = hit._source.id.toString();\n\t\thit._source.type = DBObjectType[hit._type];\n\t\treturn <T>hit._source;\n\t}\n\n\tprivate filterProperties(o: T): any {\n\t\tconst result: any = Object.assign({}, o);\n\t\tresult.type = undefined;\n\t\treturn result;\n\t}\n\n\tprivate getPropertyMapping(key: string): any {\n\t\tconst parts = key.split('.');\n\t\tlet o = this._map;\n\t\tfor (const p of parts) {\n\t\t\to = o.properties[p];\n\t\t}\n\t\treturn o;\n\t}\n\n\tprivate translateElasticQuery(query: DatabaseQuery) {\n\t\tif (query.all) {\n\t\t\treturn {match_all: {}};\n\t\t}\n\t\tlet must: Array<any> = [];\n\t\tif (query.term) {\n\t\t\tconst o = query.term;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tconst prop = this.getPropertyMapping(key);\n\t\t\t\t\tif (!prop) {\n\t\t\t\t\t\tconsole.log('Unknown prop', this._type, key);\n\t\t\t\t\t}\n\t\t\t\t\tif (prop && prop.type === 'text') {\n\t\t\t\t\t\tterm[key + '.keyword'] = o[key];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tterm[key] = o[key];\n\t\t\t\t\t}\n\t\t\t\t\treturn {'term': term};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.terms) {\n\t\t\tconst o = query.terms;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tconst prop = this.getPropertyMapping(key);\n\t\t\t\t\tif (!prop) {\n\t\t\t\t\t\tconsole.log('Unknown prop', this._type, key);\n\t\t\t\t\t}\n\t\t\t\t\tif (prop && prop.type === 'text') {\n\t\t\t\t\t\tterm[key + '.keyword'] = o[key];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tterm[key] = o[key];\n\t\t\t\t\t}\n\t\t\t\t\treturn {'terms': term};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.match) {\n\t\t\tconst o = query.match;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = o[key];\n\t\t\t\t\treturn {'match_phrase_prefix': term};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.startsWith) {\n\t\t\tconst o = query.startsWith;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = o[key];\n\t\t\t\t\treturn {'prefix': term};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.startsWiths) {\n\t\t\tconst o = query.startsWiths;\n\t\t\tObject.keys(o).forEach(key => {\n\t\t\t\to[key].forEach(s => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = s;\n\t\t\t\t\tmust.push({'prefix': term});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\tif (query.range) {\n\t\t\tconst o = query.range;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst vals = o[key];\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = {'gte': vals.gte, 'lte': vals.lte};\n\t\t\t\t\treturn {'range': term};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.notNull) {\n\t\t\tconst o = query.notNull;\n\t\t\tmust = must.concat(o.map(key => {\n\t\t\t\treturn {'exists': {'field': key}};\n\t\t\t}));\n\t\t}\n\t\treturn {\n\t\t\tbool: {\n\t\t\t\tmust: must\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async scroll(response: elasticsearch.SearchResponse<T>, onHits: (hits: Array<any>) => Promise<void>): Promise<void> {\n\t\tlet count = 0;\n\t\tconst client = this.db.client;\n\n\t\tasync function getMoreUntilDone(res: elasticsearch.SearchResponse<T>) {\n\t\t\tcount += res.hits.hits.length;\n\t\t\tawait onHits(res.hits.hits);\n\t\t\tif (res.hits.total !== count && res._scroll_id) {\n\t\t\t\t// now we can call scroll over and over\n\t\t\t\tconst next = await client.scroll<T>({scrollId: res._scroll_id, scroll: '30s'});\n\t\t\t\tawait getMoreUntilDone(next);\n\t\t\t}\n\t\t}\n\n\t\tawait getMoreUntilDone(response);\n\t}\n\n\tasync getNewId(): Promise<string> {\n\t\treturn await this.db.getNewId();\n\t}\n\n\tasync add(body: T): Promise<string> {\n\t\tif (!body.id || body.id.length === 0) {\n\t\t\tbody.id = await this.getNewId();\n\t\t}\n\t\tawait this.db.client.index({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: this.filterProperties(body),\n\t\t\tid: body.id,\n\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t});\n\t\treturn body.id;\n\t}\n\n\tasync bulk(bodies: Array<T>): Promise<void> {\n\t\tfor (const body of bodies) {\n\t\t\tawait await this.add(body);\n\t\t}\n\t}\n\n\tasync replace(id: string, body: T): Promise<void> {\n\t\tawait this.db.client.index({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: this.filterProperties(body),\n\t\t\tid,\n\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t});\n\t}\n\n\tasync upsert(id: string, body: T): Promise<void> {\n\t\tif (!id || id.length === 0) {\n\t\t\tawait this.add(body);\n\t\t\treturn;\n\t\t}\n\t\tawait this.db.client.index({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: this.filterProperties(body),\n\t\t\tid,\n\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t});\n\t}\n\n\tasync removeByQuery(query: DatabaseQuery): Promise<number> {\n\t\tconst response = await this.db.client.deleteByQuery({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query)\n\t\t\t},\n\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t});\n\t\treturn response.deleted;\n\t}\n\n\tasync remove(id: string | Array<string>): Promise<void> {\n\t\tif (id.length === 0) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\tif (Array.isArray(id)) {\n\t\t\tawait this.db.client.deleteByQuery({\n\t\t\t\tindex: this._index,\n\t\t\t\ttype: this._type,\n\t\t\t\tbody: {\n\t\t\t\t\tquery: {\n\t\t\t\t\t\t'terms': {\n\t\t\t\t\t\t\t'_id': id\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t\t});\n\t\t} else {\n\t\t\tawait this.db.client.delete({\n\t\t\t\tindex: this._index,\n\t\t\t\ttype: this._type,\n\t\t\t\tid: <string>id,\n\t\t\t\trefresh: <elasticsearch.Refresh>this.db.indexRefresh\n\t\t\t});\n\t\t}\n\t}\n\n\tasync byId(id: string): Promise<T | undefined> {\n\t\tif (this.type === undefined) {\n\t\t\treturn await this.queryOne({term: {id: id}});\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tconst response = await this.db.client.get({\n\t\t\t\t\tindex: this._index,\n\t\t\t\t\ttype: this._type,\n\t\t\t\t\tid: id\n\t\t\t\t});\n\t\t\t\tif (!response.found) {\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\treturn this.hit2Obj(response);\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tif (e.statusCode !== 404) {\n\t\t\t\t\tPromise.reject(e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tasync byIds(ids: Array<string>): Promise<Array<T>> {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconst response = await this.db.client.mget({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: {'ids': ids}\n\t\t});\n\t\tif (!response.docs) {\n\t\t\treturn [];\n\t\t}\n\t\treturn response.docs.filter((doc) => {\n\t\t\treturn doc.found;\n\t\t}).map((doc) => {\n\t\t\treturn this.hit2Obj(doc);\n\t\t});\n\t}\n\n\tasync query(query: DatabaseQuery): Promise<Array<T>> {\n\t\tlet list: Array<T> = [];\n\t\tconst response = await this.db.client.search<T>({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tscroll: '30s',\n\t\t\tsize: 100,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query)\n\t\t\t}\n\t\t});\n\t\tawait this.scroll(response, async (hits) => {\n\t\t\tlist = list.concat(hits.map(this.hit2Obj));\n\t\t});\n\t\treturn list;\n\t}\n\n\tasync queryOne(query: DatabaseQuery): Promise<T | undefined> {\n\t\tconst response = await this.db.client.search({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tsize: 1,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query)\n\t\t\t}\n\t\t});\n\t\tif (response.hits.total > 0) {\n\t\t\treturn this.hit2Obj(response.hits.hits[0]);\n\t\t}\n\t\treturn;\n\t}\n\n\tasync iterate(query: DatabaseQuery, onItem: (items: Array<T>) => Promise<void>): Promise<void> {\n\t\tconst response = await this.db.client.search<T>({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tscroll: '30s',\n\t\t\tsize: 100,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query)\n\t\t\t}\n\t\t});\n\t\tawait this.scroll(response, async (hits) => {\n\t\t\tawait onItem(hits.map(this.hit2Obj));\n\t\t});\n\t}\n\n\tasync queryIds(query: DatabaseQuery): Promise<Array<string>> {\n\t\tlet list: Array<string> = [];\n\t\tconst response = await this.db.client.search<T>({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tscroll: '30s',\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query),\n\t\t\t\tstored_fields: []\n\t\t\t}\n\t\t});\n\t\tawait this.scroll(response, async (hits) => {\n\t\t\tlist = list.concat(hits.map(hit => hit._id.toString()));\n\t\t});\n\t\treturn list;\n\t}\n\n\tasync aggregate(query: DatabaseQuery, field: string): Promise<number> {\n\t\tconst response = await this.db.client.search({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query),\n\t\t\t\t'aggs': {\n\t\t\t\t\t'_count': {\n\t\t\t\t\t\t'cardinality': {\n\t\t\t\t\t\t\t'field': field\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn response.aggregations._count.value;\n\t}\n\n\tasync count(query: DatabaseQuery): Promise<number> {\n\t\tconst response = await this.db.client.search({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tsize: 0,\n\t\t\tbody: {\n\t\t\t\tquery: this.translateElasticQuery(query),\n\t\t\t}\n\t\t});\n\t\treturn response.hits.total;\n\t}\n\n\tasync distinct(fieldname: string): Promise<Array<string>> {\n\t\tconst response = await this.db.client.search({\n\t\t\tindex: this._index,\n\t\t\ttype: this._type,\n\t\t\tbody: {'aggs': {'distinct': {'terms': {'field': fieldname}}}}\n\t\t});\n\t\treturn response.aggregations.distinct.buckets.map((hit: any) => hit.key);\n\t}\n\n}\n\nexport class DBElastic implements Database {\n\tclient: elasticsearch.Client;\n\tsequence: ESSequence;\n\tindexPrefix: string;\n\tindexRefresh: string | undefined;\n\n\tconstructor(config: ElasticsearchConfig) {\n\t\tthis.client = new elasticsearch.Client({host: config.host, log: config.log});\n\t\tthis.sequence = new ESSequence(this.client);\n\t\tthis.indexPrefix = config.indexPrefix;\n\t\tthis.indexRefresh = config.indexRefresh;\n\t}\n\n\tasync drop(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tawait this.resetIndex(type);\n\t\t}\n\t}\n\n\tasync close(): Promise<void> {\n\t\tthis.client.close();\n\t}\n\n\tasync ping(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.client.ping(<elasticsearch.PingParams>{requestTimeout: 10000});\n\t\t} catch (e) {\n\t\t\tlog.error('elasticsearch could not be contacted', e);\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n\n\tasync open(): Promise<void> {\n\t\tlog.debug('Open connection to elasticsearch');\n\t\tawait this.sequence.init(this.client);\n\t\tawait this.ping();\n\t\tawait this.check();\n\t}\n\n\tasync getNewId(): Promise<string> {\n\t\tconst id: number = await this.sequence.get(this.indexName('id'));\n\t\treturn id.toString();\n\t}\n\n\tindexName(name: string): string {\n\t\treturn this.indexPrefix + '_' + name;\n\t}\n\n\tprivate getTypes(): Array<DBObjectType> {\n\t\treturn Object.keys(DBObjectType)\n\t\t\t.filter(key => !isNaN(Number(key)))\n\t\t\t.map(key => parseInt(key, 10));\n\t}\n\n\tprivate async resetIndex(type: DBObjectType): Promise<void> {\n\t\tconst index = this.indexName(DBObjectType[type]);\n\t\tconst exists = await this.client.indices.exists({index});\n\t\tif (exists) {\n\t\t\tawait this.client.indices.delete({index});\n\t\t}\n\t}\n\n\tasync reset(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tawait this.resetIndex(type);\n\t\t}\n\t}\n\n\tprivate async createIndex(type: DBObjectType): Promise<void> {\n\t\tconst name = DBObjectType[type];\n\t\tif (!mapping[name]) {\n\t\t\treturn Promise.reject(Error('Missing Elasticsearch Mapping for type ' + name));\n\t\t}\n\t\tconst index = this.indexName(name);\n\t\tconst m: any = {};\n\t\tm['_default_'] = {'_default_': {'date_detection': false}};\n\t\tm[name] = mapping[name];\n\t\tawait this.client.indices.create({index, body: {'mappings': m}});\n\t}\n\n\tprivate async checkIndex(type: DBObjectType): Promise<boolean> {\n\t\tconst name = DBObjectType[type];\n\t\tconst index = this.indexName(name);\n\t\tconst exists = await this.client.indices.exists({index});\n\t\tif (!exists) {\n\t\t\tawait this.createIndex(type);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync check(): Promise<void> {\n\t\tlet waitAfter = false;\n\t\tfor (const type of this.getTypes()) {\n\t\t\twaitAfter = await this.checkIndex(type) || waitAfter;\n\t\t}\n\t\tif (waitAfter) {\n\t\t\tawait wait(1000);\n\t\t}\n\t}\n\n\tpublic getDBIndex<T extends DBObject>(type: DBObjectType) {\n\t\treturn new DBIndexElastic<T>(type, this);\n\t}\n}\n","module.exports = require(\"elasticsearch\");","import elasticsearch from 'elasticsearch';\n\nconst esTypeMapping = {\n\t_source: {enabled: false},\n\t_all: {enabled: false},\n\t// _type: {index: 'no'},\n\tenabled: false\n};\n\nexport class ESSequence {\n\tclient: elasticsearch.Client;\n\tprivate initPromise: Promise<any> | null = null;\n\tprivate initError: Promise<any> | null = null;\n\tprivate cacheFillPromise: Promise<any> | null = null;\n\tprivate cache: { [sequenceName: string]: Array<string> } = {};\n\tprivate cacheSize = 100;\n\tprivate options = {esIndex: 'sequences', esType: 'sequence'};\n\n\tconstructor(client: elasticsearch.Client) {\n\t\tthis.client = client;\n\t\tif (!isInjectedClientValid(client)) {\n\t\t\tthrow new Error('Init was called with an invalid client parameter value.');\n\t\t}\n\t}\n\n\tinit(options?: any, cacheSize?: number): Promise<any> {\n\t\t// The following checks are done before the init promise is created\n\t\t// because errors thrown in the init promise are stored in _initError.\n\t\t// If a check fails it should look as if init was not called.\n\t\tif (!isInjectedClientValid(this.client)) {\n\t\t\treturn Promise.reject(new Error('Init was called with an invalid client parameter value.'));\n\t\t}\n\t\tif (this.initPromise !== null) {\n\t\t\treturn Promise.reject(new Error('Init was called while a previous init is pending.'));\n\t\t}\n\t\tif (this.cacheFillPromise !== null) {\n\t\t\treturn Promise.reject(new Error('Init was called while get requests are pending.'));\n\t\t}\n\t\tif (!isInjectedCacheSizeValid(cacheSize)) {\n\t\t\treturn Promise.reject(new Error('Init was called with an invalid cacheSize parameter value.'));\n\t\t}\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.cache = {}; // In case init is called multiple times.\n\t\t\tthis.cacheSize = 100;\n\t\t\tthis.initError = null;\n\t\t\tif (cacheSize !== undefined) {\n\t\t\t\tthis.cacheSize = cacheSize;\n\t\t\t}\n\t\t\tif (isObject(options)) {\n\t\t\t\tthis.options = Object.assign(this.options, options);\n\t\t\t}\n\t\t\tresolve(this.initEsIndexIfNeeded());\n\t\t}).catch((e) => {\n\t\t\tthis.initError = e;\n\t\t\tthrow e;\n\t\t}).then(() => {\n\t\t\tthis.initPromise = null;\n\t\t});\n\t\treturn this.initPromise;\n\t}\n\n\taddMappingToEsIndexIfMissing(): Promise<any> {\n\t\tconst mapping: any = {};\n\t\tmapping[this.options.esType] = esTypeMapping;\n\t\treturn this.client.indices.putMapping({\n\t\t\tindex: this.options.esIndex,\n\t\t\ttype: this.options.esType,\n\t\t\t// ignore_conflicts: true,\n\t\t\tbody: mapping\n\t\t});\n\t}\n\n\tinitEsIndexIfNeeded(): Promise<any> {\n\t\treturn this.client.indices.exists({index: this.options.esIndex}).then(response => {\n\t\t\tif (response) {\n\t\t\t\treturn this.addMappingToEsIndexIfMissing();\n\t\t\t}\n\t\t\tconst config: any = {\n\t\t\t\tsettings: {\n\t\t\t\t\tnumber_of_shards: 1,\n\t\t\t\t\tauto_expand_replicas: '0-all'\n\t\t\t\t},\n\t\t\t\tmappings: {}\n\t\t\t};\n\t\t\tconfig.mappings[this.options.esType] = esTypeMapping;\n\t\t\treturn this.client.indices.create({\n\t\t\t\tindex: this.options.esIndex,\n\t\t\t\tbody: config\n\t\t\t});\n\t\t});\n\t}\n\n\tfillCache(sequenceName: string): Promise<any> {\n\t\tthis.cacheFillPromise = new Promise(resolve => {\n\t\t\tif (!this.cache[sequenceName]) {\n\t\t\t\tthis.cache[sequenceName] = [];\n\t\t\t}\n\t\t\tconst bulkParams: elasticsearch.BulkIndexDocumentsParams = {body: []};\n\t\t\tfor (let i = 0; i < this.cacheSize; i += 1) {\n\t\t\t\t// Action\n\t\t\t\tbulkParams.body.push({index: {_index: this.options.esIndex, _type: this.options.esType, _id: sequenceName}});\n\t\t\t\t// Empty document\n\t\t\t\tbulkParams.body.push({});\n\t\t\t}\n\t\t\tresolve(\n\t\t\t\tthis.client.bulk(bulkParams).then(response => {\n\t\t\t\t\tfor (let k = 0; k < response.items.length; k += 1) {\n\t\t\t\t\t\t// This is the core trick: The document's version is an auto-incrementing integer.\n\t\t\t\t\t\tthis.cache[sequenceName].push(response.items[k].index._version);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t);\n\t\t}).then(() => {\n\t\t\tthis.cacheFillPromise = null;\n\t\t});\n\t\treturn this.cacheFillPromise;\n\t}\n\n\tprivate interal_get(sequenceName: string): Promise<any> {\n\t\tif (this.initError !== null) {\n\t\t\treturn Promise.reject(this.initError);\n\t\t}\n\t\tif (this.cache[sequenceName] && this.cache[sequenceName].length > 0) {\n\t\t\treturn Promise.resolve(this.cache[sequenceName].shift());\n\t\t}\n\n\t\tconst returnValue = (): Promise<any> => {\n\t\t\treturn this.interal_get(sequenceName);\n\t\t};\n\n\t\tif (this.cacheFillPromise !== null) {\n\t\t\treturn this.cacheFillPromise.then(returnValue);\n\t\t} else {\n\t\t\treturn this.fillCache(sequenceName).then(returnValue);\n\t\t}\n\t}\n\n\tpublic get(sequenceName: string): Promise<any> {\n\t\tif (!this.client) {\n\t\t\tthrow new Error('Please run init(...) first to provide an elasticsearch client.');\n\t\t}\n\t\tif ((typeof sequenceName !== 'string') || sequenceName.length === 0) {\n\t\t\tthrow new Error('The parameter value for sequenceName is invalid.');\n\t\t}\n\t\tif (this.initPromise !== null) {\n\t\t\t// Defer until init is done\n\t\t\treturn this.initPromise.then(() => this.interal_get(sequenceName));\n\t\t}\n\t\treturn this.interal_get(sequenceName);\n\t}\n\n\tpublic getCacheSize(sequenceName: string): number {\n\t\tif (!this.cache[sequenceName]) {\n\t\t\treturn 0;\n\t\t} else {\n\t\t\treturn this.cache[sequenceName].length;\n\t\t}\n\t}\n\n}\n\nfunction isObject(val: any): boolean {\n\treturn typeof val === 'object';\n}\n\nfunction isFunction(val: any): boolean {\n\treturn typeof val === 'function';\n}\n\nfunction isInjectedClientValid(client: elasticsearch.Client) {\n\treturn !((!isObject(client) && !isFunction(client)) ||\n\t\t(!isObject(client.indices) && !isFunction(client.indices)) ||\n\t\t!isFunction(client.indices.create) ||\n\t\t!isFunction(client.indices.exists) ||\n\t\t!isFunction(client.indices.putMapping) ||\n\t\t!isFunction(client.bulk));\n}\n\nfunction isInjectedCacheSizeValid(cacheSize: number | any): boolean {\n\treturn ((cacheSize === undefined) || (typeof cacheSize === 'number' && isFinite(cacheSize) && Math.floor(cacheSize) === cacheSize));\n}\n","const type_bool = {type: 'boolean'};\n\nconst type_int = {type: 'long'};\n\nconst type_string = {type: 'text', fields: {keyword: {type: 'keyword'}}};\n\nconst type_key = {type: 'keyword'};\n\nconst type_Root = {\n\tproperties: {\n\t\tname: type_string,\n\t\tpath: type_key,\n\t\tcreated: type_int,\n\t\tstrategy: type_key,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_UserRoles = {\n\tproperties: {\n\t\tstream: type_bool,\n\t\tupload: type_bool,\n\t\tadmin: type_bool,\n\t\tpodcast: type_bool\n\t}\n};\n\nconst type_User = {\n\tproperties: {\n\t\tname: type_string,\n\t\tsalt: type_key,\n\t\thash: type_key,\n\t\tsubsonic_pass: type_key,\n\t\temail: type_key,\n\t\tcreated: type_int,\n\t\tscrobblingEnabled: type_bool,\n\t\tavatarLastChanged: type_int,\n\t\tavatar: type_key,\n\t\tmaxBitRate: type_int,\n\t\tallowedfolder: type_key,\n\t\troles: type_UserRoles,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Artwork = {\n\tproperties: {\n\t\tid: type_key,\n\t\tname: type_string,\n\t\ttypes: type_key,\n\t\tstat: {\n\t\t\tproperties: {\n\t\t\t\tcreated: type_int,\n\t\t\t\tmodified: type_int,\n\t\t\t\tsize: type_int\n\t\t\t}\n\t\t}\n\t}\n};\n\nconst type_FolderTag = {\n\tproperties: {\n\t\tlevel: type_int,\n\t\ttrackCount: type_int,\n\t\tfolderCount: type_int,\n\t\ttype: type_key,\n\t\tgenre: type_key,\n\t\talbum: type_key,\n\t\tartist: type_key,\n\t\tartistSort: type_key,\n\t\talbumType: type_key,\n\t\ttitle: type_string,\n\t\tyear: type_int,\n\t\tmbAlbumID: type_key,\n\t\tmbReleaseGroupID: type_key,\n\t\tmbAlbumType: type_key,\n\t\tmbArtistID: type_key,\n\t\timage: type_key,\n\t\tartworks: type_Artwork\n\t}\n};\n\nconst type_Folder = {\n\tproperties: {\n\t\trootID: type_key,\n\t\tpath: type_key,\n\t\tparentID: type_key,\n\t\tstat: {\n\t\t\tproperties: {\n\t\t\t\tcreated: type_int,\n\t\t\t\tmodified: type_int\n\t\t\t}\n\t\t},\n\t\ttag: type_FolderTag,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_PlayQueue = {\n\tproperties: {\n\t\tuserID: type_key,\n\t\ttrackIDs: type_key,\n\t\tcurrentID: type_key,\n\t\tposition: type_int,\n\t\tchanged: type_int,\n\t\tchangedBy: type_key,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_TrackTag = {\n\tproperties: {\n\t\tformat: type_key,\n\t\talbum: type_key,\n\t\talbumSort: type_key,\n\t\talbumArtist: type_key,\n\t\talbumArtistSort: type_key,\n\t\tartist: type_key,\n\t\tartistSort: type_key,\n\t\tgenre: type_key,\n\t\tdisc: type_int,\n\t\tdiscTotal: type_int,\n\t\ttitle: type_string,\n\t\ttitleSort: type_key,\n\t\ttrack: type_int,\n\t\ttrackTotal: type_int,\n\t\tyear: type_int,\n\t\tmbTrackID: type_key,\n\t\tmbAlbumType: type_key,\n\t\tmbAlbumArtistID: type_key,\n\t\tmbArtistID: type_key,\n\t\tmbAlbumID: type_key,\n\t\tmbReleaseTrackID: type_key,\n\t\tmbReleaseGroupID: type_key,\n\t\tmbRecordingID: type_key,\n\t\tmbAlbumStatus: type_key,\n\t\tmbReleaseCountry: type_key\n\t}\n};\n\nconst type_TrackMedia = {\n\tproperties: {\n\t\tduration: type_int,\n\t\tbitRate: type_int,\n\t\tformat: type_key,\n\t\tsampleRate: type_int,\n\t\tchannels: type_int,\n\t\tencoded: type_key,\n\t\tmode: type_key,\n\t\tversion: type_key\n\t}\n};\n\nconst type_Track = {\n\tproperties: {\n\t\trootID: type_key,\n\t\tparentID: type_key,\n\t\tname: type_string,\n\t\tpath: type_key,\n\t\tstat: {\n\t\t\tproperties: {\n\t\t\t\tcreated: type_int,\n\t\t\t\tmodified: type_int,\n\t\t\t\tsize: type_int\n\t\t\t}\n\t\t},\n\t\talbumID: type_key,\n\t\tartistID: type_key,\n\t\ttag: type_TrackTag,\n\t\tmedia: type_TrackMedia,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Album = {\n\tproperties: {\n\t\tslug: type_key,\n\t\tname: type_string,\n\t\trootIDs: type_key,\n\t\ttrackIDs: type_key,\n\t\talbumType: type_key,\n\t\tartistID: type_key,\n\t\tartist: type_key,\n\t\tgenre: type_key,\n\t\tyear: type_int,\n\t\tduration: type_int,\n\t\tcreated: type_int,\n\t\tmbArtistID: type_key,\n\t\tmbAlbumID: type_key,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Artist = {\n\tproperties: {\n\t\tslug: type_key,\n\t\tname: type_string,\n\t\tnameSort: type_key,\n\t\trootIDs: type_key,\n\t\ttrackIDs: type_key,\n\t\talbumIDs: type_key,\n\t\talbumTypes: type_key,\n\t\tmbArtistID: type_key,\n\t\tcreated: type_int,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Radio = {\n\tproperties: {\n\t\tname: type_string,\n\t\turl: type_key,\n\t\thomepage: type_key,\n\t\tdisabled: type_bool,\n\t\tcreated: type_int,\n\t\tchanged: type_int,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_State = {\n\tproperties: {\n\t\tuserID: type_key,\n\t\tdestID: type_key,\n\t\tdestType: type_int,\n\t\tplayed: type_int,\n\t\tlastplayed: type_int,\n\t\tfaved: type_int,\n\t\trated: type_int,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Playlist = {\n\tproperties: {\n\t\tname: type_string,\n\t\tuserID: type_key,\n\t\tcomment: type_key,\n\t\tcoverArt: type_key,\n\t\tchanged: type_int,\n\t\tcreated: type_int,\n\t\tallowedUser: type_key,\n\t\tisPublic: type_bool,\n\t\tduration: type_int,\n\t\ttrackIDs: type_key,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_PodcastTag = {\n\tproperties: {\n\t\ttitle: type_string,\n\t\tlink: type_key,\n\t\tauthor: type_key,\n\t\tdescription: type_key,\n\t\tgenerator: type_key,\n\t\timage: type_key,\n\t\tcategories: type_key\n\t}\n};\n\nconst type_Podcast = {\n\tproperties: {\n\t\turl: type_key,\n\t\tcreated: type_int,\n\t\tlastCheck: type_int,\n\t\tstatus: type_key,\n\t\terrorMessage: type_key,\n\t\ttag: type_PodcastTag,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_PodcastEpisodeChapter = {\n\tproperties: {\n\t\tstart: type_int,\n\t\ttitle: type_string\n\t}\n};\n\nconst type_PodcastEpisodeEnclosure = {\n\tproperties: {\n\t\turl: type_key,\n\t\ttype: type_key,\n\t\tlength: type_int\n\t}\n};\n\nconst type_Episode = {\n\tproperties: {\n\t\tpodcastID: type_key,\n\t\tstatus: type_key,\n\t\terror: type_key,\n\t\tpath: type_key,\n\t\tlink: type_key,\n\t\tsummary: type_key,\n\t\tdate: type_int,\n\t\tname: type_string,\n\t\tguid: type_key,\n\t\tauthor: type_key,\n\t\tchapters: type_PodcastEpisodeChapter,\n\t\tenclosures: type_PodcastEpisodeEnclosure,\n\t\tstat: {\n\t\t\tproperties: {\n\t\t\t\tcreated: type_int,\n\t\t\t\tmodified: type_int,\n\t\t\t\tsize: type_int\n\t\t\t}\n\t\t},\n\t\ttag: type_TrackTag,\n\t\tmedia: type_TrackMedia,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nconst type_Bookmark = {\n\tproperties: {\n\t\tdestID: type_key,\n\t\tuserID: type_key,\n\t\tcomment: type_key,\n\t\tcreated: type_int,\n\t\tchanged: type_int,\n\t\tposition: type_int,\n\t\tid: type_key,\n\t\ttype: type_int\n\t}\n};\n\nexport const mapping: any = {\n\troot: type_Root,\n\tuser: type_User,\n\tfolder: type_Folder,\n\tplayqueue: type_PlayQueue,\n\ttrack: type_Track,\n\talbum: type_Album,\n\tartist: type_Artist,\n\tradio: type_Radio,\n\tstate: type_State,\n\tplaylist: type_Playlist,\n\tpodcast: type_Podcast,\n\tepisode: type_Episode,\n\tbookmark: type_Bookmark\n};\n","export async function wait(ms: number) {\n\treturn new Promise<void>(res => setTimeout(res, ms));\n}\n","import {DatabaseQuerySortType} from '../../model/jam-types';\nimport path from 'path';\nimport Nedb from 'nedb';\nimport {DBObject} from '../../objects/base/base.model';\nimport {Database, DatabaseIndex, DatabaseQuery} from '../db.model';\nimport {fileDeleteIfExists} from '../../utils/fs-utils';\nimport {DBObjectType} from '../db.types';\n\nlet globaltempid = Date.now();\n\nfunction regExpEscape(literal_string: string): string {\n\treturn literal_string.replace(/[-[\\]{}()*+!<=:?.\\/\\\\^$|#\\s,]/g, '\\\\$&');\n}\n\nexport class DBIndexNedb<T extends DBObject> implements DatabaseIndex<T> {\n\tprotected _index: string;\n\tprotected _type: string;\n\ttype: DBObjectType;\n\tclient: Nedb;\n\n\tprivate hit2Obj(hit: T): T {\n\t\tdelete (<any>hit)._id;\n\t\treturn hit;\n\t}\n\n\tprivate hits2Objs(hits: Array<T>): Array<T> {\n\t\treturn hits.map(hit => {\n\t\t\treturn this.hit2Obj(hit);\n\t\t});\n\t}\n\n\tconstructor(type: DBObjectType, client: Nedb) {\n\t\tthis.type = type;\n\t\tthis._type = DBObjectType[type];\n\t\tthis._index = 'jam_' + DBObjectType[type];\n\t\tthis.client = client;\n\t}\n\n\tasync getNewId(): Promise<string> {\n\t\t// TODO: implement real sequence id in nedb\n\t\tglobaltempid++;\n\t\treturn globaltempid.toString();\n\t}\n\n\tprivate translateSortQuery(query: DatabaseQuery): { [name: string]: number } | undefined {\n\t\tif (query.sort) {\n\t\t\tconst result: { [name: string]: number } = {};\n\t\t\tconst sort = query.sort;\n\t\t\tObject.keys(sort).forEach(key => {\n\t\t\t\tresult[key] = sort[key] === DatabaseQuerySortType.ascending ? 1 : -1;\n\t\t\t});\n\t\t\treturn result;\n\t\t}\n\t\treturn;\n\t}\n\n\tprivate translateQuery(query: DatabaseQuery) {\n\t\tif (query.all) {\n\t\t\treturn {};\n\t\t}\n\t\tlet must: Array<any> = [];\n\t\tif (query.term) {\n\t\t\tconst o = query.term;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = o[key];\n\t\t\t\t\treturn term;\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.match) {\n\t\t\tconst o = query.match;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = {$regex: new RegExp(regExpEscape(o[key].toString()), 'i')};\n\t\t\t\t\treturn term;\n\t\t\t\t})\n\t\t\t);\n\n\t\t}\n\t\tif (query.terms) {\n\t\t\tconst o = query.terms;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map(key => {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = {$in: o[key]};\n\t\t\t\t\treturn term;\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.startsWith) {\n\t\t\tconst o = query.startsWith;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map((key: string): any => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\t$where: function() {\n\t\t\t\t\t\t\treturn this[key].indexOf(o[key]) === 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.startsWiths) {\n\t\t\tconst o = query.startsWiths;\n\t\t\tmust = must.concat(\n\t\t\t\tObject.keys(o).map((key: string): any => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\t$where: function() {\n\t\t\t\t\t\t\treturn !!o[key].find(entry => this[key].indexOf(entry) === 0);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t\tif (query.range) {\n\t\t\tconst o = query.range;\n\t\t\tObject.keys(o).forEach(key => {\n\t\t\t\tconst vals = o[key];\n\t\t\t\tif (vals.hasOwnProperty('gte') && vals.gte !== undefined) {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = {$gte: vals.gte};\n\t\t\t\t\tmust.push(term);\n\t\t\t\t}\n\t\t\t\tif (vals.hasOwnProperty('lte') && vals.lte !== undefined) {\n\t\t\t\t\tconst term: any = {};\n\t\t\t\t\tterm[key] = {$lte: vals.lte};\n\t\t\t\t\tmust.push(term);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (query.notNull) {\n\t\t\tconst o = query.notNull;\n\t\t\tmust = must.concat(o.map(key => {\n\t\t\t\tconst term: any = {};\n\t\t\t\tterm[key] = {$exists: true};\n\t\t\t\treturn term;\n\t\t\t}));\n\t\t}\n\t\treturn {$and: must};\n\t}\n\n\tasync add(body: T): Promise<string> {\n\t\tif (!body.id || body.id.length === 0) {\n\t\t\tbody.id = await this.getNewId();\n\t\t}\n\t\treturn new Promise<string>((resolve, reject) => {\n\t\t\tthis.client.insert(body, (err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(body.id);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t}\n\n\tasync bulk(bodies: Array<T>): Promise<void> {\n\t\tfor (const body of bodies) {\n\t\t\tawait await this.add(body);\n\t\t}\n\t}\n\n\tasync replace(id: string, body: T): Promise<void> {\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tthis.client.update({id: id}, body, {}, (err, numReplaced) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else if (numReplaced !== 1) {\n\t\t\t\t\treturn reject('Could not find ' + this._type + ' doc with id ' + id);\n\t\t\t\t} else {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync upsert(id: string, body: T): Promise<void> {\n\t\tif (!id || id.length === 0) {\n\t\t\tawait this.add(body);\n\t\t\treturn;\n\t\t} else {\n\t\t\tawait this.replace(id, body);\n\t\t}\n\t}\n\n\tasync remove(id: string | Array<string>): Promise<void> {\n\t\tconst ids = Array.isArray(id) ? id : [id];\n\t\tif (ids.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tthis.client.remove({id: {$in: ids}}, {multi: true}, (err, count) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else if (count !== ids.length) {\n\t\t\t\t\treject(Error('Found nr of items ' + count + ' does not match nr. of ids ' + ids.length));\n\t\t\t\t} else {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync removeByQuery(query: DatabaseQuery): Promise<number> {\n\t\treturn new Promise<number>((resolve, reject) => {\n\t\t\tthis.client.remove(this.translateQuery(query), {multi: true}, (err, count) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(count);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync byId(id: string): Promise<T | undefined> {\n\t\tif (this.type === undefined) {\n\t\t\treturn await this.queryOne({term: {id: id}});\n\t\t} else {\n\t\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\t\tthis.client.find<T>({id: id}, (err, docs) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t} else if (docs.length === 0) {\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(this.hit2Obj(docs[0]));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tasync byIds(ids: Array<string>): Promise<Array<T>> {\n\t\treturn new Promise<Array<T>>((resolve, reject) => {\n\t\t\tthis.client.find<T>({id: {$in: ids}}, (err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(this.hits2Objs(docs));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync query(query: DatabaseQuery): Promise<Array<T>> {\n\t\tlet dbquery = this.client.find<T>(this.translateQuery(query));\n\t\tconst sort = this.translateSortQuery(query);\n\t\tif (sort) {\n\t\t\tdbquery = dbquery.sort(sort);\n\t\t}\n\t\tif (query.offset) {\n\t\t\tdbquery = dbquery.skip(query.offset);\n\t\t}\n\t\tif (query.amount) {\n\t\t\tdbquery = dbquery.limit(query.amount);\n\t\t}\n\n\t\treturn new Promise<Array<T>>((resolve, reject) => {\n\t\t\tdbquery.exec((err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(this.hits2Objs(docs));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync queryOne(query: DatabaseQuery): Promise<T | undefined> {\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tthis.client.find<T>(this.translateQuery(query)).limit(1).exec((err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else if (docs.length === 0) {\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\tresolve(this.hit2Obj(docs[0]));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync iterate(query: DatabaseQuery, onItems: (items: Array<T>) => Promise<void>): Promise<void> {\n\t\tlet dbquery = this.client.find<T>(this.translateQuery(query));\n\t\tconst sort = this.translateSortQuery(query);\n\t\tif (sort) {\n\t\t\tdbquery = dbquery.sort(sort);\n\t\t}\n\t\tif (query.offset) {\n\t\t\tdbquery = dbquery.skip(query.offset);\n\t\t}\n\t\tif (query.amount) {\n\t\t\tdbquery = dbquery.limit(query.amount);\n\t\t}\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tdbquery.exec((err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tonItems(this.hits2Objs(docs)).then(resolve).catch(reject);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync queryIds(query: DatabaseQuery): Promise<Array<string>> {\n\t\tlet dbquery = this.client.find<T>(this.translateQuery(query));\n\t\tconst sort = this.translateSortQuery(query);\n\t\tif (sort) {\n\t\t\tdbquery = dbquery.sort(sort);\n\t\t}\n\t\tif (query.offset) {\n\t\t\tdbquery = dbquery.skip(query.offset);\n\t\t}\n\t\tif (query.amount) {\n\t\t\tdbquery = dbquery.limit(query.amount);\n\t\t}\n\t\treturn new Promise<Array<string>>((resolve, reject) => {\n\t\t\tdbquery.exec((err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(docs.map(o => o.id));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate getDotFieldValues(field: string, o: any): Array<string> {\n\t\tconst result: Array<any> = [];\n\n\t\tconst getFieldValueR = (fields: Array<string>, obj: any) => {\n\t\t\tconst sub = obj[fields[0]];\n\t\t\tif (sub === undefined) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (Array.isArray(sub)) {\n\t\t\t\tif (fields.length === 1) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsub.forEach(child => {\n\t\t\t\t\tgetFieldValueR(fields.slice(1), child);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tif (fields.length === 1) {\n\t\t\t\t\tresult.push(sub.toString());\n\t\t\t\t} else if (typeof sub === 'object') {\n\t\t\t\t\tgetFieldValueR(fields.slice(1), sub);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tgetFieldValueR(field.split('.'), o);\n\t\treturn result;\n\t}\n\n\tasync aggregate(query: DatabaseQuery, field: string): Promise<number> {\n\t\tlet dbquery = this.client.find<T>(this.translateQuery(query));\n\t\tconst sort = this.translateSortQuery(query);\n\t\tif (sort) {\n\t\t\tdbquery = dbquery.sort(sort);\n\t\t}\n\t\tif (query.offset) {\n\t\t\tdbquery = dbquery.skip(query.offset);\n\t\t}\n\t\tif (query.amount) {\n\t\t\tdbquery = dbquery.limit(query.amount);\n\t\t}\n\t\treturn new Promise<number>((resolve, reject) => {\n\t\t\tdbquery.exec((err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tconst list: Array<string> = [];\n\t\t\t\t\tdocs.forEach(doc => {\n\t\t\t\t\t\tconst vals = this.getDotFieldValues(field, doc);\n\t\t\t\t\t\tvals.forEach(val => {\n\t\t\t\t\t\t\tif (list.indexOf(val) < 0) {\n\t\t\t\t\t\t\t\tlist.push(val);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tresolve(list.length);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync count(query: DatabaseQuery): Promise<number> {\n\t\treturn new Promise<number>((resolve, reject) => {\n\t\t\tthis.client.count(this.translateQuery(query), (err, count) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(count);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tasync distinct(fieldname: string): Promise<Array<string>> {\n\t\treturn new Promise<Array<string>>((resolve, reject) => {\n\t\t\tthis.client.find<T>({}, (err, docs) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tconst list: Array<string> = [];\n\t\t\t\t\tdocs.forEach(doc => {\n\t\t\t\t\t\tconst vals = this.getDotFieldValues(fieldname, doc);\n\t\t\t\t\t\tvals.forEach(val => {\n\t\t\t\t\t\t\tif (list.indexOf(val) < 0) {\n\t\t\t\t\t\t\t\tlist.push(val);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tresolve(list);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n}\n\nexport class DBNedb implements Database {\n\tclients: {\n\t\t[type: string]: { client: Nedb; filename: string };\n\t} = {};\n\n\tconstructor(db_path: string) {\n\t\tthis.getTypes().forEach(type => {\n\t\t\tconst filename = path.resolve(db_path, DBObjectType[type] + '.db');\n\t\t\tthis.clients[DBObjectType[type]] = {client: new Nedb({filename}), filename};\n\t\t});\n\t}\n\n\tasync drop(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tconst db = this.clients[DBObjectType[type]];\n\t\t\tawait fileDeleteIfExists(db.filename);\n\t\t}\n\t}\n\n\tprivate async loadDatabase(db: Nedb) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tdb.loadDatabase((err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync open(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tconst db = this.clients[DBObjectType[type]];\n\t\t\tawait this.loadDatabase(db.client);\n\t\t}\n\t\tawait this.check();\n\t}\n\n\tasync close(): Promise<void> {\n\t\treturn;\n\t}\n\n\tprivate getTypes(): Array<DBObjectType> {\n\t\treturn Object.keys(DBObjectType)\n\t\t\t.filter(key => !isNaN(Number(key)))\n\t\t\t.map(key => parseInt(key, 10));\n\t}\n\n\tprivate async resetIndex(db: Nedb): Promise<void> {\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tdb.remove({}, {multi: true}, (err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tdb.loadDatabase((err2) => {\n\t\t\t\t\tif (err2) {\n\t\t\t\t\t\treject(err2);\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tasync reset(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tconst db = this.clients[DBObjectType[type]];\n\t\t\tawait this.resetIndex(db.client);\n\t\t}\n\t}\n\n\tprivate async checkIndex(db: Nedb): Promise<void> {\n\t\treturn;\n\t}\n\n\tasync check(): Promise<void> {\n\t\tfor (const type of this.getTypes()) {\n\t\t\tconst db = this.clients[DBObjectType[type]];\n\t\t\tawait this.checkIndex(db.client);\n\t\t}\n\t}\n\n\tgetDBIndex<T extends DBObject>(type: DBObjectType) {\n\t\treturn new DBIndexNedb<T>(type, this.clients[DBObjectType[type]].client);\n\t}\n}\n","module.exports = require(\"nedb\");","module.exports = require(\"commander\");"],"sourceRoot":""}